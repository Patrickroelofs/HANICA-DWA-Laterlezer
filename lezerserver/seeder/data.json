{
    "_id": "5fdcab2b130cba20187c5dcd",
    "userName": "testuser",
    "articles": [
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcad65130cba20187c5df5",
            "html": "<html><head></head><body><div class=block-content> <p class=excerpt>Het kabinet ziet op dit moment niets in een beloningssysteem voor mensen die zich hebben laten inenten met het coronavaccin, zegt minister Hugo de Jonge (Volksgezondheid) vrijdag. Ook gaat hij ervan uit dat er geen directe of indirecte vaccinatieplicht komt. Het kabinet wacht nog op een advies van de Gezondheidsraad en zal dan voor april een officiële beslissing nemen.</p> <p>\"Een beloning voor mensen die al gevaccineerd zijn, daar willen we niet voor kiezen\", zegt de bewindsman. \"Omdat we denken dat dat uiteindelijk ook de vaccinatiebereidheid gaat ondergraven.\" Mensen moeten zich volgens hem vooral laten inenten uit de overtuiging dat het beter is voor de gezondheid.</p><p>Afhankelijk van het advies van de Gezondheidsraad komen er, als straks een deel van de Nederlanders is ingeënt en een ander deel nog niet, mogelijk wel \"maatregelen\" waardoor de gevaccineerde mensen iets meer kunnen.</p><p>Toch is het kabinet daar heel voorzichtig mee. \"Je moet niet willen dat daar een impliciete druk vanuit gaat, of dat het toch een vorm van drang en dwang wordt\", zegt De Jonge over dit ethische dilemma.</p> <h2>Onderzoek naar draagvlak voor vaccinatiebewijs</h2> <p>Wetenschappers van de TU Delft, Erasmus Universiteit Rotterdam, Universiteit Maastricht en het RIVM deden <a href=https://www.tudelft.nl/tbm/pwe/case-studies/vaccinatiebeleid/ >onderzoek</a> naar het draagvlak onder de Nederlandse bevolking voor een vaccinatiebewijs. Daaruit kwam vrijdag naar voren dat circa drie kwart van de 1.640 ondervraagden voorstander is om mensen die zich laten vaccineren meer vrijheden te geven.</p><p>In de studie kregen de respondenten negen verschillende scenario's voorgelegd. Zij voelden het meest voor een scenario waarin mensen met een vaccinatiebewijs op zak - in theorie - op bepaalde plaatsen mogen blijven komen, wanneer in hun regio een corona-uitbraak plaatsvindt.</p><p>Het gaat dat bijvoorbeeld om winkels, horeca, verpleeghuizen, fitnesscentra en het openbaar vervoer. Mensen die niet gevaccineerd zijn, zouden tijdens een uitbraak op die plekken mogen worden geweigerd.</p> <h2>Vaccinatie geen 'instrument voor bepaalde privileges'</h2> <p>Het ministerie van Volksgezondheid benadrukt tegenover NU.nl dat het kabinet op dit moment niet inzet op een 'vaccinatiebewijs' \"als instrument voor bepaalde privileges\".</p><p>Wel wordt iedere gegeven prik straks bijgehouden in een digitaal registratiesysteem. Instanties gaan deze data gebruiken om de vaccinatiegraad bij te houden en de veiligheid en effectiviteit van een vaccin te monitoren. Ook kunnen mensen via het systeem meldingen doen van eventuele bijwerkingen van een vaccin.</p> </div></body></html>",
            "source": "https://www.nu.nl/coronavirus/6097491/de-jonge-ziet-op-dit-moment-niets-in-beloningssysteem-voor-gevaccineerden.html",
            "title": "De Jonge ziet op dit moment niets in beloningssysteem voor gevaccineerden",
            "author": "Door: NU.nl/ANP",
            "published": "2020-12-18T10:32:58.000Z",
            "image": "https://media.nu.nl/m/czox82ba5ns1_wd1280.jpg/de-jonge-ziet-op-dit-moment-niets-in-beloningssysteem-voor-gevaccineerden.jpg",
            "description": "Het kabinet ziet op dit moment niets in een beloningssysteem voor mensen die zich hebben laten inenten met het coronavaccin, zegt minister Hugo de Jonge (Volksgezondheid) vrijdag. Ook gaat hij ervan&hellip;",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab92130cba20187c5ded",
                    "title": "nu.nl",
                    "color": "#401780"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab92130cba20187c5ded",
                            "title": "nu.nl",
                            "value": "nu.nl",
                            "label": "nu.nl",
                            "color": "#401780",
                            "children": []
                        },
                        {
                            "_id": "5fdcab97130cba20187c5df4",
                            "title": "Telegraaf",
                            "value": "Telegraaf",
                            "label": "Telegraaf",
                            "color": "#5da076",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab8c130cba20187c5de6",
                    "title": "Nieuws",
                    "color": "#0ecbc3"
                }
            ],
            "createdAt": "2020-12-18T14:23:49.903+01:00"
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcad7f130cba20187c5df8",
            "html": "<html><head></head><body><div class=block-content> <p class=excerpt>Mensen worden niet gestraft als ze eerder aangeschaft vuurwerk vrijwillig afgeven bij een speciaal inleverpunt van de gemeente, zegt minister Ferd Grapperhaus (Justitie en Veiligheid) vrijdag. Hiermee reageert hij op het idee van de Rotterdamse burgemeester Ahmed Aboutaleb om zo'n \"generaal pardon\" in te voeren.</p> <p>Verschillende burgemeesters stonden achter het voorstel van Aboutaleb en drongen er bij de minister op aan dit mogelijk te maken, zodat mensen indien gewenst veilig van hun vuurwerk af kunnen komen.</p><p>Het bezit van maximaal 25 kilogram vuurwerk is toegestaan, maar het is dit jaar verboden vuurwerk te vervoeren of af te steken. Daardoor zou het onmogelijk zijn om vuurwerk in te leveren, maar Grapperhaus heeft nu met het Openbaar Ministerie (OM) een vrijwaring afgesproken. Het OM zal dus niet achter vuurwerkbezitters aangaan als zij de pijlen en fonteinen uit eigen beweging inleveren.</p><p>Nu wordt nog gekeken hoe het plan kan worden uitgewerkt. Volgens Grapperhaus is het vooral belangrijk dat het vuurwerk \"veilig ingeleverd, veilig vervoerd en veilig opgeslagen\" wordt. Dat betekent niet dat er een landelijk inzamelpunt komt.</p> <h2>Gemeenten nemen het voortouw</h2> <p>Grapperhaus benadrukt dat gemeenten het voortouw nemen. \"Wij helpen eraan mee, we kijken zeker mee, maar hier hebben we ook te maken met de lokale verantwoordelijkheden\", laat hij weten. Het is nog niet bekend welke en hoeveel gemeenten een inleverpunt voor vuurwerk gaan openen. Ze zullen de komst van zo'n locatie zelf bekendmaken.</p><p>Vrijwel al het vuurwerk is dit jaar verboden. Boven op het algemene verbod op zwaar vuurwerk dat eerder werd aangekondigd, komt er een eenmalig verbod op het lichtere vuurwerk, om zorgmedewerkers te ontzien. Alleen het zogeheten kindervuurwerk, bijvoorbeeld sterretjes, mag nog wel afgestoken worden.</p>\n<div class=\"video component_container\" id=block-1080233> <div class=\"video block\"></div>\n</div> </div></body></html>",
            "source": "https://www.nu.nl/binnenland/6097493/grapperhaus-geen-straf-als-vuurwerk-vrijwillig-wordt-ingeleverd.html",
            "title": "Grapperhaus: Geen straf als vuurwerk vrijwillig wordt ingeleverd",
            "author": "Door: ANP/NU.nl",
            "published": "2020-12-18T10:35:47.000Z",
            "image": "https://media.nu.nl/m/g4axl9laxjxo_wd1280.jpg/grapperhaus-geen-straf-als-vuurwerk-vrijwillig-wordt-ingeleverd.jpg",
            "description": "Mensen worden niet gestraft als ze eerder aangeschaft vuurwerk vrijwillig afgeven bij een speciaal inleverpunt van de gemeente, zegt minister Ferd Grapperhaus (Justitie en Veiligheid) vrijdag. Hiermee&hellip;",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab92130cba20187c5ded",
                    "title": "nu.nl",
                    "color": "#401780"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab92130cba20187c5ded",
                            "title": "nu.nl",
                            "value": "nu.nl",
                            "label": "nu.nl",
                            "color": "#401780",
                            "children": []
                        },
                        {
                            "_id": "5fdcab97130cba20187c5df4",
                            "title": "Telegraaf",
                            "value": "Telegraaf",
                            "label": "Telegraaf",
                            "color": "#5da076",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab8c130cba20187c5de6",
                    "title": "Nieuws",
                    "color": "#0ecbc3"
                }
            ],
            "createdAt": "2020-12-18T14:24:15.587+01:00"
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcad91130cba20187c5dfb",
            "html": "<html><head></head><body><div><div><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Het is 5 december ’s nachts zeer onrustig op Urk. Tal van jongeren zijn de straat opgegaan met zwaar vuurwerk. Ook de veroordeelde 19-jarige verdachte is op de been. Hij pakt zijn telefoon en besluit zijn boosheid op de nieuwe SGP-burgemeester Cees van den Bos (40) te botvieren. Via Messenger stuurt hij een bericht aan de burgemeester met daarin volgens het OM ’forse beledigingen’ en de woorden ’ik maak je af’.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Diezelfde nacht wordt hij aangehouden. Bij de politierechter verklaarde de tiener dat hij was aangeschoten en niet verwachtte dat het zo hoog zou worden opgenomen. Hij was boos omdat hij op internet zag dat vrienden van hem werden aangehouden door de politie, maar hij was niet van plan de burgemeester echt iets aan te doen. „Dat hoor ik vaker”, zei de politierechter, „maar iemand die bedreigd wordt, weet dat niet.”</p><h3 class=SubheaderBlock__body>Onrust op Urk</h3><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">De officier van justitie woog de bijzondere omstandigheden van dat moment mee in zijn strafeis. Al weekenden op rij was het onrustig op Urk. Groepen jongeren verstoorden de openbare orde en gooiden brandbommen naar de politie en ME. Op het moment dat de burgemeester het bericht ontving, zat hij in crisisberaad, terwijl het buiten wel oorlog leek. Dat de verdachte de besluitvorming van de burgemeester heeft willen beïnvloeden, neemt de officier de jongeman zeer kwalijk. Hij eiste een taakstraf van 50 uur en een week celstraf voorwaardelijk als stok achter de deur.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">De politierechter geloofde niet dat de verdachte, die zijn daad kenmerkte als ’dom’, weer een dergelijke bedreiging zou uiten en vond een voorwaardelijke celstraf niet nodig. Maar een geldboete, die meestal wordt opgelegd voor een bedreiging, doet geen recht aan de omstandigheden. Ze veroordeelde de verdachte daarom tot een taakstraf van 50 uur.</p><div class=\"ArticleBodyBlocks__relatedArticle InlineRelatedArticlesBlock__body InlineRelatedArticlesBlock__body--nieuws\"><p class=\"InlineRelatedArticlesBlock__header InlineRelatedArticlesBlock__header--nieuws\">Bekijk ook:</p><a href=/nieuws/1444681074/jongeren-urk-trekken-stekker-uit-coronatestbus class=InlineRelatedArticlesBlock__link>Jongeren Urk trekken stekker uit coronatestbus</a></div><div class=\"ArticleBodyBlocks__relatedArticle InlineRelatedArticlesBlock__body InlineRelatedArticlesBlock__body--nieuws\"><p class=\"InlineRelatedArticlesBlock__header InlineRelatedArticlesBlock__header--nieuws\">Bekijk ook:</p><a href=/nieuws/1386630908/groep-jongeren-zorgt-weer-voor-onrust-in-urk class=InlineRelatedArticlesBlock__link>Groep jongeren zorgt weer voor onrust in Urk</a></div><div class=\"ArticleBodyBlocks__relatedArticle InlineRelatedArticlesBlock__body InlineRelatedArticlesBlock__body--nieuws\"><p class=\"InlineRelatedArticlesBlock__header InlineRelatedArticlesBlock__header--nieuws\">Bekijk ook:</p><a href=/nieuws/1645549950/coronawoede-testlocaties-ggd-doelwit-vandalen class=InlineRelatedArticlesBlock__link>Coronawoede: testlocaties GGD doelwit vandalen</a></div><h3 class=SubheaderBlock__body>Gemeentehuis</h3><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Eerder deze week kregen twee jongeren uit Urk ook al taakstraffen opgelegd. Zij waren betrokken bij ongeregeldheden en vernielingen rondom het gemeentehuis in februari. Ook moeten ze beiden 500 euro aan schadevergoeding betalen. Er werden onder meer ruiten ingegooid, plantenbakken leeg getrokken en er werd een bushokje vernield. Tijdens de ongeregeldheden werd met vuurwerk gegooid en met alarmpistolen in de lucht geschoten.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\"><span class=italic>Tips? App naar onze <a href=\"https://api.whatsapp.com/send?phone=31613650952\">whatsapp tiplijn</a>. Zet het nummer in je telefoon: +31613650952</span></p></div><div class=\"NewsletterForm__wrapper Newsletter__body Newsletter__body--nieuws\"><p class=NewsletterForm__subtitle>Dagelijks tijdens de lunch een update van het belangrijkste nieuws.</p><div class=NewsletterForm__textInfo><p class=NewsletterForm__signOut><span class=NewsletterForm__privacyRulesWrapper>Lees <a href=https://www.mediahuis.nl/privacy/ class=\"NewsletterForm__privacyRules NewsletterForm__privacyRules--nieuws\">hier</a> ons privacybeleid.</span></p></div></div></div></body></html>",
            "source": "https://www.telegraaf.nl/nieuws/1336835888/19-jarige-urker-bedreigde-burgemeester-ik-maak-je-af",
            "title": "19-jarige Urker bedreigde burgemeester: ’Ik maak je af’",
            "author": null,
            "published": "2020-12-18T11:09:01.000Z",
            "image": "https://www.telegraaf.nl/images/1200x630/filters:format(jpeg):quality(80)/cdn-kiosk-api.telegraaf.nl/6f0e1276-4121-11eb-9a14-0218eaf05005.jpg",
            "description": "Een 19-jarige Urker kreeg vrijdag te horen dat hij 50 uur taakstraf moet uitvoeren voor het beledigen en bedreigen van de burgemeester van het vissersdorp. Dat deed hij middels een bericht via de app&hellip;",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab97130cba20187c5df4",
                    "title": "Telegraaf",
                    "color": "#5da076"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab92130cba20187c5ded",
                            "title": "nu.nl",
                            "value": "nu.nl",
                            "label": "nu.nl",
                            "color": "#401780",
                            "children": []
                        },
                        {
                            "_id": "5fdcab97130cba20187c5df4",
                            "title": "Telegraaf",
                            "value": "Telegraaf",
                            "label": "Telegraaf",
                            "color": "#5da076",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab8c130cba20187c5de6",
                    "title": "Nieuws",
                    "color": "#0ecbc3"
                }
            ],
            "createdAt": "2020-12-18T14:24:33.550+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcada6130cba20187c5dfe",
            "html": "<html><head></head><body><div><div><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">De ontvoering vond plaats in januari. Het slachtoffer werd in een auto geduwd, in een tapijt gerold, vastgebonden en geblinddoekt. Eerst werd hij naar een garagebox gebracht, waar hij zijn portemonnee en pinpas moest afstaan. Daarna is hij in de woning opgesloten. Volgens de rechtbank hebben de verdachten (22, 24 en 37 jaar) de operatie grondig voorbereid.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Het slachtoffer belde op 22 januari naar zijn vader in Pakistan en vertelde dat hij was ontvoerd. Tijdens een videogesprek zag de vader een elektrische zaag bij het hoofd van zijn zoon.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">De ontvoerders eisten aanvankelijk 10 miljoen dollar, te betalen in bitcoin, maar dit bedrag werd al snel teruggebracht naar 250.000 dollar. Er werd gedreigd de vingers van de student af te knippen, en zelfs hem te vermoorden, als de politie werd ingeschakeld.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Het mobiele nummer van de ontvoerders leidde de politie naar de woning waar het slachtoffer werd vastgehouden. Een arrestatieteam viel de woning in de avond van 23 januari binnen en vond het slachtoffer gewond, geblinddoekt en vastgebonden aan handen en voeten.</p><p class=\"ArticleBodyBlocks__paragraph ArticleBodyBlocks__paragraph--nieuws\">Het Openbaar Ministerie had acht en negen jaar cel geëist. De rechtbank vond die eisen, in vergelijking met andere zaken, te hoog.</p></div><div class=\"NewsletterForm__wrapper Newsletter__body Newsletter__body--nieuws\"><p class=NewsletterForm__subtitle>Dagelijks tijdens de lunch een update van het belangrijkste nieuws.</p><div class=NewsletterForm__textInfo><p class=NewsletterForm__signOut><span class=NewsletterForm__privacyRulesWrapper>Lees <a class=\"NewsletterForm__privacyRules NewsletterForm__privacyRules--nieuws\" href=https://www.mediahuis.nl/privacy/ >hier</a> ons privacybeleid.</span></p></div></div></div></body></html>",
            "source": "https://www.telegraaf.nl/nieuws/1982186505/straffen-tot-zes-jaar-voor-gijzeling-student-groningen",
            "title": "Straffen tot zes jaar voor gijzeling student Groningen | Binnenland",
            "author": null,
            "published": "2020-12-18T13:23:45.000Z",
            "image": "https://www.telegraaf.nl/images/1200x630/filters:format(jpeg):quality(80)/cdn-kiosk-api.telegraaf.nl/4151d364-4134-11eb-ba7b-02d1dbdc35d1.jpg",
            "description": "Drie mannen zijn door de rechtbank in Groningen veroordeeld tot straffen van vijf en zes jaar voor de ontvoering van een Pakistaanse student. Het 18-jarige slachtoffer heeft dagenlang geblinddoekt en&hellip;",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab97130cba20187c5df4",
                    "title": "Telegraaf",
                    "color": "#5da076"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab92130cba20187c5ded",
                            "title": "nu.nl",
                            "value": "nu.nl",
                            "label": "nu.nl",
                            "color": "#401780",
                            "children": []
                        },
                        {
                            "_id": "5fdcab97130cba20187c5df4",
                            "title": "Telegraaf",
                            "value": "Telegraaf",
                            "label": "Telegraaf",
                            "color": "#5da076",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab8c130cba20187c5de6",
                    "title": "Nieuws",
                    "color": "#0ecbc3"
                }
            ],
            "createdAt": "2020-12-18T14:24:54.237+01:00"
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcae23130cba20187c5e05",
            "html": "<html><head></head><body><div><div class=ArticleBody-articleBody id=RegularArticle-ArticleBody-5><span class=HighlightShare-hidden></span><div class=group><p>LONDON — The scale of a sophisticated cyberattack on the U.S. government that was unearthed this week is much bigger than first anticipated.&nbsp;</p><p>The Cybersecurity and Infrastructure Security Agency said in a <a href=https://us-cert.cisa.gov/ncas/alerts/aa20-352a>summary Thursday</a> that the threat \"poses a grave risk to the federal government.\"</p><p>It added that \"state, local, tribal, and territorial governments as well as critical infrastructure entities and other private sector organizations\" are also at risk.</p><p>CISA believes the attack began at least as early as March. Since then, multiple government agencies have reportedly been targeted by the hackers, with confirmation from the Energy and Commerce departments so far.</p><p>\"This threat actor has demonstrated sophistication and complex tradecraft in these intrusions,\" CISA said. \"Removing the threat actor from compromised environments will be highly complex and challenging.\"</p></div><div class=group><p>CISA has not said who it thinks is the \"advanced persistent threat actor\" behind the \"significant and ongoing\" campaign, but many experts are pointing to Russia.</p><p>\"The magnitude of this ongoing attack is hard to overstate,\" former Trump Homeland Security Advisor Thomas Bossert said in <a href=https://www.nytimes.com/2020/12/16/opinion/fireeye-solarwinds-russia-hack.html>a piece for The New York Times</a> on Thursday. \"The Russians have had access to a considerable number of important and sensitive networks for six to nine months.\"</p><p>Russian presidential spokesman Dmitry Peskov rejected the accusations, <a href=https://tass.com/politics/1234723>according to the Tass news agency</a>.</p><p>\"Even if it is true there have been some attacks over many months and the Americans managed to do nothing about them, possibly it is wrong to groundlessly blame Russians right away,\" he told Tass. \"We have nothing to do with this.\"</p><p>The Russian Embassy in London did not immediately respond to CNBC's request for comment.</p><p><a href=https://www.fbi.gov/news/pressrel/press-releases/joint-statement-by-the-federal-bureau-of-investigation-fbi-the-cybersecurity-and-infrastructure-security-agency-cisa-and-the-office-of-the-director-of-national-intelligence-odni>The FBI said Wednesday</a> it is \"investigating and gathering intelligence in order to attribute, pursue, and disrupt the responsible threat actors.\"</p><p>At this stage, it's not clear what the hackers have done beyond accessing top-secret government networks and monitoring data.</p><p>Hackers also accessed systems at the National Nuclear Security Administration, which maintains the U.S. nuclear weapons stockpile, <a href=https://www.politico.com/news/2020/12/17/nuclear-agency-hacked-officials-inform-congress-447855>according to the Politico</a> news site, citing officials familiar with the matter.</p></div><div class=group><p>CISA said those behind the attack used network management software made by SolarWinds, a Texas-headquartered IT firm, to breach the government networks.</p><p>As many as 18,000 SolarWinds Orion customers downloaded a software update that contained a backdoor, which the hackers used to gain access to the networks.</p></div><div class=PlaceHolder-wrapper id=Placeholder-ArticleBody-Video-106813226></div><div class=group><p>CISA issued an \"emergency directive\" this week instructing federal civilian agencies to \"immediately disconnect or power down affected SolarWinds Orion products from their network.\"</p><p>But the perpetrators may have used other means to access the networks. CISA said Thursday is investigating \"evidence of additional access vectors, other than the SolarWinds Orion platform.\"</p></div><div class=group><p><a href=\"https://www.cnbc.com/quotes/?symbol=MSFT\">Microsoft</a>&nbsp;was <a href=https://www.cnbc.com/2020/12/17/microsoft-shares-fall-after-report-it-was-swept-up-in-solarwinds-hack.html>hacked in connection</a> with the attack on&nbsp;<a href=\"https://www.cnbc.com/quotes/?symbol=SWI\">SolarWinds</a>' widely used management software, Reuters&nbsp;<a href=\"https://www.reuters.com/article/us-global-cyber-microsoft/exclusive-microsoft-breached-in-suspected-russian-hack-using-solarwinds-sources-idUSKBN28R3BY?il=0\">reported</a> Thursday.</p><p>Like with the cyberattack of SolarWinds, hackers infiltrated Microsoft products and then went after others, Reuters said, citing people familiar with the matter.</p><p>Microsoft said that more than 40 client organizations were compromised in the attack.</p><p>\"While roughly 80% of these customers are located in the United States, this work so far has also identified victims in seven additional countries,\" Microsoft President Brad Smith <a href=https://blogs.microsoft.com/on-the-issues/2020/12/17/cyberattacks-cybersecurity-solarwinds-fireeye/ >said in a blog</a>.</p><p>\"This includes Canada and Mexico in North America; Belgium, Spain and the United Kingdom in Europe; and Israel and the UAE in the Middle East. It's certain that the number and location of victims will keep growing.\"</p><p>Smith added that \"this is not espionage as usual\" and \"while governments have spied on each other for centuries, the recent attackers used a technique that has put at risk the technology supply chain for the broader economy.\"</p></div><div class=PlaceHolder-wrapper id=Placeholder-ArticleBody-Video-106811983><div class=InlineVideo-videoEmbed id=InlineVideo-0><div class=InlineVideo-wrapper></div></div></div><div class=group><p>U.S. President-elect Joe Biden <a href=https://www.cnbc.com/2020/12/17/biden-hints-at-a-tougher-stance-against-state-sponsors-of-cyberattacks.html>pledged Thursday</a> to make cybersecurity a key area of focus for his administration.&nbsp;</p><p>\"A good defense isn't enough; We need to disrupt and deter our adversaries from undertaking significant cyberattacks in the first place,\" Biden said in a statement issued by his transition team.</p><p>\"We will do that by, among other things, imposing substantial costs on those responsible for such malicious attacks, including in coordination with our allies and partners. Our adversaries should know that, as President, I will not stand idly by in the face of cyber assaults on our nation.\"</p><p>President Donald Trump, who has been silent about the hacking, <a href=https://www.cnbc.com/2020/12/17/trump-says-he-will-veto-defense-bill.html>threatened on Thursday to veto</a> the National Defense Authorization Act, which <a href=https://www.nytimes.com/2020/12/18/us/politics/cyber-defenses-bill-trump.html>includes money to help prevent such cyberattacks</a>. </p></div></div></div></body></html>",
            "source": "https://www.cnbc.com/2020/12/18/suspected-russian-hack-on-us-is-much-worse-than-first-feared.html",
            "title": "Suspected Russian hack is much worse than first feared: Here's what you need to know",
            "author": "Sam Shead",
            "published": "2020-12-18T12:06:10.000Z",
            "image": "https://image.cnbcfm.com/api/v1/image/106503037-1587660541145gettyimages-1078726270.jpeg?v=1605111050",
            "description": "The U.S. Cybersecurity and Infrastructure Security Agency said the threat \"poses a grave risk to the federal government.\"",
            "tags": [
                {
                    "children": [
                        {
                            "_id": "5fdcab92130cba20187c5ded",
                            "title": "nu.nl",
                            "value": "nu.nl",
                            "label": "nu.nl",
                            "color": "#401780",
                            "children": []
                        },
                        {
                            "_id": "5fdcab97130cba20187c5df4",
                            "title": "Telegraaf",
                            "value": "Telegraaf",
                            "label": "Telegraaf",
                            "color": "#5da076",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab8c130cba20187c5de6",
                    "title": "Nieuws",
                    "color": "#0ecbc3"
                }
            ],
            "createdAt": "2020-12-18T14:26:59.466+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcae6c130cba20187c5e07",
            "html": "<html><head></head><body><div class=article-body><div class=article-meta><span class=timestamp><span class=time>12:10 PM ET</span></span></div><p>It's the blockbuster deal that seems too crazy to happen, involving two of the biggest clubs in the world and their most high-profile stars, but it could be the only solution to the problems that <a href=\"/soccer/team?id=360\">Manchester United</a> and <a href=\"/soccer/team?id=111\">Juventus</a> are struggling to solve. In many ways, a player swap that would see <a href=https://www.espn.com/soccer/player/_/id/22774/Cristiano-Ronaldo>Cristiano Ronaldo</a> and <a href=https://www.espn.com/soccer/player/_/id/138860/Paul-Pogba>Paul Pogba</a> trade places is a transfer that would suit everyone.</p><p>In normal times, when the biggest clubs were flush with money and able to dictate where, why and when transfers happen, any kind of swap deal -- never mind one involving two of the game's most celebrated players -- would never get off the ground. Player swaps have always been a rarity at the highest level, and <a href=/soccer/english-premier-league/story/4103508/sanchezmkhitaryan-swap-a-warning-to-clubs-expecting-to-work-transfer-market-with-swap-deals-this-s>when you consider the disastrous outcome</a> of the <a href=https://www.espn.com/soccer/player/_/id/92055/Alexis-Sánchez>Alexis Sanchez</a>-<a href=https://www.espn.com/soccer/player/_/id/147625/Henrikh-Mkhitaryan>Henrikh Mkhitaryan</a> trade between United and <a href=\"/soccer/team?id=359\">Arsenal</a> three years ago, it's easy to see why.</p><p><strong>- <a href=https://www.espn.com/watch/catalog/88f27099-2a08-4c9c-9792-6aa026eff3f1>Stream ESPN FC Daily on ESPN+ (U.S. only)</a><br>\n- <a href=/soccer/blog-espn-fc-united/story/4172733/espn+-viewers-guide-bundesligaserie-amajor-league-socceruefa-nations-leaguefa-cupmore>ESPN+ viewer's guide: Bundesliga, Serie A, MLS, FA Cup and more</a></strong></p><p>But the impact on football of the COVID-19 pandemic has been huge, with clubs at every level of the game, in every country, seeing their finances hit hard due to fans being locked out, or crowd numbers hugely reduced, and television companies demanding rebates on their massive broadcasting deals, which has resulted in payments to clubs being slashed and prize money cut in the major competitions.</p><p>Even United and Juventus, two of Europe's biggest clubs, have suffered. United reported a revenue drop of £70 million to the end of June in their last financial figures, and that number will only get bigger with Old Trafford continuing to host behind closed doors. Juventus, meanwhile, posted similar losses (€71.4m / £64.5m) for the year ending June 30, and the ongoing impact of the pandemic will bite even harder as this season progresses. So these are not good times for either club to be dealing with growing problems with their two top names -- Ronaldo and Pogba.</p><aside class=\"inline editorial float-r\"><ul><li><a href=/soccer/english-premier-league/story/4258678/pogbaman-united-and-raiola-unpacking-what-this-weeks-shock-transfer-news-means class=img-link><img src=\"https://a.espncdn.com/combiner/i?img=/photo/2020/1210/r788252_1296x1296_1-1.jpg&amp;w=130&amp;h=130&amp;scale=crop&amp;location=center\"></a></li><li><a href=/soccer/uefa-champions-league/story/4257432/cristiano-ronaldos-move-to-juventus-justified-as-barcelona-fail-to-support-lionel-messi class=img-link><img src=\"https://a.espncdn.com/combiner/i?img=/photo/2020/1209/r787576_1296x1296_1-1.jpg&amp;w=130&amp;h=130&amp;scale=crop&amp;location=center\"></a></li><li><a href=/soccer/soccer-transfers/story/4243355/january-transfer-window-preview-messi-to-city-sancho-to-united-liverpool-to-land-upamecano class=img-link><img src=\"https://a.espncdn.com/combiner/i?img=/photo/2020/1119/r777983_1296x1296_1-1.jpg&amp;w=130&amp;h=130&amp;scale=crop&amp;location=center\"></a></li></ul></aside><p>Ronaldo, who will be 36 in February, is entering the final 18 months of his contract at Juventus, which is reportedly worth €31m (£28m) a year. Despite his return of 79 goals in 101 appearances for the Italian champions, Juve have yet to start talks over a new deal with the <a href=\"/soccer/team?id=482\">Portugal</a> captain, and sources have told ESPN that the club would be open to offers for the forward, especially given the financial strain of COVID-19.</p><p>As for United, their Pogba headache just won't go away. Like Ronaldo, his £15m-a-year contract expires in June 2022, and his agent Mino Raiola hardly shocked the world last week by <a href=/soccer/manchester-united/story/4256221/man-utds-pogba-unhappy-at-clubtime-is-up-agent>saying that his client wanted to leave Old Trafford to kick-start his career</a>. But there is no line of potential buyers for the 27-year-old right now, and he, Raiola and United know that. They know that the usual candidates -- <a href=\"/soccer/team?id=86\">Real Madrid</a>, <a href=\"/soccer/team?id=160\">Paris Saint-Germain</a> and Juve -- don't have the money to sign him or pay his wages.</p><p>It is a similar story with Juve and Ronaldo, although the former United and Real forward is at least delivering on the pitch for his team, which is difficult to say for Pogba. Juve know that there is no club on the planet who would pay a fee for Ronaldo and then agree to meet his wage demands -- even if he dropped them by a third.</p><p>This is why a Ronaldo-Pogba swap deal could prove so compelling to the two clubs and both players. It offers a route out of a difficult situation for all parties. But what are the potential obstacles and could it really happen?</p><aside class=module-iframe-wrapper> </aside><h2>Would it work from a football perspective? Do the coaches even want it to happen?</h2><p>First of all, this deal will not work if there was no sporting sense for it to happen. Would Pogba work for Juve and would United take Ronaldo back, having sold him to Real for a then-world record £80m in 2009?</p><p>Juventus coach Andrea Pirlo played alongside Pogba during their time together in Turin and they formed a midfield that saw the Italians reach the 2015 Champions League final. Pirlo knows what Pogba can offer, how his vision, passing range, goal-scoring ability and athleticism would improve his Juve team and how he would give the club a midfielder in the prime years of his career. If signing Pogba meant losing Ronaldo, it would be a tough call, but Juve have to start to plan for life without their superstar and this deal would make sense.</p><p>For United, trading a 27-year-old for a player about to turn 36 would initially seem like madness, but Pogba is not performing for Ole Gunnar Solskjaer's team, and the club are getting little or no return on their investment and salary outlay. They would lose a midfielder and replace him with a forward, but Ronaldo remains a potent threat in front of goal and no team could realistically reject the chance to sign a player who, even at this stage of his career, has scored 14 goals in 12 games so far this season.</p><p>From a football perspective, United and Juventus would benefit from a swap.</p><h2>This might be a \"swap,\" but it would still be a huge financial commitment for both clubs, right?</h2><p>Juventus would be getting the chance to sign a player who would cost half of Ronaldo's annual salary -- that's an obvious plus for the Italians. And at 27, Pogba would also give Juventus the ability to realise a return on the player by selling him for a fee in the future.</p><p>From a business perspective, it's difficult to see a downside for Juventus, although their commercial power would likely take a hit if they could no longer offer Ronaldo's image and branding to potential sponsors. That said, Pogba is also a huge figure in terms of commercial visibility across the globe. The commercial boost would be the sweetener for United, because Ronaldo would cost much more than Pogba on a weekly basis, even if he took a cut on his Juventus salary. United have capitalised on Pogba's global appeal and his loss would be a blow in most circumstances, but not if he was replaced by Ronaldo, who is on a different level entirely.</p><p>There's no question, though, that swapping Pogba for Ronaldo would see United footing most of the bill because they would have to find more for wages. But the payback on the pitch, and off it, would likely exceed what Pogba has brought to United; it would make the numbers stack up for the Old Trafford side. And if <a href=\"/soccer/team?id=382\">Manchester City</a> manage to pull off a deal for <a href=https://www.espn.com/soccer/player/_/id/45843/Lionel-Messi>Lionel Messi</a> next summer, United will need to respond with their own box office star. Ronaldo and Messi, playing the final chapters of their careers in Manchester, would be impossible to resist.</p><aside class=\"inline full inline-photo\"><figure><picture><source><source><img class=\"lazyload lazyload\"></picture><figcaption class=photoCaption>Manchester United's Paul Pogba and Juventus' Cristiano Ronaldo would constitute football's biggest-ever swap deal.&nbsp;<cite>Getty</cite></figcaption></figure></aside><h2>Pogba enjoyed his time in Turin, so a return would be an easy sell, but didn't Ronaldo find it tough in Manchester?</h2><p>If you speak to Ronaldo's former United teammates, they all have fond memories of his time at Old Trafford between 2003 and 2009, but they always say one thing: he hated the weather. As a young player from the sun-drenched island of Madeira, Manchester was a culture shock for Ronaldo. It was too cold and too wet, and way too often, for his liking, and he also didn't enjoy darkness setting in around 4 p.m. during the winter months. But despite his dislike of the climate, Ronaldo stuck around for six years in Manchester and he's made no secret of his affection for the club and the city.</p><p>His subsequent time in Madrid and Turin will have taught him that most European cities are cold in the winter, so a return to Manchester would not be akin to signing up for two years in the Arctic Circle. But if there is a barrier to any potential return to Old Trafford, the climate will not be in United's favour.</p><h2>But don't United want to move away from signing older players?</h2><p>Yes, there has been a concerted effort to reduce the age of the squad at Old Trafford and the expensive mistake of signing then-29-year-old Sanchez in January 2018 was a turning point in United's recruitment strategy. But there is also a case that each player and signing should be judged on its merits, which is why United signed the 33-year-old free agent <a href=https://www.espn.com/soccer/player/_/id/95469/Edinson-Cavani>Edinson Cavani</a> in October. <a href=https://www.espn.com/soccer/player/_/id/11001/Zlatan-Ibrahimovic>Zlatan Ibrahimovic</a> was 34 when he arrived on a free transfer from Paris Saint-Germain in 2016. He hit 28 goals in 46 games in his first season and, but for a serious knee injury, is likely to have stayed at the club for longer.</p><p>So age is not a permanent barrier to player deals at United -- the deal simply has to make sense, both on the pitch and off it. Ronaldo's stats continue to outshine players of all ages and there is no reason to believe that he doesn't have at least two more years at the top level.</p><aside class=module-iframe-wrapper> </aside><h2>OK, so if Juventus want Pogba back, why not offer somebody else in part-exchange? Dybala, maybe?</h2><p>The financial issue of having both Ronaldo and Pogba on the payroll would leave Juventus needing to do some serious cost-cutting elsewhere and the numbers wouldn't make sense unless they sold three to four of their biggest names.</p><p>United wanted <a href=https://www.espn.com/soccer/player/_/id/164839/Paulo-Dybala>Paulo Dybala</a> at the start of last season, but the <a href=\"/soccer/team?id=202\">Argentina</a> international made it clear he had no interest in moving to Old Trafford, so you can rule that one out. Former Arsenal midfielder <a href=https://www.espn.com/soccer/player/_/id/98681/Aaron-Ramsey>Aaron Ramsey</a> could be used to tempt United to sell Pogba, but the Welshman's injury record would set alarm bells ringing at Old Trafford, and United would also be getting a downgrade on the World Cup-winning, but inconsistent, <a href=\"/soccer/team?id=478\">France</a> international. <a href=https://www.espn.com/soccer/player/_/id/239349/Matthijs-de-Ligt>Matthijs de Ligt</a> is a player of interest to United, but the Dutch defender is represented by Raiola -- that may be an instant deal-breaker for the Old Trafford hierarchy.</p><p>But it is fairly straightforward -- the only deal that works for both sides is Ronaldo for Pogba, and vice-versa. Nothing else measures up.</p><h2>So will it happen then?</h2><p>The word from within United is that Ronaldo is no longer on their radar. They have tried and failed on numerous occasions since he left to get him back to Manchester, but the stars have never quite aligned.</p><p>As a straight purchase, it doesn't make sense for United, but the Pogba element is what makes Ronaldo a feasible option again. United don't want to lose Pogba as a free agent in 2022, but they know that the transfer market is in the midst of a financial crisis, which leaves them with nobody to sell to next summer. And Juventus may need to cash in on Ronaldo within the next six months to get some return on their investment and avoid another season of big wages, with nothing but a free agent at the end of it.</p><p>From a football and business perspective, there are more pluses than minuses for both clubs when it comes to a Pogba-Ronaldo swap, and the case can be made for both players to do the deal. But will it happen? Watch this space.</p>\n</div></body></html>",
            "source": "https://www.espn.com/soccer/blog-soccer-transfers/story/4266922/why-man-united-should-get-ronaldo-back-and-let-pogba-go-to-juventus",
            "title": "Why Man United should get Ronaldo back and let Pogba go to Juventus",
            "author": null,
            "published": null,
            "image": "https://a2.espncdn.com/combiner/i?img=%2Fphoto%2F2020%2F1217%2Fr791490_1296x729_16%2D9.jpg",
            "description": "Cristiano Ronaldo and Paul Pogba trading places at Manchester United and Juventus is a swap deal that, in many ways, would suit everyone.",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab36130cba20187c5dce",
                    "title": "Sport",
                    "color": "#00736d"
                },
                {
                    "children": [],
                    "_id": "5fdcc504de09ff30845f9f2f",
                    "title": "Voetball",
                    "color": "#4279a6"
                }
            ],
            "createdAt": "2020-12-18T14:28:12.162+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcaf66130cba20187c5e13",
            "html": "<html><head></head><body><div class=article-content> <p>Tennis Australia has locked in arrangements&nbsp;to begin the 2021 Australian Open on February 8, and the first restructuring of 2021 tennis tournament calendar has officially taken shape.</p> <p>The Delray Beach Open, originally scheduled to begin its main-draw action on February 15, will now launch the 2021 ATP season on Tuesday, January 5. For those who can get to the ATP 250 event in South Florida, it provides a rare chance to compete&nbsp;ahead of the&nbsp;14-day quarantine every competitor&nbsp;will need to complete upon arriving in Melbourne.</p> <p>Those competitors will also be playing in front of fans—a maximum of 2,000, or roughly 25 percent of the venue's stadium capacity.</p> <p>“The City of Delray Beach along with our tournament staff worked very quickly to take advantage of this chance to play host to a season-opening event,” <a href=https://yellowtennisball.com/delray-beach-open-by-vitacost-com-to-start-2021-tennis-season/ >said tournament director Mark Baron</a>. “The players are eager to get back to playing in tournaments and we are happy to provide that opportunity. We look forward to welcoming them as well as our fans to a healthy and safely produced event in a few short weeks.”</p> <p>At the same time, another ATP 250 tournament will take place in Antalya, Turkey.</p> <p>As previously rumored, Australian Open qualifying will not be held Down Under, in order to reduce the number of players and their respective companions&nbsp;entering the country. (As Jon Wertheim <a href=https://twitter.com/jon_wertheim/status/1339218676323667973>tweeted</a>, \"<span class=\"css-16my406 css-901oao r-1qd0xha r-ad9z0x r-bcqeeo r-qvutc0\">The Australian Government has capped the total participants allowed to enter Australia under the Special Practice Quarantine program to 1000 people. This quota applies to players and their team members.\") </span>Instead, that portion of the tournament will be hosted in Doha, from January 10-13.</p> <p>Once players have finished&nbsp;their two-week quarantines in Melbourne, where they will be permitted to spend five hours outside of their hotel room to train and practice each day,&nbsp;Tennis Australia will offer multiple playing opportunities in the lead-up to the main event. Beginning February 1, the ATP Cup will get underway in a truncated&nbsp;form, alongside a pair of ATP 250 events.</p> <p><img alt=\"\" src=//cdn.tennis.com/uploads/wysiwyg/2020/12/16/ab91ba06-2a4b-4fde-834c-c88f8bef4df8.jpg></p> <p>The ATP Challenger Tour also released the first five weeks of its calendar:</p> <blockquote class=twitter-tweet> <p>Calendar Update ‼️ </p><p> The schedule for the first five weeks of the 2021 ATP Challenger Tour season has been released. ⬇️⬇️</p><p></p> — ATP Challenger Tour (@ATPChallenger) <a href=\"https://twitter.com/ATPChallenger/status/1339368236706656256?ref_src=twsrc%5Etfw\">December 17, 2020</a></blockquote> <p>As of now, the WTA has not announced its updated calendar.</p> <p><em>We will continue to update this developing story.</em></p> </div></body></html>",
            "source": "/pro-game/2020/12/2021-tennis-calendar-melbourne-multiple-events-australian-open-atp-cup-wta-delray/92119/",
            "title": "Melbourne events to supplement Australian Open; ATP Delray opens 2021",
            "author": null,
            "published": null,
            "image": "https://cdn.tennis.com/uploads/img/2020/12/14/b4510dd4bc7e4a1396850eb38bed99f3.jpg",
            "description": "As of now, the WTA has not announced its updated calendar.",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab44130cba20187c5dd0",
                    "title": "Tennis",
                    "color": "#0edd3b"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab3d130cba20187c5dcf",
                            "title": "Voetbal",
                            "value": "Voetbal",
                            "label": "Voetbal",
                            "color": "#ba0ea4",
                            "children": []
                        },
                        {
                            "_id": "5fdcab44130cba20187c5dd0",
                            "title": "Tennis",
                            "value": "Tennis",
                            "label": "Tennis",
                            "color": "#439254",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab36130cba20187c5dce",
                    "title": "Sport",
                    "color": "#00736d"
                }
            ],
            "createdAt": "2020-12-18T14:32:22.407+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcaf95130cba20187c5e16",
            "html": "<html><head></head><body><p><i>2020 was a season like no other.&nbsp;<a href=https://www.tennis.com/tags/The-Moments-of-the-Year-2020/ >Click here to review</a>&nbsp;the top moments from the pandemic-ravaged year.</i></p> <p>It was bound to take something unprecedented to break up the dominance of Roger Federer, Rafael Nadal and Novak Djokovic at the Grand Slams. As it happens, it took a few such things.</p>\n<p>It took a pandemic, turning the tennis schedule upside down and convincing Nadal not to play the US Open. It took a second right knee surgery for Federer, sidelining him for the rest of the season. It took&nbsp;a default of the top seed&nbsp;at a Grand Slam&nbsp;for the first time ever, derailing Djokovic's campaign in the fourth round of Flushing Meadows.&nbsp;&nbsp;</p>\n<p>And finally, it took a fifth-set tiebreaker for the first time ever in the final of the US Open.</p>\n<p>Other than that, it was business as usual.</p>\n<p>All the same, it could hardly have produced a more worthy new champion. Having already reached three Grand Slam finals, <a href=/player/743/dominic-thiem/ >Dominic Thiem</a> had long been regarded as the player who would make the breakthrough.</p>\n<p>But he had faced some tough opponents in those Grand Slam finals—Nadal at the French Open, twice, and Djokovic at the Australian Open. But at the US Open, he had an even tougher foe: himself.</p>\n<p><img alt=\"\" src=//cdn.tennis.com/uploads/wysiwyg/2020/12/02/gettyimages-1272330216.jpg><br>\n<small><em>Getty Images</em></small></p>\n<p>The 27-year-old Austrian was&nbsp;expected to win when he&nbsp;stepped on court&nbsp;against Alexander&nbsp;Zverev in the final, and it showed. Playing tentative and nervy tennis, he rapidly went down two sets against his 23-year-old opponent. But he dug in for the third, sending three racquets to be restrung in bold defiance of the scoreline. At that point, it was Zverev who increasingly got tight, and the two found themselves in a deciding set that made up in tension what it lacked in quality.</p>\n<p>Zverev got the first break at 3-5, Thiem broke back for 5-5, and then another exchange of breaks followed, sending them into a tiebreaker—the first time it would be played in a US Open final. One of them would emerge as the first champion outside of the Big 3 and Andy Murray since Stanislas Wawrinka at the 2016 US Open; the newest first-time winner since&nbsp;Marin&nbsp;Cilic in 2014; and the only Slam champion on tour under 30 years old.</p>\n<p>By this point, both players could hardly move. Thiem was cramping, Zverev was double faulting, and the points went erratically back and forth until the older, more experienced player found some final ounces of energy to clinch the match and the title.&nbsp;</p>\n<p>During the trophy ceremony, the new champion said he would prefer it if there had been \"two winners,\" but his victory was also one for the rest of the men's field.</p>\n<p>Thiem had&nbsp;finally&nbsp;won his first&nbsp;Grand Slam. And perhaps just as significantly, a player—any player—had&nbsp;finally won&nbsp;a first men's Grand Slam singles title.</p></body></html>",
            "source": "/pro-game/2020/12/top-moments-2020-thiem-wins-first-grand-slam-us-open-big-3/92011/",
            "title": "Top Moments of 2020: Thiem wins first Slam, breaks Big 3 stranglehold",
            "author": null,
            "published": null,
            "image": "https://cdn.tennis.com/uploads/img/2020/12/11/809f3207426b47c59aa3a83dd083d4fc.jpg",
            "description": "The Austrian had long been regarded as the player who would make the breakthrough.",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab44130cba20187c5dd0",
                    "title": "Tennis",
                    "color": "#0edd3b"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab3d130cba20187c5dcf",
                            "title": "Voetbal",
                            "value": "Voetbal",
                            "label": "Voetbal",
                            "color": "#ba0ea4",
                            "children": []
                        },
                        {
                            "_id": "5fdcab44130cba20187c5dd0",
                            "title": "Tennis",
                            "value": "Tennis",
                            "label": "Tennis",
                            "color": "#439254",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab36130cba20187c5dce",
                    "title": "Sport",
                    "color": "#00736d"
                }
            ],
            "createdAt": "2020-12-18T14:33:09.834+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb04c130cba20187c5e19",
            "html": "<html><head></head><body><div class=\"gel-10/12@m gel-7/8@l gel-pica gs-u-ml0@l qa-story-body story-body\"><figure class=\"story-body__media gs-u-mb-alt+ qa-story-body-media gs-u-mt0 story-body__media--figure story-body__media--lead\"><span class=\"gs-u-display-block story-body__media\"><span class=\"gs-u-display-block gs-o-responsive-image\"><img alt=\"Ravichandran Ashwin celebrates a wicket\" class=qa-srcset-image sizes=\"(min-width: 1280px) 800px, (min-width: 900px) 624px, (min-width: 600px) 976px, (min-width: 400px) 624px, 400px\" src=https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/091F/production/_116153320_r_ashwin_getty.jpg srcset=\"https://ichef.bbci.co.uk/onesport/cps/400/cpsprodpb/091F/production/_116153320_r_ashwin_getty.jpg 400w, https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/091F/production/_116153320_r_ashwin_getty.jpg 624w, https://ichef.bbci.co.uk/onesport/cps/800/cpsprodpb/091F/production/_116153320_r_ashwin_getty.jpg 800w, https://ichef.bbci.co.uk/onesport/cps/976/cpsprodpb/091F/production/_116153320_r_ashwin_getty.jpg 976w\"></span></span><figcaption class=\"gel-brevier gs-u-ph+ gs-u-pv-alt story-body__media__caption story-body__media__caption--image\">Ravichandran Ashwin's three wickets came in the space of eight overs</figcaption></figure><table class=\"gs-o-table story-body__table\"><thead class=\"gel-brevier gs-o-table__head\"></thead><tbody class=gel-long-primer><tr><td class=gs-o-table__cell><strong>First Test, Adelaide Oval (day two)</strong></td></tr><tr><td class=gs-o-table__cell><strong>India 244 </strong><span>(Kohli 74, Starc 4-53)</span><strong> &amp; 9-1</strong></td></tr><tr><td class=gs-o-table__cell><strong>Australia 191 </strong><span>(Paine 73*; Ashwin 4-55, Yadav 3-40)</span></td></tr><tr><td class=gs-o-table__cell><em>India lead by 62 runs</em></td></tr><tr><td class=gs-o-table__cell><a class=story-body__internal-link href=https://www.bbc.co.uk/sport/cricket/scorecard/ECKO48440><span>Scorecard</span></a></td></tr></tbody></table><p class=\"gel-pica-bold qa-introduction\"><span>India took the upper hand as 15 wickets fell on day two of a fast-moving first Test against Australia in Adelaide.</span></p><div><p><span>The superb tourists bowled Australia out for 191 but lost opener Prithvi Shaw in reaching 9-1, a lead of 62.</span></p></div><p><span>Australia captain Tim Paine made an unbeaten 73, while Ravichandran Ashwin took 4-55 and Umesh Yadav 3-40.</span></p><p><span>Earlier, India slipped from 233-6 overnight to 244 all out inside the first 19 balls of the day as Mitchell Starc finished with 4-53.</span></p><p><span>Pat Cummins claimed 3-48 and also bowled Shaw through the gate in the six overs possible before the close in India's second innings.</span></p><p><span>It could have been better for India, but they dropped Paine on 26 and twice reprieved Marnus Labuschagne, who made 47, in a sloppy fielding display.</span></p><p><span>Although Australia, superbly marshalled by Paine, added 80 for the final three wickets, India remain favourites to win this day-night encounter and take a 1-0 lead in the four-Test series.</span></p><ul><li><a class=story-body__internal-link href=https://www.bbc.co.uk/sport/cricket/52854722><span>Australia v India - fixtures &amp; results</span></a></li></ul><h3 class=story-body__crosshead>How costly were India's drops?</h3><p><span>At the end of day one batsman </span><a class=story-body__internal-link href=https://www.bbc.co.uk/sport/cricket/55347061><span>Cheteshwar Pujara spoke</span></a><span> about India's desire to get up to at least 275, but their lower order succumbed tamely to the pace and accuracy of Starc and Cummins.</span></p><p><span>As disappointing as they were with the bat, India were superb with the ball on a pitch that offered some turn but little for the seamers.</span></p><p><span>Stand-in opener Matthew Wade and Joe Burns dug in for over an hour before both were trapped lbw for eight by Jasprit Bumrah.</span></p><p><span>Steve Smith, Australia's talisman, looked unusually scratchy - he edged short of Virat Kohli at slip before fencing to Ajinkya Rahane at slip in off-spinner Ashwin's first over to depart for one.</span></p><p><span>Travis Head and debutant Cameron Green fell cheaply to Ashwin - the former to a leaping Kohli catch at mid-wicket - to leave the hosts 79-5.</span></p><p><span>Labuschagne struggled against the shorter ball, dropped by Bumrah at fine leg on 12 and by Shaw at square leg on 21. He also overturned a caught behind on 41.</span></p><p><span>When Labuschagne and Pat Cummins were dismissed in the same Yadav over Australia were 111-7 and facing a three-figure deficit, but the superb Paine - who was also put down by Mayank Agarwal at deep fine leg - combined solid defence with counter-attacking strokeplay.</span></p><p><span>He hit 10 fours in his 99-ball innings, receiving useful support from Starc, Nathan Lyon and Josh Hazlewood to limit India's lead to 53.</span></p><h3 class=story-body__crosshead>'Test cricket like this cannot be beaten' - reaction</h3><p><strong>Australia's Marnus Labuschagne</strong><span>: \"It was a day full of action. We fought hard with the bat and got ourselves close to their total, which is big. We got their bowlers bowling a few more overs, so we're very much in this game.</span></p><p><span>\"It's just one of those wickets where you never quite feel in; you are just grinding your way into the innings. </span></p><p><span>\"It was a nice opportunity to come out and bowl again - a few more overs might have been nice to potentially get them two or three down.</span></p><p><span>\"The way Tim and the lower order batted was superb, scrapping our way through, and that's the way it's going to be for the whole game.\"</span></p><p><strong>Commentator Jim Maxwell on the BBC World Service's Stumped podcast:</strong><span> \"India will be happiest going into day three because Australia has to bat last.</span></p><p><span>\"There's a bit of uneven bounce - that's why batting has been so difficult and at times very painstaking to watch - but the contest has been thrilling. </span></p><p><span>\"If India can lead by 200-plus, they're in an excellent position to go one up in the series.\"</span></p><p><strong><em>Listen to live coverage of day three on BBC Radio 5 Live Sports Extra and the BBC Sport website on Saturday from 04:40 GMT.</em></strong></p><span class=\"gs-u-display-block story-body__media gs-u-mb-alt+ qa-story-body-media\"><span class=\"gs-u-display-block gs-o-responsive-image\"><img alt=\"Around the BBC iPlayer banner\" class=qa-srcset-image sizes=\"(min-width: 1280px) 800px, (min-width: 900px) 624px, (min-width: 600px) 976px, (min-width: 400px) 624px, 400px\" src=https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/86E1/production/_112292543_aroundthebbc-iplayerfulllogo-nc.png srcset=\"https://ichef.bbci.co.uk/onesport/cps/400/cpsprodpb/86E1/production/_112292543_aroundthebbc-iplayerfulllogo-nc.png 400w, https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/86E1/production/_112292543_aroundthebbc-iplayerfulllogo-nc.png 624w, https://ichef.bbci.co.uk/onesport/cps/800/cpsprodpb/86E1/production/_112292543_aroundthebbc-iplayerfulllogo-nc.png 800w, https://ichef.bbci.co.uk/onesport/cps/976/cpsprodpb/86E1/production/_112292543_aroundthebbc-iplayerfulllogo-nc.png 976w\"></span></span><span class=\"gs-u-display-block story-body__media gs-u-mb-alt+ qa-story-body-media\"><span class=\"gs-u-display-block gs-o-responsive-image\"><img alt=\"Around the BBC iPlayer footer\" class=qa-srcset-image sizes=\"(min-width: 1280px) 800px, (min-width: 900px) 624px, (min-width: 600px) 976px, (min-width: 400px) 624px, 400px\" src=https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/ADF1/production/_112292544_iplayerpinkfooter-nc.png srcset=\"https://ichef.bbci.co.uk/onesport/cps/400/cpsprodpb/ADF1/production/_112292544_iplayerpinkfooter-nc.png 400w, https://ichef.bbci.co.uk/onesport/cps/624/cpsprodpb/ADF1/production/_112292544_iplayerpinkfooter-nc.png 624w, https://ichef.bbci.co.uk/onesport/cps/800/cpsprodpb/ADF1/production/_112292544_iplayerpinkfooter-nc.png 800w, https://ichef.bbci.co.uk/onesport/cps/976/cpsprodpb/ADF1/production/_112292544_iplayerpinkfooter-nc.png 976w\"></span></span></div></body></html>",
            "source": "https://www.bbc.co.uk/sport/cricket/55361830",
            "title": "Australia collapse as India open up lead",
            "author": null,
            "published": null,
            "image": "https://ichef.bbci.co.uk/live-experience/cps/624/cpsprodpb/11003/production/_116153696_umesh_yadav_getty.jpg",
            "description": "India take the upper hand as 15 wickets fall on day two of a fast-moving first Test against Australia in Adelaide.",
            "tags": [
                {
                    "children": [
                        {
                            "_id": "5fdcab3d130cba20187c5dcf",
                            "title": "Voetbal",
                            "value": "Voetbal",
                            "label": "Voetbal",
                            "color": "#ba0ea4",
                            "children": []
                        },
                        {
                            "_id": "5fdcab44130cba20187c5dd0",
                            "title": "Tennis",
                            "value": "Tennis",
                            "label": "Tennis",
                            "color": "#439254",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab36130cba20187c5dce",
                    "title": "Sport",
                    "color": "#00736d"
                }
            ],
            "createdAt": "2020-12-18T14:36:12.910+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb085130cba20187c5e1b",
            "html": "<html><head></head><body><div><article class=meteredContent><section class=\"cx cy cz aj cv cw da s\"></section><div><section class=\"dg df dh di dj\"><div class=\"n p\"><div class=\"aj ab ac ae af ag ai dk\"><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3c2b>This article aims to outline all of the key points of the Python programming language. My target is to keep the information <strong class=\"hf hz\">short, relevant, and focus</strong> on the most important topics which are absolutely required to be understood.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7b88><strong class=\"hf hz\">After reading this blog, you will be able to use any Python library or implement your own Python packages.</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=bfd7><em class=ia>You are not expected to have any prior programming knowledge and it will be very quick to grasp all of the required concepts.</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2960><strong class=\"hf hz\">I will also highlight top discussion questions that people usually query regarding Python programming language.</strong></p><blockquote class=ib><p class=\"dn b hy do fc ic id ie if ig ih ii ij\" id=a749>Lets build the knowledge gradually and by the end of the article, you will have a thorough understanding of Python.</p></blockquote><figure class=\"cx cy iq paragraph-image il im in io ip\"><img alt=\"Image for post\" class=\"aj it t u v\" sizes=642px src=https://miro.medium.com/max/1284/1*V3RT5yJmh6ihakR7jhg2dw.png srcset=\"https://miro.medium.com/max/552/1*V3RT5yJmh6ihakR7jhg2dw.png 276w, https://miro.medium.com/max/1104/1*V3RT5yJmh6ihakR7jhg2dw.png 552w, https://miro.medium.com/max/1280/1*V3RT5yJmh6ihakR7jhg2dw.png 640w, https://miro.medium.com/max/1284/1*V3RT5yJmh6ihakR7jhg2dw.png 642w\" width=642></figure><blockquote class=ib><p class=\"dn b hy do fc ic id ie je jf jg jh ji\" id=0f5a>This article contains 25 key topics. Let’s Start.</p></blockquote><h2 class=jj id=f637>1. Introducing Python</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=8947>Interpreted <strong class=\"hf hz\">high-level object-oriented dynamically-typed scripting</strong> language.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=0575>As a result, <strong class=\"hf hz\">run time errors</strong> are usually encountered.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=bd25>Python is the most popular language due to the fact that it’s easier to code and understand it.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=8caa>Python is an object-oriented programming language and can be used to write functional code too.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=0b48>It is a suitable language that bridges the gaps between business and developers.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e5c3>Subsequently, it takes less time to bring a Python program to market compared to other languages such as C#/Java.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=0c2b>Additionally, there are a large number of python machine learning and analytical packages.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9dbe>A large number of communities and books are available to support Python developers.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e0de>Nearly all types of applications, ranging from forecasting analytical to UI, can be implemented in Python.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=c221>There is no need to declare variable types. Thus it is quicker to implement a Python application.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=7767>Python is slower than C++, C#, Java. This is due to the lack of Just In Time optimisers in Python.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=bdee>Python syntactical white-space constraint makes it slightly difficult to implement for new coders.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=5890>Python does not offer advanced statistical features as R does.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=18a4>Python is not suitable for low-level systems and hardware interaction.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=30ec>This image illustrates how python runs on our machines:</p><figure class=\"lc ld le lf lg cx cy iq paragraph-image\"><img alt=\"Image for post\" class=\"aj it t u v\" sizes=483px src=https://miro.medium.com/max/966/1*kDCG2OHPSUT8SBM8n9UPkQ.png srcset=\"https://miro.medium.com/max/552/1*kDCG2OHPSUT8SBM8n9UPkQ.png 276w, https://miro.medium.com/max/966/1*kDCG2OHPSUT8SBM8n9UPkQ.png 483w\" width=483></figure><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=ad45>The key here is the Interpreter that is responsible for translating high-level Python language to low-level machine language.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5aef>The way Python works is as follows:</p><ol><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv hg hj hn hr hv li\" id=66cd>A Python virtual machine is created where the packages (libraries) are installed. Think of a virtual machine as a container.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kw kx ky kz la li\" id=56db>The python code is then written in .py files</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kw kx ky kz la li\" id=b530>CPython compiles the Python code to bytecode. This bytecode is for the Python virtual machine.</li></ol><blockquote class=ib><p class=\"dn b hy do fc ic id ie je jf jg jh ji\" id=ac22><em class=lj>Now, this virtual machine is machine-dependent but the Python code isn’t.</em></p></blockquote><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df lk ll lm ln lo\" id=5fe7>4. When you want to execute the bytecode then the code will be interpreted at runtime. The code will then be translated from the bytecode into the machine code. The bytecode is not dependent on the machine on which you are running the code. This makes Python machine-independent.</p><blockquote class=ib><p class=\"dn b hy do fc ic id ie if ig ih ii ij\" id=ab7e><em class=lj>Python byte code is Python virtual machine-dependent and this makes Python machine-independent.</em></p></blockquote><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df lk ll lm ln lo\" id=3017>The point to note is that we can write Python code in one OS, copy it to another OS and simply run it.</p><h2 class=jj id=2b21>2. Variables — Object Types And Scope</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=5cd1>Variables store information that can be used and/or changed in your program. This information can be an integer, text, collection, etc.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=4e85>Variables are used to hold user inputs, local states of your program, etc.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=314d>Variables have a <strong class=\"hf hz\">name&nbsp;</strong>so&nbsp;that&nbsp;they&nbsp;can&nbsp;be&nbsp;referenced in the code.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=91ef>The fundamental concept to understand is that everything is an object in Python.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=61a5><strong class=\"hf hz\">Python supports numbers, strings, sets, lists, tuples, and dictionaries. These are the standard data types. I will explain each of them in detail.</strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=b491>Declare And Assign Value To Variable</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=1aee>Assignment sets a value to a variable.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=fa25>To assign variable a value, use the equals sign (=)</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=72dd>Assigning a value is known as <strong class=\"hf hz\">binding </strong>in Python. In the example above, we have assigned the value of 1 to myFirstVariable.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=df36><em class=ia>Note how I assigned an integer value of 1 and then a string value of “Hello You” to the same myFirstVariable variable. </em><strong class=\"hf hz\"><em class=ia>This is possible due to the fact that the data types are dynamically typed in python.</em></strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4d77>This is why Python is known as a dynamically typed programming language.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7cc4>If you want to assign the same value to more than one variables then you can use the chained assignment:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=a2be>Numeric</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=3dfe>Integers, decimals, floats are supported.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=ed59>Longs are also supported. They have a suffix of L e.g. 9999999999999L</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=a4bd>Strings</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=4d9d>Textual information. Strings are sequence of letters.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=967c>A string is an array of characters</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=5f52>A string value is enclosed in quotation marks: single, double or triple quotes.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=87c9>Strings are immutable. Once they are created, they cannot be changed e.g.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=c406>When string variables are assigned a new value then internally, Python creates a new object to store the value.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=79ed>Therefore a reference/pointer to an object is created. This pointer is then assigned to the variable and as a result, the variable can be used.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3227>We can also assign one variable to another variable. All it does is that a new pointer is created which points to the same object:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=dfd1>Variables can have local or global scope.</h2><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=c346>Local Scope</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=55c8>Variables declared within a function, as an example, can only exist within the block.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=b818>Once the block exists, the variables also become inaccessible.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=aba2>In Python, if-else and for/while loop block doesn’t create any local scope.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=fd30>Output:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7dee>With if-else block</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f914>Output:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=69aa>Global Scope</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=e2f8>Variables that can be accessed from any function have a global scope. They exist in the __main__ frame.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=4fa8>You can declare a global variable outside of functions. It’s important to note that to assign a global variable a new value, you will have to use the “<em class=ia>global</em>” keyword:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a2f9><em class=ia>Removing the line “global TestMode” will only set the variable to False within the some_function() function.</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=ff1b><strong class=\"hf hz\">Note: Although I will write more on the concept of modules later, but if you want to share a global variable across a number of modules then you can create a shared module file e.g. configuration.py and locate your variable there. Finally, import the shared module in your consumer modules.</strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=c358>Finding Variable Type</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=a8bf>If you want to find the type of a variable, you can implement:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=56d6>Comma In Integer Variables</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=bf46>Commas are treated as a sequence of variables e.g.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=5a71>3. Operations</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=9ed7>Allows us to perform computation on variables</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=6a86>Python supports basic <strong class=\"hf hz\">*, /, +, -</strong></li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=6af9>Python also supports floor division</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=434b>Note: the return type of division is always <strong class=\"hf hz\">float</strong> as shown below:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=de72>Additionally, python supports exponentiation via ** operator:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=4068>Python supports Modulus (remainder) operator too:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6792>There is also a divmod in-built method. It returns the divider and modulus:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=fa0a>String Operations</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=70a4><strong class=\"hf hz\">Concat Strings:</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=07b1>Remember string is an immutable data type, therefore, concatenating strings creates a new string object.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=82e5><strong class=\"hf hz\">Repeat String:</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=102c><strong class=\"hf hz\">Slicing:</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d05a><strong class=\"hf hz\">Reversing:</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=35ed><strong class=\"hf hz\">Negative Index:</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4a60>If you want to start from the last character then use negative index.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=1b38>It is also used to remove any new line carriages/spaces.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f649>Each element in an array gets two indexes:</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=6ee3>From left to right, the index starts at 0 and increments by 1</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=d672>From right to left, the index starts at -1 and decrements by 1</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=30a6>Therefore, if we do y[0] and y[-len(y)] then both will return the same value: ‘a’</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=73de><strong class=\"hf hz\">Finding Index</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e8f5><strong class=\"hf hz\">For Regex, use:</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=6a82>split(): splits a string into a list via regex</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2fe5>sub(): replaces matched string via regex</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=876a>subn(): replaces matched string via regex and returns number of replacements</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=f376><strong class=az>Casting</strong></h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=282b>str(x): To string</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9da6>int(x): To integer</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=078c>float(x): To floats</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=7de7>Set Operations</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=63f3>A set is an unordered data collection without any duplicates. We can define a set variable as:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d1ea>This will print: {1, 2, 3, 5, 8, 9, -1}</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0d02>Note duplicates are removed.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b600>Set has <em class=ia>a item in set, len(set)</em> and <em class=ia>for item in set </em>operations. However it does not support indexing, slicing like lists.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5420>Some of the most important set operations are:</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=c8ae>set.add(item) — adds item to the set</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=ee6e>set.remove(item) — removes item from the set and raises error if it is not present</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2294>set.discard(item) — removes item from the set if it is present</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=4468>set.pop() — returns any item from the set, raises KeyError if the set is empty</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=8783>set.clear() clears the set</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b613><strong class=\"hf hz\">Intersect Sets</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=db5c>To get what’s common in two sets</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=94e9><strong class=\"hf hz\">Difference In Sets</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=946d>To retrieve the difference between two sets:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=195f><strong class=\"hf hz\">Union Of Collections</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=f997>To get a distinct combined set of two sets</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=c93a>Ternary Operator</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=015b>Used to write conditional statements in a single line.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=9f93><strong class=\"hf hz\">Syntax:</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=edb7><strong class=\"hf hz\"><em class=ia>[If True] if [Expression] Else [If False]</em></strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7ef9>For example:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=c1a9>4. Comments</h2><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=84ca>One can use:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=3197>5. Expressions</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=35fb>Expressions can perform boolean operations such as:</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=1fff>Equality: ==</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2b4b>Not Equal: !=</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=5e9a>Greater: &gt;</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=ed44>Less: &lt;</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=23da>Greater Or Equal &gt;=</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=b9fe>Less Or Equal &lt;=</li></ul><h2 class=jj id=6b12>6. Pickling</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=4730>Converting an object into a string and dumping the string into a binary file is known as pickling. The reverse is known as unpickling.</p><h2 class=jj id=7614>7. Functions</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=0f5d>Functions are sequence of statements that you can execute in your code. If you see repetition in your code then create a reusable function and use it in your program.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=5c41>Functions can also reference other functions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2ad1>Functions eliminate repetition in your code. They make it easier to debug and find issues.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=fa4c>Finally, functions enable code to be understandable and easier to manage.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=0691>In short, functions allow us to split a large application into smaller chunks.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=b3b3>Call the len(x) function</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=05c9>Arguments</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=5ec9>Arguments can be added to a function to make the functions generic.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=04be>This exercise is known as generalization.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=f301>You can pass in variables to a method:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=bcef>We can pass in optional arguments by providing a default value to an argument:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=702b>If your function can take in any number of arguments then add a * in front of the parameter name:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=36a2>It allows you to pass a varying number of keyword arguments to a function.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=c2d8>You can also pass in dictionary values as keyword arguments.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=608f>This will print:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5028>(3, 1)<br>(‘alpha’, ‘beta’)<br>{‘a’: 1, ‘b’: 2}<br>alpha<br>1</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=0170>Return</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=82a3>Functions can return values such as:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=7612>If a function is required to return multiple values then it’s suitable to return a tuple (comma separated values). I will explain tuples later on:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a7b2><strong class=\"hf hz\">Lambda</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=d81c>Single expression anonymous function.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=73eb>It is an inline function.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5940><strong class=\"hf hz\">Syntax</strong>:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4264><em class=ia>variable = lambda arguments: expression</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=03c2><em class=ia>Lambda functions can be passed as arguments to other functions.</em></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=c7b4>Object Identity</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=a170>I will attempt to explain the important subject of Object Identity now.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=782c>Whenever we create an object in Python such as a variable, function, etc, the underlying Python interpreter creates a number that uniquely identifies that object. Some of the objects are created up-front.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=1db0>When an object is not referenced anymore in the code then it is removed and its identity number can be used by other variables.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a66a><strong class=\"hf hz\">dir() and help()</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=222a>dir() -displays defined symbols</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=38a0>help() — displays documentation</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=2a4e>Let’s understand it in detail:</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=aa0a>Consider the code below:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=357b>var_one and var_two are the two variables that are defined in the code above. Along with the variables, a function named func_one is also defined. An important note to keep in mind is that everything is an object in Python, including a function.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e5ab>Within the function, we have assigned the value of 234 to var_one and created a new variable named var_three and assigned it a value of ‘abc’.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=cc3a><strong class=\"hf hz\">Now, let’s understand the code with the help of dir() and id()</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=fdef>The above code and its variables and functions will be loaded in the Global frame. The global frame will hold all of the objects that the other frames require. As an example, there are many built-in methods loaded in Python that are available to all of the frames. These are the function frames.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=ec40>Running the above code will print:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=8bde>The variables that are prefixed with __ are known as the special variables.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2338>Notice that the var_three is not available yet. Let’s execute func_one(var_one) and then assess the dir():</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=eca5>We will again see the same list:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=bf99>This means that the variables within the func_one are only within the func_one. When func_one is executed then a Frame is created. Python is top-down therefore it always executes the lines from top to the bottom.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=1e31>The function frame can reference the variables in the global frame but any other function frame cannot reference the same variables that are created within itself. As an instance, if I create a new function func_two that tries to print var_three then it will fail:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6f59>We get an error that <strong class=\"hf hz\">NameError: name ‘var_three’ is not defined</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7b42><strong class=\"hf hz\">What if we create a new variable inside func_two() and then print the dir()?</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5a69>This will print var_four as it is local to func_two.</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=7a70>How does Assignment work In Python?</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=7370>This is by far one of the most important concepts to understand in Python. Python has an id() function.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e52e>When an object (function, variable, etc.) is created, CPython allocates it an address in memory. The id() function returns the “identity” of an object. It is essentially a unique integer.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7742>As an instance, let’s create four variables and assign them values:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2fab>The ids will be printed as follows:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=91f9>Variable1: 1747938368<br>Variable2: 152386423976<br>Variable3: 152382712136<br>Variable4: 152382633160</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=ce37>Each variable has been assigned a new integer value.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d240>The first assumption is that whenever we use the assignment “=” then Python creates a new memory address to store the variable. Is it 100% true, not really!</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=dd13>I am going to create two variables and assign them to the existing variables.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a7ed>Python printed:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e6f3>Variable1: <strong class=\"hf hz\">1747938368</strong><br>Variable4: 819035469000<br>Variable5: <strong class=\"hf hz\">1747938368</strong><br>Variable6: 819035469000</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4efe><em class=ia>Notice that Python did not create new memory addresses for the two variables. This time, it pointed both of the variables to the same memory location.</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f4c7>Let’s set a new value to the variable1. Remember 2 is an integer and integer is an immutable data type.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=47f5>This will print:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=8691><em class=ia>Variable1: 1747938368<br>Variable1: 1747938400</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2ab2><strong class=\"hf hz\">It means whenever we use the = and assign a new value to a variable that is not a variable then internally a new memory address is created to store the variable. Let’s see if it holds!</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=af6a>What happens when the value is a mutable data type?</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a9dd>variable6 is a list. Let’s append an item to it and print its memory address:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6e9a>Note that the memory address remained the same for the variable as it is a mutable data type and we simply updated its elements.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=8620>Variable6: 678181106888<br>Variable6: 678181106888</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=602e>Let’s create a function and pass a variable to it. If we set the value of the variable inside the function, what will it do internally? let’s assess</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=423e>We get:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=df09>678181106888<br>Variable6: 678181106888</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3bdc>Notice that the id of variable_to_update points to the id of the variable 6.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6676>This means that if we update the variable_to_update in a function and if variable_to_update is a mutable data type then we’ll update variable6.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0c45>This printed:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=9503>Variable6: [‘new’]<br>Variable6: [‘new’, ‘inside’]</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d10d>It shows us that the same object is updated within the function as it was expected by both having the same ID.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0b86>If we assign a new value to a variable, regardless of if it’s immutable and mutable data type then the change will be lost once we come out of the function:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=cd8f>Variable6: [‘new’]<br>344115201992<br>Variable6: [‘new’]</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=bfa8><strong class=\"hf hz\">Now an interesting scenario: Python doesn’t always create a new memory address for all new variables.</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b63b>Finally, what if we assign two different variables a string value such as ‘a’. Will it create two memory addresses?</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3ddd>Notice, both the variables have the same memory location:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0d9d>Variable9: 792473698064<br>Variable10: 792473698064</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=dadc>What if we create two different variables and assign them a long string value:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=89a5>This time Python created two memory locations for the two variables:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=fdf6>Variable9: 541949933872<br>Variable10: 541949933944</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=a412>This is because Python creates an internal cache of values when it starts up. This is done to provide faster results. It creates a handful of memory addresses for small integers such as between -5 to 256 and smaller string values. This is the reason why both of the variables in our example had the same ID.</p><figure class=\"lc ld le lf lg cx cy iq paragraph-image\"><img alt=\"Image for post\" class=\"aj it t u v\" sizes=700px src=https://miro.medium.com/max/10368/0*_lg2u6mk9G_XR4AE srcset=\"https://miro.medium.com/max/552/0*_lg2u6mk9G_XR4AE 276w, https://miro.medium.com/max/1104/0*_lg2u6mk9G_XR4AE 552w, https://miro.medium.com/max/1280/0*_lg2u6mk9G_XR4AE 640w, https://miro.medium.com/max/1400/0*_lg2u6mk9G_XR4AE 700w\" width=5184><figcaption class=\"ce b cg cx cy cz fc fm mk ml mm mn\">Photo by <a class=\"ck mo\" href=\"https://unsplash.com/@noahsilliman?utm_source=medium&amp;utm_medium=referral\">Noah Silliman</a> on <a class=\"ck mo\" href=\"https://unsplash.com/?utm_source=medium&amp;utm_medium=referral\">Unsplash</a></figcaption></figure><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=498b>== vs is</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=742e>Sometimes we want to check whether two objects are equal.</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=3ccf>If we use == then it will check whether the two arguments contain the same data</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=db93>If we use <em class=ia>is </em>then Python will check whether the two objects refer to the same object. The id() needs to be the same for both of the objects</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=564a>8. Modules</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=8cb6>Python is shipped with over 200 standard modules.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=8816>A module is a component that groups similar functionality of your python solution.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=45ab>Any python code file can be packaged as a module and then it can be imported.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9770>Modules encourage componentised design in your solution.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=49c2>They provide the concept of namespaces to help you share data and services.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e00b>Modules encourage code reusability and reduce variable name clashes.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=33b8>This environment variable indicates where the Python interpreter needs to navigate to locate the modules. PYTHONHOME is an alternative module search path.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=e7ac>If you have a file: MyFirstPythonFile.py and it contains multiple functions, variables and objects then you can import the functionality into another class by simply doing:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=db5e>Internally, python runtime will compile the module’s file to bytes and then it will run the module code.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=cd6b>If you want to import everything in a module, you can do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=926c>If your module contains a function or object named my_object then you will have to do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3838><strong class=\"hf hz\">Note: If you do not want the interpreter to execute the module when it is loaded then you can check whether the __name__ == ‘__main__’</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0ce7><strong class=\"hf hz\">2. From</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=a912>If you only want to access an object or parts of a module from a module then you can implement:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=b5ad>This will enable you to access your object without referencing your module:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=5f59>We can also do from * to import all objects</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f551><strong class=\"hf hz\"><em class=ia>Note: Modules are only imported on the first import.</em></strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=dc80><strong class=\"hf hz\">If you want to use a Python module in C:</strong></li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b0b0><em class=ia>Use PyImport_ImportModule(module_name)</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4769><strong class=\"hf hz\">Namespace — two modules with same object name</strong>:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=dc2a>Use import over from if we want to use the same name defined in two different modules.</p><h2 class=jj id=a964>9. Packages</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=a6ad>Package is a directory of modules.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=ef20>If your Python solution offers a large set of functionalities that are grouped into module files then you can create a package out of your modules to better distribute and manage your modules.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=bacd>Packages enable us to organise our modules better which helps us in resolving issues and finding modules easier.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9d1a>Third-party packages can be imported into your code such as pandas/sci-kit learn and tensor flow to name a few.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=0d04>A package can contain a large number of modules.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1943>If our solution offers similar functionality then we can group the modules into a package:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=be44>In the example above, packageroot is the root folder. packagefolder is the subfolder under packageroot. my_module is a module python file in the packagefolder folder.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=449c>Additionally, the name of the folder can serve as the namespace e.g.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=4501><strong class=\"hf hz\">Note: Ensure each directory within your package import contains a file __init__.py.</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b98a><strong class=\"hf hz\">Feel free to leave the files blank. As __init__.py files are imported before the modules are imported, you can add custom logic such as start service status checks or to open database connections, etc.</strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=5934>PIP</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=280c>PIP is a Python package manager.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=a1a9>Use PIP to download packages:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=62a3>10. Conditions</h2><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=149a><em class=ia>Note how </em><strong class=\"hf hz\"><em class=ia>colons and indentations</em></strong><em class=ia> are used to express the conditional logic.</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=15b8><strong class=\"hf hz\">Checking Types</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=604e><strong class=\"hf hz\">You can also add conditional logic in the else part. This is known as nested condition.</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=dc73>11. Loops</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=59d7>Provide a condition and run the loop until the condition is met:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=b919>Loop for a number of times</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=d595>Loop over items or characters of a string</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=221d><strong class=\"hf hz\">One-Liner For</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f32b>Syntax:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e389><strong class=\"hf hz\">Yielding</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=9bcc>Let’s assume your list contains a trillion records and you are required to count the number of even numbers from the list. It will not be optimum to load the entire list in the memory. You can instead yield each item from the list.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=76fd><strong class=\"hf hz\">range(start, stop, step):</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2235>Generates numerical values that start at <em class=ia>start</em>, stop at <em class=ia>stop </em>with the provided <em class=ia>steps</em>. As an instance, to generate odd numbers from 1 to 9, do:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=b84b><strong class=az>Combine For with If</strong></h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=7c76>Let’s do a simple exercise to find if a character is in two words</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=0c41>Break</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=d951>If you want to end the loop</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=d480>Let’s write Fibonacci for loop:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=d88b>12. Recursion</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=87d7>A function calling itself is known as recursion.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b9d0><strong class=\"hf hz\">Let’s implement a factorial recursive function:</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=68cf><strong class=\"hf hz\">Rules</strong>:</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=f010>0! = 1 #Factorial of 0 is 1</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=369a>n! = n(n-1)! #Factorial of n is n * factorial of n-1</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6f70><strong class=\"hf hz\">Steps:</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=94e7>Create a function called factorial with input n</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=621a>If n = 0 return 1 else do n x factorial of n-1</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=bbd2><strong class=\"hf hz\">Another Example: Let’s write Fibonacci recursive function:</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=81bd><strong class=\"hf hz\">Rules:</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=aa17>First two digits are 0 and 1</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=d340>Rest add last two digits</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=8183>0, 1, 1, 2, 3, 5, 8…</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=282d><strong class=\"hf hz\">Steps:</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=e46f>Create a function called fibonacci that takes in an input n</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=de1d>Create two variables first and second and assign them with values 0 and 1</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=71e6>if n =0 return 0, if n = 1 return 1 else return (n-1) + (n-2)</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d37c><strong class=\"hf hz\">It is important to have an exit check otherwise the function will end up in an infinite loop.</strong></p><h2 class=jj id=3be4>13. Frames And Call Stack</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=67cd>Python code is loaded into frames that are located into a Stack.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=7a07>Functions are loaded in a frame along with the parameters and variables.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9087>Subsequently, frames are loaded into a stack in the right order of execution.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=93f5>Stack outlines the execution of functions. Variables that are declared outside of functions are stored in __main__</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1dbf>Stacks executes the last frame first.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=96b2>You can use <strong class=\"hf hz\">traceback</strong> to find the list of functions if an error is encountered.</p><h2 class=jj id=9e78>14. Collections</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=aec9>Lists are data structures that can hold a sequence of values of any data types. They are mutable (update-able).</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=68f9>Lists are indexed by integers.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=c3d6>To create a list, use square brackets:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=41fd>To add/update/delete an item, use index:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=0cce>Addition, repetition and slices can be applied to lists (just like strings).</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=cf13>List also supports sorting:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=dbbd>Note on pop():</p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=c552>Pop from the end is O(1)</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=380c>Pop from start (<code class=\"iy b lu mp mq mr\">.pop(0)</code>) is O(N) : <em class=ia>all</em> the elements in <code class=\"iy b lu mp mq mr\">list[1:]</code> are physically moved one position to the left.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7b17>If you need to delete index position 0 frequently, use <code class=\"iy b lu mp mq mr\">collections.deque</code>.</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=00b2>Tuples</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=21b6>Tuples are like lists in the sense that they can store a sequence of objects. The objects, again, can be of any type.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=70b2>Tuples are faster than lists.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=56fe>These collections are indexed by integers.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=f27f>Tuples are immutable (non-update-able)</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=63d1><strong class=\"hf hz\"><em class=ia>Note: If a tuple contains a list of items then we can modify the list. Also if you assign a value to an object and you store the object in a list and then change the object then the object within the list will get updated.</em></strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=688a>Dictionaries</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=a40a>Dictionary is one of the most important data structure in the programming world. It stores key/value pair objects.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=54aa>It has many benefits e.g. optimised data retrieval functionality.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=5c96>You can also create a dictionary as:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=fae0><strong class=\"hf hz\">Print dictionary contents</strong></li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=72dc>Values of a dictionary can be of any type including strings, numerical, boolean, lists or even dictionaries.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b463>Few of the important functions:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7fa7><strong class=\"hf hz\"><em class=ia>Note: If you want to perform vectorised/matrix operations on a list then use NumPy Python package</em></strong></p><h2 class=jj id=6f05>15. Compilation And Linking</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=74e2>These features can be utilised to use a file that is written in another language e.g. C or C++ etc, as long as it is supported by the compiler.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=fc1c>Once the code is written into a file then the file can be placed in the Modules directory of the distribution.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=fc2a>It is important to add a line in the Setup.local file to ensure that the newly created file can be loaded. Run the file using spam file.o</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=26b6>Changing the file requires running rebuildMakefile</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=da1d>Allows compilation of new extensions without any error</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=344f>Once the extensions are compiled, they can be linked.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=beab>Allow traversing through a collection</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1a03>All iterators contain __iter__() and __next__() functions</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=4573>Simply execute iter(x) on lists, dictionaries, strings or sets.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=de82>Therefore we can execute next(iter) where iter = iter(list) as an instance.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=af9e>Iterators are useful if we have a large number of items in a collection and we do not intend to load all of the files in memory at once. Iterators are memory efficient and can represent an infinite stream.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=8cae>There are common iterators which enable developers to implement functional programming language paradigm:</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=70fe>Filter out values based on a condition</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=d663>Applies a computation on each value of a collection. It <strong class=\"hf hz\">maps</strong> one value to another value e.g. Convert Text To Integers</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=f52d>Reduces a collection of values to one single value (or a smaller collection) e.g. the sum of a collection. It can be iterative in nature.</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=d5be>Takes multiple collections and returns a new collection.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=75c8>The new collection contains items where each item contains one element from each input collection.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=a0a3>It allows us to transverse multiple collections at the same time</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=299f>enumerate can loop over an iterable and returns an automatic index for each of the elements:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=087b>Iterators require us to implement two key methods:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=da24>__iter__() and __next__()</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=06de>Additionally, StopIteration needs to be raised when there are no values left to be returned.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5f2b>We can make a function return an iterator by using a Generator. All we have to do is to use the <strong class=\"hf hz\"><em class=ia>yield </em></strong>keyword instead of <strong class=\"hf hz\"><em class=ia>return</em></strong>. The key is to yield one item at a time.</p><h2 class=jj id=e0d1>17. Object-Oriented Design — Classes</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=7b8e>Python allows us to create our custom types. These user-defined types are known as classes. The classes can have custom properties/attributes and functions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=43f6>The object-oriented design allows programmers to define their business model as objects with their required properties and functions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=b748>A property can reference another object too.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=904e>Python classes can reference other classes.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=a8da>Python supports encapsulation — instance functions and variables.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=902f>Python supports inheritance.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=3eeb>An instance of a class is known as an object. The objects are mutable and their properties can be updated once the objects are created.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5d01><strong class=\"hf hz\"><em class=ia>Note: If a tuple (immutable collection) contains a list (mutable collection) of items then we can modify the list. Also if you assign a value to an object and you store the object in a list and then change the object then the object within the list will get updated.</em></strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=e0f1>__init__</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=1716>__init__ function is present in all classes. It is executed when we are required to instantiate an object of a class. __init__ function can take any properties which we want to set:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e290><strong class=\"hf hz\"><em class=ia>Note: self parameter will contain the reference of the object, also referred to as “this” in other programming languages such as C#</em></strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=dbb7>__str__</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=3ed7>Returns stringified version of an object when we call “print”:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=f4af>Therefore, __str__ is executed when we execute print.</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=f538>__cmp__</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=576e>Use the __cmp__ instance function if we want to provide custom logic to compare two objects of the same instance.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=7630>It returns 1 (greater), -1 (lower) and 0 (equal) to indicate the equality of two objects.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2535>Think of __cmp__ like Equals() method in other programming language.</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=15a8>Overloading</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=efde>Methods of an object can be overloaded by providing more arguments as an instance.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=6584>We can also overload an operator such as + by implementing our own implementation for __add__</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=e7cb>Shallow Vs Deep Copy Of Objects</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=7892>Equivalent objects — Contains the same values</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=89b8>Identical objects — Reference the same object — same address in memory</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=dd6a>If you want to copy an entire object then you can use the copy module</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=06e5>This will result in shallow copy as the reference pointers of the properties will be copied.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=dd38>Therefore, if one of the properties of the object is an object reference then it will simply point to the same reference address as the original object.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=95c6>As a result, updating the property in the source object will result in updating the property in the target object.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=f31d>Therefore shallow copy copies reference pointers.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=6dd2>Fortunately, we can utilise deep-copy:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=6ffd>If MyClass contains a property that references MyOtherClass object then the contents of the property will be copied in the newly created object via deepcopy.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=19c2>Therefore, deep copy makes a new reference of the object.</li></ul><h2 class=jj id=e301>18. Object-Oriented Design — Inheritance</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=f0fa>Python supports the inheritance of objects. As a result, an object can inherit functions and properties of its parent.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=7d31>An inherited class can contain different logic in its functions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=215b>If you have a class: ParentClass and two subclasses: SubClass1, SubClass2 then you can use Python to create the classes as:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=e9ea>Consequently, both subclasses will contain the function my_function().</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=733b>Inheritance can encourage code reusability and maintenance.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5d96><strong class=\"hf hz\"><em class=ia>Note: Python supports multiple inheritances unlike C#</em></strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=0801>Use Python’s abc module to ensure all subclasses contain the required features of the Abstract Base Class.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=61db><strong class=\"hf hz\">Multi-Inheritance:</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=35e7>If you want to call parent class function then you can do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=cf33>There are a number of internal methods that we should be familiar with.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6c8f>__str__(self): This function returns a user-friendly value to represent the object to the users.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=90a1>__repr__(self): This function returns a developer-friendly value to represent the object to the users. If __str__() is missing then __repr()__ is called.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0552>__eq__(self, other): This function can help us compute how to find if two objects are equal.</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=39c2>This will print: Name is: Farhad</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5b81>If we remove __str__ function then it will call __repr__ instead:</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=367c>This will print: Human(Farhad, [‘Friend1’, ‘Friend2’])</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=904c>If we create two human instances with the same name and different friends then it will mark both of them as equal due to the __eq__ function:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=9511>19. Garbage Collection — Memory Management</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=68e0>All of the objects in Python are stored in heap space. This space is accessible to the Python interpreter. It is private.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=9af1>Python has an in-built garbage collection mechanism.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e009>It means Python can allocate and de-allocate the memory for your program automatically such as in C++ or C#.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=c092>Its responsibility is to clear the space in memory of those objects that are not referenced/used in the program.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=ec67>As multiple objects can share memory references, python employs two mechanisms:</p><ol><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv hg hj hn hr hv li\" id=5a74><strong class=\"hf hz\">Reference counting:</strong> Count the number of items an object is referenced, deallocate an object if its count is 0. The reference is incremented when the variable is assigned an object or when it is passed as an argument to any method.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kw kx ky kz la li\" id=9225>The second mechanism takes care of circular references, also known as <strong class=\"hf hz\">cyclic references</strong>, by only de-allocating the objects where the allocation — deallocation number is greater than the threshold.</li></ol><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=bf7f>New objects are created in Generation 0 in python. They can be inspected by:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=c9e5>Manual garbage collection can be performed on a timely or event-based mechanism.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=d97c>When a Python program exists then Python attempts to remove global objects and ones that have a circular reference.</li></ul><h2 class=jj id=10c5>20. I/O</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=73bc>Use the raw_input() function</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=74f1>Use a with/as a statement to open and read a file. It is equivalent to the using statement in C#.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=02b0>with statement can take care of the closing of connections and other cleanup activities.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=735a><strong class=\"hf hz\">Open files</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=cc77><strong class=\"hf hz\">Note: readline() can also be executed to read a line of a file.</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=43de><strong class=\"hf hz\">To open two files</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0cd7><strong class=\"hf hz\">Writing files</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=9071><strong class=\"hf hz\"><em class=ia>Note: Use os and shutil modules for files.</em></strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=24b3><strong class=\"hf hz\"><em class=ia>Note: There are a large number of modes available, such as:</em></strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=8904><em class=ia>rw — read-write mode</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=88da><em class=ia>r — read mode</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=cd09><em class=ia>rb — read in binary format mode e.g. pickle file</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2b7e><em class=ia>r+ — read for both reading and writing mode</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d048><em class=ia>a — append mode.</em></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=9146>w+ — for reading and writing, overwrites if the file exists</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=4b3b>SQL</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=2aa5><strong class=\"hf hz\">Open a connection</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=812e><strong class=\"hf hz\">Execute a SQL statement</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=e323>Web Services</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=9703><strong class=\"hf hz\">To query a rest service</strong></p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=5bf0><strong class=\"hf hz\">To Serialise and Deserialise JSON</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6371><strong class=\"hf hz\">Deserialise</strong>:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7c0a><strong class=\"hf hz\">Serialise</strong>:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=dc8c>21. Error Handling</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=e0b5>If you want to raise exceptions then use the raise keyword:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=db8b>To catch exceptions, you can do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=e047>If you want to catch specific exceptions then you can do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=11d8>If you want to use try/catch/finally then you can do:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=a105>finally part of the code is triggered regardless, you can use finally to close the connections to database/files, etc.</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=469c>else is executed when no exceptions have been raised.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=7b70>We can also assign exception to a variable by doing:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=f5a3>If you want to define user-defined constraints then use assert:</li></ul><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=f967><strong class=\"hf hz\"><em class=ia>Note: Python supports inheritance in exceptions</em></strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d8f1>You can create your own exception class by:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><h2 class=jj id=e9cb>22. Multi-Threading And GIL</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=55fc>GIL is Global Interpreter Lock.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=7eef>It ensures that the threads can execute at any one time and allows CPU cycles to pick the required thread to be executed.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1732>GIL is passed onto the threads that are currently being executed.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=78e6>Python supports multi-threading.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b5b9><em class=ia>Note: GIL adds overheads to the execution. Therefore, be sure that you want to run multiple threads.</em></p><h2 class=jj id=1ceb>23. Decorators</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=db50>Decorators can add functionality to code. They are essentially functions that call other objects/functions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=089a>Decorators are callable functions — therefore they return the object to be called later when the decorated function is invoked.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1a28><em class=ia>Think of decorates that enable aspect-oriented programming</em></li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=ded5>We can wrap a class/function and then a specific code will be executed any time the function is called.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1ed8><em class=ia>We can implement generic logic to log, check for security checks, etc and then attribute the method with the </em><strong class=\"hf hz\"><em class=ia>@property tag.</em></strong></li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1306>The most important concept to understand is that in Python, functions are objects. This means a function can return another function and one function can take another function as an argument. We can also define a function within another function. Functions can also be assigned to a variable.</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=c594><strong class=\"hf hz\">Understanding decorators:</strong></p><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt hg hj hn hr hv\" id=125a>Essentially a decorator is a function. It accepts another function as a parameter. It also returns a function. Let’s understand the steps:</li></ul><ol><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv hg hj hn hr hv li\" id=78cd>The decorator is a function that accepts a function as an input and returns an inner function:</li></ol><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d64a>2. The input function is the one that the decorator is going to decorate.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=d337>3. The internal function is the function that performs the appropriate actions to the input function and then the decorator returns the inner function.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=3940>To use the decorator, use the @ sign:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=774b>We can also pass other parameters to the decorator if required.</p><h2 class=jj id=76b0>24. Unit Testing In Python</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=1cde>There are a number of unit testing and mocking libraries available in Python.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=8afd>An example is to use <strong class=\"hf hz\">unittest</strong>:</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=2f66>1.Assume your function simply decrements an input by 1</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=7a6f>2. You can unit test it by:</p><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=15f7>We can also use <strong class=\"hf hz\">doctest</strong> to test code written in docstrings.</p><h2 class=jj id=6fb9>25. Top Python Discussion Questions</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=8050>Simple to code and learn</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=97a6>Object-oriented programming language</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=1f84>Great Analytics and ML packages</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=aa39>Faster to develop and bring my solution to market</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=2084>Offers in-built memory management facilities</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=5bb7>Huge community support and applications available</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=3789>No need to compile as it’s an interpreted language</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e3b0>Dynamically typed — no need to declare variables</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=b83c>Python is a high-level language and is not suitable to access system-level programs or hardware.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=96f3>Additionally, it is not suitable for cross-platform applications.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=4937>The fact that Python is a dynamically typed interpreted language makes it slower to be optimised and run when compared to the low-level languages.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=54dd>Implement C language-based extensions.</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=e7ea>Create multi-processes by using Spark or Hadoop</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=07d4>Utilise Cython, Numba, and PyPy to speed up your Python code or write it in C and expose it in Python like NumPy</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=e1c5>Spyder, PyCharm. Additionally various notebooks are used e.g. Jupyter</li></ul><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=36fe>There are a large number of must-use packages:</li></ul><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=0566>PyUnit (unit testing), PyDoc (documentation), SciPy (algebra and numerical), Pandas (data management), Sci-Kit learn (ML and data science), Tensorflow (AI), Numpy (array and numerical), BeautifulSoap (web pages scrapping), Flask (microframework), Pyramid (enterprise applications), Django (UI MVVM), urllib (web pages scraping), Tkinter (GUI), mock (mocking library), PyChecker(bug detector), Pylint (module code analysis)</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=98c9>How To Host Python Packages?</h2><ol><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv ko kp kq kr ks li\" id=c62a>For Unix: Make script file mode Executable and the first line begin with:</li></ol><pre class=\"lc ld le lf lg bv ls lt\"></pre><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=30ff>2. You can use command-line tool and execute it</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=c31b>3. Use PyPRI or PyPI server</p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=5c5e>Can Python and R be combined?</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=57db>A large number of rich statistical libraries have been written in R</li><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt kw kx ky kz la\" id=a5e2>One can execute R code within Python by using Rpy2 python package or by using a beaker notebook or IR kernel within Jupyter.</li></ul><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=2325>Is there a way to catch errors before running Python?</h2><ul><li class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy ku kv kt ko kp kq kr ks\" id=1837>We can use PyChecker and PyLink to catch errors before running the code.</li></ul><figure class=\"lc ld le lf lg cx cy iq paragraph-image\"><img alt=\"Image for post\" class=\"aj it t u v\" sizes=700px src=https://miro.medium.com/max/8482/0*1j0rk9JNAxpaDOVJ srcset=\"https://miro.medium.com/max/552/0*1j0rk9JNAxpaDOVJ 276w, https://miro.medium.com/max/1104/0*1j0rk9JNAxpaDOVJ 552w, https://miro.medium.com/max/1280/0*1j0rk9JNAxpaDOVJ 640w, https://miro.medium.com/max/1400/0*1j0rk9JNAxpaDOVJ 700w\" width=4241><figcaption class=\"ce b cg cx cy cz fc fm mk ml mm mn\">Photo by <a class=\"ck mo\" href=\"https://unsplash.com/@curtismacnewton?utm_source=medium&amp;utm_medium=referral\">Curtis MacNewton</a> on <a class=\"ck mo\" href=\"https://unsplash.com/?utm_source=medium&amp;utm_medium=referral\">Unsplash</a></figcaption></figure><h2 class=jj id=ea74>Summary</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy df ko kp kq kr ks\" id=7d06>This article outlined the most important 25 concepts of Python in a <strong class=\"hf hz\">short, relevant and focused manner.</strong> I genuinely hope it has helped someone get a better understanding of Python.</p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=baf9>I believe I have concentrated on the must-know topics that are absolutely required to be understood. This knowledge is sufficient to write your own python packages in the future or using existing Python packages.</p><figure class=\"lc ld le lf lg cx cy iq paragraph-image\"><img alt=\"Image for post\" class=\"aj it t u v\" sizes=700px src=https://miro.medium.com/max/1590/1*9AGcZ7S7bxMCO35PLHXyyQ.png srcset=\"https://miro.medium.com/max/552/1*9AGcZ7S7bxMCO35PLHXyyQ.png 276w, https://miro.medium.com/max/1104/1*9AGcZ7S7bxMCO35PLHXyyQ.png 552w, https://miro.medium.com/max/1280/1*9AGcZ7S7bxMCO35PLHXyyQ.png 640w, https://miro.medium.com/max/1400/1*9AGcZ7S7bxMCO35PLHXyyQ.png 700w\" width=795><figcaption class=\"ce b cg cx cy cz fc fm mk ml mm mn\">Thank you for reading.</figcaption></figure><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=b0cf><strong class=\"hf hz\">Rest, just practice as much as possible and you can implement your own library in Python because this article contains all the knowledge you need.</strong></p><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=e6a3><strong class=\"hf hz\">Here are 5 interesting Python exercises to test your knowledge :</strong></p><h2 class=\"dn ek ce eo er es eu ev ex ey fa jk jl jo jr jv jz kd kf kg kh ki kj kk kl km kn\" id=0049>I highly recommend this article as it shows how you can use your Python knowledge to build a robust application:</h2><p class=\"hf b dn ek em ep hd he hh hi hk hl hm ho hp hq hs ht hu hw hx hy hg hj hn hr hv df\" id=6d53>If there are any questions/comments then do please let me know.</p></div></div></section></div></article></div></body></html>",
            "source": "https://medium.com/fintechexplained/everything-about-python-from-beginner-to-advance-level-227d52ef32d2",
            "title": "Everything About Python — Beginner To Advanced",
            "author": "Farhad Malik",
            "published": "2020-06-22T14:01:44.948Z",
            "image": "https://miro.medium.com/max/642/1*V3RT5yJmh6ihakR7jhg2dw.png",
            "description": "Everything You Need To Know In One Article",
            "tags": [
                {
                    "children": [
                        {
                            "_id": "5fdcab52130cba20187c5dd4",
                            "title": "Javascript",
                            "value": "Javascript",
                            "label": "Javascript",
                            "color": "#bf0284",
                            "children": [
                                {
                                    "_id": "5fdcab79130cba20187c5dde",
                                    "title": "VueJS",
                                    "value": "VueJS",
                                    "label": "VueJS",
                                    "color": "#0b9414",
                                    "children": []
                                },
                                {
                                    "_id": "5fdcab7f130cba20187c5de3",
                                    "title": "React",
                                    "value": "React",
                                    "label": "React",
                                    "color": "#d00a4d",
                                    "children": []
                                }
                            ]
                        },
                        {
                            "_id": "5fdcab73130cba20187c5ddb",
                            "title": "C#",
                            "value": "C#",
                            "label": "C#",
                            "color": "#2fd892",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                }
            ],
            "createdAt":"2020-12-18T14:37:09.752+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb0b9130cba20187c5e1d",
            "html": "<html><head></head><body><div><div class=cat id=drr-container> <p>The Windows operating system logs data into the Windows Event Log whenever a problem occurs. You can view this data using the Windows Event Viewer tool. This article discusses how you can programmatically work with the Windows Event Log in C#.</p><p>To work with the code examples provided in this article, you should have Visual Studio 2019 installed in your system. If you don’t already have a copy, you can <a href=https://visualstudio.microsoft.com/downloads/ >download Visual Studio 2019 here</a>.</p><h2>Create a .NET Core console application project in Visual Studio</h2><p>First off, let’s create a .NET Core console application project in Visual Studio. Assuming Visual Studio 2019 is installed in your system, follow the steps outlined below to create a new .NET Core console application project in Visual Studio.</p><ol>\n<li>Launch the Visual Studio IDE.</li>\n<li>Click on “Create new project.”</li>\n<li>In the “Create new project” window, select “Console App (.NET Core)” from the list of templates displayed.</li>\n<li>Click Next.</li>\n<li>In the “Configure your new project” window shown next, specify the name and location for the new project.</li>\n<li>Click Create.</li>\n</ol><p>This will create a new .NET Core console application project in Visual Studio 2019. We’ll use this project to work with the Windows event log in the subsequent sections of this article.</p><h2>Install the EventLog NuGet package</h2><p>To be able to work with the Windows Event Log in .NET Core applications, you should install the Microsoft.Extensions.Logging.EventLog package from NuGet. You can do this either via the NuGet Package Manager inside the Visual Studio 2019 IDE, or by executing the following command at the NuGet Package Manager Console:</p><pre class=prettyprint>Install-Package Microsoft.Extensions.Logging.EventLog</pre><h2>Create an instance of the EventLog class in C#</h2><p>To create an instance of the EventLog class and write an entry to the Windows Event Log, you can use the following code:</p><aside class=\"nativo-promo nativo-promo-1 smartphone\"> </aside><pre class=prettyprint>EventLog eventLog = new EventLog();eventLog.Source = \"MyEventLogTarget\";<p>eventLog.WriteEntry(\"This is a test message.\", EventLogEntryType.Information);</p></pre><h2>Write to an EventLog instance in C#</h2><p>If you would like to log data to this EventLog instance from your application, you can use the following code:</p><pre class=prettyprint>string message = \"This is a test message.\";using (EventLog eventLog = new EventLog(\"Application\")){&nbsp;&nbsp;&nbsp; eventLog.Source = \"Application\";&nbsp;&nbsp;&nbsp; eventLog.WriteEntry(message, EventLogEntryType.Information);<p>}</p></pre><h2>Clear an EventLog instance in C#</h2><p>To clear the EventLog instance, you can use the following code:</p><aside class=\"nativo-promo desktop tablet nativo-promo-1\"> </aside><pre class=prettyprint>EventLog eventLog = new EventLog();eventLog.Source = \"MyEventLogSource\";<p>eventLog.Clear();</p></pre><p>The following code snippet can be used to delete an event log.</p><pre class=prettyprint>if (EventLog.Exists(\"MyEventLogTarget\")){&nbsp;&nbsp; EventLog.Delete(\"MyEventLogTarget\");<p>}</p></pre><h2>Read EventLog entries in C#</h2><p>You can read all log entries using the code snippet given below:</p><pre class=prettyprint>EventLog eventLog = new EventLog();eventLog.Log = \"MyEventLogTarget\";foreach (EventLogEntry entry in eventLog.Entries){&nbsp;&nbsp;&nbsp; //Write your custom code here<p>}</p></pre><h2>Use NLog to write log data to EventLog in C#</h2><p>Now we’ll take advantage of the NLog.WindowsEventLog package. This package will allow us to use NLog to send log data to EventLog while working from the .NET Core environment.</p><p>NLog.WindowsEventLog encapsulates the intricacies of connecting to EventLog and working with EventLog from ASP.NET Core. You just have to call NLog methods as you normally do.</p><aside class=\"nativo-promo desktop tablet nativo-promo-2 smartphone\"> </aside><p>Since we’ll be using NLog to log data to EventLog, add the following package to your project:</p><pre class=prettyprint>Install-Package NLog.WindowsEventLog</pre><h2>Create a logging interface in C#</h2><p>Create the following interface to store the logs as information, warning, debug, or error.</p><pre class=prettyprint>public interface ILogManager&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void LogInformation(string message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void LogWarning(string message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void LogDebug(string message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; void LogError(string message);<p>&nbsp;&nbsp;&nbsp; }</p></pre><h2>Implement an NLogManager class in C#</h2><p>Next, create a class named NLogManager that extends the ILogManager interface and implements each of its methods.</p><pre class=prettyprint>public class NLogManager : ILogManager&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static NLog.ILogger logger =LogManager.GetCurrentClassLogger();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogDebug(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotImplementedException();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogError(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.Error(message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogInformation(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotImplementedException();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogWarning(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new NotImplementedException();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<p>&nbsp;&nbsp;&nbsp; }</p></pre><h2>Implement a LogError method in C#</h2><p>Note that for the sake of simplicity we’ll be using the LogError method in this example and the other methods of the NLogManager class will not be implemented. Let’s now understand how we can use NLog to log data to EventLog. Modify the LogError method of the NLogManager class as shown below:</p><pre class=prettyprint>public void LogError(string message)&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger logger = LogManager.GetLogger(\"EventLogTarget\");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var logEventInfo = new LogEventInfo(LogLevel.Error,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.Name, message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger.Log(logEventInfo);<p>&nbsp;&nbsp;&nbsp;&nbsp;}</p></pre><p>Note that EventLogTarget is just the name of the log target for EventLog, which needs to be defined in the configuration file nlog.config. The LogEventInfo class is your log event, i.e., it represents the log event. To its constructor you should pass the log level, the name of the logger, and the message to be logged.</p><h2>Configure NLog to log data to EventLog in C#</h2><p>To configure NLog programmatically to log data to EventLog, you can use the following code:</p><pre class=prettyprint>var config = new NLog.Config.LoggingConfiguration();var logEventLog = new NLog.Targets.EventLogTarget(\"EventLogTarget\");config.AddRule(NLog.LogLevel.Info, NLog.LogLevel.Error, logEventLog);<p>NLog.LogManager.Configuration = config;</p></pre><h2>Complete NLogManager example in C#</h2><p>The complete source code of the NLogManager class is given below for your reference:</p><pre class=prettyprint>public class NLogManager : ILogManager&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static NLog.ILogger logger =LogManager.GetCurrentClassLogger();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogDebug(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.Debug(message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }public void LogError(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {Logger logger = LogManager.GetLogger(\"EventLogTarget\");var logEventInfo = new LogEventInfo(LogLevel.Error,logger.Name, message);logger.Log(logEventInfo);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogInformation(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.Info(message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public void LogWarning(string message)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; logger.Warn(message);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<p>&nbsp;&nbsp;&nbsp; }</p></pre><p>To leverage the NLogManager instance in the controllers you should add an instance of it in the ConfigureServices method as shown in the code snippet given below.</p><pre class=prettyprint>services.AddSingleton&lt;ILogManager, NLogManager&gt;();</pre><p>When you launch the Windows Event Viewer, you can see the error message logged there as shown in the screenshot below.</p><figure class=large><a href=https://images.idgesg.net/images/article/2020/11/windows-event-viewer-100868440-orig.jpg class=zoom><img alt=\"windows event viewer\" class=lazy src=https://images.idgesg.net/images/article/2020/11/windows-event-viewer-100868440-large.jpg width=1200></a> <small class=credit>IDG</small></figure><p>The Windows Event Log is typically used to record system events, network traffic, and related data such as security, performance, etc. You can take advantage of the Windows Event Log as a log target to store your application’s data. If your application runs only on Windows, the Windows Event Log is a nice option for storing your application’s event log data.</p><h3 class=body>How to do more in C#:</h3> </div><p class=content-copy>Copyright © 2020 <span class=ccbu>IDG Communications, Inc.</span></p></div></body></html>",
            "source": "https://www.infoworld.com/article/3598750/how-to-log-data-to-the-windows-event-log-in-csharp.html",
            "title": "How to log data to the Windows Event Log in C#",
            "author": "Joydip Kanjilal",
            "published": "2020-11-29T23:00:00.000Z",
            "image": "https://images.idgesg.net/images/article/2020/09/skyscraper-windows2-100859372-large.jpg",
            "description": "Take advantage of the Windows Event Log to store the log data of your .NET Core applications running on Windows",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                },
                {
                    "children": [],
                    "_id": "5fdcab73130cba20187c5ddb",
                    "title": "C#",
                    "color": "#2fd892"
                }
            ],
            "createdAt": "2020-12-18T14:38:01.346+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb0fd130cba20187c5e21",
            "html": "<html><head></head><body id=telerik> </body></html>",
            "source": "https://www.telerik.com/blogs/seven-javascript-quirks-i-wish-id-known-about",
            "title": "Seven JavaScript Quirks I Wish I Had Known About",
            "author": null,
            "published": "2014-04-10T23:43:46.000Z",
            "image": "https://d585tldpucybw.cloudfront.net/sfimages/default-source/blogs/older-content/tdn/javascript_quirks_header1967de6a8cc648a7a8655a9ef8003b4f.jpg?sfvrsn=5d8d5975_1",
            "description": "JavaScript Quirks: Equality Dot Notation vs Bracket Notation, Function Context, Function Declarations vs Function Expressions, Named vs Anonymous Functions",
            "tags": [
                {
                    "children": [
                        {
                            "_id": "5fdcab79130cba20187c5dde",
                            "title": "VueJS",
                            "value": "VueJS",
                            "label": "VueJS",
                            "color": "#0b9414",
                            "children": []
                        },
                        {
                            "_id": "5fdcab7f130cba20187c5de3",
                            "title": "React",
                            "value": "React",
                            "label": "React",
                            "color": "#d00a4d",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab52130cba20187c5dd4",
                    "title": "Javascript",
                    "color": "#bf0284"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab52130cba20187c5dd4",
                            "title": "Javascript",
                            "value": "Javascript",
                            "label": "Javascript",
                            "color": "#bf0284",
                            "children": [
                                {
                                    "_id": "5fdcab79130cba20187c5dde",
                                    "title": "VueJS",
                                    "value": "VueJS",
                                    "label": "VueJS",
                                    "color": "#0b9414",
                                    "children": []
                                },
                                {
                                    "_id": "5fdcab7f130cba20187c5de3",
                                    "title": "React",
                                    "value": "React",
                                    "label": "React",
                                    "color": "#d00a4d",
                                    "children": []
                                }
                            ]
                        },
                        {
                            "_id": "5fdcab73130cba20187c5ddb",
                            "title": "C#",
                            "value": "C#",
                            "label": "C#",
                            "color": "#2fd892",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                }
            ],
            "createdAt": "2020-12-18T14:39:09.514+01:00",
            "archivedAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb112130cba20187c5e24",
            "html": "<html><head></head><body><div class=css-15weewl><p>React is, in our opinion, the premier way to build big, fast Web apps with JavaScript. It has scaled very well for us at Facebook and Instagram.</p>\n<p>One of the many great parts of React is how it makes you think about apps as you build them. In this document, we’ll walk you through the thought process of building a searchable product data table using React.</p>\n<h2 id=start-with-a-mock><a href=#start-with-a-mock class=anchor><svg height=16 width=16><path></path></svg></a>Start With A Mock </h2>\n<p>Imagine that we already have a JSON API and a mock from our designer. The mock looks like this:</p>\n<p> <span class=gatsby-resp-image-wrapper> <span class=gatsby-resp-image-background-image> <img alt=Mockup class=gatsby-resp-image-image sizes=\"(max-width: 228px) 100vw, 228px\" src=/static/1071fbcc9eed01fddc115b41e193ec11/d4770/thinking-in-react-mock.png srcset=\"https://reactjs.org/static/1071fbcc9eed01fddc115b41e193ec11/65ed1/thinking-in-react-mock.png 210w, https://reactjs.org/static/1071fbcc9eed01fddc115b41e193ec11/d4770/thinking-in-react-mock.png 228w\"> </span> </span> </p>\n<p>Our JSON API returns some data that looks like this:</p>\n<div class=gatsby-highlight><pre class=gatsby-code-text><code class=gatsby-code-text>[\n  {category: \"Sporting Goods\", price: \"$49.99\", stocked: true, name: \"Football\"},\n  {category: \"Sporting Goods\", price: \"$9.99\", stocked: true, name: \"Baseball\"},\n  {category: \"Sporting Goods\", price: \"$29.99\", stocked: false, name: \"Basketball\"},\n  {category: \"Electronics\", price: \"$99.99\", stocked: true, name: \"iPod Touch\"},\n  {category: \"Electronics\", price: \"$399.99\", stocked: false, name: \"iPhone 5\"},\n  {category: \"Electronics\", price: \"$199.99\", stocked: true, name: \"Nexus 7\"}\n];</code></pre></div>\n<h2 id=step-1-break-the-ui-into-a-component-hierarchy><a href=#step-1-break-the-ui-into-a-component-hierarchy class=anchor><svg height=16 width=16><path></path></svg></a>Step 1: Break The UI Into A Component Hierarchy </h2>\n<p>The first thing you’ll want to do is to draw boxes around every component (and subcomponent) in the mock and give them all names. If you’re working with a designer, they may have already done this, so go talk to them! Their Photoshop layer names may end up being the names of your React components!</p>\n<p>But how do you know what should be its own component? Use the same techniques for deciding if you should create a new function or object. One such technique is the <a href=https://en.wikipedia.org/wiki/Single_responsibility_principle>single responsibility principle</a>, that is, a component should ideally only do one thing. If it ends up growing, it should be decomposed into smaller subcomponents.</p>\n<p>Since you’re often displaying a JSON data model to a user, you’ll find that if your model was built correctly, your UI (and therefore your component structure) will map nicely. That’s because UI and data models tend to adhere to the same <em>information architecture</em>. Separate your UI into components, where each component matches one piece of your data model.</p>\n<p> <span class=gatsby-resp-image-wrapper> <span class=gatsby-resp-image-background-image> <img alt=\"Component diagram\" class=gatsby-resp-image-image sizes=\"(max-width: 275px) 100vw, 275px\" src=/static/eb8bda25806a89ebdc838813bdfa3601/6b2ea/thinking-in-react-components.png srcset=\"https://reactjs.org/static/eb8bda25806a89ebdc838813bdfa3601/65ed1/thinking-in-react-components.png 210w, https://reactjs.org/static/eb8bda25806a89ebdc838813bdfa3601/6b2ea/thinking-in-react-components.png 275w\"> </span> </span> </p>\n<p>You’ll see here that we have five components in our app. We’ve italicized the data each component represents.</p>\n<ol>\n<li><strong><code class=gatsby-code-text>FilterableProductTable</code> (orange):</strong> contains the entirety of the example</li>\n<li><strong><code class=gatsby-code-text>SearchBar</code> (blue):</strong> receives all <em>user input</em></li>\n<li><strong><code class=gatsby-code-text>ProductTable</code> (green):</strong> displays and filters the <em>data collection</em> based on <em>user input</em></li>\n<li><strong><code class=gatsby-code-text>ProductCategoryRow</code> (turquoise):</strong> displays a heading for each <em>category</em></li>\n<li><strong><code class=gatsby-code-text>ProductRow</code> (red):</strong> displays a row for each <em>product</em></li>\n</ol>\n<p>If you look at <code class=gatsby-code-text>ProductTable</code>, you’ll see that the table header (containing the “Name” and “Price” labels) isn’t its own component. This is a matter of preference, and there’s an argument to be made either way. For this example, we left it as part of <code class=gatsby-code-text>ProductTable</code> because it is part of rendering the <em>data collection</em> which is <code class=gatsby-code-text>ProductTable</code>’s responsibility. However, if this header grows to be complex (e.g., if we were to add affordances for sorting), it would certainly make sense to make this its own <code class=gatsby-code-text>ProductTableHeader</code> component.</p>\n<p>Now that we’ve identified the components in our mock, let’s arrange them into a hierarchy. Components that appear within another component in the mock should appear as a child in the hierarchy:</p>\n<ul>\n<li>\n<p><code class=gatsby-code-text>FilterableProductTable</code></p>\n<ul>\n<li><code class=gatsby-code-text>SearchBar</code></li>\n<li>\n<p><code class=gatsby-code-text>ProductTable</code></p>\n<ul>\n<li><code class=gatsby-code-text>ProductCategoryRow</code></li>\n<li><code class=gatsby-code-text>ProductRow</code></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=step-2-build-a-static-version-in-react><a href=#step-2-build-a-static-version-in-react class=anchor><svg height=16 width=16><path></path></svg></a>Step 2: Build A Static Version in React </h2>\n<p class=codepen>See the Pen <a href=https://codepen.io/gaearon/pen/BwWzwm>Thinking In React: Step 2</a> on <a href=https://codepen.io>CodePen</a>.</p> <p>Now that you have your component hierarchy, it’s time to implement your app. The easiest way is to build a version that takes your data model and renders the UI but has no interactivity. It’s best to decouple these processes because building a static version requires a lot of typing and no thinking, and adding interactivity requires a lot of thinking and not a lot of typing. We’ll see why.</p>\n<p>To build a static version of your app that renders your data model, you’ll want to build components that reuse other components and pass data using <em>props</em>. <em>props</em> are a way of passing data from parent to child. If you’re familiar with the concept of <em>state</em>, <strong>don’t use state at all</strong> to build this static version. State is reserved only for interactivity, that is, data that changes over time. Since this is a static version of the app, you don’t need it.</p>\n<p>You can build top-down or bottom-up. That is, you can either start with building the components higher up in the hierarchy (i.e. starting with <code class=gatsby-code-text>FilterableProductTable</code>) or with the ones lower in it (<code class=gatsby-code-text>ProductRow</code>). In simpler examples, it’s usually easier to go top-down, and on larger projects, it’s easier to go bottom-up and write tests as you build.</p>\n<p>At the end of this step, you’ll have a library of reusable components that render your data model. The components will only have <code class=gatsby-code-text>render()</code> methods since this is a static version of your app. The component at the top of the hierarchy (<code class=gatsby-code-text>FilterableProductTable</code>) will take your data model as a prop. If you make a change to your underlying data model and call <code class=gatsby-code-text>ReactDOM.render()</code> again, the UI will be updated. You can see how your UI is updated and where to make changes. React’s <strong>one-way data flow</strong> (also called <em>one-way binding</em>) keeps everything modular and fast.</p>\n<p>Refer to the <a href=/docs/ >React docs</a> if you need help executing this step.</p>\n<h3 id=a-brief-interlude-props-vs-state><a href=#a-brief-interlude-props-vs-state class=anchor><svg height=16 width=16><path></path></svg></a>A Brief Interlude: Props vs State </h3>\n<p>There are two types of “model” data in React: props and state. It’s important to understand the distinction between the two; skim <a href=/docs/state-and-lifecycle.html>the official React docs</a> if you aren’t sure what the difference is. See also <a href=/docs/faq-state.html#what-is-the-difference-between-state-and-props>FAQ: What is the difference between state and props?</a></p>\n<h2 id=step-3-identify-the-minimal-but-complete-representation-of-ui-state><a href=#step-3-identify-the-minimal-but-complete-representation-of-ui-state class=anchor><svg height=16 width=16><path></path></svg></a>Step 3: Identify The Minimal (but complete) Representation Of UI State </h2>\n<p>To make your UI interactive, you need to be able to trigger changes to your underlying data model. React achieves this with <strong>state</strong>.</p>\n<p>To build your app correctly, you first need to think of the minimal set of mutable state that your app needs. The key here is <a href=https://en.wikipedia.org/wiki/Don%27t_repeat_yourself>DRY: <em>Don’t Repeat Yourself</em></a>. Figure out the absolute minimal representation of the state your application needs and compute everything else you need on-demand. For example, if you’re building a TODO list, keep an array of the TODO items around; don’t keep a separate state variable for the count. Instead, when you want to render the TODO count, take the length of the TODO items array.</p>\n<p>Think of all of the pieces of data in our example application. We have:</p>\n<ul>\n<li>The original list of products</li>\n<li>The search text the user has entered</li>\n<li>The value of the checkbox</li>\n<li>The filtered list of products</li>\n</ul>\n<p>Let’s go through each one and figure out which one is state. Ask three questions about each piece of data:</p>\n<ol>\n<li>Is it passed in from a parent via props? If so, it probably isn’t state.</li>\n<li>Does it remain unchanged over time? If so, it probably isn’t state.</li>\n<li>Can you compute it based on any other state or props in your component? If so, it isn’t state.</li>\n</ol>\n<p>The original list of products is passed in as props, so that’s not state. The search text and the checkbox seem to be state since they change over time and can’t be computed from anything. And finally, the filtered list of products isn’t state because it can be computed by combining the original list of products with the search text and value of the checkbox.</p>\n<p>So finally, our state is:</p>\n<ul>\n<li>The search text the user has entered</li>\n<li>The value of the checkbox</li>\n</ul>\n<h2 id=step-4-identify-where-your-state-should-live><a href=#step-4-identify-where-your-state-should-live class=anchor><svg height=16 width=16><path></path></svg></a>Step 4: Identify Where Your State Should Live </h2>\n<p class=codepen>See the Pen <a href=https://codepen.io/gaearon/pen/qPrNQZ>Thinking In React: Step 4</a> on <a href=https://codepen.io>CodePen</a>.</p>\n<p>OK, so we’ve identified what the minimal set of app state is. Next, we need to identify which component mutates, or <em>owns</em>, this state.</p>\n<p>Remember: React is all about one-way data flow down the component hierarchy. It may not be immediately clear which component should own what state. <strong>This is often the most challenging part for newcomers to understand,</strong> so follow these steps to figure it out:</p>\n<p>For each piece of state in your application:</p>\n<ul>\n<li>Identify every component that renders something based on that state.</li>\n<li>Find a common owner component (a single component above all the components that need the state in the hierarchy).</li>\n<li>Either the common owner or another component higher up in the hierarchy should own the state.</li>\n<li>If you can’t find a component where it makes sense to own the state, create a new component solely for holding the state and add it somewhere in the hierarchy above the common owner component.</li>\n</ul>\n<p>Let’s run through this strategy for our application:</p>\n<ul>\n<li><code class=gatsby-code-text>ProductTable</code> needs to filter the product list based on state and <code class=gatsby-code-text>SearchBar</code> needs to display the search text and checked state.</li>\n<li>The common owner component is <code class=gatsby-code-text>FilterableProductTable</code>.</li>\n<li>It conceptually makes sense for the filter text and checked value to live in <code class=gatsby-code-text>FilterableProductTable</code></li>\n</ul>\n<p>Cool, so we’ve decided that our state lives in <code class=gatsby-code-text>FilterableProductTable</code>. First, add an instance property <code class=gatsby-code-text>this.state = {filterText: '', inStockOnly: false}</code> to <code class=gatsby-code-text>FilterableProductTable</code>’s <code class=gatsby-code-text>constructor</code> to reflect the initial state of your application. Then, pass <code class=gatsby-code-text>filterText</code> and <code class=gatsby-code-text>inStockOnly</code> to <code class=gatsby-code-text>ProductTable</code> and <code class=gatsby-code-text>SearchBar</code> as a prop. Finally, use these props to filter the rows in <code class=gatsby-code-text>ProductTable</code> and set the values of the form fields in <code class=gatsby-code-text>SearchBar</code>.</p>\n<p>You can start seeing how your application will behave: set <code class=gatsby-code-text>filterText</code> to <code class=gatsby-code-text>\"ball\"</code> and refresh your app. You’ll see that the data table is updated correctly.</p>\n<h2 id=step-5-add-inverse-data-flow><a href=#step-5-add-inverse-data-flow class=anchor><svg height=16 width=16><path></path></svg></a>Step 5: Add Inverse Data Flow </h2>\n<p class=codepen>See the Pen <a href=https://codepen.io/gaearon/pen/LzWZvb>Thinking In React: Step 5</a> on <a href=https://codepen.io>CodePen</a>.</p>\n<p>So far, we’ve built an app that renders correctly as a function of props and state flowing down the hierarchy. Now it’s time to support data flowing the other way: the form components deep in the hierarchy need to update the state in <code class=gatsby-code-text>FilterableProductTable</code>.</p>\n<p>React makes this data flow explicit to help you understand how your program works, but it does require a little more typing than traditional two-way data binding.</p>\n<p>If you try to type or check the box in the current version of the example, you’ll see that React ignores your input. This is intentional, as we’ve set the <code class=gatsby-code-text>value</code> prop of the <code class=gatsby-code-text>input</code> to always be equal to the <code class=gatsby-code-text>state</code> passed in from <code class=gatsby-code-text>FilterableProductTable</code>.</p>\n<p>Let’s think about what we want to happen. We want to make sure that whenever the user changes the form, we update the state to reflect the user input. Since components should only update their own state, <code class=gatsby-code-text>FilterableProductTable</code> will pass callbacks to <code class=gatsby-code-text>SearchBar</code> that will fire whenever the state should be updated. We can use the <code class=gatsby-code-text>onChange</code> event on the inputs to be notified of it. The callbacks passed by <code class=gatsby-code-text>FilterableProductTable</code> will call <code class=gatsby-code-text>setState()</code>, and the app will be updated.</p>\n<h2 id=and-thats-it><a href=#and-thats-it class=anchor><svg height=16 width=16><path></path></svg></a>And That’s It </h2>\n<p>Hopefully, this gives you an idea of how to think about building components and applications with React. While it may be a little more typing than you’re used to, remember that code is read far more than it’s written, and it’s less difficult to read this modular, explicit code. As you start to build large libraries of components, you’ll appreciate this explicitness and modularity, and with code reuse, your lines of code will start to shrink. :)</p></div></body></html>",
            "source": "https://reactjs.org/docs/thinking-in-react.html",
            "title": "Thinking in React – React",
            "author": null,
            "published": null,
            "image": "https://reactjs.org/logo-og.png",
            "description": "A JavaScript library for building user interfaces",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab7f130cba20187c5de3",
                    "title": "React",
                    "color": "#d00a4d"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab79130cba20187c5dde",
                            "title": "VueJS",
                            "value": "VueJS",
                            "label": "VueJS",
                            "color": "#0b9414",
                            "children": []
                        },
                        {
                            "_id": "5fdcab7f130cba20187c5de3",
                            "title": "React",
                            "value": "React",
                            "label": "React",
                            "color": "#d00a4d",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab52130cba20187c5dd4",
                    "title": "Javascript",
                    "color": "#bf0284"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab52130cba20187c5dd4",
                            "title": "Javascript",
                            "value": "Javascript",
                            "label": "Javascript",
                            "color": "#bf0284",
                            "children": [
                                {
                                    "_id": "5fdcab79130cba20187c5dde",
                                    "title": "VueJS",
                                    "value": "VueJS",
                                    "label": "VueJS",
                                    "color": "#0b9414",
                                    "children": []
                                },
                                {
                                    "_id": "5fdcab7f130cba20187c5de3",
                                    "title": "React",
                                    "value": "React",
                                    "label": "React",
                                    "color": "#d00a4d",
                                    "children": []
                                }
                            ]
                        },
                        {
                            "_id": "5fdcab73130cba20187c5ddb",
                            "title": "C#",
                            "value": "C#",
                            "label": "C#",
                            "color": "#2fd892",
                            "children": []
                        }
                    ],
                    "_id":"5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                }
            ],
            "createdAt": "2020-12-18T14:39:30.246+01:00"
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb137130cba20187c5e28",
            "html": "<html><head></head><body><div class=\"crayons-article__body spec__body text-styles\" id=article-body> <p>I thought I simply didn't understand React. I taught myself React and I still wish I could go back in time and make it like React never existed. Here's why.</p> <h2> 1. It's slow </h2> <p> <a href=https://res.cloudinary.com/practicaldev/image/fetch/s--T0bxys9T--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/61wy5nckh5bqdcxn307q.png class=article-body-image-wrapper><img alt=mobile src=https://res.cloudinary.com/practicaldev/image/fetch/s--T0bxys9T--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/61wy5nckh5bqdcxn307q.png></a> <em>source: tim kadlec</em>\n<br>\n</p> <p>53% of mobile users abandon websites that take longer than 3 seconds to load. For every additional second a page takes to load, 10 percent of users leave. <a href=https://dev.to/wgolledge/an-overview-of-performance-in-javascript-applications-2obb>Performance is user experience.</a></p> <p><a href=https://aerotwist.com/blog/react-plus-performance-equals-what/ >Also read </a><a href=https://css-tricks.com/radeventlistener-a-tale-of-client-side-framework-performance/ >this</a>.</p> <h2> <a href=#2-its-expensive class=anchor> </a> 2. It's expensive\n</h2> <p>Put your React app into this testing tool: <a href=https://whatdoesmysitecost.com/ >https://whatdoesmysitecost.com/</a>. </p> <p>Do you care about people who can't afford to pay for expensive websites on their data plan? </p> <p>A <a href=https://timkadlec.com/remembers/2020-04-21-the-cost-of-javascript-frameworks/ >lot</a> <a href=https://medium.com/@addyosmani/the-cost-of-javascript-in-2018-7d8950fbb5d4>of</a> <a href=https://macwright.com/2020/05/10/spa-fatigue.html>people</a> have discussed how expensive JavaScript frameworks are, but it seems developers don't care about reaching all their potential users. I'm not the first person to make this point, but it seems like the message isn't getting through. Do you think some users are more important than others? Do you care about reaching <em> all </em> users or only the wealthy ones? </p> <h2> <a href=#3-its-inaccessible class=anchor> </a> 3. It's inaccessible\n</h2> <p>Hundreds of millions of users access the Internet from <a href=https://en.wikipedia.org/wiki/Feature_phone>feature phones</a> with a 2G connection. When you load all your JavaScript onto a feature phone, all the user sees is a spinning wheel.</p> <p>There's so many <a href=https://dev.to/addyosmani/loading-web-pages-fast-on-a-20-feature-phone-8h6>articles</a>, <a href=https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers>tools</a>, and <a href=https://preactjs.com/ >frameworks</a> that help you develop for these users - but developers scorn them. Within the <a href=https://www.reddit.com/r/javascript/ >JavaScript</a> subreddit, <a href=https://www.reddit.com/r/javascript/comments/cv56c9/should_you_should_be_using_web_workers_hint/ >web</a> <a href=https://www.reddit.com/r/javascript/comments/f9i6gx/for_what_do_you_use_serviceweb_workers_is_it/ >workers</a> <a href=https://www.reddit.com/r/javascript/comments/2pflmp/has_anyone_actually_found_good_uses_for_web/ >are hated</a>, even though <a href=https://surma.dev/things/when-workers/ >they are one of the best tools we have</a> for effectively developing apps on feature phones - scratch that, for all users!</p> <p>If your app is fast on a feature phone, it will be blazing fast on an iPhone. <strong>When you develop with all users in mind, it improves the user experience for <em> all users</em>. </strong></p> <h2> <a href=#4-react-goes-against-what-the-web-was-made-for class=anchor> </a> 4. React goes against what the web was made for\n</h2> <p>Here's the general idea of React: you download all the JavaScript a website needs for like, seven seconds in a row without showing anything, but once you do that, you never have to download resources again, because you've made a single page application.</p> <p>Is this how websites are supposed to be?</p> <blockquote> \"The web is a streaming thing by default. You go to a page and it serves HTML. You'll start seeing it as it's downloaded. Same with images, video...You can do something with just a little bit of the response.\" - <a href=\"https://invidious.snopyta.org/watch?v=G9PpImUEeUA\">Jake Archibald</a> </blockquote> <p>The Internet is a stream. React is not. I see it like this: <strong>React fights against the natural flow of the Internet.</strong></p> <p>Ditch React and become friends with the web. It's a <em>web,</em> interconnected, with resources coming from everywhere. Web apps are not like native apps that take 30 seconds to download before the user accesses the content. Stop treating webpages like native apps.</p> <h2> <a href=#5-its-made-bythose-people class=anchor> </a> 5. It's made by...those people\n</h2> <p>Just read this <a href=https://en.wikipedia.org/wiki/Lawsuits_involving_Facebook>Wikipedia article</a>. No, it's more than you expect.</p> <ul>\n<li><a href=https://infrequently.org/2018/09/the-developer-experience-bait-and-switch/ >Further reading.</a></li>\n<li><a href=https://macwright.com/2020/05/10/spa-fatigue.html>More reading.</a></li>\n<li><a href=\"https://invidious.snopyta.org/watch?v=4bZvq3nodf4\">Recommended viewing.</a></li>\n</ul> </div></body></html>",
            "source": "https://dev.to/ender_minyard/why-you-should-stop-using-react-g7c",
            "title": "Stop Using React",
            "author": null,
            "published": null,
            "image": "https://res.cloudinary.com/practicaldev/image/fetch/s---YsxwuiJ--/c_imagga_scale,f_auto,fl_progressive,h_500,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/i/cv7ln3mwwp4mbzhi8yog.png",
            "description": "I thought I simply didn't understand React. I taught myself React and I still wish I could go back in...",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab7f130cba20187c5de3",
                    "title": "React",
                    "color": "#d00a4d"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab79130cba20187c5dde",
                            "title": "VueJS",
                            "value": "VueJS",
                            "label": "VueJS",
                            "color": "#0b9414",
                            "children": []
                        },
                        {
                            "_id": "5fdcab7f130cba20187c5de3",
                            "title": "React",
                            "value": "React",
                            "label": "React",
                            "color": "#d00a4d",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab52130cba20187c5dd4",
                    "title": "Javascript",
                    "color": "#bf0284"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab52130cba20187c5dd4",
                            "title": "Javascript",
                            "value": "Javascript",
                            "label": "Javascript",
                            "color": "#bf0284",
                            "children": [
                                {
                                    "_id": "5fdcab79130cba20187c5dde",
                                    "title": "VueJS",
                                    "value": "VueJS",
                                    "label": "VueJS",
                                    "color": "#0b9414",
                                    "children": []
                                },
                                {
                                    "_id": "5fdcab7f130cba20187c5de3",
                                    "title": "React",
                                    "value": "React",
                                    "label": "React",
                                    "color": "#d00a4d",
                                    "children": []
                                }
                            ]
                        },
                        {
                            "_id": "5fdcab73130cba20187c5ddb",
                            "title": "C#",
                            "value": "C#",
                            "label": "C#",
                            "color": "#2fd892",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                }
            ],
            "createdAt": "2020-12-18T14:40:07.036+01:00",
            "readAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcb15f130cba20187c5e2c",
            "html": "<html><head></head><body><div class=\"comparison-guide content guide with-sidebar\"> <p class=\"tip v3-warning warning\"> You’re browsing the documentation for v2.x and earlier. For v3.x, <a href=https://v3.vuejs.org/ >click here</a>. </p> <p>This is definitely the most difficult page in the guide to write, but we do feel it’s important. Odds are, you’ve had problems you tried to solve and you’ve used another library to solve them. You’re here because you want to know if Vue can solve your specific problems better. That’s what we hope to answer for you.</p>\n<p>We also try very hard to avoid bias. As the core team, we obviously like Vue a lot. There are some problems we think it solves better than anything else out there. If we didn’t believe that, we wouldn’t be working on it. We do want to be fair and accurate though. Where other libraries offer significant advantages, such as React’s vast ecosystem of alternative renderers or Knockout’s browser support back to IE6, we try to list these as well.</p>\n<p>We’d also like <strong>your</strong> help keeping this document up-to-date because the JavaScript world moves fast! If you notice an inaccuracy or something that doesn’t seem quite right, please let us know by <a href=\"https://github.com/vuejs/vuejs.org/issues/new?title=Inaccuracy+in+comparisons+guide\">opening an issue</a>.</p>\n<h2 id=React><a href=#React class=headerlink></a>React</h2><p>React and Vue share many similarities. They both:</p>\n<ul>\n<li>utilize a virtual DOM</li>\n<li>provide reactive and composable view components</li>\n<li>maintain focus in the core library, with concerns such as routing and global state management handled by companion libraries</li>\n</ul>\n<p>Being so similar in scope, we’ve put more time into fine-tuning this comparison than any other. We want to ensure not only technical accuracy, but also balance. We point out where React outshines Vue, for example in the richness of their ecosystem and abundance of their custom renderers.</p>\n<p>With that said, it’s inevitable that the comparison would appear biased towards Vue to some React users, as many of the subjects explored are to some extent subjective. We acknowledge the existence of varying technical taste, and this comparison primarily aims to outline the reasons why Vue could potentially be a better fit if your preferences happen to coincide with ours.</p>\n<p>Some of the sections below may also be slightly outdated due to recent updates in React 16+, and we are planning to work with the React community to revamp this section in the near future.</p>\n<h3 id=Runtime-Performance><a href=#Runtime-Performance class=headerlink></a>Runtime Performance</h3><p>Both React and Vue are exceptionally and similarly fast, so speed is unlikely to be a deciding factor in choosing between them. For specific metrics though, check out this <a href=https://stefankrause.net/js-frameworks-benchmark8/table.html>3rd party benchmark</a>, which focuses on raw render/update performance with very simple component trees.</p>\n<h4 id=Optimization-Efforts><a href=#Optimization-Efforts class=headerlink></a>Optimization Efforts</h4><p>In React, when a component’s state changes, it triggers the re-render of the entire component sub-tree, starting at that component as root. To avoid unnecessary re-renders of child components, you need to either use <code>PureComponent</code> or implement <code>shouldComponentUpdate</code> whenever you can. You may also need to use immutable data structures to make your state changes more optimization-friendly. However, in certain cases you may not be able to rely on such optimizations because <code>PureComponent/shouldComponentUpdate</code> assumes the entire sub tree’s render output is determined by the props of the current component. If that is not the case, then such optimizations may lead to inconsistent DOM state.</p>\n<p>In Vue, a component’s dependencies are automatically tracked during its render, so the system knows precisely which components actually need to re-render when state changes. Each component can be considered to have <code>shouldComponentUpdate</code> automatically implemented for you, without the nested component caveats.</p>\n<p>Overall this removes the need for a whole class of performance optimizations from the developer’s plate, and allows them to focus more on building the app itself as it scales.</p>\n<h3 id=HTML-amp-CSS><a href=#HTML-amp-CSS class=headerlink></a>HTML &amp; CSS</h3><p>In React, everything is just JavaScript. Not only are HTML structures expressed via JSX, the recent trends also tend to put CSS management inside JavaScript as well. This approach has its own benefits, but also comes with various trade-offs that may not seem worthwhile for every developer.</p>\n<p>Vue embraces classic web technologies and builds on top of them. To show you what that means, we’ll dive into some examples.</p>\n<h4 id=JSX-vs-Templates><a href=#JSX-vs-Templates class=headerlink></a>JSX vs Templates</h4><p>In React, all components express their UI within render functions using JSX, a declarative XML-like syntax that works within JavaScript.</p>\n<p>Render functions with JSX have a few advantages:</p>\n<ul>\n<li><p>You can leverage the power of a full programming language (JavaScript) to build your view. This includes temporary variables, flow controls, and directly referencing JavaScript values in scope.</p>\n</li>\n<li><p>The tooling support (e.g. linting, type checking, editor autocompletion) for JSX is in some ways more advanced than what’s currently available for Vue templates.</p>\n</li>\n</ul>\n<p>In Vue, we also have <a href=render-function.html>render functions</a> and even <a href=render-function.html#JSX>support JSX</a>, because sometimes you do need that power. However, as the default experience we offer templates as a simpler alternative. Any valid HTML is also a valid Vue template, and this leads to a few advantages of its own:</p>\n<ul>\n<li><p>For many developers who have been working with HTML, templates feel more natural to read and write. The preference itself can be somewhat subjective, but if it makes the developer more productive then the benefit is objective.</p>\n</li>\n<li><p>HTML-based templates make it much easier to progressively migrate existing applications to take advantage of Vue’s reactivity features.</p>\n</li>\n<li><p>It also makes it much easier for designers and less experienced developers to parse and contribute to the codebase.</p>\n</li>\n<li><p>You can even use pre-processors such as Pug (formerly known as Jade) to author your Vue templates.</p>\n</li>\n</ul>\n<p>Some argue that you’d need to learn an extra DSL (Domain-Specific Language) to be able to write templates - we believe this difference is superficial at best. First, JSX doesn’t mean the user doesn’t need to learn anything - it’s additional syntax on top of plain JavaScript, so it can be easy for someone familiar with JavaScript to learn, but saying it’s essentially free is misleading. Similarly, a template is just additional syntax on top of plain HTML and thus has very low learning cost for those who are already familiar with HTML. With the DSL we are also able to help the user get more done with less code (e.g. <code>v-on</code> modifiers). The same task can involve a lot more code when using plain JSX or render functions.</p>\n<p>On a higher level, we can divide components into two categories: presentational ones and logical ones. We recommend using templates for presentational components and render function / JSX for logical ones. The percentage of these components depends on the type of app you are building, but in general we find presentational ones to be much more common.</p>\n<h4 id=Component-Scoped-CSS><a href=#Component-Scoped-CSS class=headerlink></a>Component-Scoped CSS</h4><p>Unless you spread components out over multiple files (for example with <a href=https://github.com/gajus/react-css-modules>CSS Modules</a>), scoping CSS in React is often done via CSS-in-JS solutions (e.g. <a href=https://github.com/styled-components/styled-components>styled-components</a> and <a href=https://github.com/emotion-js/emotion>emotion</a>). This introduces a new component-oriented styling paradigm that is different from the normal CSS authoring process. Additionally, although there is support for extracting CSS into a single stylesheet at build time, it is still common that a runtime will need to be included in the bundle for styling to work properly. While you gain access to the dynamism of JavaScript while constructing your styles, the tradeoff is often increased bundle size and runtime cost.</p>\n<p>If you are a fan of CSS-in-JS, many of the popular CSS-in-JS libraries support Vue (e.g. <a href=https://github.com/styled-components/vue-styled-components>styled-components-vue</a> and <a href=https://github.com/egoist/vue-emotion>vue-emotion</a>). The main difference between React and Vue here is that the default method of styling in Vue is through more familiar <code>style</code> tags in <a href=single-file-components.html>single-file components</a>.</p>\n<p><a href=single-file-components.html>Single-file components</a> give you full access to CSS in the same file as the rest of your component code.</p>\n<pre><code class=\"hljs html\"><span class=hljs-tag>&lt;<span class=hljs-name>style</span> <span class=hljs-attr>scoped</span>&gt;</span><span class=css> <span class=hljs-keyword>@media</span> (<span class=hljs-attribute>min-width:</span> <span class=hljs-number>250px</span>) { <span class=hljs-selector-class>.list-container</span><span class=hljs-selector-pseudo>:hover</span> { <span class=hljs-attribute>background</span>: orange; } }\n</span><span class=hljs-tag>&lt;/<span class=hljs-name>style</span>&gt;</span></code></pre>\n<p>The optional <code>scoped</code> attribute automatically scopes this CSS to your component by adding a unique attribute (such as <code>data-v-21e5b78</code>) to elements and compiling <code>.list-container:hover</code> to something like <code>.list-container[data-v-21e5b78]:hover</code>.</p>\n<p>Lastly, the styling in Vue’s single-file components is very flexible. Through <a href=https://github.com/vuejs/vue-loader>vue-loader</a>, you can use any preprocessor, post-processor, and even deep integration with <a href=https://vue-loader.vuejs.org/en/features/css-modules.html>CSS Modules</a> – all within the <code>&lt;style&gt;</code> element.</p>\n<h3 id=Scale><a href=#Scale class=headerlink></a>Scale</h3><h4 id=Scaling-Up><a href=#Scaling-Up class=headerlink></a>Scaling Up</h4><p>For large applications, both Vue and React offer robust routing solutions. The React community has also been very innovative in terms of state management solutions (e.g. Flux/Redux). These state management patterns and <a href=\"https://yarnpkg.com/en/packages?q=redux%20vue&amp;p=1\">even Redux itself</a> can be easily integrated into Vue applications. In fact, Vue has even taken this model a step further with <a href=https://github.com/vuejs/vuex>Vuex</a>, an Elm-inspired state management solution that integrates deeply into Vue that we think offers a superior development experience.</p>\n<p>Another important difference between these offerings is that Vue’s companion libraries for state management and routing (among <a href=https://github.com/vuejs>other concerns</a>) are all officially supported and kept up-to-date with the core library. React instead chooses to leave these concerns to the community, creating a more fragmented ecosystem. Being more popular though, React’s ecosystem is considerably richer than Vue’s.</p>\n<p>Finally, Vue offers a <a href=https://github.com/vuejs/vue-cli>CLI project generator</a> that makes it trivially easy to start a new project by featuring an interactive project scaffolding wizard. You can even use it for <a href=https://cli.vuejs.org/guide/prototyping.html#instant-prototyping>instantly prototyping</a> a component. React is also making strides in this area with <a href=https://github.com/facebookincubator/create-react-app>create-react-app</a>, but it currently has a few limitations:</p>\n<ul>\n<li>It does not allow any configuration during project generation, while Vue CLI runs on top of an upgradeable runtime dependency that can be extended via <a href=https://cli.vuejs.org/guide/plugins-and-presets.html#plugins>plugins</a>.</li>\n<li>It only offers a single template that assumes you’re building a single-page application, while Vue offers a wide variety of default options for various purposes and build systems.</li>\n<li>It cannot generate projects from user-built <a href=https://cli.vuejs.org/guide/plugins-and-presets.html#presets>presets</a>, which can be especially useful for enterprise environments with pre-established conventions.</li>\n</ul>\n<p>It’s important to note that many of these limitations are intentional design decisions made by the create-react-app team and they do have their advantages. For example, as long as your project’s needs are very simple and you never need to “eject” to customize your build process, you’ll be able to update it as a dependency. You can read more about the <a href=https://github.com/facebookincubator/create-react-app#philosophy>differing philosophy here</a>.</p>\n<h4 id=Scaling-Down><a href=#Scaling-Down class=headerlink></a>Scaling Down</h4><p>React is renowned for its steep learning curve. Before you can really get started, you need to know about JSX and probably ES2015+, since many examples use React’s class syntax. You also have to learn about build systems, because although you could technically use Babel Standalone to live-compile your code in the browser, it’s absolutely not suitable for production.</p>\n<p>While Vue scales up just as well as React, it also scales down just as well as jQuery. That’s right - to get started, all you have to do is drop a single script tag into the page:</p>\n<pre><code class=\"hljs html\"><span class=hljs-tag>&lt;<span class=hljs-name>script</span> <span class=hljs-attr>src</span>=<span class=hljs-string>\"https://cdn.jsdelivr.net/npm/vue@2\"</span>&gt;</span><span class=hljs-tag>&lt;/<span class=hljs-name>script</span>&gt;</span></code></pre>\n<p>Then you can start writing Vue code and even ship the minified version to production without feeling guilty or having to worry about performance problems.</p>\n<p>Since you don’t need to know about JSX, ES2015, or build systems to get started with Vue, it also typically takes developers less than a day reading <a href=./ >the guide</a> to learn enough to build non-trivial applications.</p>\n<h3 id=Native-Rendering><a href=#Native-Rendering class=headerlink></a>Native Rendering</h3><p>React Native enables you to write native-rendered apps for iOS and Android using the same React component model. This is great in that as a developer, you can apply your knowledge of a framework across multiple platforms. On this front, Vue has an official collaboration with <a href=https://weex.apache.org/ >Weex</a>, a cross-platform UI framework created by Alibaba Group and being incubated by the Apache Software Foundation (ASF). Weex allows you to use the same Vue component syntax to author components that can not only be rendered in the browser, but also natively on iOS and Android!</p>\n<p>At this moment, Weex is still in active development and is not as mature and battle-tested as React Native, but its development is driven by the production needs of the largest e-commerce business in the world, and the Vue team will also actively collaborate with the Weex team to ensure a smooth experience for Vue developers.</p>\n<p>Another option is <a href=https://nativescript-vue.org/ >NativeScript-Vue</a>, a <a href=https://www.nativescript.org/ >NativeScript</a> plugin for building truly native applications using Vue.js.</p>\n<h3 id=With-MobX><a href=#With-MobX class=headerlink></a>With MobX</h3><p>MobX has become quite popular in the React community and it actually uses a nearly identical reactivity system to Vue. To a limited extent, the React + MobX workflow can be thought of as a more verbose Vue, so if you’re using that combination and are enjoying it, jumping into Vue is probably the next logical step.</p>\n<h3 id=Preact-and-Other-React-Like-Libraries><a href=#Preact-and-Other-React-Like-Libraries class=headerlink></a>Preact and Other React-Like Libraries</h3><p>React-like libraries usually try to share as much of their API and ecosystem with React as is feasible. For that reason, the vast majority of comparisons above will also apply to them. The main difference will typically be a reduced ecosystem, often significantly, compared to React. Since these libraries cannot be 100% compatible with everything in the React ecosystem, some tooling and companion libraries may not be usable. Or, even if they appear to work, they could break at any time unless your specific React-like library is officially supported on par with React.</p>\n<h2 id=AngularJS-Angular-1><a href=#AngularJS-Angular-1 class=headerlink></a>AngularJS (Angular 1)</h2><p>Some of Vue’s syntax will look very similar to AngularJS (e.g. <code>v-if</code> vs <code>ng-if</code>). This is because there were a lot of things that AngularJS got right and these were an inspiration for Vue very early in its development. There are also many pains that come with AngularJS however, where Vue has attempted to offer a significant improvement.</p>\n<h3 id=Complexity><a href=#Complexity class=headerlink></a>Complexity</h3><p>Vue is much simpler than AngularJS, both in terms of API and design. Learning enough to build non-trivial applications typically takes less than a day, which is not true for AngularJS.</p>\n<h3 id=Flexibility-and-Modularity><a href=#Flexibility-and-Modularity class=headerlink></a>Flexibility and Modularity</h3><p>AngularJS has strong opinions about how your applications should be structured, while Vue is a more flexible, modular solution. While this makes Vue more adaptable to a wide variety of projects, we also recognize that sometimes it’s useful to have some decisions made for you, so that you can just start coding.</p>\n<p>That’s why we offer a full system for rapid Vue.js development. <a href=https://github.com/vuejs/vue-cli>Vue CLI</a> aims to be the standard tooling baseline for the Vue ecosystem. It ensures the various build tools work smoothly together with sensible defaults so you can focus on writing your app instead of spending hours wrangling with configurations. At the same time, it still offers the flexibility to tweak the configuration of each tool to specific needs.</p>\n<h3 id=Data-binding><a href=#Data-binding class=headerlink></a>Data binding</h3><p>AngularJS uses two-way binding between scopes, while Vue enforces a one-way data flow between components. This makes the flow of data easier to reason about in non-trivial applications.</p>\n<h3 id=Directives-vs-Components><a href=#Directives-vs-Components class=headerlink></a>Directives vs Components</h3><p>Vue has a clearer separation between directives and components. Directives are meant to encapsulate DOM manipulations only, while components are self-contained units that have their own view and data logic. In AngularJS, directives do everything and components are just a specific kind of directive.</p>\n<h3 id=Runtime-Performance-1><a href=#Runtime-Performance-1 class=headerlink></a>Runtime Performance</h3><p>Vue has better performance and is much, much easier to optimize because it doesn’t use dirty checking. AngularJS becomes slow when there are a lot of watchers, because every time anything in the scope changes, all these watchers need to be re-evaluated again. Also, the digest cycle may have to run multiple times to “stabilize” if some watcher triggers another update. AngularJS users often have to resort to esoteric techniques to get around the digest cycle, and in some situations, there’s no way to optimize a scope with many watchers.</p>\n<p>Vue doesn’t suffer from this at all because it uses a transparent dependency-tracking observation system with async queueing - all changes trigger independently unless they have explicit dependency relationships.</p>\n<p>Interestingly, there are quite a few similarities in how Angular and Vue are addressing these AngularJS issues.</p>\n<h2 id=Angular-Formerly-known-as-Angular-2><a href=#Angular-Formerly-known-as-Angular-2 class=headerlink></a>Angular (Formerly known as Angular 2)</h2><p>We have a separate section for the new Angular because it really is a completely different framework from AngularJS. For example, it features a first-class component system, many implementation details have been completely rewritten, and the API has also changed quite drastically.</p>\n<h3 id=TypeScript><a href=#TypeScript class=headerlink></a>TypeScript</h3><p>Angular essentially requires using TypeScript, given that almost all its documentation and learning resources are TypeScript-based. TypeScript has its benefits - static type checking can be very useful for large-scale applications, and can be a big productivity boost for developers with backgrounds in Java and C#.</p>\n<p>However, not everyone wants to use TypeScript. In many smaller-scale use cases, introducing a type system may result in more overhead than productivity gain. In those cases you’d be better off going with Vue instead, since using Angular without TypeScript can be challenging.</p>\n<p>Finally, although not as deeply integrated with TypeScript as Angular is, Vue also offers <a href=https://github.com/vuejs/vue/tree/dev/types>official typings</a> and <a href=https://github.com/vuejs/vue-class-component>official decorator</a> for those who wish to use TypeScript with Vue. We are also actively collaborating with the TypeScript and VSCode teams at Microsoft to improve the TS/IDE experience for Vue + TS users.</p>\n<h3 id=Runtime-Performance-2><a href=#Runtime-Performance-2 class=headerlink></a>Runtime Performance</h3><p>Both frameworks are exceptionally fast, with very similar metrics on benchmarks. You can <a href=https://stefankrause.net/js-frameworks-benchmark8/table.html>browse specific metrics</a> for a more granular comparison, but speed is unlikely to be a deciding factor.</p>\n<h3 id=Size><a href=#Size class=headerlink></a>Size</h3><p>Recent versions of Angular, with <a href=https://en.wikipedia.org/wiki/Ahead-of-time_compilation>AOT compilation</a> and <a href=https://en.wikipedia.org/wiki/Tree_shaking>tree-shaking</a>, have been able to get its size down considerably. However, a full-featured Vue 2 project with Vuex + Vue Router included (~30KB gzipped) is still significantly lighter than an out-of-the-box, AOT-compiled application generated by <code>angular-cli</code> (~65KB gzipped).</p>\n<h3 id=Flexibility><a href=#Flexibility class=headerlink></a>Flexibility</h3><p>Vue is much less opinionated than Angular, offering official support for a variety of build systems, with no restrictions on how you structure your application. Many developers enjoy this freedom, while some prefer having only one Right Way to build any application.</p>\n<h3 id=Learning-Curve><a href=#Learning-Curve class=headerlink></a>Learning Curve</h3><p>To get started with Vue, all you need is familiarity with HTML and ES5 JavaScript (i.e. plain JavaScript). With these basic skills, you can start building non-trivial applications within less than a day of reading <a href=./ >the guide</a>.</p>\n<p>Angular’s learning curve is much steeper. The API surface of the framework is huge and as a user you will need to familiarize yourself with a lot more concepts before getting productive. The complexity of Angular is largely due to its design goal of targeting only large, complex applications - but that does make the framework a lot more difficult for less-experienced developers to pick up.</p>\n<h2 id=Ember><a href=#Ember class=headerlink></a>Ember</h2><p>Ember is a full-featured framework that is designed to be highly opinionated. It provides a lot of established conventions and once you are familiar enough with them, it can make you very productive. However, it also means the learning curve is high and flexibility suffers. It’s a trade-off when you try to pick between an opinionated framework and a library with a loosely coupled set of tools that work together. The latter gives you more freedom but also requires you to make more architectural decisions.</p>\n<p>That said, it would probably make a better comparison between Vue core and Ember’s <a href=https://guides.emberjs.com/v2.10.0/templates/handlebars-basics/ >templating</a> and <a href=https://guides.emberjs.com/v2.10.0/object-model/ >object model</a> layers:</p>\n<ul>\n<li><p>Vue provides unobtrusive reactivity on plain JavaScript objects and fully automatic computed properties. In Ember, you need to wrap everything in Ember Objects and manually declare dependencies for computed properties.</p>\n</li>\n<li><p>Vue’s template syntax harnesses the full power of JavaScript expressions, while Handlebars’ expression and helper syntax is intentionally quite limited in comparison.</p>\n</li>\n<li><p>Performance-wise, Vue outperforms Ember <a href=https://stefankrause.net/js-frameworks-benchmark8/table.html>by a fair margin</a>, even after the latest Glimmer engine update in Ember 3.x. Vue automatically batches updates, while in Ember you need to manually manage run loops in performance-critical situations.</p>\n</li>\n</ul>\n<h2 id=Knockout><a href=#Knockout class=headerlink></a>Knockout</h2><p>Knockout was a pioneer in the MVVM and dependency tracking spaces and its reactivity system is very similar to Vue’s. Its <a href=http://knockoutjs.com/documentation/browser-support.html>browser support</a> is also very impressive considering everything it does, with support back to IE6! Vue on the other hand only supports IE9+.</p>\n<p>Over time though, Knockout development has slowed and it’s begun to show its age a little. For example, its component system lacks a full set of lifecycle hooks and although it’s a very common use case, the interface for passing children to a component feels a little clunky compared to <a href=components.html#Content-Distribution-with-Slots>Vue’s</a>.</p>\n<p>There also seem to be philosophical differences in the API design which if you’re curious, can be demonstrated by how each handles the creation of a <a href=https://gist.github.com/chrisvfritz/9e5f2d6826af00fcbace7be8f6dccb89>simple todo list</a>. It’s definitely somewhat subjective, but many consider Vue’s API to be less complex and better structured.</p>\n<h2 id=Polymer><a href=#Polymer class=headerlink></a>Polymer</h2><p>Polymer is another Google-sponsored project and in fact was a source of inspiration for Vue as well. Vue’s components can be loosely compared to Polymer’s custom elements and both provide a very similar development style. The biggest difference is that Polymer is built upon the latest Web Components features and requires non-trivial polyfills to work (with degraded performance) in browsers that don’t support those features natively. In contrast, Vue works without any dependencies or polyfills down to IE9.</p>\n<p>In Polymer, the team has also made its data-binding system very limited in order to compensate for the performance. For example, the only expressions supported in Polymer templates are boolean negation and single method calls. Its computed property implementation is also not very flexible.</p>\n<h2 id=Riot><a href=#Riot class=headerlink></a>Riot</h2><p>Riot 3.0 provides a similar component-based development model (which is called a “tag” in Riot), with a minimal and beautifully designed API. Riot and Vue probably share a lot in design philosophies. However, despite being a bit heavier than Riot, Vue does offer some significant advantages:</p>\n<ul>\n<li>Better performance. Riot <a href=https://v3.riotjs.now.sh/compare/#virtual-dom-vs-expressions-binding>traverses a DOM tree</a> rather than using a virtual DOM, so suffers from the same performance issues as AngularJS.</li>\n<li>More mature tooling support. Vue provides official support for <a href=https://github.com/vuejs/vue-loader>webpack</a> and <a href=https://github.com/vuejs/vueify>Browserify</a>, while Riot relies on community support for build system integration.</li>\n</ul> <p class=guide-links> <span>← <a href=/v2/guide/migration-vuex.html>Migration from Vuex 0.6.x to 1.0</a></span> <span><a href=/v2/guide/join.html>Join the Vue.js Community!</a> →</span> </p> </div></body></html>",
            "source": "https://vuejs.org/v2/guide/comparison.html",
            "title": "Comparison with Other Frameworks — Vue.js",
            "author": null,
            "published": null,
            "image": "https://vuejs.org//images/logo.png",
            "description": "Vue.js - The Progressive JavaScript Framework",
            "tags": [
                {
                    "children": [],
                    "_id": "5fdcab79130cba20187c5dde",
                    "title": "VueJS",
                    "color": "#0b9414"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab79130cba20187c5dde",
                            "title": "VueJS",
                            "value": "VueJS",
                            "label": "VueJS",
                            "color": "#0b9414",
                            "children": []
                        },
                        {
                            "_id": "5fdcab7f130cba20187c5de3",
                            "title": "React",
                            "value": "React",
                            "label": "React",
                            "color": "#d00a4d",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab52130cba20187c5dd4",
                    "title": "Javascript",
                    "color": "#bf0284"
                },
                {
                    "children": [
                        {
                            "_id": "5fdcab52130cba20187c5dd4",
                            "title": "Javascript",
                            "value": "Javascript",
                            "label": "Javascript",
                            "color": "#bf0284",
                            "children": [
                                {
                                    "_id": "5fdcab79130cba20187c5dde",
                                    "title": "VueJS",
                                    "value": "VueJS",
                                    "label": "VueJS",
                                    "color": "#0b9414",
                                    "children": []
                                },
                                {
                                    "_id": "5fdcab7f130cba20187c5de3",
                                    "title": "React",
                                    "value": "React",
                                    "label": "React",
                                    "color": "#d00a4d",
                                    "children": []
                                }
                            ]
                        },
                        {
                            "_id": "5fdcab73130cba20187c5ddb",
                            "title": "C#",
                            "value": "C#",
                            "label": "C#",
                            "color": "#2fd892",
                            "children": []
                        }
                    ],
                    "_id": "5fdcab4b130cba20187c5dd1",
                    "title": "Programmeren",
                    "color": "#fbc9a7"
                }
            ],
            "createdAt":"2020-12-18T14:40:47.992+01:00",
            "readAt": "2020-12-18T15:45:56.115+01:00",
            "archivedAt": null
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcc05bde09ff30845f9f25",
            "html": "<html><head></head><body><div class=block-content> <p class=excerpt>Moederbedrijf Audax heeft besloten om de post- en pakketpunten bij de AKO-vestigingen vanaf maandag te sluiten. Ook bij een deel van de Bruna-winkels gaan de punten dicht. Dat bevestigt een woordvoerder na berichtgeving van de <em>NOS</em>. De reden voor de sluiting is dat klanten niet snappen dat ze wel een pakket mogen ophalen of postzegels mogen kopen, maar bijvoorbeeld geen ansichtkaart kunnen krijgen. Ook de meeste Primera's sluiten om die reden hun pakketpunten.</p> <p>Sinds dinsdag zijn alle niet-essentiële winkels gesloten. Post- en pakketpunten mogen wel openblijven. Veel bedrijven die zo'n punt in hun winkel hebben, besloten om open te blijven, om zo nog wat inkomsten te hebben.</p><p>Het gaat onder meer om winkels van Bruna en AKO. Moederbedrijf Audax kreeg echter veel negatieve reacties van klanten die niet snapten waarom ze geen kerstkaart konden kopen, terwijl ze wel een postzegel konden krijgen.</p><p>Audax heeft daarom besloten om alle pakketpunten in winkels die het zelf uitbaat, te sluiten. Dat zijn er ongeveer vijftig. Het betreft alle winkels van AKO en een deel van de Bruna-winkels.</p><p>De overige Bruna-vestigingen zijn in handen van zelfstandige ondernemers, die zelf mogen beslissen of ze openblijven. Dat geldt ook voor de winkels van The Read Shop, dat eveneens onder Audax valt.</p> <h2>Pakketpunten bij meeste Primera's gaan ook dicht</h2> <p>Ook winkelketen Primera heeft besloten om de pakketpunten bij de meeste van zijn ruim 520 winkels te sluiten. Deze gaan zondag al dicht. De ondernemers die de winkels uitbaten, richten zich op het thuisbezorgen van producten.</p><p>De reden van de sluiting is dezelfde als bij Audax. \"De winkels mogen open zijn voor pakketservice, maar wie een rouwkaart of staatslot wil kopen, moeten worden doorverwezen naar een andere winkel verderop in de straat\", aldus het bedrijf in een toelichting. \"De situatie op de winkelvloer is niet langer houdbaar.\"</p><p>Een klein deel van de ondernemers heeft besloten om de winkel toch open te houden, in overleg met lokale overheden.</p> </div></body></html>",
            "source": "https://www.nu.nl/economie/6097540/pakketpunten-akos-en-deel-brunas-dicht-door-verwarring-bij-klanten.html",
            "title": "Pakketpunten AKO's en deel Bruna's dicht door verwarring bij klanten",
            "author": "Door: NU.nl",
            "published": "2020-12-18T13:54:37.000Z",
            "image": "https://media.nu.nl/m/metxeskakgwp_wd1280.jpg/pakketpunten-akos-en-deel-brunas-dicht-door-verwarring-bij-klanten.jpg",
            "description": "Moederbedrijf Audax heeft besloten om de post- en pakketpunten bij de AKO-vestigingen vanaf maandag te sluiten. Ook bij een deel van de Bruna-winkels gaan de punten dicht. Dat bevestigt een&hellip;",
            "tags": [],
            "createdAt": "2020-12-18T15:44:43.642+01:00",
            "readAt": "2020-12-18T15:44:44.882+01:00",
            "archivedAt": "2020-12-18T15:44:59.832+01:00"
        },
        {
            "links": [
                "https://eloquentjavascript.net/06_object.html"
            ],
            "pages": [],
            "_id": "5fdcc07cde09ff30845f9f26",
            "html": "<html><head></head><body><article score=632.0999999999999>\n<nav><a href=https://eloquentjavascript.net/04_data.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/06_object.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_18CYJsdOxo class=p_ident id=p_18CYJsdOxo></a>Tzu-li and Tzu-ssu were boasting about the size of their latest programs. ‘Two-hundred thousand lines,’ said Tzu-li, ‘not counting comments!’ Tzu-ssu responded, ‘Pssh, mine is almost a <em>million</em> lines already.’ Master Yuan-Ma said, ‘My best program has five hundred lines.’ Hearing this, Tzu-li and Tzu-ssu were enlightened.</p> <footer>Master Yuan-Ma, <cite>The Book of Programming</cite></footer> </blockquote> <blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_7EubtoOeCu class=p_ident id=p_7EubtoOeCu></a>There are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies, and the other way is to make it so complicated that there are no obvious deficiencies.</p> <footer>C.A.R. Hoare, <cite>1980 ACM Turing Award Lecture</cite></footer> </blockquote><figure class=\"chapter true\"><img alt=\"Letters from different scripts\" src=https://eloquentjavascript.net/img/chapter_picture_5.jpg></figure> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_rj9+mMLZbL class=p_ident id=p_rj9+mMLZbL></a>A large program is a costly program, and not just because of the time it takes to build. Size almost always involves complexity, and complexity confuses programmers. Confused programmers, in turn, introduce mistakes (<em>bugs</em>) into programs. A large program then provides a lot of space for these bugs to hide, making them hard to find.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_nR+iebr1Ci class=p_ident id=p_nR+iebr1Ci></a>Let’s briefly go back to the final two example programs in the introduction. The first is self-contained and six lines long.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_uIkg9pj99q class=c_ident id=c_uIkg9pj99q></a><p class=cm-keyword>let</p> <p class=cm-def>total</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>, <p class=cm-def>count</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>;\n<p class=cm-keyword>while</p> (<p class=cm-variable>count</p> <p class=cm-operator>&lt;=</p> <p class=cm-number>10</p>) { <p class=cm-variable>total</p> <p class=cm-operator>+=</p> <p class=cm-variable>count</p>; <p class=cm-variable>count</p> <p class=cm-operator>+=</p> <p class=cm-number>1</p>;\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>total</p>);</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Sy8N6Qcb09 class=p_ident id=p_Sy8N6Qcb09></a>The second relies on two external functions and is one line long.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_KTbQMmMCli class=c_ident id=c_KTbQMmMCli></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sum</p>(<p class=cm-variable>range</p>(<p class=cm-number>1</p>, <p class=cm-number>10</p>)));</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_srOi7846QY class=p_ident id=p_srOi7846QY></a>Which one is more likely to contain a bug?</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_G+ApGqjOk4 class=p_ident id=p_G+ApGqjOk4></a>If we count the size of the definitions of <code>sum</code> and <code>range</code>, the second program is also big—even bigger than the first. But still, I’d argue that it is more likely to be correct.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_R0XQHDENqH class=p_ident id=p_R0XQHDENqH></a>It is more likely to be correct because the solution is expressed in a vocabulary that corresponds to the problem being solved. Summing a range of numbers isn’t about loops and counters. It is about ranges and sums.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_VwxmDNivhe class=p_ident id=p_VwxmDNivhe></a>The definitions of this vocabulary (the functions <code>sum</code> and <code>range</code>) will still involve loops, counters, and other incidental details. But because they are expressing simpler concepts than the program as a whole, they are easier to get right.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_j9ps8qrlyo class=h_ident id=h_j9ps8qrlyo></a>Abstraction</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_ZPK6t/LrMG class=p_ident id=p_ZPK6t/LrMG></a>In the context of programming, these kinds of vocabularies are usually called <em>abstractions</em>. Abstractions hide details and give us the ability to talk about problems at a higher (or more abstract) level.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_bTxJr46qvN class=p_ident id=p_bTxJr46qvN></a>As an analogy, compare these two recipes for pea soup. The first one goes like this:</p> <blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_F+PunfZCXq class=p_ident id=p_F+PunfZCXq></a>Put 1 cup of dried peas per person into a container. Add water until the peas are well covered. Leave the peas in water for at least 12 hours. Take the peas out of the water and put them in a cooking pan. Add 4 cups of water per person. Cover the pan and keep the peas simmering for two hours. Take half an onion per person. Cut it into pieces with a knife. Add it to the peas. Take a stalk of celery per person. Cut it into pieces with a knife. Add it to the peas. Take a carrot per person. Cut it into pieces. With a knife! Add it to the peas. Cook for 10 more minutes.</p> </blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_K0c2hwcDfp class=p_ident id=p_K0c2hwcDfp></a>And this is the second recipe:</p> <blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_iNBZReprTd class=p_ident id=p_iNBZReprTd></a>Per person: 1 cup dried split peas, half a chopped onion, a stalk of celery, and a carrot.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_k5rI5P5p5u class=p_ident id=p_k5rI5P5p5u></a>Soak peas for 12 hours. Simmer for 2 hours in 4 cups of water (per person). Chop and add vegetables. Cook for 10 more minutes.</p> </blockquote> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_cSeY164LbX class=p_ident id=p_cSeY164LbX></a>The second is shorter and easier to interpret. But you do need to understand a few more cooking-related words such as <em>soak</em>, <em>simmer</em>, <em>chop</em>, and, I guess, <em>vegetable</em>.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_g/g3l7uyEG class=p_ident id=p_g/g3l7uyEG></a>When programming, we can’t rely on all the words we need to be waiting for us in the dictionary. Thus, we might fall into the pattern of the first recipe—work out the precise steps the computer has to perform, one by one, blind to the higher-level concepts that they express.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Hp26gkGVxA class=p_ident id=p_Hp26gkGVxA></a>It is a useful skill, in programming, to notice when you are working at too low a level of abstraction.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_8AV6kA9jcD class=h_ident id=h_8AV6kA9jcD></a>Abstracting repetition</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_kYV0l7wLUe class=p_ident id=p_kYV0l7wLUe></a>Plain functions, as we’ve seen them so far, are a good way to build abstractions. But sometimes they fall short.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_1v9Uha9PnV class=p_ident id=p_1v9Uha9PnV></a>It is common for a program to do something a given number of times. You can write a <code>for</code> loop for that, like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_5c+C2+9IG1 class=c_ident id=c_5c+C2+9IG1></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable>i</p> <p class=cm-operator>&lt;</p> <p class=cm-number>10</p>; <p class=cm-variable>i</p><p class=cm-operator>++</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>i</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_cNB+u+7TGa class=p_ident id=p_cNB+u+7TGa></a>Can we abstract “doing something <em>N</em> times” as a function? Well, it’s easy to write a function that calls <code>console.log</code> <em>N</em> times.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_/gKhlra9P+ class=c_ident id=c_/gKhlra9P+></a><p class=cm-keyword>function</p> <p class=cm-def>repeatLog</p>(<p class=cm-def>n</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>n</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>i</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_q8hNTrfIYb class=p_ident id=p_q8hNTrfIYb></a>But what if we want to do something other than logging the numbers? Since “doing something” can be represented as a function and functions are just values, we can pass our action as a function value.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_p03rPqGmn9 class=c_ident id=c_p03rPqGmn9></a><p class=cm-keyword>function</p> <p class=cm-def>repeat</p>(<p class=cm-def>n</p>, <p class=cm-def>action</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>n</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-variable-2>action</p>(<p class=cm-variable-2>i</p>); }\n} <p class=cm-variable>repeat</p>(<p class=cm-number>3</p>, <p class=cm-variable>console</p>.<p class=cm-property>log</p>);\n\n\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_zYjmzihkkN class=p_ident id=p_zYjmzihkkN></a>We don’t have to pass a predefined function to <code>repeat</code>. Often, it is easier to create a function value on the spot instead.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_EiK2Y8M/Mh class=c_ident id=c_EiK2Y8M/Mh></a><p class=cm-keyword>let</p> <p class=cm-def>labels</p> <p class=cm-operator>=</p> [];\n<p class=cm-variable>repeat</p>(<p class=cm-number>5</p>, <p class=cm-def>i</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>labels</p>.<p class=cm-property>push</p>(<p class=cm-string-2>`Unit ${</p><p class=cm-variable-2>i</p> <p class=cm-operator>+</p> <p class=cm-number>1</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n});\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>labels</p>);\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_iuDYWrtCLy class=p_ident id=p_iuDYWrtCLy></a>This is structured a little like a <code>for</code> loop—it first describes the kind of loop and then provides a body. However, the body is now written as a function value, which is wrapped in the parentheses of the call to <code>repeat</code>. This is why it has to be closed with the closing brace <em>and</em> closing parenthesis. In cases like this example, where the body is a single small expression, you could also omit the braces and write the loop on a single line.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_xxCc98lOBK class=h_ident id=h_xxCc98lOBK></a>Higher-order functions</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_cao2fH68Tj class=p_ident id=p_cao2fH68Tj></a>Functions that operate on other functions, either by taking them as arguments or by returning them, are called <em>higher-order functions</em>. Since we have already seen that functions are regular values, there is nothing particularly remarkable about the fact that such functions exist. The term comes from mathematics, where the distinction between functions and other values is taken more seriously.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_+cgNTV2i2y class=p_ident id=p_+cgNTV2i2y></a>Higher-order functions allow us to abstract over <em>actions</em>, not just values. They come in several forms. For example, we can have functions that create new functions.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_kHXugeV8Vn class=c_ident id=c_kHXugeV8Vn></a><p class=cm-keyword>function</p> <p class=cm-def>greaterThan</p>(<p class=cm-def>n</p>) { <p class=cm-keyword>return</p> <p class=cm-def>m</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>m</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>n</p>;\n}\n<p class=cm-keyword>let</p> <p class=cm-def>greaterThan10</p> <p class=cm-operator>=</p> <p class=cm-variable>greaterThan</p>(<p class=cm-number>10</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>greaterThan10</p>(<p class=cm-number>11</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Py4BnhS60O class=p_ident id=p_Py4BnhS60O></a>And we can have functions that change other functions.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_17dfYaooPK class=c_ident id=c_17dfYaooPK></a><p class=cm-keyword>function</p> <p class=cm-def>noisy</p>(<p class=cm-def>f</p>) { <p class=cm-keyword>return</p> (<p class=cm-def>args</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"calling with\"</p>, <p class=cm-variable-2>args</p>); <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-variable-2>f</p>(<p class=cm-variable-2>args</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"called with\"</p>, <p class=cm-variable-2>args</p>, <p class=cm-string>\", returned\"</p>, <p class=cm-variable-2>result</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>result</p>; };\n}\n<p class=cm-variable>noisy</p>(<p class=cm-variable>Math</p>.<p class=cm-property>min</p>)(<p class=cm-number>3</p>, <p class=cm-number>2</p>, <p class=cm-number>1</p>);\n\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_lObEs7dS9+ class=p_ident id=p_lObEs7dS9+></a>We can even write functions that provide new types of control flow.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_of6iH06dyE class=c_ident id=c_of6iH06dyE></a><p class=cm-keyword>function</p> <p class=cm-def>unless</p>(<p class=cm-def>test</p>, <p class=cm-def>then</p>) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>test</p>) <p class=cm-variable-2>then</p>();\n} <p class=cm-variable>repeat</p>(<p class=cm-number>3</p>, <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>unless</p>(<p class=cm-variable-2>n</p> <p class=cm-operator>%</p> <p class=cm-number>2</p> <p class=cm-operator>==</p> <p class=cm-number>1</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>n</p>, <p class=cm-string>\"is even\"</p>);\n  });\n});\n\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_/zKXdveDWD class=p_ident id=p_/zKXdveDWD></a>There is a built-in array method, <code>forEach</code>, that provides something like a <code>for</code>/<code>of</code> loop as a higher-order function.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_v9jL6NafRj class=c_ident id=c_v9jL6NafRj></a>[<p class=cm-string>\"A\"</p>, <p class=cm-string>\"B\"</p>].<p class=cm-property>forEach</p>(<p class=cm-def>l</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>l</p>));\n\n</pre> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_/SVokn16u9 class=h_ident id=h_/SVokn16u9></a>Script data set</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_t0gePcJ5To class=p_ident id=p_t0gePcJ5To></a>One area where higher-order functions shine is data processing. To process data, we’ll need some actual data. This chapter will use a data set about scripts—writing systems such as Latin, Cyrillic, or Arabic.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_1SGsVGpO8P class=p_ident id=p_1SGsVGpO8P></a>Remember Unicode from <a href=https://eloquentjavascript.net/01_values.html#unicode>Chapter 1</a>, the system that assigns a number to each character in written language? Most of these characters are associated with a specific script. The standard contains 140 different scripts—81 are still in use today, and 59 are historic.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_0ebPJMgh6D class=p_ident id=p_0ebPJMgh6D></a>Though I can fluently read only Latin characters, I appreciate the fact that people are writing texts in at least 80 other writing systems, many of which I wouldn’t even recognize. For example, here’s a sample of Tamil handwriting:</p><figure><img alt=\"Tamil handwriting\" src=https://eloquentjavascript.net/img/tamil.png></figure> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_RWVZnsc/dS class=p_ident id=p_RWVZnsc/dS></a>The example data set contains some pieces of information about the 140 scripts defined in Unicode. It is available in the <a href=https://eloquentjavascript.net/code#5>coding sandbox</a> for this chapter as the <code>SCRIPTS</code> binding. The binding contains an array of objects, each of which describes a script.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_YkfuyBG2fl class=c_ident id=c_YkfuyBG2fl></a>{ <p class=cm-property>name</p>: <p class=cm-string>\"Coptic\"</p>, <p class=cm-property>ranges</p>: [[<p class=cm-number>994</p>, <p class=cm-number>1008</p>], [<p class=cm-number>11392</p>, <p class=cm-number>11508</p>], [<p class=cm-number>11513</p>, <p class=cm-number>11520</p>]], <p class=cm-property>direction</p>: <p class=cm-string>\"ltr\"</p>, <p class=cm-property>year</p>: <p class=cm-operator>-</p><p class=cm-number>200</p>, <p class=cm-property>living</p>: <p class=cm-atom>false</p>, <p class=cm-property>link</p>: <p class=cm-string>\"https://en.wikipedia.org/wiki/Coptic_alphabet\"</p>\n}</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_rrPU5ybF5Y class=p_ident id=p_rrPU5ybF5Y></a>Such an object tells us the name of the script, the Unicode ranges assigned to it, the direction in which it is written, the (approximate) origin time, whether it is still in use, and a link to more information. The direction may be <code>\"ltr\"</code> for left to right, <code>\"rtl\"</code> for right to left (the way Arabic and Hebrew text are written), or <code>\"ttb\"</code> for top to bottom (as with Mongolian writing).</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_AvCZCbMsgs class=p_ident id=p_AvCZCbMsgs></a>The <code>ranges</code> property contains an array of Unicode character ranges, each of which is a two-element array containing a lower bound and an upper bound. Any character codes within these ranges are assigned to the script. The lower bound is inclusive (code 994 is a Coptic character), and the upper bound is non-inclusive (code 1008 isn’t).</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_MM7RF32uzF class=h_ident id=h_MM7RF32uzF></a>Filtering arrays</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Vpf83lHLbL class=p_ident id=p_Vpf83lHLbL></a>To find the scripts in the data set that are still in use, the following function might be helpful. It filters out the elements in an array that don’t pass a test.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_POEf7pMCk0 class=c_ident id=c_POEf7pMCk0></a><p class=cm-keyword>function</p> <p class=cm-def>filter</p>(<p class=cm-def>array</p>, <p class=cm-def>test</p>) { <p class=cm-keyword>let</p> <p class=cm-def>passed</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>element</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>array</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>test</p>(<p class=cm-variable-2>element</p>)) { <p class=cm-variable-2>passed</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>element</p>); } } <p class=cm-keyword>return</p> <p class=cm-variable-2>passed</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>filter</p>(<p class=cm-variable>SCRIPTS</p>, <p class=cm-def>script</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>script</p>.<p class=cm-property>living</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_tQlzCduFqI class=p_ident id=p_tQlzCduFqI></a>The function uses the argument named <code>test</code>, a function value, to fill a “gap” in the computation—the process of deciding which elements to collect.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_veimKHV5hF class=p_ident id=p_veimKHV5hF></a>Note how the <code>filter</code> function, rather than deleting elements from the existing array, builds up a new array with only the elements that pass the test. This function is <em>pure</em>. It does not modify the array it is given.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_nxWtg+vobY class=p_ident id=p_nxWtg+vobY></a>Like <code>forEach</code>, <code>filter</code> is a standard array method. The example defined the function only to show what it does internally. From now on, we’ll use it like this instead:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_x8e0PmGGB1 class=c_ident id=c_x8e0PmGGB1></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>SCRIPTS</p>.<p class=cm-property>filter</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>direction</p> <p class=cm-operator>==</p> <p class=cm-string>\"ttb\"</p>));\n</pre> <h2 id=map><a href=https://eloquentjavascript.net/05_higher_order.html#h_lJEtQ+qjXz class=h_ident id=h_lJEtQ+qjXz></a>Transforming with map</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_z7ZYMFMZh1 class=p_ident id=p_z7ZYMFMZh1></a>Say we have an array of objects representing scripts, produced by filtering the <code>SCRIPTS</code> array somehow. But we want an array of names, which is easier to inspect.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_6b1/g51xNK class=p_ident id=p_6b1/g51xNK></a>The <code>map</code> method transforms an array by applying a function to all of its elements and building a new array from the returned values. The new array will have the same length as the input array, but its content will have been <em>mapped</em> to a new form by the function.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_03caQcQElo class=c_ident id=c_03caQcQElo></a><p class=cm-keyword>function</p> <p class=cm-def>map</p>(<p class=cm-def>array</p>, <p class=cm-def>transform</p>) { <p class=cm-keyword>let</p> <p class=cm-def>mapped</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>element</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>array</p>) { <p class=cm-variable-2>mapped</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>transform</p>(<p class=cm-variable-2>element</p>)); } <p class=cm-keyword>return</p> <p class=cm-variable-2>mapped</p>;\n} <p class=cm-keyword>let</p> <p class=cm-def>rtlScripts</p> <p class=cm-operator>=</p> <p class=cm-variable>SCRIPTS</p>.<p class=cm-property>filter</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>direction</p> <p class=cm-operator>==</p> <p class=cm-string>\"rtl\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>map</p>(<p class=cm-variable>rtlScripts</p>, <p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>name</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_337o6zaWyY class=p_ident id=p_337o6zaWyY></a>Like <code>forEach</code> and <code>filter</code>, <code>map</code> is a standard array method.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_fx3e34kT/k class=h_ident id=h_fx3e34kT/k></a>Summarizing with reduce</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_QSyM/hwBKc class=p_ident id=p_QSyM/hwBKc></a>Another common thing to do with arrays is to compute a single value from them. Our recurring example, summing a collection of numbers, is an instance of this. Another example is finding the script with the most characters.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_AQTWjyAzxS class=p_ident id=p_AQTWjyAzxS></a>The higher-order operation that represents this pattern is called <em>reduce</em> (sometimes also called <em>fold</em>). It builds a value by repeatedly taking a single element from the array and combining it with the current value. When summing numbers, you’d start with the number zero and, for each element, add that to the sum.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_4TujL14aLE class=p_ident id=p_4TujL14aLE></a>The parameters to <code>reduce</code> are, apart from the array, a combining function and a start value. This function is a little less straightforward than <code>filter</code> and <code>map</code>, so take a close look at it:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_k5GDHjqpSc class=c_ident id=c_k5GDHjqpSc></a><p class=cm-keyword>function</p> <p class=cm-def>reduce</p>(<p class=cm-def>array</p>, <p class=cm-def>combine</p>, <p class=cm-def>start</p>) { <p class=cm-keyword>let</p> <p class=cm-def>current</p> <p class=cm-operator>=</p> <p class=cm-variable-2>start</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>element</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>array</p>) { <p class=cm-variable-2>current</p> <p class=cm-operator>=</p> <p class=cm-variable-2>combine</p>(<p class=cm-variable-2>current</p>, <p class=cm-variable-2>element</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>current</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>reduce</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>], (<p class=cm-def>a</p>, <p class=cm-def>b</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p> <p class=cm-operator>+</p> <p class=cm-variable-2>b</p>, <p class=cm-number>0</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_r9cFmJJTar class=p_ident id=p_r9cFmJJTar></a>The standard array method <code>reduce</code>, which of course corresponds to this function, has an added convenience. If your array contains at least one element, you are allowed to leave off the <code>start</code> argument. The method will take the first element of the array as its start value and start reducing at the second element.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_Dxn7muuMkk class=c_ident id=c_Dxn7muuMkk></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>].<p class=cm-property>reduce</p>((<p class=cm-def>a</p>, <p class=cm-def>b</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p> <p class=cm-operator>+</p> <p class=cm-variable-2>b</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_co+X+c08nc class=p_ident id=p_co+X+c08nc></a>To use <code>reduce</code> (twice) to find the script with the most characters, we can write something like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_x76Ukt5X+H class=c_ident id=c_x76Ukt5X+H></a><p class=cm-keyword>function</p> <p class=cm-def>characterCount</p>(<p class=cm-def>script</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>script</p>.<p class=cm-property>ranges</p>.<p class=cm-property>reduce</p>((<p class=cm-def>count</p>, [<p class=cm-def>from</p>, <p class=cm-def>to</p>]) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable-2>count</p> <p class=cm-operator>+</p> (<p class=cm-variable-2>to</p> <p class=cm-operator>-</p> <p class=cm-variable-2>from</p>); }, <p class=cm-number>0</p>);\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>SCRIPTS</p>.<p class=cm-property>reduce</p>((<p class=cm-def>a</p>, <p class=cm-def>b</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable>characterCount</p>(<p class=cm-variable-2>a</p>) <p class=cm-operator>&lt;</p> <p class=cm-variable>characterCount</p>(<p class=cm-variable-2>b</p>) <p class=cm-operator>?</p> <p class=cm-variable-2>b</p> : <p class=cm-variable-2>a</p>;\n}));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Zk/GcSOyra class=p_ident id=p_Zk/GcSOyra></a>The <code>characterCount</code> function reduces the ranges assigned to a script by summing their sizes. Note the use of destructuring in the parameter list of the reducer function. The second call to <code>reduce</code> then uses this to find the largest script by repeatedly comparing two scripts and returning the larger one.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_mdiQoTXDgm class=p_ident id=p_mdiQoTXDgm></a>The Han script has more than 89,000 characters assigned to it in the Unicode standard, making it by far the biggest writing system in the data set. Han is a script (sometimes) used for Chinese, Japanese, and Korean text. Those languages share a lot of characters, though they tend to write them differently. The (U.S.-based) Unicode Consortium decided to treat them as a single writing system to save character codes. This is called <em>Han unification</em> and still makes some people very angry.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_+NeFt8aXxf class=h_ident id=h_+NeFt8aXxf></a>Composability</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_6rxgOjYIEh class=p_ident id=p_6rxgOjYIEh></a>Consider how we would have written the previous example (finding the biggest script) without higher-order functions. The code is not that much worse.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_1FmIKHNB24 class=c_ident id=c_1FmIKHNB24></a><p class=cm-keyword>let</p> <p class=cm-def>biggest</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>;\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>script</p> <p class=cm-keyword>of</p> <p class=cm-variable>SCRIPTS</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>biggest</p> <p class=cm-operator>==</p> <p class=cm-atom>null</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable>characterCount</p>(<p class=cm-variable>biggest</p>) <p class=cm-operator>&lt;</p> <p class=cm-variable>characterCount</p>(<p class=cm-variable>script</p>)) { <p class=cm-variable>biggest</p> <p class=cm-operator>=</p> <p class=cm-variable>script</p>; }\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>biggest</p>);\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_rW1l2uIQYQ class=p_ident id=p_rW1l2uIQYQ></a>There are a few more bindings, and the program is four lines longer. But it is still very readable.</p> <p id=average_function><a href=https://eloquentjavascript.net/05_higher_order.html#p_a0FspsuDHF class=p_ident id=p_a0FspsuDHF></a>Higher-order functions start to shine when you need to <em>compose</em> operations. As an example, let’s write code that finds the average year of origin for living and dead scripts in the data set.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_rumPqbzokK class=c_ident id=c_rumPqbzokK></a><p class=cm-keyword>function</p> <p class=cm-def>average</p>(<p class=cm-def>array</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>array</p>.<p class=cm-property>reduce</p>((<p class=cm-def>a</p>, <p class=cm-def>b</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p> <p class=cm-operator>+</p> <p class=cm-variable-2>b</p>) <p class=cm-operator>/</p> <p class=cm-variable-2>array</p>.<p class=cm-property>length</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>round</p>(<p class=cm-variable>average</p>( <p class=cm-variable>SCRIPTS</p>.<p class=cm-property>filter</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>living</p>).<p class=cm-property>map</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>year</p>)))); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>round</p>(<p class=cm-variable>average</p>( <p class=cm-variable>SCRIPTS</p>.<p class=cm-property>filter</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-operator>!</p><p class=cm-variable-2>s</p>.<p class=cm-property>living</p>).<p class=cm-property>map</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>year</p>))));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_SoxeEh7KKJ class=p_ident id=p_SoxeEh7KKJ></a>So the dead scripts in Unicode are, on average, older than the living ones. This is not a terribly meaningful or surprising statistic. But I hope you’ll agree that the code used to compute it isn’t hard to read. You can see it as a pipeline: we start with all scripts, filter out the living (or dead) ones, take the years from those, average them, and round the result.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_FNSiaZ2hBC class=p_ident id=p_FNSiaZ2hBC></a>You could definitely also write this computation as one big loop.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_noyYOD0Kiy class=c_ident id=c_noyYOD0Kiy></a><p class=cm-keyword>let</p> <p class=cm-def>total</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>, <p class=cm-def>count</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>;\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>script</p> <p class=cm-keyword>of</p> <p class=cm-variable>SCRIPTS</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>script</p>.<p class=cm-property>living</p>) { <p class=cm-variable>total</p> <p class=cm-operator>+=</p> <p class=cm-variable>script</p>.<p class=cm-property>year</p>; <p class=cm-variable>count</p> <p class=cm-operator>+=</p> <p class=cm-number>1</p>; }\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>round</p>(<p class=cm-variable>total</p> <p class=cm-operator>/</p> <p class=cm-variable>count</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_yjuOvdnLHf class=p_ident id=p_yjuOvdnLHf></a>But it is harder to see what was being computed and how. And because intermediate results aren’t represented as coherent values, it’d be a lot more work to extract something like <code>average</code> into a separate function.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_CiGDWoU0I9 class=p_ident id=p_CiGDWoU0I9></a>In terms of what the computer is actually doing, these two approaches are also quite different. The first will build up new arrays when running <code>filter</code> and <code>map</code>, whereas the second computes only some numbers, doing less work. You can usually afford the readable approach, but if you’re processing huge arrays, and doing so many times, the less abstract style might be worth the extra speed.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_gQf5HZNGpM class=h_ident id=h_gQf5HZNGpM></a>Strings and character codes</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_CbVTXgjOFe class=p_ident id=p_CbVTXgjOFe></a>One use of the data set would be figuring out what script a piece of text is using. Let’s go through a program that does this.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_aEEZgRpp75 class=p_ident id=p_aEEZgRpp75></a>Remember that each script has an array of character code ranges associated with it. So given a character code, we could use a function like this to find the corresponding script (if any):</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_Q8918ecfHn class=c_ident id=c_Q8918ecfHn></a><p class=cm-keyword>function</p> <p class=cm-def>characterScript</p>(<p class=cm-def>code</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>script</p> <p class=cm-keyword>of</p> <p class=cm-variable>SCRIPTS</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>script</p>.<p class=cm-property>ranges</p>.<p class=cm-property>some</p>(([<p class=cm-def>from</p>, <p class=cm-def>to</p>]) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable-2>code</p> <p class=cm-operator>&gt;=</p> <p class=cm-variable-2>from</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>code</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>to</p>; })) { <p class=cm-keyword>return</p> <p class=cm-variable-2>script</p>; } } <p class=cm-keyword>return</p> <p class=cm-atom>null</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>characterScript</p>(<p class=cm-number>121</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_j3Y+wD1N4H class=p_ident id=p_j3Y+wD1N4H></a>The <code>some</code> method is another higher-order function. It takes a test function and tells you whether that function returns true for any of the elements in the array.</p> <p id=code_units><a href=https://eloquentjavascript.net/05_higher_order.html#p_NZ3lS1jnJX class=p_ident id=p_NZ3lS1jnJX></a>But how do we get the character codes in a string?</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_UsDhhqR3EH class=p_ident id=p_UsDhhqR3EH></a>In <a href=https://eloquentjavascript.net/01_values.html>Chapter 1</a> I mentioned that JavaScript strings are encoded as a sequence of 16-bit numbers. These are called <em>code units</em>. A Unicode character code was initially supposed to fit within such a unit (which gives you a little over 65,000 characters). When it became clear that wasn’t going to be enough, many people balked at the need to use more memory per character. To address these concerns, UTF-16, the format used by JavaScript strings, was invented. It describes most common characters using a single 16-bit code unit but uses a pair of two such units for others.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_VWL7aDQvAS class=p_ident id=p_VWL7aDQvAS></a>UTF-16 is generally considered a bad idea today. It seems almost intentionally designed to invite mistakes. It’s easy to write programs that pretend code units and characters are the same thing. And if your language doesn’t use two-unit characters, that will appear to work just fine. But as soon as someone tries to use such a program with some less common Chinese characters, it breaks. Fortunately, with the advent of emoji, everybody has started using two-unit characters, and the burden of dealing with such problems is more fairly distributed.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_iQl/Gok4Mf class=p_ident id=p_iQl/Gok4Mf></a>Unfortunately, obvious operations on JavaScript strings, such as getting their length through the <code>length</code> property and accessing their content using square brackets, deal only with code units.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_50Oes+9anA class=c_ident id=c_50Oes+9anA></a>\n<p class=cm-keyword>let</p> <p class=cm-def>horseShoe</p> <p class=cm-operator>=</p> <p class=cm-string>\"🐴👟\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>horseShoe</p>.<p class=cm-property>length</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>horseShoe</p>[<p class=cm-number>0</p>]); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>horseShoe</p>.<p class=cm-property>charCodeAt</p>(<p class=cm-number>0</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>horseShoe</p>.<p class=cm-property>codePointAt</p>(<p class=cm-number>0</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_whNOOL2UUI class=p_ident id=p_whNOOL2UUI></a>JavaScript’s <code>charCodeAt</code> method gives you a code unit, not a full character code. The <code>codePointAt</code> method, added later, does give a full Unicode character. So we could use that to get characters from a string. But the argument passed to <code>codePointAt</code> is still an index into the sequence of code units. So to run over all characters in a string, we’d still need to deal with the question of whether a character takes up one or two code units.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_AEbxGojOu6 class=p_ident id=p_AEbxGojOu6></a>In the <a href=https://eloquentjavascript.net/04_data.html#for_of_loop>previous chapter</a>, I mentioned that a <code>for</code>/<code>of</code> loop can also be used on strings. Like <code>codePointAt</code>, this type of loop was introduced at a time where people were acutely aware of the problems with UTF-16. When you use it to loop over a string, it gives you real characters, not code units.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_9QIfA1qjtG class=c_ident id=c_9QIfA1qjtG></a><p class=cm-keyword>let</p> <p class=cm-def>roseDragon</p> <p class=cm-operator>=</p> <p class=cm-string>\"🌹🐉\"</p>;\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>char</p> <p class=cm-keyword>of</p> <p class=cm-variable>roseDragon</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>char</p>);\n}\n\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_1lRKu8d5oS class=p_ident id=p_1lRKu8d5oS></a>If you have a character (which will be a string of one or two code units), you can use <code>codePointAt(0)</code> to get its code.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_qYzPQMwIvv class=h_ident id=h_qYzPQMwIvv></a>Recognizing text</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_tzTGijMwow class=p_ident id=p_tzTGijMwow></a>We have a <code>characterScript</code> function and a way to correctly loop over characters. The next step is to count the characters that belong to each script. The following counting abstraction will be useful there:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_nau/OQcf6J class=c_ident id=c_nau/OQcf6J></a><p class=cm-keyword>function</p> <p class=cm-def>countBy</p>(<p class=cm-def>items</p>, <p class=cm-def>groupName</p>) { <p class=cm-keyword>let</p> <p class=cm-def>counts</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>item</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>items</p>) { <p class=cm-keyword>let</p> <p class=cm-def>name</p> <p class=cm-operator>=</p> <p class=cm-variable-2>groupName</p>(<p class=cm-variable-2>item</p>); <p class=cm-keyword>let</p> <p class=cm-def>known</p> <p class=cm-operator>=</p> <p class=cm-variable-2>counts</p>.<p class=cm-property>findIndex</p>(<p class=cm-def>c</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>c</p>.<p class=cm-property>name</p> <p class=cm-operator>==</p> <p class=cm-variable-2>name</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>known</p> <p class=cm-operator>==</p> <p class=cm-operator>-</p><p class=cm-number>1</p>) { <p class=cm-variable-2>counts</p>.<p class=cm-property>push</p>({<p class=cm-property>name</p>, <p class=cm-property>count</p>: <p class=cm-number>1</p>}); } <p class=cm-keyword>else</p> { <p class=cm-variable-2>counts</p>[<p class=cm-variable-2>known</p>].<p class=cm-property>count</p><p class=cm-operator>++</p>; } } <p class=cm-keyword>return</p> <p class=cm-variable-2>counts</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>countBy</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>, <p class=cm-number>5</p>], <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>&gt;</p> <p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_XJKbcULdUw class=p_ident id=p_XJKbcULdUw></a>The <code>countBy</code> function expects a collection (anything that we can loop over with <code>for</code>/<code>of</code>) and a function that computes a group name for a given element. It returns an array of objects, each of which names a group and tells you the number of elements that were found in that group.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_YjH+mbwxM+ class=p_ident id=p_YjH+mbwxM+></a>It uses another array method—<code>findIndex</code>. This method is somewhat like <code>indexOf</code>, but instead of looking for a specific value, it finds the first value for which the given function returns true. Like <code>indexOf</code>, it returns -1 when no such element is found.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_T2D/Ix5YaM class=p_ident id=p_T2D/Ix5YaM></a>Using <code>countBy</code>, we can write the function that tells us which scripts are used in a piece of text.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_TyAeKAD0HB class=c_ident id=c_TyAeKAD0HB></a><p class=cm-keyword>function</p> <p class=cm-def>textScripts</p>(<p class=cm-def>text</p>) { <p class=cm-keyword>let</p> <p class=cm-def>scripts</p> <p class=cm-operator>=</p> <p class=cm-variable>countBy</p>(<p class=cm-variable-2>text</p>, <p class=cm-def>char</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>script</p> <p class=cm-operator>=</p> <p class=cm-variable>characterScript</p>(<p class=cm-variable-2>char</p>.<p class=cm-property>codePointAt</p>(<p class=cm-number>0</p>)); <p class=cm-keyword>return</p> <p class=cm-variable-2>script</p> <p class=cm-operator>?</p> <p class=cm-variable-2>script</p>.<p class=cm-property>name</p> : <p class=cm-string>\"none\"</p>; }).<p class=cm-property>filter</p>(({<p class=cm-def>name</p>}) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>name</p> <p class=cm-operator>!=</p> <p class=cm-string>\"none\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>total</p> <p class=cm-operator>=</p> <p class=cm-variable-2>scripts</p>.<p class=cm-property>reduce</p>((<p class=cm-def>n</p>, {<p class=cm-def>count</p>}) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>+</p> <p class=cm-variable-2>count</p>, <p class=cm-number>0</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>total</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"No scripts found\"</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>scripts</p>.<p class=cm-property>map</p>(({<p class=cm-def>name</p>, <p class=cm-def>count</p>}) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-string-2>`${</p><p class=cm-variable>Math</p>.<p class=cm-property>round</p>(<p class=cm-variable-2>count</p> <p class=cm-operator>*</p> <p class=cm-number>100</p> <p class=cm-operator>/</p> <p class=cm-variable-2>total</p>)<p class=cm-string-2>}</p><p class=cm-string-2>% ${</p><p class=cm-variable-2>name</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>; }).<p class=cm-property>join</p>(<p class=cm-string>\", \"</p>);\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>textScripts</p>(<p class=cm-string>'英国的狗说\"woof\", 俄罗斯的狗说\"тяв\"'</p>));\n</pre> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_ydjmkrkJ8Y class=p_ident id=p_ydjmkrkJ8Y></a>The function first counts the characters by name, using <code>characterScript</code> to assign them a name and falling back to the string <code>\"none\"</code> for characters that aren’t part of any script. The <code>filter</code> call drops the entry for <code>\"none\"</code> from the resulting array since we aren’t interested in those characters.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_avwH1AKErw class=p_ident id=p_avwH1AKErw></a>To be able to compute percentages, we first need the total number of characters that belong to a script, which we can compute with <code>reduce</code>. If no such characters are found, the function returns a specific string. Otherwise, it transforms the counting entries into readable strings with <code>map</code> and then combines them with <code>join</code>.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_N6wo+JYLCW class=p_ident id=p_N6wo+JYLCW></a>Being able to pass function values to other functions is a deeply useful aspect of JavaScript. It allows us to write functions that model computations with “gaps” in them. The code that calls these functions can fill in the gaps by providing function values.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_pZzOMOrxaO class=p_ident id=p_pZzOMOrxaO></a>Arrays provide a number of useful higher-order methods. You can use <code>forEach</code> to loop over the elements in an array. The <code>filter</code> method returns a new array containing only the elements that pass the predicate function. Transforming an array by putting each element through a function is done with <code>map</code>. You can use <code>reduce</code> to combine all the elements in an array into a single value. The <code>some</code> method tests whether any element matches a given predicate function. And <code>findIndex</code> finds the position of the first element that matches a predicate.</p> <h2><a href=https://eloquentjavascript.net/05_higher_order.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/05_higher_order.html#i_aIOczlLyX1 class=i_ident id=i_aIOczlLyX1></a>Flattening</h3> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_6CVUmjaoYw class=p_ident id=p_6CVUmjaoYw></a>Use the <code>reduce</code> method in combination with the <code>concat</code> method to “flatten” an array of arrays into a single array that has all the elements of the original arrays.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_I+o+qLGLXB class=c_ident id=c_I+o+qLGLXB></a><p class=cm-keyword>let</p> <p class=cm-def>arrays</p> <p class=cm-operator>=</p> [[<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>], [<p class=cm-number>4</p>, <p class=cm-number>5</p>], [<p class=cm-number>6</p>]];\n\n</pre> <h3><a href=https://eloquentjavascript.net/05_higher_order.html#i_gKQ1S54F4o class=i_ident id=i_gKQ1S54F4o></a>Your own loop</h3> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_LWMRzXlJIe class=p_ident id=p_LWMRzXlJIe></a>Write a higher-order function <code>loop</code> that provides something like a <code>for</code> loop statement. It takes a value, a test function, an update function, and a body function. Each iteration, it first runs the test function on the current loop value and stops if that returns false. Then it calls the body function, giving it the current value. Finally, it calls the update function to create a new value and starts from the beginning.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_S48JjGYRAU class=p_ident id=p_S48JjGYRAU></a>When defining the function, you can use a regular loop to do the actual looping.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_Fv1rc97GEM class=c_ident id=c_Fv1rc97GEM></a> <p class=cm-variable>loop</p>(<p class=cm-number>3</p>, <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>, <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>, <p class=cm-variable>console</p>.<p class=cm-property>log</p>);\n\n\n</pre> <h3><a href=https://eloquentjavascript.net/05_higher_order.html#i_SmbRSAd5GA class=i_ident id=i_SmbRSAd5GA></a>Everything</h3> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_/J/AO4UyLj class=p_ident id=p_/J/AO4UyLj></a>Analogous to the <code>some</code> method, arrays also have an <code>every</code> method. This one returns true when the given function returns true for <em>every</em> element in the array. In a way, <code>some</code> is a version of the <code>||</code> operator that acts on arrays, and <code>every</code> is like the <code>&amp;&amp;</code> operator.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_myqdLDWQWl class=p_ident id=p_myqdLDWQWl></a>Implement <code>every</code> as a function that takes an array and a predicate function as parameters. Write two versions, one using a loop and one using the <code>some</code> method.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_NludaTWDls class=c_ident id=c_NludaTWDls></a><p class=cm-keyword>function</p> <p class=cm-def>every</p>(<p class=cm-def>array</p>, <p class=cm-def>test</p>) { } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>every</p>([<p class=cm-number>1</p>, <p class=cm-number>3</p>, <p class=cm-number>5</p>], <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>&lt;</p> <p class=cm-number>10</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>every</p>([<p class=cm-number>2</p>, <p class=cm-number>4</p>, <p class=cm-number>16</p>], <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>&lt;</p> <p class=cm-number>10</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>every</p>([], <p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>&lt;</p> <p class=cm-number>10</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_1QG7tGMA79 class=p_ident id=p_1QG7tGMA79></a>Like the <code>&amp;&amp;</code> operator, the <code>every</code> method can stop evaluating further elements as soon as it has found one that doesn’t match. So the loop-based version can jump out of the loop—with <code>break</code> or <code>return</code>—as soon as it runs into an element for which the predicate function returns false. If the loop runs to its end without finding such an element, we know that all elements matched and we should return true.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Ox5LquJ8IQ class=p_ident id=p_Ox5LquJ8IQ></a>To build <code>every</code> on top of <code>some</code>, we can apply <em>De Morgan’s laws</em>, which state that <code>a &amp;&amp; b</code> equals <code>!(!a || !b)</code>. This can be generalized to arrays, where all elements in the array match if there is no element in the array that does not match.</p> </div></div> <h3><a href=https://eloquentjavascript.net/05_higher_order.html#i_4ccl4J1nOw class=i_ident id=i_4ccl4J1nOw></a>Dominant writing direction</h3> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_9kMfnY4I1g class=p_ident id=p_9kMfnY4I1g></a>Write a function that computes the dominant writing direction in a string of text. Remember that each script object has a <code>direction</code> property that can be <code>\"ltr\"</code> (left to right), <code>\"rtl\"</code> (right to left), or <code>\"ttb\"</code> (top to bottom).</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_WGH1oH+EyU class=p_ident id=p_WGH1oH+EyU></a>The dominant direction is the direction of a majority of the characters that have a script associated with them. The <code>characterScript</code> and <code>countBy</code> functions defined earlier in the chapter are probably useful here.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/05_higher_order.html#c_CNawUvyti3 class=c_ident id=c_CNawUvyti3></a><p class=cm-keyword>function</p> <p class=cm-def>dominantDirection</p>(<p class=cm-def>text</p>) { } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dominantDirection</p>(<p class=cm-string>\"Hello!\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dominantDirection</p>(<p class=cm-string>\"Hey, مساء الخير\"</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_Z2nEY1sOaH class=p_ident id=p_Z2nEY1sOaH></a>Your solution might look a lot like the first half of the <code>textScripts</code> example. You again have to count characters by a criterion based on <code>characterScript</code> and then filter out the part of the result that refers to uninteresting (script-less) characters.</p> <p><a href=https://eloquentjavascript.net/05_higher_order.html#p_1yNhVH0QH9 class=p_ident id=p_1yNhVH0QH9></a>Finding the direction with the highest character count can be done with <code>reduce</code>. If it’s not clear how, refer to the example earlier in the chapter, where <code>reduce</code> was used to find the script with the most characters.</p> </div></div><nav><a href=https://eloquentjavascript.net/04_data.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/06_object.html>▶</a></nav>\n</article><hr><h4>Page 2</h4><article score=852.6399999999996>\n<nav><a href=https://eloquentjavascript.net/05_higher_order.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/07_robot.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/06_object.html#p_gDFRhOpA5B class=p_ident id=p_gDFRhOpA5B></a>An abstract data type is realized by writing a special kind of program […] which defines the type in terms of the operations which can be performed on it.</p> <footer>Barbara Liskov, <cite>Programming with Abstract Data Types</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a rabbit with its proto-rabbit\" src=https://eloquentjavascript.net/img/chapter_picture_6.jpg></figure> <p><a href=https://eloquentjavascript.net/06_object.html#p_KkunxYMaeO class=p_ident id=p_KkunxYMaeO></a><a href=https://eloquentjavascript.net/04_data.html>Chapter 4</a> introduced JavaScript’s objects. In programming culture, we have a thing called <em>object-oriented programming</em>, a set of techniques that use objects (and related concepts) as the central principle of program organization.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_iS8mjYhuYY class=p_ident id=p_iS8mjYhuYY></a>Though no one really agrees on its precise definition, object-oriented programming has shaped the design of many programming languages, including JavaScript. This chapter will describe the way these ideas can be applied in JavaScript.</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_hn18MBjoh2 class=h_ident id=h_hn18MBjoh2></a>Encapsulation</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_76wqEvwMj/ class=p_ident id=p_76wqEvwMj/ ></a>The core idea in object-oriented programming is to divide programs into smaller pieces and make each piece responsible for managing its own state.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_Ww3ymqEfW3 class=p_ident id=p_Ww3ymqEfW3></a>This way, some knowledge about the way a piece of the program works can be kept <em>local</em> to that piece. Someone working on the rest of the program does not have to remember or even be aware of that knowledge. Whenever these local details change, only the code directly around it needs to be updated.</p> <p id=interface><a href=https://eloquentjavascript.net/06_object.html#p_m1XIFUcUIg class=p_ident id=p_m1XIFUcUIg></a>Different pieces of such a program interact with each other through <em>interfaces</em>, limited sets of functions or bindings that provide useful functionality at a more abstract level, hiding their precise implementation.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_n3o8Ctd3cn class=p_ident id=p_n3o8Ctd3cn></a>Such program pieces are modeled using objects. Their interface consists of a specific set of methods and properties. Properties that are part of the interface are called <em>public</em>. The others, which outside code should not be touching, are called <em>private</em>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_RExXHtzJn1 class=p_ident id=p_RExXHtzJn1></a>Many languages provide a way to distinguish public and private properties and prevent outside code from accessing the private ones altogether. JavaScript, once again taking the minimalist approach, does not—not yet at least. There is work underway to add this to the language.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_h9lEzfGlTT class=p_ident id=p_h9lEzfGlTT></a>Even though the language doesn’t have this distinction built in, JavaScript programmers <em>are</em> successfully using this idea. Typically, the available interface is described in documentation or comments. It is also common to put an underscore (<code>_</code>) character at the start of property names to indicate that those properties are private.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_ysFjuxKxY0 class=p_ident id=p_ysFjuxKxY0></a>Separating interface from implementation is a great idea. It is usually called <em>encapsulation</em>.</p> <h2 id=obj_methods><a href=https://eloquentjavascript.net/06_object.html#h_fkrGgDyRWc class=h_ident id=h_fkrGgDyRWc></a>Methods</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_DKj01h8Gzf class=p_ident id=p_DKj01h8Gzf></a>Methods are nothing more than properties that hold function values. This is a simple method:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_BYfVVcFY2P class=c_ident id=c_BYfVVcFY2P></a><p class=cm-keyword>let</p> <p class=cm-def>rabbit</p> <p class=cm-operator>=</p> {};\n<p class=cm-variable>rabbit</p>.<p class=cm-property>speak</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>line</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The rabbit says '${</p><p class=cm-variable-2>line</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>);\n}; <p class=cm-variable>rabbit</p>.<p class=cm-property>speak</p>(<p class=cm-string>\"I'm alive.\"</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_N+6e0UGvFo class=p_ident id=p_N+6e0UGvFo></a>Usually a method needs to do something with the object it was called on. When a function is called as a method—looked up as a property and immediately called, as in <code>object.method()</code>—the binding called <code>this</code> in its body automatically points at the object that it was called on.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_cXuIwPt+3C class=c_ident id=c_cXuIwPt+3C></a><p class=cm-keyword>function</p> <p class=cm-def>speak</p>(<p class=cm-def>line</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The ${</p><p class=cm-keyword>this</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p> <p class=cm-string-2>rabbit says '${</p><p class=cm-variable-2>line</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>);\n}\n<p class=cm-keyword>let</p> <p class=cm-def>whiteRabbit</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"white\"</p>, <p class=cm-property>speak</p>};\n<p class=cm-keyword>let</p> <p class=cm-def>hungryRabbit</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"hungry\"</p>, <p class=cm-property>speak</p>}; <p class=cm-variable>whiteRabbit</p>.<p class=cm-property>speak</p>(<p class=cm-string>\"Oh my ears and whiskers, \"</p> <p class=cm-operator>+</p> <p class=cm-string>\"how late it's getting!\"</p>); <p class=cm-variable>hungryRabbit</p>.<p class=cm-property>speak</p>(<p class=cm-string>\"I could use a carrot right now.\"</p>);\n</pre> <p id=call_method><a href=https://eloquentjavascript.net/06_object.html#p_llBwR5t6LB class=p_ident id=p_llBwR5t6LB></a>You can think of <code>this</code> as an extra parameter that is passed in a different way. If you want to pass it explicitly, you can use a function’s <code>call</code> method, which takes the <code>this</code> value as its first argument and treats further arguments as normal parameters.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_9lDr0S2nEw class=c_ident id=c_9lDr0S2nEw></a><p class=cm-variable>speak</p>.<p class=cm-property>call</p>(<p class=cm-variable>hungryRabbit</p>, <p class=cm-string>\"Burp!\"</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_8ZeOAlGKXe class=p_ident id=p_8ZeOAlGKXe></a>Since each function has its own <code>this</code> binding, whose value depends on the way it is called, you cannot refer to the <code>this</code> of the wrapping scope in a regular function defined with the <code>function</code> keyword.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_C4AqzW0fAV class=p_ident id=p_C4AqzW0fAV></a>Arrow functions are different—they do not bind their own <code>this</code> but can see the <code>this</code> binding of the scope around them. Thus, you can do something like the following code, which references <code>this</code> from inside a local function:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_wg++tcauWw class=c_ident id=c_wg++tcauWw></a><p class=cm-keyword>function</p> <p class=cm-def>normalize</p>() { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>this</p>.<p class=cm-property>coords</p>.<p class=cm-property>map</p>(<p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>/</p> <p class=cm-keyword>this</p>.<p class=cm-property>length</p>));\n}\n<p class=cm-variable>normalize</p>.<p class=cm-property>call</p>({<p class=cm-property>coords</p>: [<p class=cm-number>0</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>], <p class=cm-property>length</p>: <p class=cm-number>5</p>});\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_YkWiHcMuVP class=p_ident id=p_YkWiHcMuVP></a>If I had written the argument to <code>map</code> using the <code>function</code> keyword, the code wouldn’t work.</p> <h2 id=prototypes><a href=https://eloquentjavascript.net/06_object.html#h_SumMlRB7yn class=h_ident id=h_SumMlRB7yn></a>Prototypes</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_hi1TWnD/2p class=p_ident id=p_hi1TWnD/2p></a>Watch closely.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_P0GVdA5c8J class=c_ident id=c_P0GVdA5c8J></a><p class=cm-keyword>let</p> <p class=cm-def>empty</p> <p class=cm-operator>=</p> {};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>empty</p>.<p class=cm-property>toString</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>empty</p>.<p class=cm-property>toString</p>());\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_NUxqIXvg/G class=p_ident id=p_NUxqIXvg/G></a>I pulled a property out of an empty object. Magic!</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_bJubL+gx0p class=p_ident id=p_bJubL+gx0p></a>Well, not really. I have simply been withholding information about the way JavaScript objects work. In addition to their set of properties, most objects also have a <em>prototype</em>. A prototype is another object that is used as a fallback source of properties. When an object gets a request for a property that it does not have, its prototype will be searched for the property, then the prototype’s prototype, and so on.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_XPuG8mFwbT class=p_ident id=p_XPuG8mFwbT></a>So who is the prototype of that empty object? It is the great ancestral prototype, the entity behind almost all objects, <code>Object.prototype</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_7Q/HaNra3M class=c_ident id=c_7Q/HaNra3M></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>({}) <p class=cm-operator>==</p> <p class=cm-variable>Object</p>.<p class=cm-property>prototype</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>(<p class=cm-variable>Object</p>.<p class=cm-property>prototype</p>));\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_GfVMu4b4D+ class=p_ident id=p_GfVMu4b4D+></a>As you guess, <code>Object.<wbr>getPrototypeOf</code> returns the prototype of an object.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_4S0XbM8aBm class=p_ident id=p_4S0XbM8aBm></a>The prototype relations of JavaScript objects form a tree-shaped structure, and at the root of this structure sits <code>Object.prototype</code>. It provides a few methods that show up in all objects, such as <code>toString</code>, which converts an object to a string representation.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_j+MLWf3JXr class=p_ident id=p_j+MLWf3JXr></a>Many objects don’t directly have <code>Object.prototype</code> as their prototype but instead have another object that provides a different set of default properties. Functions derive from <code>Function.<wbr>prototype</code>, and arrays derive from <code>Array.prototype</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_NgntUaXZ1S class=c_ident id=c_NgntUaXZ1S></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>(<p class=cm-variable>Math</p>.<p class=cm-property>max</p>) <p class=cm-operator>==</p> <p class=cm-variable>Function</p>.<p class=cm-property>prototype</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>([]) <p class=cm-operator>==</p> <p class=cm-variable>Array</p>.<p class=cm-property>prototype</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_1fIXMD62Nu class=p_ident id=p_1fIXMD62Nu></a>Such a prototype object will itself have a prototype, often <code>Object.prototype</code>, so that it still indirectly provides methods like <code>toString</code>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_H2XhzSHHJP class=p_ident id=p_H2XhzSHHJP></a>You can use <code>Object.create</code> to create an object with a specific prototype.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_gSGrvGTpkW class=c_ident id=c_gSGrvGTpkW></a><p class=cm-keyword>let</p> <p class=cm-def>protoRabbit</p> <p class=cm-operator>=</p> { <p class=cm-property>speak</p>(<p class=cm-def>line</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The ${</p><p class=cm-keyword>this</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p> <p class=cm-string-2>rabbit says '${</p><p class=cm-variable-2>line</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>); }\n};\n<p class=cm-keyword>let</p> <p class=cm-def>killerRabbit</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-variable>protoRabbit</p>);\n<p class=cm-variable>killerRabbit</p>.<p class=cm-property>type</p> <p class=cm-operator>=</p> <p class=cm-string>\"killer\"</p>;\n<p class=cm-variable>killerRabbit</p>.<p class=cm-property>speak</p>(<p class=cm-string>\"SKREEEE!\"</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_eBm7AuQUBb class=p_ident id=p_eBm7AuQUBb></a>A property like <code>speak(line)</code> in an object expression is a shorthand way of defining a method. It creates a property called <code>speak</code> and gives it a function as its value.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_y8kzFoQw1W class=p_ident id=p_y8kzFoQw1W></a>The “proto” rabbit acts as a container for the properties that are shared by all rabbits. An individual rabbit object, like the killer rabbit, contains properties that apply only to itself—in this case its type—and derives shared properties from its prototype.</p> <h2 id=classes><a href=https://eloquentjavascript.net/06_object.html#h_7RhGr+474h class=h_ident id=h_7RhGr+474h></a>Classes</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_iYbDLfqSFW class=p_ident id=p_iYbDLfqSFW></a>JavaScript’s prototype system can be interpreted as a somewhat informal take on an object-oriented concept called <em>classes</em>. A class defines the shape of a type of object—what methods and properties it has. Such an object is called an <em>instance</em> of the class.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_GhnffIpINq class=p_ident id=p_GhnffIpINq></a>Prototypes are useful for defining properties for which all instances of a class share the same value, such as methods. Properties that differ per instance, such as our rabbits’ <code>type</code> property, need to be stored directly in the objects themselves.</p> <p id=constructors><a href=https://eloquentjavascript.net/06_object.html#p_hflVCtYTKN class=p_ident id=p_hflVCtYTKN></a>So to create an instance of a given class, you have to make an object that derives from the proper prototype, but you <em>also</em> have to make sure it, itself, has the properties that instances of this class are supposed to have. This is what a <em>constructor</em> function does.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_oOKUeIzSVa class=c_ident id=c_oOKUeIzSVa></a><p class=cm-keyword>function</p> <p class=cm-def>makeRabbit</p>(<p class=cm-def>type</p>) { <p class=cm-keyword>let</p> <p class=cm-def>rabbit</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-variable>protoRabbit</p>); <p class=cm-variable-2>rabbit</p>.<p class=cm-property>type</p> <p class=cm-operator>=</p> <p class=cm-variable-2>type</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>rabbit</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_j8irpNziDb class=p_ident id=p_j8irpNziDb></a>JavaScript provides a way to make defining this type of function easier. If you put the keyword <code>new</code> in front of a function call, the function is treated as a constructor. This means that an object with the right prototype is automatically created, bound to <code>this</code> in the function, and returned at the end of the function.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_svyxVljkeg class=p_ident id=p_svyxVljkeg></a>The prototype object used when constructing objects is found by taking the <code>prototype</code> property of the constructor function.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_p+u3OtMv8K class=c_ident id=c_p+u3OtMv8K></a><p class=cm-keyword>function</p> <p class=cm-def>Rabbit</p>(<p class=cm-def>type</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>type</p> <p class=cm-operator>=</p> <p class=cm-variable-2>type</p>;\n}\n<p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>.<p class=cm-property>speak</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>line</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The ${</p><p class=cm-keyword>this</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p> <p class=cm-string-2>rabbit says '${</p><p class=cm-variable-2>line</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>);\n}; <p class=cm-keyword>let</p> <p class=cm-def>weirdRabbit</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Rabbit</p>(<p class=cm-string>\"weird\"</p>);</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_IZA8w6crnz class=p_ident id=p_IZA8w6crnz></a>Constructors (all functions, in fact) automatically get a property named <code>prototype</code>, which by default holds a plain, empty object that derives from <code>Object.prototype</code>. You can overwrite it with a new object if you want. Or you can add properties to the existing object, as the example does.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_DJG7BO1oTU class=p_ident id=p_DJG7BO1oTU></a>By convention, the names of constructors are capitalized so that they can easily be distinguished from other functions.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_9bg1buEAma class=p_ident id=p_9bg1buEAma></a>It is important to understand the distinction between the way a prototype is associated with a constructor (through its <code>prototype</code> property) and the way objects <em>have</em> a prototype (which can be found with <code>Object.<wbr>getPrototypeOf</code>). The actual prototype of a constructor is <code>Function.<wbr>prototype</code> since constructors are functions. Its <code>prototype</code> <em>property</em> holds the prototype used for instances created through it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_KDYP9dCWfS class=c_ident id=c_KDYP9dCWfS></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>(<p class=cm-variable>Rabbit</p>) <p class=cm-operator>==</p> <p class=cm-variable>Function</p>.<p class=cm-property>prototype</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>getPrototypeOf</p>(<p class=cm-variable>weirdRabbit</p>) <p class=cm-operator>==</p> <p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>);\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_hPv1gHC33s class=h_ident id=h_hPv1gHC33s></a>Class notation</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_T5Ghz5me/w class=p_ident id=p_T5Ghz5me/w></a>So JavaScript classes are constructor functions with a prototype property. That is how they work, and until 2015, that was how you had to write them. These days, we have a less awkward notation.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_kqKA+SZ6vS class=c_ident id=c_kqKA+SZ6vS></a><p class=cm-keyword>class</p> <p class=cm-def>Rabbit</p> { <p class=cm-property>constructor</p>(<p class=cm-def>type</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>type</p> <p class=cm-operator>=</p> <p class=cm-variable-2>type</p>; } <p class=cm-property>speak</p>(<p class=cm-def>line</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The ${</p><p class=cm-keyword>this</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p> <p class=cm-string-2>rabbit says '${</p><p class=cm-variable-2>line</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>); }\n} <p class=cm-keyword>let</p> <p class=cm-def>killerRabbit</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Rabbit</p>(<p class=cm-string>\"killer\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>blackRabbit</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Rabbit</p>(<p class=cm-string>\"black\"</p>);</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_wpM2aH78Jp class=p_ident id=p_wpM2aH78Jp></a>The <code>class</code> keyword starts a class declaration, which allows us to define a constructor and a set of methods all in a single place. Any number of methods may be written inside the declaration’s braces. The one named <code>constructor</code> is treated specially. It provides the actual constructor function, which will be bound to the name <code>Rabbit</code>. The others are packaged into that constructor’s prototype. Thus, the earlier class declaration is equivalent to the constructor definition from the previous section. It just looks nicer.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_rJ0WbDXCuo class=p_ident id=p_rJ0WbDXCuo></a>Class declarations currently allow only <em>methods</em>—properties that hold functions—to be added to the prototype. This can be somewhat inconvenient when you want to save a non-function value in there. The next version of the language will probably improve this. For now, you can create such properties by directly manipulating the prototype after you’ve defined the class.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_pp17mMu8If class=p_ident id=p_pp17mMu8If></a>Like <code>function</code>, <code>class</code> can be used both in statements and in expressions. When used as an expression, it doesn’t define a binding but just produces the constructor as a value. You are allowed to omit the class name in a class expression.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_79re+GWcTJ class=c_ident id=c_79re+GWcTJ></a><p class=cm-keyword>let</p> <p class=cm-def>object</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-keyword>class</p> { <p class=cm-property>getWord</p>() { <p class=cm-keyword>return</p> <p class=cm-string>\"hello\"</p>; } };\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object</p>.<p class=cm-property>getWord</p>());\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_oUlUep3Os8 class=h_ident id=h_oUlUep3Os8></a>Overriding derived properties</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_Xbxf2Ooo0z class=p_ident id=p_Xbxf2Ooo0z></a>When you add a property to an object, whether it is present in the prototype or not, the property is added to the object <em>itself</em>. If there was already a property with the same name in the prototype, this property will no longer affect the object, as it is now hidden behind the object’s own property.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_vja6JbO0si class=c_ident id=c_vja6JbO0si></a><p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>.<p class=cm-property>teeth</p> <p class=cm-operator>=</p> <p class=cm-string>\"small\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>killerRabbit</p>.<p class=cm-property>teeth</p>); <p class=cm-variable>killerRabbit</p>.<p class=cm-property>teeth</p> <p class=cm-operator>=</p> <p class=cm-string>\"long, sharp, and bloody\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>killerRabbit</p>.<p class=cm-property>teeth</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>blackRabbit</p>.<p class=cm-property>teeth</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>.<p class=cm-property>teeth</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_HM5YtS3KgJ class=p_ident id=p_HM5YtS3KgJ></a>The following diagram sketches the situation after this code has run. The <code>Rabbit</code> and <code>Object</code> prototypes lie behind <code>killerRabbit</code> as a kind of backdrop, where properties that are not found in the object itself can be looked up.</p><figure><img alt=\"Rabbit object prototype schema\" src=https://eloquentjavascript.net/img/rabbits.svg></figure> <p><a href=https://eloquentjavascript.net/06_object.html#p_or3/lz1DV8 class=p_ident id=p_or3/lz1DV8></a>Overriding properties that exist in a prototype can be a useful thing to do. As the rabbit teeth example shows, overriding can be used to express exceptional properties in instances of a more generic class of objects, while letting the nonexceptional objects take a standard value from their prototype.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_GIhnbh3MdO class=p_ident id=p_GIhnbh3MdO></a>Overriding is also used to give the standard function and array prototypes a different <code>toString</code> method than the basic object prototype.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_DrIRvUgeOD class=c_ident id=c_DrIRvUgeOD></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Array</p>.<p class=cm-property>prototype</p>.<p class=cm-property>toString</p> <p class=cm-operator>==</p> <p class=cm-variable>Object</p>.<p class=cm-property>prototype</p>.<p class=cm-property>toString</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>].<p class=cm-property>toString</p>());\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_FYf2A2jS65 class=p_ident id=p_FYf2A2jS65></a>Calling <code>toString</code> on an array gives a result similar to calling <code>.<wbr>join(\",\")</code> on it—it puts commas between the values in the array. Directly calling <code>Object.<wbr>prototype.<wbr>toString</code> with an array produces a different string. That function doesn’t know about arrays, so it simply puts the word <em>object</em> and the name of the type between square brackets.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_XpqFUrDFJE class=c_ident id=c_XpqFUrDFJE></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>prototype</p>.<p class=cm-property>toString</p>.<p class=cm-property>call</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>]));\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_gAcc11EHzV class=h_ident id=h_gAcc11EHzV></a>Maps</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_5v6QzULS7C class=p_ident id=p_5v6QzULS7C></a>We saw the word <em>map</em> used in the <a href=https://eloquentjavascript.net/05_higher_order.html#map>previous chapter</a> for an operation that transforms a data structure by applying a function to its elements. Confusing as it is, in programming the same word is also used for a related but rather different thing.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_++bw9zDmtH class=p_ident id=p_++bw9zDmtH></a>A <em>map</em> (noun) is a data structure that associates values (the keys) with other values. For example, you might want to map names to ages. It is possible to use objects for this.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_Wu6a8ObZI0 class=c_ident id=c_Wu6a8ObZI0></a><p class=cm-keyword>let</p> <p class=cm-def>ages</p> <p class=cm-operator>=</p> { <p class=cm-property>Boris</p>: <p class=cm-number>39</p>, <p class=cm-property>Liang</p>: <p class=cm-number>22</p>, <p class=cm-property>Júlia</p>: <p class=cm-number>62</p>\n}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Júlia is ${</p><p class=cm-variable>ages</p>[<p class=cm-string>\"Júlia\"</p>]<p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Is Jack's age known?\"</p>, <p class=cm-string>\"Jack\"</p> <p class=cm-keyword>in</p> <p class=cm-variable>ages</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Is toString's age known?\"</p>, <p class=cm-string>\"toString\"</p> <p class=cm-keyword>in</p> <p class=cm-variable>ages</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_EQqc7pcOKT class=p_ident id=p_EQqc7pcOKT></a>Here, the object’s property names are the people’s names, and the property values are their ages. But we certainly didn’t list anybody named toString in our map. Yet, because plain objects derive from <code>Object.prototype</code>, it looks like the property is there.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_enf1/9ItBM class=p_ident id=p_enf1/9ItBM></a>As such, using plain objects as maps is dangerous. There are several possible ways to avoid this problem. First, it is possible to create objects with <em>no</em> prototype. If you pass <code>null</code> to <code>Object.create</code>, the resulting object will not derive from <code>Object.prototype</code> and can safely be used as a map.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_AkRQLQc4AG class=c_ident id=c_AkRQLQc4AG></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"toString\"</p> <p class=cm-keyword>in</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>));\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_jGC2iO9E1x class=p_ident id=p_jGC2iO9E1x></a>Object property names must be strings. If you need a map whose keys can’t easily be converted to strings—such as objects—you cannot use an object as your map.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_nIsq9E5wmZ class=p_ident id=p_nIsq9E5wmZ></a>Fortunately, JavaScript comes with a class called <code>Map</code> that is written for this exact purpose. It stores a mapping and allows any type of keys.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_dd6KsGgAGP class=c_ident id=c_dd6KsGgAGP></a><p class=cm-keyword>let</p> <p class=cm-def>ages</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Map</p>();\n<p class=cm-variable>ages</p>.<p class=cm-property>set</p>(<p class=cm-string>\"Boris\"</p>, <p class=cm-number>39</p>);\n<p class=cm-variable>ages</p>.<p class=cm-property>set</p>(<p class=cm-string>\"Liang\"</p>, <p class=cm-number>22</p>);\n<p class=cm-variable>ages</p>.<p class=cm-property>set</p>(<p class=cm-string>\"Júlia\"</p>, <p class=cm-number>62</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Júlia is ${</p><p class=cm-variable>ages</p>.<p class=cm-property>get</p>(<p class=cm-string>\"Júlia\"</p>)<p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Is Jack's age known?\"</p>, <p class=cm-variable>ages</p>.<p class=cm-property>has</p>(<p class=cm-string>\"Jack\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>ages</p>.<p class=cm-property>has</p>(<p class=cm-string>\"toString\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_iIdp+mGl3Y class=p_ident id=p_iIdp+mGl3Y></a>The methods <code>set</code>, <code>get</code>, and <code>has</code> are part of the interface of the <code>Map</code> object. Writing a data structure that can quickly update and search a large set of values isn’t easy, but we don’t have to worry about that. Someone else did it for us, and we can go through this simple interface to use their work.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_tx3xnowcEp class=p_ident id=p_tx3xnowcEp></a>If you do have a plain object that you need to treat as a map for some reason, it is useful to know that <code>Object.keys</code> returns only an object’s <em>own</em> keys, not those in the prototype. As an alternative to the <code>in</code> operator, you can use the <code>hasOwnProperty</code> method, which ignores the object’s prototype.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_qBrd35Qiln class=c_ident id=c_qBrd35Qiln></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>({<p class=cm-property>x</p>: <p class=cm-number>1</p>}.<p class=cm-property>hasOwnProperty</p>(<p class=cm-string>\"x\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>({<p class=cm-property>x</p>: <p class=cm-number>1</p>}.<p class=cm-property>hasOwnProperty</p>(<p class=cm-string>\"toString\"</p>));\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_mJ/JHQRHg9 class=h_ident id=h_mJ/JHQRHg9></a>Polymorphism</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_ozkqUookhO class=p_ident id=p_ozkqUookhO></a>When you call the <code>String</code> function (which converts a value to a string) on an object, it will call the <code>toString</code> method on that object to try to create a meaningful string from it. I mentioned that some of the standard prototypes define their own version of <code>toString</code> so they can create a string that contains more useful information than <code>\"[object Object]\"</code>. You can also do that yourself.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_V+CBn0VJnW class=c_ident id=c_V+CBn0VJnW></a><p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>.<p class=cm-property>toString</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>() { <p class=cm-keyword>return</p> <p class=cm-string-2>`a ${</p><p class=cm-keyword>this</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p> <p class=cm-string-2>rabbit`</p>;\n}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>String</p>(<p class=cm-variable>blackRabbit</p>));\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_HgUFdFB6vM class=p_ident id=p_HgUFdFB6vM></a>This is a simple instance of a powerful idea. When a piece of code is written to work with objects that have a certain interface—in this case, a <code>toString</code> method—any kind of object that happens to support this interface can be plugged into the code, and it will just work.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_qNZih5k+vu class=p_ident id=p_qNZih5k+vu></a>This technique is called <em>polymorphism</em>. Polymorphic code can work with values of different shapes, as long as they support the interface it expects.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_g9W26O8p4+ class=p_ident id=p_g9W26O8p4+></a>I mentioned in <a href=https://eloquentjavascript.net/04_data.html#for_of_loop>Chapter 4</a> that a <code>for</code>/<code>of</code> loop can loop over several kinds of data structures. This is another case of polymorphism—such loops expect the data structure to expose a specific interface, which arrays and strings do. And we can also add this interface to your own objects! But before we can do that, we need to know what symbols are.</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_Iq1mTp65i3 class=h_ident id=h_Iq1mTp65i3></a>Symbols</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_9VjlXGAIAM class=p_ident id=p_9VjlXGAIAM></a>It is possible for multiple interfaces to use the same property name for different things. For example, I could define an interface in which the <code>toString</code> method is supposed to convert the object into a piece of yarn. It would not be possible for an object to conform to both that interface and the standard use of <code>toString</code>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_v6ZgtFDNeP class=p_ident id=p_v6ZgtFDNeP></a>That would be a bad idea, and this problem isn’t that common. Most JavaScript programmers simply don’t think about it. But the language designers, whose <em>job</em> it is to think about this stuff, have provided us with a solution anyway.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_7p+O+Qr4bN class=p_ident id=p_7p+O+Qr4bN></a>When I claimed that property names are strings, that wasn’t entirely accurate. They usually are, but they can also be <em>symbols</em>. Symbols are values created with the <code>Symbol</code> function. Unlike strings, newly created symbols are unique—you cannot create the same symbol twice.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_/KAipM77Y+ class=c_ident id=c_/KAipM77Y+></a><p class=cm-keyword>let</p> <p class=cm-def>sym</p> <p class=cm-operator>=</p> <p class=cm-variable>Symbol</p>(<p class=cm-string>\"name\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sym</p> <p class=cm-operator>==</p> <p class=cm-variable>Symbol</p>(<p class=cm-string>\"name\"</p>)); <p class=cm-variable>Rabbit</p>.<p class=cm-property>prototype</p>[<p class=cm-variable>sym</p>] <p class=cm-operator>=</p> <p class=cm-number>55</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>blackRabbit</p>[<p class=cm-variable>sym</p>]);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_PBxnKMHKqV class=p_ident id=p_PBxnKMHKqV></a>The string you pass to <code>Symbol</code> is included when you convert it to a string and can make it easier to recognize a symbol when, for example, showing it in the console. But it has no meaning beyond that—multiple symbols may have the same name.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_n90pM44NAN class=p_ident id=p_n90pM44NAN></a>Being both unique and usable as property names makes symbols suitable for defining interfaces that can peacefully live alongside other properties, no matter what their names are.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_I6uO/ojWit class=c_ident id=c_I6uO/ojWit></a><p class=cm-keyword>const</p> <p class=cm-def>toStringSymbol</p> <p class=cm-operator>=</p> <p class=cm-variable>Symbol</p>(<p class=cm-string>\"toString\"</p>);\n<p class=cm-variable>Array</p>.<p class=cm-property>prototype</p>[<p class=cm-variable>toStringSymbol</p>] <p class=cm-operator>=</p> <p class=cm-keyword>function</p>() { <p class=cm-keyword>return</p> <p class=cm-string-2>`${</p><p class=cm-keyword>this</p>.<p class=cm-property>length</p><p class=cm-string-2>}</p> <p class=cm-string-2>cm of blue yarn`</p>;\n}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>].<p class=cm-property>toString</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>][<p class=cm-variable>toStringSymbol</p>]());\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_VJSo/GYvCc class=p_ident id=p_VJSo/GYvCc></a>It is possible to include symbol properties in object expressions and classes by using square brackets around the property name. That causes the property name to be evaluated, much like the square bracket property access notation, which allows us to refer to a binding that holds the symbol.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_aZAdJfdSRz class=c_ident id=c_aZAdJfdSRz></a><p class=cm-keyword>let</p> <p class=cm-def>stringObject</p> <p class=cm-operator>=</p> { [<p class=cm-variable>toStringSymbol</p>]() { <p class=cm-keyword>return</p> <p class=cm-string>\"a jute rope\"</p>; }\n};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stringObject</p>[<p class=cm-variable>toStringSymbol</p>]());\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_z2tOOXM8qO class=h_ident id=h_z2tOOXM8qO></a>The iterator interface</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_gtFNFSvSrt class=p_ident id=p_gtFNFSvSrt></a>The object given to a <code>for</code>/<code>of</code> loop is expected to be <em>iterable</em>. This means it has a method named with the <code>Symbol.iterator</code> symbol (a symbol value defined by the language, stored as a property of the <code>Symbol</code> function).</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_gs0GMX9PA7 class=p_ident id=p_gs0GMX9PA7></a>When called, that method should return an object that provides a second interface, <em>iterator</em>. This is the actual thing that iterates. It has a <code>next</code> method that returns the next result. That result should be an object with a <code>value</code> property that provides the next value, if there is one, and a <code>done</code> property, which should be true when there are no more results and false otherwise.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_a9jQxjOo3t class=p_ident id=p_a9jQxjOo3t></a>Note that the <code>next</code>, <code>value</code>, and <code>done</code> property names are plain strings, not symbols. Only <code>Symbol.iterator</code>, which is likely to be added to a <em>lot</em> of different objects, is an actual symbol.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_wSWGcm7dId class=p_ident id=p_wSWGcm7dId></a>We can directly use this interface ourselves.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_CKTaBW3WjJ class=c_ident id=c_CKTaBW3WjJ></a><p class=cm-keyword>let</p> <p class=cm-def>okIterator</p> <p class=cm-operator>=</p> <p class=cm-string>\"OK\"</p>[<p class=cm-variable>Symbol</p>.<p class=cm-property>iterator</p>]();\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>okIterator</p>.<p class=cm-property>next</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>okIterator</p>.<p class=cm-property>next</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>okIterator</p>.<p class=cm-property>next</p>());\n</pre> <p id=matrix><a href=https://eloquentjavascript.net/06_object.html#p_rqXAzunzIi class=p_ident id=p_rqXAzunzIi></a>Let’s implement an iterable data structure. We’ll build a <em>matrix</em> class, acting as a two-dimensional array.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_Q128qlROKi class=c_ident id=c_Q128qlROKi></a><p class=cm-keyword>class</p> <p class=cm-def>Matrix</p> { <p class=cm-property>constructor</p>(<p class=cm-def>width</p>, <p class=cm-def>height</p>, <p class=cm-def>element</p> <p class=cm-operator>=</p> (<p class=cm-def>x</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> <p class=cm-atom>undefined</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>width</p>; <p class=cm-keyword>this</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-variable-2>height</p>; <p class=cm-keyword>this</p>.<p class=cm-property>content</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>height</p>; <p class=cm-variable-2>y</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>width</p>; <p class=cm-variable-2>x</p><p class=cm-operator>++</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>content</p>[<p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-variable-2>width</p> <p class=cm-operator>+</p> <p class=cm-variable-2>x</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>element</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>); } } } <p class=cm-property>get</p>(<p class=cm-def>x</p>, <p class=cm-def>y</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>content</p>[<p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>+</p> <p class=cm-variable-2>x</p>]; } <p class=cm-property>set</p>(<p class=cm-def>x</p>, <p class=cm-def>y</p>, <p class=cm-def>value</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>content</p>[<p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>+</p> <p class=cm-variable-2>x</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>value</p>;\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_I/q+okK5mh class=p_ident id=p_I/q+okK5mh></a>The class stores its content in a single array of <em>width</em> × <em>height</em> elements. The elements are stored row by row, so, for example, the third element in the fifth row is (using zero-based indexing) stored at position 4 × <em>width</em> + 2.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_RlDQ7yqK2c class=p_ident id=p_RlDQ7yqK2c></a>The constructor function takes a width, a height, and an optional <code>element</code> function that will be used to fill in the initial values. There are <code>get</code> and <code>set</code> methods to retrieve and update elements in the matrix.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_DHPUGxvFrD class=p_ident id=p_DHPUGxvFrD></a>When looping over a matrix, you are usually interested in the position of the elements as well as the elements themselves, so we’ll have our iterator produce objects with <code>x</code>, <code>y</code>, and <code>value</code> properties.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_LtbqF2pl4c class=c_ident id=c_LtbqF2pl4c></a><p class=cm-keyword>class</p> <p class=cm-def>MatrixIterator</p> { <p class=cm-property>constructor</p>(<p class=cm-def>matrix</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>this</p>.<p class=cm-property>y</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>this</p>.<p class=cm-property>matrix</p> <p class=cm-operator>=</p> <p class=cm-variable-2>matrix</p>; } <p class=cm-property>next</p>() { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>y</p> <p class=cm-operator>==</p> <p class=cm-keyword>this</p>.<p class=cm-property>matrix</p>.<p class=cm-property>height</p>) <p class=cm-keyword>return</p> {<p class=cm-property>done</p>: <p class=cm-atom>true</p>}; <p class=cm-keyword>let</p> <p class=cm-def>value</p> <p class=cm-operator>=</p> {<p class=cm-property>x</p>: <p class=cm-keyword>this</p>.<p class=cm-property>x</p>, <p class=cm-property>y</p>: <p class=cm-keyword>this</p>.<p class=cm-property>y</p>, <p class=cm-property>value</p>: <p class=cm-keyword>this</p>.<p class=cm-property>matrix</p>.<p class=cm-property>get</p>(<p class=cm-keyword>this</p>.<p class=cm-property>x</p>, <p class=cm-keyword>this</p>.<p class=cm-property>y</p>)}; <p class=cm-keyword>this</p>.<p class=cm-property>x</p><p class=cm-operator>++</p>; <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>==</p> <p class=cm-keyword>this</p>.<p class=cm-property>matrix</p>.<p class=cm-property>width</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>this</p>.<p class=cm-property>y</p><p class=cm-operator>++</p>; } <p class=cm-keyword>return</p> {<p class=cm-property>value</p>, <p class=cm-property>done</p>: <p class=cm-atom>false</p>};\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_yBJg8/BmDJ class=p_ident id=p_yBJg8/BmDJ></a>The class tracks the progress of iterating over a matrix in its <code>x</code> and <code>y</code> properties. The <code>next</code> method starts by checking whether the bottom of the matrix has been reached. If it hasn’t, it <em>first</em> creates the object holding the current value and <em>then</em> updates its position, moving to the next row if necessary.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_Iu3bFayPkp class=p_ident id=p_Iu3bFayPkp></a>Let’s set up the <code>Matrix</code> class to be iterable. Throughout this book, I’ll occasionally use after-the-fact prototype manipulation to add methods to classes so that the individual pieces of code remain small and self-contained. In a regular program, where there is no need to split the code into small pieces, you’d declare these methods directly in the class instead.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_BmOLk4O5HN class=c_ident id=c_BmOLk4O5HN></a><p class=cm-variable>Matrix</p>.<p class=cm-property>prototype</p>[<p class=cm-variable>Symbol</p>.<p class=cm-property>iterator</p>] <p class=cm-operator>=</p> <p class=cm-keyword>function</p>() { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>MatrixIterator</p>(<p class=cm-keyword>this</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_+6FbIloB5k class=p_ident id=p_+6FbIloB5k></a>We can now loop over a matrix with <code>for</code>/<code>of</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_ek9pXBwNMJ class=c_ident id=c_ek9pXBwNMJ></a><p class=cm-keyword>let</p> <p class=cm-def>matrix</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Matrix</p>(<p class=cm-number>2</p>, <p class=cm-number>2</p>, (<p class=cm-def>x</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> <p class=cm-string-2>`value ${</p><p class=cm-variable-2>x</p><p class=cm-string-2>}</p><p class=cm-string-2>,${</p><p class=cm-variable-2>y</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> {<p class=cm-def>x</p>, <p class=cm-def>y</p>, <p class=cm-def>value</p>} <p class=cm-keyword>of</p> <p class=cm-variable>matrix</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>x</p>, <p class=cm-variable>y</p>, <p class=cm-variable>value</p>);\n}\n\n\n\n</pre> <h2><a href=https://eloquentjavascript.net/06_object.html#h_3vwredi8nD class=h_ident id=h_3vwredi8nD></a>Getters, setters, and statics</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_6oukozZJBx class=p_ident id=p_6oukozZJBx></a>Interfaces often consist mostly of methods, but it is also okay to include properties that hold non-function values. For example, <code>Map</code> objects have a <code>size</code> property that tells you how many keys are stored in them.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_SdyGtj5JbS class=p_ident id=p_SdyGtj5JbS></a>It is not even necessary for such an object to compute and store such a property directly in the instance. Even properties that are accessed directly may hide a method call. Such methods are called <em>getters</em>, and they are defined by writing <code>get</code> in front of the method name in an object expression or class declaration.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_Np05mJ4GVO class=c_ident id=c_Np05mJ4GVO></a><p class=cm-keyword>let</p> <p class=cm-def>varyingSize</p> <p class=cm-operator>=</p> { <p class=cm-property>get</p> <p class=cm-property>size</p>() { <p class=cm-keyword>return</p> <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-number>100</p>); }\n}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>varyingSize</p>.<p class=cm-property>size</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>varyingSize</p>.<p class=cm-property>size</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_QwpqNIZOsS class=p_ident id=p_QwpqNIZOsS></a>Whenever someone reads from this object’s <code>size</code> property, the associated method is called. You can do a similar thing when a property is written to, using a <em>setter</em>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_7LQG88c1BA class=c_ident id=c_7LQG88c1BA></a><p class=cm-keyword>class</p> <p class=cm-def>Temperature</p> { <p class=cm-property>constructor</p>(<p class=cm-def>celsius</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>celsius</p> <p class=cm-operator>=</p> <p class=cm-variable-2>celsius</p>; } <p class=cm-keyword>get</p> <p class=cm-property>fahrenheit</p>() { <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>celsius</p> <p class=cm-operator>*</p> <p class=cm-number>1.8</p> <p class=cm-operator>+</p> <p class=cm-number>32</p>; } <p class=cm-keyword>set</p> <p class=cm-property>fahrenheit</p>(<p class=cm-def>value</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>celsius</p> <p class=cm-operator>=</p> (<p class=cm-variable-2>value</p> <p class=cm-operator>-</p> <p class=cm-number>32</p>) <p class=cm-operator>/</p> <p class=cm-number>1.8</p>; } <p class=cm-keyword>static</p> <p class=cm-property>fromFahrenheit</p>(<p class=cm-def>value</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Temperature</p>((<p class=cm-variable-2>value</p> <p class=cm-operator>-</p> <p class=cm-number>32</p>) <p class=cm-operator>/</p> <p class=cm-number>1.8</p>); }\n} <p class=cm-keyword>let</p> <p class=cm-def>temp</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Temperature</p>(<p class=cm-number>22</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>temp</p>.<p class=cm-property>fahrenheit</p>); <p class=cm-variable>temp</p>.<p class=cm-property>fahrenheit</p> <p class=cm-operator>=</p> <p class=cm-number>86</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>temp</p>.<p class=cm-property>celsius</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_Hf3p+suFR+ class=p_ident id=p_Hf3p+suFR+></a>The <code>Temperature</code> class allows you to read and write the temperature in either degrees Celsius or degrees Fahrenheit, but internally it stores only Celsius and automatically converts to and from Celsius in the <code>fahrenheit</code> getter and setter.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_MwIs1kR0mD class=p_ident id=p_MwIs1kR0mD></a>Sometimes you want to attach some properties directly to your constructor function, rather than to the prototype. Such methods won’t have access to a class instance but can, for example, be used to provide additional ways to create instances.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_zLJ2u9mlXs class=p_ident id=p_zLJ2u9mlXs></a>Inside a class declaration, methods that have <code>static</code> written before their name are stored on the constructor. So the <code>Temperature</code> class allows you to write <code>Temperature.<wbr>fromFahrenheit(100)</code> to create a temperature using degrees Fahrenheit.</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_/a3bnONnws class=h_ident id=h_/a3bnONnws></a>Inheritance</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_seSalQnLZd class=p_ident id=p_seSalQnLZd></a>Some matrices are known to be <em>symmetric</em>. If you mirror a symmetric matrix around its top-left-to-bottom-right diagonal, it stays the same. In other words, the value stored at <em>x</em>,<em>y</em> is always the same as that at <em>y</em>,<em>x</em>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_InrSr2m6Kl class=p_ident id=p_InrSr2m6Kl></a>Imagine we need a data structure like <code>Matrix</code> but one that enforces the fact that the matrix is and remains symmetrical. We could write it from scratch, but that would involve repeating some code very similar to what we already wrote.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_kRtvgxF67W class=p_ident id=p_kRtvgxF67W></a>JavaScript’s prototype system makes it possible to create a <em>new</em> class, much like the old class, but with new definitions for some of its properties. The prototype for the new class derives from the old prototype but adds a new definition for, say, the <code>set</code> method.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_a3GMshNFYT class=p_ident id=p_a3GMshNFYT></a>In object-oriented programming terms, this is called <em>inheritance</em>. The new class inherits properties and behavior from the old class.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_uuBcsDdS7D class=c_ident id=c_uuBcsDdS7D></a><p class=cm-keyword>class</p> <p class=cm-def>SymmetricMatrix</p> <p class=cm-keyword>extends</p> <p class=cm-variable>Matrix</p> { <p class=cm-property>constructor</p>(<p class=cm-def>size</p>, <p class=cm-def>element</p> <p class=cm-operator>=</p> (<p class=cm-def>x</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> <p class=cm-atom>undefined</p>) { <p class=cm-keyword>super</p>(<p class=cm-variable-2>size</p>, <p class=cm-variable-2>size</p>, (<p class=cm-def>x</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>y</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>element</p>(<p class=cm-variable-2>y</p>, <p class=cm-variable-2>x</p>); <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> <p class=cm-variable-2>element</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>); }); } <p class=cm-property>set</p>(<p class=cm-def>x</p>, <p class=cm-def>y</p>, <p class=cm-def>value</p>) { <p class=cm-keyword>super</p>.<p class=cm-property>set</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>, <p class=cm-variable-2>value</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>x</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>y</p>) { <p class=cm-keyword>super</p>.<p class=cm-property>set</p>(<p class=cm-variable-2>y</p>, <p class=cm-variable-2>x</p>, <p class=cm-variable-2>value</p>); } }\n} <p class=cm-keyword>let</p> <p class=cm-def>matrix</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>SymmetricMatrix</p>(<p class=cm-number>5</p>, (<p class=cm-def>x</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>x</p><p class=cm-string-2>}</p><p class=cm-string-2>,${</p><p class=cm-variable-2>y</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>matrix</p>.<p class=cm-property>get</p>(<p class=cm-number>2</p>, <p class=cm-number>3</p>));\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_RZZzYHZ3d6 class=p_ident id=p_RZZzYHZ3d6></a>The use of the word <code>extends</code> indicates that this class shouldn’t be directly based on the default <code>Object</code> prototype but on some other class. This is called the <em>superclass</em>. The derived class is the <em>subclass</em>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_mss/w8sDfy class=p_ident id=p_mss/w8sDfy></a>To initialize a <code>SymmetricMatrix</code> instance, the constructor calls its superclass’s constructor through the <code>super</code> keyword. This is necessary because if this new object is to behave (roughly) like a <code>Matrix</code>, it is going to need the instance properties that matrices have. To ensure the matrix is symmetrical, the constructor wraps the <code>element</code> function to swap the coordinates for values below the diagonal.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_9XrYhhYXI8 class=p_ident id=p_9XrYhhYXI8></a>The <code>set</code> method again uses <code>super</code> but this time not to call the constructor but to call a specific method from the superclass’s set of methods. We are redefining <code>set</code> but do want to use the original behavior. Because <code>this.set</code> refers to the <em>new</em> <code>set</code> method, calling that wouldn’t work. Inside class methods, <code>super</code> provides a way to call methods as they were defined in the superclass.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_apvJjMYcsg class=p_ident id=p_apvJjMYcsg></a>Inheritance allows us to build slightly different data types from existing data types with relatively little work. It is a fundamental part of the object-oriented tradition, alongside encapsulation and polymorphism. But while the latter two are now generally regarded as wonderful ideas, inheritance is more controversial.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_CWDhzksvzb class=p_ident id=p_CWDhzksvzb></a>Whereas encapsulation and polymorphism can be used to <em>separate</em> pieces of code from each other, reducing the tangledness of the overall program, inheritance fundamentally ties classes together, creating <em>more</em> tangle. When inheriting from a class, you usually have to know more about how it works than when simply using it. Inheritance can be a useful tool, and I use it now and then in my own programs, but it shouldn’t be the first tool you reach for, and you probably shouldn’t actively go looking for opportunities to construct class hierarchies (family trees of classes).</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_Fdk67dJHwg class=h_ident id=h_Fdk67dJHwg></a>The instanceof operator</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_wnmK5D9foe class=p_ident id=p_wnmK5D9foe></a>It is occasionally useful to know whether an object was derived from a specific class. For this, JavaScript provides a binary operator called <code>instanceof</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_1/4hH+dV3k class=c_ident id=c_1/4hH+dV3k></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>( <p class=cm-keyword>new</p> <p class=cm-variable>SymmetricMatrix</p>(<p class=cm-number>2</p>) <p class=cm-keyword>instanceof</p> <p class=cm-variable>SymmetricMatrix</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>SymmetricMatrix</p>(<p class=cm-number>2</p>) <p class=cm-keyword>instanceof</p> <p class=cm-variable>Matrix</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Matrix</p>(<p class=cm-number>2</p>, <p class=cm-number>2</p>) <p class=cm-keyword>instanceof</p> <p class=cm-variable>SymmetricMatrix</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>] <p class=cm-keyword>instanceof</p> <p class=cm-variable>Array</p>);\n</pre> <p><a href=https://eloquentjavascript.net/06_object.html#p_VtvmEyRrv+ class=p_ident id=p_VtvmEyRrv+></a>The operator will see through inherited types, so a <code>SymmetricMatrix</code> is an instance of <code>Matrix</code>. The operator can also be applied to standard constructors like <code>Array</code>. Almost every object is an instance of <code>Object</code>.</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/06_object.html#p_VPlYPbumD2 class=p_ident id=p_VPlYPbumD2></a>So objects do more than just hold their own properties. They have prototypes, which are other objects. They’ll act as if they have properties they don’t have as long as their prototype has that property. Simple objects have <code>Object.prototype</code> as their prototype.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_A+dQsxCVz8 class=p_ident id=p_A+dQsxCVz8></a>Constructors, which are functions whose names usually start with a capital letter, can be used with the <code>new</code> operator to create new objects. The new object’s prototype will be the object found in the <code>prototype</code> property of the constructor. You can make good use of this by putting the properties that all values of a given type share into their prototype. There’s a <code>class</code> notation that provides a clear way to define a constructor and its prototype.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_AFyYjRH+5G class=p_ident id=p_AFyYjRH+5G></a>You can define getters and setters to secretly call methods every time an object’s property is accessed. Static methods are methods stored in a class’s constructor, rather than its prototype.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_U1iTgKNfyX class=p_ident id=p_U1iTgKNfyX></a>The <code>instanceof</code> operator can, given an object and a constructor, tell you whether that object is an instance of that constructor.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_zzr1L1PppY class=p_ident id=p_zzr1L1PppY></a>One useful thing to do with objects is to specify an interface for them and tell everybody that they are supposed to talk to your object only through that interface. The rest of the details that make up your object are now <em>encapsulated</em>, hidden behind the interface.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_NWmKpeeGiT class=p_ident id=p_NWmKpeeGiT></a>More than one type may implement the same interface. Code written to use an interface automatically knows how to work with any number of different objects that provide the interface. This is called <em>polymorphism</em>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_fg/ZL+fqD3 class=p_ident id=p_fg/ZL+fqD3></a>When implementing multiple classes that differ in only some details, it can be helpful to write the new classes as <em>subclasses</em> of an existing class, <em>inheriting</em> part of its behavior.</p> <h2><a href=https://eloquentjavascript.net/06_object.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3 id=exercise_vector><a href=https://eloquentjavascript.net/06_object.html#i_zO8FRQBMAy class=i_ident id=i_zO8FRQBMAy></a>A vector type</h3> <p><a href=https://eloquentjavascript.net/06_object.html#p_YtkHcQdZSH class=p_ident id=p_YtkHcQdZSH></a>Write a class <code>Vec</code> that represents a vector in two-dimensional space. It takes <code>x</code> and <code>y</code> parameters (numbers), which it should save to properties of the same name.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_8DOrtO0lbU class=p_ident id=p_8DOrtO0lbU></a>Give the <code>Vec</code> prototype two methods, <code>plus</code> and <code>minus</code>, that take another vector as a parameter and return a new vector that has the sum or difference of the two vectors’ (<code>this</code> and the parameter) <em>x</em> and <em>y</em> values.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_F5nP+jpza3 class=p_ident id=p_F5nP+jpza3></a>Add a getter property <code>length</code> to the prototype that computes the length of the vector—that is, the distance of the point (<em>x</em>, <em>y</em>) from the origin (0, 0).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_f3P62tUJWH class=c_ident id=c_f3P62tUJWH></a> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>1</p>, <p class=cm-number>2</p>).<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>2</p>, <p class=cm-number>3</p>))); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>1</p>, <p class=cm-number>2</p>).<p class=cm-property>minus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>2</p>, <p class=cm-number>3</p>))); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>3</p>, <p class=cm-number>4</p>).<p class=cm-property>length</p>);\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/06_object.html#p_jRIa414Yh5 class=p_ident id=p_jRIa414Yh5></a>Look back to the <code>Rabbit</code> class example if you’re unsure how <code>class</code> declarations look.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_uZnm2ZSaRd class=p_ident id=p_uZnm2ZSaRd></a>Adding a getter property to the constructor can be done by putting the word <code>get</code> before the method name. To compute the distance from (0, 0) to (x, y), you can use the Pythagorean theorem, which says that the square of the distance we are looking for is equal to the square of the x-coordinate plus the square of the y-coordinate. Thus, √(x<sup>2</sup> + y<sup>2</sup>) is the number you want, and <code>Math.sqrt</code> is the way you compute a square root in JavaScript.</p> </div></div> <h3><a href=https://eloquentjavascript.net/06_object.html#i_rpYp9Ou4LG class=i_ident id=i_rpYp9Ou4LG></a>Groups</h3> <p id=groups><a href=https://eloquentjavascript.net/06_object.html#p_1TnXiDoyR2 class=p_ident id=p_1TnXiDoyR2></a>The standard JavaScript environment provides another data structure called <code>Set</code>. Like an instance of <code>Map</code>, a set holds a collection of values. Unlike <code>Map</code>, it does not associate other values with those—it just tracks which values are part of the set. A value can be part of a set only once—adding it again doesn’t have any effect.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_IBo4QI1mvy class=p_ident id=p_IBo4QI1mvy></a>Write a class called <code>Group</code> (since <code>Set</code> is already taken). Like <code>Set</code>, it has <code>add</code>, <code>delete</code>, and <code>has</code> methods. Its constructor creates an empty group, <code>add</code> adds a value to the group (but only if it isn’t already a member), <code>delete</code> removes its argument from the group (if it was a member), and <code>has</code> returns a Boolean value indicating whether its argument is a member of the group.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_cHm3PZ0L5i class=p_ident id=p_cHm3PZ0L5i></a>Use the <code>===</code> operator, or something equivalent such as <code>indexOf</code>, to determine whether two values are the same.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_CbJ60eqr+J class=p_ident id=p_CbJ60eqr+J></a>Give the class a static <code>from</code> method that takes an iterable object as argument and creates a group that contains all the values produced by iterating over it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_dNauaecKx+ class=c_ident id=c_dNauaecKx+></a><p class=cm-keyword>class</p> <p class=cm-def>Group</p> { } <p class=cm-keyword>let</p> <p class=cm-def>group</p> <p class=cm-operator>=</p> <p class=cm-variable>Group</p>.<p class=cm-property>from</p>([<p class=cm-number>10</p>, <p class=cm-number>20</p>]);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>group</p>.<p class=cm-property>has</p>(<p class=cm-number>10</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>group</p>.<p class=cm-property>has</p>(<p class=cm-number>30</p>)); <p class=cm-variable>group</p>.<p class=cm-property>add</p>(<p class=cm-number>10</p>);\n<p class=cm-variable>group</p>.<p class=cm-property>delete</p>(<p class=cm-number>10</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>group</p>.<p class=cm-property>has</p>(<p class=cm-number>10</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/06_object.html#p_fQA7KS4poU class=p_ident id=p_fQA7KS4poU></a>The easiest way to do this is to store an array of group members in an instance property. The <code>includes</code> or <code>indexOf</code> methods can be used to check whether a given value is in the array.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_2+V8dOgKHs class=p_ident id=p_2+V8dOgKHs></a>Your class’s constructor can set the member collection to an empty array. When <code>add</code> is called, it must check whether the given value is in the array or add it, for example with <code>push</code>, otherwise.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_GVg0o9XSa+ class=p_ident id=p_GVg0o9XSa+></a>Deleting an element from an array, in <code>delete</code>, is less straightforward, but you can use <code>filter</code> to create a new array without the value. Don’t forget to overwrite the property holding the members with the newly filtered version of the array.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_1KdbI2vH34 class=p_ident id=p_1KdbI2vH34></a>The <code>from</code> method can use a <code>for</code>/<code>of</code> loop to get the values out of the iterable object and call <code>add</code> to put them into a newly created group.</p> </div></div> <h3><a href=https://eloquentjavascript.net/06_object.html#i_djD3XDJ27V class=i_ident id=i_djD3XDJ27V></a>Iterable groups</h3> <p id=group_iterator><a href=https://eloquentjavascript.net/06_object.html#p_azaOoj0ezw class=p_ident id=p_azaOoj0ezw></a>Make the <code>Group</code> class from the previous exercise iterable. Refer to the section about the iterator interface earlier in the chapter if you aren’t clear on the exact form of the interface anymore.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_SoL9V7zUCt class=p_ident id=p_SoL9V7zUCt></a>If you used an array to represent the group’s members, don’t just return the iterator created by calling the <code>Symbol.iterator</code> method on the array. That would work, but it defeats the purpose of this exercise.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_rLyKomI6vw class=p_ident id=p_rLyKomI6vw></a>It is okay if your iterator behaves strangely when the group is modified during iteration.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_n6ZNn/zRLj class=c_ident id=c_n6ZNn/zRLj></a> <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>value</p> <p class=cm-keyword>of</p> <p class=cm-variable>Group</p>.<p class=cm-property>from</p>([<p class=cm-string>\"a\"</p>, <p class=cm-string>\"b\"</p>, <p class=cm-string>\"c\"</p>])) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>value</p>);\n}\n\n\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/06_object.html#p_URAzFlYuQP class=p_ident id=p_URAzFlYuQP></a>It is probably worthwhile to define a new class <code>GroupIterator</code>. Iterator instances should have a property that tracks the current position in the group. Every time <code>next</code> is called, it checks whether it is done and, if not, moves past the current value and returns it.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_il9bvEkyQT class=p_ident id=p_il9bvEkyQT></a>The <code>Group</code> class itself gets a method named by <code>Symbol.iterator</code> that, when called, returns a new instance of the iterator class for that group.</p> </div></div> <h3><a href=https://eloquentjavascript.net/06_object.html#i_wcWSnr9zHV class=i_ident id=i_wcWSnr9zHV></a>Borrowing a method</h3> <p><a href=https://eloquentjavascript.net/06_object.html#p_HxMI3VGcht class=p_ident id=p_HxMI3VGcht></a>Earlier in the chapter I mentioned that an object’s <code>hasOwnProperty</code> can be used as a more robust alternative to the <code>in</code> operator when you want to ignore the prototype’s properties. But what if your map needs to include the word <code>\"hasOwnProperty\"</code>? You won’t be able to call that method anymore because the object’s own property hides the method value.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_nxOrPKy+Ky class=p_ident id=p_nxOrPKy+Ky></a>Can you think of a way to call <code>hasOwnProperty</code> on an object that has its own property by that name?</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/06_object.html#c_LtMKqqkY0Q class=c_ident id=c_LtMKqqkY0Q></a><p class=cm-keyword>let</p> <p class=cm-def>map</p> <p class=cm-operator>=</p> {<p class=cm-property>one</p>: <p class=cm-atom>true</p>, <p class=cm-property>two</p>: <p class=cm-atom>true</p>, <p class=cm-property>hasOwnProperty</p>: <p class=cm-atom>true</p>}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>map</p>.<p class=cm-property>hasOwnProperty</p>(<p class=cm-string>\"one\"</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/06_object.html#p_Pg/cWjUrKm class=p_ident id=p_Pg/cWjUrKm></a>Remember that methods that exist on plain objects come from <code>Object.prototype</code>.</p> <p><a href=https://eloquentjavascript.net/06_object.html#p_wCf1aBfcJA class=p_ident id=p_wCf1aBfcJA></a>Also remember that you can call a function with a specific <code>this</code> binding by using its <code>call</code> method.</p> </div></div><nav><a href=https://eloquentjavascript.net/05_higher_order.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/07_robot.html>▶</a></nav>\n</article><hr><h4>Page 3</h4><article score=544.1800000000001>\n<nav><a href=https://eloquentjavascript.net/06_object.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/08_error.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/07_robot.html#p_uJUZHUrdPa class=p_ident id=p_uJUZHUrdPa></a>[...] the question of whether Machines Can Think [...] is about as relevant as the question of whether Submarines Can Swim.</p> <footer>Edsger Dijkstra, <cite>The Threats to Computing Science</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a package-delivery robot\" src=https://eloquentjavascript.net/img/chapter_picture_7.jpg></figure> <p><a href=https://eloquentjavascript.net/07_robot.html#p_5AQpMxl1Fi class=p_ident id=p_5AQpMxl1Fi></a>In “project” chapters, I’ll stop pummeling you with new theory for a brief moment, and instead we’ll work through a program together. Theory is necessary to learn to program, but reading and understanding actual programs is just as important.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_ncfl8fD8N8 class=p_ident id=p_ncfl8fD8N8></a>Our project in this chapter is to build an automaton, a little program that performs a task in a virtual world. Our automaton will be a mail-delivery robot picking up and dropping off parcels.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_UmFK5fYed8 class=h_ident id=h_UmFK5fYed8></a>Meadowfield</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_rnkG5XLqCA class=p_ident id=p_rnkG5XLqCA></a>The village of Meadowfield isn’t very big. It consists of 11 places with 14 roads between them. It can be described with this array of roads:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_Zs4LZxNb9d class=c_ident id=c_Zs4LZxNb9d></a><p class=cm-keyword>const</p> <p class=cm-def>roads</p> <p class=cm-operator>=</p> [ <p class=cm-string>\"Alice's House-Bob's House\"</p>, <p class=cm-string>\"Alice's House-Cabin\"</p>, <p class=cm-string>\"Alice's House-Post Office\"</p>, <p class=cm-string>\"Bob's House-Town Hall\"</p>, <p class=cm-string>\"Daria's House-Ernie's House\"</p>, <p class=cm-string>\"Daria's House-Town Hall\"</p>, <p class=cm-string>\"Ernie's House-Grete's House\"</p>, <p class=cm-string>\"Grete's House-Farm\"</p>, <p class=cm-string>\"Grete's House-Shop\"</p>, <p class=cm-string>\"Marketplace-Farm\"</p>, <p class=cm-string>\"Marketplace-Post Office\"</p>, <p class=cm-string>\"Marketplace-Shop\"</p>, <p class=cm-string>\"Marketplace-Town Hall\"</p>, <p class=cm-string>\"Shop-Town Hall\"</p>\n];</pre><figure><img alt=\"The village of Meadowfield\" src=https://eloquentjavascript.net/img/village2x.png></figure> <p><a href=https://eloquentjavascript.net/07_robot.html#p_kUSGv0smF0 class=p_ident id=p_kUSGv0smF0></a>The network of roads in the village forms a <em>graph</em>. A graph is a collection of points (places in the village) with lines between them (roads). This graph will be the world that our robot moves through.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_zOR53PiwWK class=p_ident id=p_zOR53PiwWK></a>The array of strings isn’t very easy to work with. What we’re interested in is the destinations that we can reach from a given place. Let’s convert the list of roads to a data structure that, for each place, tells us what can be reached from there.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_URtngTWego class=c_ident id=c_URtngTWego></a><p class=cm-keyword>function</p> <p class=cm-def>buildGraph</p>(<p class=cm-def>edges</p>) { <p class=cm-keyword>let</p> <p class=cm-def>graph</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-keyword>function</p> <p class=cm-def>addEdge</p>(<p class=cm-def>from</p>, <p class=cm-def>to</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>graph</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>==</p> <p class=cm-atom>null</p>) { <p class=cm-variable-2>graph</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>=</p> [<p class=cm-variable-2>to</p>]; } <p class=cm-keyword>else</p> { <p class=cm-variable-2>graph</p>[<p class=cm-variable-2>from</p>].<p class=cm-property>push</p>(<p class=cm-variable-2>to</p>); } } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> [<p class=cm-def>from</p>, <p class=cm-def>to</p>] <p class=cm-keyword>of</p> <p class=cm-variable-2>edges</p>.<p class=cm-property>map</p>(<p class=cm-def>r</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>r</p>.<p class=cm-property>split</p>(<p class=cm-string>\"-\"</p>))) { <p class=cm-variable-2>addEdge</p>(<p class=cm-variable-2>from</p>, <p class=cm-variable-2>to</p>); <p class=cm-variable-2>addEdge</p>(<p class=cm-variable-2>to</p>, <p class=cm-variable-2>from</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>graph</p>;\n} <p class=cm-keyword>const</p> <p class=cm-def>roadGraph</p> <p class=cm-operator>=</p> <p class=cm-variable>buildGraph</p>(<p class=cm-variable>roads</p>);</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_zU4tmOhQOK class=p_ident id=p_zU4tmOhQOK></a>Given an array of edges, <code>buildGraph</code> creates a map object that, for each node, stores an array of connected nodes.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_/eUhE55hg6 class=p_ident id=p_/eUhE55hg6></a>It uses the <code>split</code> method to go from the road strings, which have the form <code>\"Start-End\"</code>, to two-element arrays containing the start and end as separate strings.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_oekYfM5x02 class=h_ident id=h_oekYfM5x02></a>The task</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_MtO6TwqB5I class=p_ident id=p_MtO6TwqB5I></a>Our robot will be moving around the village. There are parcels in various places, each addressed to some other place. The robot picks up parcels when it comes to them and delivers them when it arrives at their destinations.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_jBwlptGwo9 class=p_ident id=p_jBwlptGwo9></a>The automaton must decide, at each point, where to go next. It has finished its task when all parcels have been delivered.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_xZG2sIniIX class=p_ident id=p_xZG2sIniIX></a>To be able to simulate this process, we must define a virtual world that can describe it. This model tells us where the robot is and where the parcels are. When the robot has decided to move somewhere, we need to update the model to reflect the new situation.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_XP2aQths2D class=p_ident id=p_XP2aQths2D></a>If you’re thinking in terms of object-oriented programming, your first impulse might be to start defining objects for the various elements in the world: a class for the robot, one for a parcel, maybe one for places. These could then hold properties that describe their current state, such as the pile of parcels at a location, which we could change when updating the world.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_SIo98R3+uq class=p_ident id=p_SIo98R3+uq></a>This is wrong.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_md/LJiyP4s class=p_ident id=p_md/LJiyP4s></a>At least, it usually is. The fact that something sounds like an object does not automatically mean that it should be an object in your program. Reflexively writing classes for every concept in your application tends to leave you with a collection of interconnected objects that each have their own internal, changing state. Such programs are often hard to understand and thus easy to break.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_GAVnAUZ9xz class=p_ident id=p_GAVnAUZ9xz></a>Instead, let’s condense the village’s state down to the minimal set of values that define it. There’s the robot’s current location and the collection of undelivered parcels, each of which has a current location and a destination address. That’s it.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_/m1Ukpe9vV class=p_ident id=p_/m1Ukpe9vV></a>And while we’re at it, let’s make it so that we don’t <em>change</em> this state when the robot moves but rather compute a <em>new</em> state for the situation after the move.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_VcDNIi1lcV class=c_ident id=c_VcDNIi1lcV></a><p class=cm-keyword>class</p> <p class=cm-def>VillageState</p> { <p class=cm-property>constructor</p>(<p class=cm-def>place</p>, <p class=cm-def>parcels</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>place</p> <p class=cm-operator>=</p> <p class=cm-variable-2>place</p>; <p class=cm-keyword>this</p>.<p class=cm-property>parcels</p> <p class=cm-operator>=</p> <p class=cm-variable-2>parcels</p>; } <p class=cm-property>move</p>(<p class=cm-def>destination</p>) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable>roadGraph</p>[<p class=cm-keyword>this</p>.<p class=cm-property>place</p>].<p class=cm-property>includes</p>(<p class=cm-variable-2>destination</p>)) { <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>; } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>parcels</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>parcels</p>.<p class=cm-property>map</p>(<p class=cm-def>p</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>p</p>.<p class=cm-property>place</p> <p class=cm-operator>!=</p> <p class=cm-keyword>this</p>.<p class=cm-property>place</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>p</p>; <p class=cm-keyword>return</p> {<p class=cm-property>place</p>: <p class=cm-variable-2>destination</p>, <p class=cm-property>address</p>: <p class=cm-variable-2>p</p>.<p class=cm-property>address</p>}; }).<p class=cm-property>filter</p>(<p class=cm-def>p</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>p</p>.<p class=cm-property>place</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>p</p>.<p class=cm-property>address</p>); <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>VillageState</p>(<p class=cm-variable-2>destination</p>, <p class=cm-variable-2>parcels</p>);\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_+1K4cYKxXh class=p_ident id=p_+1K4cYKxXh></a>The <code>move</code> method is where the action happens. It first checks whether there is a road going from the current place to the destination, and if not, it returns the old state since this is not a valid move.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_8hikodLOP1 class=p_ident id=p_8hikodLOP1></a>Then it creates a new state with the destination as the robot’s new place. But it also needs to create a new set of parcels—parcels that the robot is carrying (that are at the robot’s current place) need to be moved along to the new place. And parcels that are addressed to the new place need to be delivered—that is, they need to be removed from the set of undelivered parcels. The call to <code>map</code> takes care of the moving, and the call to <code>filter</code> does the delivering.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_r1QwqYFKH8 class=p_ident id=p_r1QwqYFKH8></a>Parcel objects aren’t changed when they are moved but re-created. The <code>move</code> method gives us a new village state but leaves the old one entirely intact.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_Z0crEkc0Bs class=c_ident id=c_Z0crEkc0Bs></a><p class=cm-keyword>let</p> <p class=cm-def>first</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>VillageState</p>( <p class=cm-string>\"Post Office\"</p>, [{<p class=cm-property>place</p>: <p class=cm-string>\"Post Office\"</p>, <p class=cm-property>address</p>: <p class=cm-string>\"Alice's House\"</p>}]\n);\n<p class=cm-keyword>let</p> <p class=cm-def>next</p> <p class=cm-operator>=</p> <p class=cm-variable>first</p>.<p class=cm-property>move</p>(<p class=cm-string>\"Alice's House\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>next</p>.<p class=cm-property>place</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>next</p>.<p class=cm-property>parcels</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>first</p>.<p class=cm-property>place</p>);\n</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_tNPZKPr/w9 class=p_ident id=p_tNPZKPr/w9></a>The move causes the parcel to be delivered, and this is reflected in the next state. But the initial state still describes the situation where the robot is at the post office and the parcel is undelivered.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_BgRu2ZQp4Z class=h_ident id=h_BgRu2ZQp4Z></a>Persistent data</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_0XMckw7hMq class=p_ident id=p_0XMckw7hMq></a>Data structures that don’t change are called <em>immutable</em> or <em>persistent</em>. They behave a lot like strings and numbers in that they are who they are and stay that way, rather than containing different things at different times.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_Vzwj9t5LXR class=p_ident id=p_Vzwj9t5LXR></a>In JavaScript, just about everything <em>can</em> be changed, so working with values that are supposed to be persistent requires some restraint. There is a function called <code>Object.freeze</code> that changes an object so that writing to its properties is ignored. You could use that to make sure your objects aren’t changed, if you want to be careful. Freezing does require the computer to do some extra work, and having updates ignored is just about as likely to confuse someone as having them do the wrong thing. So I usually prefer to just tell people that a given object shouldn’t be messed with and hope they remember it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_tzmey+74SE class=c_ident id=c_tzmey+74SE></a><p class=cm-keyword>let</p> <p class=cm-def>object</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>freeze</p>({<p class=cm-property>value</p>: <p class=cm-number>5</p>});\n<p class=cm-variable>object</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-number>10</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object</p>.<p class=cm-property>value</p>);\n</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_HAywJetNsC class=p_ident id=p_HAywJetNsC></a>Why am I going out of my way to not change objects when the language is obviously expecting me to?</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_OeVgQQywMt class=p_ident id=p_OeVgQQywMt></a>Because it helps me understand my programs. This is about complexity management again. When the objects in my system are fixed, stable things, I can consider operations on them in isolation—moving to Alice’s house from a given start state always produces the same new state. When objects change over time, that adds a whole new dimension of complexity to this kind of reasoning.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_/7pvpOtS4H class=p_ident id=p_/7pvpOtS4H></a>For a small system like the one we are building in this chapter, we could handle that bit of extra complexity. But the most important limit on what kind of systems we can build is how much we can understand. Anything that makes your code easier to understand makes it possible to build a more ambitious system.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_rFxLbiWTcZ class=p_ident id=p_rFxLbiWTcZ></a>Unfortunately, although understanding a system built on persistent data structures is easier, <em>designing</em> one, especially when your programming language isn’t helping, can be a little harder. We’ll look for opportunities to use persistent data structures in this book, but we’ll also be using changeable ones.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_jjSUPDU+nv class=h_ident id=h_jjSUPDU+nv></a>Simulation</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_P+FbwSex0d class=p_ident id=p_P+FbwSex0d></a>A delivery robot looks at the world and decides in which direction it wants to move. As such, we could say that a robot is a function that takes a <code>VillageState</code> object and returns the name of a nearby place.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_d4Z1LYlBJq class=p_ident id=p_d4Z1LYlBJq></a>Because we want robots to be able to remember things, so that they can make and execute plans, we also pass them their memory and allow them to return a new memory. Thus, the thing a robot returns is an object containing both the direction it wants to move in and a memory value that will be given back to it the next time it is called.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_PAmfnoCtiQ class=c_ident id=c_PAmfnoCtiQ></a><p class=cm-keyword>function</p> <p class=cm-def>runRobot</p>(<p class=cm-def>state</p>, <p class=cm-def>robot</p>, <p class=cm-def>memory</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>turn</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>;; <p class=cm-variable-2>turn</p><p class=cm-operator>++</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>state</p>.<p class=cm-property>parcels</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Done in ${</p><p class=cm-variable-2>turn</p><p class=cm-string-2>}</p> <p class=cm-string-2>turns`</p>); <p class=cm-keyword>break</p>; } <p class=cm-keyword>let</p> <p class=cm-def>action</p> <p class=cm-operator>=</p> <p class=cm-variable-2>robot</p>(<p class=cm-variable-2>state</p>, <p class=cm-variable-2>memory</p>); <p class=cm-variable-2>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>move</p>(<p class=cm-variable-2>action</p>.<p class=cm-property>direction</p>); <p class=cm-variable-2>memory</p> <p class=cm-operator>=</p> <p class=cm-variable-2>action</p>.<p class=cm-property>memory</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Moved to ${</p><p class=cm-variable-2>action</p>.<p class=cm-property>direction</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_J4CsIfXFJR class=p_ident id=p_J4CsIfXFJR></a>Consider what a robot has to do to “solve” a given state. It must pick up all parcels by visiting every location that has a parcel and deliver them by visiting every location that a parcel is addressed to, but only after picking up the parcel.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_g8y41m0ZTO class=p_ident id=p_g8y41m0ZTO></a>What is the dumbest strategy that could possibly work? The robot could just walk in a random direction every turn. That means, with great likelihood, it will eventually run into all parcels and then also at some point reach the place where they should be delivered.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_6Z1OgF/YEs class=p_ident id=p_6Z1OgF/YEs></a>Here’s what that could look like:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_eldzpwzhOB class=c_ident id=c_eldzpwzhOB></a><p class=cm-keyword>function</p> <p class=cm-def>randomPick</p>(<p class=cm-def>array</p>) { <p class=cm-keyword>let</p> <p class=cm-def>choice</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-variable-2>array</p>.<p class=cm-property>length</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>array</p>[<p class=cm-variable-2>choice</p>];\n} <p class=cm-keyword>function</p> <p class=cm-def>randomRobot</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>return</p> {<p class=cm-property>direction</p>: <p class=cm-variable>randomPick</p>(<p class=cm-variable>roadGraph</p>[<p class=cm-variable-2>state</p>.<p class=cm-property>place</p>])};\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_2Q7kJZqP+x class=p_ident id=p_2Q7kJZqP+x></a>Remember that <code>Math.random()</code> returns a number between zero and one—but always below one. Multiplying such a number by the length of an array and then applying <code>Math.floor</code> to it gives us a random index for the array.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_sb9lL4ZUdF class=p_ident id=p_sb9lL4ZUdF></a>Since this robot does not need to remember anything, it ignores its second argument (remember that JavaScript functions can be called with extra arguments without ill effects) and omits the <code>memory</code> property in its returned object.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_Q8hya8VsaG class=p_ident id=p_Q8hya8VsaG></a>To put this sophisticated robot to work, we’ll first need a way to create a new state with some parcels. A static method (written here by directly adding a property to the constructor) is a good place to put that functionality.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_oz9CFlpcci class=c_ident id=c_oz9CFlpcci></a><p class=cm-variable>VillageState</p>.<p class=cm-property>random</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>parcelCount</p> <p class=cm-operator>=</p> <p class=cm-number>5</p>) { <p class=cm-keyword>let</p> <p class=cm-def>parcels</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>parcelCount</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> <p class=cm-def>address</p> <p class=cm-operator>=</p> <p class=cm-variable>randomPick</p>(<p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable>roadGraph</p>)); <p class=cm-keyword>let</p> <p class=cm-def>place</p>; <p class=cm-keyword>do</p> { <p class=cm-variable-2>place</p> <p class=cm-operator>=</p> <p class=cm-variable>randomPick</p>(<p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable>roadGraph</p>)); } <p class=cm-keyword>while</p> (<p class=cm-variable-2>place</p> <p class=cm-operator>==</p> <p class=cm-variable-2>address</p>); <p class=cm-variable-2>parcels</p>.<p class=cm-property>push</p>({<p class=cm-property>place</p>, <p class=cm-property>address</p>}); } <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>VillageState</p>(<p class=cm-string>\"Post Office\"</p>, <p class=cm-variable-2>parcels</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_0gS69ySVJ4 class=p_ident id=p_0gS69ySVJ4></a>We don’t want any parcels that are sent from the same place that they are addressed to. For this reason, the <code>do</code> loop keeps picking new places when it gets one that’s equal to the address.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_eqF9VU0qYO class=p_ident id=p_eqF9VU0qYO></a>Let’s start up a virtual world.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_1SZDRlmBkn class=c_ident id=c_1SZDRlmBkn></a><p class=cm-variable>runRobot</p>(<p class=cm-variable>VillageState</p>.<p class=cm-property>random</p>(), <p class=cm-variable>randomRobot</p>);\n\n\n\n</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_BFu/OgG6OM class=p_ident id=p_BFu/OgG6OM></a>It takes the robot a lot of turns to deliver the parcels because it isn’t planning ahead very well. We’ll address that soon.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_2yLwjyXxuR class=p_ident id=p_2yLwjyXxuR></a>For a more pleasant perspective on the simulation, you can use the <code>runRobotAnimation</code> function that’s available in <a href=https://eloquentjavascript.net/code/#7>this chapter’s programming environment</a>. This runs the simulation, but instead of outputting text, it shows you the robot moving around the village map.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_jWQlJ73x2Z class=c_ident id=c_jWQlJ73x2Z></a><p class=cm-variable>runRobotAnimation</p>(<p class=cm-variable>VillageState</p>.<p class=cm-property>random</p>(), <p class=cm-variable>randomRobot</p>);</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_ID6/NPeNSk class=p_ident id=p_ID6/NPeNSk></a>The way <code>runRobotAnimation</code> is implemented will remain a mystery for now, but after you’ve read the <a href=https://eloquentjavascript.net/14_dom.html>later chapters</a> of this book, which discuss JavaScript integration in web browsers, you’ll be able to guess how it works.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_Lj40iImbWq class=h_ident id=h_Lj40iImbWq></a>The mail truck’s route</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_0ChAwB4vGA class=p_ident id=p_0ChAwB4vGA></a>We should be able to do a lot better than the random robot. An easy improvement would be to take a hint from the way real-world mail delivery works. If we find a route that passes all places in the village, the robot could run that route twice, at which point it is guaranteed to be done. Here is one such route (starting from the post office):</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_smZcG/wBFx class=c_ident id=c_smZcG/wBFx></a><p class=cm-keyword>const</p> <p class=cm-def>mailRoute</p> <p class=cm-operator>=</p> [ <p class=cm-string>\"Alice's House\"</p>, <p class=cm-string>\"Cabin\"</p>, <p class=cm-string>\"Alice's House\"</p>, <p class=cm-string>\"Bob's House\"</p>, <p class=cm-string>\"Town Hall\"</p>, <p class=cm-string>\"Daria's House\"</p>, <p class=cm-string>\"Ernie's House\"</p>, <p class=cm-string>\"Grete's House\"</p>, <p class=cm-string>\"Shop\"</p>, <p class=cm-string>\"Grete's House\"</p>, <p class=cm-string>\"Farm\"</p>, <p class=cm-string>\"Marketplace\"</p>, <p class=cm-string>\"Post Office\"</p>\n];</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_yjFG5x6/qC class=p_ident id=p_yjFG5x6/qC></a>To implement the route-following robot, we’ll need to make use of robot memory. The robot keeps the rest of its route in its memory and drops the first element every turn.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_FlV5rBgCYM class=c_ident id=c_FlV5rBgCYM></a><p class=cm-keyword>function</p> <p class=cm-def>routeRobot</p>(<p class=cm-def>state</p>, <p class=cm-def>memory</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>memory</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>memory</p> <p class=cm-operator>=</p> <p class=cm-variable>mailRoute</p>; } <p class=cm-keyword>return</p> {<p class=cm-property>direction</p>: <p class=cm-variable-2>memory</p>[<p class=cm-number>0</p>], <p class=cm-property>memory</p>: <p class=cm-variable-2>memory</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>)};\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_RfLBkheDsk class=p_ident id=p_RfLBkheDsk></a>This robot is a lot faster already. It’ll take a maximum of 26 turns (twice the 13-step route) but usually less.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_EkwtJVsUrQ class=c_ident id=c_EkwtJVsUrQ></a><p class=cm-variable>runRobotAnimation</p>(<p class=cm-variable>VillageState</p>.<p class=cm-property>random</p>(), <p class=cm-variable>routeRobot</p>, []);</pre> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_oTHZwtVfKc class=h_ident id=h_oTHZwtVfKc></a>Pathfinding</h2> <p><a href=https://eloquentjavascript.net/07_robot.html#p_zm+XpdJWqT class=p_ident id=p_zm+XpdJWqT></a>Still, I wouldn’t really call blindly following a fixed route intelligent behavior. The robot could work more efficiently if it adjusted its behavior to the actual work that needs to be done.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_I3lgtVYHps class=p_ident id=p_I3lgtVYHps></a>To do that, it has to be able to deliberately move toward a given parcel or toward the location where a parcel has to be delivered. Doing that, even when the goal is more than one move away, will require some kind of route-finding function.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_mZLFbUuvec class=p_ident id=p_mZLFbUuvec></a>The problem of finding a route through a graph is a typical <em>search problem</em>. We can tell whether a given solution (a route) is a valid solution, but we can’t directly compute the solution the way we could for 2 + 2. Instead, we have to keep creating potential solutions until we find one that works.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_RL7DngqE+u class=p_ident id=p_RL7DngqE+u></a>The number of possible routes through a graph is infinite. But when searching for a route from <em>A</em> to <em>B</em>, we are interested only in the ones that start at <em>A</em>. We also don’t care about routes that visit the same place twice—those are definitely not the most efficient route anywhere. So that cuts down on the number of routes that the route finder has to consider.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_6AAxzrcDxc class=p_ident id=p_6AAxzrcDxc></a>In fact, we are mostly interested in the <em>shortest</em> route. So we want to make sure we look at short routes before we look at longer ones. A good approach would be to “grow” routes from the starting point, exploring every reachable place that hasn’t been visited yet, until a route reaches the goal. That way, we’ll only explore routes that are potentially interesting, and we’ll find the shortest route (or one of the shortest routes, if there are more than one) to the goal.</p> <p id=findRoute><a href=https://eloquentjavascript.net/07_robot.html#p_cQEEfIe4SC class=p_ident id=p_cQEEfIe4SC></a>Here is a function that does this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_qT/+IETEgM class=c_ident id=c_qT/+IETEgM></a><p class=cm-keyword>function</p> <p class=cm-def>findRoute</p>(<p class=cm-def>graph</p>, <p class=cm-def>from</p>, <p class=cm-def>to</p>) { <p class=cm-keyword>let</p> <p class=cm-def>work</p> <p class=cm-operator>=</p> [{<p class=cm-property>at</p>: <p class=cm-variable-2>from</p>, <p class=cm-property>route</p>: []}]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>work</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>at</p>, <p class=cm-def>route</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>work</p>[<p class=cm-variable-2>i</p>]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>place</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>graph</p>[<p class=cm-variable-2>at</p>]) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>place</p> <p class=cm-operator>==</p> <p class=cm-variable-2>to</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>route</p>.<p class=cm-property>concat</p>(<p class=cm-variable-2>place</p>); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>work</p>.<p class=cm-property>some</p>(<p class=cm-def>w</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>w</p>.<p class=cm-property>at</p> <p class=cm-operator>==</p> <p class=cm-variable-2>place</p>)) { <p class=cm-variable-2>work</p>.<p class=cm-property>push</p>({<p class=cm-property>at</p>: <p class=cm-variable-2>place</p>, <p class=cm-property>route</p>: <p class=cm-variable-2>route</p>.<p class=cm-property>concat</p>(<p class=cm-variable-2>place</p>)});\n      }\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_IIOF6RnmzN class=p_ident id=p_IIOF6RnmzN></a>The exploring has to be done in the right order—the places that were reached first have to be explored first. We can’t immediately explore a place as soon as we reach it because that would mean places reached <em>from there</em> would also be explored immediately, and so on, even though there may be other, shorter paths that haven’t yet been explored.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_n9z76d0Ph0 class=p_ident id=p_n9z76d0Ph0></a>Therefore, the function keeps a <em>work list</em>. This is an array of places that should be explored next, along with the route that got us there. It starts with just the start position and an empty route.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_bijwRAV0uR class=p_ident id=p_bijwRAV0uR></a>The search then operates by taking the next item in the list and exploring that, which means all roads going from that place are looked at. If one of them is the goal, a finished route can be returned. Otherwise, if we haven’t looked at this place before, a new item is added to the list. If we have looked at it before, since we are looking at short routes first, we’ve found either a longer route to that place or one precisely as long as the existing one, and we don’t need to explore it.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_vMO6D/7FJS class=p_ident id=p_vMO6D/7FJS></a>You can visually imagine this as a web of known routes crawling out from the start location, growing evenly on all sides (but never tangling back into itself). As soon as the first thread reaches the goal location, that thread is traced back to the start, giving us our route.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_SIkZT2qVfg class=p_ident id=p_SIkZT2qVfg></a>Our code doesn’t handle the situation where there are no more work items on the work list because we know that our graph is <em>connected</em>, meaning that every location can be reached from all other locations. We’ll always be able to find a route between two points, and the search can’t fail.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_RJgvG9cgxq class=c_ident id=c_RJgvG9cgxq></a><p class=cm-keyword>function</p> <p class=cm-def>goalOrientedRobot</p>({<p class=cm-def>place</p>, <p class=cm-def>parcels</p>}, <p class=cm-def>route</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>route</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-keyword>let</p> <p class=cm-def>parcel</p> <p class=cm-operator>=</p> <p class=cm-variable-2>parcels</p>[<p class=cm-number>0</p>]; <p class=cm-keyword>if</p> (<p class=cm-variable-2>parcel</p>.<p class=cm-property>place</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>place</p>) { <p class=cm-variable-2>route</p> <p class=cm-operator>=</p> <p class=cm-variable>findRoute</p>(<p class=cm-variable>roadGraph</p>, <p class=cm-variable-2>place</p>, <p class=cm-variable-2>parcel</p>.<p class=cm-property>place</p>); } <p class=cm-keyword>else</p> { <p class=cm-variable-2>route</p> <p class=cm-operator>=</p> <p class=cm-variable>findRoute</p>(<p class=cm-variable>roadGraph</p>, <p class=cm-variable-2>place</p>, <p class=cm-variable-2>parcel</p>.<p class=cm-property>address</p>); } } <p class=cm-keyword>return</p> {<p class=cm-property>direction</p>: <p class=cm-variable-2>route</p>[<p class=cm-number>0</p>], <p class=cm-property>memory</p>: <p class=cm-variable-2>route</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>)};\n}</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_sH38lI2ayD class=p_ident id=p_sH38lI2ayD></a>This robot uses its memory value as a list of directions to move in, just like the route-following robot. Whenever that list is empty, it has to figure out what to do next. It takes the first undelivered parcel in the set and, if that parcel hasn’t been picked up yet, plots a route toward it. If the parcel <em>has</em> been picked up, it still needs to be delivered, so the robot creates a route toward the delivery address instead.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_AA5uJa4YUg class=p_ident id=p_AA5uJa4YUg></a>Let’s see how it does.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_yYuNlgXLX9 class=c_ident id=c_yYuNlgXLX9></a><p class=cm-variable>runRobotAnimation</p>(<p class=cm-variable>VillageState</p>.<p class=cm-property>random</p>(), <p class=cm-variable>goalOrientedRobot</p>, []);</pre> <p><a href=https://eloquentjavascript.net/07_robot.html#p_iSOwvxhYMe class=p_ident id=p_iSOwvxhYMe></a>This robot usually finishes the task of delivering 5 parcels in about 16 turns. That’s slightly better than <code>routeRobot</code> but still definitely not optimal.</p> <h2><a href=https://eloquentjavascript.net/07_robot.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/07_robot.html#i_JrK0ADjuHH class=i_ident id=i_JrK0ADjuHH></a>Measuring a robot</h3> <p><a href=https://eloquentjavascript.net/07_robot.html#p_3o3bz0G4V0 class=p_ident id=p_3o3bz0G4V0></a>It’s hard to objectively compare robots by just letting them solve a few scenarios. Maybe one robot just happened to get easier tasks or the kind of tasks that it is good at, whereas the other didn’t.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_n9CHE7/Lua class=p_ident id=p_n9CHE7/Lua></a>Write a function <code>compareRobots</code> that takes two robots (and their starting memory). It should generate 100 tasks and let each of the robots solve each of these tasks. When done, it should output the average number of steps each robot took per task.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_O3TPJDzE3I class=p_ident id=p_O3TPJDzE3I></a>For the sake of fairness, make sure you give each task to both robots, rather than generating different tasks per robot.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_Pif/U+hwqO class=c_ident id=c_Pif/U+hwqO></a><p class=cm-keyword>function</p> <p class=cm-def>compareRobots</p>(<p class=cm-def>robot1</p>, <p class=cm-def>memory1</p>, <p class=cm-def>robot2</p>, <p class=cm-def>memory2</p>) { } <p class=cm-variable>compareRobots</p>(<p class=cm-variable>routeRobot</p>, [], <p class=cm-variable>goalOrientedRobot</p>, []);</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/07_robot.html#p_nI/WAc+Vc2 class=p_ident id=p_nI/WAc+Vc2></a>You’ll have to write a variant of the <code>runRobot</code> function that, instead of logging the events to the console, returns the number of steps the robot took to complete the task.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_49cSkm+1VL class=p_ident id=p_49cSkm+1VL></a>Your measurement function can then, in a loop, generate new states and count the steps each of the robots takes. When it has generated enough measurements, it can use <code>console.log</code> to output the average for each robot, which is the total number of steps taken divided by the number of measurements.</p> </div></div> <h3><a href=https://eloquentjavascript.net/07_robot.html#i_VbBsQJ1lp6 class=i_ident id=i_VbBsQJ1lp6></a>Robot efficiency</h3> <p><a href=https://eloquentjavascript.net/07_robot.html#p_MjKPE+EDdI class=p_ident id=p_MjKPE+EDdI></a>Can you write a robot that finishes the delivery task faster than <code>goalOrientedRobot</code>? If you observe that robot’s behavior, what obviously stupid things does it do? How could those be improved?</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_qgKBJqRg+r class=p_ident id=p_qgKBJqRg+r></a>If you solved the previous exercise, you might want to use your <code>compareRobots</code> function to verify whether you improved the robot.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_kgk5f055Ej class=c_ident id=c_kgk5f055Ej></a> <p class=cm-variable>runRobotAnimation</p>(<p class=cm-variable>VillageState</p>.<p class=cm-property>random</p>(), <p class=cm-variable>yourRobot</p>, <p class=cm-variable>memory</p>);</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/07_robot.html#p_2jYz1tpdHQ class=p_ident id=p_2jYz1tpdHQ></a>The main limitation of <code>goalOrientedRobot</code> is that it considers only one parcel at a time. It will often walk back and forth across the village because the parcel it happens to be looking at happens to be at the other side of the map, even if there are others much closer.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_+dCvWOpolq class=p_ident id=p_+dCvWOpolq></a>One possible solution would be to compute routes for all packages and then take the shortest one. Even better results can be obtained, if there are multiple shortest routes, by preferring the ones that go to pick up a package instead of delivering a package.</p> </div></div> <h3><a href=https://eloquentjavascript.net/07_robot.html#i_s+ntyh5xrm class=i_ident id=i_s+ntyh5xrm></a>Persistent group</h3> <p><a href=https://eloquentjavascript.net/07_robot.html#p_2U3yafqdvH class=p_ident id=p_2U3yafqdvH></a>Most data structures provided in a standard JavaScript environment aren’t very well suited for persistent use. Arrays have <code>slice</code> and <code>concat</code> methods, which allow us to easily create new arrays without damaging the old one. But <code>Set</code>, for example, has no methods for creating a new set with an item added or removed.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_GJFOUv4fQp class=p_ident id=p_GJFOUv4fQp></a>Write a new class <code>PGroup</code>, similar to the <code>Group</code> class from <a href=https://eloquentjavascript.net/06_object.html#groups>Chapter 6</a>, which stores a set of values. Like <code>Group</code>, it has <code>add</code>, <code>delete</code>, and <code>has</code> methods.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_CkpHJcowhH class=p_ident id=p_CkpHJcowhH></a>Its <code>add</code> method, however, should return a <em>new</em> <code>PGroup</code> instance with the given member added and leave the old one unchanged. Similarly, <code>delete</code> creates a new instance without a given member.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_BF2ns3kTIW class=p_ident id=p_BF2ns3kTIW></a>The class should work for values of any type, not just strings. It does <em>not</em> have to be efficient when used with large amounts of values.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_WVaFt53GdV class=p_ident id=p_WVaFt53GdV></a>The constructor shouldn’t be part of the class’s interface (though you’ll definitely want to use it internally). Instead, there is an empty instance, <code>PGroup.empty</code>, that can be used as a starting value.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_pV/91/QIt2 class=p_ident id=p_pV/91/QIt2></a>Why do you need only one <code>PGroup.empty</code> value, rather than having a function that creates a new, empty map every time?</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/07_robot.html#c_KN+ky/iMYB class=c_ident id=c_KN+ky/iMYB></a><p class=cm-keyword>class</p> <p class=cm-def>PGroup</p> { } <p class=cm-keyword>let</p> <p class=cm-def>a</p> <p class=cm-operator>=</p> <p class=cm-variable>PGroup</p>.<p class=cm-property>empty</p>.<p class=cm-property>add</p>(<p class=cm-string>\"a\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>ab</p> <p class=cm-operator>=</p> <p class=cm-variable>a</p>.<p class=cm-property>add</p>(<p class=cm-string>\"b\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>b</p> <p class=cm-operator>=</p> <p class=cm-variable>ab</p>.<p class=cm-property>delete</p>(<p class=cm-string>\"a\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>b</p>.<p class=cm-property>has</p>(<p class=cm-string>\"b\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>a</p>.<p class=cm-property>has</p>(<p class=cm-string>\"b\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>b</p>.<p class=cm-property>has</p>(<p class=cm-string>\"a\"</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/07_robot.html#p_wJCTKfvlWG class=p_ident id=p_wJCTKfvlWG></a>The most convenient way to represent the set of member values is still as an array since arrays are easy to copy.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_q2TqU7jyKB class=p_ident id=p_q2TqU7jyKB></a>When a value is added to the group, you can create a new group with a copy of the original array that has the value added (for example, using <code>concat</code>). When a value is deleted, you filter it from the array.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_EbZVh5gTfE class=p_ident id=p_EbZVh5gTfE></a>The class’s constructor can take such an array as argument and store it as the instance’s (only) property. This array is never updated.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_oamLkQ+NjT class=p_ident id=p_oamLkQ+NjT></a>To add a property (<code>empty</code>) to a constructor that is not a method, you have to add it to the constructor after the class definition, as a regular property.</p> <p><a href=https://eloquentjavascript.net/07_robot.html#p_no2z35iuBs class=p_ident id=p_no2z35iuBs></a>You need only one <code>empty</code> instance because all empty groups are the same and instances of the class don’t change. You can create many different groups from that single empty group without affecting it.</p> </div></div><nav><a href=https://eloquentjavascript.net/06_object.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/08_error.html>▶</a></nav>\n</article><hr><h4>Page 4</h4><article score=681.205>\n<nav><a href=https://eloquentjavascript.net/07_robot.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/09_regexp.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/08_error.html#p_tsWlII94Rs class=p_ident id=p_tsWlII94Rs></a>Debugging is twice as hard as writing the code in the first place. Therefore, if you write the code as cleverly as possible, you are, by definition, not smart enough to debug it.</p> <footer>Brian Kernighan and P.J. Plauger, <cite>The Elements of Programming Style</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a collection of bugs\" src=https://eloquentjavascript.net/img/chapter_picture_8.jpg></figure> <p><a href=https://eloquentjavascript.net/08_error.html#p_O+MttnhYVC class=p_ident id=p_O+MttnhYVC></a>Flaws in computer programs are usually called <em>bugs</em>. It makes programmers feel good to imagine them as little things that just happen to crawl into our work. In reality, of course, we put them there ourselves.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_bcWk0EwGpY class=p_ident id=p_bcWk0EwGpY></a>If a program is crystallized thought, you can roughly categorize bugs into those caused by the thoughts being confused and those caused by mistakes introduced while converting a thought to code. The former type is generally harder to diagnose and fix than the latter.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_ibhqsOZvUn class=h_ident id=h_ibhqsOZvUn></a>Language</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_ye1ml09vBV class=p_ident id=p_ye1ml09vBV></a>Many mistakes could be pointed out to us automatically by the computer, if it knew enough about what we’re trying to do. But here JavaScript’s looseness is a hindrance. Its concept of bindings and properties is vague enough that it will rarely catch typos before actually running the program. And even then, it allows you to do some clearly nonsensical things without complaint, such as computing <code>true * \"monkey\"</code>.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_EcSg7P4I9E class=p_ident id=p_EcSg7P4I9E></a>There are some things that JavaScript does complain about. Writing a program that does not follow the language’s grammar will immediately make the computer complain. Other things, such as calling something that’s not a function or looking up a property on an undefined value, will cause an error to be reported when the program tries to perform the action.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_M/fMASXkeH class=p_ident id=p_M/fMASXkeH></a>But often, your nonsense computation will merely produce <code>NaN</code> (not a number) or an undefined value, while the program happily continues, convinced that it’s doing something meaningful. The mistake will manifest itself only later, after the bogus value has traveled through several functions. It might not trigger an error at all but silently cause the program’s output to be wrong. Finding the source of such problems can be difficult.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_LaAYmHSV12 class=p_ident id=p_LaAYmHSV12></a>The process of finding mistakes—bugs—in programs is called <em>debugging</em>.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_u1jlTq3i42 class=h_ident id=h_u1jlTq3i42></a>Strict mode</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_WJCaiNx5iy class=p_ident id=p_WJCaiNx5iy></a>JavaScript can be made a <em>little</em> stricter by enabling <em>strict mode</em>. This is done by putting the string <code>\"use strict\"</code> at the top of a file or a function body. Here’s an example:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_tKCBneE0vw class=c_ident id=c_tKCBneE0vw></a><p class=cm-keyword>function</p> <p class=cm-def>canYouSpotTheProblem</p>() { <p class=cm-string>\"use strict\"</p>; <p class=cm-keyword>for</p> (<p class=cm-variable>counter</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable>counter</p> <p class=cm-operator>&lt;</p> <p class=cm-number>10</p>; <p class=cm-variable>counter</p><p class=cm-operator>++</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Happy happy\"</p>); }\n} <p class=cm-variable>canYouSpotTheProblem</p>();\n</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_9RL+1s9Y4+ class=p_ident id=p_9RL+1s9Y4+></a>Normally, when you forget to put <code>let</code> in front of your binding, as with <code>counter</code> in the example, JavaScript quietly creates a global binding and uses that. In strict mode, an error is reported instead. This is very helpful. It should be noted, though, that this doesn’t work when the binding in question already exists as a global binding. In that case, the loop will still quietly overwrite the value of the binding.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_WqXHKWNRd1 class=p_ident id=p_WqXHKWNRd1></a>Another change in strict mode is that the <code>this</code> binding holds the value <code>undefined</code> in functions that are not called as methods. When making such a call outside of strict mode, <code>this</code> refers to the global scope object, which is an object whose properties are the global bindings. So if you accidentally call a method or constructor incorrectly in strict mode, JavaScript will produce an error as soon as it tries to read something from <code>this</code>, rather than happily writing to the global scope.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_eZSU5aTSD4 class=p_ident id=p_eZSU5aTSD4></a>For example, consider the following code, which calls a constructor function without the <code>new</code> keyword so that its <code>this</code> will <em>not</em> refer to a newly constructed object:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_FPKrb2F1C3 class=c_ident id=c_FPKrb2F1C3></a><p class=cm-keyword>function</p> <p class=cm-def>Person</p>(<p class=cm-def>name</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>name</p> <p class=cm-operator>=</p> <p class=cm-variable-2>name</p>; }\n<p class=cm-keyword>let</p> <p class=cm-def>ferdinand</p> <p class=cm-operator>=</p> <p class=cm-variable>Person</p>(<p class=cm-string>\"Ferdinand\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>name</p>);\n</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_Tv3LlrrZaj class=p_ident id=p_Tv3LlrrZaj></a>So the bogus call to <code>Person</code> succeeded but returned an undefined value and created the global binding <code>name</code>. In strict mode, the result is different.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_HFy5dGOOh4 class=c_ident id=c_HFy5dGOOh4></a><p class=cm-string>\"use strict\"</p>;\n<p class=cm-keyword>function</p> <p class=cm-def>Person</p>(<p class=cm-def>name</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>name</p> <p class=cm-operator>=</p> <p class=cm-variable-2>name</p>; }\n<p class=cm-keyword>let</p> <p class=cm-def>ferdinand</p> <p class=cm-operator>=</p> <p class=cm-variable>Person</p>(<p class=cm-string>\"Ferdinand\"</p>); \n</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_0eYPyoGi1l class=p_ident id=p_0eYPyoGi1l></a>We are immediately told that something is wrong. This is helpful.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_WGJIyAOZ/i class=p_ident id=p_WGJIyAOZ/i></a>Fortunately, constructors created with the <code>class</code> notation will always complain if they are called without <code>new</code>, making this less of a problem even in non-strict mode.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_qlYTT6nRD4 class=p_ident id=p_qlYTT6nRD4></a>Strict mode does a few more things. It disallows giving a function multiple parameters with the same name and removes certain problematic language features entirely (such as the <code>with</code> statement, which is so wrong it is not further discussed in this book).</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_kIUErMqROW class=p_ident id=p_kIUErMqROW></a>In short, putting <code>\"use strict\"</code> at the top of your program rarely hurts and might help you spot a problem.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_k7niieKEJG class=h_ident id=h_k7niieKEJG></a>Types</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_YhTIyNZyz8 class=p_ident id=p_YhTIyNZyz8></a>Some languages want to know the types of all your bindings and expressions before even running a program. They will tell you right away when a type is used in an inconsistent way. JavaScript considers types only when actually running the program, and even there often tries to implicitly convert values to the type it expects, so it’s not much help.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_YdtQydcPrv class=p_ident id=p_YdtQydcPrv></a>Still, types provide a useful framework for talking about programs. A lot of mistakes come from being confused about the kind of value that goes into or comes out of a function. If you have that information written down, you’re less likely to get confused.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_YSuG1qtqyR class=p_ident id=p_YSuG1qtqyR></a>You could add a comment like the following before the <code>goalOrientedRobot</code> function from the previous chapter to describe its type:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_30eJTz3eQP class=c_ident id=c_30eJTz3eQP></a>\n<p class=cm-keyword>function</p> <p class=cm-def>goalOrientedRobot</p>(<p class=cm-def>state</p>, <p class=cm-def>memory</p>) {\n  \n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_wRx2hJtLds class=p_ident id=p_wRx2hJtLds></a>There are a number of different conventions for annotating JavaScript programs with types.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_K+Rg+L+z0T class=p_ident id=p_K+Rg+L+z0T></a>One thing about types is that they need to introduce their own complexity to be able to describe enough code to be useful. What do you think would be the type of the <code>randomPick</code> function that returns a random element from an array? You’d need to introduce a <em>type variable</em>, <em>T</em>, which can stand in for any type, so that you can give <code>randomPick</code> a type like <code>([T]) → T</code> (function from an array of <em>T</em>s to a <em>T</em>).</p> <p id=typing><a href=https://eloquentjavascript.net/08_error.html#p_eztjw3zFDU class=p_ident id=p_eztjw3zFDU></a>When the types of a program are known, it is possible for the computer to <em>check</em> them for you, pointing out mistakes before the program is run. There are several JavaScript dialects that add types to the language and check them. The most popular one is called <a href=https://www.typescriptlang.org/ >TypeScript</a>. If you are interested in adding more rigor to your programs, I recommend you give it a try.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_t8esQrTIP9 class=p_ident id=p_t8esQrTIP9></a>In this book, we’ll continue using raw, dangerous, untyped JavaScript code.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_CCCzKyBrc1 class=h_ident id=h_CCCzKyBrc1></a>Testing</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_cfHj2WfM1O class=p_ident id=p_cfHj2WfM1O></a>If the language is not going to do much to help us find mistakes, we’ll have to find them the hard way: by running the program and seeing whether it does the right thing.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_8W1dLTf8k6 class=p_ident id=p_8W1dLTf8k6></a>Doing this by hand, again and again, is a really bad idea. Not only is it annoying, it also tends to be ineffective since it takes too much time to exhaustively test everything every time you make a change.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_ngk+1LWoAU class=p_ident id=p_ngk+1LWoAU></a>Computers are good at repetitive tasks, and testing is the ideal repetitive task. Automated testing is the process of writing a program that tests another program. Writing tests is a bit more work than testing manually, but once you’ve done it, you gain a kind of superpower: it takes you only a few seconds to verify that your program still behaves properly in all the situations you wrote tests for. When you break something, you’ll immediately notice, rather than randomly running into it at some later time.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_S/z0iwnHlS class=p_ident id=p_S/z0iwnHlS></a>Tests usually take the form of little labeled programs that verify some aspect of your code. For example, a set of tests for the (standard, probably already tested by someone else) <code>toUpperCase</code> method might look like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_WrGyqyPbp3 class=c_ident id=c_WrGyqyPbp3></a><p class=cm-keyword>function</p> <p class=cm-def>test</p>(<p class=cm-def>label</p>, <p class=cm-def>body</p>) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>body</p>()) <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Failed: ${</p><p class=cm-variable-2>label</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n} <p class=cm-variable>test</p>(<p class=cm-string>\"convert Latin text to uppercase\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-string>\"hello\"</p>.<p class=cm-property>toUpperCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"HELLO\"</p>;\n});\n<p class=cm-variable>test</p>(<p class=cm-string>\"convert Greek text to uppercase\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-string>\"Χαίρετε\"</p>.<p class=cm-property>toUpperCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"ΧΑΊΡΕΤΕ\"</p>;\n});\n<p class=cm-variable>test</p>(<p class=cm-string>\"don't convert case-less characters\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-string>\"مرحبا\"</p>.<p class=cm-property>toUpperCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"مرحبا\"</p>;\n});</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_Gyas+RfY6l class=p_ident id=p_Gyas+RfY6l></a>Writing tests like this tends to produce rather repetitive, awkward code. Fortunately, there exist pieces of software that help you build and run collections of tests (<em>test suites</em>) by providing a language (in the form of functions and methods) suited to expressing tests and by outputting informative information when a test fails. These are usually called <em>test runners</em>.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_zmvP6RI0eK class=p_ident id=p_zmvP6RI0eK></a>Some code is easier to test than other code. Generally, the more external objects that the code interacts with, the harder it is to set up the context in which to test it. The style of programming shown in the <a href=https://eloquentjavascript.net/07_robot.html>previous chapter</a>, which uses self-contained persistent values rather than changing objects, tends to be easy to test.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_iVsnyIAWUT class=h_ident id=h_iVsnyIAWUT></a>Debugging</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_5mME8LB07m class=p_ident id=p_5mME8LB07m></a>Once you notice there is something wrong with your program because it misbehaves or produces errors, the next step is to figure out <em>what</em> the problem is.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_CJKevweHV6 class=p_ident id=p_CJKevweHV6></a>Sometimes it is obvious. The error message will point at a specific line of your program, and if you look at the error description and that line of code, you can often see the problem.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_5SwXZX1qh1 class=p_ident id=p_5SwXZX1qh1></a>But not always. Sometimes the line that triggered the problem is simply the first place where a flaky value produced elsewhere gets used in an invalid way. If you have been solving the exercises in earlier chapters, you will probably have already experienced such situations.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_rsq5hJyXKX class=p_ident id=p_rsq5hJyXKX></a>The following example program tries to convert a whole number to a string in a given base (decimal, binary, and so on) by repeatedly picking out the last digit and then dividing the number to get rid of this digit. But the strange output that it currently produces suggests that it has a bug.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_8tOR9x4PzT class=c_ident id=c_8tOR9x4PzT></a><p class=cm-keyword>function</p> <p class=cm-def>numberToString</p>(<p class=cm-def>n</p>, <p class=cm-def>base</p> <p class=cm-operator>=</p> <p class=cm-number>10</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>, <p class=cm-def>sign</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>n</p> <p class=cm-operator>&lt;</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>sign</p> <p class=cm-operator>=</p> <p class=cm-string>\"-\"</p>; <p class=cm-variable-2>n</p> <p class=cm-operator>=</p> <p class=cm-operator>-</p><p class=cm-variable-2>n</p>; } <p class=cm-keyword>do</p> { <p class=cm-variable-2>result</p> <p class=cm-operator>=</p> <p class=cm-variable>String</p>(<p class=cm-variable-2>n</p> <p class=cm-operator>%</p> <p class=cm-variable-2>base</p>) <p class=cm-operator>+</p> <p class=cm-variable-2>result</p>; <p class=cm-variable-2>n</p> <p class=cm-operator>/=</p> <p class=cm-variable-2>base</p>; } <p class=cm-keyword>while</p> (<p class=cm-variable-2>n</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>sign</p> <p class=cm-operator>+</p> <p class=cm-variable-2>result</p>;\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>numberToString</p>(<p class=cm-number>13</p>, <p class=cm-number>10</p>));\n</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_KiDfjUS51F class=p_ident id=p_KiDfjUS51F></a>Even if you see the problem already, pretend for a moment that you don’t. We know that our program is malfunctioning, and we want to find out why.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_2OJsjnmKOW class=p_ident id=p_2OJsjnmKOW></a>This is where you must resist the urge to start making random changes to the code to see whether that makes it better. Instead, <em>think</em>. Analyze what is happening and come up with a theory of why it might be happening. Then, make additional observations to test this theory—or, if you don’t yet have a theory, make additional observations to help you come up with one.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_HuAniqpAd5 class=p_ident id=p_HuAniqpAd5></a>Putting a few strategic <code>console.log</code> calls into the program is a good way to get additional information about what the program is doing. In this case, we want <code>n</code> to take the values <code>13</code>, <code>1</code>, and then <code>0</code>. Let’s write out its value at the start of the loop.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_nB/OeL8UNa class=c_ident id=c_nB/OeL8UNa></a>13\n1.3\n0.13\n0.013\n…\n1.5e-323</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_I+PNN6aJ0e class=p_ident id=p_I+PNN6aJ0e></a><em>Right</em>. Dividing 13 by 10 does not produce a whole number. Instead of <code>n /= base</code>, what we actually want is <code>n = Math.<wbr>floor(n /<wbr> base)</code> so that the number is properly “shifted” to the right.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_0eFcPpir7M class=p_ident id=p_0eFcPpir7M></a>An alternative to using <code>console.log</code> to peek into the program’s behavior is to use the <em>debugger</em> capabilities of your browser. Browsers come with the ability to set a <em>breakpoint</em> on a specific line of your code. When the execution of the program reaches a line with a breakpoint, it is paused, and you can inspect the values of bindings at that point. I won’t go into details, as debuggers differ from browser to browser, but look in your browser’s developer tools or search the Web for more information.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_h2R9jlfw7o class=p_ident id=p_h2R9jlfw7o></a>Another way to set a breakpoint is to include a <code>debugger</code> statement (consisting of simply that keyword) in your program. If the developer tools of your browser are active, the program will pause whenever it reaches such a statement.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_iwwPbaBjJD class=h_ident id=h_iwwPbaBjJD></a>Error propagation</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_cHc7tL2ujS class=p_ident id=p_cHc7tL2ujS></a>Not all problems can be prevented by the programmer, unfortunately. If your program communicates with the outside world in any way, it is possible to get malformed input, to become overloaded with work, or to have the network fail.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_zy372pQBzA class=p_ident id=p_zy372pQBzA></a>If you’re programming only for yourself, you can afford to just ignore such problems until they occur. But if you build something that is going to be used by anybody else, you usually want the program to do better than just crash. Sometimes the right thing to do is take the bad input in stride and continue running. In other cases, it is better to report to the user what went wrong and then give up. But in either situation, the program has to actively do something in response to the problem.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_ZrDi3JVFsJ class=p_ident id=p_ZrDi3JVFsJ></a>Say you have a function <code>promptNumber</code> that asks the user for a number and returns it. What should it return if the user inputs “orange”?</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_ee4d/K1Bh5 class=p_ident id=p_ee4d/K1Bh5></a>One option is to make it return a special value. Common choices for such values are <code>null</code>, <code>undefined</code>, or -1.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_ssOc2pf47/ class=c_ident id=c_ssOc2pf47/ ></a><p class=cm-keyword>function</p> <p class=cm-def>promptNumber</p>(<p class=cm-def>question</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-variable>Number</p>(<p class=cm-variable>prompt</p>(<p class=cm-variable-2>question</p>)); <p class=cm-keyword>if</p> (<p class=cm-variable>Number</p>.<p class=cm-property>isNaN</p>(<p class=cm-variable-2>result</p>)) <p class=cm-keyword>return</p> <p class=cm-atom>null</p>; <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> <p class=cm-variable-2>result</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>promptNumber</p>(<p class=cm-string>\"How many trees do you see?\"</p>));</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_8/CuHXN0/U class=p_ident id=p_8/CuHXN0/U></a>Now any code that calls <code>promptNumber</code> must check whether an actual number was read and, failing that, must somehow recover—maybe by asking again or by filling in a default value. Or it could again return a special value to <em>its</em> caller to indicate that it failed to do what it was asked.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_5MsTIzo4xf class=p_ident id=p_5MsTIzo4xf></a>In many situations, mostly when errors are common and the caller should be explicitly taking them into account, returning a special value is a good way to indicate an error. It does, however, have its downsides. First, what if the function can already return every possible kind of value? In such a function, you’ll have to do something like wrap the result in an object to be able to distinguish success from failure.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_aQW8dfZcRx class=c_ident id=c_aQW8dfZcRx></a><p class=cm-keyword>function</p> <p class=cm-def>lastElement</p>(<p class=cm-def>array</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>array</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-keyword>return</p> {<p class=cm-property>failed</p>: <p class=cm-atom>true</p>}; } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> {<p class=cm-property>element</p>: <p class=cm-variable-2>array</p>[<p class=cm-variable-2>array</p>.<p class=cm-property>length</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>]};\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_+E9fllIVBt class=p_ident id=p_+E9fllIVBt></a>The second issue with returning special values is that it can lead to awkward code. If a piece of code calls <code>promptNumber</code> 10 times, it has to check 10 times whether <code>null</code> was returned. And if its response to finding <code>null</code> is to simply return <code>null</code> itself, callers of the function will in turn have to check for it, and so on.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_zT3755/aOp class=h_ident id=h_zT3755/aOp></a>Exceptions</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_ZBsTKhGA4i class=p_ident id=p_ZBsTKhGA4i></a>When a function cannot proceed normally, what we would <em>like</em> to do is just stop what we are doing and immediately jump to a place that knows how to handle the problem. This is what <em>exception handling</em> does.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_kjXcPy8jGf class=p_ident id=p_kjXcPy8jGf></a>Exceptions are a mechanism that makes it possible for code that runs into a problem to <em>raise</em> (or <em>throw</em>) an exception. An exception can be any value. Raising one somewhat resembles a super-charged return from a function: it jumps out of not just the current function but also its callers, all the way down to the first call that started the current execution. This is called <em>unwinding the stack</em>. You may remember the stack of function calls that was mentioned in <a href=https://eloquentjavascript.net/03_functions.html#stack>Chapter 3</a>. An exception zooms down this stack, throwing away all the call contexts it encounters.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_giUX2OynLm class=p_ident id=p_giUX2OynLm></a>If exceptions always zoomed right down to the bottom of the stack, they would not be of much use. They’d just provide a novel way to blow up your program. Their power lies in the fact that you can set “obstacles” along the stack to <em>catch</em> the exception as it is zooming down. Once you’ve caught an exception, you can do something with it to address the problem and then continue to run the program.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_DQmDywMub9 class=p_ident id=p_DQmDywMub9></a>Here’s an example:</p> <pre class=\"cm-s-default snippet\" id=look><a href=https://eloquentjavascript.net/08_error.html#c_0VA94HjY2e class=c_ident id=c_0VA94HjY2e></a><p class=cm-keyword>function</p> <p class=cm-def>promptDirection</p>(<p class=cm-def>question</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-variable>prompt</p>(<p class=cm-variable-2>question</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>result</p>.<p class=cm-property>toLowerCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"left\"</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"L\"</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>result</p>.<p class=cm-property>toLowerCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"right\"</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"R\"</p>; <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Invalid direction: \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>result</p>);\n} <p class=cm-keyword>function</p> <p class=cm-def>look</p>() { <p class=cm-keyword>if</p> (<p class=cm-variable>promptDirection</p>(<p class=cm-string>\"Which way?\"</p>) <p class=cm-operator>==</p> <p class=cm-string>\"L\"</p>) { <p class=cm-keyword>return</p> <p class=cm-string>\"a house\"</p>; } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> <p class=cm-string>\"two angry bears\"</p>; }\n} <p class=cm-keyword>try</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You see\"</p>, <p class=cm-variable>look</p>());\n} <p class=cm-keyword>catch</p> (<p class=cm-def>error</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Something went wrong: \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>error</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_bbpj24fusK class=p_ident id=p_bbpj24fusK></a>The <code>throw</code> keyword is used to raise an exception. Catching one is done by wrapping a piece of code in a <code>try</code> block, followed by the keyword <code>catch</code>. When the code in the <code>try</code> block causes an exception to be raised, the <code>catch</code> block is evaluated, with the name in parentheses bound to the exception value. After the <code>catch</code> block finishes—or if the <code>try</code> block finishes without problems—the program proceeds beneath the entire <code>try/catch</code> statement.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_lP6PP0CCrB class=p_ident id=p_lP6PP0CCrB></a>In this case, we used the <code>Error</code> constructor to create our exception value. This is a standard JavaScript constructor that creates an object with a <code>message</code> property. In most JavaScript environments, instances of this constructor also gather information about the call stack that existed when the exception was created, a so-called <em>stack trace</em>. This information is stored in the <code>stack</code> property and can be helpful when trying to debug a problem: it tells us the function where the problem occurred and which functions made the failing call.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_BYCPINQ0h5 class=p_ident id=p_BYCPINQ0h5></a>Note that the <code>look</code> function completely ignores the possibility that <code>promptDirection</code> might go wrong. This is the big advantage of exceptions: error-handling code is necessary only at the point where the error occurs and at the point where it is handled. The functions in between can forget all about it.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_deFX/IC34y class=p_ident id=p_deFX/IC34y></a>Well, almost...</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_cgoP7o2fe9 class=h_ident id=h_cgoP7o2fe9></a>Cleaning up after exceptions</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_lHGW1D9KYW class=p_ident id=p_lHGW1D9KYW></a>The effect of an exception is another kind of control flow. Every action that might cause an exception, which is pretty much every function call and property access, might cause control to suddenly leave your code.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_Mqr7VzgCYa class=p_ident id=p_Mqr7VzgCYa></a>This means when code has several side effects, even if its “regular” control flow looks like they’ll always all happen, an exception might prevent some of them from taking place.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_V7nPGHDnR1 class=p_ident id=p_V7nPGHDnR1></a>Here is some really bad banking code.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_e3XosnGG47 class=c_ident id=c_e3XosnGG47></a><p class=cm-keyword>const</p> <p class=cm-def>accounts</p> <p class=cm-operator>=</p> { <p class=cm-property>a</p>: <p class=cm-number>100</p>, <p class=cm-property>b</p>: <p class=cm-number>0</p>, <p class=cm-property>c</p>: <p class=cm-number>20</p>\n}; <p class=cm-keyword>function</p> <p class=cm-def>getAccount</p>() { <p class=cm-keyword>let</p> <p class=cm-def>accountName</p> <p class=cm-operator>=</p> <p class=cm-variable>prompt</p>(<p class=cm-string>\"Enter an account name\"</p>); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable>accounts</p>.<p class=cm-property>hasOwnProperty</p>(<p class=cm-variable-2>accountName</p>)) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string-2>`No such account: ${</p><p class=cm-variable-2>accountName</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>accountName</p>;\n} <p class=cm-keyword>function</p> <p class=cm-def>transfer</p>(<p class=cm-def>from</p>, <p class=cm-def>amount</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>accounts</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>&lt;</p> <p class=cm-variable-2>amount</p>) <p class=cm-keyword>return</p>; <p class=cm-variable>accounts</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>-=</p> <p class=cm-variable-2>amount</p>; <p class=cm-variable>accounts</p>[<p class=cm-variable>getAccount</p>()] <p class=cm-operator>+=</p> <p class=cm-variable-2>amount</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_lj3bgLcO/p class=p_ident id=p_lj3bgLcO/p></a>The <code>transfer</code> function transfers a sum of money from a given account to another, asking for the name of the other account in the process. If given an invalid account name, <code>getAccount</code> throws an exception.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_IvzAvOGwRo class=p_ident id=p_IvzAvOGwRo></a>But <code>transfer</code> <em>first</em> removes the money from the account and <em>then</em> calls <code>getAccount</code> before it adds it to another account. If it is broken off by an exception at that point, it’ll just make the money disappear.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_vSkNwpOGmb class=p_ident id=p_vSkNwpOGmb></a>That code could have been written a little more intelligently, for example by calling <code>getAccount</code> before it starts moving money around. But often problems like this occur in more subtle ways. Even functions that don’t look like they will throw an exception might do so in exceptional circumstances or when they contain a programmer mistake.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_6ijkWjygkN class=p_ident id=p_6ijkWjygkN></a>One way to address this is to use fewer side effects. Again, a programming style that computes new values instead of changing existing data helps. If a piece of code stops running in the middle of creating a new value, no one ever sees the half-finished value, and there is no problem.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_lhrnmP99dZ class=p_ident id=p_lhrnmP99dZ></a>But that isn’t always practical. So there is another feature that <code>try</code> statements have. They may be followed by a <code>finally</code> block either instead of or in addition to a <code>catch</code> block. A <code>finally</code> block says “no matter <em>what</em> happens, run this code after trying to run the code in the <code>try</code> block.”</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_brWpzDAy4+ class=c_ident id=c_brWpzDAy4+></a><p class=cm-keyword>function</p> <p class=cm-def>transfer</p>(<p class=cm-def>from</p>, <p class=cm-def>amount</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>accounts</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>&lt;</p> <p class=cm-variable-2>amount</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>let</p> <p class=cm-def>progress</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>try</p> { <p class=cm-variable>accounts</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>-=</p> <p class=cm-variable-2>amount</p>; <p class=cm-variable-2>progress</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>; <p class=cm-variable>accounts</p>[<p class=cm-variable>getAccount</p>()] <p class=cm-operator>+=</p> <p class=cm-variable-2>amount</p>; <p class=cm-variable-2>progress</p> <p class=cm-operator>=</p> <p class=cm-number>2</p>; } <p class=cm-keyword>finally</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>progress</p> <p class=cm-operator>==</p> <p class=cm-number>1</p>) { <p class=cm-variable>accounts</p>[<p class=cm-variable-2>from</p>] <p class=cm-operator>+=</p> <p class=cm-variable-2>amount</p>;\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_LvvK85Vh5F class=p_ident id=p_LvvK85Vh5F></a>This version of the function tracks its progress, and if, when leaving, it notices that it was aborted at a point where it had created an inconsistent program state, it repairs the damage it did.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_Gs19OQg3TY class=p_ident id=p_Gs19OQg3TY></a>Note that even though the <code>finally</code> code is run when an exception is thrown in the <code>try</code> block, it does not interfere with the exception. After the <code>finally</code> block runs, the stack continues unwinding.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_yZkXySCQHr class=p_ident id=p_yZkXySCQHr></a>Writing programs that operate reliably even when exceptions pop up in unexpected places is hard. Many people simply don’t bother, and because exceptions are typically reserved for exceptional circumstances, the problem may occur so rarely that it is never even noticed. Whether that is a good thing or a really bad thing depends on how much damage the software will do when it fails.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_vfoJqEDazI class=h_ident id=h_vfoJqEDazI></a>Selective catching</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_HUJ9GRG1jC class=p_ident id=p_HUJ9GRG1jC></a>When an exception makes it all the way to the bottom of the stack without being caught, it gets handled by the environment. What this means differs between environments. In browsers, a description of the error typically gets written to the JavaScript console (reachable through the browser’s Tools or Developer menu). Node.js, the browserless JavaScript environment we will discuss in <a href=https://eloquentjavascript.net/20_node.html>Chapter 20</a>, is more careful about data corruption. It aborts the whole process when an unhandled exception occurs.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_9JOlpepKZE class=p_ident id=p_9JOlpepKZE></a>For programmer mistakes, just letting the error go through is often the best you can do. An unhandled exception is a reasonable way to signal a broken program, and the JavaScript console will, on modern browsers, provide you with some information about which function calls were on the stack when the problem occurred.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_KGWPPf4CcF class=p_ident id=p_KGWPPf4CcF></a>For problems that are <em>expected</em> to happen during routine use, crashing with an unhandled exception is a terrible strategy.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_ZkwQ40b3to class=p_ident id=p_ZkwQ40b3to></a>Invalid uses of the language, such as referencing a nonexistent binding, looking up a property on <code>null</code>, or calling something that’s not a function, will also result in exceptions being raised. Such exceptions can also be caught.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_8IwJJBHBTh class=p_ident id=p_8IwJJBHBTh></a>When a <code>catch</code> body is entered, all we know is that <em>something</em> in our <code>try</code> body caused an exception. But we don’t know <em>what</em> did or <em>which</em> exception it caused.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_3umLtBJgPo class=p_ident id=p_3umLtBJgPo></a>JavaScript (in a rather glaring omission) doesn’t provide direct support for selectively catching exceptions: either you catch them all or you don’t catch any. This makes it tempting to <em>assume</em> that the exception you get is the one you were thinking about when you wrote the <code>catch</code> block.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_O9bj9nd33p class=p_ident id=p_O9bj9nd33p></a>But it might not be. Some other assumption might be violated, or you might have introduced a bug that is causing an exception. Here is an example that <em>attempts</em> to keep on calling <code>promptDirection</code> until it gets a valid answer:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_ZxDKrGLCQ3 class=c_ident id=c_ZxDKrGLCQ3></a><p class=cm-keyword>for</p> (;;) { <p class=cm-keyword>try</p> { <p class=cm-keyword>let</p> <p class=cm-def>dir</p> <p class=cm-operator>=</p> <p class=cm-variable>promtDirection</p>(<p class=cm-string>\"Where?\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You chose \"</p>, <p class=cm-variable>dir</p>); <p class=cm-keyword>break</p>; } <p class=cm-keyword>catch</p> (<p class=cm-def>e</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Not a valid direction. Try again.\"</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_pdL8VKiwnf class=p_ident id=p_pdL8VKiwnf></a>The <code>for (;;)</code> construct is a way to intentionally create a loop that doesn’t terminate on its own. We break out of the loop only when a valid direction is given. <em>But</em> we misspelled <code>promptDirection</code>, which will result in an “undefined variable” error. Because the <code>catch</code> block completely ignores its exception value (<code>e</code>), assuming it knows what the problem is, it wrongly treats the binding error as indicating bad input. Not only does this cause an infinite loop, it “buries” the useful error message about the misspelled binding.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_hk/lwBIhah class=p_ident id=p_hk/lwBIhah></a>As a general rule, don’t blanket-catch exceptions unless it is for the purpose of “routing” them somewhere—for example, over the network to tell another system that our program crashed. And even then, think carefully about how you might be hiding information.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_o1E5pkUD5g class=p_ident id=p_o1E5pkUD5g></a>So we want to catch a <em>specific</em> kind of exception. We can do this by checking in the <code>catch</code> block whether the exception we got is the one we are interested in and rethrowing it otherwise. But how do we recognize an exception?</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_qurSIk3pjE class=p_ident id=p_qurSIk3pjE></a>We could compare its <code>message</code> property against the error message we happen to expect. But that’s a shaky way to write code—we’d be using information that’s intended for human consumption (the message) to make a programmatic decision. As soon as someone changes (or translates) the message, the code will stop working.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_Pml4dAzuT1 class=p_ident id=p_Pml4dAzuT1></a>Rather, let’s define a new type of error and use <code>instanceof</code> to identify it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_miFD8lvrWj class=c_ident id=c_miFD8lvrWj></a><p class=cm-keyword>class</p> <p class=cm-def>InputError</p> <p class=cm-keyword>extends</p> <p class=cm-variable>Error</p> {} <p class=cm-keyword>function</p> <p class=cm-def>promptDirection</p>(<p class=cm-def>question</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-variable>prompt</p>(<p class=cm-variable-2>question</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>result</p>.<p class=cm-property>toLowerCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"left\"</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"L\"</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>result</p>.<p class=cm-property>toLowerCase</p>() <p class=cm-operator>==</p> <p class=cm-string>\"right\"</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"R\"</p>; <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>InputError</p>(<p class=cm-string>\"Invalid direction: \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>result</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_/YM4ZmoOGt class=p_ident id=p_/YM4ZmoOGt></a>The new error class extends <code>Error</code>. It doesn’t define its own constructor, which means that it inherits the <code>Error</code> constructor, which expects a string message as argument. In fact, it doesn’t define anything at all—the class is empty. <code>InputError</code> objects behave like <code>Error</code> objects, except that they have a different class by which we can recognize them.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_JqyLwQxCGY class=p_ident id=p_JqyLwQxCGY></a>Now the loop can catch these more carefully.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_ab/mR1C1nr class=c_ident id=c_ab/mR1C1nr></a><p class=cm-keyword>for</p> (;;) { <p class=cm-keyword>try</p> { <p class=cm-keyword>let</p> <p class=cm-def>dir</p> <p class=cm-operator>=</p> <p class=cm-variable>promptDirection</p>(<p class=cm-string>\"Where?\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You chose \"</p>, <p class=cm-variable>dir</p>); <p class=cm-keyword>break</p>; } <p class=cm-keyword>catch</p> (<p class=cm-def>e</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>e</p> <p class=cm-keyword>instanceof</p> <p class=cm-variable>InputError</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Not a valid direction. Try again.\"</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>throw</p> <p class=cm-variable-2>e</p>;\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_N4ExnmZrQ/ class=p_ident id=p_N4ExnmZrQ/ ></a>This will catch only instances of <code>InputError</code> and let unrelated exceptions through. If you reintroduce the typo, the undefined binding error will be properly reported.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_Sb9V3BEus1 class=h_ident id=h_Sb9V3BEus1></a>Assertions</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_Is9Zkz2o9G class=p_ident id=p_Is9Zkz2o9G></a><em>Assertions</em> are checks inside a program that verify that something is the way it is supposed to be. They are used not to handle situations that can come up in normal operation but to find programmer mistakes.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_uMhd4mC7ZW class=p_ident id=p_uMhd4mC7ZW></a>If, for example, <code>firstElement</code> is described as a function that should never be called on empty arrays, we might write it like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_gRlHo3tyh8 class=c_ident id=c_gRlHo3tyh8></a><p class=cm-keyword>function</p> <p class=cm-def>firstElement</p>(<p class=cm-def>array</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>array</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"firstElement called with []\"</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>array</p>[<p class=cm-number>0</p>];\n}</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_MOw81C4a4b class=p_ident id=p_MOw81C4a4b></a>Now, instead of silently returning undefined (which you get when reading an array property that does not exist), this will loudly blow up your program as soon as you misuse it. This makes it less likely for such mistakes to go unnoticed and easier to find their cause when they occur.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_bFN2bXWxAz class=p_ident id=p_bFN2bXWxAz></a>I do not recommend trying to write assertions for every possible kind of bad input. That’d be a lot of work and would lead to very noisy code. You’ll want to reserve them for mistakes that are easy to make (or that you find yourself making).</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/08_error.html#p_rD8/ab0/w4 class=p_ident id=p_rD8/ab0/w4></a>Mistakes and bad input are facts of life. An important part of programming is finding, diagnosing, and fixing bugs. Problems can become easier to notice if you have an automated test suite or add assertions to your programs.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_8tal4BvCRU class=p_ident id=p_8tal4BvCRU></a>Problems caused by factors outside the program’s control should usually be handled gracefully. Sometimes, when the problem can be handled locally, special return values are a good way to track them. Otherwise, exceptions may be preferable.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_ZJkq9NFh8W class=p_ident id=p_ZJkq9NFh8W></a>Throwing an exception causes the call stack to be unwound until the next enclosing <code>try/catch</code> block or until the bottom of the stack. The exception value will be given to the <code>catch</code> block that catches it, which should verify that it is actually the expected kind of exception and then do something with it. To help address the unpredictable control flow caused by exceptions, <code>finally</code> blocks can be used to ensure that a piece of code <em>always</em> runs when a block finishes.</p> <h2><a href=https://eloquentjavascript.net/08_error.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/08_error.html#i_n1zYouiAfX class=i_ident id=i_n1zYouiAfX></a>Retry</h3> <p><a href=https://eloquentjavascript.net/08_error.html#p_oAuWXajIJA class=p_ident id=p_oAuWXajIJA></a>Say you have a function <code>primitiveMultiply</code> that in 20 percent of cases multiplies two numbers and in the other 80 percent of cases raises an exception of type <code>MultiplicatorUnitFailure</code>. Write a function that wraps this clunky function and just keeps trying until a call succeeds, after which it returns the result.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_FfNd4pOv0L class=p_ident id=p_FfNd4pOv0L></a>Make sure you handle only the exceptions you are trying to handle.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_E1Acr2VS8k class=c_ident id=c_E1Acr2VS8k></a><p class=cm-keyword>class</p> <p class=cm-def>MultiplicatorUnitFailure</p> <p class=cm-keyword>extends</p> <p class=cm-variable>Error</p> {} <p class=cm-keyword>function</p> <p class=cm-def>primitiveMultiply</p>(<p class=cm-def>a</p>, <p class=cm-def>b</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>&lt;</p> <p class=cm-number>0.2</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>a</p> <p class=cm-operator>*</p> <p class=cm-variable-2>b</p>; } <p class=cm-keyword>else</p> { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>MultiplicatorUnitFailure</p>(<p class=cm-string>\"Klunk\"</p>); }\n} <p class=cm-keyword>function</p> <p class=cm-def>reliableMultiply</p>(<p class=cm-def>a</p>, <p class=cm-def>b</p>) { } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>reliableMultiply</p>(<p class=cm-number>8</p>, <p class=cm-number>8</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/08_error.html#p_ChowJFeR1F class=p_ident id=p_ChowJFeR1F></a>The call to <code>primitiveMultiply</code> should definitely happen in a <code>try</code> block. The corresponding <code>catch</code> block should rethrow the exception when it is not an instance of <code>MultiplicatorUnitFailure</code> and ensure the call is retried when it is.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_2LqwPbYM+K class=p_ident id=p_2LqwPbYM+K></a>To do the retrying, you can either use a loop that stops only when a call succeeds—as in the <a href=https://eloquentjavascript.net/08_error.html#look><code>look</code> example</a> earlier in this chapter—or use recursion and hope you don’t get a string of failures so long that it overflows the stack (which is a pretty safe bet).</p> </div></div> <h3><a href=https://eloquentjavascript.net/08_error.html#i_iGlwnUbkRs class=i_ident id=i_iGlwnUbkRs></a>The locked box</h3> <p><a href=https://eloquentjavascript.net/08_error.html#p_uGznOGuYh8 class=p_ident id=p_uGznOGuYh8></a>Consider the following (rather contrived) object:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_X963W9SHCK class=c_ident id=c_X963W9SHCK></a><p class=cm-keyword>const</p> <p class=cm-def>box</p> <p class=cm-operator>=</p> { <p class=cm-property>locked</p>: <p class=cm-atom>true</p>, <p class=cm-property>unlock</p>() { <p class=cm-keyword>this</p>.<p class=cm-property>locked</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>; }, <p class=cm-property>lock</p>() { <p class=cm-keyword>this</p>.<p class=cm-property>locked</p> <p class=cm-operator>=</p> <p class=cm-atom>true</p>; }, <p class=cm-property>_content</p>: [], <p class=cm-property>get</p> <p class=cm-property>content</p>() { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>locked</p>) <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Locked!\"</p>); <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>_content</p>;\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_PPjq8MDhzp class=p_ident id=p_PPjq8MDhzp></a>It is a box with a lock. There is an array in the box, but you can get at it only when the box is unlocked. Directly accessing the private <code>_content</code> property is forbidden.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_KI+tJ+amDX class=p_ident id=p_KI+tJ+amDX></a>Write a function called <code>withBoxUnlocked</code> that takes a function value as argument, unlocks the box, runs the function, and then ensures that the box is locked again before returning, regardless of whether the argument function returned normally or threw an exception.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/08_error.html#c_EPN4Aey63n class=c_ident id=c_EPN4Aey63n></a><p class=cm-keyword>const</p> <p class=cm-def>box</p> <p class=cm-operator>=</p> { <p class=cm-property>locked</p>: <p class=cm-atom>true</p>, <p class=cm-property>unlock</p>() { <p class=cm-keyword>this</p>.<p class=cm-property>locked</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>; }, <p class=cm-property>lock</p>() { <p class=cm-keyword>this</p>.<p class=cm-property>locked</p> <p class=cm-operator>=</p> <p class=cm-atom>true</p>; }, <p class=cm-property>_content</p>: [], <p class=cm-property>get</p> <p class=cm-property>content</p>() { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>locked</p>) <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Locked!\"</p>); <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>_content</p>; }\n}; <p class=cm-keyword>function</p> <p class=cm-def>withBoxUnlocked</p>(<p class=cm-def>body</p>) { } <p class=cm-variable>withBoxUnlocked</p>(<p class=cm-keyword>function</p>() { <p class=cm-variable>box</p>.<p class=cm-property>content</p>.<p class=cm-property>push</p>(<p class=cm-string>\"gold piece\"</p>);\n}); <p class=cm-keyword>try</p> { <p class=cm-variable>withBoxUnlocked</p>(<p class=cm-keyword>function</p>() { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Pirates on the horizon! Abort!\"</p>); });\n} <p class=cm-keyword>catch</p> (<p class=cm-def>e</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Error raised: \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>e</p>);\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>box</p>.<p class=cm-property>locked</p>);\n</pre> <p><a href=https://eloquentjavascript.net/08_error.html#p_X5dxXtnN4l class=p_ident id=p_X5dxXtnN4l></a>For extra points, make sure that if you call <code>withBoxUnlocked</code> when the box is already unlocked, the box stays unlocked.</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/08_error.html#p_4MxgD1VcbV class=p_ident id=p_4MxgD1VcbV></a>This exercise calls for a <code>finally</code> block. Your function should first unlock the box and then call the argument function from inside a <code>try</code> body. The <code>finally</code> block after it should lock the box again.</p> <p><a href=https://eloquentjavascript.net/08_error.html#p_PvZL0oQnMG class=p_ident id=p_PvZL0oQnMG></a>To make sure we don’t lock the box when it wasn’t already locked, check its lock at the start of the function and unlock and lock it only when it started out locked.</p> </div></div><nav><a href=https://eloquentjavascript.net/07_robot.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/09_regexp.html>▶</a></nav>\n</article><hr><h4>Page 5</h4><article score=947.1499999999999>\n<nav><a href=https://eloquentjavascript.net/19_paint.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/21_skillsharing.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/20_node.html#p_dL3PxXkk30 class=p_ident id=p_dL3PxXkk30></a>A student asked, ‘The programmers of old used only simple machines and no programming languages, yet they made beautiful programs. Why do we use complicated machines and programming languages?’. Fu-Tzu replied, ‘The builders of old used only sticks and clay, yet they made beautiful huts.’</p> <footer>Master Yuan-Ma, <cite>The Book of Programming</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a telephone pole\" src=https://eloquentjavascript.net/img/chapter_picture_20.jpg></figure> <p><a href=https://eloquentjavascript.net/20_node.html#p_4oqrrNIihE class=p_ident id=p_4oqrrNIihE></a>So far, we have used the JavaScript language in a single environment: the browser. This chapter and the <a href=https://eloquentjavascript.net/21_skillsharing.html>next one</a> will briefly introduce Node.js, a program that allows you to apply your JavaScript skills outside of the browser. With it, you can build anything from small command line tools to HTTP servers that power dynamic websites.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_dkSo8b0Hlh class=p_ident id=p_dkSo8b0Hlh></a>These chapters aim to teach you the main concepts that Node.js uses and to give you enough information to write useful programs for it. They do not try to be a complete, or even a thorough, treatment of the platform.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_NM5XbgzOCu class=p_ident id=p_NM5XbgzOCu></a>Whereas you could run the code in previous chapters directly on these pages, because it was either raw JavaScript or written for the browser, the code samples in this chapter are written for Node and often won’t run in the browser.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_yDXmkj8agX class=p_ident id=p_yDXmkj8agX></a>If you want to follow along and run the code in this chapter, you’ll need to install Node.js version 10.1 or higher. To do so, go to <a href=https://nodejs.org/ ><em>https://nodejs.org</em></a> and follow the installation instructions for your operating system. You can also find further documentation for Node.js there.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_ZN1g/hoEn+ class=h_ident id=h_ZN1g/hoEn+></a>Background</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_I4yhs5+yBu class=p_ident id=p_I4yhs5+yBu></a>One of the more difficult problems with writing systems that communicate over the network is managing input and output—that is, the reading and writing of data to and from the network and hard drive. Moving data around takes time, and scheduling it cleverly can make a big difference in how quickly a system responds to the user or to network requests.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_MBm9R7gzIJ class=p_ident id=p_MBm9R7gzIJ></a>In such programs, asynchronous programming is often helpful. It allows the program to send and receive data from and to multiple devices at the same time without complicated thread management and synchronization.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_RCasOwXmol class=p_ident id=p_RCasOwXmol></a>Node was initially conceived for the purpose of making asynchronous programming easy and convenient. JavaScript lends itself well to a system like Node. It is one of the few programming languages that does not have a built-in way to do in- and output. Thus, JavaScript could be fit onto Node’s rather eccentric approach to in- and output without ending up with two inconsistent interfaces. In 2009, when Node was being designed, people were already doing callback-based programming in the browser, so the community around the language was used to an asynchronous programming style.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_TUzbi7lU/0 class=h_ident id=h_TUzbi7lU/0></a>The node command</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_rE0vPeaAdk class=p_ident id=p_rE0vPeaAdk></a>When Node.js is installed on a system, it provides a program called <code>node</code>, which is used to run JavaScript files. Say you have a file <code>hello.js</code>, containing this code:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_Ys/5/PYPJK class=c_ident id=c_Ys/5/PYPJK></a><p class=cm-keyword>let</p> <p class=cm-def>message</p> <p class=cm-operator>=</p> <p class=cm-string>\"Hello world\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>message</p>);</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_4LYXmSusTq class=p_ident id=p_4LYXmSusTq></a>You can then run <code>node</code> from the command line like this to execute the program:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_+NijqTTZNf class=c_ident id=c_+NijqTTZNf></a>$ node hello.js\nHello world</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_eFRb1edk0V class=p_ident id=p_eFRb1edk0V></a>The <code>console.log</code> method in Node does something similar to what it does in the browser. It prints out a piece of text. But in Node, the text will go to the process’s standard output stream, rather than to a browser’s JavaScript console. When running <code>node</code> from the command line, that means you see the logged values in your terminal.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_TwZ26izezw class=p_ident id=p_TwZ26izezw></a>If you run <code>node</code> without giving it a file, it provides you with a prompt at which you can type JavaScript code and immediately see the result.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_d/9k6S5oD+ class=c_ident id=c_d/9k6S5oD+></a>$ node\n&gt; 1 + 1\n2\n&gt; [-1, -2, -3].map(Math.abs)\n[1, 2, 3]\n&gt; process.exit(0)\n$</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_gu0HNk/tPj class=p_ident id=p_gu0HNk/tPj></a>The <code>process</code> binding, just like the <code>console</code> binding, is available globally in Node. It provides various ways to inspect and manipulate the current program. The <code>exit</code> method ends the process and can be given an exit status code, which tells the program that started <code>node</code> (in this case, the command line shell) whether the program completed successfully (code zero) or encountered an error (any other code).</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_r76dNN6hR1 class=p_ident id=p_r76dNN6hR1></a>To find the command line arguments given to your script, you can read <code>process.argv</code>, which is an array of strings. Note that it also includes the name of the <code>node</code> command and your script name, so the actual arguments start at index 2. If <code>showargv.js</code> contains the statement <code>console.<wbr>log(process.<wbr>argv)</code>, you could run it like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_WCisDZr57g class=c_ident id=c_WCisDZr57g></a>$ node showargv.js one --and two\n[\"node\", \"/tmp/showargv.js\", \"one\", \"--and\", \"two\"]</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_ols5jgMHp4 class=p_ident id=p_ols5jgMHp4></a>All the standard JavaScript global bindings, such as <code>Array</code>, <code>Math</code>, and <code>JSON</code>, are also present in Node’s environment. Browser-related functionality, such as <code>document</code> or <code>prompt</code>, is not.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_BOlGLA/wK7 class=h_ident id=h_BOlGLA/wK7></a>Modules</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_7uiDKmOxBC class=p_ident id=p_7uiDKmOxBC></a>Beyond the bindings I mentioned, such as <code>console</code> and <code>process</code>, Node puts few additional bindings in the global scope. If you want to access built-in functionality, you have to ask the module system for it.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_KyUqoANKU6 class=p_ident id=p_KyUqoANKU6></a>The CommonJS module system, based on the <code>require</code> function, was described in <a href=https://eloquentjavascript.net/10_modules.html#commonjs>Chapter 10</a>. This system is built into Node and is used to load anything from built-in modules to downloaded packages to files that are part of your own program.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_/PFjIKtmrf class=p_ident id=p_/PFjIKtmrf></a>When <code>require</code> is called, Node has to resolve the given string to an actual file that it can load. Pathnames that start with <code>/</code>, <code>./</code>, or <code>../</code> are resolved relative to the current module’s path, where <code>.</code> stands for the current directory, <code>../</code> for one directory up, and <code>/</code> for the root of the file system. So if you ask for <code>\"./<wbr>graph\"</code> from the file <code>/<wbr>tmp/<wbr>robot/<wbr>robot.<wbr>js</code>, Node will try to load the file <code>/<wbr>tmp/<wbr>robot/<wbr>graph.<wbr>js</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_5Uhl44wvon class=p_ident id=p_5Uhl44wvon></a>The <code>.js</code> extension may be omitted, and Node will add it if such a file exists. If the required path refers to a directory, Node will try to load the file named <code>index.js</code> in that directory.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_Jbv0K2DaVF class=p_ident id=p_Jbv0K2DaVF></a>When a string that does not look like a relative or absolute path is given to <code>require</code>, it is assumed to refer to either a built-in module or a module installed in a <code>node_modules</code> directory. For example, <code>require(\"fs\")</code> will give you Node’s built-in file system module. And <code>require(\"robot\")</code> might try to load the library found in <code>node_modules/<wbr>robot/<wbr></code>. A common way to install such libraries is by using NPM, which we’ll come back to in a moment.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_nVdHCtPw94 class=p_ident id=p_nVdHCtPw94></a>Let’s set up a small project consisting of two files. The first one, called <code>main.js</code>, defines a script that can be called from the command line to reverse a string.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_P0yKauuaN8 class=c_ident id=c_P0yKauuaN8></a><p class=cm-keyword>const</p> {<p class=cm-def>reverse</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"./reverse\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>argument</p> <p class=cm-operator>=</p> <p class=cm-variable>process</p>.<p class=cm-property>argv</p>[<p class=cm-number>2</p>]; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>reverse</p>(<p class=cm-variable>argument</p>));</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_4ZPnC8Ok8r class=p_ident id=p_4ZPnC8Ok8r></a>The file <code>reverse.js</code> defines a library for reversing strings, which can be used both by this command line tool and by other scripts that need direct access to a string-reversing function.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_xPNlH3e9Ye class=c_ident id=c_xPNlH3e9Ye></a><p class=cm-variable>exports</p>.<p class=cm-property>reverse</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>string</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable-2>string</p>).<p class=cm-property>reverse</p>().<p class=cm-property>join</p>(<p class=cm-string>\"\"</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_cz8b+bxuQd class=p_ident id=p_cz8b+bxuQd></a>Remember that adding properties to <code>exports</code> adds them to the interface of the module. Since Node.js treats files as CommonJS modules, <code>main.js</code> can take the exported <code>reverse</code> function from <code>reverse.js</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_S/nc4v84fJ class=p_ident id=p_S/nc4v84fJ></a>We can now call our tool like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_k81NC+cAsi class=c_ident id=c_k81NC+cAsi></a>$ node main.js JavaScript\ntpircSavaJ</pre> <h2><a href=https://eloquentjavascript.net/20_node.html#h_J6hW/SmL/a class=h_ident id=h_J6hW/SmL/a></a>Installing with NPM</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_vdquK0d/vZ class=p_ident id=p_vdquK0d/vZ></a>NPM, which was introduced in <a href=https://eloquentjavascript.net/10_modules.html#modules_npm>Chapter 10</a>, is an online repository of JavaScript modules, many of which are specifically written for Node. When you install Node on your computer, you also get the <code>npm</code> command, which you can use to interact with this repository.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_S050oa0uFn class=p_ident id=p_S050oa0uFn></a>NPM’s main use is downloading packages. We saw the <code>ini</code> package in <a href=https://eloquentjavascript.net/10_modules.html#modules_ini>Chapter 10</a>. We can use NPM to fetch and install that package on our computer.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_BggMWensXe class=c_ident id=c_BggMWensXe></a>$ npm install ini\nnpm WARN enoent ENOENT: no such file or directory,\n         open '/tmp/package.json'\n+ ini@1.3.5\nadded 1 package in 0.552s\n\n$ node\n&gt; const {parse} = require(\"ini\");\n&gt; parse(\"x = 1\\ny = 2\");\n{ x: '1', y: '2' }</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_NBQHpDdZuw class=p_ident id=p_NBQHpDdZuw></a>After running <code>npm install</code>, NPM will have created a directory called <code>node_modules</code>. Inside that directory will be an <code>ini</code> directory that contains the library. You can open it and look at the code. When we call <code>require(\"ini\")</code>, this library is loaded, and we can call its <code>parse</code> property to parse a configuration file.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_sKeXO3qL6G class=p_ident id=p_sKeXO3qL6G></a>By default NPM installs packages under the current directory, rather than in a central place. If you are used to other package managers, this may seem unusual, but it has advantages—it puts each application in full control of the packages it installs and makes it easier to manage versions and clean up when removing an application.</p> <h3><a href=https://eloquentjavascript.net/20_node.html#i_IMZP7FN0pF class=i_ident id=i_IMZP7FN0pF></a>Package files</h3> <p><a href=https://eloquentjavascript.net/20_node.html#p_efbbWPPNXQ class=p_ident id=p_efbbWPPNXQ></a>In the <code>npm install</code> example, you could see a warning about the fact that the <code>package.json</code> file did not exist. It is recommended to create such a file for each project, either manually or by running <code>npm init</code>. It contains some information about the project, such as its name and version, and lists its dependencies.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_NT9giTr6Q2 class=p_ident id=p_NT9giTr6Q2></a>The robot simulation from <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a>, as modularized in the exercise in <a href=https://eloquentjavascript.net/10_modules.html#modular_robot>Chapter 10</a>, might have a <code>package.json</code> file like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_K51zuXso4A class=c_ident id=c_K51zuXso4A></a>{ <p class=cm-string>\"author\"</p>: <p class=cm-string>\"Marijn Haverbeke\"</p>, <p class=cm-string>\"name\"</p>: <p class=cm-string>\"eloquent-javascript-robot\"</p>, <p class=cm-string>\"description\"</p>: <p class=cm-string>\"Simulation of a package-delivery robot\"</p>, <p class=cm-string>\"version\"</p>: <p class=cm-string>\"1.0.0\"</p>, <p class=cm-string>\"main\"</p>: <p class=cm-string>\"run.js\"</p>, <p class=cm-string>\"dependencies\"</p>: { <p class=cm-string>\"dijkstrajs\"</p>: <p class=cm-string>\"^1.0.1\"</p>, <p class=cm-string>\"random-item\"</p>: <p class=cm-string>\"^1.0.0\"</p> }, <p class=cm-string>\"license\"</p>: <p class=cm-string>\"ISC\"</p>\n}</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_LA2QNdOUqm class=p_ident id=p_LA2QNdOUqm></a>When you run <code>npm install</code> without naming a package to install, NPM will install the dependencies listed in <code>package.json</code>. When you install a specific package that is not already listed as a dependency, NPM will add it to <code>package.json</code>.</p> <h3><a href=https://eloquentjavascript.net/20_node.html#i_ojkQfvKPbv class=i_ident id=i_ojkQfvKPbv></a>Versions</h3> <p><a href=https://eloquentjavascript.net/20_node.html#p_UrPIybyUA4 class=p_ident id=p_UrPIybyUA4></a>A <code>package.json</code> file lists both the program’s own version and versions for its dependencies. Versions are a way to deal with the fact that packages evolve separately, and code written to work with a package as it existed at one point may not work with a later, modified version of the package.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_CvfHe7sDbQ class=p_ident id=p_CvfHe7sDbQ></a>NPM demands that its packages follow a schema called <em>semantic versioning</em>, which encodes some information about which versions are <em>compatible</em> (don’t break the old interface) in the version number. A semantic version consists of three numbers, separated by periods, such as <code>2.3.0</code>. Every time new functionality is added, the middle number has to be incremented. Every time compatibility is broken, so that existing code that uses the package might not work with the new version, the first number has to be incremented.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_gTL1n2TLHm class=p_ident id=p_gTL1n2TLHm></a>A caret character (<code>^</code>) in front of the version number for a dependency in <code>package.json</code> indicates that any version compatible with the given number may be installed. So, for example, <code>\"^2.<wbr>3.<wbr>0\"</code> would mean that any version greater than or equal to 2.3.0 and less than 3.0.0 is allowed.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_HcGcWqTR8/ class=p_ident id=p_HcGcWqTR8/ ></a>The <code>npm</code> command is also used to publish new packages or new versions of packages. If you run <code>npm publish</code> in a directory that has a <code>package.json</code> file, it will publish a package with the name and version listed in the JSON file to the registry. Anyone can publish packages to NPM—though only under a package name that isn’t in use yet since it would be somewhat scary if random people could update existing packages.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_3Z1I+gjqS6 class=p_ident id=p_3Z1I+gjqS6></a>Since the <code>npm</code> program is a piece of software that talks to an open system—the package registry—there is nothing unique about what it does. Another program, <code>yarn</code>, which can be installed from the NPM registry, fills the same role as <code>npm</code> using a somewhat different interface and installation strategy.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_u9CNibuDC7 class=p_ident id=p_u9CNibuDC7></a>This book won’t delve further into the details of NPM usage. Refer to <a href=https://npmjs.org/ ><em>https://npmjs.org</em></a> for further documentation and a way to search for packages.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_o2abiQU0TD class=h_ident id=h_o2abiQU0TD></a>The file system module</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_HumHNRQKJx class=p_ident id=p_HumHNRQKJx></a>One of the most commonly used built-in modules in Node is the <code>fs</code> module, which stands for <em>file system</em>. It exports functions for working with files and directories.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_75RFSIQwdU class=p_ident id=p_75RFSIQwdU></a>For example, the function called <code>readFile</code> reads a file and then calls a callback with the file’s contents.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_JolDdwagNc class=c_ident id=c_JolDdwagNc></a><p class=cm-keyword>let</p> {<p class=cm-def>readFile</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>);\n<p class=cm-variable>readFile</p>(<p class=cm-string>\"file.txt\"</p>, <p class=cm-string>\"utf8\"</p>, (<p class=cm-def>error</p>, <p class=cm-def>text</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p>) <p class=cm-keyword>throw</p> <p class=cm-variable-2>error</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"The file contains:\"</p>, <p class=cm-variable-2>text</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_kiSsXyNElK class=p_ident id=p_kiSsXyNElK></a>The second argument to <code>readFile</code> indicates the <em>character encoding</em> used to decode the file into a string. There are several ways in which text can be encoded to binary data, but most modern systems use UTF-8. So unless you have reasons to believe another encoding is used, pass <code>\"utf8\"</code> when reading a text file. If you do not pass an encoding, Node will assume you are interested in the binary data and will give you a <code>Buffer</code> object instead of a string. This is an array-like object that contains numbers representing the bytes (8-bit chunks of data) in the files.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_D3dLtJ/8n6 class=c_ident id=c_D3dLtJ/8n6></a><p class=cm-keyword>const</p> {<p class=cm-def>readFile</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>);\n<p class=cm-variable>readFile</p>(<p class=cm-string>\"file.txt\"</p>, (<p class=cm-def>error</p>, <p class=cm-def>buffer</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p>) <p class=cm-keyword>throw</p> <p class=cm-variable-2>error</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"The file contained\"</p>, <p class=cm-variable-2>buffer</p>.<p class=cm-property>length</p>, <p class=cm-string>\"bytes.\"</p>, <p class=cm-string>\"The first byte is:\"</p>, <p class=cm-variable-2>buffer</p>[<p class=cm-number>0</p>]);\n});</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_2eNWgxdLGx class=p_ident id=p_2eNWgxdLGx></a>A similar function, <code>writeFile</code>, is used to write a file to disk.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_lbylD3zyw8 class=c_ident id=c_lbylD3zyw8></a><p class=cm-keyword>const</p> {<p class=cm-def>writeFile</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>);\n<p class=cm-variable>writeFile</p>(<p class=cm-string>\"graffiti.txt\"</p>, <p class=cm-string>\"Node was here\"</p>, <p class=cm-def>err</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>err</p>) <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Failed to write file: ${</p><p class=cm-variable-2>err</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-keyword>else</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"File written.\"</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_rDd4gjDwV6 class=p_ident id=p_rDd4gjDwV6></a>Here it was not necessary to specify the encoding—<code>writeFile</code> will assume that when it is given a string to write, rather than a <code>Buffer</code> object, it should write it out as text using its default character encoding, which is UTF-8.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_SJ/BKOfrhB class=p_ident id=p_SJ/BKOfrhB></a>The <code>fs</code> module contains many other useful functions: <code>readdir</code> will return the files in a directory as an array of strings, <code>stat</code> will retrieve information about a file, <code>rename</code> will rename a file, <code>unlink</code> will remove one, and so on. See the documentation at <a href=https://nodejs.org/ ><em>https://nodejs.org</em></a> for specifics.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_e3QJHgZtmU class=p_ident id=p_e3QJHgZtmU></a>Most of these take a callback function as the last parameter, which they call either with an error (the first argument) or with a successful result (the second). As we saw in <a href=https://eloquentjavascript.net/11_async.html>Chapter 11</a>, there are downsides to this style of programming—the biggest one being that error handling becomes verbose and error-prone.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_mXF/pVhyVJ class=p_ident id=p_mXF/pVhyVJ></a>Though promises have been part of JavaScript for a while, at the time of writing their integration into Node.js is still a work in progress. There is an object <code>promises</code> exported from the <code>fs</code> package since version 10.1 that contains most of the same functions as <code>fs</code> but uses promises rather than callback functions.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_wosbb7EfU3 class=c_ident id=c_wosbb7EfU3></a><p class=cm-keyword>const</p> {<p class=cm-def>readFile</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>).<p class=cm-property>promises</p>;\n<p class=cm-variable>readFile</p>(<p class=cm-string>\"file.txt\"</p>, <p class=cm-string>\"utf8\"</p>) .<p class=cm-property>then</p>(<p class=cm-def>text</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"The file contains:\"</p>, <p class=cm-variable-2>text</p>));</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_RKcdbQa/Ot class=p_ident id=p_RKcdbQa/Ot></a>Sometimes you don’t need asynchronicity, and it just gets in the way. Many of the functions in <code>fs</code> also have a synchronous variant, which has the same name with <code>Sync</code> added to the end. For example, the synchronous version of <code>readFile</code> is called <code>readFileSync</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_odA0N1psD0 class=c_ident id=c_odA0N1psD0></a><p class=cm-keyword>const</p> {<p class=cm-def>readFileSync</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"The file contains:\"</p>, <p class=cm-variable>readFileSync</p>(<p class=cm-string>\"file.txt\"</p>, <p class=cm-string>\"utf8\"</p>));</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_C0yp9W48Cn class=p_ident id=p_C0yp9W48Cn></a>Do note that while such a synchronous operation is being performed, your program is stopped entirely. If it should be responding to the user or to other machines on the network, being stuck on a synchronous action might produce annoying delays.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_3O5dGIJE9F class=h_ident id=h_3O5dGIJE9F></a>The HTTP module</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_jzBrRTKIgP class=p_ident id=p_jzBrRTKIgP></a>Another central module is called <code>http</code>. It provides functionality for running HTTP servers and making HTTP requests.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_5AqaLQsq5V class=p_ident id=p_5AqaLQsq5V></a>This is all it takes to start an HTTP server:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_87+jSJqVtw class=c_ident id=c_87+jSJqVtw></a><p class=cm-keyword>const</p> {<p class=cm-def>createServer</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"http\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>server</p> <p class=cm-operator>=</p> <p class=cm-variable>createServer</p>((<p class=cm-def>request</p>, <p class=cm-def>response</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>response</p>.<p class=cm-property>writeHead</p>(<p class=cm-number>200</p>, {<p class=cm-string>\"Content-Type\"</p>: <p class=cm-string>\"text/html\"</p>}); <p class=cm-variable-2>response</p>.<p class=cm-property>write</p>(<p class=cm-string-2>`</p> <p class=cm-string-2>&lt;h1&gt;Hello!&lt;/h1&gt;</p> <p class=cm-string-2>&lt;p&gt;You asked for &lt;code&gt;${</p><p class=cm-variable-2>request</p>.<p class=cm-property>url</p><p class=cm-string-2>}</p><p class=cm-string-2>&lt;/code&gt;&lt;/p&gt;`</p>); <p class=cm-variable-2>response</p>.<p class=cm-property>end</p>();\n});\n<p class=cm-variable>server</p>.<p class=cm-property>listen</p>(<p class=cm-number>8000</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Listening! (port 8000)\"</p>);</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_aWcDaGah2b class=p_ident id=p_aWcDaGah2b></a>If you run this script on your own machine, you can point your web browser at <a href=http://localhost:8000/hello><em>http://localhost:8000/hello</em></a> to make a request to your server. It will respond with a small HTML page.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ZiHH2p8YG0 class=p_ident id=p_ZiHH2p8YG0></a>The function passed as argument to <code>createServer</code> is called every time a client connects to the server. The <code>request</code> and <code>response</code> bindings are objects representing the incoming and outgoing data. The first contains information about the request, such as its <code>url</code> property, which tells us to what URL the request was made.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ufJ1Rx8+U9 class=p_ident id=p_ufJ1Rx8+U9></a>So, when you open that page in your browser, it sends a request to your own computer. This causes the server function to run and send back a response, which you can then see in the browser.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_eHNvwd3lFU class=p_ident id=p_eHNvwd3lFU></a>To send something back, you call methods on the <code>response</code> object. The first, <code>writeHead</code>, will write out the response headers (see <a href=https://eloquentjavascript.net/18_http.html#headers>Chapter 18</a>). You give it the status code (200 for “OK” in this case) and an object that contains header values. The example sets the <code>Content-Type</code> header to inform the client that we’ll be sending back an HTML document.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_AVzTSVzXSM class=p_ident id=p_AVzTSVzXSM></a>Next, the actual response body (the document itself) is sent with <code>response.write</code>. You are allowed to call this method multiple times if you want to send the response piece by piece, for example to stream data to the client as it becomes available. Finally, <code>response.end</code> signals the end of the response.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_evKrjFovQf class=p_ident id=p_evKrjFovQf></a>The call to <code>server.listen</code> causes the server to start waiting for connections on port 8000. This is why you have to connect to <em>localhost:8000</em> to speak to this server, rather than just <em>localhost</em>, which would use the default port 80.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_fc62/ayv5k class=p_ident id=p_fc62/ayv5k></a>When you run this script, the process just sits there and waits. When a script is listening for events—in this case, network connections—<code>node</code> will not automatically exit when it reaches the end of the script. To close it, press <span class=keyname>control</span>-C.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_7qMlOUUlqm class=p_ident id=p_7qMlOUUlqm></a>A real web server usually does more than the one in the example—it looks at the request’s method (the <code>method</code> property) to see what action the client is trying to perform and looks at the request’s URL to find out which resource this action is being performed on. We’ll see a more advanced server <a href=https://eloquentjavascript.net/20_node.html#file_server>later in this chapter</a>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_sg2xBFD57S class=p_ident id=p_sg2xBFD57S></a>To act as an HTTP <em>client</em>, we can use the <code>request</code> function in the <code>http</code> module.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_qPo2Gq+u4e class=c_ident id=c_qPo2Gq+u4e></a><p class=cm-keyword>const</p> {<p class=cm-def>request</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"http\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>requestStream</p> <p class=cm-operator>=</p> <p class=cm-variable>request</p>({ <p class=cm-property>hostname</p>: <p class=cm-string>\"eloquentjavascript.net\"</p>, <p class=cm-property>path</p>: <p class=cm-string>\"/20_node.html\"</p>, <p class=cm-property>method</p>: <p class=cm-string>\"GET\"</p>, <p class=cm-property>headers</p>: {<p class=cm-property>Accept</p>: <p class=cm-string>\"text/html\"</p>}\n}, <p class=cm-def>response</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Server responded with status code\"</p>, <p class=cm-variable-2>response</p>.<p class=cm-property>statusCode</p>);\n});\n<p class=cm-variable>requestStream</p>.<p class=cm-property>end</p>();</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_Br0rH14iSh class=p_ident id=p_Br0rH14iSh></a>The first argument to <code>request</code> configures the request, telling Node what server to talk to, what path to request from that server, which method to use, and so on. The second argument is the function that should be called when a response comes in. It is given an object that allows us to inspect the response, for example to find out its status code.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_9OfV0SuhAH class=p_ident id=p_9OfV0SuhAH></a>Just like the <code>response</code> object we saw in the server, the object returned by <code>request</code> allows us to stream data into the request with the <code>write</code> method and finish the request with the <code>end</code> method. The example does not use <code>write</code> because <code>GET</code> requests should not contain data in their request body.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_0v59qVWIFa class=p_ident id=p_0v59qVWIFa></a>There’s a similar <code>request</code> function in the <code>https</code> module that can be used to make requests to <code>https:</code> URLs.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_HRVzkvyPNc class=p_ident id=p_HRVzkvyPNc></a>Making requests with Node’s raw functionality is rather verbose. There are much more convenient wrapper packages available on NPM. For example, <code>node-fetch</code> provides the promise-based <code>fetch</code> interface that we know from the browser.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_dJhdomfGgD class=h_ident id=h_dJhdomfGgD></a>Streams</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_2nMXkmd3DS class=p_ident id=p_2nMXkmd3DS></a>We have seen two instances of writable streams in the HTTP examples—namely, the response object that the server could write to and the request object that was returned from <code>request</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_hqra1oS3e2 class=p_ident id=p_hqra1oS3e2></a><em>Writable streams</em> are a widely used concept in Node. Such objects have a <code>write</code> method that can be passed a string or a <code>Buffer</code> object to write something to the stream. Their <code>end</code> method closes the stream and optionally takes a value to write to the stream before closing. Both of these methods can also be given a callback as an additional argument, which they will call when the writing or closing has finished.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_L3YcfbxZV7 class=p_ident id=p_L3YcfbxZV7></a>It is possible to create a writable stream that points at a file with the <code>createWriteStream</code> function from the <code>fs</code> module. Then you can use the <code>write</code> method on the resulting object to write the file one piece at a time, rather than in one shot as with <code>writeFile</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_93VQIHGgFt class=p_ident id=p_93VQIHGgFt></a>Readable streams are a little more involved. Both the <code>request</code> binding that was passed to the HTTP server’s callback and the <code>response</code> binding passed to the HTTP client’s callback are readable streams—a server reads requests and then writes responses, whereas a client first writes a request and then reads a response. Reading from a stream is done using event handlers, rather than methods.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_CaPkx6i5f+ class=p_ident id=p_CaPkx6i5f+></a>Objects that emit events in Node have a method called <code>on</code> that is similar to the <code>addEventListener</code> method in the browser. You give it an event name and then a function, and it will register that function to be called whenever the given event occurs.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_3yAsJAs/Gl class=p_ident id=p_3yAsJAs/Gl></a>Readable streams have <code>\"data\"</code> and <code>\"end\"</code> events. The first is fired every time data comes in, and the second is called whenever the stream is at its end. This model is most suited for <em>streaming</em> data that can be immediately processed, even when the whole document isn’t available yet. A file can be read as a readable stream by using the <code>createReadStream</code> function from <code>fs</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_DQmM9KjDIA class=p_ident id=p_DQmM9KjDIA></a>This code creates a server that reads request bodies and streams them back to the client as all-uppercase text:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_vUewhc4MbF class=c_ident id=c_vUewhc4MbF></a><p class=cm-keyword>const</p> {<p class=cm-def>createServer</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"http\"</p>);\n<p class=cm-variable>createServer</p>((<p class=cm-def>request</p>, <p class=cm-def>response</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>response</p>.<p class=cm-property>writeHead</p>(<p class=cm-number>200</p>, {<p class=cm-string>\"Content-Type\"</p>: <p class=cm-string>\"text/plain\"</p>}); <p class=cm-variable-2>request</p>.<p class=cm-property>on</p>(<p class=cm-string>\"data\"</p>, <p class=cm-def>chunk</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>response</p>.<p class=cm-property>write</p>(<p class=cm-variable-2>chunk</p>.<p class=cm-property>toString</p>().<p class=cm-property>toUpperCase</p>())); <p class=cm-variable-2>request</p>.<p class=cm-property>on</p>(<p class=cm-string>\"end\"</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>response</p>.<p class=cm-property>end</p>());\n}).<p class=cm-property>listen</p>(<p class=cm-number>8000</p>);</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_cE/QJiL9Ih class=p_ident id=p_cE/QJiL9Ih></a>The <code>chunk</code> value passed to the data handler will be a binary <code>Buffer</code>. We can convert this to a string by decoding it as UTF-8 encoded characters with its <code>toString</code> method.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_w5A5V67s63 class=p_ident id=p_w5A5V67s63></a>The following piece of code, when run with the uppercasing server active, will send a request to that server and write out the response it gets:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_tqlbzAFLXQ class=c_ident id=c_tqlbzAFLXQ></a><p class=cm-keyword>const</p> {<p class=cm-def>request</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"http\"</p>);\n<p class=cm-variable>request</p>({ <p class=cm-property>hostname</p>: <p class=cm-string>\"localhost\"</p>, <p class=cm-property>port</p>: <p class=cm-number>8000</p>, <p class=cm-property>method</p>: <p class=cm-string>\"POST\"</p>\n}, <p class=cm-def>response</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>response</p>.<p class=cm-property>on</p>(<p class=cm-string>\"data\"</p>, <p class=cm-def>chunk</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>process</p>.<p class=cm-property>stdout</p>.<p class=cm-property>write</p>(<p class=cm-variable-2>chunk</p>.<p class=cm-property>toString</p>()));\n}).<p class=cm-property>end</p>(<p class=cm-string>\"Hello server\"</p>);\n</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_BjmSS8sm41 class=p_ident id=p_BjmSS8sm41></a>The example writes to <code>process.stdout</code> (the process’s standard output, which is a writable stream) instead of using <code>console.log</code>. We can’t use <code>console.log</code> because it adds an extra newline character after each piece of text that it writes, which isn’t appropriate here since the response may come in as multiple chunks.</p> <h2 id=file_server><a href=https://eloquentjavascript.net/20_node.html#h_yAdw1Y7bgN class=h_ident id=h_yAdw1Y7bgN></a>A file server</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_XFsmNNR4P8 class=p_ident id=p_XFsmNNR4P8></a>Let’s combine our newfound knowledge about HTTP servers and working with the file system to create a bridge between the two: an HTTP server that allows remote access to a file system. Such a server has all kinds of uses—it allows web applications to store and share data, or it can give a group of people shared access to a bunch of files.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_Pu9mO8Vutb class=p_ident id=p_Pu9mO8Vutb></a>When we treat files as HTTP resources, the HTTP methods <code>GET</code>, <code>PUT</code>, and <code>DELETE</code> can be used to read, write, and delete the files, respectively. We will interpret the path in the request as the path of the file that the request refers to.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ISZx6yrjrK class=p_ident id=p_ISZx6yrjrK></a>We probably don’t want to share our whole file system, so we’ll interpret these paths as starting in the server’s working directory, which is the directory in which it was started. If I ran the server from <code>/tmp/public/</code> (or <code>C:\\tmp\\public\\</code> on Windows), then a request for <code>/file.txt</code> should refer to <code>/<wbr>tmp/<wbr>public/<wbr>file.<wbr>txt</code> (or <code>C:\\tmp\\public\\file.<wbr>txt</code>).</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_2ZKgpWkGup class=p_ident id=p_2ZKgpWkGup></a>We’ll build the program piece by piece, using an object called <code>methods</code> to store the functions that handle the various HTTP methods. Method handlers are <code>async</code> functions that get the request object as argument and return a promise that resolves to an object that describes the response.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_W/1zaB21gr class=c_ident id=c_W/1zaB21gr></a><p class=cm-keyword>const</p> {<p class=cm-def>createServer</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"http\"</p>); <p class=cm-keyword>const</p> <p class=cm-def>methods</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-variable>createServer</p>((<p class=cm-def>request</p>, <p class=cm-def>response</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>handler</p> <p class=cm-operator>=</p> <p class=cm-variable>methods</p>[<p class=cm-variable-2>request</p>.<p class=cm-property>method</p>] <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable>notAllowed</p>; <p class=cm-variable-2>handler</p>(<p class=cm-variable-2>request</p>) .<p class=cm-property>catch</p>(<p class=cm-def>error</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p>.<p class=cm-property>status</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>error</p>; <p class=cm-keyword>return</p> {<p class=cm-property>body</p>: <p class=cm-variable>String</p>(<p class=cm-variable-2>error</p>), <p class=cm-property>status</p>: <p class=cm-number>500</p>}; }) .<p class=cm-property>then</p>(({<p class=cm-property>body</p>, <p class=cm-property>status</p> <p class=cm-operator>=</p> <p class=cm-number>200</p>, <p class=cm-variable>type</p> <p class=cm-operator>=</p> <p class=cm-string>\"text/plain\"</p>}) <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>response</p>.<p class=cm-property>writeHead</p>(<p class=cm-variable>status</p>, {<p class=cm-string>\"Content-Type\"</p>: <p class=cm-variable>type</p>}); <p class=cm-keyword>if</p> (<p class=cm-variable>body</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable>body</p>.<p class=cm-property>pipe</p>) <p class=cm-variable>body</p>.<p class=cm-property>pipe</p>(<p class=cm-variable-2>response</p>); <p class=cm-keyword>else</p> <p class=cm-variable-2>response</p>.<p class=cm-property>end</p>(<p class=cm-variable>body</p>); });\n}).<p class=cm-property>listen</p>(<p class=cm-number>8000</p>); <p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>notAllowed</p>(<p class=cm-def>request</p>) { <p class=cm-keyword>return</p> { <p class=cm-property>status</p>: <p class=cm-number>405</p>, <p class=cm-property>body</p>: <p class=cm-string-2>`Method ${</p><p class=cm-variable-2>request</p>.<p class=cm-property>method</p><p class=cm-string-2>}</p> <p class=cm-string-2>not allowed.`</p>\n  };\n}</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_yWKuFrWjV3 class=p_ident id=p_yWKuFrWjV3></a>This starts a server that just returns 405 error responses, which is the code used to indicate that the server refuses to handle a given method.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_JXw1kc0aXP class=p_ident id=p_JXw1kc0aXP></a>When a request handler’s promise is rejected, the <code>catch</code> call translates the error into a response object, if it isn’t one already, so that the server can send back an error response to inform the client that it failed to handle the request.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_hqnRLFr4tm class=p_ident id=p_hqnRLFr4tm></a>The <code>status</code> field of the response description may be omitted, in which case it defaults to 200 (OK). The content type, in the <code>type</code> property, can also be left off, in which case the response is assumed to be plain text.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_qzp2F6cgBS class=p_ident id=p_qzp2F6cgBS></a>When the value of <code>body</code> is a readable stream, it will have a <code>pipe</code> method that is used to forward all content from a readable stream to a writable stream. If not, it is assumed to be either <code>null</code> (no body), a string, or a buffer, and it is passed directly to the response’s <code>end</code> method.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_pL6vfBBk4E class=p_ident id=p_pL6vfBBk4E></a>To figure out which file path corresponds to a request URL, the <code>urlPath</code> function uses Node’s built-in <code>url</code> module to parse the URL. It takes its pathname, which will be something like <code>\"/<wbr>file.<wbr>txt\"</code>, decodes that to get rid of the <code>%20</code>-style escape codes, and resolves it relative to the program’s working directory.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_vgzzr4jj34 class=c_ident id=c_vgzzr4jj34></a><p class=cm-keyword>const</p> {<p class=cm-def>parse</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"url\"</p>);\n<p class=cm-keyword>const</p> {<p class=cm-def>resolve</p>, <p class=cm-def>sep</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"path\"</p>); <p class=cm-keyword>const</p> <p class=cm-def>baseDirectory</p> <p class=cm-operator>=</p> <p class=cm-variable>process</p>.<p class=cm-property>cwd</p>(); <p class=cm-keyword>function</p> <p class=cm-def>urlPath</p>(<p class=cm-def>url</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>pathname</p>} <p class=cm-operator>=</p> <p class=cm-variable>parse</p>(<p class=cm-variable-2>url</p>); <p class=cm-keyword>let</p> <p class=cm-def>path</p> <p class=cm-operator>=</p> <p class=cm-variable>resolve</p>(<p class=cm-variable>decodeURIComponent</p>(<p class=cm-variable-2>pathname</p>).<p class=cm-property>slice</p>(<p class=cm-number>1</p>)); <p class=cm-keyword>if</p> (<p class=cm-variable-2>path</p> <p class=cm-operator>!=</p> <p class=cm-variable>baseDirectory</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-operator>!</p><p class=cm-variable-2>path</p>.<p class=cm-property>startsWith</p>(<p class=cm-variable>baseDirectory</p> <p class=cm-operator>+</p> <p class=cm-variable>sep</p>)) { <p class=cm-keyword>throw</p> {<p class=cm-property>status</p>: <p class=cm-number>403</p>, <p class=cm-property>body</p>: <p class=cm-string>\"Forbidden\"</p>}; } <p class=cm-keyword>return</p> <p class=cm-variable-2>path</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_1NWx24yrl9 class=p_ident id=p_1NWx24yrl9></a>As soon as you set up a program to accept network requests, you have to start worrying about security. In this case, if we aren’t careful, it is likely that we’ll accidentally expose our whole file system to the network.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_m0GNABM8RH class=p_ident id=p_m0GNABM8RH></a>File paths are strings in Node. To map such a string to an actual file, there is a nontrivial amount of interpretation going on. Paths may, for example, include <code>../</code> to refer to a parent directory. So one obvious source of problems would be requests for paths like <code>/../secret_file</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_5zn0AvJXaW class=p_ident id=p_5zn0AvJXaW></a>To avoid such problems, <code>urlPath</code> uses the <code>resolve</code> function from the <code>path</code> module, which resolves relative paths. It then verifies that the result is <em>below</em> the working directory. The <code>process.cwd</code> function (where <code>cwd</code> stands for “current working directory”) can be used to find this working directory. The <code>sep</code> binding from the <code>path</code> package is the system’s path separator—a backslash on Windows and a forward slash on most other systems. When the path doesn’t start with the base directory, the function throws an error response object, using the HTTP status code indicating that access to the resource is forbidden.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_0E1fkrPcjR class=p_ident id=p_0E1fkrPcjR></a>We’ll set up the <code>GET</code> method to return a list of files when reading a directory and to return the file’s content when reading a regular file.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_zj6fKVP9SD class=p_ident id=p_zj6fKVP9SD></a>One tricky question is what kind of <code>Content-Type</code> header we should set when returning a file’s content. Since these files could be anything, our server can’t simply return the same content type for all of them. NPM can help us again here. The <code>mime</code> package (content type indicators like <code>text/plain</code> are also called <em>MIME types</em>) knows the correct type for a large number of file extensions.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ZZr+O24IMr class=p_ident id=p_ZZr+O24IMr></a>The following <code>npm</code> command, in the directory where the server script lives, installs a specific version of <code>mime</code>:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_nzfHTZ/5TP class=c_ident id=c_nzfHTZ/5TP></a>$ npm install mime@2.2.0</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_0oNrzailqn class=p_ident id=p_0oNrzailqn></a>When a requested file does not exist, the correct HTTP status code to return is 404. We’ll use the <code>stat</code> function, which looks up information about a file, to find out both whether the file exists and whether it is a directory.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_bUezN7Otmf class=c_ident id=c_bUezN7Otmf></a><p class=cm-keyword>const</p> {<p class=cm-def>createReadStream</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>);\n<p class=cm-keyword>const</p> {<p class=cm-def>stat</p>, <p class=cm-def>readdir</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>).<p class=cm-property>promises</p>;\n<p class=cm-keyword>const</p> <p class=cm-def>mime</p> <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"mime\"</p>); <p class=cm-variable>methods</p>.<p class=cm-property>GET</p> <p class=cm-operator>=</p> <p class=cm-keyword>async</p> <p class=cm-keyword>function</p>(<p class=cm-def>request</p>) { <p class=cm-keyword>let</p> <p class=cm-def>path</p> <p class=cm-operator>=</p> <p class=cm-variable>urlPath</p>(<p class=cm-variable-2>request</p>.<p class=cm-property>url</p>); <p class=cm-keyword>let</p> <p class=cm-def>stats</p>; <p class=cm-keyword>try</p> { <p class=cm-variable-2>stats</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>stat</p>(<p class=cm-variable-2>path</p>); } <p class=cm-keyword>catch</p> (<p class=cm-def>error</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p>.<p class=cm-property>code</p> <p class=cm-operator>!=</p> <p class=cm-string>\"ENOENT\"</p>) <p class=cm-keyword>throw</p> <p class=cm-variable-2>error</p>; <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> {<p class=cm-property>status</p>: <p class=cm-number>404</p>, <p class=cm-property>body</p>: <p class=cm-string>\"File not found\"</p>}; } <p class=cm-keyword>if</p> (<p class=cm-variable-2>stats</p>.<p class=cm-property>isDirectory</p>()) { <p class=cm-keyword>return</p> {<p class=cm-property>body</p>: (<p class=cm-keyword>await</p> <p class=cm-variable>readdir</p>(<p class=cm-variable-2>path</p>)).<p class=cm-property>join</p>(<p class=cm-string>\"\\n\"</p>)}; } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> {<p class=cm-property>body</p>: <p class=cm-variable>createReadStream</p>(<p class=cm-variable-2>path</p>), <p class=cm-property>type</p>: <p class=cm-variable>mime</p>.<p class=cm-property>getType</p>(<p class=cm-variable-2>path</p>)};\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_iYt4Ms5dC4 class=p_ident id=p_iYt4Ms5dC4></a>Because it has to touch the disk and thus might take a while, <code>stat</code> is asynchronous. Since we’re using promises rather than callback style, it has to be imported from <code>promises</code> instead of directly from <code>fs</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_tdTunaPFS/ class=p_ident id=p_tdTunaPFS/ ></a>When the file does not exist, <code>stat</code> will throw an error object with a <code>code</code> property of <code>\"ENOENT\"</code>. These somewhat obscure, Unix-inspired codes are how you recognize error types in Node.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_f1+vCwgX9M class=p_ident id=p_f1+vCwgX9M></a>The <code>stats</code> object returned by <code>stat</code> tells us a number of things about a file, such as its size (<code>size</code> property) and its modification date (<code>mtime</code> property). Here we are interested in the question of whether it is a directory or a regular file, which the <code>isDirectory</code> method tells us.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_E8HtJSMMtj class=p_ident id=p_E8HtJSMMtj></a>We use <code>readdir</code> to read the array of files in a directory and return it to the client. For normal files, we create a readable stream with <code>createReadStream</code> and return that as the body, along with the content type that the <code>mime</code> package gives us for the file’s name.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_3SF21U54yR class=p_ident id=p_3SF21U54yR></a>The code to handle <code>DELETE</code> requests is slightly simpler.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_QVBbtdK0s5 class=c_ident id=c_QVBbtdK0s5></a><p class=cm-keyword>const</p> {<p class=cm-def>rmdir</p>, <p class=cm-def>unlink</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>).<p class=cm-property>promises</p>; <p class=cm-variable>methods</p>.<p class=cm-property>DELETE</p> <p class=cm-operator>=</p> <p class=cm-keyword>async</p> <p class=cm-keyword>function</p>(<p class=cm-def>request</p>) { <p class=cm-keyword>let</p> <p class=cm-def>path</p> <p class=cm-operator>=</p> <p class=cm-variable>urlPath</p>(<p class=cm-variable-2>request</p>.<p class=cm-property>url</p>); <p class=cm-keyword>let</p> <p class=cm-def>stats</p>; <p class=cm-keyword>try</p> { <p class=cm-variable-2>stats</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>stat</p>(<p class=cm-variable-2>path</p>); } <p class=cm-keyword>catch</p> (<p class=cm-def>error</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p>.<p class=cm-property>code</p> <p class=cm-operator>!=</p> <p class=cm-string>\"ENOENT\"</p>) <p class=cm-keyword>throw</p> <p class=cm-variable-2>error</p>; <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> {<p class=cm-property>status</p>: <p class=cm-number>204</p>}; } <p class=cm-keyword>if</p> (<p class=cm-variable-2>stats</p>.<p class=cm-property>isDirectory</p>()) <p class=cm-keyword>await</p> <p class=cm-variable>rmdir</p>(<p class=cm-variable-2>path</p>); <p class=cm-keyword>else</p> <p class=cm-keyword>await</p> <p class=cm-variable>unlink</p>(<p class=cm-variable-2>path</p>); <p class=cm-keyword>return</p> {<p class=cm-property>status</p>: <p class=cm-number>204</p>};\n};</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_AXYF3FSJbj class=p_ident id=p_AXYF3FSJbj></a>When an HTTP response does not contain any data, the status code 204 (“no content”) can be used to indicate this. Since the response to deletion doesn’t need to transmit any information beyond whether the operation succeeded, that is a sensible thing to return here.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_1CFycX4t/q class=p_ident id=p_1CFycX4t/q></a>You may be wondering why trying to delete a nonexistent file returns a success status code, rather than an error. When the file that is being deleted is not there, you could say that the request’s objective is already fulfilled. The HTTP standard encourages us to make requests <em>idempotent</em>, which means that making the same request multiple times produces the same result as making it once. In a way, if you try to delete something that’s already gone, the effect you were trying to do has been achieved—the thing is no longer there.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_q7xnjGCxyr class=p_ident id=p_q7xnjGCxyr></a>This is the handler for <code>PUT</code> requests:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_SSOayCBrzD class=c_ident id=c_SSOayCBrzD></a><p class=cm-keyword>const</p> {<p class=cm-def>createWriteStream</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"fs\"</p>); <p class=cm-keyword>function</p> <p class=cm-def>pipeStream</p>(<p class=cm-def>from</p>, <p class=cm-def>to</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>((<p class=cm-def>resolve</p>, <p class=cm-def>reject</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>from</p>.<p class=cm-property>on</p>(<p class=cm-string>\"error\"</p>, <p class=cm-variable-2>reject</p>); <p class=cm-variable-2>to</p>.<p class=cm-property>on</p>(<p class=cm-string>\"error\"</p>, <p class=cm-variable-2>reject</p>); <p class=cm-variable-2>to</p>.<p class=cm-property>on</p>(<p class=cm-string>\"finish\"</p>, <p class=cm-variable-2>resolve</p>); <p class=cm-variable-2>from</p>.<p class=cm-property>pipe</p>(<p class=cm-variable-2>to</p>); });\n} <p class=cm-variable>methods</p>.<p class=cm-property>PUT</p> <p class=cm-operator>=</p> <p class=cm-keyword>async</p> <p class=cm-keyword>function</p>(<p class=cm-def>request</p>) { <p class=cm-keyword>let</p> <p class=cm-def>path</p> <p class=cm-operator>=</p> <p class=cm-variable>urlPath</p>(<p class=cm-variable-2>request</p>.<p class=cm-property>url</p>); <p class=cm-keyword>await</p> <p class=cm-variable>pipeStream</p>(<p class=cm-variable-2>request</p>, <p class=cm-variable>createWriteStream</p>(<p class=cm-variable-2>path</p>)); <p class=cm-keyword>return</p> {<p class=cm-property>status</p>: <p class=cm-number>204</p>};\n};</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_uDb6FJuQ47 class=p_ident id=p_uDb6FJuQ47></a>We don’t need to check whether the file exists this time—if it does, we’ll just overwrite it. We again use <code>pipe</code> to move data from a readable stream to a writable one, in this case from the request to the file. But since <code>pipe</code> isn’t written to return a promise, we have to write a wrapper, <code>pipeStream</code>, that creates a promise around the outcome of calling <code>pipe</code>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_DGGAMEixPQ class=p_ident id=p_DGGAMEixPQ></a>When something goes wrong when opening the file, <code>createWriteStream</code> will still return a stream, but that stream will fire an <code>\"error\"</code> event. The output stream to the request may also fail, for example if the network goes down. So we wire up both streams’ <code>\"error\"</code> events to reject the promise. When <code>pipe</code> is done, it will close the output stream, which causes it to fire a <code>\"finish\"</code> event. That’s the point where we can successfully resolve the promise (returning nothing).</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ig7HitKqRz class=p_ident id=p_ig7HitKqRz></a>The full script for the server is available at <a href=https://eloquentjavascript.net/code/file_server.js><em>https://eloquentjavascript.net/code/file_server.js</em></a>. You can download that and, after installing its dependencies, run it with Node to start your own file server. And, of course, you can modify and extend it to solve this chapter’s exercises or to experiment.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_fBFWTJncql class=p_ident id=p_fBFWTJncql></a>The command line tool <code>curl</code>, widely available on Unix-like systems (such as macOS and Linux), can be used to make HTTP requests. The following session briefly tests our server. The <code>-X</code> option is used to set the request’s method, and <code>-d</code> is used to include a request body.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/20_node.html#c_1De9cCo/FY class=c_ident id=c_1De9cCo/FY></a>$ curl http://localhost:8000/file.txt\nFile not found\n$ curl -X PUT -d hello http://localhost:8000/file.txt\n$ curl http://localhost:8000/file.txt\nhello\n$ curl -X DELETE http://localhost:8000/file.txt\n$ curl http://localhost:8000/file.txt\nFile not found</pre> <p><a href=https://eloquentjavascript.net/20_node.html#p_AmMFBJGSkb class=p_ident id=p_AmMFBJGSkb></a>The first request for <code>file.txt</code> fails since the file does not exist yet. The <code>PUT</code> request creates the file, and behold, the next request successfully retrieves it. After deleting it with a <code>DELETE</code> request, the file is again missing.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/20_node.html#p_aI1QIDZs29 class=p_ident id=p_aI1QIDZs29></a>Node is a nice, small system that lets us run JavaScript in a nonbrowser context. It was originally designed for network tasks to play the role of a <em>node</em> in a network. But it lends itself to all kinds of scripting tasks, and if writing JavaScript is something you enjoy, automating tasks with Node works well.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_pVLEV4YWAu class=p_ident id=p_pVLEV4YWAu></a>NPM provides packages for everything you can think of (and quite a few things you’d probably never think of), and it allows you to fetch and install those packages with the <code>npm</code> program. Node comes with a number of built-in modules, including the <code>fs</code> module for working with the file system and the <code>http</code> module for running HTTP servers and making HTTP requests.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_FBsszxt4wi class=p_ident id=p_FBsszxt4wi></a>All input and output in Node is done asynchronously, unless you explicitly use a synchronous variant of a function, such as <code>readFileSync</code>. When calling such asynchronous functions, you provide callback functions, and Node will call them with an error value and (if available) a result when it is ready.</p> <h2><a href=https://eloquentjavascript.net/20_node.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/20_node.html#i_9+y+iovU0J class=i_ident id=i_9+y+iovU0J></a>Search tool</h3> <p><a href=https://eloquentjavascript.net/20_node.html#p_ca6ZBtGx1B class=p_ident id=p_ca6ZBtGx1B></a>On Unix systems, there is a command line tool called <code>grep</code> that can be used to quickly search files for a regular expression.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_/pAmPm2px7 class=p_ident id=p_/pAmPm2px7></a>Write a Node script that can be run from the command line and acts somewhat like <code>grep</code>. It treats its first command line argument as a regular expression and treats any further arguments as files to search. It should output the names of any file whose content matches the regular expression.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_ddYdvItkvN class=p_ident id=p_ddYdvItkvN></a>When that works, extend it so that when one of the arguments is a directory, it searches through all files in that directory and its subdirectories.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_y4ht4tsxKI class=p_ident id=p_y4ht4tsxKI></a>Use asynchronous or synchronous file system functions as you see fit. Setting things up so that multiple asynchronous actions are requested at the same time might speed things up a little, but not a huge amount, since most file systems can read only one thing at a time.</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/20_node.html#p_3yQPGLxU85 class=p_ident id=p_3yQPGLxU85></a>Your first command line argument, the regular expression, can be found in <code>process.argv[2]</code>. The input files come after that. You can use the <code>RegExp</code> constructor to go from a string to a regular expression object.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_h+mtaoCbhZ class=p_ident id=p_h+mtaoCbhZ></a>Doing this synchronously, with <code>readFileSync</code>, is more straightforward, but if you use <code>fs.promises</code> again to get promise-returning functions and write an <code>async</code> function, the code looks similar.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_r0XgnA8VK0 class=p_ident id=p_r0XgnA8VK0></a>To figure out whether something is a directory, you can again use <code>stat</code> (or <code>statSync</code>) and the stats object’s <code>isDirectory</code> method.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_KiWSClPPul class=p_ident id=p_KiWSClPPul></a>Exploring a directory is a branching process. You can do it either by using a recursive function or by keeping an array of work (files that still need to be explored). To find the files in a directory, you can call <code>readdir</code> or <code>readdirSync</code>. The strange capitalization—Node’s file system function naming is loosely based on standard Unix functions, such as <code>readdir</code>, that are all lowercase, but then it adds <code>Sync</code> with a capital letter.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_dYrkZNxSEL class=p_ident id=p_dYrkZNxSEL></a>To go from a filename read with <code>readdir</code> to a full path name, you have to combine it with the name of the directory, putting a slash character (<code>/</code>) between them.</p> </div></div> <h3><a href=https://eloquentjavascript.net/20_node.html#i_h8iNiA8ezX class=i_ident id=i_h8iNiA8ezX></a>Directory creation</h3> <p><a href=https://eloquentjavascript.net/20_node.html#p_eKscmrM/cp class=p_ident id=p_eKscmrM/cp></a>Though the <code>DELETE</code> method in our file server is able to delete directories (using <code>rmdir</code>), the server currently does not provide any way to <em>create</em> a directory.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_GpjSLUJk84 class=p_ident id=p_GpjSLUJk84></a>Add support for the <code>MKCOL</code> method (“make collection”), which should create a directory by calling <code>mkdir</code> from the <code>fs</code> module. <code>MKCOL</code> is not a widely used HTTP method, but it does exist for this same purpose in the <em>WebDAV</em> standard, which specifies a set of conventions on top of HTTP that make it suitable for creating documents.</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/20_node.html#p_Ptyerm4lHs class=p_ident id=p_Ptyerm4lHs></a>You can use the function that implements the <code>DELETE</code> method as a blueprint for the <code>MKCOL</code> method. When no file is found, try to create a directory with <code>mkdir</code>. When a directory exists at that path, you can return a 204 response so that directory creation requests are idempotent. If a nondirectory file exists here, return an error code. Code 400 (“bad request”) would be appropriate.</p> </div></div> <h3><a href=https://eloquentjavascript.net/20_node.html#i_TLRTlwK6ZU class=i_ident id=i_TLRTlwK6ZU></a>A public space on the web</h3> <p><a href=https://eloquentjavascript.net/20_node.html#p_fGFbxH6/FF class=p_ident id=p_fGFbxH6/FF></a>Since the file server serves up any kind of file and even includes the right <code>Content-Type</code> header, you can use it to serve a website. Since it allows everybody to delete and replace files, it would be an interesting kind of website: one that can be modified, improved, and vandalized by everybody who takes the time to create the right HTTP request.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_A9LlE9TbZm class=p_ident id=p_A9LlE9TbZm></a>Write a basic HTML page that includes a simple JavaScript file. Put the files in a directory served by the file server and open them in your browser.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_6IZvK/z6Ez class=p_ident id=p_6IZvK/z6Ez></a>Next, as an advanced exercise or even a weekend project, combine all the knowledge you gained from this book to build a more user-friendly interface for modifying the website—from <em>inside</em> the website.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_PMJCxe07g5 class=p_ident id=p_PMJCxe07g5></a>Use an HTML form to edit the content of the files that make up the website, allowing the user to update them on the server by using HTTP requests, as described in <a href=https://eloquentjavascript.net/18_http.html>Chapter 18</a>.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_hWSA1+odAv class=p_ident id=p_hWSA1+odAv></a>Start by making only a single file editable. Then make it so that the user can select which file to edit. Use the fact that our file server returns lists of files when reading a directory.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_5JDgu6tuAT class=p_ident id=p_5JDgu6tuAT></a>Don’t work directly in the code exposed by the file server since if you make a mistake, you are likely to damage the files there. Instead, keep your work outside of the publicly accessible directory and copy it there when testing.</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/20_node.html#p_v9JKMD5WJI class=p_ident id=p_v9JKMD5WJI></a>You can create a <code>&lt;textarea&gt;</code> element to hold the content of the file that is being edited. A <code>GET</code> request, using <code>fetch</code>, can retrieve the current content of the file. You can use relative URLs like <em>index.html</em>, instead of <a href=http://localhost:8000/index.html><em>http://localhost:8000/index.html</em></a>, to refer to files on the same server as the running script.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_AddxfNwTA3 class=p_ident id=p_AddxfNwTA3></a>Then, when the user clicks a button (you can use a <code>&lt;form&gt;</code> element and <code>\"submit\"</code> event), make a <code>PUT</code> request to the same URL, with the content of the <code>&lt;textarea&gt;</code> as request body, to save the file.</p> <p><a href=https://eloquentjavascript.net/20_node.html#p_E3aBDoYaVe class=p_ident id=p_E3aBDoYaVe></a>You can then add a <code>&lt;select&gt;</code> element that contains all the files in the server’s top directory by adding <code>&lt;option&gt;</code> elements containing the lines returned by a <code>GET</code> request to the URL <code>/</code>. When the user selects another file (a <code>\"change\"</code> event on the field), the script must fetch and display that file. When saving a file, use the currently selected filename.</p> </div></div><nav><a href=https://eloquentjavascript.net/19_paint.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/21_skillsharing.html>▶</a></nav>\n</article><hr><h4>Page 6</h4><article score=680.3>\n<nav><a href=https://eloquentjavascript.net/09_regexp.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/11_async.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/10_modules.html#p_OwlHMaRbBt class=p_ident id=p_OwlHMaRbBt></a>Write code that is easy to delete, not easy to extend.</p> <footer>Tef, <cite>Programming is Terrible</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a building built from modular pieces\" src=https://eloquentjavascript.net/img/chapter_picture_10.jpg></figure> <p><a href=https://eloquentjavascript.net/10_modules.html#p_lt7t/NZub8 class=p_ident id=p_lt7t/NZub8></a>The ideal program has a crystal-clear structure. The way it works is easy to explain, and each part plays a well-defined role.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_HLTCewyOYT class=p_ident id=p_HLTCewyOYT></a>A typical real program grows organically. New pieces of functionality are added as new needs come up. Structuring—and preserving structure—is additional work. It’s work that will pay off only in the future, the <em>next</em> time someone works on the program. So it is tempting to neglect it and allow the parts of the program to become deeply entangled.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_Ph53LAfIAv class=p_ident id=p_Ph53LAfIAv></a>This causes two practical issues. First, understanding such a system is hard. If everything can touch everything else, it is difficult to look at any given piece in isolation. You are forced to build up a holistic understanding of the entire thing. Second, if you want to use any of the functionality from such a program in another situation, rewriting it may be easier than trying to disentangle it from its context.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_pzOEW37Kfc class=p_ident id=p_pzOEW37Kfc></a>The phrase “big ball of mud” is often used for such large, structureless programs. Everything sticks together, and when you try to pick out a piece, the whole thing comes apart, and your hands get dirty.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_BOlGLA/wK7 class=h_ident id=h_BOlGLA/wK7></a>Modules</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_LoWZBZ2Vpv class=p_ident id=p_LoWZBZ2Vpv></a><em>Modules</em> are an attempt to avoid these problems. A module is a piece of program that specifies which other pieces it relies on and which functionality it provides for other modules to use (its <em>interface</em>).</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_kjhUrZ1SF0 class=p_ident id=p_kjhUrZ1SF0></a>Module interfaces have a lot in common with object interfaces, as we saw them in <a href=https://eloquentjavascript.net/06_object.html#interface>Chapter 6</a>. They make part of the module available to the outside world and keep the rest private. By restricting the ways in which modules interact with each other, the system becomes more like LEGO, where pieces interact through well-defined connectors, and less like mud, where everything mixes with everything.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_l+1k6bprY2 class=p_ident id=p_l+1k6bprY2></a>The relations between modules are called <em>dependencies</em>. When a module needs a piece from another module, it is said to depend on that module. When this fact is clearly specified in the module itself, it can be used to figure out which other modules need to be present to be able to use a given module and to automatically load dependencies.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_4WkC7snvFx class=p_ident id=p_4WkC7snvFx></a>To separate modules in that way, each needs its own private scope.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_bgQuCetNwq class=p_ident id=p_bgQuCetNwq></a>Just putting your JavaScript code into different files does not satisfy these requirements. The files still share the same global namespace. They can, intentionally or accidentally, interfere with each other’s bindings. And the dependency structure remains unclear. We can do better, as we’ll see later in the chapter.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_uf1CU70zfG class=p_ident id=p_uf1CU70zfG></a>Designing a fitting module structure for a program can be difficult. In the phase where you are still exploring the problem, trying different things to see what works, you might want to not worry about it too much since it can be a big distraction. Once you have something that feels solid, that’s a good time to take a step back and organize it.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_CpmQEv+4ez class=h_ident id=h_CpmQEv+4ez></a>Packages</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_g7o14y8ONd class=p_ident id=p_g7o14y8ONd></a>One of the advantages of building a program out of separate pieces, and being actually able to run those pieces on their own, is that you might be able to apply the same piece in different programs.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_iBvlR95Pda class=p_ident id=p_iBvlR95Pda></a>But how do you set this up? Say I want to use the <code>parseINI</code> function from <a href=https://eloquentjavascript.net/09_regexp.html#ini>Chapter 9</a> in another program. If it is clear what the function depends on (in this case, nothing), I can just copy all the necessary code into my new project and use it. But then, if I find a mistake in that code, I’ll probably fix it in whichever program I’m working with at the time and forget to also fix it in the other program.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_TA/SfLJ50i class=p_ident id=p_TA/SfLJ50i></a>Once you start duplicating code, you’ll quickly find yourself wasting time and energy moving copies around and keeping them up-to-date.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_CNI2vOkPJp class=p_ident id=p_CNI2vOkPJp></a>That’s where <em>packages</em> come in. A package is a chunk of code that can be distributed (copied and installed). It may contain one or more modules and has information about which other packages it depends on. A package also usually comes with documentation explaining what it does so that people who didn’t write it might still be able to use it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_sZgcoPgtEe class=p_ident id=p_sZgcoPgtEe></a>When a problem is found in a package or a new feature is added, the package is updated. Now the programs that depend on it (which may also be packages) can upgrade to the new version.</p> <p id=modules_npm><a href=https://eloquentjavascript.net/10_modules.html#p_oiLHr3lvbw class=p_ident id=p_oiLHr3lvbw></a>Working in this way requires infrastructure. We need a place to store and find packages and a convenient way to install and upgrade them. In the JavaScript world, this infrastructure is provided by NPM (<a href=https://npmjs.org/ ><em>https://npmjs.org</em></a>).</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_WUPNc5b7D2 class=p_ident id=p_WUPNc5b7D2></a>NPM is two things: an online service where one can download (and upload) packages and a program (bundled with Node.js) that helps you install and manage them.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_kcXuOxm8Rl class=p_ident id=p_kcXuOxm8Rl></a>At the time of writing, there are more than half a million different packages available on NPM. A large portion of those are rubbish, I should mention, but almost every useful, publicly available package can be found on there. For example, an INI file parser, similar to the one we built in <a href=https://eloquentjavascript.net/09_regexp.html>Chapter 9</a>, is available under the package name <code>ini</code>.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_irXmhzBaaT class=p_ident id=p_irXmhzBaaT></a><a href=https://eloquentjavascript.net/20_node.html>Chapter 20</a> will show how to install such packages locally using the <code>npm</code> command line program.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_D/2FJ7Crwg class=p_ident id=p_D/2FJ7Crwg></a>Having quality packages available for download is extremely valuable. It means that we can often avoid reinventing a program that 100 people have written before and get a solid, well-tested implementation at the press of a few keys.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_4hMCknNFh+ class=p_ident id=p_4hMCknNFh+></a>Software is cheap to copy, so once someone has written it, distributing it to other people is an efficient process. But writing it in the first place <em>is</em> work, and responding to people who have found problems in the code, or who want to propose new features, is even more work.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_K/LevaOaUV class=p_ident id=p_K/LevaOaUV></a>By default, you own the copyright to the code you write, and other people may use it only with your permission. But because some people are just nice and because publishing good software can help make you a little bit famous among programmers, many packages are published under a license that explicitly allows other people to use it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_sWMlqqRmbd class=p_ident id=p_sWMlqqRmbd></a>Most code on NPM is licensed this way. Some licenses require you to also publish code that you build on top of the package under the same license. Others are less demanding, just requiring that you keep the license with the code as you distribute it. The JavaScript community mostly uses the latter type of license. When using other people’s packages, make sure you are aware of their license.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_QQ/m+TRmqd class=h_ident id=h_QQ/m+TRmqd></a>Improvised modules</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_VhfSheFY3t class=p_ident id=p_VhfSheFY3t></a>Until 2015, the JavaScript language had no built-in module system. Yet people had been building large systems in JavaScript for more than a decade, and they <em>needed</em> modules.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_EThAZWj4TA class=p_ident id=p_EThAZWj4TA></a>So they designed their own module systems on top of the language. You can use JavaScript functions to create local scopes and objects to represent module interfaces.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_3jjByT+Dg0 class=p_ident id=p_3jjByT+Dg0></a>This is a module for going between day names and numbers (as returned by <code>Date</code>’s <code>getDay</code> method). Its interface consists of <code>weekDay.name</code> and <code>weekDay.number</code>, and it hides its local binding <code>names</code> inside the scope of a function expression that is immediately invoked.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_m+yRMF5NXw class=c_ident id=c_m+yRMF5NXw></a><p class=cm-keyword>const</p> <p class=cm-def>weekDay</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>() { <p class=cm-keyword>const</p> <p class=cm-def>names</p> <p class=cm-operator>=</p> [<p class=cm-string>\"Sunday\"</p>, <p class=cm-string>\"Monday\"</p>, <p class=cm-string>\"Tuesday\"</p>, <p class=cm-string>\"Wednesday\"</p>, <p class=cm-string>\"Thursday\"</p>, <p class=cm-string>\"Friday\"</p>, <p class=cm-string>\"Saturday\"</p>]; <p class=cm-keyword>return</p> { <p class=cm-property>name</p>(<p class=cm-def>number</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>names</p>[<p class=cm-variable-2>number</p>]; }, <p class=cm-property>number</p>(<p class=cm-def>name</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>names</p>.<p class=cm-property>indexOf</p>(<p class=cm-variable-2>name</p>); } };\n}(); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>weekDay</p>.<p class=cm-property>name</p>(<p class=cm-variable>weekDay</p>.<p class=cm-property>number</p>(<p class=cm-string>\"Sunday\"</p>)));\n</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_uv8xnuw95L class=p_ident id=p_uv8xnuw95L></a>This style of modules provides isolation, to a certain degree, but it does not declare dependencies. Instead, it just puts its interface into the global scope and expects its dependencies, if any, to do the same. For a long time this was the main approach used in web programming, but it is mostly obsolete now.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_i8xxHMuJw+ class=p_ident id=p_i8xxHMuJw+></a>If we want to make dependency relations part of the code, we’ll have to take control of loading dependencies. Doing that requires being able to execute strings as code. JavaScript can do this.</p> <h2 id=eval><a href=https://eloquentjavascript.net/10_modules.html#h_oeOkEDaadU class=h_ident id=h_oeOkEDaadU></a>Evaluating data as code</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_jvij1au4eP class=p_ident id=p_jvij1au4eP></a>There are several ways to take data (a string of code) and run it as part of the current program.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_8T3Py6Zkwc class=p_ident id=p_8T3Py6Zkwc></a>The most obvious way is the special operator <code>eval</code>, which will execute a string in the <em>current</em> scope. This is usually a bad idea because it breaks some of the properties that scopes normally have, such as it being easily predictable which binding a given name refers to.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_14x3bOXX9G class=c_ident id=c_14x3bOXX9G></a><p class=cm-keyword>const</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>;\n<p class=cm-keyword>function</p> <p class=cm-def>evalAndReturnX</p>(<p class=cm-def>code</p>) { <p class=cm-variable>eval</p>(<p class=cm-variable-2>code</p>); <p class=cm-keyword>return</p> <p class=cm-variable>x</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>evalAndReturnX</p>(<p class=cm-string>\"var x = 2\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>x</p>);\n</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_wzjzmC3uLa class=p_ident id=p_wzjzmC3uLa></a>A less scary way of interpreting data as code is to use the <code>Function</code> constructor. It takes two arguments: a string containing a comma-separated list of argument names and a string containing the function body. It wraps the code in a function value so that it gets its own scope and won’t do odd things with other scopes.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_Mc9BAi4AVK class=c_ident id=c_Mc9BAi4AVK></a><p class=cm-keyword>let</p> <p class=cm-def>plusOne</p> <p class=cm-operator>=</p> <p class=cm-variable>Function</p>(<p class=cm-string>\"n\"</p>, <p class=cm-string>\"return n + 1;\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>plusOne</p>(<p class=cm-number>4</p>));\n</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_vgKeYBfC4h class=p_ident id=p_vgKeYBfC4h></a>This is precisely what we need for a module system. We can wrap the module’s code in a function and use that function’s scope as module scope.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_N33QHgUxbG class=h_ident id=h_N33QHgUxbG></a>CommonJS</h2> <p id=commonjs><a href=https://eloquentjavascript.net/10_modules.html#p_kAtCGxNjIq class=p_ident id=p_kAtCGxNjIq></a>The most widely used approach to bolted-on JavaScript modules is called <em>CommonJS modules</em>. Node.js uses it and is the system used by most packages on NPM.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_NM2zfHqLcE class=p_ident id=p_NM2zfHqLcE></a>The main concept in CommonJS modules is a function called <code>require</code>. When you call this with the module name of a dependency, it makes sure the module is loaded and returns its interface.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_CNeZtts3Cz class=p_ident id=p_CNeZtts3Cz></a>Because the loader wraps the module code in a function, modules automatically get their own local scope. All they have to do is call <code>require</code> to access their dependencies and put their interface in the object bound to <code>exports</code>.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_ew2dDAURuM class=p_ident id=p_ew2dDAURuM></a>This example module provides a date-formatting function. It uses two packages from NPM—<code>ordinal</code> to convert numbers to strings like <code>\"1st\"</code> and <code>\"2nd\"</code>, and <code>date-names</code> to get the English names for weekdays and months. It exports a single function, <code>formatDate</code>, which takes a <code>Date</code> object and a template string.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_fH0b3BN1Fp class=p_ident id=p_fH0b3BN1Fp></a>The template string may contain codes that direct the format, such as <code>YYYY</code> for the full year and <code>Do</code> for the ordinal day of the month. You could give it a string like <code>\"MMMM Do YYYY\"</code> to get output like “November 22nd 2017”.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_hEFnba6fud class=c_ident id=c_hEFnba6fud></a><p class=cm-keyword>const</p> <p class=cm-def>ordinal</p> <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"ordinal\"</p>);\n<p class=cm-keyword>const</p> {<p class=cm-def>days</p>, <p class=cm-def>months</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"date-names\"</p>); <p class=cm-variable>exports</p>.<p class=cm-property>formatDate</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>date</p>, <p class=cm-def>format</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>format</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/YYYY|M(MMM)?|Do?|dddd/g</p>, <p class=cm-def>tag</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"YYYY\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>date</p>.<p class=cm-property>getFullYear</p>(); <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"M\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>date</p>.<p class=cm-property>getMonth</p>(); <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"MMMM\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable>months</p>[<p class=cm-variable-2>date</p>.<p class=cm-property>getMonth</p>()]; <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"D\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>date</p>.<p class=cm-property>getDate</p>(); <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"Do\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable>ordinal</p>(<p class=cm-variable-2>date</p>.<p class=cm-property>getDate</p>()); <p class=cm-keyword>if</p> (<p class=cm-variable-2>tag</p> <p class=cm-operator>==</p> <p class=cm-string>\"dddd\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable>days</p>[<p class=cm-variable-2>date</p>.<p class=cm-property>getDay</p>()];\n  });\n};</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_jvrgfRxGB4 class=p_ident id=p_jvrgfRxGB4></a>The interface of <code>ordinal</code> is a single function, whereas <code>date-names</code> exports an object containing multiple things—<code>days</code> and <code>months</code> are arrays of names. Destructuring is very convenient when creating bindings for imported interfaces.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_cHv4rZkvfj class=p_ident id=p_cHv4rZkvfj></a>The module adds its interface function to <code>exports</code> so that modules that depend on it get access to it. We could use the module like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_pWURcHuHTt class=c_ident id=c_pWURcHuHTt></a><p class=cm-keyword>const</p> {<p class=cm-def>formatDate</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"./format-date\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>formatDate</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-number>2017</p>, <p class=cm-number>9</p>, <p class=cm-number>13</p>), <p class=cm-string>\"dddd the Do\"</p>));\n</pre> <p id=require><a href=https://eloquentjavascript.net/10_modules.html#p_vmJrDleGRH class=p_ident id=p_vmJrDleGRH></a>We can define <code>require</code>, in its most minimal form, like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_CSMfqoYOzp class=c_ident id=c_CSMfqoYOzp></a><p class=cm-variable>require</p>.<p class=cm-property>cache</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-keyword>function</p> <p class=cm-def>require</p>(<p class=cm-def>name</p>) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p>(<p class=cm-variable-2>name</p> <p class=cm-keyword>in</p> <p class=cm-variable>require</p>.<p class=cm-property>cache</p>)) { <p class=cm-keyword>let</p> <p class=cm-def>code</p> <p class=cm-operator>=</p> <p class=cm-variable>readFile</p>(<p class=cm-variable-2>name</p>); <p class=cm-keyword>let</p> <p class=cm-def>module</p> <p class=cm-operator>=</p> {<p class=cm-property>exports</p>: {}}; <p class=cm-variable>require</p>.<p class=cm-property>cache</p>[<p class=cm-variable-2>name</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>module</p>; <p class=cm-keyword>let</p> <p class=cm-def>wrapper</p> <p class=cm-operator>=</p> <p class=cm-variable>Function</p>(<p class=cm-string>\"require, exports, module\"</p>, <p class=cm-variable-2>code</p>); <p class=cm-variable-2>wrapper</p>(<p class=cm-variable>require</p>, <p class=cm-variable-2>module</p>.<p class=cm-property>exports</p>, <p class=cm-variable-2>module</p>); } <p class=cm-keyword>return</p> <p class=cm-variable>require</p>.<p class=cm-property>cache</p>[<p class=cm-variable-2>name</p>].<p class=cm-property>exports</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_sc1VEkBDCY class=p_ident id=p_sc1VEkBDCY></a>In this code, <code>readFile</code> is a made-up function that reads a file and returns its contents as a string. Standard JavaScript provides no such functionality—but different JavaScript environments, such as the browser and Node.js, provide their own ways of accessing files. The example just pretends that <code>readFile</code> exists.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_DxNIETFONd class=p_ident id=p_DxNIETFONd></a>To avoid loading the same module multiple times, <code>require</code> keeps a store (cache) of already loaded modules. When called, it first checks if the requested module has been loaded and, if not, loads it. This involves reading the module’s code, wrapping it in a function, and calling it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_tI7DzFSLjM class=p_ident id=p_tI7DzFSLjM></a>The interface of the <code>ordinal</code> package we saw before is not an object but a function. A quirk of the CommonJS modules is that, though the module system will create an empty interface object for you (bound to <code>exports</code>), you can replace that with any value by overwriting <code>module.exports</code>. This is done by many modules to export a single value instead of an interface object.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_1en0vUqbeI class=p_ident id=p_1en0vUqbeI></a>By defining <code>require</code>, <code>exports</code>, and <code>module</code> as parameters for the generated wrapper function (and passing the appropriate values when calling it), the loader makes sure that these bindings are available in the module’s scope.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_xriS0EN27o class=p_ident id=p_xriS0EN27o></a>The way the string given to <code>require</code> is translated to an actual filename or web address differs in different systems. When it starts with <code>\"./\"</code> or <code>\"../\"</code>, it is generally interpreted as relative to the current module’s filename. So <code>\"./<wbr>format-date\"</code> would be the file named <code>format-date.js</code> in the same directory.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_L5+LG67XHa class=p_ident id=p_L5+LG67XHa></a>When the name isn’t relative, Node.js will look for an installed package by that name. In the example code in this chapter, we’ll interpret such names as referring to NPM packages. We’ll go into more detail on how to install and use NPM modules in <a href=https://eloquentjavascript.net/20_node.html>Chapter 20</a>.</p> <p id=modules_ini><a href=https://eloquentjavascript.net/10_modules.html#p_B5bzWP/zEC class=p_ident id=p_B5bzWP/zEC></a>Now, instead of writing our own INI file parser, we can use one from NPM.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_LfcCXOMZGr class=c_ident id=c_LfcCXOMZGr></a><p class=cm-keyword>const</p> {<p class=cm-def>parse</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"ini\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>parse</p>(<p class=cm-string>\"x = 10\\ny = 20\"</p>));\n</pre> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_hF2FmOVxw7 class=h_ident id=h_hF2FmOVxw7></a>ECMAScript modules</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_ZB3AF/XP4y class=p_ident id=p_ZB3AF/XP4y></a>CommonJS modules work quite well and, in combination with NPM, have allowed the JavaScript community to start sharing code on a large scale.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_yy6++k1U8b class=p_ident id=p_yy6++k1U8b></a>But they remain a bit of a duct-tape hack. The notation is slightly awkward—the things you add to <code>exports</code> are not available in the local scope, for example. And because <code>require</code> is a normal function call taking any kind of argument, not just a string literal, it can be hard to determine the dependencies of a module without running its code.</p> <p id=es><a href=https://eloquentjavascript.net/10_modules.html#p_fGE1JkAJHH class=p_ident id=p_fGE1JkAJHH></a>This is why the JavaScript standard from 2015 introduces its own, different module system. It is usually called <em>ES modules</em>, where <em>ES</em> stands for ECMAScript. The main concepts of dependencies and interfaces remain the same, but the details differ. For one thing, the notation is now integrated into the language. Instead of calling a function to access a dependency, you use a special <code>import</code> keyword.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_EpiH8qOAcJ class=c_ident id=c_EpiH8qOAcJ></a><p class=cm-keyword>import</p> <p class=cm-def>ordinal</p> <p class=cm-keyword>from</p> <p class=cm-string>\"ordinal\"</p>;\n<p class=cm-keyword>import</p> {<p class=cm-def>days</p>, <p class=cm-def>months</p>} <p class=cm-keyword>from</p> <p class=cm-string>\"date-names\"</p>; <p class=cm-keyword>export</p> <p class=cm-keyword>function</p> <p class=cm-def>formatDate</p>(<p class=cm-def>date</p>, <p class=cm-def>format</p>) {  }</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_Md0hUIO/t1 class=p_ident id=p_Md0hUIO/t1></a>Similarly, the <code>export</code> keyword is used to export things. It may appear in front of a function, class, or binding definition (<code>let</code>, <code>const</code>, or <code>var</code>).</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_2XcNI5i8RP class=p_ident id=p_2XcNI5i8RP></a>An ES module’s interface is not a single value but a set of named bindings. The preceding module binds <code>formatDate</code> to a function. When you import from another module, you import the <em>binding</em>, not the value, which means an exporting module may change the value of the binding at any time, and the modules that import it will see its new value.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_H96aQvDt7C class=p_ident id=p_H96aQvDt7C></a>When there is a binding named <code>default</code>, it is treated as the module’s main exported value. If you import a module like <code>ordinal</code> in the example, without braces around the binding name, you get its <code>default</code> binding. Such modules can still export other bindings under different names alongside their <code>default</code> export.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_C4XHB0ByrT class=p_ident id=p_C4XHB0ByrT></a>To create a default export, you write <code>export default</code> before an expression, a function declaration, or a class declaration.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_Y6Wnu9X+/W class=c_ident id=c_Y6Wnu9X+/W></a><p class=cm-keyword>export</p> <p class=cm-keyword>default</p> [<p class=cm-string>\"Winter\"</p>, <p class=cm-string>\"Spring\"</p>, <p class=cm-string>\"Summer\"</p>, <p class=cm-string>\"Autumn\"</p>];</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_XbHIrV+nuJ class=p_ident id=p_XbHIrV+nuJ></a>It is possible to rename imported bindings using the word <code>as</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_I7jPaQvsXj class=c_ident id=c_I7jPaQvsXj></a><p class=cm-keyword>import</p> {<p class=cm-def>days</p> <p class=cm-keyword>as</p> <p class=cm-def>dayNames</p>} <p class=cm-keyword>from</p> <p class=cm-string>\"date-names\"</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dayNames</p>.<p class=cm-property>length</p>);\n</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_oqym70c7ZR class=p_ident id=p_oqym70c7ZR></a>Another important difference is that ES module imports happen before a module’s script starts running. That means <code>import</code> declarations may not appear inside functions or blocks, and the names of dependencies must be quoted strings, not arbitrary expressions.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_+UaRV7zy4m class=p_ident id=p_+UaRV7zy4m></a>At the time of writing, the JavaScript community is in the process of adopting this module style. But it has been a slow process. It took a few years, after the format was specified, for browsers and Node.js to start supporting it. And though they mostly support it now, this support still has issues, and the discussion on how such modules should be distributed through NPM is still ongoing.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_UEipP/dEjR class=p_ident id=p_UEipP/dEjR></a>Many projects are written using ES modules and then automatically converted to some other format when published. We are in a transitional period in which two different module systems are used side by side, and it is useful to be able to read and write code in either of them.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_zWTXAU93DC class=h_ident id=h_zWTXAU93DC></a>Building and bundling</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_Si0Uy8W7Rk class=p_ident id=p_Si0Uy8W7Rk></a>In fact, many JavaScript projects aren’t even, technically, written in JavaScript. There are extensions, such as the type checking dialect mentioned in <a href=https://eloquentjavascript.net/08_error.html#typing>Chapter 8</a>, that are widely used. People also often start using planned extensions to the language long before they have been added to the platforms that actually run JavaScript.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_8YI40LC/+x class=p_ident id=p_8YI40LC/+x></a>To make this possible, they <em>compile</em> their code, translating it from their chosen JavaScript dialect to plain old JavaScript—or even to a past version of JavaScript—so that old browsers can run it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_xCwSgQaAdq class=p_ident id=p_xCwSgQaAdq></a>Including a modular program that consists of 200 different files in a web page produces its own problems. If fetching a single file over the network takes 50 milliseconds, loading the whole program takes 10 seconds, or maybe half that if you can load several files simultaneously. That’s a lot of wasted time. Because fetching a single big file tends to be faster than fetching a lot of tiny ones, web programmers have started using tools that roll their programs (which they painstakingly split into modules) back into a single big file before they publish it to the Web. Such tools are called <em>bundlers</em>.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_F5bhvXPahh class=p_ident id=p_F5bhvXPahh></a>And we can go further. Apart from the number of files, the <em>size</em> of the files also determines how fast they can be transferred over the network. Thus, the JavaScript community has invented <em>minifiers</em>. These are tools that take a JavaScript program and make it smaller by automatically removing comments and whitespace, renaming bindings, and replacing pieces of code with equivalent code that take up less space.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_0kzBnsBjVM class=p_ident id=p_0kzBnsBjVM></a>So it is not uncommon for the code that you find in an NPM package or that runs on a web page to have gone through <em>multiple</em> stages of transformation—converted from modern JavaScript to historic JavaScript, from ES module format to CommonJS, bundled, and minified. We won’t go into the details of these tools in this book since they tend to be boring and change rapidly. Just be aware that the JavaScript code you run is often not the code as it was written.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_P8pyzbI9vO class=h_ident id=h_P8pyzbI9vO></a>Module design</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_8K2T8s7itK class=p_ident id=p_8K2T8s7itK></a>Structuring programs is one of the subtler aspects of programming. Any nontrivial piece of functionality can be modeled in various ways.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_98c2qP5s8p class=p_ident id=p_98c2qP5s8p></a>Good program design is subjective—there are trade-offs involved and matters of taste. The best way to learn the value of well-structured design is to read or work on a lot of programs and notice what works and what doesn’t. Don’t assume that a painful mess is “just the way it is”. You can improve the structure of almost everything by putting more thought into it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_AF7qUrMoR4 class=p_ident id=p_AF7qUrMoR4></a>One aspect of module design is ease of use. If you are designing something that is intended to be used by multiple people—or even by yourself, in three months when you no longer remember the specifics of what you did—it is helpful if your interface is simple and predictable.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_hHDSnM2Orb class=p_ident id=p_hHDSnM2Orb></a>That may mean following existing conventions. A good example is the <code>ini</code> package. This module imitates the standard <code>JSON</code> object by providing <code>parse</code> and <code>stringify</code> (to write an INI file) functions, and, like <code>JSON</code>, converts between strings and plain objects. So the interface is small and familiar, and after you’ve worked with it once, you’re likely to remember how to use it.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_uS+as91Giv class=p_ident id=p_uS+as91Giv></a>Even if there’s no standard function or widely used package to imitate, you can keep your modules predictable by using simple data structures and doing a single, focused thing. Many of the INI-file parsing modules on NPM provide a function that directly reads such a file from the hard disk and parses it, for example. This makes it impossible to use such modules in the browser, where we don’t have direct file system access, and adds complexity that would have been better addressed by <em>composing</em> the module with some file-reading function.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_JYcq/PgjlO class=p_ident id=p_JYcq/PgjlO></a>This points to another helpful aspect of module design—the ease with which something can be composed with other code. Focused modules that compute values are applicable in a wider range of programs than bigger modules that perform complicated actions with side effects. An INI file reader that insists on reading the file from disk is useless in a scenario where the file’s content comes from some other source.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_6cqySeVoki class=p_ident id=p_6cqySeVoki></a>Relatedly, stateful objects are sometimes useful or even necessary, but if something can be done with a function, use a function. Several of the INI file readers on NPM provide an interface style that requires you to first create an object, then load the file into your object, and finally use specialized methods to get at the results. This type of thing is common in the object-oriented tradition, and it’s terrible. Instead of making a single function call and moving on, you have to perform the ritual of moving your object through various states. And because the data is now wrapped in a specialized object type, all code that interacts with it has to know about that type, creating unnecessary interdependencies.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_uR7iWbgBIy class=p_ident id=p_uR7iWbgBIy></a>Often defining new data structures can’t be avoided—only a few basic ones are provided by the language standard, and many types of data have to be more complex than an array or a map. But when an array suffices, use an array.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_gE7WoNX7+Z class=p_ident id=p_gE7WoNX7+Z></a>An example of a slightly more complex data structure is the graph from <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a>. There is no single obvious way to represent a graph in JavaScript. In that chapter, we used an object whose properties hold arrays of strings—the other nodes reachable from that node.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_17Fkotj+nV class=p_ident id=p_17Fkotj+nV></a>There are several different pathfinding packages on NPM, but none of them uses this graph format. They usually allow the graph’s edges to have a weight, which is the cost or distance associated with it. That isn’t possible in our representation.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_d3wpFXYEjN class=p_ident id=p_d3wpFXYEjN></a>For example, there’s the <code>dijkstrajs</code> package. A well-known approach to pathfinding, quite similar to our <code>findRoute</code> function, is called <em>Dijkstra’s algorithm</em>, after Edsger Dijkstra, who first wrote it down. The <code>js</code> suffix is often added to package names to indicate the fact that they are written in JavaScript. This <code>dijkstrajs</code> package uses a graph format similar to ours, but instead of arrays, it uses objects whose property values are numbers—the weights of the edges.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_3iug1e4kQG class=p_ident id=p_3iug1e4kQG></a>So if we wanted to use that package, we’d have to make sure that our graph was stored in the format it expects. All edges get the same weight since our simplified model treats each road as having the same cost (one turn).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_NyRXVpwPYN class=c_ident id=c_NyRXVpwPYN></a><p class=cm-keyword>const</p> {<p class=cm-def>find_path</p>} <p class=cm-operator>=</p> <p class=cm-variable>require</p>(<p class=cm-string>\"dijkstrajs\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>graph</p> <p class=cm-operator>=</p> {};\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>node</p> <p class=cm-keyword>of</p> <p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable>roadGraph</p>)) { <p class=cm-keyword>let</p> <p class=cm-def>edges</p> <p class=cm-operator>=</p> <p class=cm-variable>graph</p>[<p class=cm-variable>node</p>] <p class=cm-operator>=</p> {}; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>dest</p> <p class=cm-keyword>of</p> <p class=cm-variable>roadGraph</p>[<p class=cm-variable>node</p>]) { <p class=cm-variable>edges</p>[<p class=cm-variable>dest</p>] <p class=cm-operator>=</p> <p class=cm-number>1</p>; }\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>find_path</p>(<p class=cm-variable>graph</p>, <p class=cm-string>\"Post Office\"</p>, <p class=cm-string>\"Cabin\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_X8Ulb726ZC class=p_ident id=p_X8Ulb726ZC></a>This can be a barrier to composition—when various packages are using different data structures to describe similar things, combining them is difficult. Therefore, if you want to design for composability, find out what data structures other people are using and, when possible, follow their example.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/10_modules.html#p_OX2jY0nGFw class=p_ident id=p_OX2jY0nGFw></a>Modules provide structure to bigger programs by separating the code into pieces with clear interfaces and dependencies. The interface is the part of the module that’s visible from other modules, and the dependencies are the other modules that it makes use of.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_sYCJxIhCEI class=p_ident id=p_sYCJxIhCEI></a>Because JavaScript historically did not provide a module system, the CommonJS system was built on top of it. Then at some point it <em>did</em> get a built-in system, which now coexists uneasily with the CommonJS system.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_wDM2Q8HBcB class=p_ident id=p_wDM2Q8HBcB></a>A package is a chunk of code that can be distributed on its own. NPM is a repository of JavaScript packages. You can download all kinds of useful (and useless) packages from it.</p> <h2><a href=https://eloquentjavascript.net/10_modules.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/10_modules.html#i_CJKk6NIC0T class=i_ident id=i_CJKk6NIC0T></a>A modular robot</h3> <p id=modular_robot><a href=https://eloquentjavascript.net/10_modules.html#p_nPAEnO4pep class=p_ident id=p_nPAEnO4pep></a>These are the bindings that the project from <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a> creates:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_/nxTd1W0Sy class=c_ident id=c_/nxTd1W0Sy></a>roads\nbuildGraph\nroadGraph\nVillageState\nrunRobot\nrandomPick\nrandomRobot\nmailRoute\nrouteRobot\nfindRoute\ngoalOrientedRobot</pre> <p><a href=https://eloquentjavascript.net/10_modules.html#p_0LdymcLoV8 class=p_ident id=p_0LdymcLoV8></a>If you were to write that project as a modular program, what modules would you create? Which module would depend on which other module, and what would their interfaces look like?</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_hU/u/IPER+ class=p_ident id=p_hU/u/IPER+></a>Which pieces are likely to be available prewritten on NPM? Would you prefer to use an NPM package or write them yourself?</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/10_modules.html#p_o3MT4wM7DB class=p_ident id=p_o3MT4wM7DB></a>Here’s what I would have done (but again, there is no single <em>right</em> way to design a given module):</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_56/CQgKTat class=p_ident id=p_56/CQgKTat></a>The code used to build the road graph lives in the <code>graph</code> module. Because I’d rather use <code>dijkstrajs</code> from NPM than our own pathfinding code, we’ll make this build the kind of graph data that <code>dijkstrajs</code> expects. This module exports a single function, <code>buildGraph</code>. I’d have <code>buildGraph</code> accept an array of two-element arrays, rather than strings containing hyphens, to make the module less dependent on the input format.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_B6Z6VXRXv9 class=p_ident id=p_B6Z6VXRXv9></a>The <code>roads</code> module contains the raw road data (the <code>roads</code> array) and the <code>roadGraph</code> binding. This module depends on <code>./graph</code> and exports the road graph.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_JLwefzFde0 class=p_ident id=p_JLwefzFde0></a>The <code>VillageState</code> class lives in the <code>state</code> module. It depends on the <code>./roads</code> module because it needs to be able to verify that a given road exists. It also needs <code>randomPick</code>. Since that is a three-line function, we could just put it into the <code>state</code> module as an internal helper function. But <code>randomRobot</code> needs it too. So we’d have to either duplicate it or put it into its own module. Since this function happens to exist on NPM in the <code>random-item</code> package, a good solution is to just make both modules depend on that. We can add the <code>runRobot</code> function to this module as well, since it’s small and closely related to state management. The module exports both the <code>VillageState</code> class and the <code>runRobot</code> function.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_wJDmndPhIc class=p_ident id=p_wJDmndPhIc></a>Finally, the robots, along with the values they depend on such as <code>mailRoute</code>, could go into an <code>example-robots</code> module, which depends on <code>./roads</code> and exports the robot functions. To make it possible for <code>goalOrientedRobot</code> to do route-finding, this module also depends on <code>dijkstrajs</code>.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_jU189+mtkS class=p_ident id=p_jU189+mtkS></a>By offloading some work to NPM modules, the code became a little smaller. Each individual module does something rather simple and can be read on its own. Dividing code into modules also often suggests further improvements to the program’s design. In this case, it seems a little odd that the <code>VillageState</code> and the robots depend on a specific road graph. It might be a better idea to make the graph an argument to the state’s constructor and make the robots read it from the state object—this reduces dependencies (which is always good) and makes it possible to run simulations on different maps (which is even better).</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_rfGj5/gdUx class=p_ident id=p_rfGj5/gdUx></a>Is it a good idea to use NPM modules for things that we could have written ourselves? In principle, yes—for nontrivial things like the pathfinding function you are likely to make mistakes and waste time writing them yourself. For tiny functions like <code>random-item</code>, writing them yourself is easy enough. But adding them wherever you need them does tend to clutter your modules.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_shhnxYPdPj class=p_ident id=p_shhnxYPdPj></a>However, you should also not underestimate the work involved in <em>finding</em> an appropriate NPM package. And even if you find one, it might not work well or may be missing some feature you need. On top of that, depending on NPM packages means you have to make sure they are installed, you have to distribute them with your program, and you might have to periodically upgrade them.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_UgTNT3/2gd class=p_ident id=p_UgTNT3/2gd></a>So again, this is a trade-off, and you can decide either way depending on how much the packages help you.</p> </div></div> <h3><a href=https://eloquentjavascript.net/10_modules.html#i_+pU//gQmZ8 class=i_ident id=i_+pU//gQmZ8></a>Roads module</h3> <p><a href=https://eloquentjavascript.net/10_modules.html#p_U88wPDSl2i class=p_ident id=p_U88wPDSl2i></a>Write a CommonJS module, based on the example from <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a>, that contains the array of roads and exports the graph data structure representing them as <code>roadGraph</code>. It should depend on a module <code>./graph</code>, which exports a function <code>buildGraph</code> that is used to build the graph. This function expects an array of two-element arrays (the start and end points of the roads).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/10_modules.html#c_FPEwj7xDOs class=c_ident id=c_FPEwj7xDOs></a> <p class=cm-keyword>const</p> <p class=cm-def>roads</p> <p class=cm-operator>=</p> [ <p class=cm-string>\"Alice's House-Bob's House\"</p>, <p class=cm-string>\"Alice's House-Cabin\"</p>, <p class=cm-string>\"Alice's House-Post Office\"</p>, <p class=cm-string>\"Bob's House-Town Hall\"</p>, <p class=cm-string>\"Daria's House-Ernie's House\"</p>, <p class=cm-string>\"Daria's House-Town Hall\"</p>, <p class=cm-string>\"Ernie's House-Grete's House\"</p>, <p class=cm-string>\"Grete's House-Farm\"</p>, <p class=cm-string>\"Grete's House-Shop\"</p>, <p class=cm-string>\"Marketplace-Farm\"</p>, <p class=cm-string>\"Marketplace-Post Office\"</p>, <p class=cm-string>\"Marketplace-Shop\"</p>, <p class=cm-string>\"Marketplace-Town Hall\"</p>, <p class=cm-string>\"Shop-Town Hall\"</p>\n];</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/10_modules.html#p_KWk09Gyhem class=p_ident id=p_KWk09Gyhem></a>Since this is a CommonJS module, you have to use <code>require</code> to import the graph module. That was described as exporting a <code>buildGraph</code> function, which you can pick out of its interface object with a destructuring <code>const</code> declaration.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_zdT6jLwIjp class=p_ident id=p_zdT6jLwIjp></a>To export <code>roadGraph</code>, you add a property to the <code>exports</code> object. Because <code>buildGraph</code> takes a data structure that doesn’t precisely match <code>roads</code>, the splitting of the road strings must happen in your module.</p> </div></div> <h3><a href=https://eloquentjavascript.net/10_modules.html#i_E/zWqBFdy8 class=i_ident id=i_E/zWqBFdy8></a>Circular dependencies</h3> <p><a href=https://eloquentjavascript.net/10_modules.html#p_fl2MZMonQV class=p_ident id=p_fl2MZMonQV></a>A circular dependency is a situation where module A depends on B, and B also, directly or indirectly, depends on A. Many module systems simply forbid this because whichever order you choose for loading such modules, you cannot make sure that each module’s dependencies have been loaded before it runs.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_b5sTJIUt38 class=p_ident id=p_b5sTJIUt38></a>CommonJS modules allow a limited form of cyclic dependencies. As long as the modules do not replace their default <code>exports</code> object and don’t access each other’s interface until after they finish loading, cyclic dependencies are okay.</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_s/oDnu78Ko class=p_ident id=p_s/oDnu78Ko></a>The <code>require</code> function given <a href=https://eloquentjavascript.net/10_modules.html#require>earlier in this chapter</a> supports this type of dependency cycle. Can you see how it handles cycles? What would go wrong when a module in a cycle <em>does</em> replace its default <code>exports</code> object?</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/10_modules.html#p_nf2U1lY9dq class=p_ident id=p_nf2U1lY9dq></a>The trick is that <code>require</code> adds modules to its cache <em>before</em> it starts loading the module. That way, if any <code>require</code> call made while it is running tries to load it, it is already known, and the current interface will be returned, rather than starting to load the module once more (which would eventually overflow the stack).</p> <p><a href=https://eloquentjavascript.net/10_modules.html#p_QAZLbqVKnV class=p_ident id=p_QAZLbqVKnV></a>If a module overwrites its <code>module.exports</code> value, any other module that has received its interface value before it finished loading will have gotten hold of the default interface object (which is likely empty), rather than the intended interface value.</p> </div></div><nav><a href=https://eloquentjavascript.net/09_regexp.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/11_async.html>▶</a></nav>\n</article><hr><h4>Page 7</h4><article score=1174.9750000000004>\n<nav><a href=https://eloquentjavascript.net/10_modules.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/12_language.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/11_async.html#p_zgFDYrsuxU class=p_ident id=p_zgFDYrsuxU></a>Who can wait quietly while the mud settles?<br>Who can remain still until the moment of action?</p> <footer>Laozi, <cite>Tao Te Ching</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of two crows on a branch\" src=https://eloquentjavascript.net/img/chapter_picture_11.jpg></figure> <p><a href=https://eloquentjavascript.net/11_async.html#p_i07NtkAZRR class=p_ident id=p_i07NtkAZRR></a>The central part of a computer, the part that carries out the individual steps that make up our programs, is called the <em>processor</em>. The programs we have seen so far are things that will keep the processor busy until they have finished their work. The speed at which something like a loop that manipulates numbers can be executed depends pretty much entirely on the speed of the processor.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_DvfTBQjvgo class=p_ident id=p_DvfTBQjvgo></a>But many programs interact with things outside of the processor. For example, they may communicate over a computer network or request data from the hard disk—which is a lot slower than getting it from memory.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_QDVyt/iXeq class=p_ident id=p_QDVyt/iXeq></a>When such a thing is happening, it would be a shame to let the processor sit idle—there might be some other work it could do in the meantime. In part, this is handled by your operating system, which will switch the processor between multiple running programs. But that doesn’t help when we want a <em>single</em> program to be able to make progress while it is waiting for a network request.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_HH3wvnWMnd class=h_ident id=h_HH3wvnWMnd></a>Asynchronicity</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_UMfVhtpDiH class=p_ident id=p_UMfVhtpDiH></a>In a <em>synchronous</em> programming model, things happen one at a time. When you call a function that performs a long-running action, it returns only when the action has finished and it can return the result. This stops your program for the time the action takes.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_w/nshgUouX class=p_ident id=p_w/nshgUouX></a>An <em>asynchronous</em> model allows multiple things to happen at the same time. When you start an action, your program continues to run. When the action finishes, the program is informed and gets access to the result (for example, the data read from disk).</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_4+uLDdNazP class=p_ident id=p_4+uLDdNazP></a>We can compare synchronous and asynchronous programming using a small example: a program that fetches two resources from the network and then combines results.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_dCIBPdfDLZ class=p_ident id=p_dCIBPdfDLZ></a>In a synchronous environment, where the request function returns only after it has done its work, the easiest way to perform this task is to make the requests one after the other. This has the drawback that the second request will be started only when the first has finished. The total time taken will be at least the sum of the two response times.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_GzbDIalJ5Y class=p_ident id=p_GzbDIalJ5Y></a>The solution to this problem, in a synchronous system, is to start additional threads of control. A <em>thread</em> is another running program whose execution may be interleaved with other programs by the operating system—since most modern computers contain multiple processors, multiple threads may even run at the same time, on different processors. A second thread could start the second request, and then both threads wait for their results to come back, after which they resynchronize to combine their results.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_EWjYy77pGQ class=p_ident id=p_EWjYy77pGQ></a>In the following diagram, the thick lines represent time the program spends running normally, and the thin lines represent time spent waiting for the network. In the synchronous model, the time taken by the network is <em>part</em> of the timeline for a given thread of control. In the asynchronous model, starting a network action conceptually causes a <em>split</em> in the timeline. The program that initiated the action continues running, and the action happens alongside it, notifying the program when it is finished.</p><figure><img alt=\"Control flow for synchronous and asynchronous programming\" src=https://eloquentjavascript.net/img/control-io.svg></figure> <p><a href=https://eloquentjavascript.net/11_async.html#p_2edJ/IzPV6 class=p_ident id=p_2edJ/IzPV6></a>Another way to describe the difference is that waiting for actions to finish is <em>implicit</em> in the synchronous model, while it is <em>explicit</em>, under our control, in the asynchronous one.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_8Ij/ZgHMRP class=p_ident id=p_8Ij/ZgHMRP></a>Asynchronicity cuts both ways. It makes expressing programs that do not fit the straight-line model of control easier, but it can also make expressing programs that do follow a straight line more awkward. We’ll see some ways to address this awkwardness later in the chapter.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_9fBOnSzsqK class=p_ident id=p_9fBOnSzsqK></a>Both of the important JavaScript programming platforms—browsers and Node.js—make operations that might take a while asynchronous, rather than relying on threads. Since programming with threads is notoriously hard (understanding what a program does is much more difficult when it’s doing multiple things at once), this is generally considered a good thing.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_Lao/OEmKKI class=h_ident id=h_Lao/OEmKKI></a>Crow tech</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_pnZ1JVpOVQ class=p_ident id=p_pnZ1JVpOVQ></a>Most people are aware of the fact that crows are very smart birds. They can use tools, plan ahead, remember things, and even communicate these things among themselves.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_6wGoxYcEfi class=p_ident id=p_6wGoxYcEfi></a>What most people don’t know is that they are capable of many things that they keep well hidden from us. I’ve been told by a reputable (if somewhat eccentric) expert on corvids that crow technology is not far behind human technology, and they are catching up.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_C/prtcqwC/ class=p_ident id=p_C/prtcqwC/ ></a>For example, many crow cultures have the ability to construct computing devices. These are not electronic, as human computing devices are, but operate through the actions of tiny insects, a species closely related to the termite, which has developed a symbiotic relationship with the crows. The birds provide them with food, and in return the insects build and operate their complex colonies that, with the help of the living creatures inside them, perform computations.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_6lPeENM1/D class=p_ident id=p_6lPeENM1/D></a>Such colonies are usually located in big, long-lived nests. The birds and insects work together to build a network of bulbous clay structures, hidden between the twigs of the nest, in which the insects live and work.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_GCtbVBOldY class=p_ident id=p_GCtbVBOldY></a>To communicate with other devices, these machines use light signals. The crows embed pieces of reflective material in special communication stalks, and the insects aim these to reflect light at another nest, encoding data as a sequence of quick flashes. This means that only nests that have an unbroken visual connection can communicate.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_vIkGOLeRGq class=p_ident id=p_vIkGOLeRGq></a>Our friend the corvid expert has mapped the network of crow nests in the village of Hières-sur-Amby, on the banks of the river Rhône. This map shows the nests and their connections:</p><figure><img alt=\"A network of crow nests in a small village\" src=https://eloquentjavascript.net/img/Hieres-sur-Amby.png></figure> <p><a href=https://eloquentjavascript.net/11_async.html#p_DgtWrWr+T8 class=p_ident id=p_DgtWrWr+T8></a>In an astounding example of convergent evolution, crow computers run JavaScript. In this chapter we’ll write some basic networking functions for them.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_n9ws/jdPpb class=h_ident id=h_n9ws/jdPpb></a>Callbacks</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_He8eYTpzz8 class=p_ident id=p_He8eYTpzz8></a>One approach to asynchronous programming is to make functions that perform a slow action take an extra argument, a <em>callback function</em>. The action is started, and when it finishes, the callback function is called with the result.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_xXv7FoAy7v class=p_ident id=p_xXv7FoAy7v></a>As an example, the <code>setTimeout</code> function, available both in Node.js and in browsers, waits a given number of milliseconds (a second is a thousand milliseconds) and then calls a function.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_RyFm7Uoiuv class=c_ident id=c_RyFm7Uoiuv></a><p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Tick\"</p>), <p class=cm-number>500</p>);</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_9Tu7uanv/t class=p_ident id=p_9Tu7uanv/t></a>Waiting is not generally a very important type of work, but it can be useful when doing something like updating an animation or checking whether something is taking longer than a given amount of time.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_7FItlRu6ne class=p_ident id=p_7FItlRu6ne></a>Performing multiple asynchronous actions in a row using callbacks means that you have to keep passing new functions to handle the continuation of the computation after the actions.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_GBzdHEp9fD class=p_ident id=p_GBzdHEp9fD></a>Most crow nest computers have a long-term data storage bulb, where pieces of information are etched into twigs so that they can be retrieved later. Etching, or finding a piece of data, takes a moment, so the interface to long-term storage is asynchronous and uses callback functions.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_qrVbRBjxbB class=p_ident id=p_qrVbRBjxbB></a>Storage bulbs store pieces of JSON-encodable data under names. A crow might store information about the places where it’s hidden food under the name <code>\"food caches\"</code>, which could hold an array of names that point at other pieces of data, describing the actual cache. To look up a food cache in the storage bulbs of the <em>Big Oak</em> nest, a crow could run code like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_f7XSZ4G+k8 class=c_ident id=c_f7XSZ4G+k8></a><p class=cm-keyword>import</p> {<p class=cm-def>bigOak</p>} <p class=cm-keyword>from</p> <p class=cm-string>\"./crow-tech\"</p>; <p class=cm-variable>bigOak</p>.<p class=cm-property>readStorage</p>(<p class=cm-string>\"food caches\"</p>, <p class=cm-def>caches</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>firstCache</p> <p class=cm-operator>=</p> <p class=cm-variable-2>caches</p>[<p class=cm-number>0</p>]; <p class=cm-variable>bigOak</p>.<p class=cm-property>readStorage</p>(<p class=cm-variable-2>firstCache</p>, <p class=cm-def>info</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>info</p>);\n  });\n});</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_drcmHan03C class=p_ident id=p_drcmHan03C></a>(All binding names and strings have been translated from crow language to English.)</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_aCzLiqd4ZF class=p_ident id=p_aCzLiqd4ZF></a>This style of programming is workable, but the indentation level increases with each asynchronous action because you end up in another function. Doing more complicated things, such as running multiple actions at the same time, can get a little awkward.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_HQVI9t8QwN class=p_ident id=p_HQVI9t8QwN></a>Crow nest computers are built to communicate using request-response pairs. That means one nest sends a message to another nest, which then immediately sends a message back, confirming receipt and possibly including a reply to a question asked in the message.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_1UN167Dotu class=p_ident id=p_1UN167Dotu></a>Each message is tagged with a <em>type</em>, which determines how it is handled. Our code can define handlers for specific request types, and when such a request comes in, the handler is called to produce a response.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_VJjqeXBfmZ class=p_ident id=p_VJjqeXBfmZ></a>The interface exported by the <code>\"./<wbr>crow-tech\"</code> module provides callback-based functions for communication. Nests have a <code>send</code> method that sends off a request. It expects the name of the target nest, the type of the request, and the content of the request as its first three arguments, and it expects a function to call when a response comes in as its fourth and last argument.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_qzWIKDLKSP class=c_ident id=c_qzWIKDLKSP></a><p class=cm-variable>bigOak</p>.<p class=cm-property>send</p>(<p class=cm-string>\"Cow Pasture\"</p>, <p class=cm-string>\"note\"</p>, <p class=cm-string>\"Let's caw loudly at 7PM\"</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Note delivered.\"</p>));</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_fY1oYJALqf class=p_ident id=p_fY1oYJALqf></a>But to make nests capable of receiving that request, we first have to define a request type named <code>\"note\"</code>. The code that handles the requests has to run not just on this nest-computer but on all nests that can receive messages of this type. We’ll just assume that a crow flies over and installs our handler code on all the nests.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_38THPHvc7d class=c_ident id=c_38THPHvc7d></a><p class=cm-keyword>import</p> {<p class=cm-def>defineRequestType</p>} <p class=cm-keyword>from</p> <p class=cm-string>\"./crow-tech\"</p>; <p class=cm-variable>defineRequestType</p>(<p class=cm-string>\"note\"</p>, (<p class=cm-def>nest</p>, <p class=cm-def>content</p>, <p class=cm-def>source</p>, <p class=cm-def>done</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`${</p><p class=cm-variable-2>nest</p>.<p class=cm-property>name</p><p class=cm-string-2>}</p> <p class=cm-string-2>received note: ${</p><p class=cm-variable-2>content</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-variable-2>done</p>();\n});</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_Mr/K2c1G6w class=p_ident id=p_Mr/K2c1G6w></a>The <code>defineRequestType</code> function defines a new type of request. The example adds support for <code>\"note\"</code> requests, which just sends a note to a given nest. Our implementation calls <code>console.log</code> so that we can verify that the request arrived. Nests have a <code>name</code> property that holds their name.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_vzmLB4UIgA class=p_ident id=p_vzmLB4UIgA></a>The fourth argument given to the handler, <code>done</code>, is a callback function that it must call when it is done with the request. If we had used the handler’s return value as the response value, that would mean that a request handler can’t itself perform asynchronous actions. A function doing asynchronous work typically returns before the work is done, having arranged for a callback to be called when it completes. So we need some asynchronous mechanism—in this case, another callback function—to signal when a response is available.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_Kg8Vsu1J2B class=p_ident id=p_Kg8Vsu1J2B></a>In a way, asynchronicity is <em>contagious</em>. Any function that calls a function that works asynchronously must itself be asynchronous, using a callback or similar mechanism to deliver its result. Calling a callback is somewhat more involved and error-prone than simply returning a value, so needing to structure large parts of your program that way is not great.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_sdRy5CTAP/ class=h_ident id=h_sdRy5CTAP/ ></a>Promises</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_cJV/7Xc1YN class=p_ident id=p_cJV/7Xc1YN></a>Working with abstract concepts is often easier when those concepts can be represented by values. In the case of asynchronous actions, you could, instead of arranging for a function to be called at some point in the future, return an object that represents this future event.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_c7IGxt0qcZ class=p_ident id=p_c7IGxt0qcZ></a>This is what the standard class <code>Promise</code> is for. A <em>promise</em> is an asynchronous action that may complete at some point and produce a value. It is able to notify anyone who is interested when its value is available.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_uoWOt7zYca class=p_ident id=p_uoWOt7zYca></a>The easiest way to create a promise is by calling <code>Promise.resolve</code>. This function ensures that the value you give it is wrapped in a promise. If it’s already a promise, it is simply returned—otherwise, you get a new promise that immediately finishes with your value as its result.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_fzJ7VLwQ/i class=c_ident id=c_fzJ7VLwQ/i></a><p class=cm-keyword>let</p> <p class=cm-def>fifteen</p> <p class=cm-operator>=</p> <p class=cm-variable>Promise</p>.<p class=cm-property>resolve</p>(<p class=cm-number>15</p>);\n<p class=cm-variable>fifteen</p>.<p class=cm-property>then</p>(<p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Got ${</p><p class=cm-variable-2>value</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>));\n</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_dq+GKs56Gg class=p_ident id=p_dq+GKs56Gg></a>To get the result of a promise, you can use its <code>then</code> method. This registers a callback function to be called when the promise resolves and produces a value. You can add multiple callbacks to a single promise, and they will be called, even if you add them after the promise has already <em>resolved</em> (finished).</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_BLNHvARdwj class=p_ident id=p_BLNHvARdwj></a>But that’s not all the <code>then</code> method does. It returns another promise, which resolves to the value that the handler function returns or, if that returns a promise, waits for that promise and then resolves to its result.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_I53M7bh5Zh class=p_ident id=p_I53M7bh5Zh></a>It is useful to think of promises as a device to move values into an asynchronous reality. A normal value is simply there. A promised value is a value that <em>might</em> already be there or might appear at some point in the future. Computations defined in terms of promises act on such wrapped values and are executed asynchronously as the values become available.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_sPGdi+3o75 class=p_ident id=p_sPGdi+3o75></a>To create a promise, you can use <code>Promise</code> as a constructor. It has a somewhat odd interface—the constructor expects a function as argument, which it immediately calls, passing it a function that it can use to resolve the promise. It works this way, instead of for example with a <code>resolve</code> method, so that only the code that created the promise can resolve it.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_N1xvulQh1Y class=p_ident id=p_N1xvulQh1Y></a>This is how you’d create a promise-based interface for the <code>readStorage</code> function:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_gYXlRtzMyd class=c_ident id=c_gYXlRtzMyd></a><p class=cm-keyword>function</p> <p class=cm-def>storage</p>(<p class=cm-def>nest</p>, <p class=cm-def>name</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>(<p class=cm-def>resolve</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>nest</p>.<p class=cm-property>readStorage</p>(<p class=cm-variable-2>name</p>, <p class=cm-def>result</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>result</p>)); });\n} <p class=cm-variable>storage</p>(<p class=cm-variable>bigOak</p>, <p class=cm-string>\"enemies\"</p>) .<p class=cm-property>then</p>(<p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Got\"</p>, <p class=cm-variable-2>value</p>));</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_teu5aKy22g class=p_ident id=p_teu5aKy22g></a>This asynchronous function returns a meaningful value. This is the main advantage of promises—they simplify the use of asynchronous functions. Instead of having to pass around callbacks, promise-based functions look similar to regular ones: they take input as arguments and return their output. The only difference is that the output may not be available yet.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_FlZkkRfkN/ class=h_ident id=h_FlZkkRfkN/ ></a>Failure</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_3xQ2mMjPI/ class=p_ident id=p_3xQ2mMjPI/ ></a>Regular JavaScript computations can fail by throwing an exception. Asynchronous computations often need something like that. A network request may fail, or some code that is part of the asynchronous computation may throw an exception.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_U/HpYNT9Y/ class=p_ident id=p_U/HpYNT9Y/ ></a>One of the most pressing problems with the callback style of asynchronous programming is that it makes it extremely difficult to make sure failures are properly reported to the callbacks.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_o521HDp6Q3 class=p_ident id=p_o521HDp6Q3></a>A widely used convention is that the first argument to the callback is used to indicate that the action failed, and the second contains the value produced by the action when it was successful. Such callback functions must always check whether they received an exception and make sure that any problems they cause, including exceptions thrown by functions they call, are caught and given to the right function.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_sdBQKhfBzG class=p_ident id=p_sdBQKhfBzG></a>Promises make this easier. They can be either resolved (the action finished successfully) or rejected (it failed). Resolve handlers (as registered with <code>then</code>) are called only when the action is successful, and rejections are automatically propagated to the new promise that is returned by <code>then</code>. And when a handler throws an exception, this automatically causes the promise produced by its <code>then</code> call to be rejected. So if any element in a chain of asynchronous actions fails, the outcome of the whole chain is marked as rejected, and no success handlers are called beyond the point where it failed.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_/Duy2d2EJl class=p_ident id=p_/Duy2d2EJl></a>Much like resolving a promise provides a value, rejecting one also provides one, usually called the <em>reason</em> of the rejection. When an exception in a handler function causes the rejection, the exception value is used as the reason. Similarly, when a handler returns a promise that is rejected, that rejection flows into the next promise. There’s a <code>Promise.reject</code> function that creates a new, immediately rejected promise.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_n8xS1bRY5C class=p_ident id=p_n8xS1bRY5C></a>To explicitly handle such rejections, promises have a <code>catch</code> method that registers a handler to be called when the promise is rejected, similar to how <code>then</code> handlers handle normal resolution. It’s also very much like <code>then</code> in that it returns a new promise, which resolves to the original promise’s value if it resolves normally and to the result of the <code>catch</code> handler otherwise. If a <code>catch</code> handler throws an error, the new promise is also rejected.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_M0B+/Jkbg2 class=p_ident id=p_M0B+/Jkbg2></a>As a shorthand, <code>then</code> also accepts a rejection handler as a second argument, so you can install both types of handlers in a single method call.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_JarwEqSrWp class=p_ident id=p_JarwEqSrWp></a>A function passed to the <code>Promise</code> constructor receives a second argument, alongside the resolve function, which it can use to reject the new promise.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_z3DyjoAwVl class=p_ident id=p_z3DyjoAwVl></a>The chains of promise values created by calls to <code>then</code> and <code>catch</code> can be seen as a pipeline through which asynchronous values or failures move. Since such chains are created by registering handlers, each link has a success handler or a rejection handler (or both) associated with it. Handlers that don’t match the type of outcome (success or failure) are ignored. But those that do match are called, and their outcome determines what kind of value comes next—success when it returns a non-promise value, rejection when it throws an exception, and the outcome of a promise when it returns one of those.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_TOwOnoqIIW class=c_ident id=c_TOwOnoqIIW></a><p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>((<p class=cm-def>_</p>, <p class=cm-def>reject</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>reject</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Fail\"</p>))) .<p class=cm-property>then</p>(<p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Handler 1\"</p>)) .<p class=cm-property>catch</p>(<p class=cm-def>reason</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Caught failure \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>reason</p>); <p class=cm-keyword>return</p> <p class=cm-string>\"nothing\"</p>; }) .<p class=cm-property>then</p>(<p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Handler 2\"</p>, <p class=cm-variable-2>value</p>));\n\n</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_221BynGy7j class=p_ident id=p_221BynGy7j></a>Much like an uncaught exception is handled by the environment, JavaScript environments can detect when a promise rejection isn’t handled and will report this as an error.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_o8Vlf60I8f class=h_ident id=h_o8Vlf60I8f></a>Networks are hard</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_fjvcMK987B class=p_ident id=p_fjvcMK987B></a>Occasionally, there isn’t enough light for the crows’ mirror systems to transmit a signal or something is blocking the path of the signal. It is possible for a signal to be sent but never received.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_lbPe1lr2o1 class=p_ident id=p_lbPe1lr2o1></a>As it is, that will just cause the callback given to <code>send</code> to never be called, which will probably cause the program to stop without even noticing there is a problem. It would be nice if, after a given period of not getting a response, a request would <em>time out</em> and report failure.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_uW9fnd/IuC class=p_ident id=p_uW9fnd/IuC></a>Often, transmission failures are random accidents, like a car’s headlight interfering with the light signals, and simply retrying the request may cause it to succeed. So while we’re at it, let’s make our request function automatically retry the sending of the request a few times before it gives up.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_aJq/gxAcrD class=p_ident id=p_aJq/gxAcrD></a>And, since we’ve established that promises are a good thing, we’ll also make our request function return a promise. In terms of what they can express, callbacks and promises are equivalent. Callback-based functions can be wrapped to expose a promise-based interface, and vice versa.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_5BHxJdJVP6 class=p_ident id=p_5BHxJdJVP6></a>Even when a request and its response are successfully delivered, the response may indicate failure—for example, if the request tries to use a request type that hasn’t been defined or the handler throws an error. To support this, <code>send</code> and <code>defineRequestType</code> follow the convention mentioned before, where the first argument passed to callbacks is the failure reason, if any, and the second is the actual result.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_97bGw9TnRL class=p_ident id=p_97bGw9TnRL></a>These can be translated to promise resolution and rejection by our wrapper.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_Wg7xZ1po7J class=c_ident id=c_Wg7xZ1po7J></a><p class=cm-keyword>class</p> <p class=cm-def>Timeout</p> <p class=cm-keyword>extends</p> <p class=cm-variable>Error</p> {} <p class=cm-keyword>function</p> <p class=cm-def>request</p>(<p class=cm-def>nest</p>, <p class=cm-def>target</p>, <p class=cm-def>type</p>, <p class=cm-def>content</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>((<p class=cm-def>resolve</p>, <p class=cm-def>reject</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>done</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>; <p class=cm-keyword>function</p> <p class=cm-def>attempt</p>(<p class=cm-def>n</p>) { <p class=cm-variable-2>nest</p>.<p class=cm-property>send</p>(<p class=cm-variable-2>target</p>, <p class=cm-variable-2>type</p>, <p class=cm-variable-2>content</p>, (<p class=cm-def>failed</p>, <p class=cm-def>value</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>done</p> <p class=cm-operator>=</p> <p class=cm-atom>true</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>failed</p>) <p class=cm-variable-2>reject</p>(<p class=cm-variable-2>failed</p>); <p class=cm-keyword>else</p> <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>value</p>); }); <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>done</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>n</p> <p class=cm-operator>&lt;</p> <p class=cm-number>3</p>) <p class=cm-variable-2>attempt</p>(<p class=cm-variable-2>n</p> <p class=cm-operator>+</p> <p class=cm-number>1</p>); <p class=cm-keyword>else</p> <p class=cm-variable-2>reject</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Timeout</p>(<p class=cm-string>\"Timed out\"</p>)); }, <p class=cm-number>250</p>); } <p class=cm-variable-2>attempt</p>(<p class=cm-number>1</p>);\n  });\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_st0GjZl4iZ class=p_ident id=p_st0GjZl4iZ></a>Because promises can be resolved (or rejected) only once, this will work. The first time <code>resolve</code> or <code>reject</code> is called determines the outcome of the promise, and further calls caused by a request coming back after another request finished are ignored.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_WbNhsnDMXt class=p_ident id=p_WbNhsnDMXt></a>To build an asynchronous loop, for the retries, we need to use a recursive function—a regular loop doesn’t allow us to stop and wait for an asynchronous action. The <code>attempt</code> function makes a single attempt to send a request. It also sets a timeout that, if no response has come back after 250 milliseconds, either starts the next attempt or, if this was the third attempt, rejects the promise with an instance of <code>Timeout</code> as the reason.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_acM5kja+EL class=p_ident id=p_acM5kja+EL></a>Retrying every quarter-second and giving up when no response has come in after three-quarter second is definitely somewhat arbitrary. It is even possible, if the request did come through but the handler is just taking a bit longer, for requests to be delivered multiple times. We’ll write our handlers with that problem in mind—duplicate messages should be harmless.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_e9iIV/0dqZ class=p_ident id=p_e9iIV/0dqZ></a>In general, we will not be building a world-class, robust network today. But that’s okay—crows don’t have very high expectations yet when it comes to computing.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_8G2rFK/pFH class=p_ident id=p_8G2rFK/pFH></a>To isolate ourselves from callbacks altogether, we’ll go ahead and also define a wrapper for <code>defineRequestType</code> that allows the handler function to return a promise or plain value and wires that up to the callback for us.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_HejJcHo3dj class=c_ident id=c_HejJcHo3dj></a><p class=cm-keyword>function</p> <p class=cm-def>requestType</p>(<p class=cm-def>name</p>, <p class=cm-def>handler</p>) { <p class=cm-variable>defineRequestType</p>(<p class=cm-variable-2>name</p>, (<p class=cm-variable>nest</p>, <p class=cm-variable>content</p>, <p class=cm-variable>source</p>, <p class=cm-variable>callback</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>try</p> { <p class=cm-variable>Promise</p>.<p class=cm-property>resolve</p>(<p class=cm-variable-2>handler</p>(<p class=cm-variable>nest</p>, <p class=cm-variable>content</p>, <p class=cm-variable>source</p>)) .<p class=cm-property>then</p>(<p class=cm-def>response</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>callback</p>(<p class=cm-atom>null</p>, <p class=cm-variable-2>response</p>), <p class=cm-def>failure</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>callback</p>(<p class=cm-variable-2>failure</p>)); } <p class=cm-keyword>catch</p> (<p class=cm-def>exception</p>) { <p class=cm-variable>callback</p>(<p class=cm-variable-2>exception</p>);\n    }\n  });\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_m5fm86hZW6 class=p_ident id=p_m5fm86hZW6></a><code>Promise.resolve</code> is used to convert the value returned by <code>handler</code> to a promise if it isn’t already.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_CAzmYCfy+I class=p_ident id=p_CAzmYCfy+I></a>Note that the call to <code>handler</code> had to be wrapped in a <code>try</code> block to make sure any exception it raises directly is given to the callback. This nicely illustrates the difficulty of properly handling errors with raw callbacks—it is easy to forget to properly route exceptions like that, and if you don’t do it, failures won’t get reported to the right callback. Promises make this mostly automatic and thus less error-prone.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_4rfkjtrFcP class=h_ident id=h_4rfkjtrFcP></a>Collections of promises</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_aICANM74sI class=p_ident id=p_aICANM74sI></a>Each nest computer keeps an array of other nests within transmission distance in its <code>neighbors</code> property. To check which of those are currently reachable, you could write a function that tries to send a <code>\"ping\"</code> request (a request that simply asks for a response) to each of them and see which ones come back.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_fBcfo2czu8 class=p_ident id=p_fBcfo2czu8></a>When working with collections of promises running at the same time, the <code>Promise.all</code> function can be useful. It returns a promise that waits for all of the promises in the array to resolve and then resolves to an array of the values that these promises produced (in the same order as the original array). If any promise is rejected, the result of <code>Promise.all</code> is itself rejected.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_ZtEtR5AsHV class=c_ident id=c_ZtEtR5AsHV></a><p class=cm-variable>requestType</p>(<p class=cm-string>\"ping\"</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-string>\"pong\"</p>); <p class=cm-keyword>function</p> <p class=cm-def>availableNeighbors</p>(<p class=cm-def>nest</p>) { <p class=cm-keyword>let</p> <p class=cm-def>requests</p> <p class=cm-operator>=</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>.<p class=cm-property>map</p>(<p class=cm-def>neighbor</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable>request</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>neighbor</p>, <p class=cm-string>\"ping\"</p>) .<p class=cm-property>then</p>(() <p class=cm-operator>=&gt;</p> <p class=cm-atom>true</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-atom>false</p>); }); <p class=cm-keyword>return</p> <p class=cm-variable>Promise</p>.<p class=cm-property>all</p>(<p class=cm-variable-2>requests</p>).<p class=cm-property>then</p>(<p class=cm-def>result</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>.<p class=cm-property>filter</p>((<p class=cm-def>_</p>, <p class=cm-def>i</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>result</p>[<p class=cm-variable-2>i</p>]);\n  });\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_p074kPsd4q class=p_ident id=p_p074kPsd4q></a>When a neighbor isn’t available, we don’t want the entire combined promise to fail since then we still wouldn’t know anything. So the function that is mapped over the set of neighbors to turn them into request promises attaches handlers that make successful requests produce <code>true</code> and rejected ones produce <code>false</code>.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_xJZvWO1Y4P class=p_ident id=p_xJZvWO1Y4P></a>In the handler for the combined promise, <code>filter</code> is used to remove those elements from the <code>neighbors</code> array whose corresponding value is false. This makes use of the fact that <code>filter</code> passes the array index of the current element as a second argument to its filtering function (<code>map</code>, <code>some</code>, and similar higher-order array methods do the same).</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_pi4+kiBmAy class=h_ident id=h_pi4+kiBmAy></a>Network flooding</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_ktVbTscCrR class=p_ident id=p_ktVbTscCrR></a>The fact that nests can talk only to their neighbors greatly inhibits the usefulness of this network.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_/O0D1BFKEk class=p_ident id=p_/O0D1BFKEk></a>For broadcasting information to the whole network, one solution is to set up a type of request that is automatically forwarded to neighbors. These neighbors then in turn forward it to their neighbors, until the whole network has received the message.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_wHo3Wk05Ya class=c_ident id=c_wHo3Wk05Ya></a><p class=cm-keyword>import</p> {<p class=cm-def>everywhere</p>} <p class=cm-keyword>from</p> <p class=cm-string>\"./crow-tech\"</p>; <p class=cm-variable>everywhere</p>(<p class=cm-def>nest</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>gossip</p> <p class=cm-operator>=</p> [];\n}); <p class=cm-keyword>function</p> <p class=cm-def>sendGossip</p>(<p class=cm-def>nest</p>, <p class=cm-def>message</p>, <p class=cm-def>exceptFor</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>) { <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>gossip</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>message</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>neighbor</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>neighbor</p> <p class=cm-operator>==</p> <p class=cm-variable-2>exceptFor</p>) <p class=cm-keyword>continue</p>; <p class=cm-variable>request</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>neighbor</p>, <p class=cm-string>\"gossip\"</p>, <p class=cm-variable-2>message</p>); }\n} <p class=cm-variable>requestType</p>(<p class=cm-string>\"gossip\"</p>, (<p class=cm-def>nest</p>, <p class=cm-def>message</p>, <p class=cm-def>source</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>gossip</p>.<p class=cm-property>includes</p>(<p class=cm-variable-2>message</p>)) <p class=cm-keyword>return</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`${</p><p class=cm-variable-2>nest</p>.<p class=cm-property>name</p><p class=cm-string-2>}</p> <p class=cm-string-2>received gossip '${</p> <p class=cm-variable-2>message</p><p class=cm-string-2>}</p><p class=cm-string-2>' from ${</p><p class=cm-variable-2>source</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-variable>sendGossip</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>message</p>, <p class=cm-variable-2>source</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_BxJ3gAVNXY class=p_ident id=p_BxJ3gAVNXY></a>To avoid sending the same message around the network forever, each nest keeps an array of gossip strings that it has already seen. To define this array, we use the <code>everywhere</code> function—which runs code on every nest—to add a property to the nest’s <code>state</code> object, which is where we’ll keep nest-local state.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_iuIpNkZ6Y1 class=p_ident id=p_iuIpNkZ6Y1></a>When a nest receives a duplicate gossip message, which is very likely to happen with everybody blindly resending them, it ignores it. But when it receives a new message, it excitedly tells all its neighbors except for the one who sent it the message.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_Vf87ZzInCt class=p_ident id=p_Vf87ZzInCt></a>This will cause a new piece of gossip to spread through the network like an ink stain in water. Even when some connections aren’t currently working, if there is an alternative route to a given nest, the gossip will reach it through there.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_vuq8D4aVHG class=p_ident id=p_vuq8D4aVHG></a>This style of network communication is called <em>flooding</em>—it floods the network with a piece of information until all nodes have it.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_uA2Fs2G7PW class=p_ident id=p_uA2Fs2G7PW></a>We can call <code>sendGossip</code> to see a message flow through the village.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_KWBmLZ/aO7 class=c_ident id=c_KWBmLZ/aO7></a><p class=cm-variable>sendGossip</p>(<p class=cm-variable>bigOak</p>, <p class=cm-string>\"Kids with airgun in the park\"</p>);</pre> <h2><a href=https://eloquentjavascript.net/11_async.html#h_qb23G8H5P9 class=h_ident id=h_qb23G8H5P9></a>Message routing</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_DfGu9P/nDx class=p_ident id=p_DfGu9P/nDx></a>If a given node wants to talk to a single other node, flooding is not a very efficient approach. Especially when the network is big, that would lead to a lot of useless data transfers.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_+/v2WfaNg2 class=p_ident id=p_+/v2WfaNg2></a>An alternative approach is to set up a way for messages to hop from node to node until they reach their destination. The difficulty with that is it requires knowledge about the layout of the network. To send a request in the direction of a faraway nest, it is necessary to know which neighboring nest gets it closer to its destination. Sending it in the wrong direction will not do much good.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_H9F/PkVSom class=p_ident id=p_H9F/PkVSom></a>Since each nest knows only about its direct neighbors, it doesn’t have the information it needs to compute a route. We must somehow spread the information about these connections to all nests, preferably in a way that allows it to change over time, when nests are abandoned or new nests are built.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_NNmqy7WOzL class=p_ident id=p_NNmqy7WOzL></a>We can use flooding again, but instead of checking whether a given message has already been received, we now check whether the new set of neighbors for a given nest matches the current set we have for it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_pOL6/oUmtj class=c_ident id=c_pOL6/oUmtj></a><p class=cm-variable>requestType</p>(<p class=cm-string>\"connections\"</p>, (<p class=cm-variable>nest</p>, {<p class=cm-property>name</p>, <p class=cm-property>neighbors</p>}, <p class=cm-variable>source</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>connections</p> <p class=cm-operator>=</p> <p class=cm-variable>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p>; <p class=cm-keyword>if</p> (<p class=cm-variable>JSON</p>.<p class=cm-property>stringify</p>(<p class=cm-variable-2>connections</p>.<p class=cm-property>get</p>(<p class=cm-variable>name</p>)) <p class=cm-operator>==</p> <p class=cm-variable>JSON</p>.<p class=cm-property>stringify</p>(<p class=cm-variable>neighbors</p>)) <p class=cm-keyword>return</p>; <p class=cm-variable-2>connections</p>.<p class=cm-property>set</p>(<p class=cm-variable>name</p>, <p class=cm-variable>neighbors</p>); <p class=cm-variable>broadcastConnections</p>(<p class=cm-variable>nest</p>, <p class=cm-variable>name</p>, <p class=cm-variable>source</p>);\n}); <p class=cm-keyword>function</p> <p class=cm-def>broadcastConnections</p>(<p class=cm-def>nest</p>, <p class=cm-def>name</p>, <p class=cm-def>exceptFor</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>neighbor</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>neighbor</p> <p class=cm-operator>==</p> <p class=cm-variable-2>exceptFor</p>) <p class=cm-keyword>continue</p>; <p class=cm-variable>request</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>neighbor</p>, <p class=cm-string>\"connections\"</p>, { <p class=cm-property>name</p>, <p class=cm-property>neighbors</p>: <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p>.<p class=cm-property>get</p>(<p class=cm-variable-2>name</p>) }); }\n} <p class=cm-variable>everywhere</p>(<p class=cm-def>nest</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Map</p>(); <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p>.<p class=cm-property>set</p>(<p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>, <p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>); <p class=cm-variable>broadcastConnections</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_Dpash2ByBo class=p_ident id=p_Dpash2ByBo></a>The comparison uses <code>JSON.stringify</code> because <code>==</code>, on objects or arrays, will return true only when the two are the exact same value, which is not what we need here. Comparing the JSON strings is a crude but effective way to compare their content.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_qfljgqkp+v class=p_ident id=p_qfljgqkp+v></a>The nodes immediately start broadcasting their connections, which should, unless some nests are completely unreachable, quickly give every nest a map of the current network graph.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_hDQVurU6rz class=p_ident id=p_hDQVurU6rz></a>A thing you can do with graphs is find routes in them, as we saw in <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a>. If we have a route toward a message’s destination, we know which direction to send it in.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_nLh7irC9fa class=p_ident id=p_nLh7irC9fa></a>This <code>findRoute</code> function, which greatly resembles the <code>findRoute</code> from <a href=https://eloquentjavascript.net/07_robot.html#findRoute>Chapter 7</a>, searches for a way to reach a given node in the network. But instead of returning the whole route, it just returns the next step. That next nest will itself, using its current information about the network, decide where <em>it</em> sends the message.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_BDriUx0MeG class=c_ident id=c_BDriUx0MeG></a><p class=cm-keyword>function</p> <p class=cm-def>findRoute</p>(<p class=cm-def>from</p>, <p class=cm-def>to</p>, <p class=cm-def>connections</p>) { <p class=cm-keyword>let</p> <p class=cm-def>work</p> <p class=cm-operator>=</p> [{<p class=cm-property>at</p>: <p class=cm-variable-2>from</p>, <p class=cm-property>via</p>: <p class=cm-atom>null</p>}]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>work</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>at</p>, <p class=cm-def>via</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>work</p>[<p class=cm-variable-2>i</p>]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>next</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>connections</p>.<p class=cm-property>get</p>(<p class=cm-variable-2>at</p>) <p class=cm-operator>|</p><p class=cm-operator>|</p> []) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>next</p> <p class=cm-operator>==</p> <p class=cm-variable-2>to</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>via</p>; <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>work</p>.<p class=cm-property>some</p>(<p class=cm-def>w</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>w</p>.<p class=cm-property>at</p> <p class=cm-operator>==</p> <p class=cm-variable-2>next</p>)) { <p class=cm-variable-2>work</p>.<p class=cm-property>push</p>({<p class=cm-property>at</p>: <p class=cm-variable-2>next</p>, <p class=cm-property>via</p>: <p class=cm-variable-2>via</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable-2>next</p>}); } } } <p class=cm-keyword>return</p> <p class=cm-atom>null</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_khShpBYpjP class=p_ident id=p_khShpBYpjP></a>Now we can build a function that can send long-distance messages. If the message is addressed to a direct neighbor, it is delivered as usual. If not, it is packaged in an object and sent to a neighbor that is closer to the target, using the <code>\"route\"</code> request type, which will cause that neighbor to repeat the same behavior.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_qgwq/4PpOq class=c_ident id=c_qgwq/4PpOq></a><p class=cm-keyword>function</p> <p class=cm-def>routeRequest</p>(<p class=cm-def>nest</p>, <p class=cm-def>target</p>, <p class=cm-def>type</p>, <p class=cm-def>content</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>nest</p>.<p class=cm-property>neighbors</p>.<p class=cm-property>includes</p>(<p class=cm-variable-2>target</p>)) { <p class=cm-keyword>return</p> <p class=cm-variable>request</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>target</p>, <p class=cm-variable-2>type</p>, <p class=cm-variable-2>content</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>via</p> <p class=cm-operator>=</p> <p class=cm-variable>findRoute</p>(<p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>, <p class=cm-variable-2>target</p>, <p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p>); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>via</p>) <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string-2>`No route to ${</p><p class=cm-variable-2>target</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); <p class=cm-keyword>return</p> <p class=cm-variable>request</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>via</p>, <p class=cm-string>\"route\"</p>, {<p class=cm-property>target</p>, <p class=cm-property>type</p>, <p class=cm-property>content</p>}); }\n} <p class=cm-variable>requestType</p>(<p class=cm-string>\"route\"</p>, (<p class=cm-def>nest</p>, {<p class=cm-def>target</p>, <p class=cm-def>type</p>, <p class=cm-def>content</p>}) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable>routeRequest</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>target</p>, <p class=cm-variable-2>type</p>, <p class=cm-variable-2>content</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_2KFj5q8DUa class=p_ident id=p_2KFj5q8DUa></a>We can now send a message to the nest in the church tower, which is four network hops removed.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_S73i8jJBHA class=c_ident id=c_S73i8jJBHA></a><p class=cm-variable>routeRequest</p>(<p class=cm-variable>bigOak</p>, <p class=cm-string>\"Church Tower\"</p>, <p class=cm-string>\"note\"</p>, <p class=cm-string>\"Incoming jackdaws!\"</p>);</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_T0OvjpGy1d class=p_ident id=p_T0OvjpGy1d></a>We’ve constructed several layers of functionality on top of a primitive communication system to make it convenient to use. This is a nice (though simplified) model of how real computer networks work.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_BCiG5DVrmR class=p_ident id=p_BCiG5DVrmR></a>A distinguishing property of computer networks is that they aren’t reliable—abstractions built on top of them can help, but you can’t abstract away network failure. So network programming is typically very much about anticipating and dealing with failures.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_XvLsfAhtsE class=h_ident id=h_XvLsfAhtsE></a>Async functions</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_4FwmFfekYV class=p_ident id=p_4FwmFfekYV></a>To store important information, crows are known to duplicate it across nests. That way, when a hawk destroys a nest, the information isn’t lost.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_QezI5I8rjm class=p_ident id=p_QezI5I8rjm></a>To retrieve a given piece of information that it doesn’t have in its own storage bulb, a nest computer might consult random other nests in the network until it finds one that has it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_QLKv1tpg1i class=c_ident id=c_QLKv1tpg1i></a><p class=cm-variable>requestType</p>(<p class=cm-string>\"storage\"</p>, (<p class=cm-def>nest</p>, <p class=cm-def>name</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable>storage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>)); <p class=cm-keyword>function</p> <p class=cm-def>findInStorage</p>(<p class=cm-def>nest</p>, <p class=cm-def>name</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>storage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>).<p class=cm-property>then</p>(<p class=cm-def>found</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>found</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>found</p>; <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> <p class=cm-variable>findInRemoteStorage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>); });\n} <p class=cm-keyword>function</p> <p class=cm-def>network</p>(<p class=cm-def>nest</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable-2>nest</p>.<p class=cm-property>state</p>.<p class=cm-property>connections</p>.<p class=cm-property>keys</p>());\n} <p class=cm-keyword>function</p> <p class=cm-def>findInRemoteStorage</p>(<p class=cm-def>nest</p>, <p class=cm-def>name</p>) { <p class=cm-keyword>let</p> <p class=cm-def>sources</p> <p class=cm-operator>=</p> <p class=cm-variable>network</p>(<p class=cm-variable-2>nest</p>).<p class=cm-property>filter</p>(<p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>); <p class=cm-keyword>function</p> <p class=cm-def>next</p>() { <p class=cm-keyword>if</p> (<p class=cm-variable-2>sources</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>Promise</p>.<p class=cm-property>reject</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Not found\"</p>)); } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>source</p> <p class=cm-operator>=</p> <p class=cm-variable-2>sources</p>[<p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-variable-2>sources</p>.<p class=cm-property>length</p>)]; <p class=cm-variable-2>sources</p> <p class=cm-operator>=</p> <p class=cm-variable-2>sources</p>.<p class=cm-property>filter</p>(<p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>source</p>); <p class=cm-keyword>return</p> <p class=cm-variable>routeRequest</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>source</p>, <p class=cm-string>\"storage\"</p>, <p class=cm-variable-2>name</p>) .<p class=cm-property>then</p>(<p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>value</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p> <p class=cm-operator>?</p> <p class=cm-variable-2>value</p> : <p class=cm-variable-2>next</p>(), <p class=cm-variable-2>next</p>); } } <p class=cm-keyword>return</p> <p class=cm-variable-2>next</p>();\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_9ueI22bqmz class=p_ident id=p_9ueI22bqmz></a>Because <code>connections</code> is a <code>Map</code>, <code>Object.keys</code> doesn’t work on it. It has a <code>keys</code> <em>method</em>, but that returns an iterator rather than an array. An iterator (or iterable value) can be converted to an array with the <code>Array.from</code> function.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_1yDETF9zmK class=p_ident id=p_1yDETF9zmK></a>Even with promises this is some rather awkward code. Multiple asynchronous actions are chained together in non-obvious ways. We again need a recursive function (<code>next</code>) to model looping through the nests.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_ZdDrrtYpkB class=p_ident id=p_ZdDrrtYpkB></a>And the thing the code actually does is completely linear—it always waits for the previous action to complete before starting the next one. In a synchronous programming model, it’d be simpler to express.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_YB91K5v8Ro class=p_ident id=p_YB91K5v8Ro></a>The good news is that JavaScript allows you to write pseudo-synchronous code to describe asynchronous computation. An <code>async</code> function is a function that implicitly returns a promise and that can, in its body, <code>await</code> other promises in a way that <em>looks</em> synchronous.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_+aWABbtzTM class=p_ident id=p_+aWABbtzTM></a>We can rewrite <code>findInStorage</code> like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_eDKVOF1oo/ class=c_ident id=c_eDKVOF1oo/ ></a><p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>findInStorage</p>(<p class=cm-def>nest</p>, <p class=cm-def>name</p>) { <p class=cm-keyword>let</p> <p class=cm-def>local</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>storage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>local</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>local</p>; <p class=cm-keyword>let</p> <p class=cm-def>sources</p> <p class=cm-operator>=</p> <p class=cm-variable>network</p>(<p class=cm-variable-2>nest</p>).<p class=cm-property>filter</p>(<p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>); <p class=cm-keyword>while</p> (<p class=cm-variable-2>sources</p>.<p class=cm-property>length</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-keyword>let</p> <p class=cm-def>source</p> <p class=cm-operator>=</p> <p class=cm-variable-2>sources</p>[<p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-variable-2>sources</p>.<p class=cm-property>length</p>)]; <p class=cm-variable-2>sources</p> <p class=cm-operator>=</p> <p class=cm-variable-2>sources</p>.<p class=cm-property>filter</p>(<p class=cm-def>n</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>n</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>source</p>); <p class=cm-keyword>try</p> { <p class=cm-keyword>let</p> <p class=cm-def>found</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>routeRequest</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>source</p>, <p class=cm-string>\"storage\"</p>, <p class=cm-variable-2>name</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>found</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>found</p>; } <p class=cm-keyword>catch</p> (<p class=cm-def>_</p>) {} } <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Not found\"</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_yJ9vEuqhm9 class=p_ident id=p_yJ9vEuqhm9></a>An <code>async</code> function is marked by the word <code>async</code> before the <code>function</code> keyword. Methods can also be made <code>async</code> by writing <code>async</code> before their name. When such a function or method is called, it returns a promise. As soon as the body returns something, that promise is resolved. If it throws an exception, the promise is rejected.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_04MPwtOsw6 class=c_ident id=c_04MPwtOsw6></a><p class=cm-variable>findInStorage</p>(<p class=cm-variable>bigOak</p>, <p class=cm-string>\"events on 2017-12-21\"</p>) .<p class=cm-property>then</p>(<p class=cm-variable>console</p>.<p class=cm-property>log</p>);</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_0PWuoWXaWE class=p_ident id=p_0PWuoWXaWE></a>Inside an <code>async</code> function, the word <code>await</code> can be put in front of an expression to wait for a promise to resolve and only then continue the execution of the function.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_hTH03GxRLH class=p_ident id=p_hTH03GxRLH></a>Such a function no longer, like a regular JavaScript function, runs from start to completion in one go. Instead, it can be <em>frozen</em> at any point that has an <code>await</code>, and can be resumed at a later time.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_6JNP8vemlA class=p_ident id=p_6JNP8vemlA></a>For non-trivial asynchronous code, this notation is usually more convenient than directly using promises. Even if you need to do something that doesn’t fit the synchronous model, such as perform multiple actions at the same time, it is easy to combine <code>await</code> with the direct use of promises.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_o+cFzGGhnz class=h_ident id=h_o+cFzGGhnz></a>Generators</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_zFhfm+tYq8 class=p_ident id=p_zFhfm+tYq8></a>This ability of functions to be paused and then resumed again is not exclusive to <code>async</code> functions. JavaScript also has a feature called <em>generator</em> functions. These are similar, but without the promises.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_+0474o2QAY class=p_ident id=p_+0474o2QAY></a>When you define a function with <code>function*</code> (placing an asterisk after the word <code>function</code>), it becomes a generator. When you call a generator, it returns an iterator, which we already saw in <a href=https://eloquentjavascript.net/06_object.html>Chapter 6</a>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_B4ek89g871 class=c_ident id=c_B4ek89g871></a><p class=cm-keyword>function</p><p class=cm-keyword>*</p> <p class=cm-def>powers</p>(<p class=cm-def>n</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>current</p> <p class=cm-operator>=</p> <p class=cm-variable-2>n</p>;; <p class=cm-variable-2>current</p> <p class=cm-operator>*=</p> <p class=cm-variable-2>n</p>) { <p class=cm-keyword>yield</p> <p class=cm-variable-2>current</p>; }\n} <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>power</p> <p class=cm-keyword>of</p> <p class=cm-variable>powers</p>(<p class=cm-number>3</p>)) { <p class=cm-keyword>if</p> (<p class=cm-variable>power</p> <p class=cm-operator>&gt;</p> <p class=cm-number>50</p>) <p class=cm-keyword>break</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>power</p>);\n}\n\n\n</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_66VAHXEtbn class=p_ident id=p_66VAHXEtbn></a>Initially, when you call <code>powers</code>, the function is frozen at its start. Every time you call <code>next</code> on the iterator, the function runs until it hits a <code>yield</code> expression, which pauses it and causes the yielded value to become the next value produced by the iterator. When the function returns (the one in the example never does), the iterator is done.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_ck21A7VgZt class=p_ident id=p_ck21A7VgZt></a>Writing iterators is often much easier when you use generator functions. The iterator for the <code>Group</code> class (from the exercise in <a href=https://eloquentjavascript.net/06_object.html#group_iterator>Chapter 6</a>) can be written with this generator:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_C6OZWjI9EM class=c_ident id=c_C6OZWjI9EM></a><p class=cm-variable>Group</p>.<p class=cm-property>prototype</p>[<p class=cm-variable>Symbol</p>.<p class=cm-property>iterator</p>] <p class=cm-operator>=</p> <p class=cm-keyword>function</p><p class=cm-keyword>*</p>() { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-keyword>this</p>.<p class=cm-property>members</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>yield</p> <p class=cm-keyword>this</p>.<p class=cm-property>members</p>[<p class=cm-variable-2>i</p>];\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_oMZiyktu3O class=p_ident id=p_oMZiyktu3O></a>There’s no longer a need to create an object to hold the iteration state—generators automatically save their local state every time they yield.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_YCNJmBl4aF class=p_ident id=p_YCNJmBl4aF></a>Such <code>yield</code> expressions may occur only directly in the generator function itself and not in an inner function you define inside of it. The state a generator saves, when yielding, is only its <em>local</em> environment and the position where it yielded.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_TnoowE9/OQ class=p_ident id=p_TnoowE9/OQ></a>An <code>async</code> function is a special type of generator. It produces a promise when called, which is resolved when it returns (finishes) and rejected when it throws an exception. Whenever it yields (awaits) a promise, the result of that promise (value or thrown exception) is the result of the <code>await</code> expression.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_GXDb0+eMId class=h_ident id=h_GXDb0+eMId></a>The event loop</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_AfROx8LXEr class=p_ident id=p_AfROx8LXEr></a>Asynchronous programs are executed piece by piece. Each piece may start some actions and schedule code to be executed when the action finishes or fails. In between these pieces, the program sits idle, waiting for the next action.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_WG0CglTDJj class=p_ident id=p_WG0CglTDJj></a>So callbacks are not directly called by the code that scheduled them. If I call <code>setTimeout</code> from within a function, that function will have returned by the time the callback function is called. And when the callback returns, control does not go back to the function that scheduled it.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_jb72lBvUWs class=p_ident id=p_jb72lBvUWs></a>Asynchronous behavior happens on its own empty function call stack. This is one of the reasons that, without promises, managing exceptions across asynchronous code is hard. Since each callback starts with a mostly empty stack, your <code>catch</code> handlers won’t be on the stack when they throw an exception.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_UswfjtMHu4 class=c_ident id=c_UswfjtMHu4></a><p class=cm-keyword>try</p> { <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Woosh\"</p>); }, <p class=cm-number>20</p>);\n} <p class=cm-keyword>catch</p> (<p class=cm-def>_</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Caught!\"</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_SHy5RpBOP1 class=p_ident id=p_SHy5RpBOP1></a>No matter how closely together events—such as timeouts or incoming requests—happen, a JavaScript environment will run only one program at a time. You can think of this as it running a big loop <em>around</em> your program, called the <em>event loop</em>. When there’s nothing to be done, that loop is stopped. But as events come in, they are added to a queue, and their code is executed one after the other. Because no two things run at the same time, slow-running code might delay the handling of other events.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_o5sS+xwBLP class=p_ident id=p_o5sS+xwBLP></a>This example sets a timeout but then dallies until after the timeout’s intended point of time, causing the timeout to be late.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_Xozg9CCvVZ class=c_ident id=c_Xozg9CCvVZ></a><p class=cm-keyword>let</p> <p class=cm-def>start</p> <p class=cm-operator>=</p> <p class=cm-variable>Date</p>.<p class=cm-property>now</p>();\n<p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Timeout ran at\"</p>, <p class=cm-variable>Date</p>.<p class=cm-property>now</p>() <p class=cm-operator>-</p> <p class=cm-variable>start</p>);\n}, <p class=cm-number>20</p>);\n<p class=cm-keyword>while</p> (<p class=cm-variable>Date</p>.<p class=cm-property>now</p>() <p class=cm-operator>&lt;</p> <p class=cm-variable>start</p> <p class=cm-operator>+</p> <p class=cm-number>50</p>) {}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Wasted time until\"</p>, <p class=cm-variable>Date</p>.<p class=cm-property>now</p>() <p class=cm-operator>-</p> <p class=cm-variable>start</p>);\n\n</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_OZm6Yhq/Wa class=p_ident id=p_OZm6Yhq/Wa></a>Promises always resolve or reject as a new event. Even if a promise is already resolved, waiting for it will cause your callback to run after the current script finishes, rather than right away.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_B4TYo0a2ol class=c_ident id=c_B4TYo0a2ol></a><p class=cm-variable>Promise</p>.<p class=cm-property>resolve</p>(<p class=cm-string>\"Done\"</p>).<p class=cm-property>then</p>(<p class=cm-variable>console</p>.<p class=cm-property>log</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Me first!\"</p>);\n\n</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_/AFx3XpMr1 class=p_ident id=p_/AFx3XpMr1></a>In later chapters we’ll see various other types of events that run on the event loop.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_FcctcOqtcF class=h_ident id=h_FcctcOqtcF></a>Asynchronous bugs</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_7G3I/OEwrS class=p_ident id=p_7G3I/OEwrS></a>When your program runs synchronously, in a single go, there are no state changes happening except those that the program itself makes. For asynchronous programs this is different—they may have <em>gaps</em> in their execution during which other code can run.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_IHtlm+p6vM class=p_ident id=p_IHtlm+p6vM></a>Let’s look at an example. One of the hobbies of our crows is to count the number of chicks that hatch throughout the village every year. Nests store this count in their storage bulbs. The following code tries to enumerate the counts from all the nests for a given year:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_IMqeevTorV class=c_ident id=c_IMqeevTorV></a><p class=cm-keyword>function</p> <p class=cm-def>anyStorage</p>(<p class=cm-def>nest</p>, <p class=cm-def>source</p>, <p class=cm-def>name</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>source</p> <p class=cm-operator>==</p> <p class=cm-variable-2>nest</p>.<p class=cm-property>name</p>) <p class=cm-keyword>return</p> <p class=cm-variable>storage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>); <p class=cm-keyword>else</p> <p class=cm-keyword>return</p> <p class=cm-variable>routeRequest</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>source</p>, <p class=cm-string>\"storage\"</p>, <p class=cm-variable-2>name</p>);\n} <p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>chicks</p>(<p class=cm-def>nest</p>, <p class=cm-def>year</p>) { <p class=cm-keyword>let</p> <p class=cm-def>list</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>; <p class=cm-keyword>await</p> <p class=cm-variable>Promise</p>.<p class=cm-property>all</p>(<p class=cm-variable>network</p>(<p class=cm-variable-2>nest</p>).<p class=cm-property>map</p>(<p class=cm-keyword>async</p> <p class=cm-def>name</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>list</p> <p class=cm-operator>+=</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>name</p><p class=cm-string-2>}</p><p class=cm-string-2>: ${</p> <p class=cm-keyword>await</p> <p class=cm-variable>anyStorage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>, <p class=cm-string-2>`chicks in ${</p><p class=cm-variable-2>year</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>) <p class=cm-string-2>}</p><p class=cm-string-2>\\n`</p>; })); <p class=cm-keyword>return</p> <p class=cm-variable-2>list</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_0pgRtcGBdP class=p_ident id=p_0pgRtcGBdP></a>The <code>async name =&gt;</code> part shows that arrow functions can also be made <code>async</code> by putting the word <code>async</code> in front of them.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_KHzN+dp1hs class=p_ident id=p_KHzN+dp1hs></a>The code doesn’t immediately look suspicious...it maps the <code>async</code> arrow function over the set of nests, creating an array of promises, and then uses <code>Promise.all</code> to wait for all of these before returning the list they build up.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_TdSgPYi+yD class=p_ident id=p_TdSgPYi+yD></a>But it is seriously broken. It’ll always return only a single line of output, listing the nest that was slowest to respond.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_GWIpudJZ4o class=c_ident id=c_GWIpudJZ4o></a><p class=cm-variable>chicks</p>(<p class=cm-variable>bigOak</p>, <p class=cm-number>2017</p>).<p class=cm-property>then</p>(<p class=cm-variable>console</p>.<p class=cm-property>log</p>);</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_Dvt4nbkZZR class=p_ident id=p_Dvt4nbkZZR></a>Can you work out why?</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_vdkIPINyQy class=p_ident id=p_vdkIPINyQy></a>The problem lies in the <code>+=</code> operator, which takes the <em>current</em> value of <code>list</code> at the time where the statement starts executing and then, when the <code>await</code> finishes, sets the <code>list</code> binding to be that value plus the added string.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_faVxxgg3dQ class=p_ident id=p_faVxxgg3dQ></a>But between the time where the statement starts executing and the time where it finishes there’s an asynchronous gap. The <code>map</code> expression runs before anything has been added to the list, so each of the <code>+=</code> operators starts from an empty string and ends up, when its storage retrieval finishes, setting <code>list</code> to a single-line list—the result of adding its line to the empty string.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_WrnTDweOkP class=p_ident id=p_WrnTDweOkP></a>This could have easily been avoided by returning the lines from the mapped promises and calling <code>join</code> on the result of <code>Promise.all</code>, instead of building up the list by changing a binding. As usual, computing new values is less error-prone than changing existing values.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_gkD231Soao class=c_ident id=c_gkD231Soao></a><p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>chicks</p>(<p class=cm-def>nest</p>, <p class=cm-def>year</p>) { <p class=cm-keyword>let</p> <p class=cm-def>lines</p> <p class=cm-operator>=</p> <p class=cm-variable>network</p>(<p class=cm-variable-2>nest</p>).<p class=cm-property>map</p>(<p class=cm-keyword>async</p> <p class=cm-def>name</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable-2>name</p> <p class=cm-operator>+</p> <p class=cm-string>\": \"</p> <p class=cm-operator>+</p> <p class=cm-keyword>await</p> <p class=cm-variable>anyStorage</p>(<p class=cm-variable-2>nest</p>, <p class=cm-variable-2>name</p>, <p class=cm-string-2>`chicks in ${</p><p class=cm-variable-2>year</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); }); <p class=cm-keyword>return</p> (<p class=cm-keyword>await</p> <p class=cm-variable>Promise</p>.<p class=cm-property>all</p>(<p class=cm-variable-2>lines</p>)).<p class=cm-property>join</p>(<p class=cm-string>\"\\n\"</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/11_async.html#p_7XYZHth7ax class=p_ident id=p_7XYZHth7ax></a>Mistakes like this are easy to make, especially when using <code>await</code>, and you should be aware of where the gaps in your code occur. An advantage of JavaScript’s <em>explicit</em> asynchronicity (whether through callbacks, promises, or <code>await</code>) is that spotting these gaps is relatively easy.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/11_async.html#p_MoVe59fjo8 class=p_ident id=p_MoVe59fjo8></a>Asynchronous programming makes it possible to express waiting for long-running actions without freezing the program during these actions. JavaScript environments typically implement this style of programming using callbacks, functions that are called when the actions complete. An event loop schedules such callbacks to be called when appropriate, one after the other, so that their execution does not overlap.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_8QVLsE1w4k class=p_ident id=p_8QVLsE1w4k></a>Programming asynchronously is made easier by promises, objects that represent actions that might complete in the future, and <code>async</code> functions, which allow you to write an asynchronous program as if it were synchronous.</p> <h2><a href=https://eloquentjavascript.net/11_async.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/11_async.html#i_UvyahfUnfl class=i_ident id=i_UvyahfUnfl></a>Tracking the scalpel</h3> <p><a href=https://eloquentjavascript.net/11_async.html#p_x4s0mGpqFW class=p_ident id=p_x4s0mGpqFW></a>The village crows own an old scalpel that they occasionally use on special missions—say, to cut through screen doors or packaging. To be able to quickly track it down, every time the scalpel is moved to another nest, an entry is added to the storage of both the nest that had it and the nest that took it, under the name <code>\"scalpel\"</code>, with its new location as the value.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_X85b03YAMx class=p_ident id=p_X85b03YAMx></a>This means that finding the scalpel is a matter of following the breadcrumb trail of storage entries, until you find a nest where that points at the nest itself.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_pGzF+NquWH class=p_ident id=p_pGzF+NquWH></a>Write an <code>async</code> function <code>locateScalpel</code> that does this, starting at the nest on which it runs. You can use the <code>anyStorage</code> function defined earlier to access storage in arbitrary nests. The scalpel has been going around long enough that you may assume that every nest has a <code>\"scalpel\"</code> entry in its data storage.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_kCIUGPuKAV class=p_ident id=p_kCIUGPuKAV></a>Next, write the same function again without using <code>async</code> and <code>await</code>.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_rIlnOS1Bz0 class=p_ident id=p_rIlnOS1Bz0></a>Do request failures properly show up as rejections of the returned promise in both versions? How?</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_YnFVXk9tRo class=c_ident id=c_YnFVXk9tRo></a><p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>locateScalpel</p>(<p class=cm-def>nest</p>) { } <p class=cm-keyword>function</p> <p class=cm-def>locateScalpel2</p>(<p class=cm-def>nest</p>) { } <p class=cm-variable>locateScalpel</p>(<p class=cm-variable>bigOak</p>).<p class=cm-property>then</p>(<p class=cm-variable>console</p>.<p class=cm-property>log</p>);\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/11_async.html#p_HBYJhQLRh0 class=p_ident id=p_HBYJhQLRh0></a>This can be done with a single loop that searches through the nests, moving forward to the next when it finds a value that doesn’t match the current nest’s name and returning the name when it finds a matching value. In the <code>async</code> function, a regular <code>for</code> or <code>while</code> loop can be used.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_dvm1OVOM4s class=p_ident id=p_dvm1OVOM4s></a>To do the same in a plain function, you will have to build your loop using a recursive function. The easiest way to do this is to have that function return a promise by calling <code>then</code> on the promise that retrieves the storage value. Depending on whether that value matches the name of the current nest, the handler returns that value or a further promise created by calling the loop function again.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_4zv80GXYD/ class=p_ident id=p_4zv80GXYD/ ></a>Don’t forget to start the loop by calling the recursive function once from the main function.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_h9Yrbo5Eju class=p_ident id=p_h9Yrbo5Eju></a>In the <code>async</code> function, rejected promises are converted to exceptions by <code>await</code>. When an <code>async</code> function throws an exception, its promise is rejected. So that works.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_GEDOzip0j2 class=p_ident id=p_GEDOzip0j2></a>If you implemented the non-<code>async</code> function as outlined earlier, the way <code>then</code> works also automatically causes a failure to end up in the returned promise. If a request fails, the handler passed to <code>then</code> isn’t called, and the promise it returns is rejected with the same reason.</p> </div></div> <h3><a href=https://eloquentjavascript.net/11_async.html#i_Ug+Dv9Mmsw class=i_ident id=i_Ug+Dv9Mmsw></a>Building Promise.all</h3> <p><a href=https://eloquentjavascript.net/11_async.html#p_V49Fgs6t/I class=p_ident id=p_V49Fgs6t/I></a>Given an array of promises, <code>Promise.all</code> returns a promise that waits for all of the promises in the array to finish. It then succeeds, yielding an array of result values. If a promise in the array fails, the promise returned by <code>all</code> fails too, with the failure reason from the failing promise.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_D4i3Qt21e7 class=p_ident id=p_D4i3Qt21e7></a>Implement something like this yourself as a regular function called <code>Promise_all</code>.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_pUBmweFzla class=p_ident id=p_pUBmweFzla></a>Remember that after a promise has succeeded or failed, it can’t succeed or fail again, and further calls to the functions that resolve it are ignored. This can simplify the way you handle failure of your promise.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/11_async.html#c_70Eq9i3rpH class=c_ident id=c_70Eq9i3rpH></a><p class=cm-keyword>function</p> <p class=cm-def>Promise_all</p>(<p class=cm-def>promises</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>((<p class=cm-def>resolve</p>, <p class=cm-def>reject</p>) <p class=cm-operator>=&gt;</p> { });\n} <p class=cm-variable>Promise_all</p>([]).<p class=cm-property>then</p>(<p class=cm-def>array</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"This should be []:\"</p>, <p class=cm-variable-2>array</p>);\n});\n<p class=cm-keyword>function</p> <p class=cm-def>soon</p>(<p class=cm-def>val</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>(<p class=cm-def>resolve</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>val</p>), <p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-number>500</p>); });\n}\n<p class=cm-variable>Promise_all</p>([<p class=cm-variable>soon</p>(<p class=cm-number>1</p>), <p class=cm-variable>soon</p>(<p class=cm-number>2</p>), <p class=cm-variable>soon</p>(<p class=cm-number>3</p>)]).<p class=cm-property>then</p>(<p class=cm-def>array</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"This should be [1, 2, 3]:\"</p>, <p class=cm-variable-2>array</p>);\n});\n<p class=cm-variable>Promise_all</p>([<p class=cm-variable>soon</p>(<p class=cm-number>1</p>), <p class=cm-variable>Promise</p>.<p class=cm-property>reject</p>(<p class=cm-string>\"X\"</p>), <p class=cm-variable>soon</p>(<p class=cm-number>3</p>)]) .<p class=cm-property>then</p>(<p class=cm-def>array</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"We should not get here\"</p>); }) .<p class=cm-property>catch</p>(<p class=cm-def>error</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>error</p> <p class=cm-operator>!=</p> <p class=cm-string>\"X\"</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Unexpected failure:\"</p>, <p class=cm-variable-2>error</p>);\n    }\n  });</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/11_async.html#p_zV4HNd52Ay class=p_ident id=p_zV4HNd52Ay></a>The function passed to the <code>Promise</code> constructor will have to call <code>then</code> on each of the promises in the given array. When one of them succeeds, two things need to happen. The resulting value needs to be stored in the correct position of a result array, and we must check whether this was the last pending promise and finish our own promise if it was.</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_oMTLkDbIsp class=p_ident id=p_oMTLkDbIsp></a>The latter can be done with a counter that is initialized to the length of the input array and from which we subtract 1 every time a promise succeeds. When it reaches 0, we are done. Make sure you take into account the situation where the input array is empty (and thus no promise will ever resolve).</p> <p><a href=https://eloquentjavascript.net/11_async.html#p_pVTKGiHusk class=p_ident id=p_pVTKGiHusk></a>Handling failure requires some thought but turns out to be extremely simple. Just pass the <code>reject</code> function of the wrapping promise to each of the promises in the array as a <code>catch</code> handler or as a second argument to <code>then</code> so that a failure in one of them triggers the rejection of the whole wrapper promise.</p> </div></div><nav><a href=https://eloquentjavascript.net/10_modules.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/12_language.html>▶</a></nav>\n</article><hr><h4>Page 8</h4><article score=702.7750000000001>\n<nav><a href=https://eloquentjavascript.net/11_async.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/13_browser.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/12_language.html#p_Mt+zDiEThG class=p_ident id=p_Mt+zDiEThG></a>The evaluator, which determines the meaning of expressions in a programming language, is just another program.</p> <footer>Hal Abelson and Gerald Sussman, <cite>Structure and Interpretation of Computer Programs</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of an egg with smaller eggs inside\" src=https://eloquentjavascript.net/img/chapter_picture_12.jpg></figure> <p><a href=https://eloquentjavascript.net/12_language.html#p_sLOpE8A1YZ class=p_ident id=p_sLOpE8A1YZ></a>Building your own programming language is surprisingly easy (as long as you do not aim too high) and very enlightening.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_XWyxXihLGw class=p_ident id=p_XWyxXihLGw></a>The main thing I want to show in this chapter is that there is no magic involved in building your own language. I’ve often felt that some human inventions were so immensely clever and complicated that I’d never be able to understand them. But with a little reading and experimenting, they often turn out to be quite mundane.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_lwKaxcGOfP class=p_ident id=p_lwKaxcGOfP></a>We will build a programming language called Egg. It will be a tiny, simple language—but one that is powerful enough to express any computation you can think of. It will allow simple abstraction based on functions.</p> <h2 id=parsing><a href=https://eloquentjavascript.net/12_language.html#h_cpTTNxAWkQ class=h_ident id=h_cpTTNxAWkQ></a>Parsing</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_iHS+/Um+4q class=p_ident id=p_iHS+/Um+4q></a>The most immediately visible part of a programming language is its <em>syntax</em>, or notation. A <em>parser</em> is a program that reads a piece of text and produces a data structure that reflects the structure of the program contained in that text. If the text does not form a valid program, the parser should point out the error.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_aBKAId2dD2 class=p_ident id=p_aBKAId2dD2></a>Our language will have a simple and uniform syntax. Everything in Egg is an expression. An expression can be the name of a binding, a number, a string, or an <em>application</em>. Applications are used for function calls but also for constructs such as <code>if</code> or <code>while</code>.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_Us9En1q6+r class=p_ident id=p_Us9En1q6+r></a>To keep the parser simple, strings in Egg do not support anything like backslash escapes. A string is simply a sequence of characters that are not double quotes, wrapped in double quotes. A number is a sequence of digits. Binding names can consist of any character that is not whitespace and that does not have a special meaning in the syntax.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_N7llkiWaN/ class=p_ident id=p_N7llkiWaN/ ></a>Applications are written the way they are in JavaScript, by putting parentheses after an expression and having any number of arguments between those parentheses, separated by commas.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_WUuISgykcX class=c_ident id=c_WUuISgykcX></a>do(define(x, 10),\n   if(&gt;(x, 5),\n      print(\"large\"),\n      print(\"small\")))</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_HBJ5fbzauR class=p_ident id=p_HBJ5fbzauR></a>The uniformity of the Egg language means that things that are operators in JavaScript (such as <code>&gt;</code>) are normal bindings in this language, applied just like other functions. And since the syntax has no concept of a block, we need a <code>do</code> construct to represent doing multiple things in sequence.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_aL3GdDKR9a class=p_ident id=p_aL3GdDKR9a></a>The data structure that the parser will use to describe a program consists of expression objects, each of which has a <code>type</code> property indicating the kind of expression it is and other properties to describe its content.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_1s3I5AYr64 class=p_ident id=p_1s3I5AYr64></a>Expressions of type <code>\"value\"</code> represent literal strings or numbers. Their <code>value</code> property contains the string or number value that they represent. Expressions of type <code>\"word\"</code> are used for identifiers (names). Such objects have a <code>name</code> property that holds the identifier’s name as a string. Finally, <code>\"apply\"</code> expressions represent applications. They have an <code>operator</code> property that refers to the expression that is being applied, as well as an <code>args</code> property that holds an array of argument expressions.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_wueahIWuuc class=p_ident id=p_wueahIWuuc></a>The <code>&gt;(x, 5)</code> part of the previous program would be represented like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_YRUVy1WdLZ class=c_ident id=c_YRUVy1WdLZ></a>{ <p class=cm-property>type</p>: <p class=cm-string>\"apply\"</p>, <p class=cm-property>operator</p>: {<p class=cm-property>type</p>: <p class=cm-string>\"word\"</p>, <p class=cm-property>name</p>: <p class=cm-string>\"&gt;\"</p>}, <p class=cm-property>args</p>: [ {<p class=cm-property>type</p>: <p class=cm-string>\"word\"</p>, <p class=cm-property>name</p>: <p class=cm-string>\"x\"</p>}, {<p class=cm-property>type</p>: <p class=cm-string>\"value\"</p>, <p class=cm-property>value</p>: <p class=cm-number>5</p>}\n  ]\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_97QzTGLJEr class=p_ident id=p_97QzTGLJEr></a>Such a data structure is called a <em>syntax tree</em>. If you imagine the objects as dots and the links between them as lines between those dots, it has a treelike shape. The fact that expressions contain other expressions, which in turn might contain more expressions, is similar to the way tree branches split and split again.</p><figure><img alt=\"The structure of a syntax tree\" src=https://eloquentjavascript.net/img/syntax_tree.svg></figure> <p><a href=https://eloquentjavascript.net/12_language.html#p_TiCtOm6qwQ class=p_ident id=p_TiCtOm6qwQ></a>Contrast this to the parser we wrote for the configuration file format in <a href=https://eloquentjavascript.net/09_regexp.html#ini>Chapter 9</a>, which had a simple structure: it split the input into lines and handled those lines one at a time. There were only a few simple forms that a line was allowed to have.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_OtoCO51d4l class=p_ident id=p_OtoCO51d4l></a>Here we must find a different approach. Expressions are not separated into lines, and they have a recursive structure. Application expressions <em>contain</em> other expressions.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_ouduag85mO class=p_ident id=p_ouduag85mO></a>Fortunately, this problem can be solved very well by writing a parser function that is recursive in a way that reflects the recursive nature of the language.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_vEMw7RQ1iA class=p_ident id=p_vEMw7RQ1iA></a>We define a function <code>parseExpression</code>, which takes a string as input and returns an object containing the data structure for the expression at the start of the string, along with the part of the string left after parsing this expression. When parsing subexpressions (the argument to an application, for example), this function can be called again, yielding the argument expression as well as the text that remains. This text may in turn contain more arguments or may be the closing parenthesis that ends the list of arguments.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_qQZOLuZdMw class=p_ident id=p_qQZOLuZdMw></a>This is the first part of the parser:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_Wq0wHUqay5 class=c_ident id=c_Wq0wHUqay5></a><p class=cm-keyword>function</p> <p class=cm-def>parseExpression</p>(<p class=cm-def>program</p>) { <p class=cm-variable-2>program</p> <p class=cm-operator>=</p> <p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>program</p>); <p class=cm-keyword>let</p> <p class=cm-def>match</p>, <p class=cm-def>expr</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>match</p> <p class=cm-operator>=</p> <p class=cm-string-2>/^\"([^\"]*)\"/</p>.<p class=cm-property>exec</p>(<p class=cm-variable-2>program</p>)) { <p class=cm-variable-2>expr</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"value\"</p>, <p class=cm-property>value</p>: <p class=cm-variable-2>match</p>[<p class=cm-number>1</p>]}; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>match</p> <p class=cm-operator>=</p> <p class=cm-string-2>/^\\d+\\b/</p>.<p class=cm-property>exec</p>(<p class=cm-variable-2>program</p>)) { <p class=cm-variable-2>expr</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"value\"</p>, <p class=cm-property>value</p>: <p class=cm-variable>Number</p>(<p class=cm-variable-2>match</p>[<p class=cm-number>0</p>])}; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>match</p> <p class=cm-operator>=</p> <p class=cm-string-2>/^[^\\s(),#\"]+/</p>.<p class=cm-property>exec</p>(<p class=cm-variable-2>program</p>)) { <p class=cm-variable-2>expr</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"word\"</p>, <p class=cm-property>name</p>: <p class=cm-variable-2>match</p>[<p class=cm-number>0</p>]}; } <p class=cm-keyword>else</p> { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Unexpected syntax: \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>program</p>); } <p class=cm-keyword>return</p> <p class=cm-variable>parseApply</p>(<p class=cm-variable-2>expr</p>, <p class=cm-variable-2>program</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>match</p>[<p class=cm-number>0</p>].<p class=cm-property>length</p>));\n} <p class=cm-keyword>function</p> <p class=cm-def>skipSpace</p>(<p class=cm-def>string</p>) { <p class=cm-keyword>let</p> <p class=cm-def>first</p> <p class=cm-operator>=</p> <p class=cm-variable-2>string</p>.<p class=cm-property>search</p>(<p class=cm-string-2>/\\S/</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>first</p> <p class=cm-operator>==</p> <p class=cm-operator>-</p><p class=cm-number>1</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"\"</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>string</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>first</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_Y6B44JswIj class=p_ident id=p_Y6B44JswIj></a>Because Egg, like JavaScript, allows any amount of whitespace between its elements, we have to repeatedly cut the whitespace off the start of the program string. That is what the <code>skipSpace</code> function helps with.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_OMLAKNeu9S class=p_ident id=p_OMLAKNeu9S></a>After skipping any leading space, <code>parseExpression</code> uses three regular expressions to spot the three atomic elements that Egg supports: strings, numbers, and words. The parser constructs a different kind of data structure depending on which one matches. If the input does not match one of these three forms, it is not a valid expression, and the parser throws an error. We use <code>SyntaxError</code> instead of <code>Error</code> as the exception constructor, which is another standard error type, because it is a little more specific—it is also the error type thrown when an attempt is made to run an invalid JavaScript program.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_pGQdVONUL4 class=p_ident id=p_pGQdVONUL4></a>We then cut off the part that was matched from the program string and pass that, along with the object for the expression, to <code>parseApply</code>, which checks whether the expression is an application. If so, it parses a parenthesized list of arguments.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_tCV23NW6UI class=c_ident id=c_tCV23NW6UI></a><p class=cm-keyword>function</p> <p class=cm-def>parseApply</p>(<p class=cm-def>expr</p>, <p class=cm-def>program</p>) { <p class=cm-variable-2>program</p> <p class=cm-operator>=</p> <p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>program</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>program</p>[<p class=cm-number>0</p>] <p class=cm-operator>!=</p> <p class=cm-string>\"(\"</p>) { <p class=cm-keyword>return</p> {<p class=cm-property>expr</p>: <p class=cm-variable-2>expr</p>, <p class=cm-property>rest</p>: <p class=cm-variable-2>program</p>}; } <p class=cm-variable-2>program</p> <p class=cm-operator>=</p> <p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>program</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>)); <p class=cm-variable-2>expr</p> <p class=cm-operator>=</p> {<p class=cm-property>type</p>: <p class=cm-string>\"apply\"</p>, <p class=cm-property>operator</p>: <p class=cm-variable-2>expr</p>, <p class=cm-property>args</p>: []}; <p class=cm-keyword>while</p> (<p class=cm-variable-2>program</p>[<p class=cm-number>0</p>] <p class=cm-operator>!=</p> <p class=cm-string>\")\"</p>) { <p class=cm-keyword>let</p> <p class=cm-def>arg</p> <p class=cm-operator>=</p> <p class=cm-variable>parseExpression</p>(<p class=cm-variable-2>program</p>); <p class=cm-variable-2>expr</p>.<p class=cm-property>args</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>arg</p>.<p class=cm-property>expr</p>); <p class=cm-variable-2>program</p> <p class=cm-operator>=</p> <p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>arg</p>.<p class=cm-property>rest</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>program</p>[<p class=cm-number>0</p>] <p class=cm-operator>==</p> <p class=cm-string>\",\"</p>) { <p class=cm-variable-2>program</p> <p class=cm-operator>=</p> <p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>program</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>)); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>program</p>[<p class=cm-number>0</p>] <p class=cm-operator>!=</p> <p class=cm-string>\")\"</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Expected ',' or ')'\"</p>); } } <p class=cm-keyword>return</p> <p class=cm-variable>parseApply</p>(<p class=cm-variable-2>expr</p>, <p class=cm-variable-2>program</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>));\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_s9VFvU/BT3 class=p_ident id=p_s9VFvU/BT3></a>If the next character in the program is not an opening parenthesis, this is not an application, and <code>parseApply</code> returns the expression it was given.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_rdoND4Um+i class=p_ident id=p_rdoND4Um+i></a>Otherwise, it skips the opening parenthesis and creates the syntax tree object for this application expression. It then recursively calls <code>parseExpression</code> to parse each argument until a closing parenthesis is found. The recursion is indirect, through <code>parseApply</code> and <code>parseExpression</code> calling each other.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_G9HFeaWQ5+ class=p_ident id=p_G9HFeaWQ5+></a>Because an application expression can itself be applied (such as in <code>multiplier(2)(1)</code>), <code>parseApply</code> must, after it has parsed an application, call itself again to check whether another pair of parentheses follows.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_ZG1H567GVD class=p_ident id=p_ZG1H567GVD></a>This is all we need to parse Egg. We wrap it in a convenient <code>parse</code> function that verifies that it has reached the end of the input string after parsing the expression (an Egg program is a single expression), and that gives us the program’s data structure.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_P0tq+UdJy1 class=c_ident id=c_P0tq+UdJy1></a><p class=cm-keyword>function</p> <p class=cm-def>parse</p>(<p class=cm-def>program</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>expr</p>, <p class=cm-def>rest</p>} <p class=cm-operator>=</p> <p class=cm-variable>parseExpression</p>(<p class=cm-variable-2>program</p>); <p class=cm-keyword>if</p> (<p class=cm-variable>skipSpace</p>(<p class=cm-variable-2>rest</p>).<p class=cm-property>length</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Unexpected text after program\"</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>expr</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>parse</p>(<p class=cm-string>\"+(a, 10)\"</p>));\n\n\n\n</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_sbjERs3L8Y class=p_ident id=p_sbjERs3L8Y></a>It works! It doesn’t give us very helpful information when it fails and doesn’t store the line and column on which each expression starts, which might be helpful when reporting errors later, but it’s good enough for our purposes.</p> <h2><a href=https://eloquentjavascript.net/12_language.html#h_HlYkF24q0q class=h_ident id=h_HlYkF24q0q></a>The evaluator</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_zhwRUqtrSl class=p_ident id=p_zhwRUqtrSl></a>What can we do with the syntax tree for a program? Run it, of course! And that is what the evaluator does. You give it a syntax tree and a scope object that associates names with values, and it will evaluate the expression that the tree represents and return the value that this produces.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_v23JbR3fAL class=c_ident id=c_v23JbR3fAL></a><p class=cm-keyword>const</p> <p class=cm-def>specialForms</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-keyword>function</p> <p class=cm-def>evaluate</p>(<p class=cm-def>expr</p>, <p class=cm-def>scope</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>expr</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"value\"</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>expr</p>.<p class=cm-property>value</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>expr</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"word\"</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>expr</p>.<p class=cm-property>name</p> <p class=cm-keyword>in</p> <p class=cm-variable-2>scope</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>scope</p>[<p class=cm-variable-2>expr</p>.<p class=cm-property>name</p>]; } <p class=cm-keyword>else</p> { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>ReferenceError</p>( <p class=cm-string-2>`Undefined binding: ${</p><p class=cm-variable-2>expr</p>.<p class=cm-property>name</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>); } } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>expr</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"apply\"</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>operator</p>, <p class=cm-def>args</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>expr</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>operator</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"word\"</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>operator</p>.<p class=cm-property>name</p> <p class=cm-keyword>in</p> <p class=cm-variable>specialForms</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>specialForms</p>[<p class=cm-variable-2>operator</p>.<p class=cm-property>name</p>](<p class=cm-variable-2>expr</p>.<p class=cm-property>args</p>, <p class=cm-variable-2>scope</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>op</p> <p class=cm-operator>=</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>operator</p>, <p class=cm-variable-2>scope</p>); <p class=cm-keyword>if</p> (<p class=cm-keyword>typeof</p> <p class=cm-variable-2>op</p> <p class=cm-operator>==</p> <p class=cm-string>\"function\"</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>op</p>(<p class=cm-variable-2>args</p>.<p class=cm-property>map</p>(<p class=cm-def>arg</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>arg</p>, <p class=cm-variable-2>scope</p>))); } <p class=cm-keyword>else</p> { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>TypeError</p>(<p class=cm-string>\"Applying a non-function.\"</p>);\n      }\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_iJ+cB7ncAD class=p_ident id=p_iJ+cB7ncAD></a>The evaluator has code for each of the expression types. A literal value expression produces its value. (For example, the expression <code>100</code> just evaluates to the number 100.) For a binding, we must check whether it is actually defined in the scope and, if it is, fetch the binding’s value.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_NLdaIAcdf6 class=p_ident id=p_NLdaIAcdf6></a>Applications are more involved. If they are a special form, like <code>if</code>, we do not evaluate anything and pass the argument expressions, along with the scope, to the function that handles this form. If it is a normal call, we evaluate the operator, verify that it is a function, and call it with the evaluated arguments.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_6TdgYHF3F3 class=p_ident id=p_6TdgYHF3F3></a>We use plain JavaScript function values to represent Egg’s function values. We will come back to this <a href=https://eloquentjavascript.net/12_language.html#egg_fun>later</a>, when the special form called <code>fun</code> is defined.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_wol0KtLeGh class=p_ident id=p_wol0KtLeGh></a>The recursive structure of <code>evaluate</code> resembles the similar structure of the parser, and both mirror the structure of the language itself. It would also be possible to integrate the parser with the evaluator and evaluate during parsing, but splitting them up this way makes the program clearer.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_lfbXYqM2w2 class=p_ident id=p_lfbXYqM2w2></a>This is really all that is needed to interpret Egg. It is that simple. But without defining a few special forms and adding some useful values to the environment, you can’t do much with this language yet.</p> <h2><a href=https://eloquentjavascript.net/12_language.html#h_JOCrYKZbDr class=h_ident id=h_JOCrYKZbDr></a>Special forms</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_R9YTZoL8Oo class=p_ident id=p_R9YTZoL8Oo></a>The <code>specialForms</code> object is used to define special syntax in Egg. It associates words with functions that evaluate such forms. It is currently empty. Let’s add <code>if</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_4kMBuxSNgt class=c_ident id=c_4kMBuxSNgt></a><p class=cm-variable>specialForms</p>.<p class=cm-property>if</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>args</p>.<p class=cm-property>length</p> <p class=cm-operator>!=</p> <p class=cm-number>3</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Wrong number of args to if\"</p>); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>0</p>], <p class=cm-variable-2>scope</p>) <p class=cm-operator>!==</p> <p class=cm-atom>false</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>1</p>], <p class=cm-variable-2>scope</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>2</p>], <p class=cm-variable-2>scope</p>);\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_8j6jdyDOpo class=p_ident id=p_8j6jdyDOpo></a>Egg’s <code>if</code> construct expects exactly three arguments. It will evaluate the first, and if the result isn’t the value <code>false</code>, it will evaluate the second. Otherwise, the third gets evaluated. This <code>if</code> form is more similar to JavaScript’s ternary <code>?:</code> operator than to JavaScript’s <code>if</code>. It is an expression, not a statement, and it produces a value, namely, the result of the second or third argument.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_9fjtidVbOZ class=p_ident id=p_9fjtidVbOZ></a>Egg also differs from JavaScript in how it handles the condition value to <code>if</code>. It will not treat things like zero or the empty string as false, only the precise value <code>false</code>.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_vwKmxnusyS class=p_ident id=p_vwKmxnusyS></a>The reason we need to represent <code>if</code> as a special form, rather than a regular function, is that all arguments to functions are evaluated before the function is called, whereas <code>if</code> should evaluate only <em>either</em> its second or its third argument, depending on the value of the first.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_QqSon2ioSi class=p_ident id=p_QqSon2ioSi></a>The <code>while</code> form is similar.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_wZb+EB+hgA class=c_ident id=c_wZb+EB+hgA></a><p class=cm-variable>specialForms</p>.<p class=cm-property>while</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>args</p>.<p class=cm-property>length</p> <p class=cm-operator>!=</p> <p class=cm-number>2</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Wrong number of args to while\"</p>); } <p class=cm-keyword>while</p> (<p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>0</p>], <p class=cm-variable-2>scope</p>) <p class=cm-operator>!==</p> <p class=cm-atom>false</p>) { <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>1</p>], <p class=cm-variable-2>scope</p>); } <p class=cm-keyword>return</p> <p class=cm-atom>false</p>;\n};</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_SIqEJzuMdz class=p_ident id=p_SIqEJzuMdz></a>Another basic building block is <code>do</code>, which executes all its arguments from top to bottom. Its value is the value produced by the last argument.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_QkaRUun3ao class=c_ident id=c_QkaRUun3ao></a><p class=cm-variable>specialForms</p>.<p class=cm-property>do</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>value</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>arg</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>args</p>) { <p class=cm-variable-2>value</p> <p class=cm-operator>=</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>arg</p>, <p class=cm-variable-2>scope</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>value</p>;\n};</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_KvAMPTVJ2y class=p_ident id=p_KvAMPTVJ2y></a>To be able to create bindings and give them new values, we also create a form called <code>define</code>. It expects a word as its first argument and an expression producing the value to assign to that word as its second argument. Since <code>define</code>, like everything, is an expression, it must return a value. We’ll make it return the value that was assigned (just like JavaScript’s <code>=</code> operator).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_/TYE9JhkNk class=c_ident id=c_/TYE9JhkNk></a><p class=cm-variable>specialForms</p>.<p class=cm-property>define</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>args</p>.<p class=cm-property>length</p> <p class=cm-operator>!=</p> <p class=cm-number>2</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable-2>args</p>[<p class=cm-number>0</p>].<p class=cm-property>type</p> <p class=cm-operator>!=</p> <p class=cm-string>\"word\"</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Incorrect use of define\"</p>); } <p class=cm-keyword>let</p> <p class=cm-def>value</p> <p class=cm-operator>=</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>args</p>[<p class=cm-number>1</p>], <p class=cm-variable-2>scope</p>); <p class=cm-variable-2>scope</p>[<p class=cm-variable-2>args</p>[<p class=cm-number>0</p>].<p class=cm-property>name</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>value</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>value</p>;\n};</pre> <h2><a href=https://eloquentjavascript.net/12_language.html#h_2Tc54fkIgF class=h_ident id=h_2Tc54fkIgF></a>The environment</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_Mkc8xlkeHk class=p_ident id=p_Mkc8xlkeHk></a>The scope accepted by <code>evaluate</code> is an object with properties whose names correspond to binding names and whose values correspond to the values those bindings are bound to. Let’s define an object to represent the global scope.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_3eybUSvE1z class=p_ident id=p_3eybUSvE1z></a>To be able to use the <code>if</code> construct we just defined, we must have access to Boolean values. Since there are only two Boolean values, we do not need special syntax for them. We simply bind two names to the values <code>true</code> and <code>false</code> and use them.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_vJ45zHlK0v class=c_ident id=c_vJ45zHlK0v></a><p class=cm-keyword>const</p> <p class=cm-def>topScope</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-variable>topScope</p>.<p class=cm-property>true</p> <p class=cm-operator>=</p> <p class=cm-atom>true</p>;\n<p class=cm-variable>topScope</p>.<p class=cm-property>false</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>;</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_mLmm584R4a class=p_ident id=p_mLmm584R4a></a>We can now evaluate a simple expression that negates a Boolean value.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_ynBEgrK+/h class=c_ident id=c_ynBEgrK+/h></a><p class=cm-keyword>let</p> <p class=cm-def>prog</p> <p class=cm-operator>=</p> <p class=cm-variable>parse</p>(<p class=cm-string-2>`if(true, false, true)`</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>evaluate</p>(<p class=cm-variable>prog</p>, <p class=cm-variable>topScope</p>));\n</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_zuRstuTjxo class=p_ident id=p_zuRstuTjxo></a>To supply basic arithmetic and comparison operators, we will also add some function values to the scope. In the interest of keeping the code short, we’ll use <code>Function</code> to synthesize a bunch of operator functions in a loop, instead of defining them individually.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_OTgmEw/s8v class=c_ident id=c_OTgmEw/s8v></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>op</p> <p class=cm-keyword>of</p> [<p class=cm-string>\"+\"</p>, <p class=cm-string>\"-\"</p>, <p class=cm-string>\"*\"</p>, <p class=cm-string>\"/\"</p>, <p class=cm-string>\"==\"</p>, <p class=cm-string>\"&lt;\"</p>, <p class=cm-string>\"&gt;\"</p>]) { <p class=cm-variable>topScope</p>[<p class=cm-variable>op</p>] <p class=cm-operator>=</p> <p class=cm-variable>Function</p>(<p class=cm-string>\"a, b\"</p>, <p class=cm-string-2>`return a ${</p><p class=cm-variable>op</p><p class=cm-string-2>}</p> <p class=cm-string-2>b;`</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_nv+OyOKpzZ class=p_ident id=p_nv+OyOKpzZ></a>A way to output values is also useful, so we’ll wrap <code>console.log</code> in a function and call it <code>print</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_XFrq8jIuQC class=c_ident id=c_XFrq8jIuQC></a><p class=cm-variable>topScope</p>.<p class=cm-property>print</p> <p class=cm-operator>=</p> <p class=cm-def>value</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>value</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>value</p>;\n};</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_+CG1YjXYFG class=p_ident id=p_+CG1YjXYFG></a>That gives us enough elementary tools to write simple programs. The following function provides a convenient way to parse a program and run it in a fresh scope:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_aPeJgSZPEO class=c_ident id=c_aPeJgSZPEO></a><p class=cm-keyword>function</p> <p class=cm-def>run</p>(<p class=cm-def>program</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable>parse</p>(<p class=cm-variable-2>program</p>), <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-variable>topScope</p>));\n}</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_3RSx9KsCbf class=p_ident id=p_3RSx9KsCbf></a>We’ll use object prototype chains to represent nested scopes so that the program can add bindings to its local scope without changing the top-level scope.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_uW/XtfVXMZ class=c_ident id=c_uW/XtfVXMZ></a><p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(total, 0),</p> <p class=cm-string-2>define(count, 1),</p> <p class=cm-string-2>while(&lt;(count, 11),</p> <p class=cm-string-2>do(define(total, +(total, count)),</p> <p class=cm-string-2>define(count, +(count, 1)))),</p> <p class=cm-string-2>print(total))</p>\n<p class=cm-string-2>`</p>);\n</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_4cQhF2ypgW class=p_ident id=p_4cQhF2ypgW></a>This is the program we’ve seen several times before, which computes the sum of the numbers 1 to 10, expressed in Egg. It is clearly uglier than the equivalent JavaScript program—but not bad for a language implemented in less than 150 lines of code.</p> <h2 id=egg_fun><a href=https://eloquentjavascript.net/12_language.html#h_K5Yd6h3Axg class=h_ident id=h_K5Yd6h3Axg></a>Functions</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_r7HIVKVzo4 class=p_ident id=p_r7HIVKVzo4></a>A programming language without functions is a poor programming language indeed.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_OEAPwS9R8Z class=p_ident id=p_OEAPwS9R8Z></a>Fortunately, it isn’t hard to add a <code>fun</code> construct, which treats its last argument as the function’s body and uses all arguments before that as the names of the function’s parameters.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_cnvuH0fWH0 class=c_ident id=c_cnvuH0fWH0></a><p class=cm-variable>specialForms</p>.<p class=cm-property>fun</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>args</p>.<p class=cm-property>length</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Functions need a body\"</p>); } <p class=cm-keyword>let</p> <p class=cm-def>body</p> <p class=cm-operator>=</p> <p class=cm-variable-2>args</p>[<p class=cm-variable-2>args</p>.<p class=cm-property>length</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>]; <p class=cm-keyword>let</p> <p class=cm-def>params</p> <p class=cm-operator>=</p> <p class=cm-variable-2>args</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>args</p>.<p class=cm-property>length</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>).<p class=cm-property>map</p>(<p class=cm-def>expr</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>expr</p>.<p class=cm-property>type</p> <p class=cm-operator>!=</p> <p class=cm-string>\"word\"</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>SyntaxError</p>(<p class=cm-string>\"Parameter names must be words\"</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>expr</p>.<p class=cm-property>name</p>; }); <p class=cm-keyword>return</p> <p class=cm-keyword>function</p>() { <p class=cm-keyword>if</p> (<p class=cm-variable-2>arguments</p>.<p class=cm-property>length</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>params</p>.<p class=cm-property>length</p>) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>TypeError</p>(<p class=cm-string>\"Wrong number of arguments\"</p>); } <p class=cm-keyword>let</p> <p class=cm-def>localScope</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-variable-2>scope</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>arguments</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-variable-2>localScope</p>[<p class=cm-variable-2>params</p>[<p class=cm-variable-2>i</p>]] <p class=cm-operator>=</p> <p class=cm-variable-2>arguments</p>[<p class=cm-variable-2>i</p>]; } <p class=cm-keyword>return</p> <p class=cm-variable>evaluate</p>(<p class=cm-variable-2>body</p>, <p class=cm-variable-2>localScope</p>);\n  };\n};</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_KsTEGYhZ+f class=p_ident id=p_KsTEGYhZ+f></a>Functions in Egg get their own local scope. The function produced by the <code>fun</code> form creates this local scope and adds the argument bindings to it. It then evaluates the function body in this scope and returns the result.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_tn5DChGAkA class=c_ident id=c_tn5DChGAkA></a><p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(plusOne, fun(a, +(a, 1))),</p> <p class=cm-string-2>print(plusOne(10)))</p>\n<p class=cm-string-2>`</p>); <p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(pow, fun(base, exp,</p> <p class=cm-string-2>if(==(exp, 0),</p> <p class=cm-string-2>1,</p> <p class=cm-string-2>*(base, pow(base, -(exp, 1)))))),</p> <p class=cm-string-2>print(pow(2, 10)))</p>\n<p class=cm-string-2>`</p>);\n</pre> <h2><a href=https://eloquentjavascript.net/12_language.html#h_qtdV3kKVQe class=h_ident id=h_qtdV3kKVQe></a>Compilation</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_JRcPOXDFEi class=p_ident id=p_JRcPOXDFEi></a>What we have built is an interpreter. During evaluation, it acts directly on the representation of the program produced by the parser.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_Lk17qNau8L class=p_ident id=p_Lk17qNau8L></a><em>Compilation</em> is the process of adding another step between the parsing and the running of a program, which transforms the program into something that can be evaluated more efficiently by doing as much work as possible in advance. For example, in well-designed languages it is obvious, for each use of a binding, which binding is being referred to, without actually running the program. This can be used to avoid looking up the binding by name every time it is accessed, instead directly fetching it from some predetermined memory location.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_HrQe0PuoCJ class=p_ident id=p_HrQe0PuoCJ></a>Traditionally, compilation involves converting the program to machine code, the raw format that a computer’s processor can execute. But any process that converts a program to a different representation can be thought of as compilation.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_+HfDnbf6cY class=p_ident id=p_+HfDnbf6cY></a>It would be possible to write an alternative evaluation strategy for Egg, one that first converts the program to a JavaScript program, uses <code>Function</code> to invoke the JavaScript compiler on it, and then runs the result. When done right, this would make Egg run very fast while still being quite simple to implement.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_bV8xBkdmzN class=p_ident id=p_bV8xBkdmzN></a>If you are interested in this topic and willing to spend some time on it, I encourage you to try to implement such a compiler as an exercise.</p> <h2><a href=https://eloquentjavascript.net/12_language.html#h_DmDK0dWdfE class=h_ident id=h_DmDK0dWdfE></a>Cheating</h2> <p><a href=https://eloquentjavascript.net/12_language.html#p_WFyw9AWF7D class=p_ident id=p_WFyw9AWF7D></a>When we defined <code>if</code> and <code>while</code>, you probably noticed that they were more or less trivial wrappers around JavaScript’s own <code>if</code> and <code>while</code>. Similarly, the values in Egg are just regular old JavaScript values.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_qMvm2xpt6o class=p_ident id=p_qMvm2xpt6o></a>If you compare the implementation of Egg, built on top of JavaScript, with the amount of work and complexity required to build a programming language directly on the raw functionality provided by a machine, the difference is huge. Regardless, this example ideally gave you an impression of the way programming languages work.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_xuQu2Hdpx2 class=p_ident id=p_xuQu2Hdpx2></a>And when it comes to getting something done, cheating is more effective than doing everything yourself. Though the toy language in this chapter doesn’t do anything that couldn’t be done better in JavaScript, there <em>are</em> situations where writing small languages helps get real work done.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_0TKyk5rWYK class=p_ident id=p_0TKyk5rWYK></a>Such a language does not have to resemble a typical programming language. If JavaScript didn’t come equipped with regular expressions, for example, you could write your own parser and evaluator for regular expressions.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_fdoy9duCSp class=p_ident id=p_fdoy9duCSp></a>Or imagine you are building a giant robotic dinosaur and need to program its behavior. JavaScript might not be the most effective way to do this. You might instead opt for a language that looks like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_831P/I2TjC class=c_ident id=c_831P/I2TjC></a>behavior walk\n  perform when\n    destination ahead\n  actions\n    move left-foot\n    move right-foot\n\nbehavior attack\n  perform when\n    Godzilla in-view\n  actions\n    fire laser-eyes\n    launch arm-rockets</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_O9+2Ve51P4 class=p_ident id=p_O9+2Ve51P4></a>This is what is usually called a <em>domain-specific language</em>, a language tailored to express a narrow domain of knowledge. Such a language can be more expressive than a general-purpose language because it is designed to describe exactly the things that need to be described in its domain, and nothing else.</p> <h2><a href=https://eloquentjavascript.net/12_language.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/12_language.html#i_uQzJv9I1Z6 class=i_ident id=i_uQzJv9I1Z6></a>Arrays</h3> <p><a href=https://eloquentjavascript.net/12_language.html#p_tNcRruOv4Q class=p_ident id=p_tNcRruOv4Q></a>Add support for arrays to Egg by adding the following three functions to the top scope: <code>array(...values)</code> to construct an array containing the argument values, <code>length(array)</code> to get an array’s length, and <code>element(array, n)</code> to fetch the n<sup>th</sup> element from an array.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_eB3J9xBy0h class=c_ident id=c_eB3J9xBy0h></a> <p class=cm-variable>topScope</p>.<p class=cm-property>array</p> <p class=cm-operator>=</p> <p class=cm-string>\"...\"</p>; <p class=cm-variable>topScope</p>.<p class=cm-property>length</p> <p class=cm-operator>=</p> <p class=cm-string>\"...\"</p>; <p class=cm-variable>topScope</p>.<p class=cm-property>element</p> <p class=cm-operator>=</p> <p class=cm-string>\"...\"</p>; <p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(sum, fun(array,</p> <p class=cm-string-2>do(define(i, 0),</p> <p class=cm-string-2>define(sum, 0),</p> <p class=cm-string-2>while(&lt;(i, length(array)),</p> <p class=cm-string-2>do(define(sum, +(sum, element(array, i))),</p> <p class=cm-string-2>define(i, +(i, 1)))),</p> <p class=cm-string-2>sum))),</p> <p class=cm-string-2>print(sum(array(1, 2, 3))))</p>\n<p class=cm-string-2>`</p>);\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/12_language.html#p_wvp5VE3wUs class=p_ident id=p_wvp5VE3wUs></a>The easiest way to do this is to represent Egg arrays with JavaScript arrays.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_pIQgd4yDJ0 class=p_ident id=p_pIQgd4yDJ0></a>The values added to the top scope must be functions. By using a rest argument (with triple-dot notation), the definition of <code>array</code> can be <em>very</em> simple.</p> </div></div> <h3><a href=https://eloquentjavascript.net/12_language.html#i_hOd+yVxaku class=i_ident id=i_hOd+yVxaku></a>Closure</h3> <p><a href=https://eloquentjavascript.net/12_language.html#p_v1H/2L3I5F class=p_ident id=p_v1H/2L3I5F></a>The way we have defined <code>fun</code> allows functions in Egg to reference the surrounding scope, allowing the function’s body to use local values that were visible at the time the function was defined, just like JavaScript functions do.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_CyqsFIcQdy class=p_ident id=p_CyqsFIcQdy></a>The following program illustrates this: function <code>f</code> returns a function that adds its argument to <code>f</code>’s argument, meaning that it needs access to the local scope inside <code>f</code> to be able to use binding <code>a</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_zJ2x7sbWRv class=c_ident id=c_zJ2x7sbWRv></a><p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(f, fun(a, fun(b, +(a, b)))),</p> <p class=cm-string-2>print(f(4)(5)))</p>\n<p class=cm-string-2>`</p>);\n</pre> <p><a href=https://eloquentjavascript.net/12_language.html#p_40Yj7LMkYl class=p_ident id=p_40Yj7LMkYl></a>Go back to the definition of the <code>fun</code> form and explain which mechanism causes this to work.</p> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/12_language.html#p_LOgpHZsyhJ class=p_ident id=p_LOgpHZsyhJ></a>Again, we are riding along on a JavaScript mechanism to get the equivalent feature in Egg. Special forms are passed the local scope in which they are evaluated so that they can evaluate their subforms in that scope. The function returned by <code>fun</code> has access to the <code>scope</code> argument given to its enclosing function and uses that to create the function’s local scope when it is called.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_w6RFAh/z4Z class=p_ident id=p_w6RFAh/z4Z></a>This means that the prototype of the local scope will be the scope in which the function was created, which makes it possible to access bindings in that scope from the function. This is all there is to implementing closure (though to compile it in a way that is actually efficient, you’d need to do some more work).</p> </div></div> <h3><a href=https://eloquentjavascript.net/12_language.html#i_/OBuIOX390 class=i_ident id=i_/OBuIOX390></a>Comments</h3> <p><a href=https://eloquentjavascript.net/12_language.html#p_qV4w3Ov/ee class=p_ident id=p_qV4w3Ov/ee></a>It would be nice if we could write comments in Egg. For example, whenever we find a hash sign (<code>#</code>), we could treat the rest of the line as a comment and ignore it, similar to <code>//</code> in JavaScript.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_EVGdU2vHLH class=p_ident id=p_EVGdU2vHLH></a>We do not have to make any big changes to the parser to support this. We can simply change <code>skipSpace</code> to skip comments as if they are whitespace so that all the points where <code>skipSpace</code> is called will now also skip comments. Make this change.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_HlvQkY82YH class=c_ident id=c_HlvQkY82YH></a>\n<p class=cm-keyword>function</p> <p class=cm-def>skipSpace</p>(<p class=cm-def>string</p>) { <p class=cm-keyword>let</p> <p class=cm-def>first</p> <p class=cm-operator>=</p> <p class=cm-variable-2>string</p>.<p class=cm-property>search</p>(<p class=cm-string-2>/\\S/</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>first</p> <p class=cm-operator>==</p> <p class=cm-operator>-</p><p class=cm-number>1</p>) <p class=cm-keyword>return</p> <p class=cm-string>\"\"</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>string</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>first</p>);\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>parse</p>(<p class=cm-string>\"# hello\\nx\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>parse</p>(<p class=cm-string>\"a # one\\n # two\\n()\"</p>));\n\n\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/12_language.html#p_Dds6GLJzwb class=p_ident id=p_Dds6GLJzwb></a>Make sure your solution handles multiple comments in a row, with potentially whitespace between or after them.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_w/PeZhCFV2 class=p_ident id=p_w/PeZhCFV2></a>A regular expression is probably the easiest way to solve this. Write something that matches “whitespace or a comment, zero or more times”. Use the <code>exec</code> or <code>match</code> method and look at the length of the first element in the returned array (the whole match) to find out how many characters to slice off.</p> </div></div> <h3><a href=https://eloquentjavascript.net/12_language.html#i_Y9ZDMshYCQ class=i_ident id=i_Y9ZDMshYCQ></a>Fixing scope</h3> <p><a href=https://eloquentjavascript.net/12_language.html#p_wiUendOwjA class=p_ident id=p_wiUendOwjA></a>Currently, the only way to assign a binding a value is <code>define</code>. This construct acts as a way both to define new bindings and to give existing ones a new value.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_O06fqfa6CU class=p_ident id=p_O06fqfa6CU></a>This ambiguity causes a problem. When you try to give a nonlocal binding a new value, you will end up defining a local one with the same name instead. Some languages work like this by design, but I’ve always found it an awkward way to handle scope.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_wG0OsCIoJb class=p_ident id=p_wG0OsCIoJb></a>Add a special form <code>set</code>, similar to <code>define</code>, which gives a binding a new value, updating the binding in an outer scope if it doesn’t already exist in the inner scope. If the binding is not defined at all, throw a <code>ReferenceError</code> (another standard error type).</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_vI0CMB91dl class=p_ident id=p_vI0CMB91dl></a>The technique of representing scopes as simple objects, which has made things convenient so far, will get in your way a little at this point. You might want to use the <code>Object.<wbr>getPrototypeOf</code> function, which returns the prototype of an object. Also remember that scopes do not derive from <code>Object.prototype</code>, so if you want to call <code>hasOwnProperty</code> on them, you have to use this clumsy expression:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_uQ8XmGT/j0 class=c_ident id=c_uQ8XmGT/j0></a><p class=cm-variable>Object</p>.<p class=cm-property>prototype</p>.<p class=cm-property>hasOwnProperty</p>.<p class=cm-property>call</p>(<p class=cm-variable>scope</p>, <p class=cm-variable>name</p>);</pre> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/12_language.html#c_A8iULt4bk6 class=c_ident id=c_A8iULt4bk6></a><p class=cm-variable>specialForms</p>.<p class=cm-property>set</p> <p class=cm-operator>=</p> (<p class=cm-def>args</p>, <p class=cm-def>scope</p>) <p class=cm-operator>=&gt;</p> { }; <p class=cm-variable>run</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>do(define(x, 4),</p> <p class=cm-string-2>define(setx, fun(val, set(x, val))),</p> <p class=cm-string-2>setx(50),</p> <p class=cm-string-2>print(x))</p>\n<p class=cm-string-2>`</p>); <p class=cm-variable>run</p>(<p class=cm-string-2>`set(quux, true)`</p>);\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/12_language.html#p_NhXhfFLedb class=p_ident id=p_NhXhfFLedb></a>You will have to loop through one scope at a time, using <code>Object.<wbr>getPrototypeOf</code> to go to the next outer scope. For each scope, use <code>hasOwnProperty</code> to find out whether the binding, indicated by the <code>name</code> property of the first argument to <code>set</code>, exists in that scope. If it does, set it to the result of evaluating the second argument to <code>set</code> and then return that value.</p> <p><a href=https://eloquentjavascript.net/12_language.html#p_vdMHRjshzJ class=p_ident id=p_vdMHRjshzJ></a>If the outermost scope is reached (<code>Object.<wbr>getPrototypeOf</code> returns null) and we haven’t found the binding yet, it doesn’t exist, and an error should be thrown.</p> </div></div><nav><a href=https://eloquentjavascript.net/11_async.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/13_browser.html>▶</a></nav>\n</article><hr><h4>Page 9</h4><article score=1020.8150000000003>\n<nav><a href=https://eloquentjavascript.net/08_error.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/10_modules.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_MWUwIAb0uO class=p_ident id=p_MWUwIAb0uO></a>Some people, when confronted with a problem, think ‘I know, I’ll use regular expressions.’ Now they have two problems.</p> <footer>Jamie Zawinski</footer> </blockquote> <blockquote> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_icxlw7+18l class=p_ident id=p_icxlw7+18l></a>Yuan-Ma said, ‘When you cut against the grain of the wood, much strength is needed. When you program against the grain of the problem, much code is needed.’</p> <footer>Master Yuan-Ma, <cite>The Book of Programming</cite></footer> </blockquote><figure class=\"chapter square-framed\"><img alt=\"A railroad diagram\" src=https://eloquentjavascript.net/img/chapter_picture_9.jpg></figure> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_mYvGNMWwx9 class=p_ident id=p_mYvGNMWwx9></a>Programming tools and techniques survive and spread in a chaotic, evolutionary way. It’s not always the pretty or brilliant ones that win but rather the ones that function well enough within the right niche or that happen to be integrated with another successful piece of technology.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_iH3Aqi6y2A class=p_ident id=p_iH3Aqi6y2A></a>In this chapter, I will discuss one such tool, <em>regular expressions</em>. Regular expressions are a way to describe patterns in string data. They form a small, separate language that is part of JavaScript and many other languages and systems.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_cxbejyPUGl class=p_ident id=p_cxbejyPUGl></a>Regular expressions are both terribly awkward and extremely useful. Their syntax is cryptic, and the programming interface JavaScript provides for them is clumsy. But they are a powerful tool for inspecting and processing strings. Properly understanding regular expressions will make you a more effective programmer.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_5w4yGFJRYl class=h_ident id=h_5w4yGFJRYl></a>Creating a regular expression</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_u/9SKAI2Yi class=p_ident id=p_u/9SKAI2Yi></a>A regular expression is a type of object. It can be either constructed with the <code>RegExp</code> constructor or written as a literal value by enclosing a pattern in forward slash (<code>/</code>) characters.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_O1I2rl+HTy class=c_ident id=c_O1I2rl+HTy></a><p class=cm-keyword>let</p> <p class=cm-def>re1</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>RegExp</p>(<p class=cm-string>\"abc\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>re2</p> <p class=cm-operator>=</p> <p class=cm-string-2>/abc/</p>;</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_dviEva2QQM class=p_ident id=p_dviEva2QQM></a>Both of those regular expression objects represent the same pattern: an <em>a</em> character followed by a <em>b</em> followed by a <em>c</em>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_qv8UWLVrTv class=p_ident id=p_qv8UWLVrTv></a>When using the <code>RegExp</code> constructor, the pattern is written as a normal string, so the usual rules apply for backslashes.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_0mNIcPpslS class=p_ident id=p_0mNIcPpslS></a>The second notation, where the pattern appears between slash characters, treats backslashes somewhat differently. First, since a forward slash ends the pattern, we need to put a backslash before any forward slash that we want to be <em>part</em> of the pattern. In addition, backslashes that aren’t part of special character codes (like <code>\\n</code>) will be <em>preserved</em>, rather than ignored as they are in strings, and change the meaning of the pattern. Some characters, such as question marks and plus signs, have special meanings in regular expressions and must be preceded by a backslash if they are meant to represent the character itself.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_uRzUiBSrul class=c_ident id=c_uRzUiBSrul></a><p class=cm-keyword>let</p> <p class=cm-def>eighteenPlus</p> <p class=cm-operator>=</p> <p class=cm-string-2>/eighteen\\+/</p>;</pre> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_vPyyYjMEtz class=h_ident id=h_vPyyYjMEtz></a>Testing for matches</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_SHaMWlzFzk class=p_ident id=p_SHaMWlzFzk></a>Regular expression objects have a number of methods. The simplest one is <code>test</code>. If you pass it a string, it will return a Boolean telling you whether the string contains a match of the pattern in the expression.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_Szn1CmrIV5 class=c_ident id=c_Szn1CmrIV5></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/abc/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"abcde\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/abc/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"abxde\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_YGcbMDV493 class=p_ident id=p_YGcbMDV493></a>A regular expression consisting of only nonspecial characters simply represents that sequence of characters. If <em>abc</em> occurs anywhere in the string we are testing against (not just at the start), <code>test</code> will return <code>true</code>.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_8EFR0DU1xd class=h_ident id=h_8EFR0DU1xd></a>Sets of characters</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ZyB7HeLr75 class=p_ident id=p_ZyB7HeLr75></a>Finding out whether a string contains <em>abc</em> could just as well be done with a call to <code>indexOf</code>. Regular expressions allow us to express more complicated patterns.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_i/99SEfu9y class=p_ident id=p_i/99SEfu9y></a>Say we want to match any number. In a regular expression, putting a set of characters between square brackets makes that part of the expression match any of the characters between the brackets.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_sC+2E08KnL class=p_ident id=p_sC+2E08KnL></a>Both of the following expressions match all strings that contain a digit:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_Z3UJdL//cY class=c_ident id=c_Z3UJdL//cY></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/[0123456789]/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"in 1992\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/[0-9]/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"in 1992\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_i0WYLVUede class=p_ident id=p_i0WYLVUede></a>Within square brackets, a hyphen (<code>-</code>) between two characters can be used to indicate a range of characters, where the ordering is determined by the character’s Unicode number. Characters 0 to 9 sit right next to each other in this ordering (codes 48 to 57), so <code>[0-9]</code> covers all of them and matches any digit.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_1qtYlDfA/1 class=p_ident id=p_1qtYlDfA/1></a>A number of common character groups have their own built-in shortcuts. Digits are one of them: <code>\\d</code> means the same thing as <code>[0-9]</code>.</p> <table> <tbody><tr><td><code>\\d</code></td><td>Any digit character</td> </tr> <tr><td><code>\\w</code></td><td>An alphanumeric character (“word character”)</td> </tr> <tr><td><code>\\s</code></td><td>Any whitespace character (space, tab, newline, and similar)</td> </tr> <tr><td><code>\\D</code></td><td>A character that is <em>not</em> a digit</td> </tr> <tr><td><code>\\W</code></td><td>A nonalphanumeric character</td> </tr> <tr><td><code>\\S</code></td><td>A nonwhitespace character</td> </tr> <tr><td><code>.</code></td><td>Any character except for newline</td> </tr> </tbody></table> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_yXMUKEYpwG class=p_ident id=p_yXMUKEYpwG></a>So you could match a date and time format like 01-30-2003 15:20 with the following expression:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_Y0e7M8nAL0 class=c_ident id=c_Y0e7M8nAL0></a><p class=cm-keyword>let</p> <p class=cm-def>dateTime</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\d\\d-\\d\\d-\\d\\d\\d\\d \\d\\d:\\d\\d/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dateTime</p>.<p class=cm-property>test</p>(<p class=cm-string>\"01-30-2003 15:20\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dateTime</p>.<p class=cm-property>test</p>(<p class=cm-string>\"30-jan-2003 15:20\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_gdY0EhLXlE class=p_ident id=p_gdY0EhLXlE></a>That looks completely awful, doesn’t it? Half of it is backslashes, producing a background noise that makes it hard to spot the actual pattern expressed. We’ll see a slightly improved version of this expression <a href=https://eloquentjavascript.net/09_regexp.html#date_regexp_counted>later</a>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_P0qAMYu0C/ class=p_ident id=p_P0qAMYu0C/ ></a>These backslash codes can also be used inside square brackets. For example, <code>[\\d.]</code> means any digit or a period character. But the period itself, between square brackets, loses its special meaning. The same goes for other special characters, such as <code>+</code>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_HqQEZsitdl class=p_ident id=p_HqQEZsitdl></a>To <em>invert</em> a set of characters—that is, to express that you want to match any character <em>except</em> the ones in the set—you can write a caret (<code>^</code>) character after the opening bracket.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_XH8deAcckk class=c_ident id=c_XH8deAcckk></a><p class=cm-keyword>let</p> <p class=cm-def>notBinary</p> <p class=cm-operator>=</p> <p class=cm-string-2>/[^01]/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>notBinary</p>.<p class=cm-property>test</p>(<p class=cm-string>\"1100100010100110\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>notBinary</p>.<p class=cm-property>test</p>(<p class=cm-string>\"1100100010200110\"</p>));\n</pre> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_iFI1qvUwY9 class=h_ident id=h_iFI1qvUwY9></a>Repeating parts of a pattern</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_crYiu/oAUM class=p_ident id=p_crYiu/oAUM></a>We now know how to match a single digit. What if we want to match a whole number—a sequence of one or more digits?</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_B4wupHzbR+ class=p_ident id=p_B4wupHzbR+></a>When you put a plus sign (<code>+</code>) after something in a regular expression, it indicates that the element may be repeated more than once. Thus, <code>/\\d+/</code> matches one or more digit characters.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_9/5mFF4Ih4 class=c_ident id=c_9/5mFF4Ih4></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/'\\d+'/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"'123'\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/'\\d+'/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"''\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/'\\d*'/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"'123'\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/'\\d*'/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"''\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_/oNBIVm41F class=p_ident id=p_/oNBIVm41F></a>The star (<code>*</code>) has a similar meaning but also allows the pattern to match zero times. Something with a star after it never prevents a pattern from matching—it’ll just match zero instances if it can’t find any suitable text to match.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_77Y5t9C8NV class=p_ident id=p_77Y5t9C8NV></a>A question mark makes a part of a pattern <em>optional</em>, meaning it may occur zero times or one time. In the following example, the <em>u</em> character is allowed to occur, but the pattern also matches when it is missing.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_EiCIowdq+d class=c_ident id=c_EiCIowdq+d></a><p class=cm-keyword>let</p> <p class=cm-def>neighbor</p> <p class=cm-operator>=</p> <p class=cm-string-2>/neighbou?r/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>neighbor</p>.<p class=cm-property>test</p>(<p class=cm-string>\"neighbour\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>neighbor</p>.<p class=cm-property>test</p>(<p class=cm-string>\"neighbor\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_B4ikd8xN8i class=p_ident id=p_B4ikd8xN8i></a>To indicate that a pattern should occur a precise number of times, use braces. Putting <code>{4}</code> after an element, for example, requires it to occur exactly four times. It is also possible to specify a range this way: <code>{2,4}</code> means the element must occur at least twice and at most four times.</p> <p id=date_regexp_counted><a href=https://eloquentjavascript.net/09_regexp.html#p_a1yNHuI+49 class=p_ident id=p_a1yNHuI+49></a>Here is another version of the date and time pattern that allows both single- and double-digit days, months, and hours. It is also slightly easier to decipher.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_Tw+K6Mxe45 class=c_ident id=c_Tw+K6Mxe45></a><p class=cm-keyword>let</p> <p class=cm-def>dateTime</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\d{1,2}-\\d{1,2}-\\d{4} \\d{1,2}:\\d{2}/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>dateTime</p>.<p class=cm-property>test</p>(<p class=cm-string>\"1-30-2003 8:45\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_RjqN6VMQIa class=p_ident id=p_RjqN6VMQIa></a>You can also specify open-ended ranges when using braces by omitting the number after the comma. So, <code>{5,}</code> means five or more times.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_uICSDspz1I class=h_ident id=h_uICSDspz1I></a>Grouping subexpressions</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_pKTOYUDGIr class=p_ident id=p_pKTOYUDGIr></a>To use an operator like <code>*</code> or <code>+</code> on more than one element at a time, you have to use parentheses. A part of a regular expression that is enclosed in parentheses counts as a single element as far as the operators following it are concerned.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_P/f6a65XwI class=c_ident id=c_P/f6a65XwI></a><p class=cm-keyword>let</p> <p class=cm-def>cartoonCrying</p> <p class=cm-operator>=</p> <p class=cm-string-2>/boo+(hoo+)+/i</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>cartoonCrying</p>.<p class=cm-property>test</p>(<p class=cm-string>\"Boohoooohoohooo\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_S5jkv2dMC+ class=p_ident id=p_S5jkv2dMC+></a>The first and second <code>+</code> characters apply only to the second <em>o</em> in <em>boo</em> and <em>hoo</em>, respectively. The third <code>+</code> applies to the whole group <code>(hoo+)</code>, matching one or more sequences like that.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_c4RlIM4/HI class=p_ident id=p_c4RlIM4/HI></a>The <code>i</code> at the end of the expression in the example makes this regular expression case insensitive, allowing it to match the uppercase <em>B</em> in the input string, even though the pattern is itself all lowercase.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_CV5XL/TADP class=h_ident id=h_CV5XL/TADP></a>Matches and groups</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_K3KRDzatsp class=p_ident id=p_K3KRDzatsp></a>The <code>test</code> method is the absolute simplest way to match a regular expression. It tells you only whether it matched and nothing else. Regular expressions also have an <code>exec</code> (execute) method that will return <code>null</code> if no match was found and return an object with information about the match otherwise.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_JJMWZpk0iD class=c_ident id=c_JJMWZpk0iD></a><p class=cm-keyword>let</p> <p class=cm-def>match</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\d+/</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"one two 100\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>match</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>match</p>.<p class=cm-property>index</p>);\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_fJSwbQyG6w class=p_ident id=p_fJSwbQyG6w></a>An object returned from <code>exec</code> has an <code>index</code> property that tells us <em>where</em> in the string the successful match begins. Other than that, the object looks like (and in fact is) an array of strings, whose first element is the string that was matched. In the previous example, this is the sequence of digits that we were looking for.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_VT4fpht7D7 class=p_ident id=p_VT4fpht7D7></a>String values have a <code>match</code> method that behaves similarly.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_uAkAqNYx+q class=c_ident id=c_uAkAqNYx+q></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"one two 100\"</p>.<p class=cm-property>match</p>(<p class=cm-string-2>/\\d+/</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_/9rdcJO9zZ class=p_ident id=p_/9rdcJO9zZ></a>When the regular expression contains subexpressions grouped with parentheses, the text that matched those groups will also show up in the array. The whole match is always the first element. The next element is the part matched by the first group (the one whose opening parenthesis comes first in the expression), then the second group, and so on.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_5E2M1BBsUm class=c_ident id=c_5E2M1BBsUm></a><p class=cm-keyword>let</p> <p class=cm-def>quotedText</p> <p class=cm-operator>=</p> <p class=cm-string-2>/'([^']*)'/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>quotedText</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"she said 'hello'\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_f4bciMASJ1 class=p_ident id=p_f4bciMASJ1></a>When a group does not end up being matched at all (for example, when followed by a question mark), its position in the output array will hold <code>undefined</code>. Similarly, when a group is matched multiple times, only the last match ends up in the array.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_j9t+gn+1eT class=c_ident id=c_j9t+gn+1eT></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/bad(ly)?/</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"bad\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/(\\d)+/</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"123\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_GvLofvnQnz class=p_ident id=p_GvLofvnQnz></a>Groups can be useful for extracting parts of a string. If we don’t just want to verify whether a string contains a date but also extract it and construct an object that represents it, we can wrap parentheses around the digit patterns and directly pick the date out of the result of <code>exec</code>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_DzNUSBaBZb class=p_ident id=p_DzNUSBaBZb></a>But first we’ll take a brief detour, in which we discuss the built-in way to represent date and time values in JavaScript.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_8U7L7LCU27 class=h_ident id=h_8U7L7LCU27></a>The Date class</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_2NeTRvucQq class=p_ident id=p_2NeTRvucQq></a>JavaScript has a standard class for representing dates—or, rather, points in time. It is called <code>Date</code>. If you simply create a date object using <code>new</code>, you get the current date and time.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_AjgqFetryg class=c_ident id=c_AjgqFetryg></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>());\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_IcV7kv3B1y class=p_ident id=p_IcV7kv3B1y></a>You can also create an object for a specific time.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_2VCU0f4HsQ class=c_ident id=c_2VCU0f4HsQ></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-number>2009</p>, <p class=cm-number>11</p>, <p class=cm-number>9</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-number>2009</p>, <p class=cm-number>11</p>, <p class=cm-number>9</p>, <p class=cm-number>12</p>, <p class=cm-number>59</p>, <p class=cm-number>59</p>, <p class=cm-number>999</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_cYaexzwHiw class=p_ident id=p_cYaexzwHiw></a>JavaScript uses a convention where month numbers start at zero (so December is 11), yet day numbers start at one. This is confusing and silly. Be careful.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_gVdQSb0Lv9 class=p_ident id=p_gVdQSb0Lv9></a>The last four arguments (hours, minutes, seconds, and milliseconds) are optional and taken to be zero when not given.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_1mIMU5T5MA class=p_ident id=p_1mIMU5T5MA></a>Timestamps are stored as the number of milliseconds since the start of 1970, in the UTC time zone. This follows a convention set by “Unix time”, which was invented around that time. You can use negative numbers for times before 1970. The <code>getTime</code> method on a date object returns this number. It is big, as you can imagine.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_lMlCuckMIc class=c_ident id=c_lMlCuckMIc></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-number>2013</p>, <p class=cm-number>11</p>, <p class=cm-number>19</p>).<p class=cm-property>getTime</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-number>1387407600000</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Cn9WUyCZhq class=p_ident id=p_Cn9WUyCZhq></a>If you give the <code>Date</code> constructor a single argument, that argument is treated as such a millisecond count. You can get the current millisecond count by creating a new <code>Date</code> object and calling <code>getTime</code> on it or by calling the <code>Date.now</code> function.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_iqL2Ehg9D4 class=p_ident id=p_iqL2Ehg9D4></a>Date objects provide methods such as <code>getFullYear</code>, <code>getMonth</code>, <code>getDate</code>, <code>getHours</code>, <code>getMinutes</code>, and <code>getSeconds</code> to extract their components. Besides <code>getFullYear</code> there’s also <code>getYear</code>, which gives you the year minus 1900 (<code>98</code> or <code>119</code>) and is mostly useless.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_/RCtQyD3w/ class=p_ident id=p_/RCtQyD3w/ ></a>Putting parentheses around the parts of the expression that we are interested in, we can now create a date object from a string.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_xW0xfMnpiZ class=c_ident id=c_xW0xfMnpiZ></a><p class=cm-keyword>function</p> <p class=cm-def>getDate</p>(<p class=cm-def>string</p>) { <p class=cm-keyword>let</p> [<p class=cm-def>_</p>, <p class=cm-def>month</p>, <p class=cm-def>day</p>, <p class=cm-def>year</p>] <p class=cm-operator>=</p> <p class=cm-string-2>/(\\d{1,2})-(\\d{1,2})-(\\d{4})/</p>.<p class=cm-property>exec</p>(<p class=cm-variable-2>string</p>); <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Date</p>(<p class=cm-variable-2>year</p>, <p class=cm-variable-2>month</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>, <p class=cm-variable-2>day</p>);\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>getDate</p>(<p class=cm-string>\"1-30-2003\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_YUOJEGEtSI class=p_ident id=p_YUOJEGEtSI></a>The <code>_</code> (underscore) binding is ignored and used only to skip the full match element in the array returned by <code>exec</code>.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_26ixny78VY class=h_ident id=h_26ixny78VY></a>Word and string boundaries</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_xdYJVr9vlf class=p_ident id=p_xdYJVr9vlf></a>Unfortunately, <code>getDate</code> will also happily extract the nonsensical date 00-1-3000 from the string <code>\"100-1-30000\"</code>. A match may happen anywhere in the string, so in this case, it’ll just start at the second character and end at the second-to-last character.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_kLS7rqRrqG class=p_ident id=p_kLS7rqRrqG></a>If we want to enforce that the match must span the whole string, we can add the markers <code>^</code> and <code>$</code>. The caret matches the start of the input string, whereas the dollar sign matches the end. So, <code>/^\\d+$/</code> matches a string consisting entirely of one or more digits, <code>/^!/</code> matches any string that starts with an exclamation mark, and <code>/x^/</code> does not match any string (there cannot be an <em>x</em> before the start of the string).</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_fEYS5Ev94W class=p_ident id=p_fEYS5Ev94W></a>If, on the other hand, we just want to make sure the date starts and ends on a word boundary, we can use the marker <code>\\b</code>. A word boundary can be the start or end of the string or any point in the string that has a word character (as in <code>\\w</code>) on one side and a nonword character on the other.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_6U0b866tUk class=c_ident id=c_6U0b866tUk></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/cat/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"concatenate\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/\\bcat\\b/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"concatenate\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_btxd6luedx class=p_ident id=p_btxd6luedx></a>Note that a boundary marker doesn’t match an actual character. It just enforces that the regular expression matches only when a certain condition holds at the place where it appears in the pattern.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_In3b+t6uOO class=h_ident id=h_In3b+t6uOO></a>Choice patterns</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_G5RTt0AFku class=p_ident id=p_G5RTt0AFku></a>Say we want to know whether a piece of text contains not only a number but a number followed by one of the words <em>pig</em>, <em>cow</em>, or <em>chicken</em>, or any of their plural forms.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_GcEbQJT+nS class=p_ident id=p_GcEbQJT+nS></a>We could write three regular expressions and test them in turn, but there is a nicer way. The pipe character (<code>|</code>) denotes a choice between the pattern to its left and the pattern to its right. So I can say this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_z0soEIN8RB class=c_ident id=c_z0soEIN8RB></a><p class=cm-keyword>let</p> <p class=cm-def>animalCount</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\b\\d+ (pig|cow|chicken)s?\\b/</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>animalCount</p>.<p class=cm-property>test</p>(<p class=cm-string>\"15 pigs\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>animalCount</p>.<p class=cm-property>test</p>(<p class=cm-string>\"15 pigchickens\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_bPWKulKcxf class=p_ident id=p_bPWKulKcxf></a>Parentheses can be used to limit the part of the pattern that the pipe operator applies to, and you can put multiple such operators next to each other to express a choice between more than two alternatives.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_AzxCBCKdvY class=h_ident id=h_AzxCBCKdvY></a>The mechanics of matching</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_SXQOi9ZwwH class=p_ident id=p_SXQOi9ZwwH></a>Conceptually, when you use <code>exec</code> or <code>test</code>, the regular expression engine looks for a match in your string by trying to match the expression first from the start of the string, then from the second character, and so on, until it finds a match or reaches the end of the string. It’ll either return the first match that can be found or fail to find any match at all.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_HJjJAo8dQp class=p_ident id=p_HJjJAo8dQp></a>To do the actual matching, the engine treats a regular expression something like a flow diagram. This is the diagram for the livestock expression in the previous example:</p><figure><img alt=\"Visualization of /\\b\\d+ (pig|cow|chicken)s?\\b/\" src=https://eloquentjavascript.net/img/re_pigchickens.svg></figure> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_SNiUdMyezk class=p_ident id=p_SNiUdMyezk></a>Our expression matches if we can find a path from the left side of the diagram to the right side. We keep a current position in the string, and every time we move through a box, we verify that the part of the string after our current position matches that box.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_MB99a8uIlE class=p_ident id=p_MB99a8uIlE></a>So if we try to match <code>\"the 3 pigs\"</code> from position 4, our progress through the flow chart would look like this:</p> <ul> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_bgxoerTVW4 class=p_ident id=p_bgxoerTVW4></a>At position 4, there is a word boundary, so we can move past the first box.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_YCV1/H+Rbe class=p_ident id=p_YCV1/H+Rbe></a>Still at position 4, we find a digit, so we can also move past the second box.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_fQdWHxKgCF class=p_ident id=p_fQdWHxKgCF></a>At position 5, one path loops back to before the second (digit) box, while the other moves forward through the box that holds a single space character. There is a space here, not a digit, so we must take the second path.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_KItk5iNp9m class=p_ident id=p_KItk5iNp9m></a>We are now at position 6 (the start of <em>pigs</em>) and at the three-way branch in the diagram. We don’t see <em>cow</em> or <em>chicken</em> here, but we do see <em>pig</em>, so we take that branch.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_SowlGZC6lM class=p_ident id=p_SowlGZC6lM></a>At position 9, after the three-way branch, one path skips the <em>s</em> box and goes straight to the final word boundary, while the other path matches an <em>s</em>. There is an <em>s</em> character here, not a word boundary, so we go through the <em>s</em> box.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_oJRMcnDoAt class=p_ident id=p_oJRMcnDoAt></a>We’re at position 10 (the end of the string) and can match only a word boundary. The end of a string counts as a word boundary, so we go through the last box and have successfully matched this string.</p></li></ul> <h2 id=backtracking><a href=https://eloquentjavascript.net/09_regexp.html#h_NFMtGK0tD3 class=h_ident id=h_NFMtGK0tD3></a>Backtracking</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_tCd15MFAty class=p_ident id=p_tCd15MFAty></a>The regular expression <code>/<wbr>\\b([01]+b|[\\da-f]+h|\\d+)\\b/<wbr></code> matches either a binary number followed by a <em>b</em>, a hexadecimal number (that is, base 16, with the letters <em>a</em> to <em>f</em> standing for the digits 10 to 15) followed by an <em>h</em>, or a regular decimal number with no suffix character. This is the corresponding diagram:</p><figure><img alt=\"Visualization of /\\b([01]+b|\\d+|[\\da-f]+h)\\b/\" src=https://eloquentjavascript.net/img/re_number.svg></figure> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_MypvfTaiTG class=p_ident id=p_MypvfTaiTG></a>When matching this expression, it will often happen that the top (binary) branch is entered even though the input does not actually contain a binary number. When matching the string <code>\"103\"</code>, for example, it becomes clear only at the 3 that we are in the wrong branch. The string <em>does</em> match the expression, just not the branch we are currently in.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_SjTCKE9hvf class=p_ident id=p_SjTCKE9hvf></a>So the matcher <em>backtracks</em>. When entering a branch, it remembers its current position (in this case, at the start of the string, just past the first boundary box in the diagram) so that it can go back and try another branch if the current one does not work out. For the string <code>\"103\"</code>, after encountering the 3 character, it will start trying the branch for hexadecimal numbers, which fails again because there is no <em>h</em> after the number. So it tries the decimal number branch. This one fits, and a match is reported after all.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_VymH7raTcU class=p_ident id=p_VymH7raTcU></a>The matcher stops as soon as it finds a full match. This means that if multiple branches could potentially match a string, only the first one (ordered by where the branches appear in the regular expression) is used.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_zEBIV8lYeb class=p_ident id=p_zEBIV8lYeb></a>Backtracking also happens for repetition operators like + and <code>*</code>. If you match <code>/^.*x/</code> against <code>\"abcxe\"</code>, the <code>.*</code> part will first try to consume the whole string. The engine will then realize that it needs an <em>x</em> to match the pattern. Since there is no <em>x</em> past the end of the string, the star operator tries to match one character less. But the matcher doesn’t find an <em>x</em> after <code>abcx</code> either, so it backtracks again, matching the star operator to just <code>abc</code>. <em>Now</em> it finds an <em>x</em> where it needs it and reports a successful match from positions 0 to 4.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_0MBBMH8aI2 class=p_ident id=p_0MBBMH8aI2></a>It is possible to write regular expressions that will do a <em>lot</em> of backtracking. This problem occurs when a pattern can match a piece of input in many different ways. For example, if we get confused while writing a binary-number regular expression, we might accidentally write something like <code>/([01]+)+b/</code>.</p><figure><img alt=\"Visualization of /([01]+)+b/\" src=https://eloquentjavascript.net/img/re_slow.svg></figure> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_5cI0Ma3Wy8 class=p_ident id=p_5cI0Ma3Wy8></a>If that tries to match some long series of zeros and ones with no trailing <em>b</em> character, the matcher first goes through the inner loop until it runs out of digits. Then it notices there is no <em>b</em>, so it backtracks one position, goes through the outer loop once, and gives up again, trying to backtrack out of the inner loop once more. It will continue to try every possible route through these two loops. This means the amount of work <em>doubles</em> with each additional character. For even just a few dozen characters, the resulting match will take practically forever.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_k0YuTOu54D class=h_ident id=h_k0YuTOu54D></a>The replace method</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_HMQv5qrs78 class=p_ident id=p_HMQv5qrs78></a>String values have a <code>replace</code> method that can be used to replace part of the string with another string.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_dPdIdK/Wyi class=c_ident id=c_dPdIdK/Wyi></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"papa\"</p>.<p class=cm-property>replace</p>(<p class=cm-string>\"p\"</p>, <p class=cm-string>\"m\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_jjBKX9l81o class=p_ident id=p_jjBKX9l81o></a>The first argument can also be a regular expression, in which case the first match of the regular expression is replaced. When a <code>g</code> option (for <em>global</em>) is added to the regular expression, <em>all</em> matches in the string will be replaced, not just the first.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_ztGnSKyKy1 class=c_ident id=c_ztGnSKyKy1></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Borobudur\"</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/[ou]/</p>, <p class=cm-string>\"a\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Borobudur\"</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/[ou]/g</p>, <p class=cm-string>\"a\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_BTzyExrWv3 class=p_ident id=p_BTzyExrWv3></a>It would have been sensible if the choice between replacing one match or all matches was made through an additional argument to <code>replace</code> or by providing a different method, <code>replaceAll</code>. But for some unfortunate reason, the choice relies on a property of the regular expression instead.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_/5YU/Qo2Np class=p_ident id=p_/5YU/Qo2Np></a>The real power of using regular expressions with <code>replace</code> comes from the fact that we can refer to matched groups in the replacement string. For example, say we have a big string containing the names of people, one name per line, in the format <code>Lastname, Firstname</code>. If we want to swap these names and remove the comma to get a <code>Firstname Lastname</code> format, we can use the following code:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_5P5aZAbVLL class=c_ident id=c_5P5aZAbVLL></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>( <p class=cm-string>\"Liskov, Barbara\\nMcCarthy, John\\nWadler, Philip\"</p> .<p class=cm-property>replace</p>(<p class=cm-string-2>/(\\w+), (\\w+)/g</p>, <p class=cm-string>\"$2 $1\"</p>));\n\n\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_sEudLRqyzC class=p_ident id=p_sEudLRqyzC></a>The <code>$1</code> and <code>$2</code> in the replacement string refer to the parenthesized groups in the pattern. <code>$1</code> is replaced by the text that matched against the first group, <code>$2</code> by the second, and so on, up to <code>$9</code>. The whole match can be referred to with <code>$&amp;</code>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_BpgnqwKFHn class=p_ident id=p_BpgnqwKFHn></a>It is possible to pass a function—rather than a string—as the second argument to <code>replace</code>. For each replacement, the function will be called with the matched groups (as well as the whole match) as arguments, and its return value will be inserted into the new string.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_GbNoBizUD+ class=p_ident id=p_GbNoBizUD+></a>Here’s a small example:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_fwgl3+oeyX class=c_ident id=c_fwgl3+oeyX></a><p class=cm-keyword>let</p> <p class=cm-def>s</p> <p class=cm-operator>=</p> <p class=cm-string>\"the cia and fbi\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>s</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/\\b(fbi|cia)\\b/g</p>, <p class=cm-def>str</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>str</p>.<p class=cm-property>toUpperCase</p>()));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_EXxvdgdiP1 class=p_ident id=p_EXxvdgdiP1></a>Here’s a more interesting one:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_Zo/y2Vv93l class=c_ident id=c_Zo/y2Vv93l></a><p class=cm-keyword>let</p> <p class=cm-def>stock</p> <p class=cm-operator>=</p> <p class=cm-string>\"1 lemon, 2 cabbages, and 101 eggs\"</p>;\n<p class=cm-keyword>function</p> <p class=cm-def>minusOne</p>(<p class=cm-def>match</p>, <p class=cm-def>amount</p>, <p class=cm-def>unit</p>) { <p class=cm-variable-2>amount</p> <p class=cm-operator>=</p> <p class=cm-variable>Number</p>(<p class=cm-variable-2>amount</p>) <p class=cm-operator>-</p> <p class=cm-number>1</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>amount</p> <p class=cm-operator>==</p> <p class=cm-number>1</p>) { <p class=cm-variable-2>unit</p> <p class=cm-operator>=</p> <p class=cm-variable-2>unit</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>unit</p>.<p class=cm-property>length</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>amount</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>amount</p> <p class=cm-operator>=</p> <p class=cm-string>\"no\"</p>; } <p class=cm-keyword>return</p> <p class=cm-variable-2>amount</p> <p class=cm-operator>+</p> <p class=cm-string>\" \"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>unit</p>;\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stock</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/(\\d+) (\\w+)/g</p>, <p class=cm-variable>minusOne</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_bv4e/DVilz class=p_ident id=p_bv4e/DVilz></a>This takes a string, finds all occurrences of a number followed by an alphanumeric word, and returns a string wherein every such occurrence is decremented by one.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_H94SX/MJX8 class=p_ident id=p_H94SX/MJX8></a>The <code>(\\d+)</code> group ends up as the <code>amount</code> argument to the function, and the <code>(\\w+)</code> group gets bound to <code>unit</code>. The function converts <code>amount</code> to a number—which always works since it matched <code>\\d+</code>—and makes some adjustments in case there is only one or zero left.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_kiECehz+i+ class=h_ident id=h_kiECehz+i+></a>Greed</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_VccKwuX/1m class=p_ident id=p_VccKwuX/1m></a>It is possible to use <code>replace</code> to write a function that removes all comments from a piece of JavaScript code. Here is a first attempt:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_u0oKSJTOA2 class=c_ident id=c_u0oKSJTOA2></a><p class=cm-keyword>function</p> <p class=cm-def>stripComments</p>(<p class=cm-def>code</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>code</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/\\/\\/.*|\\/\\*[^]*\\*\\//g</p>, <p class=cm-string>\"\"</p>);\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stripComments</p>(<p class=cm-string>\"1 + /* 2 */3\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stripComments</p>(<p class=cm-string>\"x = 10;// ten!\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stripComments</p>(<p class=cm-string>\"1 /* a */+/* b */ 1\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_DkzBCJQQdu class=p_ident id=p_DkzBCJQQdu></a>The part before the <em>or</em> operator matches two slash characters followed by any number of non-newline characters. The part for multiline comments is more involved. We use <code>[^]</code> (any character that is not in the empty set of characters) as a way to match any character. We cannot just use a period here because block comments can continue on a new line, and the period character does not match newline characters.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_s9E9JYjAYp class=p_ident id=p_s9E9JYjAYp></a>But the output for the last line appears to have gone wrong. Why?</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_atS1ERkauC class=p_ident id=p_atS1ERkauC></a>The <code>[^]*</code> part of the expression, as I described in the section on backtracking, will first match as much as it can. If that causes the next part of the pattern to fail, the matcher moves back one character and tries again from there. In the example, the matcher first tries to match the whole rest of the string and then moves back from there. It will find an occurrence of <code>*/</code> after going back four characters and match that. This is not what we wanted—the intention was to match a single comment, not to go all the way to the end of the code and find the end of the last block comment.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_eNtLSVH65f class=p_ident id=p_eNtLSVH65f></a>Because of this behavior, we say the repetition operators (<code>+</code>, <code>*</code>, <code>?</code>, and <code>{}</code>) are <em>greedy</em>, meaning they match as much as they can and backtrack from there. If you put a question mark after them (<code>+?</code>, <code>*?</code>, <code>??</code>, <code>{}?</code>), they become nongreedy and start by matching as little as possible, matching more only when the remaining pattern does not fit the smaller match.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_0L47KZXZKa class=p_ident id=p_0L47KZXZKa></a>And that is exactly what we want in this case. By having the star match the smallest stretch of characters that brings us to a <code>*/</code>, we consume one block comment and nothing more.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_MCNF7GxfR1 class=c_ident id=c_MCNF7GxfR1></a><p class=cm-keyword>function</p> <p class=cm-def>stripComments</p>(<p class=cm-def>code</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>code</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/\\/\\/.*|\\/\\*[^]*?\\*\\//g</p>, <p class=cm-string>\"\"</p>);\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>stripComments</p>(<p class=cm-string>\"1 /* a */+/* b */ 1\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_o+3JCFC4Dr class=p_ident id=p_o+3JCFC4Dr></a>A lot of bugs in regular expression programs can be traced to unintentionally using a greedy operator where a nongreedy one would work better. When using a repetition operator, consider the nongreedy variant first.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_Rhu25fogrG class=h_ident id=h_Rhu25fogrG></a>Dynamically creating RegExp objects</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_34PsyHYX4x class=p_ident id=p_34PsyHYX4x></a>There are cases where you might not know the exact pattern you need to match against when you are writing your code. Say you want to look for the user’s name in a piece of text and enclose it in underscore characters to make it stand out. Since you will know the name only once the program is actually running, you can’t use the slash-based notation.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_KAQggWa80Y class=p_ident id=p_KAQggWa80Y></a>But you can build up a string and use the <code>RegExp</code> constructor on that. Here’s an example:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_3yQimfD35d class=c_ident id=c_3yQimfD35d></a><p class=cm-keyword>let</p> <p class=cm-def>name</p> <p class=cm-operator>=</p> <p class=cm-string>\"harry\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-string>\"Harry is a suspicious character.\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>regexp</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>RegExp</p>(<p class=cm-string>\"\\\\b(\"</p> <p class=cm-operator>+</p> <p class=cm-variable>name</p> <p class=cm-operator>+</p> <p class=cm-string>\")\\\\b\"</p>, <p class=cm-string>\"gi\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>text</p>.<p class=cm-property>replace</p>(<p class=cm-variable>regexp</p>, <p class=cm-string>\"_$1_\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_J6H1NBoQy/ class=p_ident id=p_J6H1NBoQy/ ></a>When creating the <code>\\b</code> boundary markers, we have to use two backslashes because we are writing them in a normal string, not a slash-enclosed regular expression. The second argument to the <code>RegExp</code> constructor contains the options for the regular expression—in this case, <code>\"gi\"</code> for global and case insensitive.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_UPAgEiKHfS class=p_ident id=p_UPAgEiKHfS></a>But what if the name is <code>\"dea+hl[]rd\"</code> because our user is a nerdy teenager? That would result in a nonsensical regular expression that won’t actually match the user’s name.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Q+hqmMv8NT class=p_ident id=p_Q+hqmMv8NT></a>To work around this, we can add backslashes before any character that has a special meaning.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_VVThPW6YGV class=c_ident id=c_VVThPW6YGV></a><p class=cm-keyword>let</p> <p class=cm-def>name</p> <p class=cm-operator>=</p> <p class=cm-string>\"dea+hl[]rd\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-string>\"This dea+hl[]rd guy is super annoying.\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>escaped</p> <p class=cm-operator>=</p> <p class=cm-variable>name</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/[\\\\[.+*?(){|^$]/g</p>, <p class=cm-string>\"\\\\$&amp;\"</p>);\n<p class=cm-keyword>let</p> <p class=cm-def>regexp</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>RegExp</p>(<p class=cm-string>\"\\\\b\"</p> <p class=cm-operator>+</p> <p class=cm-variable>escaped</p> <p class=cm-operator>+</p> <p class=cm-string>\"\\\\b\"</p>, <p class=cm-string>\"gi\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>text</p>.<p class=cm-property>replace</p>(<p class=cm-variable>regexp</p>, <p class=cm-string>\"_$&amp;_\"</p>));\n</pre> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_Txg7z4j/ei class=h_ident id=h_Txg7z4j/ei></a>The search method</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_3QlEdRm5L2 class=p_ident id=p_3QlEdRm5L2></a>The <code>indexOf</code> method on strings cannot be called with a regular expression. But there is another method, <code>search</code>, that does expect a regular expression. Like <code>indexOf</code>, it returns the first index on which the expression was found, or -1 when it wasn’t found.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_diUfxE6ifs class=c_ident id=c_diUfxE6ifs></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\" word\"</p>.<p class=cm-property>search</p>(<p class=cm-string-2>/\\S/</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\" \"</p>.<p class=cm-property>search</p>(<p class=cm-string-2>/\\S/</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_tqlyvUKoi5 class=p_ident id=p_tqlyvUKoi5></a>Unfortunately, there is no way to indicate that the match should start at a given offset (like we can with the second argument to <code>indexOf</code>), which would often be useful.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_duFTd2hqd0 class=h_ident id=h_duFTd2hqd0></a>The lastIndex property</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_MvO8+re1D+ class=p_ident id=p_MvO8+re1D+></a>The <code>exec</code> method similarly does not provide a convenient way to start searching from a given position in the string. But it does provide an <em>in</em>convenient way.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_F+JgzwxLtK class=p_ident id=p_F+JgzwxLtK></a>Regular expression objects have properties. One such property is <code>source</code>, which contains the string that expression was created from. Another property is <code>lastIndex</code>, which controls, in some limited circumstances, where the next match will start.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Ld5Vcdy0jB class=p_ident id=p_Ld5Vcdy0jB></a>Those circumstances are that the regular expression must have the global (<code>g</code>) or sticky (<code>y</code>) option enabled, and the match must happen through the <code>exec</code> method. Again, a less confusing solution would have been to just allow an extra argument to be passed to <code>exec</code>, but confusion is an essential feature of JavaScript’s regular expression interface.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_nXsHtqIJdF class=c_ident id=c_nXsHtqIJdF></a><p class=cm-keyword>let</p> <p class=cm-def>pattern</p> <p class=cm-operator>=</p> <p class=cm-string-2>/y/g</p>;\n<p class=cm-variable>pattern</p>.<p class=cm-property>lastIndex</p> <p class=cm-operator>=</p> <p class=cm-number>3</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>match</p> <p class=cm-operator>=</p> <p class=cm-variable>pattern</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"xyzzy\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>match</p>.<p class=cm-property>index</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>pattern</p>.<p class=cm-property>lastIndex</p>);\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_hjLQ+57mDd class=p_ident id=p_hjLQ+57mDd></a>If the match was successful, the call to <code>exec</code> automatically updates the <code>lastIndex</code> property to point after the match. If no match was found, <code>lastIndex</code> is set back to zero, which is also the value it has in a newly constructed regular expression object.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_dQPVkpMm7y class=p_ident id=p_dQPVkpMm7y></a>The difference between the global and the sticky options is that, when sticky is enabled, the match will succeed only if it starts directly at <code>lastIndex</code>, whereas with global, it will search ahead for a position where a match can start.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_98GwGRIMj8 class=c_ident id=c_98GwGRIMj8></a><p class=cm-keyword>let</p> <p class=cm-def>global</p> <p class=cm-operator>=</p> <p class=cm-string-2>/abc/g</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>global</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"xyz abc\"</p>)); <p class=cm-keyword>let</p> <p class=cm-def>sticky</p> <p class=cm-operator>=</p> <p class=cm-string-2>/abc/y</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sticky</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"xyz abc\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_042bNmzNZK class=p_ident id=p_042bNmzNZK></a>When using a shared regular expression value for multiple <code>exec</code> calls, these automatic updates to the <code>lastIndex</code> property can cause problems. Your regular expression might be accidentally starting at an index that was left over from a previous call.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_wrx2wO0P8M class=c_ident id=c_wrx2wO0P8M></a><p class=cm-keyword>let</p> <p class=cm-def>digit</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\d/g</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>digit</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"here it is: 1\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>digit</p>.<p class=cm-property>exec</p>(<p class=cm-string>\"and now: 1\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_9l7tQ3SsME class=p_ident id=p_9l7tQ3SsME></a>Another interesting effect of the global option is that it changes the way the <code>match</code> method on strings works. When called with a global expression, instead of returning an array similar to that returned by <code>exec</code>, <code>match</code> will find <em>all</em> matches of the pattern in the string and return an array containing the matched strings.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_weT/d5+8vE class=c_ident id=c_weT/d5+8vE></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Banana\"</p>.<p class=cm-property>match</p>(<p class=cm-string-2>/an/g</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_zFHO63a2iV class=p_ident id=p_zFHO63a2iV></a>So be cautious with global regular expressions. The cases where they are necessary—calls to <code>replace</code> and places where you want to explicitly use <code>lastIndex</code>—are typically the only places where you want to use them.</p> <h3><a href=https://eloquentjavascript.net/09_regexp.html#i_m0fs21dHEg class=i_ident id=i_m0fs21dHEg></a>Looping over matches</h3> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Rhy/hnaaT+ class=p_ident id=p_Rhy/hnaaT+></a>A common thing to do is to scan through all occurrences of a pattern in a string, in a way that gives us access to the match object in the loop body. We can do this by using <code>lastIndex</code> and <code>exec</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_rSzEnbVHja class=c_ident id=c_rSzEnbVHja></a><p class=cm-keyword>let</p> <p class=cm-def>input</p> <p class=cm-operator>=</p> <p class=cm-string>\"A string with 3 numbers in it... 42 and 88.\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>number</p> <p class=cm-operator>=</p> <p class=cm-string-2>/\\b\\d+\\b/g</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>match</p>;\n<p class=cm-keyword>while</p> (<p class=cm-variable>match</p> <p class=cm-operator>=</p> <p class=cm-variable>number</p>.<p class=cm-property>exec</p>(<p class=cm-variable>input</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Found\"</p>, <p class=cm-variable>match</p>[<p class=cm-number>0</p>], <p class=cm-string>\"at\"</p>, <p class=cm-variable>match</p>.<p class=cm-property>index</p>);\n}\n\n\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ZdCI2+edqA class=p_ident id=p_ZdCI2+edqA></a>This makes use of the fact that the value of an assignment expression (<code>=</code>) is the assigned value. So by using <code>match = number.<wbr>exec(input)</code> as the condition in the <code>while</code> statement, we perform the match at the start of each iteration, save its result in a binding, and stop looping when no more matches are found.</p> <h2 id=ini><a href=https://eloquentjavascript.net/09_regexp.html#h_RGsf6ah1EY class=h_ident id=h_RGsf6ah1EY></a>Parsing an INI file</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_JbrLORqV9r class=p_ident id=p_JbrLORqV9r></a>To conclude the chapter, we’ll look at a problem that calls for regular expressions. Imagine we are writing a program to automatically collect information about our enemies from the Internet. (We will not actually write that program here, just the part that reads the configuration file. Sorry.) The configuration file looks like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_RV3f5fiptq class=c_ident id=c_RV3f5fiptq></a>searchengine=https://duckduckgo.com/?q=$1\nspitefulness=9.7\n\n; comments are preceded by a semicolon...\n; each section concerns an individual enemy\n[larry]\nfullname=Larry Doe\ntype=kindergarten bully\nwebsite=http://www.geocities.com/CapeCanaveral/11451\n\n[davaeorn]\nfullname=Davaeorn\ntype=evil wizard\noutputdir=/home/marijn/enemies/davaeorn</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_OgIQS1TJxB class=p_ident id=p_OgIQS1TJxB></a>The exact rules for this format (which is a widely used format, usually called an <em>INI</em> file) are as follows:</p> <ul> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_jIewfc/40B class=p_ident id=p_jIewfc/40B></a>Blank lines and lines starting with semicolons are ignored.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_O/dGCr+aR5 class=p_ident id=p_O/dGCr+aR5></a>Lines wrapped in <code>[</code> and <code>]</code> start a new section.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_l2Yjl1fUVB class=p_ident id=p_l2Yjl1fUVB></a>Lines containing an alphanumeric identifier followed by an <code>=</code> character add a setting to the current section.</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_bCaQwCXJCi class=p_ident id=p_bCaQwCXJCi></a>Anything else is invalid.</p></li></ul> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_clbD+OAS4y class=p_ident id=p_clbD+OAS4y></a>Our task is to convert a string like this into an object whose properties hold strings for settings written before the first section header and subobjects for sections, with those subobjects holding the section’s settings.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_8U3vMRn7g4 class=p_ident id=p_8U3vMRn7g4></a>Since the format has to be processed line by line, splitting up the file into separate lines is a good start. We saw the <code>split</code> method in <a href=https://eloquentjavascript.net/04_data.html#split>Chapter 4</a>. Some operating systems, however, use not just a newline character to separate lines but a carriage return character followed by a newline (<code>\"\\r\\n\"</code>). Given that the <code>split</code> method also allows a regular expression as its argument, we can use a regular expression like <code>/\\r?\\n/</code> to split in a way that allows both <code>\"\\n\"</code> and <code>\"\\r\\n\"</code> between lines.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_neI86/XXg2 class=c_ident id=c_neI86/XXg2></a><p class=cm-keyword>function</p> <p class=cm-def>parseINI</p>(<p class=cm-def>string</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> {}; <p class=cm-keyword>let</p> <p class=cm-def>section</p> <p class=cm-operator>=</p> <p class=cm-variable-2>result</p>; <p class=cm-variable-2>string</p>.<p class=cm-property>split</p>(<p class=cm-string-2>/\\r?\\n/</p>).<p class=cm-property>forEach</p>(<p class=cm-def>line</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>match</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>match</p> <p class=cm-operator>=</p> <p class=cm-variable-2>line</p>.<p class=cm-property>match</p>(<p class=cm-string-2>/^(\\w+)=(.*)$/</p>)) { <p class=cm-variable-2>section</p>[<p class=cm-variable-2>match</p>[<p class=cm-number>1</p>]] <p class=cm-operator>=</p> <p class=cm-variable-2>match</p>[<p class=cm-number>2</p>]; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>match</p> <p class=cm-operator>=</p> <p class=cm-variable-2>line</p>.<p class=cm-property>match</p>(<p class=cm-string-2>/^\\[(.*)\\]$/</p>)) { <p class=cm-variable-2>section</p> <p class=cm-operator>=</p> <p class=cm-variable-2>result</p>[<p class=cm-variable-2>match</p>[<p class=cm-number>1</p>]] <p class=cm-operator>=</p> {}; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-string-2>/^\\s*(;.*)?$/</p>.<p class=cm-property>test</p>(<p class=cm-variable-2>line</p>)) { <p class=cm-keyword>throw</p> <p class=cm-keyword>new</p> <p class=cm-variable>Error</p>(<p class=cm-string>\"Line '\"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>line</p> <p class=cm-operator>+</p> <p class=cm-string>\"' is not valid.\"</p>); } }); <p class=cm-keyword>return</p> <p class=cm-variable-2>result</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>parseINI</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>name=Vasilis</p>\n<p class=cm-string-2>[address]</p>\n<p class=cm-string-2>city=Tessaloniki`</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_86q0K3iF4C class=p_ident id=p_86q0K3iF4C></a>The code goes over the file’s lines and builds up an object. Properties at the top are stored directly into that object, whereas properties found in sections are stored in a separate section object. The <code>section</code> binding points at the object for the current section.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ixTfvSC1VN class=p_ident id=p_ixTfvSC1VN></a>There are two kinds of significant lines—section headers or property lines. When a line is a regular property, it is stored in the current section. When it is a section header, a new section object is created, and <code>section</code> is set to point at it.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_FPzqsloIkT class=p_ident id=p_FPzqsloIkT></a>Note the recurring use of <code>^</code> and <code>$</code> to make sure the expression matches the whole line, not just part of it. Leaving these out results in code that mostly works but behaves strangely for some input, which can be a difficult bug to track down.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ACT8bIScp+ class=p_ident id=p_ACT8bIScp+></a>The pattern <code>if (match = string.<wbr>match(.<wbr>.<wbr>.<wbr>))</code> is similar to the trick of using an assignment as the condition for <code>while</code>. You often aren’t sure that your call to <code>match</code> will succeed, so you can access the resulting object only inside an <code>if</code> statement that tests for this. To not break the pleasant chain of <code>else if</code> forms, we assign the result of the match to a binding and immediately use that assignment as the test for the <code>if</code> statement.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_mwlBKfUu5D class=p_ident id=p_mwlBKfUu5D></a>If a line is not a section header or a property, the function checks whether it is a comment or an empty line using the expression <code>/^\\s*(;.*)?$/</code>. Do you see how it works? The part between the parentheses will match comments, and the <code>?</code> makes sure it also matches lines containing only whitespace. When a line doesn’t match any of the expected forms, the function throws an exception.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_+y54//b0l+ class=h_ident id=h_+y54//b0l+></a>International characters</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_2zJ37rLrbl class=p_ident id=p_2zJ37rLrbl></a>Because of JavaScript’s initial simplistic implementation and the fact that this simplistic approach was later set in stone as standard behavior, JavaScript’s regular expressions are rather dumb about characters that do not appear in the English language. For example, as far as JavaScript’s regular expressions are concerned, a “word character” is only one of the 26 characters in the Latin alphabet (uppercase or lowercase), decimal digits, and, for some reason, the underscore character. Things like <em>é</em> or <em>β</em>, which most definitely are word characters, will not match <code>\\w</code> (and <em>will</em> match uppercase <code>\\W</code>, the nonword category).</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_H4r1oRJB6J class=p_ident id=p_H4r1oRJB6J></a>By a strange historical accident, <code>\\s</code> (whitespace) does not have this problem and matches all characters that the Unicode standard considers whitespace, including things like the nonbreaking space and the Mongolian vowel separator.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Ln5OarYp4l class=p_ident id=p_Ln5OarYp4l></a>Another problem is that, by default, regular expressions work on code units, as discussed in <a href=https://eloquentjavascript.net/05_higher_order.html#code_units>Chapter 5</a>, not actual characters. This means characters that are composed of two code units behave strangely.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_CfMTYxun8D class=c_ident id=c_CfMTYxun8D></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/🍎{3}/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"🍎🍎🍎\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/&lt;.&gt;/</p>.<p class=cm-property>test</p>(<p class=cm-string>\"&lt;🌹&gt;\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/&lt;.&gt;/u</p>.<p class=cm-property>test</p>(<p class=cm-string>\"&lt;🌹&gt;\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_j4Kcv6J/rF class=p_ident id=p_j4Kcv6J/rF></a>The problem is that the 🍎 in the first line is treated as two code units, and the <code>{3}</code> part is applied only to the second one. Similarly, the dot matches a single code unit, not the two that make up the rose emoji.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_1OZOJ3sk/b class=p_ident id=p_1OZOJ3sk/b></a>You must add a <code>u</code> option (for Unicode) to your regular expression to make it treat such characters properly. The wrong behavior remains the default, unfortunately, because changing that might cause problems for existing code that depends on it.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_MmzTSqcyKg class=p_ident id=p_MmzTSqcyKg></a>Though this was only just standardized and is, at the time of writing, not widely supported yet, it is possible to use <code>\\p</code> in a regular expression (that must have the Unicode option enabled) to match all characters to which the Unicode standard assigns a given property.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_+jV1oln0sr class=c_ident id=c_+jV1oln0sr></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/\\p{Script=Greek}/u</p>.<p class=cm-property>test</p>(<p class=cm-string>\"α\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/\\p{Script=Arabic}/u</p>.<p class=cm-property>test</p>(<p class=cm-string>\"α\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/\\p{Alphabetic}/u</p>.<p class=cm-property>test</p>(<p class=cm-string>\"α\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>/\\p{Alphabetic}/u</p>.<p class=cm-property>test</p>(<p class=cm-string>\"!\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_5NxQGhRrMq class=p_ident id=p_5NxQGhRrMq></a>Unicode defines a number of useful properties, though finding the one that you need may not always be trivial. You can use the <code>\\p{Property=Value}</code> notation to match any character that has the given value for that property. If the property name is left off, as in <code>\\p{Name}</code>, the name is assumed to be either a binary property such as <code>Alphabetic</code> or a category such as <code>Number</code>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_/hQX04GtpS class=p_ident id=p_/hQX04GtpS></a>Regular expressions are objects that represent patterns in strings. They use their own language to express these patterns.</p> <table> <tbody><tr><td><code>/abc/</code></td><td>A sequence of characters</td> </tr> <tr><td><code>/[abc]/</code></td><td>Any character from a set of characters</td> </tr> <tr><td><code>/[^abc]/</code></td><td>Any character <em>not</em> in a set of characters</td> </tr> <tr><td><code>/[0-9]/</code></td><td>Any character in a range of characters</td> </tr> <tr><td><code>/x+/</code></td><td>One or more occurrences of the pattern <code>x</code></td> </tr> <tr><td><code>/x+?/</code></td><td>One or more occurrences, nongreedy</td> </tr> <tr><td><code>/x*/</code></td><td>Zero or more occurrences</td> </tr> <tr><td><code>/x?/</code></td><td>Zero or one occurrence</td> </tr> <tr><td><code>/x{2,4}/</code></td><td>Two to four occurrences</td> </tr> <tr><td><code>/(abc)/</code></td><td>A group</td> </tr> <tr><td><code>/a|b|c/</code></td><td>Any one of several patterns</td> </tr> <tr><td><code>/\\d/</code></td><td>Any digit character</td> </tr> <tr><td><code>/\\w/</code></td><td>An alphanumeric character (“word character”)</td> </tr> <tr><td><code>/\\s/</code></td><td>Any whitespace character</td> </tr> <tr><td><code>/./</code></td><td>Any character except newlines</td> </tr> <tr><td><code>/\\b/</code></td><td>A word boundary</td> </tr> <tr><td><code>/^/</code></td><td>Start of input</td> </tr> <tr><td><code>/$/</code></td><td>End of input</td> </tr> </tbody></table> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_AVY5pFcEyH class=p_ident id=p_AVY5pFcEyH></a>A regular expression has a method <code>test</code> to test whether a given string matches it. It also has a method <code>exec</code> that, when a match is found, returns an array containing all matched groups. Such an array has an <code>index</code> property that indicates where the match started.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_FoVJlvxp9q class=p_ident id=p_FoVJlvxp9q></a>Strings have a <code>match</code> method to match them against a regular expression and a <code>search</code> method to search for one, returning only the starting position of the match. Their <code>replace</code> method can replace matches of a pattern with a replacement string or function.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_APfM9C3A6j class=p_ident id=p_APfM9C3A6j></a>Regular expressions can have options, which are written after the closing slash. The <code>i</code> option makes the match case insensitive. The <code>g</code> option makes the expression <em>global</em>, which, among other things, causes the <code>replace</code> method to replace all instances instead of just the first. The <code>y</code> option makes it sticky, which means that it will not search ahead and skip part of the string when looking for a match. The <code>u</code> option turns on Unicode mode, which fixes a number of problems around the handling of characters that take up two code units.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_mvLGdyUb97 class=p_ident id=p_mvLGdyUb97></a>Regular expressions are a sharp tool with an awkward handle. They simplify some tasks tremendously but can quickly become unmanageable when applied to complex problems. Part of knowing how to use them is resisting the urge to try to shoehorn things that they cannot cleanly express into them.</p> <h2><a href=https://eloquentjavascript.net/09_regexp.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_meNfX2B/+s class=p_ident id=p_meNfX2B/+s></a>It is almost unavoidable that, in the course of working on these exercises, you will get confused and frustrated by some regular expression’s inexplicable behavior. Sometimes it helps to enter your expression into an online tool like <a href=https://www.debuggex.com/ ><em>https://debuggex.com</em></a> to see whether its visualization corresponds to what you intended and to experiment with the way it responds to various input strings.</p> <h3><a href=https://eloquentjavascript.net/09_regexp.html#i_vDM8PzwQWU class=i_ident id=i_vDM8PzwQWU></a>Regexp golf</h3> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_1t8xXpFN7O class=p_ident id=p_1t8xXpFN7O></a><em>Code golf</em> is a term used for the game of trying to express a particular program in as few characters as possible. Similarly, <em>regexp golf</em> is the practice of writing as tiny a regular expression as possible to match a given pattern, and <em>only</em> that pattern.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_VGCqgCur6C class=p_ident id=p_VGCqgCur6C></a>For each of the following items, write a regular expression to test whether any of the given substrings occur in a string. The regular expression should match only strings containing one of the substrings described. Do not worry about word boundaries unless explicitly mentioned. When your expression works, see whether you can make it any smaller.</p> <ol> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_togdFO+/b9 class=p_ident id=p_togdFO+/b9></a><em>car</em> and <em>cat</em></p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_2Q37Tsr9DS class=p_ident id=p_2Q37Tsr9DS></a><em>pop</em> and <em>prop</em></p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_2Ah4dFikw1 class=p_ident id=p_2Ah4dFikw1></a><em>ferret</em>, <em>ferry</em>, and <em>ferrari</em></p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ttiBCcePDl class=p_ident id=p_ttiBCcePDl></a>Any word ending in <em>ious</em></p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_XnqTy5SopM class=p_ident id=p_XnqTy5SopM></a>A whitespace character followed by a period, comma, colon, or semicolon</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Ku7hE3qqDn class=p_ident id=p_Ku7hE3qqDn></a>A word longer than six letters</p></li> <li> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_mFDWQqRtWe class=p_ident id=p_mFDWQqRtWe></a>A word without the letter <em>e</em> (or <em>E</em>)</p></li> </ol> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_Tzjl1Axr+h class=p_ident id=p_Tzjl1Axr+h></a>Refer to the table in the <a href=https://eloquentjavascript.net/09_regexp.html#summary_regexp>chapter summary</a> for help. Test each solution with a few test strings.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_bnGKrYkiZ9 class=c_ident id=c_bnGKrYkiZ9></a> <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"my car\"</p>, <p class=cm-string>\"bad cats\"</p>], [<p class=cm-string>\"camper\"</p>, <p class=cm-string>\"high art\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"pop culture\"</p>, <p class=cm-string>\"mad props\"</p>], [<p class=cm-string>\"plop\"</p>, <p class=cm-string>\"prrrop\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"ferret\"</p>, <p class=cm-string>\"ferry\"</p>, <p class=cm-string>\"ferrari\"</p>], [<p class=cm-string>\"ferrum\"</p>, <p class=cm-string>\"transfer A\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"how delicious\"</p>, <p class=cm-string>\"spacious room\"</p>], [<p class=cm-string>\"ruinous\"</p>, <p class=cm-string>\"consciousness\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"bad punctuation .\"</p>], [<p class=cm-string>\"escape the period\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"Siebentausenddreihundertzweiundzwanzig\"</p>], [<p class=cm-string>\"no\"</p>, <p class=cm-string>\"three small words\"</p>]); <p class=cm-variable>verify</p>(<p class=cm-string-2>/.../</p>, [<p class=cm-string>\"red platypus\"</p>, <p class=cm-string>\"wobbling nest\"</p>], [<p class=cm-string>\"earth bed\"</p>, <p class=cm-string>\"learning ape\"</p>, <p class=cm-string>\"BEET\"</p>]); <p class=cm-keyword>function</p> <p class=cm-def>verify</p>(<p class=cm-def>regexp</p>, <p class=cm-def>yes</p>, <p class=cm-def>no</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>regexp</p>.<p class=cm-property>source</p> <p class=cm-operator>==</p> <p class=cm-string>\"...\"</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>str</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>yes</p>) <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>regexp</p>.<p class=cm-property>test</p>(<p class=cm-variable-2>str</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Failure to match '${</p><p class=cm-variable-2>str</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>); } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>str</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>no</p>) <p class=cm-keyword>if</p> (<p class=cm-variable-2>regexp</p>.<p class=cm-property>test</p>(<p class=cm-variable-2>str</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Unexpected match for '${</p><p class=cm-variable-2>str</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>);\n  }\n}</pre> <h3><a href=https://eloquentjavascript.net/09_regexp.html#i_dTiEW14oG0 class=i_ident id=i_dTiEW14oG0></a>Quoting style</h3> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_x7xoQ6mk60 class=p_ident id=p_x7xoQ6mk60></a>Imagine you have written a story and used single quotation marks throughout to mark pieces of dialogue. Now you want to replace all the dialogue quotes with double quotes, while keeping the single quotes used in contractions like <em>aren’t</em>.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_k3Y0NF9w4b class=p_ident id=p_k3Y0NF9w4b></a>Think of a pattern that distinguishes these two kinds of quote usage and craft a call to the <code>replace</code> method that does the proper replacement.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_sPrcOR+s/4 class=c_ident id=c_sPrcOR+s/4></a><p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-string>\"'I'm the cook,' he said, 'it's my job.'\"</p>; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>text</p>.<p class=cm-property>replace</p>(<p class=cm-string-2>/A/g</p>, <p class=cm-string>\"B\"</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_rNoBQVCfFp class=p_ident id=p_rNoBQVCfFp></a>The most obvious solution is to replace only quotes with a nonword character on at least one side—something like <code>/\\W'|'\\W/</code>. But you also have to take the start and end of the line into account.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_1SUsrUgWek class=p_ident id=p_1SUsrUgWek></a>In addition, you must ensure that the replacement also includes the characters that were matched by the <code>\\W</code> pattern so that those are not dropped. This can be done by wrapping them in parentheses and including their groups in the replacement string (<code>$1</code>, <code>$2</code>). Groups that are not matched will be replaced by nothing.</p> </div></div> <h3><a href=https://eloquentjavascript.net/09_regexp.html#i_izldJoT3uv class=i_ident id=i_izldJoT3uv></a>Numbers again</h3> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_0OQXsuIIcQ class=p_ident id=p_0OQXsuIIcQ></a>Write an expression that matches only JavaScript-style numbers. It must support an optional minus <em>or</em> plus sign in front of the number, the decimal dot, and exponent notation—<code>5e-3</code> or <code>1E10</code>—again with an optional sign in front of the exponent. Also note that it is not necessary for there to be digits in front of or after the dot, but the number cannot be a dot alone. That is, <code>.5</code> and <code>5.</code> are valid JavaScript numbers, but a lone dot <em>isn’t</em>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/09_regexp.html#c_aHAzeMYYGe class=c_ident id=c_aHAzeMYYGe></a>\n<p class=cm-keyword>let</p> <p class=cm-def>number</p> <p class=cm-operator>=</p> <p class=cm-string-2>/^...$/</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>str</p> <p class=cm-keyword>of</p> [<p class=cm-string>\"1\"</p>, <p class=cm-string>\"-1\"</p>, <p class=cm-string>\"+15\"</p>, <p class=cm-string>\"1.55\"</p>, <p class=cm-string>\".5\"</p>, <p class=cm-string>\"5.\"</p>, <p class=cm-string>\"1.3e2\"</p>, <p class=cm-string>\"1E-4\"</p>, <p class=cm-string>\"1e+12\"</p>]) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable>number</p>.<p class=cm-property>test</p>(<p class=cm-variable>str</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Failed to match '${</p><p class=cm-variable>str</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>); }\n}\n<p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>str</p> <p class=cm-keyword>of</p> [<p class=cm-string>\"1a\"</p>, <p class=cm-string>\"+-1\"</p>, <p class=cm-string>\"1.2.3\"</p>, <p class=cm-string>\"1+1\"</p>, <p class=cm-string>\"1e4.5\"</p>, <p class=cm-string>\".5.\"</p>, <p class=cm-string>\"1f5\"</p>, <p class=cm-string>\".\"</p>]) { <p class=cm-keyword>if</p> (<p class=cm-variable>number</p>.<p class=cm-property>test</p>(<p class=cm-variable>str</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`Incorrectly accepted '${</p><p class=cm-variable>str</p><p class=cm-string-2>}</p><p class=cm-string-2>'`</p>);\n  }\n}</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_sWIFtGBNR7 class=p_ident id=p_sWIFtGBNR7></a>First, do not forget the backslash in front of the period.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_ShOca+aF11 class=p_ident id=p_ShOca+aF11></a>Matching the optional sign in front of the number, as well as in front of the exponent, can be done with <code>[+\\-]?</code> or <code>(\\+|-|)</code> (plus, minus, or nothing).</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_z9QJjd6IxQ class=p_ident id=p_z9QJjd6IxQ></a>The more complicated part of the exercise is the problem of matching both <code>\"5.\"</code> and <code>\".5\"</code> without also matching <code>\".\"</code>. For this, a good solution is to use the <code>|</code> operator to separate the two cases—either one or more digits optionally followed by a dot and zero or more digits <em>or</em> a dot followed by one or more digits.</p> <p><a href=https://eloquentjavascript.net/09_regexp.html#p_WHNmLsGl4C class=p_ident id=p_WHNmLsGl4C></a>Finally, to make the <em>e</em> case insensitive, either add an <code>i</code> option to the regular expression or use <code>[eE]</code>.</p> </div></div><nav><a href=https://eloquentjavascript.net/08_error.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/10_modules.html>▶</a></nav>\n</article><hr><h4>Page 10</h4><article score=1190.8750000000005>\n<nav><a href=https://eloquentjavascript.net/03_functions.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/05_higher_order.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/04_data.html#p_3DGxnMhaad class=p_ident id=p_3DGxnMhaad></a>On two occasions I have been asked, ‘Pray, Mr. Babbage, if you put into the machine wrong figures, will the right answers come out?’ [...] I am not able rightly to apprehend the kind of confusion of ideas that could provoke such a question.</p> <footer>Charles Babbage, <cite>Passages from the Life of a Philosopher (1864)</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a weresquirrel\" src=https://eloquentjavascript.net/img/chapter_picture_4.jpg></figure> <p><a href=https://eloquentjavascript.net/04_data.html#p_j/UjCN3npi class=p_ident id=p_j/UjCN3npi></a>Numbers, Booleans, and strings are the atoms that data structures are built from. Many types of information require more than one atom, though. <em>Objects</em> allow us to group values—including other objects—to build more complex structures.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_F4YgzUjHcT class=p_ident id=p_F4YgzUjHcT></a>The programs we have built so far have been limited by the fact that they were operating only on simple data types. This chapter will introduce basic data structures. By the end of it, you’ll know enough to start writing useful programs.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_vL8agXHSiL class=p_ident id=p_vL8agXHSiL></a>The chapter will work through a more or less realistic programming example, introducing concepts as they apply to the problem at hand. The example code will often build on functions and bindings that were introduced earlier in the text.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_NvjtahQLlw class=h_ident id=h_NvjtahQLlw></a>The weresquirrel</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_0aih0sjFrb class=p_ident id=p_0aih0sjFrb></a>Every now and then, usually between 8 p.m. and 10 p.m., Jacques finds himself transforming into a small furry rodent with a bushy tail.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_EIDMzKWaqr class=p_ident id=p_EIDMzKWaqr></a>On one hand, Jacques is quite glad that he doesn’t have classic lycanthropy. Turning into a squirrel does cause fewer problems than turning into a wolf. Instead of having to worry about accidentally eating the neighbor (<em>that</em> would be awkward), he worries about being eaten by the neighbor’s cat. After two occasions where he woke up on a precariously thin branch in the crown of an oak, naked and disoriented, he has taken to locking the doors and windows of his room at night and putting a few walnuts on the floor to keep himself busy.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ciZTylV1yl class=p_ident id=p_ciZTylV1yl></a>That takes care of the cat and tree problems. But Jacques would prefer to get rid of his condition entirely. The irregular occurrences of the transformation make him suspect that they might be triggered by something. For a while, he believed that it happened only on days when he had been near oak trees. But avoiding oak trees did not stop the problem.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Xj6eprhXkS class=p_ident id=p_Xj6eprhXkS></a>Switching to a more scientific approach, Jacques has started keeping a daily log of everything he does on a given day and whether he changed form. With this data he hopes to narrow down the conditions that trigger the transformations.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_mcDf0Dxvcm class=p_ident id=p_mcDf0Dxvcm></a>The first thing he needs is a data structure to store this information.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_HjL/otjEJn class=h_ident id=h_HjL/otjEJn></a>Data sets</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_HFLfyQFSDp class=p_ident id=p_HFLfyQFSDp></a>To work with a chunk of digital data, we’ll first have to find a way to represent it in our machine’s memory. Say, for example, that we want to represent a collection of the numbers 2, 3, 5, 7, and 11.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_cnzv4pg+Wz class=p_ident id=p_cnzv4pg+Wz></a>We could get creative with strings—after all, strings can have any length, so we can put a lot of data into them—and use <code>\"2 3 5 7 11\"</code> as our representation. But this is awkward. You’d have to somehow extract the digits and convert them back to numbers to access them.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_/aFILq7bDn class=p_ident id=p_/aFILq7bDn></a>Fortunately, JavaScript provides a data type specifically for storing sequences of values. It is called an <em>array</em> and is written as a list of values between square brackets, separated by commas.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_05cIH1hy/D class=c_ident id=c_05cIH1hy/D></a><p class=cm-keyword>let</p> <p class=cm-def>listOfNumbers</p> <p class=cm-operator>=</p> [<p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>5</p>, <p class=cm-number>7</p>, <p class=cm-number>11</p>];\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>listOfNumbers</p>[<p class=cm-number>2</p>]); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>listOfNumbers</p>[<p class=cm-number>0</p>]); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>listOfNumbers</p>[<p class=cm-number>2</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>]);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_xu5bhsrvS2 class=p_ident id=p_xu5bhsrvS2></a>The notation for getting at the elements inside an array also uses square brackets. A pair of square brackets immediately after an expression, with another expression inside of them, will look up the element in the left-hand expression that corresponds to the <em>index</em> given by the expression in the brackets.</p> <p id=array_indexing><a href=https://eloquentjavascript.net/04_data.html#p_1+NmIJreij class=p_ident id=p_1+NmIJreij></a>The first index of an array is zero, not one. So the first element is retrieved with <code>listOfNumbers[0]</code>. Zero-based counting has a long tradition in technology and in certain ways makes a lot of sense, but it takes some getting used to. Think of the index as the amount of items to skip, counting from the start of the array.</p> <h2 id=properties><a href=https://eloquentjavascript.net/04_data.html#h_vGyI2y8HA6 class=h_ident id=h_vGyI2y8HA6></a>Properties</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_GC4++VF2pM class=p_ident id=p_GC4++VF2pM></a>We’ve seen a few suspicious-looking expressions like <code>myString.length</code> (to get the length of a string) and <code>Math.max</code> (the maximum function) in past chapters. These are expressions that access a <em>property</em> of some value. In the first case, we access the <code>length</code> property of the value in <code>myString</code>. In the second, we access the property named <code>max</code> in the <code>Math</code> object (which is a collection of mathematics-related constants and functions).</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_dTOk+Nu/lR class=p_ident id=p_dTOk+Nu/lR></a>Almost all JavaScript values have properties. The exceptions are <code>null</code> and <code>undefined</code>. If you try to access a property on one of these nonvalues, you get an error.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_FNR95AymUx class=c_ident id=c_FNR95AymUx></a><p class=cm-atom>null</p>.<p class=cm-property>length</p>;\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_wm1lZqKJ49 class=p_ident id=p_wm1lZqKJ49></a>The two main ways to access properties in JavaScript are with a dot and with square brackets. Both <code>value.x</code> and <code>value[x]</code> access a property on <code>value</code>—but not necessarily the same property. The difference is in how <code>x</code> is interpreted. When using a dot, the word after the dot is the literal name of the property. When using square brackets, the expression between the brackets is <em>evaluated</em> to get the property name. Whereas <code>value.x</code> fetches the property of <code>value</code> named “x”, <code>value[x]</code> tries to evaluate the expression <code>x</code> and uses the result, converted to a string, as the property name.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_PeocsmCJ3P class=p_ident id=p_PeocsmCJ3P></a>So if you know that the property you are interested in is called <em>color</em>, you say <code>value.color</code>. If you want to extract the property named by the value held in the binding <code>i</code>, you say <code>value[i]</code>. Property names are strings. They can be any string, but the dot notation works only with names that look like valid binding names. So if you want to access a property named <em>2</em> or <em>John Doe</em>, you must use square brackets: <code>value[2]</code> or <code>value[\"John Doe\"]</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_v2+DwDjnmO class=p_ident id=p_v2+DwDjnmO></a>The elements in an array are stored as the array’s properties, using numbers as property names. Because you can’t use the dot notation with numbers and usually want to use a binding that holds the index anyway, you have to use the bracket notation to get at them.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Bcq+Q3kiI4 class=p_ident id=p_Bcq+Q3kiI4></a>The <code>length</code> property of an array tells us how many elements it has. This property name is a valid binding name, and we know its name in advance, so to find the length of an array, you typically write <code>array.length</code> because that’s easier to write than <code>array[\"length\"]</code>.</p> <h2 id=methods><a href=https://eloquentjavascript.net/04_data.html#h_fkrGgDyRWc class=h_ident id=h_fkrGgDyRWc></a>Methods</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_t1dHhJEzat class=p_ident id=p_t1dHhJEzat></a>Both string and array values contain, in addition to the <code>length</code> property, a number of properties that hold function values.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_prRDc5amqh class=c_ident id=c_prRDc5amqh></a><p class=cm-keyword>let</p> <p class=cm-def>doh</p> <p class=cm-operator>=</p> <p class=cm-string>\"Doh\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-keyword>typeof</p> <p class=cm-variable>doh</p>.<p class=cm-property>toUpperCase</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>doh</p>.<p class=cm-property>toUpperCase</p>());\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_TWVl3O+8/l class=p_ident id=p_TWVl3O+8/l></a>Every string has a <code>toUpperCase</code> property. When called, it will return a copy of the string in which all letters have been converted to uppercase. There is also <code>toLowerCase</code>, going the other way.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ZYWrM09QFe class=p_ident id=p_ZYWrM09QFe></a>Interestingly, even though the call to <code>toUpperCase</code> does not pass any arguments, the function somehow has access to the string <code>\"Doh\"</code>, the value whose property we called. How this works is described in <a href=https://eloquentjavascript.net/06_object.html#obj_methods>Chapter 6</a>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_96KudJIN5i class=p_ident id=p_96KudJIN5i></a>Properties that contain functions are generally called <em>methods</em> of the value they belong to, as in “<code>toUpperCase</code> is a method of a string”.</p> <p id=array_methods><a href=https://eloquentjavascript.net/04_data.html#p_aAS6mUhzmc class=p_ident id=p_aAS6mUhzmc></a>This example demonstrates two methods you can use to manipulate arrays:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_RiFZUNk6gr class=c_ident id=c_RiFZUNk6gr></a><p class=cm-keyword>let</p> <p class=cm-def>sequence</p> <p class=cm-operator>=</p> [<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>];\n<p class=cm-variable>sequence</p>.<p class=cm-property>push</p>(<p class=cm-number>4</p>);\n<p class=cm-variable>sequence</p>.<p class=cm-property>push</p>(<p class=cm-number>5</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sequence</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sequence</p>.<p class=cm-property>pop</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sequence</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_6iATZ6SSgb class=p_ident id=p_6iATZ6SSgb></a>The <code>push</code> method adds values to the end of an array, and the <code>pop</code> method does the opposite, removing the last value in the array and returning it.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_0p3gvnUXoK class=p_ident id=p_0p3gvnUXoK></a>These somewhat silly names are the traditional terms for operations on a <em>stack</em>. A stack, in programming, is a data structure that allows you to push values into it and pop them out again in the opposite order so that the thing that was added last is removed first. These are common in programming—you might remember the function call stack from <a href=https://eloquentjavascript.net/03_functions.html#stack>the previous chapter</a>, which is an instance of the same idea.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_cqg63Sxe3o class=h_ident id=h_cqg63Sxe3o></a>Objects</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_D8cm1kz0P8 class=p_ident id=p_D8cm1kz0P8></a>Back to the weresquirrel. A set of daily log entries can be represented as an array. But the entries do not consist of just a number or a string—each entry needs to store a list of activities and a Boolean value that indicates whether Jacques turned into a squirrel or not. Ideally, we would like to group these together into a single value and then put those grouped values into an array of log entries.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_amO+YCpNIz class=p_ident id=p_amO+YCpNIz></a>Values of the type <em>object</em> are arbitrary collections of properties. One way to create an object is by using braces as an expression.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_Y37a9WsXpl class=c_ident id=c_Y37a9WsXpl></a><p class=cm-keyword>let</p> <p class=cm-def>day1</p> <p class=cm-operator>=</p> { <p class=cm-property>squirrel</p>: <p class=cm-atom>false</p>, <p class=cm-property>events</p>: [<p class=cm-string>\"work\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"pizza\"</p>, <p class=cm-string>\"running\"</p>]\n};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>day1</p>.<p class=cm-property>squirrel</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>day1</p>.<p class=cm-property>wolf</p>); <p class=cm-variable>day1</p>.<p class=cm-property>wolf</p> <p class=cm-operator>=</p> <p class=cm-atom>false</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>day1</p>.<p class=cm-property>wolf</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_hPPBEWYY/i class=p_ident id=p_hPPBEWYY/i></a>Inside the braces, there is a list of properties separated by commas. Each property has a name followed by a colon and a value. When an object is written over multiple lines, indenting it like in the example helps with readability. Properties whose names aren’t valid binding names or valid numbers have to be quoted.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_n8ErtKNPW/ class=c_ident id=c_n8ErtKNPW/ ></a><p class=cm-keyword>let</p> <p class=cm-def>descriptions</p> <p class=cm-operator>=</p> { <p class=cm-property>work</p>: <p class=cm-string>\"Went to work\"</p>, <p class=cm-string>\"touched tree\"</p>: <p class=cm-string>\"Touched a tree\"</p>\n};</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_nZ3mgfn27O class=p_ident id=p_nZ3mgfn27O></a>This means that braces have <em>two</em> meanings in JavaScript. At the start of a statement, they start a block of statements. In any other position, they describe an object. Fortunately, it is rarely useful to start a statement with an object in braces, so the ambiguity between these two is not much of a problem.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_lBjH6GtvXt class=p_ident id=p_lBjH6GtvXt></a>Reading a property that doesn’t exist will give you the value <code>undefined</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_m1hLPDyHXE class=p_ident id=p_m1hLPDyHXE></a>It is possible to assign a value to a property expression with the <code>=</code> operator. This will replace the property’s value if it already existed or create a new property on the object if it didn’t.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_2b9eQWe4l/ class=p_ident id=p_2b9eQWe4l/ ></a>To briefly return to our tentacle model of bindings—property bindings are similar. They <em>grasp</em> values, but other bindings and properties might be holding onto those same values. You may think of objects as octopuses with any number of tentacles, each of which has a name tattooed on it.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_nQBjCOh9nC class=p_ident id=p_nQBjCOh9nC></a>The <code>delete</code> operator cuts off a tentacle from such an octopus. It is a unary operator that, when applied to an object property, will remove the named property from the object. This is not a common thing to do, but it is possible.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_66M3B1wG98 class=c_ident id=c_66M3B1wG98></a><p class=cm-keyword>let</p> <p class=cm-def>anObject</p> <p class=cm-operator>=</p> {<p class=cm-property>left</p>: <p class=cm-number>1</p>, <p class=cm-property>right</p>: <p class=cm-number>2</p>};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>anObject</p>.<p class=cm-property>left</p>); <p class=cm-keyword>delete</p> <p class=cm-variable>anObject</p>.<p class=cm-property>left</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>anObject</p>.<p class=cm-property>left</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"left\"</p> <p class=cm-keyword>in</p> <p class=cm-variable>anObject</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"right\"</p> <p class=cm-keyword>in</p> <p class=cm-variable>anObject</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_vVEymXRSvR class=p_ident id=p_vVEymXRSvR></a>The binary <code>in</code> operator, when applied to a string and an object, tells you whether that object has a property with that name. The difference between setting a property to <code>undefined</code> and actually deleting it is that, in the first case, the object still <em>has</em> the property (it just doesn’t have a very interesting value), whereas in the second case the property is no longer present and <code>in</code> will return <code>false</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_SvMW6lxfp+ class=p_ident id=p_SvMW6lxfp+></a>To find out what properties an object has, you can use the <code>Object.keys</code> function. You give it an object, and it returns an array of strings—the object’s property names.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_0oaalmpqn6 class=c_ident id=c_0oaalmpqn6></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Object</p>.<p class=cm-property>keys</p>({<p class=cm-property>x</p>: <p class=cm-number>0</p>, <p class=cm-property>y</p>: <p class=cm-number>0</p>, <p class=cm-property>z</p>: <p class=cm-number>2</p>}));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_z4/OPZzTTK class=p_ident id=p_z4/OPZzTTK></a>There’s an <code>Object.assign</code> function that copies all properties from one object into another.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_ngXKayzwiT class=c_ident id=c_ngXKayzwiT></a><p class=cm-keyword>let</p> <p class=cm-def>objectA</p> <p class=cm-operator>=</p> {<p class=cm-property>a</p>: <p class=cm-number>1</p>, <p class=cm-property>b</p>: <p class=cm-number>2</p>};\n<p class=cm-variable>Object</p>.<p class=cm-property>assign</p>(<p class=cm-variable>objectA</p>, {<p class=cm-property>b</p>: <p class=cm-number>3</p>, <p class=cm-property>c</p>: <p class=cm-number>4</p>});\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>objectA</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_Rl8msr9DUz class=p_ident id=p_Rl8msr9DUz></a>Arrays, then, are just a kind of object specialized for storing sequences of things. If you evaluate <code>typeof []</code>, it produces <code>\"object\"</code>. You can see them as long, flat octopuses with all their tentacles in a neat row, labeled with numbers.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_d1H6/6O79A class=p_ident id=p_d1H6/6O79A></a>We will represent the journal that Jacques keeps as an array of objects.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_H7Np/tieSQ class=c_ident id=c_H7Np/tieSQ></a><p class=cm-keyword>let</p> <p class=cm-def>journal</p> <p class=cm-operator>=</p> [ {<p class=cm-property>events</p>: [<p class=cm-string>\"work\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"pizza\"</p>, <p class=cm-string>\"running\"</p>, <p class=cm-string>\"television\"</p>], <p class=cm-property>squirrel</p>: <p class=cm-atom>false</p>}, {<p class=cm-property>events</p>: [<p class=cm-string>\"work\"</p>, <p class=cm-string>\"ice cream\"</p>, <p class=cm-string>\"cauliflower\"</p>, <p class=cm-string>\"lasagna\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"brushed teeth\"</p>], <p class=cm-property>squirrel</p>: <p class=cm-atom>false</p>}, {<p class=cm-property>events</p>: [<p class=cm-string>\"weekend\"</p>, <p class=cm-string>\"cycling\"</p>, <p class=cm-string>\"break\"</p>, <p class=cm-string>\"peanuts\"</p>, <p class=cm-string>\"beer\"</p>], <p class=cm-property>squirrel</p>: <p class=cm-atom>true</p>},\n  \n];</pre> <h2><a href=https://eloquentjavascript.net/04_data.html#h_C3n45IkMhg class=h_ident id=h_C3n45IkMhg></a>Mutability</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_HZ50qDRWmj class=p_ident id=p_HZ50qDRWmj></a>We will get to actual programming <em>real</em> soon now. First there’s one more piece of theory to understand.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ZAtU8veKBN class=p_ident id=p_ZAtU8veKBN></a>We saw that object values can be modified. The types of values discussed in earlier chapters, such as numbers, strings, and Booleans, are all <em>immutable</em>—it is impossible to change values of those types. You can combine them and derive new values from them, but when you take a specific string value, that value will always remain the same. The text inside it cannot be changed. If you have a string that contains <code>\"cat\"</code>, it is not possible for other code to change a character in your string to make it spell <code>\"rat\"</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_0geJong3Bv class=p_ident id=p_0geJong3Bv></a>Objects work differently. You <em>can</em> change their properties, causing a single object value to have different content at different times.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_fVZ1xXAqW5 class=p_ident id=p_fVZ1xXAqW5></a>When we have two numbers, 120 and 120, we can consider them precisely the same number, whether or not they refer to the same physical bits. With objects, there is a difference between having two references to the same object and having two different objects that contain the same properties. Consider the following code:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_I1Dv6D46/p class=c_ident id=c_I1Dv6D46/p></a><p class=cm-keyword>let</p> <p class=cm-def>object1</p> <p class=cm-operator>=</p> {<p class=cm-property>value</p>: <p class=cm-number>10</p>};\n<p class=cm-keyword>let</p> <p class=cm-def>object2</p> <p class=cm-operator>=</p> <p class=cm-variable>object1</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>object3</p> <p class=cm-operator>=</p> {<p class=cm-property>value</p>: <p class=cm-number>10</p>}; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object1</p> <p class=cm-operator>==</p> <p class=cm-variable>object2</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object1</p> <p class=cm-operator>==</p> <p class=cm-variable>object3</p>); <p class=cm-variable>object1</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-number>15</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object2</p>.<p class=cm-property>value</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>object3</p>.<p class=cm-property>value</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_LKrvBk0ldY class=p_ident id=p_LKrvBk0ldY></a>The <code>object1</code> and <code>object2</code> bindings grasp the <em>same</em> object, which is why changing <code>object1</code> also changes the value of <code>object2</code>. They are said to have the same <em>identity</em>. The binding <code>object3</code> points to a different object, which initially contains the same properties as <code>object1</code> but lives a separate life.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_eic4GJbroA class=p_ident id=p_eic4GJbroA></a>Bindings can also be changeable or constant, but this is separate from the way their values behave. Even though number values don’t change, you can use a <code>let</code> binding to keep track of a changing number by changing the value the binding points at. Similarly, though a <code>const</code> binding to an object can itself not be changed and will continue to point at the same object, the <em>contents</em> of that object might change.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_eOXMRndYxO class=c_ident id=c_eOXMRndYxO></a><p class=cm-keyword>const</p> <p class=cm-def>score</p> <p class=cm-operator>=</p> {<p class=cm-property>visitors</p>: <p class=cm-number>0</p>, <p class=cm-property>home</p>: <p class=cm-number>0</p>}; <p class=cm-variable>score</p>.<p class=cm-property>visitors</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>; <p class=cm-variable>score</p> <p class=cm-operator>=</p> {<p class=cm-property>visitors</p>: <p class=cm-number>1</p>, <p class=cm-property>home</p>: <p class=cm-number>1</p>};</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_wD7jhXt+Tr class=p_ident id=p_wD7jhXt+Tr></a>When you compare objects with JavaScript’s <code>==</code> operator, it compares by identity: it will produce <code>true</code> only if both objects are precisely the same value. Comparing different objects will return <code>false</code>, even if they have identical properties. There is no “deep” comparison operation built into JavaScript, which compares objects by contents, but it is possible to write it yourself (which is one of the <a href=https://eloquentjavascript.net/04_data.html#exercise_deep_compare>exercises</a> at the end of this chapter).</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_qHGOoBxOeE class=h_ident id=h_qHGOoBxOeE></a>The lycanthrope’s log</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_z1vPsL0dwv class=p_ident id=p_z1vPsL0dwv></a>So, Jacques starts up his JavaScript interpreter and sets up the environment he needs to keep his journal.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_CI+dtzXW/x class=c_ident id=c_CI+dtzXW/x></a><p class=cm-keyword>let</p> <p class=cm-def>journal</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>function</p> <p class=cm-def>addEntry</p>(<p class=cm-def>events</p>, <p class=cm-def>squirrel</p>) { <p class=cm-variable>journal</p>.<p class=cm-property>push</p>({<p class=cm-property>events</p>, <p class=cm-property>squirrel</p>});\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_ljMiZolRIM class=p_ident id=p_ljMiZolRIM></a>Note that the object added to the journal looks a little odd. Instead of declaring properties like <code>events: events</code>, it just gives a property name. This is shorthand that means the same thing—if a property name in brace notation isn’t followed by a value, its value is taken from the binding with the same name.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_cm0psWaVgC class=p_ident id=p_cm0psWaVgC></a>So then, every evening at 10 p.m.—or sometimes the next morning, after climbing down from the top shelf of his bookcase—Jacques records the day.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_S+F+R2oIfR class=c_ident id=c_S+F+R2oIfR></a><p class=cm-variable>addEntry</p>([<p class=cm-string>\"work\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"pizza\"</p>, <p class=cm-string>\"running\"</p>, <p class=cm-string>\"television\"</p>], <p class=cm-atom>false</p>);\n<p class=cm-variable>addEntry</p>([<p class=cm-string>\"work\"</p>, <p class=cm-string>\"ice cream\"</p>, <p class=cm-string>\"cauliflower\"</p>, <p class=cm-string>\"lasagna\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"brushed teeth\"</p>], <p class=cm-atom>false</p>);\n<p class=cm-variable>addEntry</p>([<p class=cm-string>\"weekend\"</p>, <p class=cm-string>\"cycling\"</p>, <p class=cm-string>\"break\"</p>, <p class=cm-string>\"peanuts\"</p>, <p class=cm-string>\"beer\"</p>], <p class=cm-atom>true</p>);</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_7VcOxe4CEu class=p_ident id=p_7VcOxe4CEu></a>Once he has enough data points, he intends to use statistics to find out which of these events may be related to the squirrelifications.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_EedDVNQ30H class=p_ident id=p_EedDVNQ30H></a><em>Correlation</em> is a measure of dependence between statistical variables. A statistical variable is not quite the same as a programming variable. In statistics you typically have a set of <em>measurements</em>, and each variable is measured for every measurement. Correlation between variables is usually expressed as a value that ranges from -1 to 1. Zero correlation means the variables are not related. A correlation of one indicates that the two are perfectly related—if you know one, you also know the other. Negative one also means that the variables are perfectly related but that they are opposites—when one is true, the other is false.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_mq//xARuKm class=p_ident id=p_mq//xARuKm></a>To compute the measure of correlation between two Boolean variables, we can use the <em>phi coefficient</em> (<em>ϕ</em>). This is a formula whose input is a frequency table containing the number of times the different combinations of the variables were observed. The output of the formula is a number between -1 and 1 that describes the correlation.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_enPDgop6ZQ class=p_ident id=p_enPDgop6ZQ></a>We could take the event of eating pizza and put that in a frequency table like this, where each number indicates the amount of times that combination occurred in our measurements:</p><figure><img alt=\"Eating pizza versus turning into a squirrel\" src=https://eloquentjavascript.net/img/pizza-squirrel.svg></figure> <p><a href=https://eloquentjavascript.net/04_data.html#p_34XzN30BBH class=p_ident id=p_34XzN30BBH></a>If we call that table <em>n</em>, we can compute <em>ϕ</em> using the following formula:</p><div>\n<table><tbody><tr> <td><em>ϕ</em> =</td> <td> <p><em>n</em><sub>11</sub><em>n</em><sub>00</sub> − <em>n</em><sub>10</sub><em>n</em><sub>01</sub></p> <p>√<span> <span><em>n</em><sub>1•</sub><em>n</em><sub>0•</sub><em>n</em><sub>•1</sub><em>n</em><sub>•0</sub></span> </span></p> </td>\n</tr></tbody></table>\n</div> <p><a href=https://eloquentjavascript.net/04_data.html#p_BlqmmOB0tg class=p_ident id=p_BlqmmOB0tg></a>(If at this point you’re putting the book down to focus on a terrible flashback to 10th grade math class—hold on! I do not intend to torture you with endless pages of cryptic notation—it’s just this one formula for now. And even with this one, all we do is turn it into JavaScript.)</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_6U87ck4G90 class=p_ident id=p_6U87ck4G90></a>The notation <em>n</em><sub>01</sub> indicates the number of measurements where the first variable (squirrelness) is false (0) and the second variable (pizza) is true (1). In the pizza table, <em>n</em><sub>01</sub> is 9.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_pweIXp0GRF class=p_ident id=p_pweIXp0GRF></a>The value <em>n</em><sub>1•</sub> refers to the sum of all measurements where the first variable is true, which is 5 in the example table. Likewise, <em>n</em><sub>•0</sub> refers to the sum of the measurements where the second variable is false.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ACMn7uvFzz class=p_ident id=p_ACMn7uvFzz></a>So for the pizza table, the part above the division line (the dividend) would be 1×76−4×9 = 40, and the part below it (the divisor) would be the square root of 5×85×10×80, or √340000. This comes out to <em>ϕ</em> ≈ 0.069, which is tiny. Eating pizza does not appear to have influence on the transformations.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_YwedOm6SqZ class=h_ident id=h_YwedOm6SqZ></a>Computing correlation</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_jn2nhCXEpR class=p_ident id=p_jn2nhCXEpR></a>We can represent a two-by-two table in JavaScript with a four-element array (<code>[76, 9, 4, 1]</code>). We could also use other representations, such as an array containing two two-element arrays (<code>[[76, 9], [4, 1]]</code>) or an object with property names like <code>\"11\"</code> and <code>\"01\"</code>, but the flat array is simple and makes the expressions that access the table pleasantly short. We’ll interpret the indices to the array as two-bit binary numbers, where the leftmost (most significant) digit refers to the squirrel variable and the rightmost (least significant) digit refers to the event variable. For example, the binary number <code>10</code> refers to the case where Jacques did turn into a squirrel, but the event (say, “pizza”) didn’t occur. This happened four times. And since binary <code>10</code> is 2 in decimal notation, we will store this number at index 2 of the array.</p> <p id=phi_function><a href=https://eloquentjavascript.net/04_data.html#p_h+u9TgFTTH class=p_ident id=p_h+u9TgFTTH></a>This is the function that computes the <em>ϕ</em> coefficient from such an array:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_AnoNjFldkv class=c_ident id=c_AnoNjFldkv></a><p class=cm-keyword>function</p> <p class=cm-def>phi</p>(<p class=cm-def>table</p>) { <p class=cm-keyword>return</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>3</p>] <p class=cm-operator>*</p> <p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>-</p> <p class=cm-variable-2>table</p>[<p class=cm-number>2</p>] <p class=cm-operator>*</p> <p class=cm-variable-2>table</p>[<p class=cm-number>1</p>]) <p class=cm-operator>/</p> <p class=cm-variable>Math</p>.<p class=cm-property>sqrt</p>((<p class=cm-variable-2>table</p>[<p class=cm-number>2</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>3</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>1</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>1</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>3</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>2</p>]));\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>phi</p>([<p class=cm-number>76</p>, <p class=cm-number>9</p>, <p class=cm-number>4</p>, <p class=cm-number>1</p>]));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_DPLO2QZk5F class=p_ident id=p_DPLO2QZk5F></a>This is a direct translation of the <em>ϕ</em> formula into JavaScript. <code>Math.sqrt</code> is the square root function, as provided by the <code>Math</code> object in a standard JavaScript environment. We have to add two fields from the table to get fields like n<sub>1•</sub> because the sums of rows or columns are not stored directly in our data structure.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_GhEP5hEDnb class=p_ident id=p_GhEP5hEDnb></a>Jacques kept his journal for three months. The resulting data set is available in the <a href=https://eloquentjavascript.net/code#4>coding sandbox</a> for this chapter, where it is stored in the <code>JOURNAL</code> binding and in a downloadable <a href=https://eloquentjavascript.net/code/journal.js>file</a>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_sM+4QT8FKs class=p_ident id=p_sM+4QT8FKs></a>To extract a two-by-two table for a specific event from the journal, we must loop over all the entries and tally how many times the event occurs in relation to squirrel transformations.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_rfea+FwMb5 class=c_ident id=c_rfea+FwMb5></a><p class=cm-keyword>function</p> <p class=cm-def>tableFor</p>(<p class=cm-def>event</p>, <p class=cm-def>journal</p>) { <p class=cm-keyword>let</p> <p class=cm-def>table</p> <p class=cm-operator>=</p> [<p class=cm-number>0</p>, <p class=cm-number>0</p>, <p class=cm-number>0</p>, <p class=cm-number>0</p>]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>journal</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> <p class=cm-def>entry</p> <p class=cm-operator>=</p> <p class=cm-variable-2>journal</p>[<p class=cm-variable-2>i</p>], <p class=cm-def>index</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>entry</p>.<p class=cm-property>events</p>.<p class=cm-property>includes</p>(<p class=cm-variable-2>event</p>)) <p class=cm-variable-2>index</p> <p class=cm-operator>+=</p> <p class=cm-number>1</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>entry</p>.<p class=cm-property>squirrel</p>) <p class=cm-variable-2>index</p> <p class=cm-operator>+=</p> <p class=cm-number>2</p>; <p class=cm-variable-2>table</p>[<p class=cm-variable-2>index</p>] <p class=cm-operator>+=</p> <p class=cm-number>1</p>; } <p class=cm-keyword>return</p> <p class=cm-variable-2>table</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>tableFor</p>(<p class=cm-string>\"pizza\"</p>, <p class=cm-variable>JOURNAL</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_1/7IsMpwdF class=p_ident id=p_1/7IsMpwdF></a>Arrays have an <code>includes</code> method that checks whether a given value exists in the array. The function uses that to determine whether the event name it is interested in is part of the event list for a given day.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_2jmDtun7lQ class=p_ident id=p_2jmDtun7lQ></a>The body of the loop in <code>tableFor</code> figures out which box in the table each journal entry falls into by checking whether the entry contains the specific event it’s interested in and whether the event happens alongside a squirrel incident. The loop then adds one to the correct box in the table.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_f0iI+VuF1R class=p_ident id=p_f0iI+VuF1R></a>We now have the tools we need to compute individual correlations. The only step remaining is to find a correlation for every type of event that was recorded and see whether anything stands out.</p> <h2 id=for_of_loop><a href=https://eloquentjavascript.net/04_data.html#h_4WwZLib71C class=h_ident id=h_4WwZLib71C></a>Array loops</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_NcUX4h3Azc class=p_ident id=p_NcUX4h3Azc></a>In the <code>tableFor</code> function, there’s a loop like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_pE7VRrRQir class=c_ident id=c_pE7VRrRQir></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable>JOURNAL</p>.<p class=cm-property>length</p>; <p class=cm-variable>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> <p class=cm-def>entry</p> <p class=cm-operator>=</p> <p class=cm-variable>JOURNAL</p>[<p class=cm-variable>i</p>];\n  \n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_bofXG4HkzH class=p_ident id=p_bofXG4HkzH></a>This kind of loop is common in classical JavaScript—going over arrays one element at a time is something that comes up a lot, and to do that you’d run a counter over the length of the array and pick out each element in turn.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Xl/M0+NR/e class=p_ident id=p_Xl/M0+NR/e></a>There is a simpler way to write such loops in modern JavaScript.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_OXsCQPvDE1 class=c_ident id=c_OXsCQPvDE1></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>entry</p> <p class=cm-keyword>of</p> <p class=cm-variable>JOURNAL</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`${</p><p class=cm-variable>entry</p>.<p class=cm-property>events</p>.<p class=cm-property>length</p><p class=cm-string-2>}</p> <p class=cm-string-2>events.`</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_LDkHv2luaA class=p_ident id=p_LDkHv2luaA></a>When a <code>for</code> loop looks like this, with the word <code>of</code> after a variable definition, it will loop over the elements of the value given after <code>of</code>. This works not only for arrays but also for strings and some other data structures. We’ll discuss <em>how</em> it works in <a href=https://eloquentjavascript.net/06_object.html>Chapter 6</a>.</p> <h2 id=analysis><a href=https://eloquentjavascript.net/04_data.html#h_Lg5n7mjqw/ class=h_ident id=h_Lg5n7mjqw/ ></a>The final analysis</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_LI+01yIQON class=p_ident id=p_LI+01yIQON></a>We need to compute a correlation for every type of event that occurs in the data set. To do that, we first need to <em>find</em> every type of event.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_P6cqJZBL1M class=c_ident id=c_P6cqJZBL1M></a><p class=cm-keyword>function</p> <p class=cm-def>journalEvents</p>(<p class=cm-def>journal</p>) { <p class=cm-keyword>let</p> <p class=cm-def>events</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>entry</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>journal</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>event</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>entry</p>.<p class=cm-property>events</p>) { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>events</p>.<p class=cm-property>includes</p>(<p class=cm-variable-2>event</p>)) { <p class=cm-variable-2>events</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>event</p>); } } } <p class=cm-keyword>return</p> <p class=cm-variable-2>events</p>;\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>journalEvents</p>(<p class=cm-variable>JOURNAL</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_vBsW+TJrFo class=p_ident id=p_vBsW+TJrFo></a>By going over all the events and adding those that aren’t already in there to the <code>events</code> array, the function collects every type of event.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_HohHy+JZoP class=p_ident id=p_HohHy+JZoP></a>Using that, we can see all the correlations.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_7ws9oWaneM class=c_ident id=c_7ws9oWaneM></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>event</p> <p class=cm-keyword>of</p> <p class=cm-variable>journalEvents</p>(<p class=cm-variable>JOURNAL</p>)) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>event</p> <p class=cm-operator>+</p> <p class=cm-string>\":\"</p>, <p class=cm-variable>phi</p>(<p class=cm-variable>tableFor</p>(<p class=cm-variable>event</p>, <p class=cm-variable>JOURNAL</p>)));\n}\n\n\n\n\n\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_TiI6dIjE18 class=p_ident id=p_TiI6dIjE18></a>Most correlations seem to lie close to zero. Eating carrots, bread, or pudding apparently does not trigger squirrel-lycanthropy. It <em>does</em> seem to occur somewhat more often on weekends. Let’s filter the results to show only correlations greater than 0.1 or less than -0.1.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_hBXzmb7hPU class=c_ident id=c_hBXzmb7hPU></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>event</p> <p class=cm-keyword>of</p> <p class=cm-variable>journalEvents</p>(<p class=cm-variable>JOURNAL</p>)) { <p class=cm-keyword>let</p> <p class=cm-def>correlation</p> <p class=cm-operator>=</p> <p class=cm-variable>phi</p>(<p class=cm-variable>tableFor</p>(<p class=cm-variable>event</p>, <p class=cm-variable>JOURNAL</p>)); <p class=cm-keyword>if</p> (<p class=cm-variable>correlation</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0.1</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable>correlation</p> <p class=cm-operator>&lt;</p> <p class=cm-operator>-</p><p class=cm-number>0.1</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>event</p> <p class=cm-operator>+</p> <p class=cm-string>\":\"</p>, <p class=cm-variable>correlation</p>);\n  }\n}\n\n\n\n\n\n\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_SmM3fqump2 class=p_ident id=p_SmM3fqump2></a>Aha! There are two factors with a correlation that’s clearly stronger than the others. Eating peanuts has a strong positive effect on the chance of turning into a squirrel, whereas brushing his teeth has a significant negative effect.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_CGdrhu89cM class=p_ident id=p_CGdrhu89cM></a>Interesting. Let’s try something.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_x7WUJStSIp class=c_ident id=c_x7WUJStSIp></a><p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>entry</p> <p class=cm-keyword>of</p> <p class=cm-variable>JOURNAL</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>entry</p>.<p class=cm-property>events</p>.<p class=cm-property>includes</p>(<p class=cm-string>\"peanuts\"</p>) <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-operator>!</p><p class=cm-variable>entry</p>.<p class=cm-property>events</p>.<p class=cm-property>includes</p>(<p class=cm-string>\"brushed teeth\"</p>)) { <p class=cm-variable>entry</p>.<p class=cm-property>events</p>.<p class=cm-property>push</p>(<p class=cm-string>\"peanut teeth\"</p>); }\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>phi</p>(<p class=cm-variable>tableFor</p>(<p class=cm-string>\"peanut teeth\"</p>, <p class=cm-variable>JOURNAL</p>)));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_Ji3VLlNJjI class=p_ident id=p_Ji3VLlNJjI></a>That’s a strong result. The phenomenon occurs precisely when Jacques eats peanuts and fails to brush his teeth. If only he weren’t such a slob about dental hygiene, he’d have never even noticed his affliction.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_CLBAQ41EVq class=p_ident id=p_CLBAQ41EVq></a>Knowing this, Jacques stops eating peanuts altogether and finds that his transformations don’t come back.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_IMX7LE4P7A class=p_ident id=p_IMX7LE4P7A></a>For a few years, things go great for Jacques. But at some point he loses his job. Because he lives in a nasty country where having no job means having no medical services, he is forced to take employment with a circus where he performs as <em>The Incredible Squirrelman</em>, stuffing his mouth with peanut butter before every show.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_SK7dEwTJMB class=p_ident id=p_SK7dEwTJMB></a>One day, fed up with this pitiful existence, Jacques fails to change back into his human form, hops through a crack in the circus tent, and vanishes into the forest. He is never seen again.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_GFaxee4PuU class=h_ident id=h_GFaxee4PuU></a>Further arrayology</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_Wik6gRMuIP class=p_ident id=p_Wik6gRMuIP></a>Before finishing the chapter, I want to introduce you to a few more object-related concepts. I’ll start by introducing some generally useful array methods.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Px7nduaW01 class=p_ident id=p_Px7nduaW01></a>We saw <code>push</code> and <code>pop</code>, which add and remove elements at the end of an array, <a href=https://eloquentjavascript.net/04_data.html#array_methods>earlier</a> in this chapter. The corresponding methods for adding and removing things at the start of an array are called <code>unshift</code> and <code>shift</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_Vq1IBpy+hP class=c_ident id=c_Vq1IBpy+hP></a><p class=cm-keyword>let</p> <p class=cm-def>todoList</p> <p class=cm-operator>=</p> [];\n<p class=cm-keyword>function</p> <p class=cm-def>remember</p>(<p class=cm-def>task</p>) { <p class=cm-variable>todoList</p>.<p class=cm-property>push</p>(<p class=cm-variable-2>task</p>);\n}\n<p class=cm-keyword>function</p> <p class=cm-def>getTask</p>() { <p class=cm-keyword>return</p> <p class=cm-variable>todoList</p>.<p class=cm-property>shift</p>();\n}\n<p class=cm-keyword>function</p> <p class=cm-def>rememberUrgently</p>(<p class=cm-def>task</p>) { <p class=cm-variable>todoList</p>.<p class=cm-property>unshift</p>(<p class=cm-variable-2>task</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_Z35J/zKDAQ class=p_ident id=p_Z35J/zKDAQ></a>That program manages a queue of tasks. You add tasks to the end of the queue by calling <code>remember(\"groceries\")</code>, and when you’re ready to do something, you call <code>getTask()</code> to get (and remove) the front item from the queue. The <code>rememberUrgently</code> function also adds a task but adds it to the front instead of the back of the queue.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_7VffwcInkI class=p_ident id=p_7VffwcInkI></a>To search for a specific value, arrays provide an <code>indexOf</code> method. The method searches through the array from the start to the end and returns the index at which the requested value was found—or -1 if it wasn’t found. To search from the end instead of the start, there’s a similar method called <code>lastIndexOf</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_N+G0EtTfto class=c_ident id=c_N+G0EtTfto></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>2</p>, <p class=cm-number>1</p>].<p class=cm-property>indexOf</p>(<p class=cm-number>2</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>2</p>, <p class=cm-number>1</p>].<p class=cm-property>lastIndexOf</p>(<p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_zErdHcwkcD class=p_ident id=p_zErdHcwkcD></a>Both <code>indexOf</code> and <code>lastIndexOf</code> take an optional second argument that indicates where to start searching.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_xl0kBHXnu2 class=p_ident id=p_xl0kBHXnu2></a>Another fundamental array method is <code>slice</code>, which takes start and end indices and returns an array that has only the elements between them. The start index is inclusive, the end index exclusive.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_zCBzPnMpIk class=c_ident id=c_zCBzPnMpIk></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>0</p>, <p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>].<p class=cm-property>slice</p>(<p class=cm-number>2</p>, <p class=cm-number>4</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-number>0</p>, <p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>].<p class=cm-property>slice</p>(<p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_Y6nY8puZtN class=p_ident id=p_Y6nY8puZtN></a>When the end index is not given, <code>slice</code> will take all of the elements after the start index. You can also omit the start index to copy the entire array.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_QNFIcCtVLd class=p_ident id=p_QNFIcCtVLd></a>The <code>concat</code> method can be used to glue arrays together to create a new array, similar to what the <code>+</code> operator does for strings.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_x8OwNmbLzo class=p_ident id=p_x8OwNmbLzo></a>The following example shows both <code>concat</code> and <code>slice</code> in action. It takes an array and an index, and it returns a new array that is a copy of the original array with the element at the given index removed.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_q+NBMNgFFy class=c_ident id=c_q+NBMNgFFy></a><p class=cm-keyword>function</p> <p class=cm-def>remove</p>(<p class=cm-def>array</p>, <p class=cm-def>index</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>array</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>index</p>) .<p class=cm-property>concat</p>(<p class=cm-variable-2>array</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>index</p> <p class=cm-operator>+</p> <p class=cm-number>1</p>));\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>remove</p>([<p class=cm-string>\"a\"</p>, <p class=cm-string>\"b\"</p>, <p class=cm-string>\"c\"</p>, <p class=cm-string>\"d\"</p>, <p class=cm-string>\"e\"</p>], <p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_RxH5uQN5Uq class=p_ident id=p_RxH5uQN5Uq></a>If you pass <code>concat</code> an argument that is not an array, that value will be added to the new array as if it were a one-element array.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_mT4YQfwHp6 class=h_ident id=h_mT4YQfwHp6></a>Strings and their properties</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_sp+O+Km+2n class=p_ident id=p_sp+O+Km+2n></a>We can read properties like <code>length</code> and <code>toUpperCase</code> from string values. But if you try to add a new property, it doesn’t stick.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_xvzL9wErq7 class=c_ident id=c_xvzL9wErq7></a><p class=cm-keyword>let</p> <p class=cm-def>kim</p> <p class=cm-operator>=</p> <p class=cm-string>\"Kim\"</p>;\n<p class=cm-variable>kim</p>.<p class=cm-property>age</p> <p class=cm-operator>=</p> <p class=cm-number>88</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>kim</p>.<p class=cm-property>age</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_B+oSPYAIbV class=p_ident id=p_B+oSPYAIbV></a>Values of type string, number, and Boolean are not objects, and though the language doesn’t complain if you try to set new properties on them, it doesn’t actually store those properties. As mentioned earlier, such values are immutable and cannot be changed.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_8L2ib2beYN class=p_ident id=p_8L2ib2beYN></a>But these types do have built-in properties. Every string value has a number of methods. Some very useful ones are <code>slice</code> and <code>indexOf</code>, which resemble the array methods of the same name.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_/Tmq1doYeG class=c_ident id=c_/Tmq1doYeG></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"coconuts\"</p>.<p class=cm-property>slice</p>(<p class=cm-number>4</p>, <p class=cm-number>7</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"coconut\"</p>.<p class=cm-property>indexOf</p>(<p class=cm-string>\"u\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_RUd6q+Q4dc class=p_ident id=p_RUd6q+Q4dc></a>One difference is that a string’s <code>indexOf</code> can search for a string containing more than one character, whereas the corresponding array method looks only for a single element.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_xM5/GBnZVG class=c_ident id=c_xM5/GBnZVG></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"one two three\"</p>.<p class=cm-property>indexOf</p>(<p class=cm-string>\"ee\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_USclxilOGS class=p_ident id=p_USclxilOGS></a>The <code>trim</code> method removes whitespace (spaces, newlines, tabs, and similar characters) from the start and end of a string.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_0AfLRWyjq0 class=c_ident id=c_0AfLRWyjq0></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\" okay \\n \"</p>.<p class=cm-property>trim</p>());\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_pSkK9k9R0g class=p_ident id=p_pSkK9k9R0g></a>The <code>zeroPad</code> function from the <a href=https://eloquentjavascript.net/03_functions.html>previous chapter</a> also exists as a method. It is called <code>padStart</code> and takes the desired length and padding character as arguments.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_SJbD9MiYu+ class=c_ident id=c_SJbD9MiYu+></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>String</p>(<p class=cm-number>6</p>).<p class=cm-property>padStart</p>(<p class=cm-number>3</p>, <p class=cm-string>\"0\"</p>));\n</pre> <p id=split><a href=https://eloquentjavascript.net/04_data.html#p_/nMvmESoIj class=p_ident id=p_/nMvmESoIj></a>You can split a string on every occurrence of another string with <code>split</code> and join it again with <code>join</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_/rV2Ed5e8V class=c_ident id=c_/rV2Ed5e8V></a><p class=cm-keyword>let</p> <p class=cm-def>sentence</p> <p class=cm-operator>=</p> <p class=cm-string>\"Secretarybirds specialize in stomping\"</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>words</p> <p class=cm-operator>=</p> <p class=cm-variable>sentence</p>.<p class=cm-property>split</p>(<p class=cm-string>\" \"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>words</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>words</p>.<p class=cm-property>join</p>(<p class=cm-string>\". \"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_EKC26dOCjK class=p_ident id=p_EKC26dOCjK></a>A string can be repeated with the <code>repeat</code> method, which creates a new string containing multiple copies of the original string, glued together.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_70WotkNADb class=c_ident id=c_70WotkNADb></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"LA\"</p>.<p class=cm-property>repeat</p>(<p class=cm-number>3</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_JoGJxr+Ofe class=p_ident id=p_JoGJxr+Ofe></a>We have already seen the string type’s <code>length</code> property. Accessing the individual characters in a string looks like accessing array elements (with a caveat that we’ll discuss in <a href=https://eloquentjavascript.net/05_higher_order.html#code_units>Chapter 5</a>).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_Aeop9AuKAb class=c_ident id=c_Aeop9AuKAb></a><p class=cm-keyword>let</p> <p class=cm-def>string</p> <p class=cm-operator>=</p> <p class=cm-string>\"abc\"</p>;\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>string</p>.<p class=cm-property>length</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>string</p>[<p class=cm-number>1</p>]);\n</pre> <h2 id=rest_parameters><a href=https://eloquentjavascript.net/04_data.html#h_hX9DkIBp9y class=h_ident id=h_hX9DkIBp9y></a>Rest parameters</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_4Vr2QMYcHp class=p_ident id=p_4Vr2QMYcHp></a>It can be useful for a function to accept any number of arguments. For example, <code>Math.max</code> computes the maximum of <em>all</em> the arguments it is given.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_eWuSc6aG2b class=p_ident id=p_eWuSc6aG2b></a>To write such a function, you put three dots before the function’s last parameter, like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_UXPbyGFVIB class=c_ident id=c_UXPbyGFVIB></a><p class=cm-keyword>function</p> <p class=cm-def>max</p>(<p class=cm-def>numbers</p>) { <p class=cm-keyword>let</p> <p class=cm-def>result</p> <p class=cm-operator>=</p> <p class=cm-operator>-</p><p class=cm-atom>Infinity</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>number</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>numbers</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>number</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>result</p>) <p class=cm-variable-2>result</p> <p class=cm-operator>=</p> <p class=cm-variable-2>number</p>; } <p class=cm-keyword>return</p> <p class=cm-variable-2>result</p>;\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>max</p>(<p class=cm-number>4</p>, <p class=cm-number>1</p>, <p class=cm-number>9</p>, <p class=cm-operator>-</p><p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_rGoFNpUuEy class=p_ident id=p_rGoFNpUuEy></a>When such a function is called, the <em>rest parameter</em> is bound to an array containing all further arguments. If there are other parameters before it, their values aren’t part of that array. When, as in <code>max</code>, it is the only parameter, it will hold all arguments.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ZVL6nOj2oy class=p_ident id=p_ZVL6nOj2oy></a>You can use a similar three-dot notation to <em>call</em> a function with an array of arguments.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_h9hmTe3vix class=c_ident id=c_h9hmTe3vix></a><p class=cm-keyword>let</p> <p class=cm-def>numbers</p> <p class=cm-operator>=</p> [<p class=cm-number>5</p>, <p class=cm-number>1</p>, <p class=cm-number>7</p>];\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>max</p>(<p class=cm-variable>numbers</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_Q6Tzyy9eaj class=p_ident id=p_Q6Tzyy9eaj></a>This “spreads” out the array into the function call, passing its elements as separate arguments. It is possible to include an array like that along with other arguments, as in <code>max(9, .<wbr>.<wbr>.<wbr>numbers, 2)</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_/SfVO/tjcB class=p_ident id=p_/SfVO/tjcB></a>Square bracket array notation similarly allows the triple-dot operator to spread another array into the new array.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_4t+LJt3Kyo class=c_ident id=c_4t+LJt3Kyo></a><p class=cm-keyword>let</p> <p class=cm-def>words</p> <p class=cm-operator>=</p> [<p class=cm-string>\"never\"</p>, <p class=cm-string>\"fully\"</p>];\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>([<p class=cm-string>\"will\"</p>, <p class=cm-variable>words</p>, <p class=cm-string>\"understand\"</p>]);\n</pre> <h2><a href=https://eloquentjavascript.net/04_data.html#h_C51DnYk8WZ class=h_ident id=h_C51DnYk8WZ></a>The Math object</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_h3aa0itA5J class=p_ident id=p_h3aa0itA5J></a>As we’ve seen, <code>Math</code> is a grab bag of number-related utility functions, such as <code>Math.max</code> (maximum), <code>Math.min</code> (minimum), and <code>Math.sqrt</code> (square root).</p> <p id=namespace_pollution><a href=https://eloquentjavascript.net/04_data.html#p_Sae3fXYP2/ class=p_ident id=p_Sae3fXYP2/ ></a>The <code>Math</code> object is used as a container to group a bunch of related functionality. There is only one <code>Math</code> object, and it is almost never useful as a value. Rather, it provides a <em>namespace</em> so that all these functions and values do not have to be global bindings.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_fGEMziAXhp class=p_ident id=p_fGEMziAXhp></a>Having too many global bindings “pollutes” the namespace. The more names have been taken, the more likely you are to accidentally overwrite the value of some existing binding. For example, it’s not unlikely to want to name something <code>max</code> in one of your programs. Since JavaScript’s built-in <code>max</code> function is tucked safely inside the <code>Math</code> object, we don’t have to worry about overwriting it.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_6OHrUF+WEc class=p_ident id=p_6OHrUF+WEc></a>Many languages will stop you, or at least warn you, when you are defining a binding with a name that is already taken. JavaScript does this for bindings you declared with <code>let</code> or <code>const</code> but—perversely—not for standard bindings nor for bindings declared with <code>var</code> or <code>function</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_zWXQRNgLI/ class=p_ident id=p_zWXQRNgLI/ ></a>Back to the <code>Math</code> object. If you need to do trigonometry, <code>Math</code> can help. It contains <code>cos</code> (cosine), <code>sin</code> (sine), and <code>tan</code> (tangent), as well as their inverse functions, <code>acos</code>, <code>asin</code>, and <code>atan</code>, respectively. The number π (pi)—or at least the closest approximation that fits in a JavaScript number—is available as <code>Math.PI</code>. There is an old programming tradition of writing the names of constant values in all caps.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_54zxf+2nsU class=c_ident id=c_54zxf+2nsU></a><p class=cm-keyword>function</p> <p class=cm-def>randomPointOnCircle</p>(<p class=cm-def>radius</p>) { <p class=cm-keyword>let</p> <p class=cm-def>angle</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-number>2</p> <p class=cm-operator>*</p> <p class=cm-variable>Math</p>.<p class=cm-property>PI</p>; <p class=cm-keyword>return</p> {<p class=cm-property>x</p>: <p class=cm-variable-2>radius</p> <p class=cm-operator>*</p> <p class=cm-variable>Math</p>.<p class=cm-property>cos</p>(<p class=cm-variable-2>angle</p>), <p class=cm-property>y</p>: <p class=cm-variable-2>radius</p> <p class=cm-operator>*</p> <p class=cm-variable>Math</p>.<p class=cm-property>sin</p>(<p class=cm-variable-2>angle</p>)};\n}\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>randomPointOnCircle</p>(<p class=cm-number>2</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_KN16iaNdwJ class=p_ident id=p_KN16iaNdwJ></a>If sines and cosines are not something you are familiar with, don’t worry. When they are used in this book, in <a href=https://eloquentjavascript.net/14_dom.html#sin_cos>Chapter 14</a>, I’ll explain them.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_a6xMq73yCc class=p_ident id=p_a6xMq73yCc></a>The previous example used <code>Math.random</code>. This is a function that returns a new pseudorandom number between zero (inclusive) and one (exclusive) every time you call it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_+gqW4B1qk1 class=c_ident id=c_+gqW4B1qk1></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>()); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>());\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_wukRTlH+QE class=p_ident id=p_wukRTlH+QE></a>Though computers are deterministic machines—they always react the same way if given the same input—it is possible to have them produce numbers that appear random. To do that, the machine keeps some hidden value, and whenever you ask for a new random number, it performs complicated computations on this hidden value to create a new value. It stores a new value and returns some number derived from it. That way, it can produce ever new, hard-to-predict numbers in a way that <em>seems</em> random.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_2guGKjrtTY class=p_ident id=p_2guGKjrtTY></a>If we want a whole random number instead of a fractional one, we can use <code>Math.floor</code> (which rounds down to the nearest whole number) on the result of <code>Math.random</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_LlfOX4tbSH class=c_ident id=c_LlfOX4tbSH></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-number>10</p>));\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_qcgl/8YUFj class=p_ident id=p_qcgl/8YUFj></a>Multiplying the random number by 10 gives us a number greater than or equal to 0 and below 10. Since <code>Math.floor</code> rounds down, this expression will produce, with equal chance, any number from 0 through 9.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_4Vo+PhEiYY class=p_ident id=p_4Vo+PhEiYY></a>There are also the functions <code>Math.ceil</code> (for “ceiling”, which rounds up to a whole number), <code>Math.round</code> (to the nearest whole number), and <code>Math.abs</code>, which takes the absolute value of a number, meaning it negates negative values but leaves positive ones as they are.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_B372u36cp6 class=h_ident id=h_B372u36cp6></a>Destructuring</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_YaENzwA635 class=p_ident id=p_YaENzwA635></a>Let’s go back to the <code>phi</code> function for a moment.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_8p90ivE8ZI class=c_ident id=c_8p90ivE8ZI></a><p class=cm-keyword>function</p> <p class=cm-def>phi</p>(<p class=cm-def>table</p>) { <p class=cm-keyword>return</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>3</p>] <p class=cm-operator>*</p> <p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>-</p> <p class=cm-variable-2>table</p>[<p class=cm-number>2</p>] <p class=cm-operator>*</p> <p class=cm-variable-2>table</p>[<p class=cm-number>1</p>]) <p class=cm-operator>/</p> <p class=cm-variable>Math</p>.<p class=cm-property>sqrt</p>((<p class=cm-variable-2>table</p>[<p class=cm-number>2</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>3</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>1</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>1</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>3</p>]) <p class=cm-operator>*</p> (<p class=cm-variable-2>table</p>[<p class=cm-number>0</p>] <p class=cm-operator>+</p> <p class=cm-variable-2>table</p>[<p class=cm-number>2</p>]));\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_KYh2WplVnQ class=p_ident id=p_KYh2WplVnQ></a>One of the reasons this function is awkward to read is that we have a binding pointing at our array, but we’d much prefer to have bindings for the <em>elements</em> of the array, that is, <code>let n00 = table[0]</code> and so on. Fortunately, there is a succinct way to do this in JavaScript.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_z2cboTL/zX class=c_ident id=c_z2cboTL/zX></a><p class=cm-keyword>function</p> <p class=cm-def>phi</p>([<p class=cm-def>n00</p>, <p class=cm-def>n01</p>, <p class=cm-def>n10</p>, <p class=cm-def>n11</p>]) { <p class=cm-keyword>return</p> (<p class=cm-variable-2>n11</p> <p class=cm-operator>*</p> <p class=cm-variable-2>n00</p> <p class=cm-operator>-</p> <p class=cm-variable-2>n10</p> <p class=cm-operator>*</p> <p class=cm-variable-2>n01</p>) <p class=cm-operator>/</p> <p class=cm-variable>Math</p>.<p class=cm-property>sqrt</p>((<p class=cm-variable-2>n10</p> <p class=cm-operator>+</p> <p class=cm-variable-2>n11</p>) <p class=cm-operator>*</p> (<p class=cm-variable-2>n00</p> <p class=cm-operator>+</p> <p class=cm-variable-2>n01</p>) <p class=cm-operator>*</p> (<p class=cm-variable-2>n01</p> <p class=cm-operator>+</p> <p class=cm-variable-2>n11</p>) <p class=cm-operator>*</p> (<p class=cm-variable-2>n00</p> <p class=cm-operator>+</p> <p class=cm-variable-2>n10</p>));\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_kBO/cFWeM1 class=p_ident id=p_kBO/cFWeM1></a>This also works for bindings created with <code>let</code>, <code>var</code>, or <code>const</code>. If you know the value you are binding is an array, you can use square brackets to “look inside” of the value, binding its contents.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Zr6hFslmUP class=p_ident id=p_Zr6hFslmUP></a>A similar trick works for objects, using braces instead of square brackets.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_ZXEdn9Xbfc class=c_ident id=c_ZXEdn9Xbfc></a><p class=cm-keyword>let</p> {<p class=cm-def>name</p>} <p class=cm-operator>=</p> {<p class=cm-property>name</p>: <p class=cm-string>\"Faraji\"</p>, <p class=cm-property>age</p>: <p class=cm-number>23</p>};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>name</p>);\n</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_1RhWeB9//B class=p_ident id=p_1RhWeB9//B></a>Note that if you try to destructure <code>null</code> or <code>undefined</code>, you get an error, much as you would if you directly try to access a property of those values.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_AxpOdvCznQ class=h_ident id=h_AxpOdvCznQ></a>JSON</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_7o8VSa4Rvc class=p_ident id=p_7o8VSa4Rvc></a>Because properties only grasp their value, rather than contain it, objects and arrays are stored in the computer’s memory as sequences of bits holding the <em>addresses</em>—the place in memory—of their contents. So an array with another array inside of it consists of (at least) one memory region for the inner array, and another for the outer array, containing (among other things) a binary number that represents the position of the inner array.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_aF+08iJEQw class=p_ident id=p_aF+08iJEQw></a>If you want to save data in a file for later or send it to another computer over the network, you have to somehow convert these tangles of memory addresses to a description that can be stored or sent. You <em>could</em> send over your entire computer memory along with the address of the value you’re interested in, I suppose, but that doesn’t seem like the best approach.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ZM103Qyv6l class=p_ident id=p_ZM103Qyv6l></a>What we can do is <em>serialize</em> the data. That means it is converted into a flat description. A popular serialization format is called <em>JSON</em> (pronounced “Jason”), which stands for JavaScript Object Notation. It is widely used as a data storage and communication format on the Web, even in languages other than JavaScript.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_IMEKAvSfAI class=p_ident id=p_IMEKAvSfAI></a>JSON looks similar to JavaScript’s way of writing arrays and objects, with a few restrictions. All property names have to be surrounded by double quotes, and only simple data expressions are allowed—no function calls, bindings, or anything that involves actual computation. Comments are not allowed in JSON.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_9DCLKzKNiz class=p_ident id=p_9DCLKzKNiz></a>A journal entry might look like this when represented as JSON data:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_A3jdCqz1Q6 class=c_ident id=c_A3jdCqz1Q6></a>{ <p class=cm-string>\"squirrel\"</p>: <p class=cm-atom>false</p>, <p class=cm-string>\"events\"</p>: [<p class=cm-string>\"work\"</p>, <p class=cm-string>\"touched tree\"</p>, <p class=cm-string>\"pizza\"</p>, <p class=cm-string>\"running\"</p>]\n}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_1IU60Zh2Af class=p_ident id=p_1IU60Zh2Af></a>JavaScript gives us the functions <code>JSON.stringify</code> and <code>JSON.parse</code> to convert data to and from this format. The first takes a JavaScript value and returns a JSON-encoded string. The second takes such a string and converts it to the value it encodes.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_HYCgCsK7z1 class=c_ident id=c_HYCgCsK7z1></a><p class=cm-keyword>let</p> <p class=cm-def>string</p> <p class=cm-operator>=</p> <p class=cm-variable>JSON</p>.<p class=cm-property>stringify</p>({<p class=cm-property>squirrel</p>: <p class=cm-atom>false</p>, <p class=cm-property>events</p>: [<p class=cm-string>\"weekend\"</p>]});\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>string</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>JSON</p>.<p class=cm-property>parse</p>(<p class=cm-variable>string</p>).<p class=cm-property>events</p>);\n</pre> <h2><a href=https://eloquentjavascript.net/04_data.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/04_data.html#p_78ZfHX5x1B class=p_ident id=p_78ZfHX5x1B></a>Objects and arrays (which are a specific kind of object) provide ways to group several values into a single value. Conceptually, this allows us to put a bunch of related things in a bag and run around with the bag, instead of wrapping our arms around all of the individual things and trying to hold on to them separately.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ayhyxvWlMH class=p_ident id=p_ayhyxvWlMH></a>Most values in JavaScript have properties, the exceptions being <code>null</code> and <code>undefined</code>. Properties are accessed using <code>value.prop</code> or <code>value[\"prop\"]</code>. Objects tend to use names for their properties and store more or less a fixed set of them. Arrays, on the other hand, usually contain varying amounts of conceptually identical values and use numbers (starting from 0) as the names of their properties.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_1lcitbawCQ class=p_ident id=p_1lcitbawCQ></a>There <em>are</em> some named properties in arrays, such as <code>length</code> and a number of methods. Methods are functions that live in properties and (usually) act on the value they are a property of.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_KWzs1al6OP class=p_ident id=p_KWzs1al6OP></a>You can iterate over arrays using a special kind of <code>for</code> loop—<code>for (let element of array)</code>.</p> <h2><a href=https://eloquentjavascript.net/04_data.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/04_data.html#i_8ZspxiCEC/ class=i_ident id=i_8ZspxiCEC/ ></a>The sum of a range</h3> <p><a href=https://eloquentjavascript.net/04_data.html#p_fpyyiv/hm1 class=p_ident id=p_fpyyiv/hm1></a>The <a href=https://eloquentjavascript.net/00_intro.html>introduction</a> of this book alluded to the following as a nice way to compute the sum of a range of numbers:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_KTbQMmMCli class=c_ident id=c_KTbQMmMCli></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sum</p>(<p class=cm-variable>range</p>(<p class=cm-number>1</p>, <p class=cm-number>10</p>)));</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_uTMnVb6I1m class=p_ident id=p_uTMnVb6I1m></a>Write a <code>range</code> function that takes two arguments, <code>start</code> and <code>end</code>, and returns an array containing all the numbers from <code>start</code> up to (and including) <code>end</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_0GiJNcBSop class=p_ident id=p_0GiJNcBSop></a>Next, write a <code>sum</code> function that takes an array of numbers and returns the sum of these numbers. Run the example program and see whether it does indeed return 55.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_1Uvf7bfQT8 class=p_ident id=p_1Uvf7bfQT8></a>As a bonus assignment, modify your <code>range</code> function to take an optional third argument that indicates the “step” value used when building the array. If no step is given, the elements go up by increments of one, corresponding to the old behavior. The function call <code>range(1, 10, 2)</code> should return <code>[1, 3, 5, 7, 9]</code>. Make sure it also works with negative step values so that <code>range(5, 2, -1)</code> produces <code>[5, 4, 3, 2]</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_gV3XCKJAqj class=c_ident id=c_gV3XCKJAqj></a> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>range</p>(<p class=cm-number>1</p>, <p class=cm-number>10</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>range</p>(<p class=cm-number>5</p>, <p class=cm-number>2</p>, <p class=cm-operator>-</p><p class=cm-number>1</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>sum</p>(<p class=cm-variable>range</p>(<p class=cm-number>1</p>, <p class=cm-number>10</p>)));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/04_data.html#p_AzWVqPrlre class=p_ident id=p_AzWVqPrlre></a>Building up an array is most easily done by first initializing a binding to <code>[]</code> (a fresh, empty array) and repeatedly calling its <code>push</code> method to add a value. Don’t forget to return the array at the end of the function.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_eu6MUPwjEb class=p_ident id=p_eu6MUPwjEb></a>Since the end boundary is inclusive, you’ll need to use the <code>&lt;=</code> operator rather than <code>&lt;</code> to check for the end of your loop.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_kvr5NnqBEW class=p_ident id=p_kvr5NnqBEW></a>The step parameter can be an optional parameter that defaults (using the <code>=</code> operator) to 1.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_zih2wFkrk5 class=p_ident id=p_zih2wFkrk5></a>Having <code>range</code> understand negative step values is probably best done by writing two separate loops—one for counting up and one for counting down—because the comparison that checks whether the loop is finished needs to be <code>&gt;=</code> rather than <code>&lt;=</code> when counting downward.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_d7Vi2uDSps class=p_ident id=p_d7Vi2uDSps></a>It might also be worthwhile to use a different default step, namely, -1, when the end of the range is smaller than the start. That way, <code>range(5, 2)</code> returns something meaningful, rather than getting stuck in an infinite loop. It is possible to refer to previous parameters in the default value of a parameter.</p> </div></div> <h3><a href=https://eloquentjavascript.net/04_data.html#i_6xTmjj4Rf5 class=i_ident id=i_6xTmjj4Rf5></a>Reversing an array</h3> <p><a href=https://eloquentjavascript.net/04_data.html#p_+SVCOC/qcN class=p_ident id=p_+SVCOC/qcN></a>Arrays have a <code>reverse</code> method that changes the array by inverting the order in which its elements appear. For this exercise, write two functions, <code>reverseArray</code> and <code>reverseArrayInPlace</code>. The first, <code>reverseArray</code>, takes an array as argument and produces a <em>new</em> array that has the same elements in the inverse order. The second, <code>reverseArrayInPlace</code>, does what the <code>reverse</code> method does: it <em>modifies</em> the array given as argument by reversing its elements. Neither may use the standard <code>reverse</code> method.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_SpaDJmGkSI class=p_ident id=p_SpaDJmGkSI></a>Thinking back to the notes about side effects and pure functions in the <a href=https://eloquentjavascript.net/03_functions.html#pure>previous chapter</a>, which variant do you expect to be useful in more situations? Which one runs faster?</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_sghv5avX0H class=c_ident id=c_sghv5avX0H></a> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>reverseArray</p>([<p class=cm-string>\"A\"</p>, <p class=cm-string>\"B\"</p>, <p class=cm-string>\"C\"</p>])); <p class=cm-keyword>let</p> <p class=cm-def>arrayValue</p> <p class=cm-operator>=</p> [<p class=cm-number>1</p>, <p class=cm-number>2</p>, <p class=cm-number>3</p>, <p class=cm-number>4</p>, <p class=cm-number>5</p>];\n<p class=cm-variable>reverseArrayInPlace</p>(<p class=cm-variable>arrayValue</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>arrayValue</p>);\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/04_data.html#p_bJlW8Cyw1e class=p_ident id=p_bJlW8Cyw1e></a>There are two obvious ways to implement <code>reverseArray</code>. The first is to simply go over the input array from front to back and use the <code>unshift</code> method on the new array to insert each element at its start. The second is to loop over the input array backwards and use the <code>push</code> method. Iterating over an array backwards requires a (somewhat awkward) <code>for</code> specification, like <code>(let i = array.<wbr>length - 1; i &gt;= 0; i--)</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Y08sN3Yej5 class=p_ident id=p_Y08sN3Yej5></a>Reversing the array in place is harder. You have to be careful not to overwrite elements that you will later need. Using <code>reverseArray</code> or otherwise copying the whole array (<code>array.slice(0)</code> is a good way to copy an array) works but is cheating.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_hzYSkS4zzl class=p_ident id=p_hzYSkS4zzl></a>The trick is to <em>swap</em> the first and last elements, then the second and second-to-last, and so on. You can do this by looping over half the length of the array (use <code>Math.floor</code> to round down—you don’t need to touch the middle element in an array with an odd number of elements) and swapping the element at position <code>i</code> with the one at position <code>array.<wbr>length - 1 - i</code>. You can use a local binding to briefly hold on to one of the elements, overwrite that one with its mirror image, and then put the value from the local binding in the place where the mirror image used to be.</p> </div></div> <h3 id=list><a href=https://eloquentjavascript.net/04_data.html#i_nSTX34CM1M class=i_ident id=i_nSTX34CM1M></a>A list</h3> <p><a href=https://eloquentjavascript.net/04_data.html#p_7AnSuS26HF class=p_ident id=p_7AnSuS26HF></a>Objects, as generic blobs of values, can be used to build all sorts of data structures. A common data structure is the <em>list</em> (not to be confused with array). A list is a nested set of objects, with the first object holding a reference to the second, the second to the third, and so on.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_kYAco70aHD class=c_ident id=c_kYAco70aHD></a><p class=cm-keyword>let</p> <p class=cm-def>list</p> <p class=cm-operator>=</p> { <p class=cm-property>value</p>: <p class=cm-number>1</p>, <p class=cm-property>rest</p>: { <p class=cm-property>value</p>: <p class=cm-number>2</p>, <p class=cm-property>rest</p>: { <p class=cm-property>value</p>: <p class=cm-number>3</p>, <p class=cm-property>rest</p>: <p class=cm-atom>null</p>\n    }\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_2un5u6U14Q class=p_ident id=p_2un5u6U14Q></a>The resulting objects form a chain, like this:</p><figure><img alt=\"A linked list\" src=https://eloquentjavascript.net/img/linked-list.svg></figure> <p><a href=https://eloquentjavascript.net/04_data.html#p_NaI0fhp38z class=p_ident id=p_NaI0fhp38z></a>A nice thing about lists is that they can share parts of their structure. For example, if I create two new values <code>{value: 0, rest: list}</code> and <code>{value: -1, rest: list}</code> (with <code>list</code> referring to the binding defined earlier), they are both independent lists, but they share the structure that makes up their last three elements. The original list is also still a valid three-element list.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_iPlgVCeZGh class=p_ident id=p_iPlgVCeZGh></a>Write a function <code>arrayToList</code> that builds up a list structure like the one shown when given <code>[1, 2, 3]</code> as argument. Also write a <code>listToArray</code> function that produces an array from a list. Then add a helper function <code>prepend</code>, which takes an element and a list and creates a new list that adds the element to the front of the input list, and <code>nth</code>, which takes a list and a number and returns the element at the given position in the list (with zero referring to the first element) or <code>undefined</code> when there is no such element.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_8YcepSmcdv class=p_ident id=p_8YcepSmcdv></a>If you haven’t already, also write a recursive version of <code>nth</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_rufmukl+AQ class=c_ident id=c_rufmukl+AQ></a> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>arrayToList</p>([<p class=cm-number>10</p>, <p class=cm-number>20</p>])); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>listToArray</p>(<p class=cm-variable>arrayToList</p>([<p class=cm-number>10</p>, <p class=cm-number>20</p>, <p class=cm-number>30</p>]))); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>prepend</p>(<p class=cm-number>10</p>, <p class=cm-variable>prepend</p>(<p class=cm-number>20</p>, <p class=cm-atom>null</p>))); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>nth</p>(<p class=cm-variable>arrayToList</p>([<p class=cm-number>10</p>, <p class=cm-number>20</p>, <p class=cm-number>30</p>]), <p class=cm-number>1</p>));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/04_data.html#p_gUGYq9Tjlx class=p_ident id=p_gUGYq9Tjlx></a>Building up a list is easier when done back to front. So <code>arrayToList</code> could iterate over the array backwards (see the previous exercise) and, for each element, add an object to the list. You can use a local binding to hold the part of the list that was built so far and use an assignment like <code>list = {value: X, rest: list}</code> to add an element.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_+rJULr60CD class=p_ident id=p_+rJULr60CD></a>To run over a list (in <code>listToArray</code> and <code>nth</code>), a <code>for</code> loop specification like this can be used:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_HLrOQGihFR class=c_ident id=c_HLrOQGihFR></a><span class=cm-keyword>for</span> (<span class=cm-keyword>let</span> <span class=cm-def>node</span> <span class=cm-operator>=</span> <span class=cm-variable>list</span>; <span class=cm-variable>node</span>; <span class=cm-variable>node</span> <span class=cm-operator>=</span> <span class=cm-variable>node</span>.<span class=cm-property>rest</span>) {}</pre> <p><a href=https://eloquentjavascript.net/04_data.html#p_LnwEAnSmsp class=p_ident id=p_LnwEAnSmsp></a>Can you see how that works? Every iteration of the loop, <code>node</code> points to the current sublist, and the body can read its <code>value</code> property to get the current element. At the end of an iteration, <code>node</code> moves to the next sublist. When that is null, we have reached the end of the list, and the loop is finished.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ASUOjWBRh5 class=p_ident id=p_ASUOjWBRh5></a>The recursive version of <code>nth</code> will, similarly, look at an ever smaller part of the “tail” of the list and at the same time count down the index until it reaches zero, at which point it can return the <code>value</code> property of the node it is looking at. To get the zeroth element of a list, you simply take the <code>value</code> property of its head node. To get element <em>N</em> + 1, you take the <em>N</em>th element of the list that’s in this list’s <code>rest</code> property.</p> </div></div> <h3 id=exercise_deep_compare><a href=https://eloquentjavascript.net/04_data.html#i_IJBU+aXOIC class=i_ident id=i_IJBU+aXOIC></a>Deep comparison</h3> <p><a href=https://eloquentjavascript.net/04_data.html#p_xTwbRlqHNJ class=p_ident id=p_xTwbRlqHNJ></a>The <code>==</code> operator compares objects by identity. But sometimes you’d prefer to compare the values of their actual properties.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_DwdnLiD0pC class=p_ident id=p_DwdnLiD0pC></a>Write a function <code>deepEqual</code> that takes two values and returns true only if they are the same value or are objects with the same properties, where the values of the properties are equal when compared with a recursive call to <code>deepEqual</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_Znb46HKrMg class=p_ident id=p_Znb46HKrMg></a>To find out whether values should be compared directly (use the <code>===</code> operator for that) or have their properties compared, you can use the <code>typeof</code> operator. If it produces <code>\"object\"</code> for both values, you should do a deep comparison. But you have to take one silly exception into account: because of a historical accident, <code>typeof null</code> also produces <code>\"object\"</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_n9AoXEbeFg class=p_ident id=p_n9AoXEbeFg></a>The <code>Object.keys</code> function will be useful when you need to go over the properties of objects to compare them.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/04_data.html#c_kWPN5i/Y3x class=c_ident id=c_kWPN5i/Y3x></a> <p class=cm-keyword>let</p> <p class=cm-def>obj</p> <p class=cm-operator>=</p> {<p class=cm-property>here</p>: {<p class=cm-property>is</p>: <p class=cm-string>\"an\"</p>}, <p class=cm-property>object</p>: <p class=cm-number>2</p>};\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>deepEqual</p>(<p class=cm-variable>obj</p>, <p class=cm-variable>obj</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>deepEqual</p>(<p class=cm-variable>obj</p>, {<p class=cm-property>here</p>: <p class=cm-number>1</p>, <p class=cm-property>object</p>: <p class=cm-number>2</p>})); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>deepEqual</p>(<p class=cm-variable>obj</p>, {<p class=cm-property>here</p>: {<p class=cm-property>is</p>: <p class=cm-string>\"an\"</p>}, <p class=cm-property>object</p>: <p class=cm-number>2</p>}));\n</pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/04_data.html#p_t3z+oosxP9 class=p_ident id=p_t3z+oosxP9></a>Your test for whether you are dealing with a real object will look something like <code>typeof x == \"object\" &amp;&amp; x != null</code>. Be careful to compare properties only when <em>both</em> arguments are objects. In all other cases you can just immediately return the result of applying <code>===</code>.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_csfrgdVrEd class=p_ident id=p_csfrgdVrEd></a>Use <code>Object.keys</code> to go over the properties. You need to test whether both objects have the same set of property names and whether those properties have identical values. One way to do that is to ensure that both objects have the same number of properties (the lengths of the property lists are the same). And then, when looping over one of the object’s properties to compare them, always first make sure the other actually has a property by that name. If they have the same number of properties and all properties in one also exist in the other, they have the same set of property names.</p> <p><a href=https://eloquentjavascript.net/04_data.html#p_ECXa1sWg6+ class=p_ident id=p_ECXa1sWg6+></a>Returning the correct value from the function is best done by immediately returning false when a mismatch is found and returning true at the end of the function.</p> </div></div><nav><a href=https://eloquentjavascript.net/03_functions.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/05_higher_order.html>▶</a></nav>\n</article><hr><h4>Page 11</h4><article score=775.3550000000002>\n<nav><a href=https://eloquentjavascript.net/13_browser.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/15_event.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/14_dom.html#p_yqipqPLrLS class=p_ident id=p_yqipqPLrLS></a>Too bad! Same old story! Once you’ve finished building your house you notice you’ve accidentally learned something that you really should have known—before you started.</p> <footer>Friedrich Nietzsche, <cite>Beyond Good and Evil</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a tree with letters and scripts hanging from its branches\" src=https://eloquentjavascript.net/img/chapter_picture_14.jpg></figure> <p><a href=https://eloquentjavascript.net/14_dom.html#p_O255K9+8+X class=p_ident id=p_O255K9+8+X></a>When you open a web page in your browser, the browser retrieves the page’s HTML text and parses it, much like the way our parser from <a href=https://eloquentjavascript.net/12_language.html#parsing>Chapter 12</a> parsed programs. The browser builds up a model of the document’s structure and uses this model to draw the page on the screen.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_zrkOdq43yM class=p_ident id=p_zrkOdq43yM></a>This representation of the document is one of the toys that a JavaScript program has available in its sandbox. It is a data structure that you can read or modify. It acts as a <em>live</em> data structure: when it’s modified, the page on the screen is updated to reflect the changes.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_XJzHjmX32m class=h_ident id=h_XJzHjmX32m></a>Document structure</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_j22zv7gLgp class=p_ident id=p_j22zv7gLgp></a>You can imagine an HTML document as a nested set of boxes. Tags such as <code>&lt;body&gt;</code> and <code>&lt;/body&gt;</code> enclose other tags, which in turn contain other tags or text. Here’s the example document from the <a href=https://eloquentjavascript.net/13_browser.html>previous chapter</a>:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_4wSSl86LKl class=c_ident id=c_4wSSl86LKl></a>\n<p class=cm-tag>&lt;</p><p class=cm-tag>html</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>head</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>head</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Hello, I am Marijn and this is my home page.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>I also wrote a book! Read it <p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"http://eloquentjavascript.net\"</p><p class=cm-tag>&gt;</p>here<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p>.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>html</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_rRaTGW2wtE class=p_ident id=p_rRaTGW2wtE></a>This page has the following structure:</p><figure><img alt=\"HTML document as nested boxes\" src=https://eloquentjavascript.net/img/html-boxes.svg></figure> <p><a href=https://eloquentjavascript.net/14_dom.html#p_1mgE45KfoF class=p_ident id=p_1mgE45KfoF></a>The data structure the browser uses to represent the document follows this shape. For each box, there is an object, which we can interact with to find out things such as what HTML tag it represents and which boxes and text it contains. This representation is called the <em>Document Object Model</em>, or DOM for short.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_ltiXfOMPcl class=p_ident id=p_ltiXfOMPcl></a>The global binding <code>document</code> gives us access to these objects. Its <code>documentElement</code> property refers to the object representing the <code>&lt;html&gt;</code> tag. Since every HTML document has a head and a body, it also has <code>head</code> and <code>body</code> properties, pointing at those elements.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_HnCB1zb0Ot class=h_ident id=h_HnCB1zb0Ot></a>Trees</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_63ES4U9bHr class=p_ident id=p_63ES4U9bHr></a>Think back to the syntax trees from <a href=https://eloquentjavascript.net/12_language.html#parsing>Chapter 12</a> for a moment. Their structures are strikingly similar to the structure of a browser’s document. Each <em>node</em> may refer to other nodes, <em>children</em>, which in turn may have their own children. This shape is typical of nested structures where elements can contain subelements that are similar to themselves.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_QVBp4KpREl class=p_ident id=p_QVBp4KpREl></a>We call a data structure a <em>tree</em> when it has a branching structure, has no cycles (a node may not contain itself, directly or indirectly), and has a single, well-defined <em>root</em>. In the case of the DOM, <code>document.<wbr>documentElement</code> serves as the root.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_BEUMAPGYwc class=p_ident id=p_BEUMAPGYwc></a>Trees come up a lot in computer science. In addition to representing recursive structures such as HTML documents or programs, they are often used to maintain sorted sets of data because elements can usually be found or inserted more efficiently in a tree than in a flat array.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_bH4un2TNOK class=p_ident id=p_bH4un2TNOK></a>A typical tree has different kinds of nodes. The syntax tree for <a href=https://eloquentjavascript.net/12_language.html>the Egg language</a> had identifiers, values, and application nodes. Application nodes may have children, whereas identifiers and values are <em>leaves</em>, or nodes without children.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_boZnTfEJs0 class=p_ident id=p_boZnTfEJs0></a>The same goes for the DOM. Nodes for <em>elements</em>, which represent HTML tags, determine the structure of the document. These can have child nodes. An example of such a node is <code>document.body</code>. Some of these children can be leaf nodes, such as pieces of text or comment nodes.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_f2BdWNSlpJ class=p_ident id=p_f2BdWNSlpJ></a>Each DOM node object has a <code>nodeType</code> property, which contains a code (number) that identifies the type of node. Elements have code 1, which is also defined as the constant property <code>Node.<wbr>ELEMENT_NODE</code>. Text nodes, representing a section of text in the document, get code 3 (<code>Node.TEXT_NODE</code>). Comments have code 8 (<code>Node.<wbr>COMMENT_NODE</code>).</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_RcdzGUMYUH class=p_ident id=p_RcdzGUMYUH></a>Another way to visualize our document tree is as follows:</p><figure><img alt=\"HTML document as a tree\" src=https://eloquentjavascript.net/img/html-tree.svg></figure> <p><a href=https://eloquentjavascript.net/14_dom.html#p_KheiUePsYH class=p_ident id=p_KheiUePsYH></a>The leaves are text nodes, and the arrows indicate parent-child relationships between nodes.</p> <h2 id=standard><a href=https://eloquentjavascript.net/14_dom.html#h_XgjABY6Ugx class=h_ident id=h_XgjABY6Ugx></a>The standard</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_mGhmcMpW9e class=p_ident id=p_mGhmcMpW9e></a>Using cryptic numeric codes to represent node types is not a very JavaScript-like thing to do. Later in this chapter, we’ll see that other parts of the DOM interface also feel cumbersome and alien. The reason for this is that the DOM wasn’t designed for just JavaScript. Rather, it tries to be a language-neutral interface that can be used in other systems as well—not just for HTML but also for XML, which is a generic data format with an HTML-like syntax.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_IT2jWsK6qu class=p_ident id=p_IT2jWsK6qu></a>This is unfortunate. Standards are often useful. But in this case, the advantage (cross-language consistency) isn’t all that compelling. Having an interface that is properly integrated with the language you are using will save you more time than having a familiar interface across languages.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_feaMhbBocX class=p_ident id=p_feaMhbBocX></a>As an example of this poor integration, consider the <code>childNodes</code> property that element nodes in the DOM have. This property holds an array-like object, with a <code>length</code> property and properties labeled by numbers to access the child nodes. But it is an instance of the <code>NodeList</code> type, not a real array, so it does not have methods such as <code>slice</code> and <code>map</code>.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_XrOZAaBu2c class=p_ident id=p_XrOZAaBu2c></a>Then there are issues that are simply poor design. For example, there is no way to create a new node and immediately add children or attributes to it. Instead, you have to first create it and then add the children and attributes one by one, using side effects. Code that interacts heavily with the DOM tends to get long, repetitive, and ugly.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_1dwhmrGwQQ class=p_ident id=p_1dwhmrGwQQ></a>But these flaws aren’t fatal. Since JavaScript allows us to create our own abstractions, it is possible to design improved ways to express the operations you are performing. Many libraries intended for browser programming come with such tools.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_ShZPVipWw/ class=h_ident id=h_ShZPVipWw/ ></a>Moving through the tree</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_KU+aLLXhA0 class=p_ident id=p_KU+aLLXhA0></a>DOM nodes contain a wealth of links to other nearby nodes. The following diagram illustrates these:</p><figure><img alt=\"Links between DOM nodes\" src=https://eloquentjavascript.net/img/html-links.svg></figure> <p><a href=https://eloquentjavascript.net/14_dom.html#p_oWR8F5E2Yw class=p_ident id=p_oWR8F5E2Yw></a>Although the diagram shows only one link of each type, every node has a <code>parentNode</code> property that points to the node it is part of, if any. Likewise, every element node (node type 1) has a <code>childNodes</code> property that points to an array-like object holding its children.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_zpX7kgIV1h class=p_ident id=p_zpX7kgIV1h></a>In theory, you could move anywhere in the tree using just these parent and child links. But JavaScript also gives you access to a number of additional convenience links. The <code>firstChild</code> and <code>lastChild</code> properties point to the first and last child elements or have the value <code>null</code> for nodes without children. Similarly, <code>previousSibling</code> and <code>nextSibling</code> point to adjacent nodes, which are nodes with the same parent that appear immediately before or after the node itself. For a first child, <code>previousSibling</code> will be null, and for a last child, <code>nextSibling</code> will be null.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_EXYoCGtRP4 class=p_ident id=p_EXYoCGtRP4></a>There’s also the <code>children</code> property, which is like <code>childNodes</code> but contains only element (type 1) children, not other types of child nodes. This can be useful when you aren’t interested in text nodes.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_wSmPJ/d3c4 class=p_ident id=p_wSmPJ/d3c4></a>When dealing with a nested data structure like this one, recursive functions are often useful. The following function scans a document for text nodes containing a given string and returns <code>true</code> when it has found one:</p> <pre class=\"cm-s-default snippet\" id=talksAbout><a href=https://eloquentjavascript.net/14_dom.html#c_6/D7aNG9Y+ class=c_ident id=c_6/D7aNG9Y+></a><p class=cm-keyword>function</p> <p class=cm-def>talksAbout</p>(<p class=cm-def>node</p>, <p class=cm-def>string</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>node</p>.<p class=cm-property>nodeType</p> <p class=cm-operator>==</p> <p class=cm-variable>Node</p>.<p class=cm-property>ELEMENT_NODE</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>child</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>node</p>.<p class=cm-property>childNodes</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>talksAbout</p>(<p class=cm-variable-2>child</p>, <p class=cm-variable-2>string</p>)) { <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } } <p class=cm-keyword>return</p> <p class=cm-atom>false</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>node</p>.<p class=cm-property>nodeType</p> <p class=cm-operator>==</p> <p class=cm-variable>Node</p>.<p class=cm-property>TEXT_NODE</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>node</p>.<p class=cm-property>nodeValue</p>.<p class=cm-property>indexOf</p>(<p class=cm-variable-2>string</p>) <p class=cm-operator>&gt;</p> <p class=cm-operator>-</p><p class=cm-number>1</p>; }\n} <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>talksAbout</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-string>\"book\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_z6XhjipK31 class=p_ident id=p_z6XhjipK31></a>The <code>nodeValue</code> property of a text node holds the string of text that it represents.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_jS5BEpmLY0 class=h_ident id=h_jS5BEpmLY0></a>Finding elements</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_saBiuECTgW class=p_ident id=p_saBiuECTgW></a>Navigating these links among parents, children, and siblings is often useful. But if we want to find a specific node in the document, reaching it by starting at <code>document.body</code> and following a fixed path of properties is a bad idea. Doing so bakes assumptions into our program about the precise structure of the document—a structure you might want to change later. Another complicating factor is that text nodes are created even for the whitespace between nodes. The example document’s <code>&lt;body&gt;</code> tag does not have just three children (<code>&lt;h1&gt;</code> and two <code>&lt;p&gt;</code> elements) but actually has seven: those three, plus the spaces before, after, and between them.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_St5y6wbhGX class=p_ident id=p_St5y6wbhGX></a>So if we want to get the <code>href</code> attribute of the link in that document, we don’t want to say something like “Get the second child of the sixth child of the document body”. It’d be better if we could say “Get the first link in the document”. And we can.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_X6zFdF/80F class=c_ident id=c_X6zFdF/80F></a><p class=cm-keyword>let</p> <p class=cm-def>link</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>getElementsByTagName</p>(<p class=cm-string>\"a\"</p>)[<p class=cm-number>0</p>];\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>link</p>.<p class=cm-property>href</p>);</pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_VGWClqmGZz class=p_ident id=p_VGWClqmGZz></a>All element nodes have a <code>getElementsByTagName</code> method, which collects all elements with the given tag name that are descendants (direct or indirect children) of that node and returns them as an array-like object.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_xDCAIt1lT6 class=p_ident id=p_xDCAIt1lT6></a>To find a specific <em>single</em> node, you can give it an <code>id</code> attribute and use <code>document.<wbr>getElementById</code> instead.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_CpFVpKYjsr class=c_ident id=c_CpFVpKYjsr></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>My ostrich Gertrude:<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"gertrude\"</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/ostrich.png\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>ostrich</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>getElementById</p>(<p class=cm-string>\"gertrude\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>ostrich</p>.<p class=cm-property>src</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Ur1I1Lx8SY class=p_ident id=p_Ur1I1Lx8SY></a>A third, similar method is <code>getElementsByClassName</code>, which, like <code>getElementsByTagName</code>, searches through the contents of an element node and retrieves all elements that have the given string in their <code>class</code> attribute.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_npiFAJENvT class=h_ident id=h_npiFAJENvT></a>Changing the document</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_PqYkGnE2Ps class=p_ident id=p_PqYkGnE2Ps></a>Almost everything about the DOM data structure can be changed. The shape of the document tree can be modified by changing parent-child relationships. Nodes have a <code>remove</code> method to remove them from their current parent node. To add a child node to an element node, we can use <code>appendChild</code>, which puts it at the end of the list of children, or <code>insertBefore</code>, which inserts the node given as the first argument before the node given as the second argument.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_xdAyPFCEJ5 class=c_ident id=c_xdAyPFCEJ5></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>One<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Two<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Three<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>paragraphs</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>getElementsByTagName</p>(<p class=cm-string>\"p\"</p>); <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>insertBefore</p>(<p class=cm-variable>paragraphs</p>[<p class=cm-number>2</p>], <p class=cm-variable>paragraphs</p>[<p class=cm-number>0</p>]);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_izAyoVA99z class=p_ident id=p_izAyoVA99z></a>A node can exist in the document in only one place. Thus, inserting paragraph <em>Three</em> in front of paragraph <em>One</em> will first remove it from the end of the document and then insert it at the front, resulting in <em>Three</em>/<em>One</em>/<em>Two</em>. All operations that insert a node somewhere will, as a side effect, cause it to be removed from its current position (if it has one).</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_PHkpqBpgHX class=p_ident id=p_PHkpqBpgHX></a>The <code>replaceChild</code> method is used to replace a child node with another one. It takes as arguments two nodes: a new node and the node to be replaced. The replaced node must be a child of the element the method is called on. Note that both <code>replaceChild</code> and <code>insertBefore</code> expect the <em>new</em> node as their first argument.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_AlX6HES+2D class=h_ident id=h_AlX6HES+2D></a>Creating nodes</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Z0UBaFpahv class=p_ident id=p_Z0UBaFpahv></a>Say we want to write a script that replaces all images (<code>&lt;img&gt;</code> tags) in the document with the text held in their <code>alt</code> attributes, which specifies an alternative textual representation of the image.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_zMqlQBb7H1 class=p_ident id=p_zMqlQBb7H1></a>This involves not only removing the images but adding a new text node to replace them. Text nodes are created with the <code>document.<wbr>createTextNode</code> method.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_x13nsyh4X4 class=c_ident id=c_x13nsyh4X4></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>The <p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/cat.png\"</p> <p class=cm-attribute>alt</p>=<p class=cm-string>\"Cat\"</p><p class=cm-tag>&gt;</p> in the <p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/hat.png\"</p> <p class=cm-attribute>alt</p>=<p class=cm-string>\"Hat\"</p><p class=cm-tag>&gt;</p>.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>onclick</p>=<p class=cm-string>\"replaceImages()\"</p><p class=cm-tag>&gt;</p>Replace<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>replaceImages</p>() { <p class=cm-keyword>let</p> <p class=cm-def>images</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>getElementsByTagName</p>(<p class=cm-string>\"img\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-variable-2>images</p>.<p class=cm-property>length</p> <p class=cm-operator>-</p> <p class=cm-number>1</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&gt;=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p><p class=cm-operator>--</p>) { <p class=cm-keyword>let</p> <p class=cm-def>image</p> <p class=cm-operator>=</p> <p class=cm-variable-2>images</p>[<p class=cm-variable-2>i</p>]; <p class=cm-keyword>if</p> (<p class=cm-variable-2>image</p>.<p class=cm-property>alt</p>) { <p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>(<p class=cm-variable-2>image</p>.<p class=cm-property>alt</p>); <p class=cm-variable-2>image</p>.<p class=cm-property>parentNode</p>.<p class=cm-property>replaceChild</p>(<p class=cm-variable-2>text</p>, <p class=cm-variable-2>image</p>); } } }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_SZGvV3YwdR class=p_ident id=p_SZGvV3YwdR></a>Given a string, <code>createTextNode</code> gives us a text node that we can insert into the document to make it show up on the screen.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_6KP6Yw4ww7 class=p_ident id=p_6KP6Yw4ww7></a>The loop that goes over the images starts at the end of the list. This is necessary because the node list returned by a method like <code>getElementsByTagName</code> (or a property like <code>childNodes</code>) is <em>live</em>. That is, it is updated as the document changes. If we started from the front, removing the first image would cause the list to lose its first element so that the second time the loop repeats, where <code>i</code> is 1, it would stop because the length of the collection is now also 1.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_H+4G9MqWPh class=p_ident id=p_H+4G9MqWPh></a>If you want a <em>solid</em> collection of nodes, as opposed to a live one, you can convert the collection to a real array by calling <code>Array.from</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_YYMkVyoN/K class=c_ident id=c_YYMkVyoN/K></a><p class=cm-keyword>let</p> <p class=cm-def>arrayish</p> <p class=cm-operator>=</p> {<p class=cm-number>0</p>: <p class=cm-string>\"one\"</p>, <p class=cm-number>1</p>: <p class=cm-string>\"two\"</p>, <p class=cm-property>length</p>: <p class=cm-number>2</p>};\n<p class=cm-keyword>let</p> <p class=cm-def>array</p> <p class=cm-operator>=</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>arrayish</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>array</p>.<p class=cm-property>map</p>(<p class=cm-def>s</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>s</p>.<p class=cm-property>toUpperCase</p>()));\n</pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_2LO1OJVEk3 class=p_ident id=p_2LO1OJVEk3></a>To create element nodes, you can use the <code>document.<wbr>createElement</code> method. This method takes a tag name and returns a new empty node of the given type.</p> <p id=elt><a href=https://eloquentjavascript.net/14_dom.html#p_bvldRsjLfM class=p_ident id=p_bvldRsjLfM></a>The following example defines a utility <code>elt</code>, which creates an element node and treats the rest of its arguments as children to that node. This function is then used to add an attribution to a quote.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_yKu7txUDrU class=c_ident id=c_yKu7txUDrU></a><p class=cm-tag>&lt;</p><p class=cm-tag>blockquote</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"quote\"</p><p class=cm-tag>&gt;</p> No book can ever be finished. While working on it we learn just enough to find it immature the moment we turn away from it.\n<p class=cm-tag>&lt;/</p><p class=cm-tag>blockquote</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>elt</p>(<p class=cm-def>type</p>, <p class=cm-def>children</p>) { <p class=cm-keyword>let</p> <p class=cm-def>node</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-variable-2>type</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>child</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>children</p>) { <p class=cm-keyword>if</p> (<p class=cm-keyword>typeof</p> <p class=cm-variable-2>child</p> <p class=cm-operator>!=</p> <p class=cm-string>\"string\"</p>) <p class=cm-variable-2>node</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>child</p>); <p class=cm-keyword>else</p> <p class=cm-variable-2>node</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>(<p class=cm-variable-2>child</p>)); } <p class=cm-keyword>return</p> <p class=cm-variable-2>node</p>; } <p class=cm-variable>document</p>.<p class=cm-property>getElementById</p>(<p class=cm-string>\"quote\"</p>).<p class=cm-property>appendChild</p>( <p class=cm-variable>elt</p>(<p class=cm-string>\"footer\"</p>, <p class=cm-string>\"—\"</p>, <p class=cm-variable>elt</p>(<p class=cm-string>\"strong\"</p>, <p class=cm-string>\"Karl Popper\"</p>), <p class=cm-string>\", preface to the second edition of \"</p>, <p class=cm-variable>elt</p>(<p class=cm-string>\"em\"</p>, <p class=cm-string>\"The Open Society and Its Enemies\"</p>), <p class=cm-string>\", 1950\"</p>));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_pmUmF/LHme class=h_ident id=h_pmUmF/LHme></a>Attributes</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_HSPdyuAruy class=p_ident id=p_HSPdyuAruy></a>Some element attributes, such as <code>href</code> for links, can be accessed through a property of the same name on the element’s DOM object. This is the case for most commonly used standard attributes.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_vK0AfBjXCM class=p_ident id=p_vK0AfBjXCM></a>But HTML allows you to set any attribute you want on nodes. This can be useful because it allows you to store extra information in a document. If you make up your own attribute names, though, such attributes will not be present as properties on the element’s node. Instead, you have to use the <code>getAttribute</code> and <code>setAttribute</code> methods to work with them.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_S977zg3XyT class=c_ident id=c_S977zg3XyT></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>data-classified</p>=<p class=cm-string>\"secret\"</p><p class=cm-tag>&gt;</p>The launch code is 00000000.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>data-classified</p>=<p class=cm-string>\"unclassified\"</p><p class=cm-tag>&gt;</p>I have two feet.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>paras</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>getElementsByTagName</p>(<p class=cm-string>\"p\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>para</p> <p class=cm-keyword>of</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>paras</p>)) { <p class=cm-keyword>if</p> (<p class=cm-variable>para</p>.<p class=cm-property>getAttribute</p>(<p class=cm-string>\"data-classified\"</p>) <p class=cm-operator>==</p> <p class=cm-string>\"secret\"</p>) { <p class=cm-variable>para</p>.<p class=cm-property>remove</p>(); } }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_BrjnN/bGC0 class=p_ident id=p_BrjnN/bGC0></a>It is recommended to prefix the names of such made-up attributes with <code>data-</code> to ensure they do not conflict with any other attributes.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Hi6IWNjXxP class=p_ident id=p_Hi6IWNjXxP></a>There is a commonly used attribute, <code>class</code>, which is a keyword in the JavaScript language. For historical reasons—some old JavaScript implementations could not handle property names that matched keywords—the property used to access this attribute is called <code>className</code>. You can also access it under its real name, <code>\"class\"</code>, by using the <code>getAttribute</code> and <code>setAttribute</code> methods.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_lyrY2KUDl7 class=h_ident id=h_lyrY2KUDl7></a>Layout</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Qvk9MMKpjV class=p_ident id=p_Qvk9MMKpjV></a>You may have noticed that different types of elements are laid out differently. Some, such as paragraphs (<code>&lt;p&gt;</code>) or headings (<code>&lt;h1&gt;</code>), take up the whole width of the document and are rendered on separate lines. These are called <em>block</em> elements. Others, such as links (<code>&lt;a&gt;</code>) or the <code>&lt;strong&gt;</code> element, are rendered on the same line with their surrounding text. Such elements are called <em>inline</em> elements.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_uyQ6hsLw6d class=p_ident id=p_uyQ6hsLw6d></a>For any given document, browsers are able to compute a layout, which gives each element a size and position based on its type and content. This layout is then used to actually draw the document.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_2zXIgr70Do class=p_ident id=p_2zXIgr70Do></a>The size and position of an element can be accessed from JavaScript. The <code>offsetWidth</code> and <code>offsetHeight</code> properties give you the space the element takes up in <em>pixels</em>. A pixel is the basic unit of measurement in the browser. It traditionally corresponds to the smallest dot that the screen can draw, but on modern displays, which can draw <em>very</em> small dots, that may no longer be the case, and a browser pixel may span multiple display dots.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_CL3JagaUiP class=p_ident id=p_CL3JagaUiP></a>Similarly, <code>clientWidth</code> and <code>clientHeight</code> give you the size of the space <em>inside</em> the element, ignoring border width.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_E5M9cwi2qC class=c_ident id=c_E5M9cwi2qC></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"border: 3px solid red\"</p><p class=cm-tag>&gt;</p> I'm boxed in\n<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>para</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>getElementsByTagName</p>(<p class=cm-string>\"p\"</p>)[<p class=cm-number>0</p>]; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"clientHeight:\"</p>, <p class=cm-variable>para</p>.<p class=cm-property>clientHeight</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"offsetHeight:\"</p>, <p class=cm-variable>para</p>.<p class=cm-property>offsetHeight</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p id=boundingRect><a href=https://eloquentjavascript.net/14_dom.html#p_LG8xrkr071 class=p_ident id=p_LG8xrkr071></a>The most effective way to find the precise position of an element on the screen is the <code>getBoundingClientRect</code> method. It returns an object with <code>top</code>, <code>bottom</code>, <code>left</code>, and <code>right</code> properties, indicating the pixel positions of the sides of the element relative to the top left of the screen. If you want them relative to the whole document, you must add the current scroll position, which you can find in the <code>pageXOffset</code> and <code>pageYOffset</code> bindings.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_LcMNzqCMUS class=p_ident id=p_LcMNzqCMUS></a>Laying out a document can be quite a lot of work. In the interest of speed, browser engines do not immediately re-layout a document every time you change it but wait as long as they can. When a JavaScript program that changed the document finishes running, the browser will have to compute a new layout to draw the changed document to the screen. When a program <em>asks</em> for the position or size of something by reading properties such as <code>offsetHeight</code> or calling <code>getBoundingClientRect</code>, providing correct information also requires computing a layout.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_TzaMQEZthV class=p_ident id=p_TzaMQEZthV></a>A program that repeatedly alternates between reading DOM layout information and changing the DOM forces a lot of layout computations to happen and will consequently run very slowly. The following code is an example of this. It contains two different programs that build up a line of <em>X</em> characters 2,000 pixels wide and measures the time each one takes.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_Mmn5ZrRT52 class=c_ident id=c_Mmn5ZrRT52></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"one\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"two\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>time</p>(<p class=cm-def>name</p>, <p class=cm-def>action</p>) { <p class=cm-keyword>let</p> <p class=cm-def>start</p> <p class=cm-operator>=</p> <p class=cm-variable>Date</p>.<p class=cm-property>now</p>(); <p class=cm-variable-2>action</p>(); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>name</p>, <p class=cm-string>\"took\"</p>, <p class=cm-variable>Date</p>.<p class=cm-property>now</p>() <p class=cm-operator>-</p> <p class=cm-variable-2>start</p>, <p class=cm-string>\"ms\"</p>); } <p class=cm-variable>time</p>(<p class=cm-string>\"naive\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>target</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>getElementById</p>(<p class=cm-string>\"one\"</p>); <p class=cm-keyword>while</p> (<p class=cm-variable-2>target</p>.<p class=cm-property>offsetWidth</p> <p class=cm-operator>&lt;</p> <p class=cm-number>2000</p>) { <p class=cm-variable-2>target</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>(<p class=cm-string>\"X\"</p>)); } }); <p class=cm-variable>time</p>(<p class=cm-string>\"clever\"</p>, <p class=cm-keyword>function</p>() { <p class=cm-keyword>let</p> <p class=cm-def>target</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>getElementById</p>(<p class=cm-string>\"two\"</p>); <p class=cm-variable-2>target</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>(<p class=cm-string>\"XXXXX\"</p>)); <p class=cm-keyword>let</p> <p class=cm-def>total</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>ceil</p>(<p class=cm-number>2000</p> <p class=cm-operator>/</p> (<p class=cm-variable-2>target</p>.<p class=cm-property>offsetWidth</p> <p class=cm-operator>/</p> <p class=cm-number>5</p>)); <p class=cm-variable-2>target</p>.<p class=cm-property>firstChild</p>.<p class=cm-property>nodeValue</p> <p class=cm-operator>=</p> <p class=cm-string>\"X\"</p>.<p class=cm-property>repeat</p>(<p class=cm-variable-2>total</p>); }); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_VfKBbtOqcL class=h_ident id=h_VfKBbtOqcL></a>Styling</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_G9Se5o/P9V class=p_ident id=p_G9Se5o/P9V></a>We have seen that different HTML elements are drawn differently. Some are displayed as blocks, others inline. Some add styling—<code>&lt;strong&gt;</code> makes its content bold, and <code>&lt;a&gt;</code> makes it blue and underlines it.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_0uDaEVu+We class=p_ident id=p_0uDaEVu+We></a>The way an <code>&lt;img&gt;</code> tag shows an image or an <code>&lt;a&gt;</code> tag causes a link to be followed when it is clicked is strongly tied to the element type. But we can change the styling associated with an element, such as the text color or underline. Here is an example that uses the <code>style</code> property:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_Qie8s1kOFZ class=c_ident id=c_Qie8s1kOFZ></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\".\"</p><p class=cm-tag>&gt;</p>Normal link<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\".\"</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"color: green\"</p><p class=cm-tag>&gt;</p>Green link<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_UDiIHFxHaH class=p_ident id=p_UDiIHFxHaH></a>A style attribute may contain one or more <em>declarations</em>, which are a property (such as <code>color</code>) followed by a colon and a value (such as <code>green</code>). When there is more than one declaration, they must be separated by semicolons, as in <code>\"color: red; border: none\"</code>.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_IFsPqr8z6J class=p_ident id=p_IFsPqr8z6J></a>A lot of aspects of the document can be influenced by styling. For example, the <code>display</code> property controls whether an element is displayed as a block or an inline element.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_NN8SrlwTXB class=c_ident id=c_NN8SrlwTXB></a>This text is displayed <p class=cm-tag>&lt;</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p>inline<p class=cm-tag>&lt;/</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p>,\n<p class=cm-tag>&lt;</p><p class=cm-tag>strong</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"display: block\"</p><p class=cm-tag>&gt;</p>as a block<p class=cm-tag>&lt;/</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p>, and\n<p class=cm-tag>&lt;</p><p class=cm-tag>strong</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"display: none\"</p><p class=cm-tag>&gt;</p>not at all<p class=cm-tag>&lt;/</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p>.</pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_1al7UxHqSY class=p_ident id=p_1al7UxHqSY></a>The <code>block</code> tag will end up on its own line since block elements are not displayed inline with the text around them. The last tag is not displayed at all—<code>display: none</code> prevents an element from showing up on the screen. This is a way to hide elements. It is often preferable to removing them from the document entirely because it makes it easy to reveal them again later.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_HcAoKCgOCF class=p_ident id=p_HcAoKCgOCF></a>JavaScript code can directly manipulate the style of an element through the element’s <code>style</code> property. This property holds an object that has properties for all possible style properties. The values of these properties are strings, which we can write to in order to change a particular aspect of the element’s style.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_WtWpdICuOL class=c_ident id=c_WtWpdICuOL></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"para\"</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"color: purple\"</p><p class=cm-tag>&gt;</p> Nice text\n<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>para</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>getElementById</p>(<p class=cm-string>\"para\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>para</p>.<p class=cm-property>style</p>.<p class=cm-property>color</p>); <p class=cm-variable>para</p>.<p class=cm-property>style</p>.<p class=cm-property>color</p> <p class=cm-operator>=</p> <p class=cm-string>\"magenta\"</p>;\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_yEGT1UyTDI class=p_ident id=p_yEGT1UyTDI></a>Some style property names contain hyphens, such as <code>font-family</code>. Because such property names are awkward to work with in JavaScript (you’d have to say <code>style[\"font-family\"]</code>), the property names in the <code>style</code> object for such properties have their hyphens removed and the letters after them capitalized (<code>style.fontFamily</code>).</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_7kGsaGnBbD class=h_ident id=h_7kGsaGnBbD></a>Cascading styles</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_i2Y6OhznV/ class=p_ident id=p_i2Y6OhznV/ ></a>The styling system for HTML is called CSS, for <em>Cascading Style Sheets</em>. A <em>style sheet</em> is a set of rules for how to style elements in a document. It can be given inside a <code>&lt;style&gt;</code> tag.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_WnNZqmUMzQ class=c_ident id=c_WnNZqmUMzQ></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-tag>strong</p> { <p class=cm-property>font-style</p>: <p class=cm-atom>italic</p>; <p class=cm-property>color</p>: <p class=cm-keyword>gray</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Now <p class=cm-tag>&lt;</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p>strong text<p class=cm-tag>&lt;/</p><p class=cm-tag>strong</p><p class=cm-tag>&gt;</p> is italic and gray.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_QiKgncw4nF class=p_ident id=p_QiKgncw4nF></a>The <em>cascading</em> in the name refers to the fact that multiple such rules are combined to produce the final style for an element. In the example, the default styling for <code>&lt;strong&gt;</code> tags, which gives them <code>font-weight: bold</code>, is overlaid by the rule in the <code>&lt;style&gt;</code> tag, which adds <code>font-style</code> and <code>color</code>.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_TpdOmgyGAl class=p_ident id=p_TpdOmgyGAl></a>When multiple rules define a value for the same property, the most recently read rule gets a higher precedence and wins. So if the rule in the <code>&lt;style&gt;</code> tag included <code>font-weight: normal</code>, contradicting the default <code>font-weight</code> rule, the text would be normal, <em>not</em> bold. Styles in a <code>style</code> attribute applied directly to the node have the highest precedence and always win.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_BgSVZ5fpx+ class=p_ident id=p_BgSVZ5fpx+></a>It is possible to target things other than tag names in CSS rules. A rule for <code>.abc</code> applies to all elements with <code>\"abc\"</code> in their <code>class</code> attribute. A rule for <code>#xyz</code> applies to the element with an <code>id</code> attribute of <code>\"xyz\"</code> (which should be unique within the document).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_0kqCdknBKh class=c_ident id=c_0kqCdknBKh></a><p class=cm-qualifier>.subtle</p> { <p class=cm-property>color</p>: <p class=cm-keyword>gray</p>; <p class=cm-property>font-size</p>: <p class=cm-number>80%</p>;\n}\n<p class=cm-builtin>#header</p> { <p class=cm-property>background</p>: <p class=cm-keyword>blue</p>; <p class=cm-property>color</p>: <p class=cm-keyword>white</p>;\n} <p class=cm-tag>p</p><p class=cm-builtin>#main</p><p class=cm-qualifier>.a</p><p class=cm-qualifier>.b</p> { <p class=cm-property>margin-bottom</p>: <p class=cm-number>20px</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_7kmWmOHAMA class=p_ident id=p_7kmWmOHAMA></a>The precedence rule favoring the most recently defined rule applies only when the rules have the same <em>specificity</em>. A rule’s specificity is a measure of how precisely it describes matching elements, determined by the number and kind (tag, class, or ID) of element aspects it requires. For example, a rule that targets <code>p.a</code> is more specific than rules that target <code>p</code> or just <code>.a</code> and would thus take precedence over them.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_sM9qHFmGsZ class=p_ident id=p_sM9qHFmGsZ></a>The notation <code>p &gt; a {…}</code> applies the given styles to all <code>&lt;a&gt;</code> tags that are direct children of <code>&lt;p&gt;</code> tags. Similarly, <code>p a {…}</code> applies to all <code>&lt;a&gt;</code> tags inside <code>&lt;p&gt;</code> tags, whether they are direct or indirect children.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_5ooQzToxht class=h_ident id=h_5ooQzToxht></a>Query selectors</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_1wj652tYzq class=p_ident id=p_1wj652tYzq></a>We won’t be using style sheets all that much in this book. Understanding them is helpful when programming in the browser, but they are complicated enough to warrant a separate book.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_8GQ7mCW+rh class=p_ident id=p_8GQ7mCW+rh></a>The main reason I introduced <em>selector</em> syntax—the notation used in style sheets to determine which elements a set of styles apply to—is that we can use this same mini-language as an effective way to find DOM elements.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_HBvo4vBdkM class=p_ident id=p_HBvo4vBdkM></a>The <code>querySelectorAll</code> method, which is defined both on the <code>document</code> object and on element nodes, takes a selector string and returns a <code>NodeList</code> containing all the elements that it matches.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_yJ0zujW+YH class=c_ident id=c_yJ0zujW+YH></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>And if you go chasing <p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>class</p>=<p class=cm-string>\"animal\"</p><p class=cm-tag>&gt;</p>rabbits<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>And you know you're going to fall<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Tell 'em a <p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>class</p>=<p class=cm-string>\"character\"</p><p class=cm-tag>&gt;</p>hookah smoking <p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>class</p>=<p class=cm-string>\"animal\"</p><p class=cm-tag>&gt;</p>caterpillar<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Has given you the call<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>count</p>(<p class=cm-def>selector</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelectorAll</p>(<p class=cm-variable-2>selector</p>).<p class=cm-property>length</p>; } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>count</p>(<p class=cm-string>\"p\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>count</p>(<p class=cm-string>\".animal\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>count</p>(<p class=cm-string>\"p .animal\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>count</p>(<p class=cm-string>\"p &gt; .animal\"</p>)); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_VqdoUrLVMq class=p_ident id=p_VqdoUrLVMq></a>Unlike methods such as <code>getElementsByTagName</code>, the object returned by <code>querySelectorAll</code> is <em>not</em> live. It won’t change when you change the document. It is still not a real array, though, so you still need to call <code>Array.from</code> if you want to treat it like one.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_SlkO7PnZLM class=p_ident id=p_SlkO7PnZLM></a>The <code>querySelector</code> method (without the <code>All</code> part) works in a similar way. This one is useful if you want a specific, single element. It will return only the first matching element or null when no element matches.</p> <h2 id=animation><a href=https://eloquentjavascript.net/14_dom.html#h_MAsyozbjjZ class=h_ident id=h_MAsyozbjjZ></a>Positioning and animating</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_6Fd+Oq3MzE class=p_ident id=p_6Fd+Oq3MzE></a>The <code>position</code> style property influences layout in a powerful way. By default it has a value of <code>static</code>, meaning the element sits in its normal place in the document. When it is set to <code>relative</code>, the element still takes up space in the document, but now the <code>top</code> and <code>left</code> style properties can be used to move it relative to that normal place. When <code>position</code> is set to <code>absolute</code>, the element is removed from the normal document flow—that is, it no longer takes up space and may overlap with other elements. Also, its <code>top</code> and <code>left</code> properties can be used to absolutely position it relative to the top-left corner of the nearest enclosing element whose <code>position</code> property isn’t <code>static</code>, or relative to the document if no such enclosing element exists.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_TEJWNXCk6K class=p_ident id=p_TEJWNXCk6K></a>We can use this to create an animation. The following document displays a picture of a cat that moves around in an ellipse:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_SCZYa8azNm class=c_ident id=c_SCZYa8azNm></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"text-align: center\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/cat.png\"</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"position: relative\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>cat</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"img\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>angle</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>PI</p> <p class=cm-operator>/</p> <p class=cm-number>2</p>; <p class=cm-keyword>function</p> <p class=cm-def>animate</p>(<p class=cm-def>time</p>, <p class=cm-def>lastTime</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>lastTime</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) { <p class=cm-variable>angle</p> <p class=cm-operator>+=</p> (<p class=cm-variable-2>time</p> <p class=cm-operator>-</p> <p class=cm-variable-2>lastTime</p>) <p class=cm-operator>*</p> <p class=cm-number>0.001</p>; } <p class=cm-variable>cat</p>.<p class=cm-property>style</p>.<p class=cm-property>top</p> <p class=cm-operator>=</p> (<p class=cm-variable>Math</p>.<p class=cm-property>sin</p>(<p class=cm-variable>angle</p>) <p class=cm-operator>*</p> <p class=cm-number>20</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>cat</p>.<p class=cm-property>style</p>.<p class=cm-property>left</p> <p class=cm-operator>=</p> (<p class=cm-variable>Math</p>.<p class=cm-property>cos</p>(<p class=cm-variable>angle</p>) <p class=cm-operator>*</p> <p class=cm-number>200</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-def>newTime</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>animate</p>(<p class=cm-variable-2>newTime</p>, <p class=cm-variable-2>time</p>)); } <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-variable>animate</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_1j1D9J1YQt class=p_ident id=p_1j1D9J1YQt></a>Our picture is centered on the page and given a <code>position</code> of <code>relative</code>. We’ll repeatedly update that picture’s <code>top</code> and <code>left</code> styles to move it.</p> <p id=animationFrame><a href=https://eloquentjavascript.net/14_dom.html#p_YWJ84IIJ5r class=p_ident id=p_YWJ84IIJ5r></a>The script uses <code>requestAnimationFrame</code> to schedule the <code>animate</code> function to run whenever the browser is ready to repaint the screen. The <code>animate</code> function itself again calls <code>requestAnimationFrame</code> to schedule the next update. When the browser window (or tab) is active, this will cause updates to happen at a rate of about 60 per second, which tends to produce a good-looking animation.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_V1ZyP92HDo class=p_ident id=p_V1ZyP92HDo></a>If we just updated the DOM in a loop, the page would freeze, and nothing would show up on the screen. Browsers do not update their display while a JavaScript program is running, nor do they allow any interaction with the page. This is why we need <code>requestAnimationFrame</code>—it lets the browser know that we are done for now, and it can go ahead and do the things that browsers do, such as updating the screen and responding to user actions.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_T1Drg7jSr7 class=p_ident id=p_T1Drg7jSr7></a>The animation function is passed the current time as an argument. To ensure that the motion of the cat per millisecond is stable, it bases the speed at which the angle changes on the difference between the current time and the last time the function ran. If it just moved the angle by a fixed amount per step, the motion would stutter if, for example, another heavy task running on the same computer were to prevent the function from running for a fraction of a second.</p> <p id=sin_cos><a href=https://eloquentjavascript.net/14_dom.html#p_C8QAvF7kWm class=p_ident id=p_C8QAvF7kWm></a>Moving in circles is done using the trigonometry functions <code>Math.cos</code> and <code>Math.sin</code>. For those who aren’t familiar with these, I’ll briefly introduce them since we will occasionally use them in this book.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_fz9+cW0plg class=p_ident id=p_fz9+cW0plg></a><code>Math.cos</code> and <code>Math.sin</code> are useful for finding points that lie on a circle around point (0,0) with a radius of one. Both functions interpret their argument as the position on this circle, with zero denoting the point on the far right of the circle, going clockwise until 2π (about 6.28) has taken us around the whole circle. <code>Math.cos</code> tells you the x-coordinate of the point that corresponds to the given position, and <code>Math.sin</code> yields the y-coordinate. Positions (or angles) greater than 2π or less than 0 are valid—the rotation repeats so that <em>a</em>+2π refers to the same angle as <em>a</em>.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_0LZN4Lli69 class=p_ident id=p_0LZN4Lli69></a>This unit for measuring angles is called radians—a full circle is 2π radians, similar to how it is 360 degrees when measuring in degrees. The constant π is available as <code>Math.PI</code> in JavaScript.</p><figure><img alt=\"Using cosine and sine to compute coordinates\" src=https://eloquentjavascript.net/img/cos_sin.svg></figure> <p><a href=https://eloquentjavascript.net/14_dom.html#p_9ovGFCxRhX class=p_ident id=p_9ovGFCxRhX></a>The cat animation code keeps a counter, <code>angle</code>, for the current angle of the animation and increments it every time the <code>animate</code> function is called. It can then use this angle to compute the current position of the image element. The <code>top</code> style is computed with <code>Math.sin</code> and multiplied by 20, which is the vertical radius of our ellipse. The <code>left</code> style is based on <code>Math.cos</code> and multiplied by 200 so that the ellipse is much wider than it is high.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_/Yly9Ir9QF class=p_ident id=p_/Yly9Ir9QF></a>Note that styles usually need <em>units</em>. In this case, we have to append <code>\"px\"</code> to the number to tell the browser that we are counting in pixels (as opposed to centimeters, “ems”, or other units). This is easy to forget. Using numbers without units will result in your style being ignored—unless the number is 0, which always means the same thing, regardless of its unit.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/14_dom.html#p_kLcHWntN1r class=p_ident id=p_kLcHWntN1r></a>JavaScript programs may inspect and interfere with the document that the browser is displaying through a data structure called the DOM. This data structure represents the browser’s model of the document, and a JavaScript program can modify it to change the visible document.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_7Ce58FA9bp class=p_ident id=p_7Ce58FA9bp></a>The DOM is organized like a tree, in which elements are arranged hierarchically according to the structure of the document. The objects representing elements have properties such as <code>parentNode</code> and <code>childNodes</code>, which can be used to navigate through this tree.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_KUJGKqAvJC class=p_ident id=p_KUJGKqAvJC></a>The way a document is displayed can be influenced by <em>styling</em>, both by attaching styles to nodes directly and by defining rules that match certain nodes. There are many different style properties, such as <code>color</code> or <code>display</code>. JavaScript code can manipulate an element’s style directly through its <code>style</code> property.</p> <h2><a href=https://eloquentjavascript.net/14_dom.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3 id=exercise_table><a href=https://eloquentjavascript.net/14_dom.html#i_g/5UC3zznV class=i_ident id=i_g/5UC3zznV></a>Build a table</h3> <p><a href=https://eloquentjavascript.net/14_dom.html#p_LuZsMlc8YJ class=p_ident id=p_LuZsMlc8YJ></a>An HTML table is built with the following tag structure:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_MudCG4cYiG class=c_ident id=c_MudCG4cYiG></a><p class=cm-tag>&lt;</p><p class=cm-tag>table</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>tr</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p>name<p class=cm-tag>&lt;/</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p>height<p class=cm-tag>&lt;/</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p>place<p class=cm-tag>&lt;/</p><p class=cm-tag>th</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>tr</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>tr</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p>Kilimanjaro<p class=cm-tag>&lt;/</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p>5895<p class=cm-tag>&lt;/</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p>Tanzania<p class=cm-tag>&lt;/</p><p class=cm-tag>td</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>tr</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>table</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/14_dom.html#p_xvnLvuqcz5 class=p_ident id=p_xvnLvuqcz5></a>For each <em>row</em>, the <code>&lt;table&gt;</code> tag contains a <code>&lt;tr&gt;</code> tag. Inside of these <code>&lt;tr&gt;</code> tags, we can put cell elements: either heading cells (<code>&lt;th&gt;</code>) or regular cells (<code>&lt;td&gt;</code>).</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Kz26QB0sIU class=p_ident id=p_Kz26QB0sIU></a>Given a data set of mountains, an array of objects with <code>name</code>, <code>height</code>, and <code>place</code> properties, generate the DOM structure for a table that enumerates the objects. It should have one column per key and one row per object, plus a header row with <code>&lt;th&gt;</code> elements at the top, listing the column names.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_mmjekKHDOX class=p_ident id=p_mmjekKHDOX></a>Write this so that the columns are automatically derived from the objects, by taking the property names of the first object in the data.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_EvtDcsiT4c class=p_ident id=p_EvtDcsiT4c></a>Add the resulting table to the element with an <code>id</code> attribute of <code>\"mountains\"</code> so that it becomes visible in the document.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Ve9FRgVfit class=p_ident id=p_Ve9FRgVfit></a>Once you have this working, right-align cells that contain number values by setting their <code>style.textAlign</code> property to <code>\"right\"</code>.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_SaASguUQJh class=c_ident id=c_SaASguUQJh></a><p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>Mountains<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"mountains\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>const</p> <p class=cm-def>MOUNTAINS</p> <p class=cm-operator>=</p> [ {<p class=cm-property>name</p>: <p class=cm-string>\"Kilimanjaro\"</p>, <p class=cm-property>height</p>: <p class=cm-number>5895</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Tanzania\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Everest\"</p>, <p class=cm-property>height</p>: <p class=cm-number>8848</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Nepal\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Mount Fuji\"</p>, <p class=cm-property>height</p>: <p class=cm-number>3776</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Japan\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Vaalserberg\"</p>, <p class=cm-property>height</p>: <p class=cm-number>323</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Netherlands\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Denali\"</p>, <p class=cm-property>height</p>: <p class=cm-number>6168</p>, <p class=cm-property>place</p>: <p class=cm-string>\"United States\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Popocatepetl\"</p>, <p class=cm-property>height</p>: <p class=cm-number>5465</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Mexico\"</p>}, {<p class=cm-property>name</p>: <p class=cm-string>\"Mont Blanc\"</p>, <p class=cm-property>height</p>: <p class=cm-number>4808</p>, <p class=cm-property>place</p>: <p class=cm-string>\"Italy/France\"</p>} ]; <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/14_dom.html#p_2Q6e2rAy5t class=p_ident id=p_2Q6e2rAy5t></a>You can use <code>document.<wbr>createElement</code> to create new element nodes, <code>document.<wbr>createTextNode</code> to create text nodes, and the <code>appendChild</code> method to put nodes into other nodes.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_BD8axR6MPn class=p_ident id=p_BD8axR6MPn></a>You’ll want to loop over the key names once to fill in the top row and then again for each object in the array to construct the data rows. To get an array of key names from the first object, <code>Object.keys</code> will be useful.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_f4AX6Lsiww class=p_ident id=p_f4AX6Lsiww></a>To add the table to the correct parent node, you can use <code>document.<wbr>getElementById</code> or <code>document.<wbr>querySelector</code> to find the node with the proper <code>id</code> attribute.</p> </div></div> <h3><a href=https://eloquentjavascript.net/14_dom.html#i_VSftnyRTsV class=i_ident id=i_VSftnyRTsV></a>Elements by tag name</h3> <p><a href=https://eloquentjavascript.net/14_dom.html#p_QviMLCSPLN class=p_ident id=p_QviMLCSPLN></a>The <code>document.<wbr>getElementsByTagName</code> method returns all child elements with a given tag name. Implement your own version of this as a function that takes a node and a string (the tag name) as arguments and returns an array containing all descendant element nodes with the given tag name.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_F3uW/zaQpy class=p_ident id=p_F3uW/zaQpy></a>To find the tag name of an element, use its <code>nodeName</code> property. But note that this will return the tag name in all uppercase. Use the <code>toLowerCase</code> or <code>toUpperCase</code> string methods to compensate for this.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_SHm9FthIXO class=c_ident id=c_SHm9FthIXO></a><p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>Heading with a <p class=cm-tag>&lt;</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>span<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p> element.<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>A paragraph with <p class=cm-tag>&lt;</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>one<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>, <p class=cm-tag>&lt;</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>two<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p> spans.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>byTagName</p>(<p class=cm-def>node</p>, <p class=cm-def>tagName</p>) { } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>byTagName</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-string>\"h1\"</p>).<p class=cm-property>length</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>byTagName</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-string>\"span\"</p>).<p class=cm-property>length</p>); <p class=cm-keyword>let</p> <p class=cm-def>para</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"p\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>byTagName</p>(<p class=cm-variable>para</p>, <p class=cm-string>\"span\"</p>).<p class=cm-property>length</p>); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/14_dom.html#p_M6sxoq7K9N class=p_ident id=p_M6sxoq7K9N></a>The solution is most easily expressed with a recursive function, similar to the <a href=https://eloquentjavascript.net/14_dom.html#talksAbout><code>talksAbout</code> function</a> defined earlier in this chapter.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_g/fG/I+qTc class=p_ident id=p_g/fG/I+qTc></a>You could call <code>byTagname</code> itself recursively, concatenating the resulting arrays to produce the output. Or you could create an inner function that calls itself recursively and that has access to an array binding defined in the outer function, to which it can add the matching elements it finds. Don’t forget to call the inner function once from the outer function to start the process.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_Zi3ayOqWyD class=p_ident id=p_Zi3ayOqWyD></a>The recursive function must check the node type. Here we are interested only in node type 1 (<code>Node.<wbr>ELEMENT_NODE</code>). For such nodes, we must loop over their children and, for each child, see whether the child matches the query while also doing a recursive call on it to inspect its own children.</p> </div></div> <h3><a href=https://eloquentjavascript.net/14_dom.html#i_b/LAqZUqyo class=i_ident id=i_b/LAqZUqyo></a>The cat’s hat</h3> <p><a href=https://eloquentjavascript.net/14_dom.html#p_6r1baDVOSE class=p_ident id=p_6r1baDVOSE></a>Extend the cat animation defined <a href=https://eloquentjavascript.net/14_dom.html#animation>earlier</a> so that both the cat and his hat (<code>&lt;img src=\"img/<wbr>hat.<wbr>png\"&gt;</code>) orbit at opposite sides of the ellipse.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_VqdQKV2uH0 class=p_ident id=p_VqdQKV2uH0></a>Or make the hat circle around the cat. Or alter the animation in some other interesting way.</p> <p><a href=https://eloquentjavascript.net/14_dom.html#p_3jJ377egS/ class=p_ident id=p_3jJ377egS/ ></a>To make positioning multiple objects easier, it is probably a good idea to switch to absolute positioning. This means that <code>top</code> and <code>left</code> are counted relative to the top left of the document. To avoid using negative coordinates, which would cause the image to move outside of the visible page, you can add a fixed number of pixels to the position values.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/14_dom.html#c_h3Gqsempqw class=c_ident id=c_h3Gqsempqw></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p><p class=cm-tag>body</p> { <p class=cm-property>min-height</p>: <p class=cm-number>200px</p> }<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/cat.png\"</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"cat\"</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"position: absolute\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>img</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"img/hat.png\"</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"hat\"</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"position: absolute\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>cat</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#cat\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>hat</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#hat\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>angle</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>let</p> <p class=cm-def>lastTime</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>; <p class=cm-keyword>function</p> <p class=cm-def>animate</p>(<p class=cm-def>time</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable>lastTime</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) <p class=cm-variable>angle</p> <p class=cm-operator>+=</p> (<p class=cm-variable-2>time</p> <p class=cm-operator>-</p> <p class=cm-variable>lastTime</p>) <p class=cm-operator>*</p> <p class=cm-number>0.001</p>; <p class=cm-variable>lastTime</p> <p class=cm-operator>=</p> <p class=cm-variable-2>time</p>; <p class=cm-variable>cat</p>.<p class=cm-property>style</p>.<p class=cm-property>top</p> <p class=cm-operator>=</p> (<p class=cm-variable>Math</p>.<p class=cm-property>sin</p>(<p class=cm-variable>angle</p>) <p class=cm-operator>*</p> <p class=cm-number>40</p> <p class=cm-operator>+</p> <p class=cm-number>40</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>cat</p>.<p class=cm-property>style</p>.<p class=cm-property>left</p> <p class=cm-operator>=</p> (<p class=cm-variable>Math</p>.<p class=cm-property>cos</p>(<p class=cm-variable>angle</p>) <p class=cm-operator>*</p> <p class=cm-number>200</p> <p class=cm-operator>+</p> <p class=cm-number>230</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-variable>animate</p>); } <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-variable>animate</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/14_dom.html#p_g8VVOKD2zX class=p_ident id=p_g8VVOKD2zX></a><code>Math.cos</code> and <code>Math.sin</code> measure angles in radians, where a full circle is 2π. For a given angle, you can get the opposite angle by adding half of this, which is <code>Math.PI</code>. This can be useful for putting the hat on the opposite side of the orbit.</p> </div></div><nav><a href=https://eloquentjavascript.net/13_browser.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/15_event.html>▶</a></nav>\n</article><hr><h4>Page 12</h4><article score=391.55>\n<nav><a href=https://eloquentjavascript.net/12_language.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/14_dom.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/13_browser.html#p_QvqpbswJB1 class=p_ident id=p_QvqpbswJB1></a>The dream behind the Web is of a common information space in which we communicate by sharing information. Its universality is essential: the fact that a hypertext link can point to anything, be it personal, local or global, be it draft or highly polished.</p> <footer>Tim Berners-Lee, <cite>The World Wide Web: A very short personal history</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a telephone switchboard\" src=https://eloquentjavascript.net/img/chapter_picture_13.jpg></figure> <p><a href=https://eloquentjavascript.net/13_browser.html#p_6xYW9QtXdj class=p_ident id=p_6xYW9QtXdj></a>The next chapters of this book will talk about web browsers. Without web browsers, there would be no JavaScript. Or even if there were, no one would ever have paid any attention to it.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_4wBY7T1C+9 class=p_ident id=p_4wBY7T1C+9></a>Web technology has been decentralized from the start, not just technically but also in the way it evolved. Various browser vendors have added new functionality in ad hoc and sometimes poorly thought-out ways, which then, sometimes, ended up being adopted by others—and finally set down as in standards.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_f7+s12+aB6 class=p_ident id=p_f7+s12+aB6></a>This is both a blessing and a curse. On the one hand, it is empowering to not have a central party control a system but have it be improved by various parties working in loose collaboration (or occasionally open hostility). On the other hand, the haphazard way in which the Web was developed means that the resulting system is not exactly a shining example of internal consistency. Some parts of it are downright confusing and poorly conceived.</p> <h2><a href=https://eloquentjavascript.net/13_browser.html#h_MYPczIw5xZ class=h_ident id=h_MYPczIw5xZ></a>Networks and the Internet</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_RpFiP9A355 class=p_ident id=p_RpFiP9A355></a>Computer networks have been around since the 1950s. If you put cables between two or more computers and allow them to send data back and forth through these cables, you can do all kinds of wonderful things.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_B/5G5eG3tT class=p_ident id=p_B/5G5eG3tT></a>And if connecting two machines in the same building allows us to do wonderful things, connecting machines all over the planet should be even better. The technology to start implementing this vision was developed in the 1980s, and the resulting network is called the <em>Internet</em>. It has lived up to its promise.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_syPs5XCgaK class=p_ident id=p_syPs5XCgaK></a>A computer can use this network to shoot bits at another computer. For any effective communication to arise out of this bit-shooting, the computers on both ends must know what the bits are supposed to represent. The meaning of any given sequence of bits depends entirely on the kind of thing that it is trying to express and on the encoding mechanism used.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_tlYBPgx73H class=p_ident id=p_tlYBPgx73H></a>A <em>network protocol</em> describes a style of communication over a network. There are protocols for sending email, for fetching email, for sharing files, and even for controlling computers that happen to be infected by malicious software.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_B7xXryH7Z0 class=p_ident id=p_B7xXryH7Z0></a>For example, the <em>Hypertext Transfer Protocol</em> (HTTP) is a protocol for retrieving named resources (chunks of information, such as web pages or pictures). It specifies that the side making the request should start with a line like this, naming the resource and the version of the protocol that it is trying to use:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_lC/Gwm2hWr class=c_ident id=c_lC/Gwm2hWr></a>GET /index.html HTTP/1.1</pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_xfDuPAt1np class=p_ident id=p_xfDuPAt1np></a>There are a lot more rules about the way the requester can include more information in the request and the way the other side, which returns the resource, packages up its content. We’ll look at HTTP in a little more detail in <a href=https://eloquentjavascript.net/18_http.html>Chapter 18</a>.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_kEu/pbT49n class=p_ident id=p_kEu/pbT49n></a>Most protocols are built on top of other protocols. HTTP treats the network as a streamlike device into which you can put bits and have them arrive at the correct destination in the correct order. As we saw in <a href=https://eloquentjavascript.net/11_async.html>Chapter 11</a>, ensuring those things is already a rather difficult problem.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_7IOEk4hhjX class=p_ident id=p_7IOEk4hhjX></a>The <em>Transmission Control Protocol</em> (TCP) is a protocol that addresses this problem. All Internet-connected devices “speak” it, and most communication on the Internet is built on top of it.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_R1N5wYYFn+ class=p_ident id=p_R1N5wYYFn+></a>A TCP connection works as follows: one computer must be waiting, or <em>listening</em>, for other computers to start talking to it. To be able to listen for different kinds of communication at the same time on a single machine, each listener has a number (called a <em>port</em>) associated with it. Most protocols specify which port should be used by default. For example, when we want to send an email using the SMTP protocol, the machine through which we send it is expected to be listening on port 25.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_C9NFg/yfxC class=p_ident id=p_C9NFg/yfxC></a>Another computer can then establish a connection by connecting to the target machine using the correct port number. If the target machine can be reached and is listening on that port, the connection is successfully created. The listening computer is called the <em>server</em>, and the connecting computer is called the <em>client</em>.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_g48pTp1IKV class=p_ident id=p_g48pTp1IKV></a>Such a connection acts as a two-way pipe through which bits can flow—the machines on both ends can put data into it. Once the bits are successfully transmitted, they can be read out again by the machine on the other side. This is a convenient model. You could say that TCP provides an abstraction of the network.</p> <h2 id=web><a href=https://eloquentjavascript.net/13_browser.html#h_tbGTd9Llzv class=h_ident id=h_tbGTd9Llzv></a>The Web</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_w4VQt163Im class=p_ident id=p_w4VQt163Im></a>The <em>World Wide Web</em> (not to be confused with the Internet as a whole) is a set of protocols and formats that allow us to visit web pages in a browser. The “Web” part in the name refers to the fact that such pages can easily link to each other, thus connecting into a huge mesh that users can move through.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_sD0EeCxfSf class=p_ident id=p_sD0EeCxfSf></a>To become part of the Web, all you need to do is connect a machine to the Internet and have it listen on port 80 with the HTTP protocol so that other computers can ask it for documents.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_KH3H5PXZlk class=p_ident id=p_KH3H5PXZlk></a>Each document on the Web is named by a <em>Uniform Resource Locator</em> (URL), which looks something like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_szDcTXPXE8 class=c_ident id=c_szDcTXPXE8></a>  http://eloquentjavascript.net/13_browser.html\n |      |                      |               |\n protocol       server               path</pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_0F4MKpLU9B class=p_ident id=p_0F4MKpLU9B></a>The first part tells us that this URL uses the HTTP protocol (as opposed to, for example, encrypted HTTP, which would be <em>https://</em>). Then comes the part that identifies which server we are requesting the document from. Last is a path string that identifies the specific document (or <em>resource</em>) we are interested in.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_Otsk2MtA94 class=p_ident id=p_Otsk2MtA94></a>Machines connected to the Internet get an <em>IP address</em>, which is a number that can be used to send messages to that machine, and looks something like <code>149.210.142.219</code> or <code>2001:4860:4860::8888</code>. But lists of more or less random numbers are hard to remember and awkward to type, so you can instead register a <em>domain name</em> for a specific address or set of addresses. I registered <em>eloquentjavascript.net</em> to point at the IP address of a machine I control and can thus use that domain name to serve web pages.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_DEpzgqGWvq class=p_ident id=p_DEpzgqGWvq></a>If you type this URL into your browser’s address bar, the browser will try to retrieve and display the document at that URL. First, your browser has to find out what address <em>eloquentjavascript.net</em> refers to. Then, using the HTTP protocol, it will make a connection to the server at that address and ask for the resource <em>/13_browser.html</em>. If all goes well, the server sends back a document, which your browser then displays on your screen.</p> <h2><a href=https://eloquentjavascript.net/13_browser.html#h_n3OM6EV/KR class=h_ident id=h_n3OM6EV/KR></a>HTML</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_m2H1Cp4ACJ class=p_ident id=p_m2H1Cp4ACJ></a>HTML, which stands for <em>Hypertext Markup Language</em>, is the document format used for web pages. An HTML document contains text, as well as <em>tags</em> that give structure to the text, describing things such as links, paragraphs, and headings.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_X9UXPRiLgl class=p_ident id=p_X9UXPRiLgl></a>A short HTML document might look like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_4GPwlAMrQs class=c_ident id=c_4GPwlAMrQs></a>\n<p class=cm-tag>&lt;</p><p class=cm-tag>html</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>head</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>meta</p> <p class=cm-attribute>charset</p>=<p class=cm-string>\"utf-8\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>head</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Hello, I am Marijn and this is my home page.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>I also wrote a book! Read it <p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"http://eloquentjavascript.net\"</p><p class=cm-tag>&gt;</p>here<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p>.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>html</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_zP6SuTzWSr class=p_ident id=p_zP6SuTzWSr></a>The tags, wrapped in angle brackets (<code>&lt;</code> and <code>&gt;</code>, the symbols for <em>less than</em> and <em>greater than</em>), provide information about the structure of the document. The other text is just plain text.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_7PI7BADgG4 class=p_ident id=p_7PI7BADgG4></a>The document starts with <code>&lt;!doctype html&gt;</code>, which tells the browser to interpret the page as <em>modern</em> HTML, as opposed to various dialects that were in use in the past.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_TMtmUAUMPQ class=p_ident id=p_TMtmUAUMPQ></a>HTML documents have a head and a body. The head contains information <em>about</em> the document, and the body contains the document itself. In this case, the head declares that the title of this document is “My home page” and that it uses the UTF-8 encoding, which is a way to encode Unicode text as binary data. The document’s body contains a heading (<code>&lt;h1&gt;</code>, meaning “heading 1”—<code>&lt;h2&gt;</code> to <code>&lt;h6&gt;</code> produce subheadings) and two paragraphs (<code>&lt;p&gt;</code>).</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_twHeUPgGnQ class=p_ident id=p_twHeUPgGnQ></a>Tags come in several forms. An element, such as the body, a paragraph, or a link, is started by an <em>opening tag</em> like <code>&lt;p&gt;</code> and ended by a <em>closing tag</em> like <code>&lt;/p&gt;</code>. Some opening tags, such as the one for the link (<code>&lt;a&gt;</code>), contain extra information in the form of <code>name=\"value\"</code> pairs. These are called <em>attributes</em>. In this case, the destination of the link is indicated with <code>href=\"http://<wbr>eloquentjavascript.<wbr>net\"</code>, where <code>href</code> stands for “hypertext reference”.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_oLeQsmpoFC class=p_ident id=p_oLeQsmpoFC></a>Some kinds of tags do not enclose anything and thus do not need to be closed. The metadata tag <code>&lt;meta charset=\"utf-8\"&gt;</code> is an example of this.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_aDzWCv6pnm class=p_ident id=p_aDzWCv6pnm></a>To be able to include angle brackets in the text of a document, even though they have a special meaning in HTML, yet another form of special notation has to be introduced. A plain opening angle bracket is written as <code>&amp;lt;</code> (“less than”), and a closing bracket is written as <code>&amp;gt;</code> (“greater than”). In HTML, an ampersand (<code>&amp;</code>) character followed by a name or character code and a semicolon (<code>;</code>) is called an <em>entity</em> and will be replaced by the character it encodes.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_BVTrBS/gKt class=p_ident id=p_BVTrBS/gKt></a>This is analogous to the way backslashes are used in JavaScript strings. Since this mechanism gives ampersand characters a special meaning, too, they need to be escaped as <code>&amp;amp;</code>. Inside attribute values, which are wrapped in double quotes, <code>&amp;quot;</code> can be used to insert an actual quote character.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_RK6LQEinS9 class=p_ident id=p_RK6LQEinS9></a>HTML is parsed in a remarkably error-tolerant way. When tags that should be there are missing, the browser reconstructs them. The way in which this is done has been standardized, and you can rely on all modern browsers to do it in the same way.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_hnbBzl0NyQ class=p_ident id=p_hnbBzl0NyQ></a>The following document will be treated just like the one shown previously:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_uW331sfiez class=c_ident id=c_uW331sfiez></a> <p class=cm-tag>&lt;</p><p class=cm-tag>meta</p> <p class=cm-attribute>charset</p>=<p class=cm-string>utf-8</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>title</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>My home page<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Hello, I am Marijn and this is my home page.\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>I also wrote a book! Read it <p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>http://eloquentjavascript.net</p><p class=cm-tag>&gt;</p>here<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p>.</pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_0ji/iAsoGd class=p_ident id=p_0ji/iAsoGd></a>The <code>&lt;html&gt;</code>, <code>&lt;head&gt;</code>, and <code>&lt;body&gt;</code> tags are gone completely. The browser knows that <code>&lt;meta&gt;</code> and <code>&lt;title&gt;</code> belong in the head and that <code>&lt;h1&gt;</code> means the body has started. Furthermore, I am no longer explicitly closing the paragraphs since opening a new paragraph or ending the document will close them implicitly. The quotes around the attribute values are also gone.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_849RpAZtxv class=p_ident id=p_849RpAZtxv></a>This book will usually omit the <code>&lt;html&gt;</code>, <code>&lt;head&gt;</code>, and <code>&lt;body&gt;</code> tags from examples to keep them short and free of clutter. But I <em>will</em> close tags and include quotes around attributes.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_xJbQ1KdKG6 class=p_ident id=p_xJbQ1KdKG6></a>I will also usually omit the doctype and <code>charset</code> declaration. This is not to be taken as an encouragement to drop these from HTML documents. Browsers will often do ridiculous things when you forget them. You should consider the doctype and the <code>charset</code> metadata to be implicitly present in examples, even when they are not actually shown in the text.</p> <h2 id=script_tag><a href=https://eloquentjavascript.net/13_browser.html#h_x9VDt2sTZZ class=h_ident id=h_x9VDt2sTZZ></a>HTML and JavaScript</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_yGq/gOJF3i class=p_ident id=p_yGq/gOJF3i></a>In the context of this book, the most important HTML tag is <code>&lt;script&gt;</code>. This tag allows us to include a piece of JavaScript in a document.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_r/8m2Qh59j class=c_ident id=c_r/8m2Qh59j></a><p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>Testing alert<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p><p class=cm-variable>alert</p>(<p class=cm-string>\"hello!\"</p>);<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_sQGLHtZgi0 class=p_ident id=p_sQGLHtZgi0></a>Such a script will run as soon as its <code>&lt;script&gt;</code> tag is encountered while the browser reads the HTML. This page will pop up a dialog when opened—the <code>alert</code> function resembles <code>prompt</code>, in that it pops up a little window, but only shows a message without asking for input.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_GmDPwY/KfO class=p_ident id=p_GmDPwY/KfO></a>Including large programs directly in HTML documents is often impractical. The <code>&lt;script&gt;</code> tag can be given an <code>src</code> attribute to fetch a script file (a text file containing a JavaScript program) from a URL.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_UGuRtQ4i0u class=c_ident id=c_UGuRtQ4i0u></a><p class=cm-tag>&lt;</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>Testing alert<p class=cm-tag>&lt;/</p><p class=cm-tag>h1</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p> <p class=cm-attribute>src</p>=<p class=cm-string>\"code/hello.js\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_Hz/JcRYmOp class=p_ident id=p_Hz/JcRYmOp></a>The <em>code/hello.js</em> file included here contains the same program—<code>alert(\"hello!\")</code>. When an HTML page references other URLs as part of itself—for example, an image file or a script—web browsers will retrieve them immediately and include them in the page.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_DLaR5M/yDv class=p_ident id=p_DLaR5M/yDv></a>A script tag must always be closed with <code>&lt;/script&gt;</code>, even if it refers to a script file and doesn’t contain any code. If you forget this, the rest of the page will be interpreted as part of the script.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_G01s8wj6pP class=p_ident id=p_G01s8wj6pP></a>You can load ES modules (see <a href=https://eloquentjavascript.net/10_modules.html#es>Chapter 10</a>) in the browser by giving your script tag a <code>type=\"module\"</code> attribute. Such modules can depend on other modules by using URLs relative to themselves as module names in <code>import</code> declarations.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_DDA5xIdUC1 class=p_ident id=p_DDA5xIdUC1></a>Some attributes can also contain a JavaScript program. The <code>&lt;button&gt;</code> tag shown next (which shows up as a button) has an <code>onclick</code> attribute. The attribute’s value will be run whenever the button is clicked.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/13_browser.html#c_2a6WfPL3P2 class=c_ident id=c_2a6WfPL3P2></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>onclick</p>=<p class=cm-string>\"alert('Boom!');\"</p><p class=cm-tag>&gt;</p>DO NOT PRESS<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/13_browser.html#p_ua9bcAZLko class=p_ident id=p_ua9bcAZLko></a>Note that I had to use single quotes for the string in the <code>onclick</code> attribute because double quotes are already used to quote the whole attribute. I could also have used <code>&amp;quot;</code>.</p> <h2><a href=https://eloquentjavascript.net/13_browser.html#h_xSthu5StoL class=h_ident id=h_xSthu5StoL></a>In the sandbox</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_AniKiqdG2y class=p_ident id=p_AniKiqdG2y></a>Running programs downloaded from the Internet is potentially dangerous. You do not know much about the people behind most sites you visit, and they do not necessarily mean well. Running programs by people who do not mean well is how you get your computer infected by viruses, your data stolen, and your accounts hacked.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_D7H4XfnmGB class=p_ident id=p_D7H4XfnmGB></a>Yet the attraction of the Web is that you can browse it without necessarily trusting all the pages you visit. This is why browsers severely limit the things a JavaScript program may do: it can’t look at the files on your computer or modify anything not related to the web page it was embedded in.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_46UloKEL0E class=p_ident id=p_46UloKEL0E></a>Isolating a programming environment in this way is called <em>sandboxing</em>, the idea being that the program is harmlessly playing in a sandbox. But you should imagine this particular kind of sandbox as having a cage of thick steel bars over it so that the programs playing in it can’t actually get out.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_7pNt468QvZ class=p_ident id=p_7pNt468QvZ></a>The hard part of sandboxing is allowing the programs enough room to be useful yet at the same time restricting them from doing anything dangerous. Lots of useful functionality, such as communicating with other servers or reading the content of the copy-paste clipboard, can also be used to do problematic, privacy-invading things.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_vavJ6h7++M class=p_ident id=p_vavJ6h7++M></a>Every now and then, someone comes up with a new way to circumvent the limitations of a browser and do something harmful, ranging from leaking minor private information to taking over the whole machine that the browser runs on. The browser developers respond by fixing the hole, and all is well again—until the next problem is discovered, and hopefully publicized, rather than secretly exploited by some government agency or mafia.</p> <h2><a href=https://eloquentjavascript.net/13_browser.html#h_p42hxqLkOm class=h_ident id=h_p42hxqLkOm></a>Compatibility and the browser wars</h2> <p><a href=https://eloquentjavascript.net/13_browser.html#p_EZKXamx/Cn class=p_ident id=p_EZKXamx/Cn></a>In the early stages of the Web, a browser called Mosaic dominated the market. After a few years, the balance shifted to Netscape, which was then, in turn, largely supplanted by Microsoft’s Internet Explorer. At any point where a single browser was dominant, that browser’s vendor would feel entitled to unilaterally invent new features for the Web. Since most users used the most popular browser, websites would simply start using those features—never mind the other browsers.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_78bXJk2Qn6 class=p_ident id=p_78bXJk2Qn6></a>This was the dark age of compatibility, often called the <em>browser wars</em>. Web developers were left with not one unified Web but two or three incompatible platforms. To make things worse, the browsers in use around 2003 were all full of bugs, and of course the bugs were different for each browser. Life was hard for people writing web pages.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_K5Wu7RrwZS class=p_ident id=p_K5Wu7RrwZS></a>Mozilla Firefox, a not-for-profit offshoot of Netscape, challenged Internet Explorer’s position in the late 2000s. Because Microsoft was not particularly interested in staying competitive at the time, Firefox took a lot of market share away from it. Around the same time, Google introduced its Chrome browser, and Apple’s Safari browser gained popularity, leading to a situation where there were four major players, rather than one.</p> <p><a href=https://eloquentjavascript.net/13_browser.html#p_ztjPRIOS1D class=p_ident id=p_ztjPRIOS1D></a>The new players had a more serious attitude toward standards and better engineering practices, giving us less incompatibility and fewer bugs. Microsoft, seeing its market share crumble, came around and adopted these attitudes in its Edge browser, which replaces Internet Explorer. If you are starting to learn web development today, consider yourself lucky. The latest versions of the major browsers behave quite uniformly and have relatively few bugs.</p><nav><a href=https://eloquentjavascript.net/12_language.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/14_dom.html>▶</a></nav>\n</article><hr><h4>Page 13</h4><article score=927.2049999999999>\n<nav><a href=https://eloquentjavascript.net/17_canvas.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/19_paint.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/18_http.html#p_oMpq82ALLD class=p_ident id=p_oMpq82ALLD></a>Communication must be stateless in nature [...] such that each request from client to server must contain all of the information necessary to understand the request, and cannot take advantage of any stored context on the server.</p> <footer>Roy Fielding, <cite>Architectural Styles and the Design of Network-based Software Architectures</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a web form on a medieval scroll\" src=https://eloquentjavascript.net/img/chapter_picture_18.jpg></figure> <p><a href=https://eloquentjavascript.net/18_http.html#p_C6+RXvCvFu class=p_ident id=p_C6+RXvCvFu></a>The <em>Hypertext Transfer Protocol</em>, already mentioned in <a href=https://eloquentjavascript.net/13_browser.html#web>Chapter 13</a>, is the mechanism through which data is requested and provided on the World Wide Web. This chapter describes the protocol in more detail and explains the way browser JavaScript has access to it.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_vXdZCu/Tty class=h_ident id=h_vXdZCu/Tty></a>The protocol</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_uAGANEYkBZ class=p_ident id=p_uAGANEYkBZ></a>If you type <em>eloquentjavascript.net/18_http.html</em> into your browser’s address bar, the browser first looks up the address of the server associated with <em>eloquentjavascript.net</em> and tries to open a TCP connection to it on port 80, the default port for HTTP traffic. If the server exists and accepts the connection, the browser might send something like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Y12YPXciUz class=c_ident id=c_Y12YPXciUz></a>GET /18_http.html HTTP/1.1\nHost: eloquentjavascript.net\nUser-Agent: Your browser's name</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_cpaXDnG/vq class=p_ident id=p_cpaXDnG/vq></a>Then the server responds, through that same connection.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Y84SZaL9nl class=c_ident id=c_Y84SZaL9nl></a>HTTP/1.1 200 OK\nContent-Length: 65585\nContent-Type: text/html\nLast-Modified: Mon, 08 Jan 2018 10:29:45 GMT\n\n&lt;!doctype html&gt;\n... the rest of the document</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_W+0FSsrSY0 class=p_ident id=p_W+0FSsrSY0></a>The browser takes the part of the response after the blank line, its <em>body</em> (not to be confused with the HTML <code>&lt;body&gt;</code> tag), and displays it as an HTML document.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_EF5P7+qf9n class=p_ident id=p_EF5P7+qf9n></a>The information sent by the client is called the <em>request</em>. It starts with this line:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_q82hekYuxl class=c_ident id=c_q82hekYuxl></a>GET /18_http.html HTTP/1.1</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_RhcvCQnL7N class=p_ident id=p_RhcvCQnL7N></a>The first word is the <em>method</em> of the request. <code>GET</code> means that we want to <em>get</em> the specified resource. Other common methods are <code>DELETE</code> to delete a resource, <code>PUT</code> to create or replace it, and <code>POST</code> to send information to it. Note that the server is not obliged to carry out every request it gets. If you walk up to a random website and tell it to <code>DELETE</code> its main page, it’ll probably refuse.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_dRtHLefq7L class=p_ident id=p_dRtHLefq7L></a>The part after the method name is the path of the <em>resource</em> the request applies to. In the simplest case, a resource is simply a file on the server, but the protocol doesn’t require it to be. A resource may be anything that can be transferred <em>as if</em> it is a file. Many servers generate the responses they produce on the fly. For example, if you open <a href=https://github.com/marijnh><em>https://github.com/marijnh</em></a>, the server looks in its database for a user named “marijnh”, and if it finds one, it will generate a profile page for that user.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_P7s+ccxZW6 class=p_ident id=p_P7s+ccxZW6></a>After the resource path, the first line of the request mentions <code>HTTP/1.1</code> to indicate the version of the HTTP protocol it is using.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_mQcW6s4Mx4 class=p_ident id=p_mQcW6s4Mx4></a>In practice, many sites use HTTP version 2, which supports the same concepts as version 1.1 but is a lot more complicated so that it can be faster. Browsers will automatically switch to the appropriate protocol version when talking to a given server, and the outcome of a request is the same regardless of which version is used. Because version 1.1 is more straightforward and easier to play around with, we’ll focus on that.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_ADqYIHJxxD class=p_ident id=p_ADqYIHJxxD></a>The server’s response will start with a version as well, followed by the status of the response, first as a three-digit status code and then as a human-readable string.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_A6dkQ5Qg2b class=c_ident id=c_A6dkQ5Qg2b></a>HTTP/1.1 200 OK</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_I8BGMaErRo class=p_ident id=p_I8BGMaErRo></a>Status codes starting with a 2 indicate that the request succeeded. Codes starting with 4 mean there was something wrong with the request. 404 is probably the most famous HTTP status code—it means that the resource could not be found. Codes that start with 5 mean an error happened on the server and the request is not to blame.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_1ObQMSreRj class=c_ident id=c_1ObQMSreRj></a>Content-Length: 65585\nContent-Type: text/html\nLast-Modified: Thu, 04 Jan 2018 14:05:30 GMT</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_04zcUGZ8sT class=p_ident id=p_04zcUGZ8sT></a>This tells us the size and type of the response document. In this case, it is an HTML document of 65,585 bytes. It also tells us when that document was last modified.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_CoUIJDjIMb class=p_ident id=p_CoUIJDjIMb></a>For most headers, the client and server are free to decide whether to include them in a request or response. But a few are required. For example, the <code>Host</code> header, which specifies the hostname, should be included in a request because a server might be serving multiple hostnames on a single IP address, and without that header, the server won’t know which hostname the client is trying to talk to.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_DeF17lBSIn class=p_ident id=p_DeF17lBSIn></a>After the headers, both requests and responses may include a blank line followed by a body, which contains the data being sent. <code>GET</code> and <code>DELETE</code> requests don’t send along any data, but <code>PUT</code> and <code>POST</code> requests do. Similarly, some response types, such as error responses, do not require a body.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_G1xxLfiYeu class=h_ident id=h_G1xxLfiYeu></a>Browsers and HTTP</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_di/c79dO8s class=p_ident id=p_di/c79dO8s></a>As we saw in the example, a browser will make a request when we enter a URL in its address bar. When the resulting HTML page references other files, such as images and JavaScript files, those are also retrieved.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_H5hfE5XTVU class=p_ident id=p_H5hfE5XTVU></a>A moderately complicated website can easily include anywhere from 10 to 200 resources. To be able to fetch those quickly, browsers will make several <code>GET</code> requests simultaneously, rather than waiting for the responses one at a time.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_Aub9jfdnAA class=p_ident id=p_Aub9jfdnAA></a>HTML pages may include <em>forms</em>, which allow the user to fill out information and send it to the server. This is an example of a form:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_feixSy0wew class=c_ident id=c_feixSy0wew></a><p class=cm-tag>&lt;</p><p class=cm-tag>form</p> <p class=cm-attribute>method</p>=<p class=cm-string>\"GET\"</p> <p class=cm-attribute>action</p>=<p class=cm-string>\"example/message.html\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Name: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"name\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Message:<p class=cm-tag>&lt;</p><p class=cm-tag>br</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"message\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"submit\"</p><p class=cm-tag>&gt;</p>Send<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>form</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_wzIYNG3lpP class=p_ident id=p_wzIYNG3lpP></a>This code describes a form with two fields: a small one asking for a name and a larger one to write a message in. When you click the Send button, the form is <em>submitted</em>, meaning that the content of its field is packed into an HTTP request and the browser navigates to the result of that request.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_vktFCcfPRa class=p_ident id=p_vktFCcfPRa></a>When the <code>&lt;form&gt;</code> element’s <code>method</code> attribute is <code>GET</code> (or is omitted), the information in the form is added to the end of the <code>action</code> URL as a <em>query string</em>. The browser might make a request to this URL:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_1RUljJwVrY class=c_ident id=c_1RUljJwVrY></a>GET /example/message.html?name=Jean&amp;message=Yes%3F HTTP/1.1</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_T5aHHLPL5V class=p_ident id=p_T5aHHLPL5V></a>The question mark indicates the end of the path part of the URL and the start of the query. It is followed by pairs of names and values, corresponding to the <code>name</code> attribute on the form field elements and the content of those elements, respectively. An ampersand character (<code>&amp;</code>) is used to separate the pairs.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_4Eo/x5v9Qy class=p_ident id=p_4Eo/x5v9Qy></a>The actual message encoded in the URL is “Yes?”, but the question mark is replaced by a strange code. Some characters in query strings must be escaped. The question mark, represented as <code>%3F</code>, is one of those. There seems to be an unwritten rule that every format needs its own way of escaping characters. This one, called <em>URL encoding</em>, uses a percent sign followed by two hexadecimal (base 16) digits that encode the character code. In this case, 3F, which is 63 in decimal notation, is the code of a question mark character. JavaScript provides the <code>encodeURIComponent</code> and <code>decodeURIComponent</code> functions to encode and decode this format.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_v2cBL8Tnwf class=c_ident id=c_v2cBL8Tnwf></a><p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>encodeURIComponent</p>(<p class=cm-string>\"Yes?\"</p>)); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>decodeURIComponent</p>(<p class=cm-string>\"Yes%3F\"</p>));\n</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_l15d9HkVlZ class=p_ident id=p_l15d9HkVlZ></a>If we change the <code>method</code> attribute of the HTML form in the example we saw earlier to <code>POST</code>, the HTTP request made to submit the form will use the <code>POST</code> method and put the query string in the body of the request, rather than adding it to the URL.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_5Xyh6tIq0d class=c_ident id=c_5Xyh6tIq0d></a>POST /example/message.html HTTP/1.1\nContent-length: 24\nContent-type: application/x-www-form-urlencoded\n\nname=Jean&amp;message=Yes%3F</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_DK/cEfFOLx class=p_ident id=p_DK/cEfFOLx></a><code>GET</code> requests should be used for requests that do not have side effects but simply ask for information. Requests that change something on the server, for example creating a new account or posting a message, should be expressed with other methods, such as <code>POST</code>. Client-side software such as a browser knows that it shouldn’t blindly make <code>POST</code> requests but will often implicitly make <code>GET</code> requests—for example to prefetch a resource it believes the user will soon need.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_DhsgH7HhV5 class=p_ident id=p_DhsgH7HhV5></a>We’ll come back to forms and how to interact with them from JavaScript <a href=https://eloquentjavascript.net/18_http.html#forms>later in the chapter</a>.</p> <h2 id=fetch><a href=https://eloquentjavascript.net/18_http.html#h_1Iqv5okrKE class=h_ident id=h_1Iqv5okrKE></a>Fetch</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_N4uvmrpYsh class=p_ident id=p_N4uvmrpYsh></a>The interface through which browser JavaScript can make HTTP requests is called <code>fetch</code>. Since it is relatively new, it conveniently uses promises (which is rare for browser interfaces).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_RHiMHW5ptB class=c_ident id=c_RHiMHW5ptB></a><p class=cm-variable>fetch</p>(<p class=cm-string>\"example/data.txt\"</p>).<p class=cm-property>then</p>(<p class=cm-def>response</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>response</p>.<p class=cm-property>status</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>response</p>.<p class=cm-property>headers</p>.<p class=cm-property>get</p>(<p class=cm-string>\"Content-Type\"</p>));\n  \n});</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_nEI47jB1j7 class=p_ident id=p_nEI47jB1j7></a>Calling <code>fetch</code> returns a promise that resolves to a <code>Response</code> object holding information about the server’s response, such as its status code and its headers. The headers are wrapped in a <code>Map</code>-like object that treats its keys (the header names) as case insensitive because header names are not supposed to be case sensitive. This means <code>headers.<wbr>get(\"Content-Type\")</code> and <code>headers.<wbr>get(\"content-TYPE\")</code> will return the same value.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_9+aWsoAyy9 class=p_ident id=p_9+aWsoAyy9></a>Note that the promise returned by <code>fetch</code> resolves successfully even if the server responded with an error code. It <em>might</em> also be rejected if there is a network error or if the server that the request is addressed to can’t be found.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_5r0Wgj3ZeL class=p_ident id=p_5r0Wgj3ZeL></a>The first argument to <code>fetch</code> is the URL that should be requested. When that URL doesn’t start with a protocol name (such as <em>http:</em>), it is treated as <em>relative</em>, which means it is interpreted relative to the current document. When it starts with a slash (/), it replaces the current path, which is the part after the server name. When it does not, the part of the current path up to and including its last slash character is put in front of the relative URL.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_I7dcmG9O8z class=p_ident id=p_I7dcmG9O8z></a>To get at the actual content of a response, you can use its <code>text</code> method. Because the initial promise is resolved as soon as the response’s headers have been received and because reading the response body might take a while longer, this again returns a promise.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_p/pN7BXNbA class=c_ident id=c_p/pN7BXNbA></a><p class=cm-variable>fetch</p>(<p class=cm-string>\"example/data.txt\"</p>) .<p class=cm-property>then</p>(<p class=cm-def>resp</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>resp</p>.<p class=cm-property>text</p>()) .<p class=cm-property>then</p>(<p class=cm-def>text</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>text</p>));\n</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_yKDs0M+BWY class=p_ident id=p_yKDs0M+BWY></a>A similar method, called <code>json</code>, returns a promise that resolves to the value you get when parsing the body as JSON or rejects if it’s not valid JSON.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_zqk7Gjqi6s class=p_ident id=p_zqk7Gjqi6s></a>By default, <code>fetch</code> uses the <code>GET</code> method to make its request and does not include a request body. You can configure it differently by passing an object with extra options as a second argument. For example, this request tries to delete <code>example/data.txt</code>:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_hrJqISfbr3 class=c_ident id=c_hrJqISfbr3></a><p class=cm-variable>fetch</p>(<p class=cm-string>\"example/data.txt\"</p>, {<p class=cm-property>method</p>: <p class=cm-string>\"DELETE\"</p>}).<p class=cm-property>then</p>(<p class=cm-def>resp</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable-2>resp</p>.<p class=cm-property>status</p>);\n  \n});</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_NyyktLENAG class=p_ident id=p_NyyktLENAG></a>The 405 status code means “method not allowed”, an HTTP server’s way of saying “I can’t do that”.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_60thNhmBur class=p_ident id=p_60thNhmBur></a>To add a request body, you can include a <code>body</code> option. To set headers, there’s the <code>headers</code> option. For example, this request includes a <code>Range</code> header, which instructs the server to return only part of a response.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_ayu6SNFLBc class=c_ident id=c_ayu6SNFLBc></a><p class=cm-variable>fetch</p>(<p class=cm-string>\"example/data.txt\"</p>, {<p class=cm-property>headers</p>: {<p class=cm-property>Range</p>: <p class=cm-string>\"bytes=8-19\"</p>}}) .<p class=cm-property>then</p>(<p class=cm-def>resp</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>resp</p>.<p class=cm-property>text</p>()) .<p class=cm-property>then</p>(<p class=cm-variable>console</p>.<p class=cm-property>log</p>);\n</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_bD3Fa3HIuA class=p_ident id=p_bD3Fa3HIuA></a>The browser will automatically add some request headers, such as “Host” and those needed for the server to figure out the size of the body. But adding your own headers is often useful to include things such as authentication information or to tell the server which file format you’d like to receive.</p> <h2 id=http_sandbox><a href=https://eloquentjavascript.net/18_http.html#h_4h3DL+zoLY class=h_ident id=h_4h3DL+zoLY></a>HTTP sandboxing</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_JiU9W0PiCv class=p_ident id=p_JiU9W0PiCv></a>Making HTTP requests in web page scripts once again raises concerns about security. The person who controls the script might not have the same interests as the person on whose computer it is running. More specifically, if I visit <em>themafia.org</em>, I do not want its scripts to be able to make a request to <em>mybank.com</em>, using identifying information from my browser, with instructions to transfer all my money to some random account.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_XbYnzVu8E9 class=p_ident id=p_XbYnzVu8E9></a>For this reason, browsers protect us by disallowing scripts to make HTTP requests to other domains (names such as <em>themafia.org</em> and <em>mybank.com</em>).</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_g7fM23J7Wi class=p_ident id=p_g7fM23J7Wi></a>This can be an annoying problem when building systems that want to access several domains for legitimate reasons. Fortunately, servers can include a header like this in their response to explicitly indicate to the browser that it is okay for the request to come from another domain:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_kNUaXkbMWE class=c_ident id=c_kNUaXkbMWE></a>Access-Control-Allow-Origin: *</pre> <h2><a href=https://eloquentjavascript.net/18_http.html#h_OJmHENDG5y class=h_ident id=h_OJmHENDG5y></a>Appreciating HTTP</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_dVrq2xCOfJ class=p_ident id=p_dVrq2xCOfJ></a>When building a system that requires communication between a JavaScript program running in the browser (client-side) and a program on a server (server-side), there are several different ways to model this communication.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_xJpo9CMhYT class=p_ident id=p_xJpo9CMhYT></a>A commonly used model is that of <em>remote procedure calls</em>. In this model, communication follows the patterns of normal function calls, except that the function is actually running on another machine. Calling it involves making a request to the server that includes the function’s name and arguments. The response to that request contains the returned value.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_7z+OqsDVUu class=p_ident id=p_7z+OqsDVUu></a>When thinking in terms of remote procedure calls, HTTP is just a vehicle for communication, and you will most likely write an abstraction layer that hides it entirely.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_dOvEvBngFh class=p_ident id=p_dOvEvBngFh></a>Another approach is to build your communication around the concept of resources and HTTP methods. Instead of a remote procedure called <code>addUser</code>, you use a <code>PUT</code> request to <code>/users/larry</code>. Instead of encoding that user’s properties in function arguments, you define a JSON document format (or use an existing format) that represents a user. The body of the <code>PUT</code> request to create a new resource is then such a document. A resource is fetched by making a <code>GET</code> request to the resource’s URL (for example, <code>/user/larry</code>), which again returns the document representing the resource.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_YwC80f9YNp class=p_ident id=p_YwC80f9YNp></a>This second approach makes it easier to use some of the features that HTTP provides, such as support for caching resources (keeping a copy on the client for fast access). The concepts used in HTTP, which are well designed, can provide a helpful set of principles to design your server interface around.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_oDqIFugKX4 class=h_ident id=h_oDqIFugKX4></a>Security and HTTPS</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_VAyObUfHZm class=p_ident id=p_VAyObUfHZm></a>Data traveling over the Internet tends to follow a long, dangerous road. To get to its destination, it must hop through anything from coffee shop Wi-Fi hotspots to networks controlled by various companies and states. At any point along its route it may be inspected or even modified.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_FkVKmUiG/R class=p_ident id=p_FkVKmUiG/R></a>If it is important that something remain secret, such as the password to your email account, or that it arrive at its destination unmodified, such as the account number you transfer money to via your bank’s website, plain HTTP is not good enough.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_s1KEZa2j+E class=p_ident id=p_s1KEZa2j+E></a>The secure HTTP protocol, used for URLs starting with <em>https://</em>, wraps HTTP traffic in a way that makes it harder to read and tamper with. Before exchanging data, the client verifies that the server is who it claims to be by asking it to prove that it has a cryptographic certificate issued by a certificate authority that the browser recognizes. Next, all data going over the connection is encrypted in a way that should prevent eavesdropping and tampering.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_e4DTn5YT85 class=p_ident id=p_e4DTn5YT85></a>Thus, when it works right, HTTPS prevents other people from impersonating the website you are trying to talk to and from snooping on your communication. It is not perfect, and there have been various incidents where HTTPS failed because of forged or stolen certificates and broken software, but it is a <em>lot</em> safer than plain HTTP.</p> <h2 id=forms><a href=https://eloquentjavascript.net/18_http.html#h_H222GOgM6T class=h_ident id=h_H222GOgM6T></a>Form fields</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_TyplG8H3xg class=p_ident id=p_TyplG8H3xg></a>Forms were originally designed for the pre-JavaScript Web to allow web sites to send user-submitted information in an HTTP request. This design assumes that interaction with the server always happens by navigating to a new page.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_fnL4EDXYjc class=p_ident id=p_fnL4EDXYjc></a>But their elements are part of the DOM like the rest of the page, and the DOM elements that represent form fields support a number of properties and events that are not present on other elements. These make it possible to inspect and control such input fields with JavaScript programs and do things such as adding new functionality to a form or using forms and fields as building blocks in a JavaScript application.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_pfSLM800x5 class=p_ident id=p_pfSLM800x5></a>A web form consists of any number of input fields grouped in a <code>&lt;form&gt;</code> tag. HTML allows several different styles of fields, ranging from simple on/off checkboxes to drop-down menus and fields for text input. This book won’t try to comprehensively discuss all field types, but we’ll start with a rough overview.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_Rhphckn33e class=p_ident id=p_Rhphckn33e></a>A lot of field types use the <code>&lt;input&gt;</code> tag. This tag’s <code>type</code> attribute is used to select the field’s style. These are some commonly used <code>&lt;input&gt;</code> types:</p> <table> <tbody><tr><td><code>text</code></td><td>A single-line text field</td> </tr> <tr><td><code>password</code></td><td>Same as <code>text</code> but hides the text that is typed</td> </tr> <tr><td><code>checkbox</code></td><td>An on/off switch</td> </tr> <tr><td><code>radio</code></td><td>(Part of) a multiple-choice field</td> </tr> <tr><td><code>file</code></td><td>Allows the user to choose a file from their computer</td> </tr> </tbody></table> <p><a href=https://eloquentjavascript.net/18_http.html#p_wq9TjeOZyz class=p_ident id=p_wq9TjeOZyz></a>Form fields do not necessarily have to appear in a <code>&lt;form&gt;</code> tag. You can put them anywhere in a page. Such form-less fields cannot be submitted (only a form as a whole can), but when responding to input with JavaScript, we often don’t want to submit our fields normally anyway.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_BwDEUfcPYP class=c_ident id=c_BwDEUfcPYP></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"abc\"</p><p class=cm-tag>&gt;</p> (text)<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"password\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"abc\"</p><p class=cm-tag>&gt;</p> (password)<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"checkbox\"</p> <p class=cm-attribute>checked</p><p class=cm-tag>&gt;</p> (checkbox)<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"A\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"choice\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"B\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"choice\"</p> <p class=cm-attribute>checked</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"C\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"choice\"</p><p class=cm-tag>&gt;</p> (radio)<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"file\"</p><p class=cm-tag>&gt;</p> (file)<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_EMkwu3giRV class=p_ident id=p_EMkwu3giRV></a>The JavaScript interface for such elements differs with the type of the element.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_dU8xgBYYQy class=p_ident id=p_dU8xgBYYQy></a>Multiline text fields have their own tag, <code>&lt;textarea&gt;</code>, mostly because using an attribute to specify a multiline starting value would be awkward. The <code>&lt;textarea&gt;</code> tag requires a matching <code>&lt;/<wbr>textarea&gt;</code> closing tag and uses the text between those two, instead of the <code>value</code> attribute, as starting text.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_ta2qUMw3tQ class=c_ident id=c_ta2qUMw3tQ></a><p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p>\none\ntwo\nthree\n<p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_ZYw2re7bQY class=p_ident id=p_ZYw2re7bQY></a>Finally, the <code>&lt;select&gt;</code> tag is used to create a field that allows the user to select from a number of predefined options.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_ZxJgtmof49 class=c_ident id=c_ZxJgtmof49></a><p class=cm-tag>&lt;</p><p class=cm-tag>select</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p>Pancakes<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p>Pudding<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p>Ice cream<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>select</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_RNW9gGQ0uZ class=p_ident id=p_RNW9gGQ0uZ></a>Whenever the value of a form field changes, it will fire a <code>\"change\"</code> event.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_/n9VuL9o/U class=h_ident id=h_/n9VuL9o/U></a>Focus</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_sv9Kp9pqvi class=p_ident id=p_sv9Kp9pqvi></a>Unlike most elements in HTML documents, form fields can get <em>keyboard focus</em>. When clicked or activated in some other way, they become the currently active element and the recipient of keyboard input.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_Hyh25uQbKJ class=p_ident id=p_Hyh25uQbKJ></a>Thus, you can type into a text field only when it is focused. Other fields respond differently to keyboard events. For example, a <code>&lt;select&gt;</code> menu tries to move to the option that contains the text the user typed and responds to the arrow keys by moving its selection up and down.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_bTNSIbb+d4 class=p_ident id=p_bTNSIbb+d4></a>We can control focus from JavaScript with the <code>focus</code> and <code>blur</code> methods. The first moves focus to the DOM element it is called on, and the second removes focus. The value in <code>document.<wbr>activeElement</code> corresponds to the currently focused element.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_QrBgwnycJO class=c_ident id=c_QrBgwnycJO></a><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"input\"</p>).<p class=cm-property>focus</p>(); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>document</p>.<p class=cm-property>activeElement</p>.<p class=cm-property>tagName</p>); <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"input\"</p>).<p class=cm-property>blur</p>(); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>document</p>.<p class=cm-property>activeElement</p>.<p class=cm-property>tagName</p>); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_ymv/ML6eGQ class=p_ident id=p_ymv/ML6eGQ></a>For some pages, the user is expected to want to interact with a form field immediately. JavaScript can be used to focus this field when the document is loaded, but HTML also provides the <code>autofocus</code> attribute, which produces the same effect while letting the browser know what we are trying to achieve. This gives the browser the option to disable the behavior when it is not appropriate, such as when the user has put the focus on something else.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_IgspvfRub5 class=p_ident id=p_IgspvfRub5></a>Browsers traditionally also allow the user to move the focus through the document by pressing the <span class=keyname>tab</span> key. We can influence the order in which elements receive focus with the <code>tabindex</code> attribute. The following example document will let the focus jump from the text input to the OK button, rather than going through the help link first:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_DXorT/vrbR class=c_ident id=c_DXorT/vrbR></a><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>tabindex</p>=<p class=cm-string>1</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\".\"</p><p class=cm-tag>&gt;</p>(help)<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>onclick</p>=<p class=cm-string>\"console.log('ok')\"</p> <p class=cm-attribute>tabindex</p>=<p class=cm-string>2</p><p class=cm-tag>&gt;</p>OK<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_F/Js9FpFgt class=p_ident id=p_F/Js9FpFgt></a>By default, most types of HTML elements cannot be focused. But you can add a <code>tabindex</code> attribute to any element that will make it focusable. A <code>tabindex</code> of -1 makes tabbing skip over an element, even if it is normally focusable.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_l2z9T1FDym class=h_ident id=h_l2z9T1FDym></a>Disabled fields</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_avmCql+rjT class=p_ident id=p_avmCql+rjT></a>All form fields can be <em>disabled</em> through their <code>disabled</code> attribute. It is an attribute that can be specified without value—the fact that it is present at all disables the element.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_f++NW8087u class=c_ident id=c_f++NW8087u></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>I'm all right<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>disabled</p><p class=cm-tag>&gt;</p>I'm out<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_GR2MtLESGu class=p_ident id=p_GR2MtLESGu></a>Disabled fields cannot be focused or changed, and browsers make them look gray and faded.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_Q2URIcrW6H class=p_ident id=p_Q2URIcrW6H></a>When a program is in the process of handling an action caused by some button or other control that might require communication with the server and thus take a while, it can be a good idea to disable the control until the action finishes. That way, when the user gets impatient and clicks it again, they don’t accidentally repeat their action.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_R8SZxHmDt0 class=h_ident id=h_R8SZxHmDt0></a>The form as a whole</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_G8aitsjxoL class=p_ident id=p_G8aitsjxoL></a>When a field is contained in a <code>&lt;form&gt;</code> element, its DOM element will have a <code>form</code> property linking back to the form’s DOM element. The <code>&lt;form&gt;</code> element, in turn, has a property called <code>elements</code> that contains an array-like collection of the fields inside it.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_unq0zWRWC6 class=p_ident id=p_unq0zWRWC6></a>The <code>name</code> attribute of a form field determines the way its value will be identified when the form is submitted. It can also be used as a property name when accessing the form’s <code>elements</code> property, which acts both as an array-like object (accessible by number) and a map (accessible by name).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_2pmbvR5Jhe class=c_ident id=c_2pmbvR5Jhe></a><p class=cm-tag>&lt;</p><p class=cm-tag>form</p> <p class=cm-attribute>action</p>=<p class=cm-string>\"example/submit.html\"</p><p class=cm-tag>&gt;</p> Name: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"name\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>br</p><p class=cm-tag>&gt;</p> Password: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"password\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"password\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>br</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"submit\"</p><p class=cm-tag>&gt;</p>Log in<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>form</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>form</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"form\"</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>form</p>.<p class=cm-property>elements</p>[<p class=cm-number>1</p>].<p class=cm-property>type</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>form</p>.<p class=cm-property>elements</p>.<p class=cm-property>password</p>.<p class=cm-property>type</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>form</p>.<p class=cm-property>elements</p>.<p class=cm-property>name</p>.<p class=cm-property>form</p> <p class=cm-operator>==</p> <p class=cm-variable>form</p>); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_DOQDGp4ZWr class=p_ident id=p_DOQDGp4ZWr></a>A button with a <code>type</code> attribute of <code>submit</code> will, when pressed, cause the form to be submitted. Pressing <span class=keyname>enter</span> when a form field is focused has the same effect.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_MVbboPCoBM class=p_ident id=p_MVbboPCoBM></a>Submitting a form normally means that the browser navigates to the page indicated by the form’s <code>action</code> attribute, using either a <code>GET</code> or a <code>POST</code> request. But before that happens, a <code>\"submit\"</code> event is fired. You can handle this event with JavaScript and prevent this default behavior by calling <code>preventDefault</code> on the event object.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Zv/K0ruWJS class=c_ident id=c_Zv/K0ruWJS></a><p class=cm-tag>&lt;</p><p class=cm-tag>form</p> <p class=cm-attribute>action</p>=<p class=cm-string>\"example/submit.html\"</p><p class=cm-tag>&gt;</p> Value: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"value\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"submit\"</p><p class=cm-tag>&gt;</p>Save<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>form</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>form</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"form\"</p>); <p class=cm-variable>form</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"submit\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Saving value\"</p>, <p class=cm-variable>form</p>.<p class=cm-property>elements</p>.<p class=cm-property>value</p>.<p class=cm-property>value</p>); <p class=cm-variable-2>event</p>.<p class=cm-property>preventDefault</p>(); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_wqAnsOYW3V class=p_ident id=p_wqAnsOYW3V></a>Intercepting <code>\"submit\"</code> events in JavaScript has various uses. We can write code to verify that the values the user entered make sense and immediately show an error message instead of submitting the form. Or we can disable the regular way of submitting the form entirely, as in the example, and have our program handle the input, possibly using <code>fetch</code> to send it to a server without reloading the page.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_+RaBROT23F class=h_ident id=h_+RaBROT23F></a>Text fields</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_NENXbP9XTb class=p_ident id=p_NENXbP9XTb></a>Fields created by <code>&lt;textarea&gt;</code> tags, or <code>&lt;input&gt;</code> tags with a type of <code>text</code> or <code>password</code>, share a common interface. Their DOM elements have a <code>value</code> property that holds their current content as a string value. Setting this property to another string changes the field’s content.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_xQSknx93fe class=p_ident id=p_xQSknx93fe></a>The <code>selectionStart</code> and <code>selectionEnd</code> properties of text fields give us information about the cursor and selection in the text. When nothing is selected, these two properties hold the same number, indicating the position of the cursor. For example, 0 indicates the start of the text, and 10 indicates the cursor is after the 10<sup>th</sup> character. When part of the field is selected, the two properties will differ, giving us the start and end of the selected text. Like <code>value</code>, these properties may also be written to.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_VlvYL2VLoi class=p_ident id=p_VlvYL2VLoi></a>Imagine you are writing an article about Khasekhemwy but have some trouble spelling his name. The following code wires up a <code>&lt;textarea&gt;</code> tag with an event handler that, when you press F2, inserts the string “Khasekhemwy” for you.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_bpWFxEi3zn class=c_ident id=c_bpWFxEi3zn></a><p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>textarea</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"textarea\"</p>); <p class=cm-variable>textarea</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keydown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>keyCode</p> <p class=cm-operator>==</p> <p class=cm-number>113</p>) { <p class=cm-variable>replaceSelection</p>(<p class=cm-variable>textarea</p>, <p class=cm-string>\"Khasekhemwy\"</p>); <p class=cm-variable-2>event</p>.<p class=cm-property>preventDefault</p>(); } }); <p class=cm-keyword>function</p> <p class=cm-def>replaceSelection</p>(<p class=cm-def>field</p>, <p class=cm-def>word</p>) { <p class=cm-keyword>let</p> <p class=cm-def>from</p> <p class=cm-operator>=</p> <p class=cm-variable-2>field</p>.<p class=cm-property>selectionStart</p>, <p class=cm-def>to</p> <p class=cm-operator>=</p> <p class=cm-variable-2>field</p>.<p class=cm-property>selectionEnd</p>; <p class=cm-variable-2>field</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-variable-2>field</p>.<p class=cm-property>value</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>from</p>) <p class=cm-operator>+</p> <p class=cm-variable-2>word</p> <p class=cm-operator>+</p> <p class=cm-variable-2>field</p>.<p class=cm-property>value</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>to</p>); <p class=cm-variable-2>field</p>.<p class=cm-property>selectionStart</p> <p class=cm-operator>=</p> <p class=cm-variable-2>from</p> <p class=cm-operator>+</p> <p class=cm-variable-2>word</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>field</p>.<p class=cm-property>selectionEnd</p> <p class=cm-operator>=</p> <p class=cm-variable-2>from</p> <p class=cm-operator>+</p> <p class=cm-variable-2>word</p>.<p class=cm-property>length</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_XRaVO9Iigu class=p_ident id=p_XRaVO9Iigu></a>The <code>replaceSelection</code> function replaces the currently selected part of a text field’s content with the given word and then moves the cursor after that word so that the user can continue typing.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_7ehU5cu5aF class=p_ident id=p_7ehU5cu5aF></a>The <code>\"change\"</code> event for a text field does not fire every time something is typed. Rather, it fires when the field loses focus after its content was changed. To respond immediately to changes in a text field, you should register a handler for the <code>\"input\"</code> event instead, which fires for every time the user types a character, deletes text, or otherwise manipulates the field’s content.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_rladqIVDE4 class=p_ident id=p_rladqIVDE4></a>The following example shows a text field and a counter displaying the current length of the text in the field:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_FW2nBbCoKe class=c_ident id=c_FW2nBbCoKe></a><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p><p class=cm-tag>&gt;</p> length: <p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"length\"</p><p class=cm-tag>&gt;</p>0<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"input\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>output</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#length\"</p>); <p class=cm-variable>text</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"input\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>output</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-variable>text</p>.<p class=cm-property>value</p>.<p class=cm-property>length</p>; });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/18_http.html#h_axUK+XNvTN class=h_ident id=h_axUK+XNvTN></a>Checkboxes and radio buttons</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_DFZwKUx9E+ class=p_ident id=p_DFZwKUx9E+></a>A checkbox field is a binary toggle. Its value can be extracted or changed through its <code>checked</code> property, which holds a Boolean value.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_QDNdcETI4b class=c_ident id=c_QDNdcETI4b></a><p class=cm-tag>&lt;</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"checkbox\"</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"purple\"</p><p class=cm-tag>&gt;</p> Make this page purple\n<p class=cm-tag>&lt;/</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>checkbox</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#purple\"</p>); <p class=cm-variable>checkbox</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>style</p>.<p class=cm-property>background</p> <p class=cm-operator>=</p> <p class=cm-variable>checkbox</p>.<p class=cm-property>checked</p> <p class=cm-operator>?</p> <p class=cm-string>\"mediumpurple\"</p> : <p class=cm-string>\"\"</p>; });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_kQbNxPLuR2 class=p_ident id=p_kQbNxPLuR2></a>The <code>&lt;label&gt;</code> tag associates a piece of document with an input field. Clicking anywhere on the label will activate the field, which focuses it and toggles its value when it is a checkbox or radio button.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_vNsiBxZlre class=p_ident id=p_vNsiBxZlre></a>A radio button is similar to a checkbox, but it’s implicitly linked to other radio buttons with the same <code>name</code> attribute so that only one of them can be active at any time.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_tM2CEiReVh class=c_ident id=c_tM2CEiReVh></a>Color:\n<p class=cm-tag>&lt;</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"color\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"orange\"</p><p class=cm-tag>&gt;</p> Orange\n<p class=cm-tag>&lt;/</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"color\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"lightgreen\"</p><p class=cm-tag>&gt;</p> Green\n<p class=cm-tag>&lt;/</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"radio\"</p> <p class=cm-attribute>name</p>=<p class=cm-string>\"color\"</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"lightblue\"</p><p class=cm-tag>&gt;</p> Blue\n<p class=cm-tag>&lt;/</p><p class=cm-tag>label</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>buttons</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelectorAll</p>(<p class=cm-string>\"[name=color]\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>button</p> <p class=cm-keyword>of</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>buttons</p>)) { <p class=cm-variable>button</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>style</p>.<p class=cm-property>background</p> <p class=cm-operator>=</p> <p class=cm-variable>button</p>.<p class=cm-property>value</p>; }); }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_OM3AMgKt0y class=p_ident id=p_OM3AMgKt0y></a>The square brackets in the CSS query given to <code>querySelectorAll</code> are used to match attributes. It selects elements whose <code>name</code> attribute is <code>\"color\"</code>.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_eaB6RprDK3 class=h_ident id=h_eaB6RprDK3></a>Select fields</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_C43QMBKrcK class=p_ident id=p_C43QMBKrcK></a>Select fields are conceptually similar to radio buttons—they also allow the user to choose from a set of options. But where a radio button puts the layout of the options under our control, the appearance of a <code>&lt;select&gt;</code> tag is determined by the browser.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_cSTgnCzv3c class=p_ident id=p_cSTgnCzv3c></a>Select fields also have a variant that is more akin to a list of checkboxes, rather than radio boxes. When given the <code>multiple</code> attribute, a <code>&lt;select&gt;</code> tag will allow the user to select any number of options, rather than just a single option. This will, in most browsers, show up differently than a normal select field, which is typically drawn as a <em>drop-down</em> control that shows the options only when you open it.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_D7R79xBFg4 class=p_ident id=p_D7R79xBFg4></a>Each <code>&lt;option&gt;</code> tag has a value. This value can be defined with a <code>value</code> attribute. When that is not given, the text inside the option will count as its value. The <code>value</code> property of a <code>&lt;select&gt;</code> element reflects the currently selected option. For a <code>multiple</code> field, though, this property doesn’t mean much since it will give the value of only <em>one</em> of the currently selected options.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_cuEVUjcKsy class=p_ident id=p_cuEVUjcKsy></a>The <code>&lt;option&gt;</code> tags for a <code>&lt;select&gt;</code> field can be accessed as an array-like object through the field’s <code>options</code> property. Each option has a property called <code>selected</code>, which indicates whether that option is currently selected. The property can also be written to select or deselect an option.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_MaAZPlhgSY class=p_ident id=p_MaAZPlhgSY></a>This example extracts the selected values from a <code>multiple</code> select field and uses them to compose a binary number from individual bits. Hold <span class=keyname>control</span> (or <span class=keyname>command</span> on a Mac) to select multiple options.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Jh/nb6UYLR class=c_ident id=c_Jh/nb6UYLR></a><p class=cm-tag>&lt;</p><p class=cm-tag>select</p> <p class=cm-attribute>multiple</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"1\"</p><p class=cm-tag>&gt;</p>0001<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"2\"</p><p class=cm-tag>&gt;</p>0010<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"4\"</p><p class=cm-tag>&gt;</p>0100<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>option</p> <p class=cm-attribute>value</p>=<p class=cm-string>\"8\"</p><p class=cm-tag>&gt;</p>1000<p class=cm-tag>&lt;/</p><p class=cm-tag>option</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>select</p><p class=cm-tag>&gt;</p> = <p class=cm-tag>&lt;</p><p class=cm-tag>span</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"output\"</p><p class=cm-tag>&gt;</p>0<p class=cm-tag>&lt;/</p><p class=cm-tag>span</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>select</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"select\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>output</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#output\"</p>); <p class=cm-variable>select</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>number</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>option</p> <p class=cm-keyword>of</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>select</p>.<p class=cm-property>options</p>)) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>option</p>.<p class=cm-property>selected</p>) { <p class=cm-variable-2>number</p> <p class=cm-operator>+=</p> <p class=cm-variable>Number</p>(<p class=cm-variable-2>option</p>.<p class=cm-property>value</p>); } } <p class=cm-variable>output</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-variable-2>number</p>; });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/18_http.html#h_tK84z183/8 class=h_ident id=h_tK84z183/8></a>File fields</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_12DuX873Jk class=p_ident id=p_12DuX873Jk></a>File fields were originally designed as a way to upload files from the user’s machine through a form. In modern browsers, they also provide a way to read such files from JavaScript programs. The field acts as a kind of gatekeeper. The script cannot simply start reading private files from the user’s computer, but if the user selects a file in such a field, the browser interprets that action to mean that the script may read the file.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_nfUpEs7Vxe class=p_ident id=p_nfUpEs7Vxe></a>A file field usually looks like a button labeled with something like “choose file” or “browse”, with information about the chosen file next to it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Gg47yko2dF class=c_ident id=c_Gg47yko2dF></a><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"file\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>input</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"input\"</p>); <p class=cm-variable>input</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable>input</p>.<p class=cm-property>files</p>.<p class=cm-property>length</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-keyword>let</p> <p class=cm-def>file</p> <p class=cm-operator>=</p> <p class=cm-variable>input</p>.<p class=cm-property>files</p>[<p class=cm-number>0</p>]; <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You chose\"</p>, <p class=cm-variable-2>file</p>.<p class=cm-property>name</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>file</p>.<p class=cm-property>type</p>) <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"It has type\"</p>, <p class=cm-variable-2>file</p>.<p class=cm-property>type</p>); } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_9WVMeVLeav class=p_ident id=p_9WVMeVLeav></a>The <code>files</code> property of a file field element is an array-like object (again, not a real array) containing the files chosen in the field. It is initially empty. The reason there isn’t simply a <code>file</code> property is that file fields also support a <code>multiple</code> attribute, which makes it possible to select multiple files at the same time.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_yUTGY9XA00 class=p_ident id=p_yUTGY9XA00></a>Objects in the <code>files</code> object have properties such as <code>name</code> (the filename), <code>size</code> (the file’s size in bytes, which are chunks of 8 bits), and <code>type</code> (the media type of the file, such as <code>text/plain</code> or <code>image/jpeg</code>).</p> <p id=filereader><a href=https://eloquentjavascript.net/18_http.html#p_BUCcjCybzf class=p_ident id=p_BUCcjCybzf></a>What it does not have is a property that contains the content of the file. Getting at that is a little more involved. Since reading a file from disk can take time, the interface must be asynchronous to avoid freezing the document.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_NWBXf4dpgg class=c_ident id=c_NWBXf4dpgg></a><p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"file\"</p> <p class=cm-attribute>multiple</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>input</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"input\"</p>); <p class=cm-variable>input</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>file</p> <p class=cm-keyword>of</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>input</p>.<p class=cm-property>files</p>)) { <p class=cm-keyword>let</p> <p class=cm-def>reader</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>FileReader</p>(); <p class=cm-variable-2>reader</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"load\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"File\"</p>, <p class=cm-variable-2>file</p>.<p class=cm-property>name</p>, <p class=cm-string>\"starts with\"</p>, <p class=cm-variable-2>reader</p>.<p class=cm-property>result</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-number>20</p>)); }); <p class=cm-variable-2>reader</p>.<p class=cm-property>readAsText</p>(<p class=cm-variable-2>file</p>); } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_WTVG7dhgkK class=p_ident id=p_WTVG7dhgkK></a>Reading a file is done by creating a <code>FileReader</code> object, registering a <code>\"load\"</code> event handler for it, and calling its <code>readAsText</code> method, giving it the file we want to read. Once loading finishes, the reader’s <code>result</code> property contains the file’s content.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_K4QhByVIWK class=p_ident id=p_K4QhByVIWK></a><code>FileReader</code>s also fire an <code>\"error\"</code> event when reading the file fails for any reason. The error object itself will end up in the reader’s <code>error</code> property. This interface was designed before promises became part of the language. You could wrap it in a promise like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_Kr3V9NFjD7 class=c_ident id=c_Kr3V9NFjD7></a><p class=cm-keyword>function</p> <p class=cm-def>readFileText</p>(<p class=cm-def>file</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>((<p class=cm-def>resolve</p>, <p class=cm-def>reject</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>reader</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>FileReader</p>(); <p class=cm-variable-2>reader</p>.<p class=cm-property>addEventListener</p>( <p class=cm-string>\"load\"</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>reader</p>.<p class=cm-property>result</p>)); <p class=cm-variable-2>reader</p>.<p class=cm-property>addEventListener</p>( <p class=cm-string>\"error\"</p>, () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>reject</p>(<p class=cm-variable-2>reader</p>.<p class=cm-property>error</p>)); <p class=cm-variable-2>reader</p>.<p class=cm-property>readAsText</p>(<p class=cm-variable-2>file</p>);\n  });\n}</pre> <h2><a href=https://eloquentjavascript.net/18_http.html#h_xMhbz7W4BY class=h_ident id=h_xMhbz7W4BY></a>Storing data client-side</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_JABB1DfeON class=p_ident id=p_JABB1DfeON></a>Simple HTML pages with a bit of JavaScript can be a great format for “mini applications”—small helper programs that automate basic tasks. By connecting a few form fields with event handlers, you can do anything from converting between centimeters and inches to computing passwords from a master password and a website name.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_ZDof7+yfRJ class=p_ident id=p_ZDof7+yfRJ></a>When such an application needs to remember something between sessions, you cannot use JavaScript bindings—those are thrown away every time the page is closed. You could set up a server, connect it to the Internet, and have your application store something there. We will see how to do that in <a href=https://eloquentjavascript.net/20_node.html>Chapter 20</a>. But that’s a lot of extra work and complexity. Sometimes it is enough to just keep the data in the browser.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_tijRqdmE+T class=p_ident id=p_tijRqdmE+T></a>The <code>localStorage</code> object can be used to store data in a way that survives page reloads. This object allows you to file string values under names.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_zS9vKuxYED class=c_ident id=c_zS9vKuxYED></a><p class=cm-variable>localStorage</p>.<p class=cm-property>setItem</p>(<p class=cm-string>\"username\"</p>, <p class=cm-string>\"marijn\"</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-variable>localStorage</p>.<p class=cm-property>getItem</p>(<p class=cm-string>\"username\"</p>)); <p class=cm-variable>localStorage</p>.<p class=cm-property>removeItem</p>(<p class=cm-string>\"username\"</p>);</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_6Jr54na1O5 class=p_ident id=p_6Jr54na1O5></a>A value in <code>localStorage</code> sticks around until it is overwritten, it is removed with <code>removeItem</code>, or the user clears their local data.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_rQBn/5RRw1 class=p_ident id=p_rQBn/5RRw1></a>Sites from different domains get different storage compartments. That means data stored in <code>localStorage</code> by a given website can, in principle, be read (and overwritten) only by scripts on that same site.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_QOv0pecyix class=p_ident id=p_QOv0pecyix></a>Browsers do enforce a limit on the size of the data a site can store in <code>localStorage</code>. That restriction, along with the fact that filling up people’s hard drives with junk is not really profitable, prevents the feature from eating up too much space.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_nOUdqdshUV class=p_ident id=p_nOUdqdshUV></a>The following code implements a crude note-taking application. It keeps a set of named notes and allows the user to edit notes and create new ones.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_7EHyh6Vlvw class=c_ident id=c_7EHyh6Vlvw></a>Notes: <p class=cm-tag>&lt;</p><p class=cm-tag>select</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>select</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>Add<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;</p><p class=cm-tag>br</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"width: 100%\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>list</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"select\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>note</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"textarea\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>state</p>; <p class=cm-keyword>function</p> <p class=cm-def>setState</p>(<p class=cm-def>newState</p>) { <p class=cm-variable>list</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>name</p> <p class=cm-keyword>of</p> <p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable-2>newState</p>.<p class=cm-property>notes</p>)) { <p class=cm-keyword>let</p> <p class=cm-def>option</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-string>\"option\"</p>); <p class=cm-variable-2>option</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-variable-2>name</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>newState</p>.<p class=cm-property>selected</p> <p class=cm-operator>==</p> <p class=cm-variable-2>name</p>) <p class=cm-variable-2>option</p>.<p class=cm-property>selected</p> <p class=cm-operator>=</p> <p class=cm-atom>true</p>; <p class=cm-variable>list</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>option</p>); } <p class=cm-variable>note</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newState</p>.<p class=cm-property>notes</p>[<p class=cm-variable-2>newState</p>.<p class=cm-property>selected</p>]; <p class=cm-variable>localStorage</p>.<p class=cm-property>setItem</p>(<p class=cm-string>\"Notes\"</p>, <p class=cm-variable>JSON</p>.<p class=cm-property>stringify</p>(<p class=cm-variable-2>newState</p>)); <p class=cm-variable>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newState</p>; } <p class=cm-variable>setState</p>(<p class=cm-variable>JSON</p>.<p class=cm-property>parse</p>(<p class=cm-variable>localStorage</p>.<p class=cm-property>getItem</p>(<p class=cm-string>\"Notes\"</p>)) <p class=cm-operator>|</p><p class=cm-operator>|</p> { <p class=cm-property>notes</p>: {<p class=cm-string>\"shopping list\"</p>: <p class=cm-string>\"Carrots\\nRaisins\"</p>}, <p class=cm-property>selected</p>: <p class=cm-string>\"shopping list\"</p> }); <p class=cm-variable>list</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>setState</p>({<p class=cm-property>notes</p>: <p class=cm-variable>state</p>.<p class=cm-property>notes</p>, <p class=cm-property>selected</p>: <p class=cm-variable>list</p>.<p class=cm-property>value</p>}); }); <p class=cm-variable>note</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"change\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>setState</p>({ <p class=cm-property>notes</p>: <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable>state</p>.<p class=cm-property>notes</p>, {[<p class=cm-variable>state</p>.<p class=cm-property>selected</p>]: <p class=cm-variable>note</p>.<p class=cm-property>value</p>}), <p class=cm-property>selected</p>: <p class=cm-variable>state</p>.<p class=cm-property>selected</p> }); }); <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"button\"</p>) .<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>name</p> <p class=cm-operator>=</p> <p class=cm-variable>prompt</p>(<p class=cm-string>\"Note name\"</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>name</p>) <p class=cm-variable>setState</p>({ <p class=cm-property>notes</p>: <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable>state</p>.<p class=cm-property>notes</p>, {[<p class=cm-variable-2>name</p>]: <p class=cm-string>\"\"</p>}), <p class=cm-property>selected</p>: <p class=cm-variable-2>name</p> }); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_KKRjPQnlpK class=p_ident id=p_KKRjPQnlpK></a>The script gets its starting state from the <code>\"Notes\"</code> value stored in <code>localStorage</code> or, if that is missing, creates an example state that has only a shopping list in it. Reading a field that does not exist from <code>localStorage</code> will yield <code>null</code>. Passing <code>null</code> to <code>JSON.parse</code> will make it parse the string <code>\"null\"</code> and return <code>null</code>. Thus, the <code>||</code> operator can be used to provide a default value in a situation like this.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_vsgpRLsWlg class=p_ident id=p_vsgpRLsWlg></a>The <code>setState</code> method makes sure the DOM is showing a given state and stores the new state to <code>localStorage</code>. Event handlers call this function to move to a new state.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_KLQOhbE5S6 class=p_ident id=p_KLQOhbE5S6></a>The use of <code>Object.assign</code> in the example is intended to create a new object that is a clone of the old <code>state.notes</code>, but with one property added or overwritten. <code>Object.assign</code> takes its first argument and adds all properties from any further arguments to it. Thus, giving it an empty object will cause it to fill a fresh object. The square brackets notation in the third argument is used to create a property whose name is based on some dynamic value.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_McB+3/vKwy class=p_ident id=p_McB+3/vKwy></a>There is another object, similar to <code>localStorage</code>, called <code>sessionStorage</code>. The difference between the two is that the content of <code>sessionStorage</code> is forgotten at the end of each <em>session</em>, which for most browsers means whenever the browser is closed.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/18_http.html#p_1249Ox6nXm class=p_ident id=p_1249Ox6nXm></a>In this chapter, we discussed how the HTTP protocol works. A <em>client</em> sends a request, which contains a method (usually <code>GET</code>) and a path that identifies a resource. The <em>server</em> then decides what to do with the request and responds with a status code and a response body. Both requests and responses may contain headers that provide additional information.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_taYkCAtnud class=p_ident id=p_taYkCAtnud></a>The interface through which browser JavaScript can make HTTP requests is called <code>fetch</code>. Making a request looks like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_I5lSLBiG+b class=c_ident id=c_I5lSLBiG+b></a><p class=cm-variable>fetch</p>(<p class=cm-string>\"/18_http.html\"</p>).<p class=cm-property>then</p>(<p class=cm-def>r</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>r</p>.<p class=cm-property>text</p>()).<p class=cm-property>then</p>(<p class=cm-def>text</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`The page starts with ${</p><p class=cm-variable-2>text</p>.<p class=cm-property>slice</p>(<p class=cm-number>0</p>, <p class=cm-number>15</p>)<p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/18_http.html#p_V30s3OVzdK class=p_ident id=p_V30s3OVzdK></a>Browsers make <code>GET</code> requests to fetch the resources needed to display a web page. A page may also contain forms, which allow information entered by the user to be sent as a request for a new page when the form is submitted.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_QjxVhJesQe class=p_ident id=p_QjxVhJesQe></a>HTML can represent various types of form fields, such as text fields, checkboxes, multiple-choice fields, and file pickers.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_RrO1r6Pyin class=p_ident id=p_RrO1r6Pyin></a>Such fields can be inspected and manipulated with JavaScript. They fire the <code>\"change\"</code> event when changed, fire the <code>\"input\"</code> event when text is typed, and receive keyboard events when they have keyboard focus. Properties like <code>value</code> (for text and select fields) or <code>checked</code> (for checkboxes and radio buttons) are used to read or set the field’s content.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_SD8tK1CyB9 class=p_ident id=p_SD8tK1CyB9></a>When a form is submitted, a <code>\"submit\"</code> event is fired on it. A JavaScript handler can call <code>preventDefault</code> on that event to disable the browser’s default behavior. Form field elements may also occur outside of a form tag.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_4GN43j/R8o class=p_ident id=p_4GN43j/R8o></a>When the user has selected a file from their local file system in a file picker field, the <code>FileReader</code> interface can be used to access the content of this file from a JavaScript program.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_UfsY7mgHDE class=p_ident id=p_UfsY7mgHDE></a>The <code>localStorage</code> and <code>sessionStorage</code> objects can be used to save information in a way that survives page reloads. The first object saves the data forever (or until the user decides to clear it), and the second saves it until the browser is closed.</p> <h2><a href=https://eloquentjavascript.net/18_http.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/18_http.html#i_uaWwL8WGXf class=i_ident id=i_uaWwL8WGXf></a>Content negotiation</h3> <p><a href=https://eloquentjavascript.net/18_http.html#p_4RSIQjkFSG class=p_ident id=p_4RSIQjkFSG></a>One of the things HTTP can do is called <em>content negotiation</em>. The <code>Accept</code> request header is used to tell the server what type of document the client would like to get. Many servers ignore this header, but when a server knows of various ways to encode a resource, it can look at this header and send the one that the client prefers.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_cYtib3gEMB class=p_ident id=p_cYtib3gEMB></a>The URL <a href=https://eloquentjavascript.net/author><em>https://eloquentjavascript.net/author</em></a> is configured to respond with either plaintext, HTML, or JSON, depending on what the client asks for. These formats are identified by the standardized <em>media types</em> <code>text/plain</code>, <code>text/html</code>, and <code>application/json</code>.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_8+gmMBG1zE class=p_ident id=p_8+gmMBG1zE></a>Send requests to fetch all three formats of this resource. Use the <code>headers</code> property in the options object passed to <code>fetch</code> to set the header named <code>Accept</code> to the desired media type.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_DGQ35JK0dT class=p_ident id=p_DGQ35JK0dT></a>Finally, try asking for the media type <code>application/<wbr>rainbows+unicorns</code> and see which status code that produces.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_HRKSrZS1tJ class=c_ident id=c_HRKSrZS1tJ></a></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/18_http.html#p_QQMLShvZ/N class=p_ident id=p_QQMLShvZ/N></a>Base your code on the <code>fetch</code> examples <a href=https://eloquentjavascript.net/18_http.html#fetch>earlier in the chapter</a>.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_U/l3HWMtEN class=p_ident id=p_U/l3HWMtEN></a>Asking for a bogus media type will return a response with code 406, “Not acceptable”, which is the code a server should return when it can’t fulfill the <code>Accept</code> header.</p> </div></div> <h3><a href=https://eloquentjavascript.net/18_http.html#i_wTXvIH5Wds class=i_ident id=i_wTXvIH5Wds></a>A JavaScript workbench</h3> <p><a href=https://eloquentjavascript.net/18_http.html#p_b4iA8hbDyH class=p_ident id=p_b4iA8hbDyH></a>Build an interface that allows people to type and run pieces of JavaScript code.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_5ABzoaFbF8 class=p_ident id=p_5ABzoaFbF8></a>Put a button next to a <code>&lt;textarea&gt;</code> field that, when pressed, uses the <code>Function</code> constructor we saw in <a href=https://eloquentjavascript.net/10_modules.html#eval>Chapter 10</a> to wrap the text in a function and call it. Convert the return value of the function, or any error it raises, to a string and display it below the text field.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_zdElSW9Q47 class=c_ident id=c_zdElSW9Q47></a><p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"code\"</p><p class=cm-tag>&gt;</p>return \"hi\";<p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"button\"</p><p class=cm-tag>&gt;</p>Run<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>pre</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"output\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>pre</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/18_http.html#p_FntbF4i9OW class=p_ident id=p_FntbF4i9OW></a>Use <code>document.<wbr>querySelector</code> or <code>document.<wbr>getElementById</code> to get access to the elements defined in your HTML. An event handler for <code>\"click\"</code> or <code>\"mousedown\"</code> events on the button can get the <code>value</code> property of the text field and call <code>Function</code> on it.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_uLWfzgaSrI class=p_ident id=p_uLWfzgaSrI></a>Make sure you wrap both the call to <code>Function</code> and the call to its result in a <code>try</code> block so you can catch the exceptions it produces. In this case, we really don’t know what type of exception we are looking for, so catch everything.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_J8bbt63whH class=p_ident id=p_J8bbt63whH></a>The <code>textContent</code> property of the output element can be used to fill it with a string message. Or, if you want to keep the old content around, create a new text node using <code>document.<wbr>createTextNode</code> and append it to the element. Remember to add a newline character to the end so that not all output appears on a single line.</p> </div></div> <h3><a href=https://eloquentjavascript.net/18_http.html#i_XyKQVmCbTN class=i_ident id=i_XyKQVmCbTN></a>Conway’s Game of Life</h3> <p><a href=https://eloquentjavascript.net/18_http.html#p_5s3eB2ZhzK class=p_ident id=p_5s3eB2ZhzK></a>Conway’s Game of Life is a simple simulation that creates artificial “life” on a grid, each cell of which is either alive or not. Each generation (turn), the following rules are applied:</p> <ul> <li> <p><a href=https://eloquentjavascript.net/18_http.html#p_D7IMqD7kgE class=p_ident id=p_D7IMqD7kgE></a>Any live cell with fewer than two or more than three live neighbors dies.</p></li> <li> <p><a href=https://eloquentjavascript.net/18_http.html#p_ztkCIOYDVq class=p_ident id=p_ztkCIOYDVq></a>Any live cell with two or three live neighbors lives on to the next generation.</p></li> <li> <p><a href=https://eloquentjavascript.net/18_http.html#p_y/DnAd+/CJ class=p_ident id=p_y/DnAd+/CJ></a>Any dead cell with exactly three live neighbors becomes a live cell.</p></li></ul> <p><a href=https://eloquentjavascript.net/18_http.html#p_iUPnWf2p1M class=p_ident id=p_iUPnWf2p1M></a>A <em>neighbor</em> is defined as any adjacent cell, including diagonally adjacent ones.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_9dLS2RK5SZ class=p_ident id=p_9dLS2RK5SZ></a>Note that these rules are applied to the whole grid at once, not one square at a time. That means the counting of neighbors is based on the situation at the start of the generation, and changes happening to neighbor cells during this generation should not influence the new state of a given cell.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_W0m8oVpi7M class=p_ident id=p_W0m8oVpi7M></a>Implement this game using whichever data structure you find appropriate. Use <code>Math.random</code> to populate the grid with a random pattern initially. Display it as a grid of checkbox fields, with a button next to it to advance to the next generation. When the user checks or unchecks the checkboxes, their changes should be included when computing the next generation.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/18_http.html#c_xF6LIoITNO class=c_ident id=c_xF6LIoITNO></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"grid\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"next\"</p><p class=cm-tag>&gt;</p>Next generation<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/18_http.html#p_Aww6OjjuYz class=p_ident id=p_Aww6OjjuYz></a>To solve the problem of having the changes conceptually happen at the same time, try to see the computation of a generation as a pure function, which takes one grid and produces a new grid that represents the next turn.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_DBZ6s168gb class=p_ident id=p_DBZ6s168gb></a>Representing the matrix can be done in the way shown in <a href=https://eloquentjavascript.net/06_object.html#matrix>Chapter 6</a>. You can count live neighbors with two nested loops, looping over adjacent coordinates in both dimensions. Take care not to count cells outside of the field and to ignore the cell in the center, whose neighbors we are counting.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_Jyqyj//gTI class=p_ident id=p_Jyqyj//gTI></a>Ensuring that changes to checkboxes take effect on the next generation can be done in two ways. An event handler could notice these changes and update the current grid to reflect them, or you could generate a fresh grid from the values in the checkboxes before computing the next turn.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_wu3Ty9I4d4 class=p_ident id=p_wu3Ty9I4d4></a>If you choose to go with event handlers, you might want to attach attributes that identify the position that each checkbox corresponds to so that it is easy to find out which cell to change.</p> <p><a href=https://eloquentjavascript.net/18_http.html#p_XFp+gOIONt class=p_ident id=p_XFp+gOIONt></a>To draw the grid of checkboxes, you can either use a <code>&lt;table&gt;</code> element (see <a href=https://eloquentjavascript.net/14_dom.html#exercise_table>Chapter 14</a>) or simply put them all in the same element and put <code>&lt;br&gt;</code> (line break) elements between the rows.</p> </div></div><nav><a href=https://eloquentjavascript.net/17_canvas.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/19_paint.html>▶</a></nav>\n</article><hr><h4>Page 14</h4><article score=1057.1899999999998>\n<nav><a href=https://eloquentjavascript.net/18_http.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/20_node.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/19_paint.html#p_S+jzRBETBQ class=p_ident id=p_S+jzRBETBQ></a>I look at the many colors before me. I look at my blank canvas. Then, I try to apply colors like words that shape poems, like notes that shape music.</p> <footer>Joan Miro</footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a tiled mosaic\" src=https://eloquentjavascript.net/img/chapter_picture_19.jpg></figure> <p><a href=https://eloquentjavascript.net/19_paint.html#p_m3rLDhVHTL class=p_ident id=p_m3rLDhVHTL></a>The material from the previous chapters gives you all the elements you need to build a basic web application. In this chapter, we will do just that.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_1emWaHj7VO class=p_ident id=p_1emWaHj7VO></a>Our application will be a pixel drawing program, where you can modify a picture pixel by pixel by manipulating a zoomed-in view of it, shown as a grid of colored squares. You can use the program to open image files, scribble on them with your mouse or other pointer device, and save them. This is what it will look like:</p><figure><img alt=\"The pixel editor interface, with colored pixels at the top and a number of controls below that\" src=https://eloquentjavascript.net/img/pixel_editor.png></figure> <p><a href=https://eloquentjavascript.net/19_paint.html#p_oDwL9FxPW8 class=p_ident id=p_oDwL9FxPW8></a>Painting on a computer is great. You don’t need to worry about materials, skill, or talent. You just start smearing.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_kolHPu7a7g class=h_ident id=h_kolHPu7a7g></a>Components</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_FdzFEXmy5/ class=p_ident id=p_FdzFEXmy5/ ></a>The interface for the application shows a big <code>&lt;canvas&gt;</code> element on top, with a number of form fields below it. The user draws on the picture by selecting a tool from a <code>&lt;select&gt;</code> field and then clicking, touching, or dragging across the canvas. There are tools for drawing single pixels or rectangles, for filling an area, and for picking a color from the picture.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_NhRI/7J4/9 class=p_ident id=p_NhRI/7J4/9></a>We will structure the editor interface as a number of <em>components</em>, objects that are responsible for a piece of the DOM and that may contain other components inside them.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_fkKmP4oVNw class=p_ident id=p_fkKmP4oVNw></a>The state of the application consists of the current picture, the selected tool, and the selected color. We’ll set things up so that the state lives in a single value, and the interface components always base the way they look on the current state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_vdd3n7kKQ+ class=p_ident id=p_vdd3n7kKQ+></a>To see why this is important, let’s consider the alternative—distributing pieces of state throughout the interface. Up to a certain point, this is easier to program. We can just put in a color field and read its value when we need to know the current color.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_DT4dS+wk+p class=p_ident id=p_DT4dS+wk+p></a>But then we add the color picker—a tool that lets you click the picture to select the color of a given pixel. To keep the color field showing the correct color, that tool would have to know that it exists and update it whenever it picks a new color. If you ever add another place that makes the color visible (maybe the mouse cursor could show it), you have to update your color-changing code to keep that synchronized.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_V/rEZY0rXG class=p_ident id=p_V/rEZY0rXG></a>In effect, this creates a problem where each part of the interface needs to know about all other parts, which is not very modular. For small applications like the one in this chapter, that may not be a problem. For bigger projects, it can turn into a real nightmare.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_g1VVb9/ySC class=p_ident id=p_g1VVb9/ySC></a>To avoid this nightmare on principle, we’re going to be strict about <em>data flow</em>. There is a state, and the interface is drawn based on that state. An interface component may respond to user actions by updating the state, at which point the components get a chance to synchronize themselves with this new state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_snbNYCWNLn class=p_ident id=p_snbNYCWNLn></a>In practice, each component is set up so that when it is given a new state, it also notifies its child components, insofar as those need to be updated. Setting this up is a bit of a hassle. Making this more convenient is the main selling point of many browser programming libraries. But for a small application like this, we can do it without such infrastructure.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_lPz3O+BIo4 class=p_ident id=p_lPz3O+BIo4></a>Updates to the state are represented as objects, which we’ll call <em>actions</em>. Components may create such actions and <em>dispatch</em> them—give them to a central state management function. That function computes the next state, after which the interface components update themselves to this new state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_5gofo0W3xD class=p_ident id=p_5gofo0W3xD></a>We’re taking the messy task of running a user interface and applying some structure to it. Though the DOM-related pieces are still full of side effects, they are held up by a conceptually simple backbone: the state update cycle. The state determines what the DOM looks like, and the only way DOM events can change the state is by dispatching actions to the state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_/EcvUcHPZo class=p_ident id=p_/EcvUcHPZo></a>There are <em>many</em> variants of this approach, each with its own benefits and problems, but their central idea is the same: state changes should go through a single well-defined channel, not happen all over the place.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_x8WZeXxSe3 class=p_ident id=p_x8WZeXxSe3></a>Our components will be classes conforming to an interface. Their constructor is given a state—which may be the whole application state or some smaller value if it doesn’t need access to everything—and uses that to build up a <code>dom</code> property. This is the DOM element that represents the component. Most constructors will also take some other values that won’t change over time, such as the function they can use to dispatch an action.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_//+fikMSC2 class=p_ident id=p_//+fikMSC2></a>Each component has a <code>syncState</code> method that is used to synchronize it to a new state value. The method takes one argument, the state, which is of the same type as the first argument to its constructor.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_ftf/mS/U0E class=h_ident id=h_ftf/mS/U0E></a>The state</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_bfnMVWQbM8 class=p_ident id=p_bfnMVWQbM8></a>The application state will be an object with <code>picture</code>, <code>tool</code>, and <code>color</code> properties. The picture is itself an object that stores the width, height, and pixel content of the picture. The pixels are stored in an array, in the same way as the matrix class from <a href=https://eloquentjavascript.net/06_object.html>Chapter 6</a>—row by row, from top to bottom.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_FaXS4E1Q9/ class=c_ident id=c_FaXS4E1Q9/ ></a><p class=cm-keyword>class</p> <p class=cm-def>Picture</p> { <p class=cm-property>constructor</p>(<p class=cm-def>width</p>, <p class=cm-def>height</p>, <p class=cm-def>pixels</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>width</p>; <p class=cm-keyword>this</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-variable-2>height</p>; <p class=cm-keyword>this</p>.<p class=cm-property>pixels</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pixels</p>; } <p class=cm-keyword>static</p> <p class=cm-property>empty</p>(<p class=cm-def>width</p>, <p class=cm-def>height</p>, <p class=cm-def>color</p>) { <p class=cm-keyword>let</p> <p class=cm-def>pixels</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Array</p>(<p class=cm-variable-2>width</p> <p class=cm-operator>*</p> <p class=cm-variable-2>height</p>).<p class=cm-property>fill</p>(<p class=cm-variable-2>color</p>); <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Picture</p>(<p class=cm-variable-2>width</p>, <p class=cm-variable-2>height</p>, <p class=cm-variable-2>pixels</p>); } <p class=cm-property>pixel</p>(<p class=cm-def>x</p>, <p class=cm-def>y</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>pixels</p>[<p class=cm-variable-2>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-keyword>this</p>.<p class=cm-property>width</p>]; } <p class=cm-property>draw</p>(<p class=cm-def>pixels</p>) { <p class=cm-keyword>let</p> <p class=cm-def>copy</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>pixels</p>.<p class=cm-property>slice</p>(); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> {<p class=cm-def>x</p>, <p class=cm-def>y</p>, <p class=cm-def>color</p>} <p class=cm-keyword>of</p> <p class=cm-variable-2>pixels</p>) { <p class=cm-variable-2>copy</p>[<p class=cm-variable-2>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-keyword>this</p>.<p class=cm-property>width</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>color</p>; } <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Picture</p>(<p class=cm-keyword>this</p>.<p class=cm-property>width</p>, <p class=cm-keyword>this</p>.<p class=cm-property>height</p>, <p class=cm-variable-2>copy</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_gEQNun84hI class=p_ident id=p_gEQNun84hI></a>We want to be able to treat a picture as an immutable value, for reasons that we’ll get back to later in the chapter. But we also sometimes need to update a whole bunch of pixels at a time. To be able to do that, the class has a <code>draw</code> method that expects an array of updated pixels—objects with <code>x</code>, <code>y</code>, and <code>color</code> properties—and creates a new picture with those pixels overwritten. This method uses <code>slice</code> without arguments to copy the entire pixel array—the start of the slice defaults to 0, and the end defaults to the array’s length.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_WuI3QLNiPA class=p_ident id=p_WuI3QLNiPA></a>The <code>empty</code> method uses two pieces of array functionality that we haven’t seen before. The <code>Array</code> constructor can be called with a number to create an empty array of the given length. The <code>fill</code> method can then be used to fill this array with a given value. These are used to create an array in which all pixels have the same color.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_06+YtnEEH5 class=p_ident id=p_06+YtnEEH5></a>Colors are stored as strings containing traditional CSS color codes made up of a hash sign (<code>#</code>) followed by six hexadecimal (base-16) digits—two for the red component, two for the green component, and two for the blue component. This is a somewhat cryptic and inconvenient way to write colors, but it is the format the HTML color input field uses, and it can be used in the <code>fillStyle</code> property of a canvas drawing context, so for the ways we’ll use colors in this program, it is practical enough.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_EsZKxAfcSW class=p_ident id=p_EsZKxAfcSW></a>Black, where all components are zero, is written <code>\"#000000\"</code>, and bright pink looks like <code>\"#ff00ff\"</code>, where the red and blue components have the maximum value of 255, written <code>ff</code> in hexadecimal digits (which use <em>a</em> to <em>f</em> to represent digits 10 to 15).</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_gcI/Yem+Yv class=p_ident id=p_gcI/Yem+Yv></a>We’ll allow the interface to dispatch actions as objects whose properties overwrite the properties of the previous state. The color field, when the user changes it, could dispatch an object like <code>{color: field.<wbr>value}</code>, from which this update function can compute a new state.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_0xovfSx+PU class=c_ident id=c_0xovfSx+PU></a><p class=cm-keyword>function</p> <p class=cm-def>updateState</p>(<p class=cm-def>state</p>, <p class=cm-def>action</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable-2>state</p>, <p class=cm-variable-2>action</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_nJ9Pa/72hN class=p_ident id=p_nJ9Pa/72hN></a>This rather cumbersome pattern, in which <code>Object.assign</code> is used to first add the properties of <code>state</code> to an empty object and then overwrite some of those with the properties from <code>action</code>, is common in JavaScript code that uses immutable objects. A more convenient notation for this, in which the triple-dot operator is used to include all properties from another object in an object expression, is in the final stages of being standardized. With that addition, you could write <code>{.<wbr>.<wbr>.<wbr>state, .<wbr>.<wbr>.<wbr>action}</code> instead. At the time of writing, this doesn’t yet work in all browsers.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_sNxHTHiM3l class=h_ident id=h_sNxHTHiM3l></a>DOM building</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_pW7WuvagbQ class=p_ident id=p_pW7WuvagbQ></a>One of the main things that interface components do is creating DOM structure. We again don’t want to directly use the verbose DOM methods for that, so here’s a slightly expanded version of the <code>elt</code> function:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_bpc/osm9kD class=c_ident id=c_bpc/osm9kD></a><p class=cm-keyword>function</p> <p class=cm-def>elt</p>(<p class=cm-def>type</p>, <p class=cm-def>props</p>, <p class=cm-def>children</p>) { <p class=cm-keyword>let</p> <p class=cm-def>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-variable-2>type</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>props</p>) <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>(<p class=cm-variable-2>dom</p>, <p class=cm-variable-2>props</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>child</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>children</p>) { <p class=cm-keyword>if</p> (<p class=cm-keyword>typeof</p> <p class=cm-variable-2>child</p> <p class=cm-operator>!=</p> <p class=cm-string>\"string\"</p>) <p class=cm-variable-2>dom</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>child</p>); <p class=cm-keyword>else</p> <p class=cm-variable-2>dom</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>(<p class=cm-variable-2>child</p>)); } <p class=cm-keyword>return</p> <p class=cm-variable-2>dom</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_BpQHRZu5+n class=p_ident id=p_BpQHRZu5+n></a>The main difference between this version and the one we used in <a href=https://eloquentjavascript.net/16_game.html#domdisplay>Chapter 16</a> is that it assigns <em>properties</em> to DOM nodes, not <em>attributes</em>. This means we can’t use it to set arbitrary attributes, but we <em>can</em> use it to set properties whose value isn’t a string, such as <code>onclick</code>, which can be set to a function to register a click event handler.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ZshAZr+fAT class=p_ident id=p_ZshAZr+fAT></a>This allows the following style of registering event handlers:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_UrXW9qBNM+ class=c_ident id=c_UrXW9qBNM+></a><p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>elt</p>(<p class=cm-string>\"button\"</p>, { <p class=cm-property>onclick</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"click\"</p>) }, <p class=cm-string>\"The button\"</p>)); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_amGIg81orI class=h_ident id=h_amGIg81orI></a>The canvas</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_BmCCXvkmPk class=p_ident id=p_BmCCXvkmPk></a>The first component we’ll define is the part of the interface that displays the picture as a grid of colored boxes. This component is responsible for two things: showing a picture and communicating pointer events on that picture to the rest of the application.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_A/ZPezFryZ class=p_ident id=p_A/ZPezFryZ></a>As such, we can define it as a component that knows about only the current picture, not the whole application state. Because it doesn’t know how the application as a whole works, it cannot directly dispatch actions. Rather, when responding to pointer events, it calls a callback function provided by the code that created it, which will handle the application-specific parts.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_uknkIx/3Hs class=c_ident id=c_uknkIx/3Hs></a><p class=cm-keyword>const</p> <p class=cm-def>scale</p> <p class=cm-operator>=</p> <p class=cm-number>10</p>; <p class=cm-keyword>class</p> <p class=cm-def>PictureCanvas</p> { <p class=cm-property>constructor</p>(<p class=cm-def>picture</p>, <p class=cm-def>pointerDown</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"canvas\"</p>, { <p class=cm-property>onmousedown</p>: <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> <p class=cm-keyword>this</p>.<p class=cm-property>mouse</p>(<p class=cm-variable-2>event</p>, <p class=cm-variable-2>pointerDown</p>), <p class=cm-property>ontouchstart</p>: <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> <p class=cm-keyword>this</p>.<p class=cm-property>touch</p>(<p class=cm-variable-2>event</p>, <p class=cm-variable-2>pointerDown</p>) }); <p class=cm-keyword>this</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>picture</p>); } <p class=cm-property>syncState</p>(<p class=cm-def>picture</p>) { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>==</p> <p class=cm-variable-2>picture</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>; <p class=cm-variable>drawPicture</p>(<p class=cm-keyword>this</p>.<p class=cm-property>picture</p>, <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>, <p class=cm-variable>scale</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_GUKkdM8Vr3 class=p_ident id=p_GUKkdM8Vr3></a>We draw each pixel as a 10-by-10 square, as determined by the <code>scale</code> constant. To avoid unnecessary work, the component keeps track of its current picture and does a redraw only when <code>syncState</code> is given a new picture.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_+vW5Ci/vvJ class=p_ident id=p_+vW5Ci/vvJ></a>The actual drawing function sets the size of the canvas based on the scale and picture size and fills it with a series of squares, one for each pixel.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_kMF9hx2xSw class=c_ident id=c_kMF9hx2xSw></a><p class=cm-keyword>function</p> <p class=cm-def>drawPicture</p>(<p class=cm-def>picture</p>, <p class=cm-def>canvas</p>, <p class=cm-def>scale</p>) { <p class=cm-variable-2>canvas</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>width</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>; <p class=cm-variable-2>canvas</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>height</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>; <p class=cm-keyword>let</p> <p class=cm-def>cx</p> <p class=cm-operator>=</p> <p class=cm-variable-2>canvas</p>.<p class=cm-property>getContext</p>(<p class=cm-string>\"2d\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>height</p>; <p class=cm-variable-2>y</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>width</p>; <p class=cm-variable-2>x</p><p class=cm-operator>++</p>) { <p class=cm-variable-2>cx</p>.<p class=cm-property>fillStyle</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>pixel</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>); <p class=cm-variable-2>cx</p>.<p class=cm-property>fillRect</p>(<p class=cm-variable-2>x</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>scale</p>);\n    }\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_wPTPY1JmU4 class=p_ident id=p_wPTPY1JmU4></a>When the left mouse button is pressed while the mouse is over the picture canvas, the component calls the <code>pointerDown</code> callback, giving it the position of the pixel that was clicked—in picture coordinates. This will be used to implement mouse interaction with the picture. The callback may return another callback function to be notified when the pointer is moved to a different pixel while the button is held down.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_G1LWj2jAqP class=c_ident id=c_G1LWj2jAqP></a><p class=cm-variable>PictureCanvas</p>.<p class=cm-property>prototype</p>.<p class=cm-property>mouse</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>downEvent</p>, <p class=cm-def>onDown</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>downEvent</p>.<p class=cm-property>button</p> <p class=cm-operator>!=</p> <p class=cm-number>0</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>let</p> <p class=cm-def>pos</p> <p class=cm-operator>=</p> <p class=cm-variable>pointerPosition</p>(<p class=cm-variable-2>downEvent</p>, <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>); <p class=cm-keyword>let</p> <p class=cm-def>onMove</p> <p class=cm-operator>=</p> <p class=cm-variable-2>onDown</p>(<p class=cm-variable-2>pos</p>); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>onMove</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>let</p> <p class=cm-def>move</p> <p class=cm-operator>=</p> <p class=cm-def>moveEvent</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>moveEvent</p>.<p class=cm-property>buttons</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>removeEventListener</p>(<p class=cm-string>\"mousemove\"</p>, <p class=cm-variable-2>move</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>newPos</p> <p class=cm-operator>=</p> <p class=cm-variable>pointerPosition</p>(<p class=cm-variable-2>moveEvent</p>, <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>newPos</p>.<p class=cm-property>x</p> <p class=cm-operator>==</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>newPos</p>.<p class=cm-property>y</p> <p class=cm-operator>==</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>) <p class=cm-keyword>return</p>; <p class=cm-variable-2>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newPos</p>; <p class=cm-variable-2>onMove</p>(<p class=cm-variable-2>newPos</p>); } }; <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousemove\"</p>, <p class=cm-variable-2>move</p>);\n}; <p class=cm-keyword>function</p> <p class=cm-def>pointerPosition</p>(<p class=cm-def>pos</p>, <p class=cm-def>domNode</p>) { <p class=cm-keyword>let</p> <p class=cm-def>rect</p> <p class=cm-operator>=</p> <p class=cm-variable-2>domNode</p>.<p class=cm-property>getBoundingClientRect</p>(); <p class=cm-keyword>return</p> {<p class=cm-property>x</p>: <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>((<p class=cm-variable-2>pos</p>.<p class=cm-property>clientX</p> <p class=cm-operator>-</p> <p class=cm-variable-2>rect</p>.<p class=cm-property>left</p>) <p class=cm-operator>/</p> <p class=cm-variable>scale</p>), <p class=cm-property>y</p>: <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>((<p class=cm-variable-2>pos</p>.<p class=cm-property>clientY</p> <p class=cm-operator>-</p> <p class=cm-variable-2>rect</p>.<p class=cm-property>top</p>) <p class=cm-operator>/</p> <p class=cm-variable>scale</p>)};\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_B/cdI1TfFV class=p_ident id=p_B/cdI1TfFV></a>Since we know the size of the pixels and we can use <code>getBoundingClientRect</code> to find the position of the canvas on the screen, it is possible to go from mouse event coordinates (<code>clientX</code> and <code>clientY</code>) to picture coordinates. These are always rounded down so that they refer to a specific pixel.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_iTkf+HH3B/ class=p_ident id=p_iTkf+HH3B/ ></a>With touch events, we have to do something similar, but using different events and making sure we call <code>preventDefault</code> on the <code>\"touchstart\"</code> event to prevent panning.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_HUiWca6Gb7 class=c_ident id=c_HUiWca6Gb7></a><p class=cm-variable>PictureCanvas</p>.<p class=cm-property>prototype</p>.<p class=cm-property>touch</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>startEvent</p>, <p class=cm-def>onDown</p>) { <p class=cm-keyword>let</p> <p class=cm-def>pos</p> <p class=cm-operator>=</p> <p class=cm-variable>pointerPosition</p>(<p class=cm-variable-2>startEvent</p>.<p class=cm-property>touches</p>[<p class=cm-number>0</p>], <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>); <p class=cm-keyword>let</p> <p class=cm-def>onMove</p> <p class=cm-operator>=</p> <p class=cm-variable-2>onDown</p>(<p class=cm-variable-2>pos</p>); <p class=cm-variable-2>startEvent</p>.<p class=cm-property>preventDefault</p>(); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>onMove</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>let</p> <p class=cm-def>move</p> <p class=cm-operator>=</p> <p class=cm-def>moveEvent</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>newPos</p> <p class=cm-operator>=</p> <p class=cm-variable>pointerPosition</p>(<p class=cm-variable-2>moveEvent</p>.<p class=cm-property>touches</p>[<p class=cm-number>0</p>], <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>newPos</p>.<p class=cm-property>x</p> <p class=cm-operator>==</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>newPos</p>.<p class=cm-property>y</p> <p class=cm-operator>==</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>) <p class=cm-keyword>return</p>; <p class=cm-variable-2>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newPos</p>; <p class=cm-variable-2>onMove</p>(<p class=cm-variable-2>newPos</p>); }; <p class=cm-keyword>let</p> <p class=cm-def>end</p> <p class=cm-operator>=</p> () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>removeEventListener</p>(<p class=cm-string>\"touchmove\"</p>, <p class=cm-variable-2>move</p>); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>removeEventListener</p>(<p class=cm-string>\"touchend\"</p>, <p class=cm-variable-2>end</p>); }; <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"touchmove\"</p>, <p class=cm-variable-2>move</p>); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"touchend\"</p>, <p class=cm-variable-2>end</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_oah1AjpovX class=p_ident id=p_oah1AjpovX></a>For touch events, <code>clientX</code> and <code>clientY</code> aren’t available directly on the event object, but we can use the coordinates of the first touch object in the <code>touches</code> property.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_bxOeMBlEZu class=h_ident id=h_bxOeMBlEZu></a>The application</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_oKqyuCaaPg class=p_ident id=p_oKqyuCaaPg></a>To make it possible to build the application piece by piece, we’ll implement the main component as a shell around a picture canvas and a dynamic set of tools and controls that we pass to its constructor.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_2fnd7WZs8N class=p_ident id=p_2fnd7WZs8N></a>The <em>controls</em> are the interface elements that appear below the picture. They’ll be provided as an array of component constructors.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_67YdeRoZl7 class=p_ident id=p_67YdeRoZl7></a>The <em>tools</em> do things like drawing pixels or filling in an area. The application shows the set of available tools as a <code>&lt;select&gt;</code> field. The currently selected tool determines what happens when the user interacts with the picture with a pointer device. The set of available tools is provided as an object that maps the names that appear in the drop-down field to functions that implement the tools. Such functions get a picture position, a current application state, and a <code>dispatch</code> function as arguments. They may return a move handler function that gets called with a new position and a current state when the pointer moves to a different pixel.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_bksTXX2fO6 class=c_ident id=c_bksTXX2fO6></a><p class=cm-keyword>class</p> <p class=cm-def>PixelEditor</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>, <p class=cm-def>config</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>tools</p>, <p class=cm-def>controls</p>, <p class=cm-def>dispatch</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>config</p>; <p class=cm-keyword>this</p>.<p class=cm-property>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>; <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>PictureCanvas</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>, <p class=cm-def>pos</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>tool</p> <p class=cm-operator>=</p> <p class=cm-variable-2>tools</p>[<p class=cm-keyword>this</p>.<p class=cm-property>state</p>.<p class=cm-property>tool</p>]; <p class=cm-keyword>let</p> <p class=cm-def>onMove</p> <p class=cm-operator>=</p> <p class=cm-variable-2>tool</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>state</p>, <p class=cm-variable-2>dispatch</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>onMove</p>) <p class=cm-keyword>return</p> <p class=cm-def>pos</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>onMove</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>state</p>); }); <p class=cm-keyword>this</p>.<p class=cm-property>controls</p> <p class=cm-operator>=</p> <p class=cm-variable-2>controls</p>.<p class=cm-property>map</p>( <p class=cm-def>Control</p> <p class=cm-operator>=&gt;</p> <p class=cm-keyword>new</p> <p class=cm-variable-2>Control</p>(<p class=cm-variable-2>state</p>, <p class=cm-variable-2>config</p>)); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"div\"</p>, {}, <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p>.<p class=cm-property>dom</p>, <p class=cm-variable>elt</p>(<p class=cm-string>\"br\"</p>), <p class=cm-keyword>this</p>.<p class=cm-property>controls</p>.<p class=cm-property>reduce</p>( (<p class=cm-def>a</p>, <p class=cm-def>c</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p>.<p class=cm-property>concat</p>(<p class=cm-string>\" \"</p>, <p class=cm-variable-2>c</p>.<p class=cm-property>dom</p>), [])); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>; <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>ctrl</p> <p class=cm-keyword>of</p> <p class=cm-keyword>this</p>.<p class=cm-property>controls</p>) <p class=cm-variable-2>ctrl</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_5ni0DeofjL class=p_ident id=p_5ni0DeofjL></a>The pointer handler given to <code>PictureCanvas</code> calls the currently selected tool with the appropriate arguments and, if that returns a move handler, adapts it to also receive the state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_gOumsrO7+U class=p_ident id=p_gOumsrO7+U></a>All controls are constructed and stored in <code>this.controls</code> so that they can be updated when the application state changes. The call to <code>reduce</code> introduces spaces between the controls’ DOM elements. That way they don’t look so pressed together.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_KM7knGXuoO class=p_ident id=p_KM7knGXuoO></a>The first control is the tool selection menu. It creates a <code>&lt;select&gt;</code> element with an option for each tool and sets up a <code>\"change\"</code> event handler that updates the application state when the user selects a different tool.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_ErM/S5/GMa class=c_ident id=c_ErM/S5/GMa></a><p class=cm-keyword>class</p> <p class=cm-def>ToolSelect</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>, {<p class=cm-def>tools</p>, <p class=cm-def>dispatch</p>}) { <p class=cm-keyword>this</p>.<p class=cm-property>select</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"select\"</p>, { <p class=cm-property>onchange</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>dispatch</p>({<p class=cm-property>tool</p>: <p class=cm-keyword>this</p>.<p class=cm-property>select</p>.<p class=cm-property>value</p>}) }, <p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable-2>tools</p>).<p class=cm-property>map</p>(<p class=cm-def>name</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"option\"</p>, { <p class=cm-property>selected</p>: <p class=cm-variable-2>name</p> <p class=cm-operator>==</p> <p class=cm-variable-2>state</p>.<p class=cm-property>tool</p> }, <p class=cm-variable-2>name</p>))); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"label\"</p>, <p class=cm-atom>null</p>, <p class=cm-string>\"🖌 Tool: \"</p>, <p class=cm-keyword>this</p>.<p class=cm-property>select</p>); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>select</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>tool</p>; }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_7EVkxldvIa class=p_ident id=p_7EVkxldvIa></a>By wrapping the label text and the field in a <code>&lt;label&gt;</code> element, we tell the browser that the label belongs to that field so that you can, for example, click the label to focus the field.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_avuZ1LKe/u class=p_ident id=p_avuZ1LKe/u></a>We also need to be able to change the color, so let’s add a control for that. An HTML <code>&lt;input&gt;</code> element with a <code>type</code> attribute of <code>color</code> gives us a form field that is specialized for selecting colors. Such a field’s value is always a CSS color code in <code>\"#RRGGBB\"</code> format (red, green, and blue components, two digits per color). The browser will show a color picker interface when the user interacts with it.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_mUiMIeOUud class=p_ident id=p_mUiMIeOUud></a>This control creates such a field and wires it up to stay synchronized with the application state’s <code>color</code> property.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_CNKBIFujc0 class=c_ident id=c_CNKBIFujc0></a><p class=cm-keyword>class</p> <p class=cm-def>ColorSelect</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>, {<p class=cm-def>dispatch</p>}) { <p class=cm-keyword>this</p>.<p class=cm-property>input</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"input\"</p>, { <p class=cm-property>type</p>: <p class=cm-string>\"color\"</p>, <p class=cm-property>value</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>, <p class=cm-property>onchange</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>dispatch</p>({<p class=cm-property>color</p>: <p class=cm-keyword>this</p>.<p class=cm-property>input</p>.<p class=cm-property>value</p>}) }); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"label\"</p>, <p class=cm-atom>null</p>, <p class=cm-string>\"🎨 Color: \"</p>, <p class=cm-keyword>this</p>.<p class=cm-property>input</p>); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>input</p>.<p class=cm-property>value</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>; }\n}</pre> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_dRTuNLyniP class=h_ident id=h_dRTuNLyniP></a>Drawing tools</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_zMXAaVz6Dy class=p_ident id=p_zMXAaVz6Dy></a>Before we can draw anything, we need to implement the tools that will control the functionality of mouse or touch events on the canvas.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_km565kqis+ class=p_ident id=p_km565kqis+></a>The most basic tool is the draw tool, which changes any pixel you click or tap to the currently selected color. It dispatches an action that updates the picture to a version in which the pointed-at pixel is given the currently selected color.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_CZoPfAkoSo class=c_ident id=c_CZoPfAkoSo></a><p class=cm-keyword>function</p> <p class=cm-def>draw</p>(<p class=cm-def>pos</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { <p class=cm-keyword>function</p> <p class=cm-def>drawPixel</p>({<p class=cm-def>x</p>, <p class=cm-def>y</p>}, <p class=cm-def>state</p>) { <p class=cm-keyword>let</p> <p class=cm-def>drawn</p> <p class=cm-operator>=</p> {<p class=cm-property>x</p>, <p class=cm-property>y</p>, <p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>}; <p class=cm-variable-2>dispatch</p>({<p class=cm-property>picture</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>draw</p>([<p class=cm-variable-2>drawn</p>])}); } <p class=cm-variable-2>drawPixel</p>(<p class=cm-variable-2>pos</p>, <p class=cm-variable-2>state</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>drawPixel</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_NV0WFpOefQ class=p_ident id=p_NV0WFpOefQ></a>The function immediately calls the <code>drawPixel</code> function but then also returns it so that it is called again for newly touched pixels when the user drags or swipes over the picture.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_zzmdcb6+s1 class=p_ident id=p_zzmdcb6+s1></a>To draw larger shapes, it can be useful to quickly create rectangles. The <code>rectangle</code> tool draws a rectangle between the point where you start dragging and the point that you drag to.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_cHtZqBzkqi class=c_ident id=c_cHtZqBzkqi></a><p class=cm-keyword>function</p> <p class=cm-def>rectangle</p>(<p class=cm-def>start</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { <p class=cm-keyword>function</p> <p class=cm-def>drawRectangle</p>(<p class=cm-def>pos</p>) { <p class=cm-keyword>let</p> <p class=cm-def>xStart</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>min</p>(<p class=cm-variable-2>start</p>.<p class=cm-property>x</p>, <p class=cm-variable-2>pos</p>.<p class=cm-property>x</p>); <p class=cm-keyword>let</p> <p class=cm-def>yStart</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>min</p>(<p class=cm-variable-2>start</p>.<p class=cm-property>y</p>, <p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>); <p class=cm-keyword>let</p> <p class=cm-def>xEnd</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>max</p>(<p class=cm-variable-2>start</p>.<p class=cm-property>x</p>, <p class=cm-variable-2>pos</p>.<p class=cm-property>x</p>); <p class=cm-keyword>let</p> <p class=cm-def>yEnd</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>max</p>(<p class=cm-variable-2>start</p>.<p class=cm-property>y</p>, <p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>); <p class=cm-keyword>let</p> <p class=cm-def>drawn</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-variable-2>yStart</p>; <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;=</p> <p class=cm-variable-2>yEnd</p>; <p class=cm-variable-2>y</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-variable-2>xStart</p>; <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;=</p> <p class=cm-variable-2>xEnd</p>; <p class=cm-variable-2>x</p><p class=cm-operator>++</p>) { <p class=cm-variable-2>drawn</p>.<p class=cm-property>push</p>({<p class=cm-property>x</p>, <p class=cm-property>y</p>, <p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>}); } } <p class=cm-variable-2>dispatch</p>({<p class=cm-property>picture</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>draw</p>(<p class=cm-variable-2>drawn</p>)}); } <p class=cm-variable-2>drawRectangle</p>(<p class=cm-variable-2>start</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>drawRectangle</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Fdi8lpCnu5 class=p_ident id=p_Fdi8lpCnu5></a>An important detail in this implementation is that when dragging, the rectangle is redrawn on the picture from the <em>original</em> state. That way, you can make the rectangle larger and smaller again while creating it, without the intermediate rectangles sticking around in the final picture. This is one of the reasons why immutable picture objects are useful—we’ll see another reason later.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_IN3YD5TiR4 class=p_ident id=p_IN3YD5TiR4></a>Implementing flood fill is somewhat more involved. This is a tool that fills the pixel under the pointer and all adjacent pixels that have the same color. “Adjacent” means directly horizontally or vertically adjacent, not diagonally. This picture illustrates the set of pixels colored when the flood fill tool is used at the marked pixel:</p><figure><img alt=\"A pixel grid showing the area filled by a flood fill operation\" src=https://eloquentjavascript.net/img/flood-grid.svg></figure> <p><a href=https://eloquentjavascript.net/19_paint.html#p_g4IQdiCX9d class=p_ident id=p_g4IQdiCX9d></a>Interestingly, the way we’ll do this looks a bit like the pathfinding code from <a href=https://eloquentjavascript.net/07_robot.html>Chapter 7</a>. Whereas that code searched through a graph to find a route, this code searches through a grid to find all “connected” pixels. The problem of keeping track of a branching set of possible routes is similar.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_mkCcD637J8 class=c_ident id=c_mkCcD637J8></a><p class=cm-keyword>const</p> <p class=cm-def>around</p> <p class=cm-operator>=</p> [{<p class=cm-property>dx</p>: <p class=cm-operator>-</p><p class=cm-number>1</p>, <p class=cm-property>dy</p>: <p class=cm-number>0</p>}, {<p class=cm-property>dx</p>: <p class=cm-number>1</p>, <p class=cm-property>dy</p>: <p class=cm-number>0</p>}, {<p class=cm-property>dx</p>: <p class=cm-number>0</p>, <p class=cm-property>dy</p>: <p class=cm-operator>-</p><p class=cm-number>1</p>}, {<p class=cm-property>dx</p>: <p class=cm-number>0</p>, <p class=cm-property>dy</p>: <p class=cm-number>1</p>}]; <p class=cm-keyword>function</p> <p class=cm-def>fill</p>({<p class=cm-def>x</p>, <p class=cm-def>y</p>}, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { <p class=cm-keyword>let</p> <p class=cm-def>targetColor</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>pixel</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>); <p class=cm-keyword>let</p> <p class=cm-def>drawn</p> <p class=cm-operator>=</p> [{<p class=cm-property>x</p>, <p class=cm-property>y</p>, <p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>}]; <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>done</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>done</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>drawn</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>done</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> {<p class=cm-def>dx</p>, <p class=cm-def>dy</p>} <p class=cm-keyword>of</p> <p class=cm-variable>around</p>) { <p class=cm-keyword>let</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-variable-2>drawn</p>[<p class=cm-variable-2>done</p>].<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>dx</p>, <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-variable-2>drawn</p>[<p class=cm-variable-2>done</p>].<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>dy</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>x</p> <p class=cm-operator>&gt;=</p> <p class=cm-number>0</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>width</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>y</p> <p class=cm-operator>&gt;=</p> <p class=cm-number>0</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>height</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>pixel</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>) <p class=cm-operator>==</p> <p class=cm-variable-2>targetColor</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-operator>!</p><p class=cm-variable-2>drawn</p>.<p class=cm-property>some</p>(<p class=cm-def>p</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>p</p>.<p class=cm-property>x</p> <p class=cm-operator>==</p> <p class=cm-variable-2>x</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>p</p>.<p class=cm-property>y</p> <p class=cm-operator>==</p> <p class=cm-variable-2>y</p>)) { <p class=cm-variable-2>drawn</p>.<p class=cm-property>push</p>({<p class=cm-property>x</p>, <p class=cm-property>y</p>, <p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>}); } } } <p class=cm-variable-2>dispatch</p>({<p class=cm-property>picture</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>draw</p>(<p class=cm-variable-2>drawn</p>)});\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_h2+e0trcAB class=p_ident id=p_h2+e0trcAB></a>The array of drawn pixels doubles as the function’s work list. For each pixel reached, we have to see whether any adjacent pixels have the same color and haven’t already been painted over. The loop counter lags behind the length of the <code>drawn</code> array as new pixels are added. Any pixels ahead of it still need to be explored. When it catches up with the length, no unexplored pixels remain, and the function is done.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ExOoxU8nGm class=p_ident id=p_ExOoxU8nGm></a>The final tool is a color picker, which allows you to point at a color in the picture to use it as the current drawing color.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_JK2K2M0XJH class=c_ident id=c_JK2K2M0XJH></a><p class=cm-keyword>function</p> <p class=cm-def>pick</p>(<p class=cm-def>pos</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { <p class=cm-variable-2>dispatch</p>({<p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>pixel</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>x</p>, <p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>)});\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_JOsrRsRZs3 class=p_ident id=p_JOsrRsRZs3></a>We can now test our application!</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_OAsV4NrCrn class=c_ident id=c_OAsV4NrCrn></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>state</p> <p class=cm-operator>=</p> { <p class=cm-property>tool</p>: <p class=cm-string>\"draw\"</p>, <p class=cm-property>color</p>: <p class=cm-string>\"#000000\"</p>, <p class=cm-property>picture</p>: <p class=cm-variable>Picture</p>.<p class=cm-property>empty</p>(<p class=cm-number>60</p>, <p class=cm-number>30</p>, <p class=cm-string>\"#f0f0f0\"</p>) }; <p class=cm-keyword>let</p> <p class=cm-def>app</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>PixelEditor</p>(<p class=cm-variable>state</p>, { <p class=cm-property>tools</p>: {<p class=cm-property>draw</p>, <p class=cm-property>fill</p>, <p class=cm-property>rectangle</p>, <p class=cm-property>pick</p>}, <p class=cm-property>controls</p>: [<p class=cm-variable>ToolSelect</p>, <p class=cm-variable>ColorSelect</p>], <p class=cm-property>dispatch</p>(<p class=cm-def>action</p>) { <p class=cm-variable>state</p> <p class=cm-operator>=</p> <p class=cm-variable>updateState</p>(<p class=cm-variable>state</p>, <p class=cm-variable-2>action</p>); <p class=cm-variable>app</p>.<p class=cm-property>syncState</p>(<p class=cm-variable>state</p>); } }); <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>).<p class=cm-property>appendChild</p>(<p class=cm-variable>app</p>.<p class=cm-property>dom</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_7eec4RKHJi class=h_ident id=h_7eec4RKHJi></a>Saving and loading</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_apCzJ1aUDN class=p_ident id=p_apCzJ1aUDN></a>When we’ve drawn our masterpiece, we’ll want to save it for later. We should add a button for downloading the current picture as an image file. This control provides that button:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_4+FAPgY7mH class=c_ident id=c_4+FAPgY7mH></a><p class=cm-keyword>class</p> <p class=cm-def>SaveButton</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>; <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"button\"</p>, { <p class=cm-property>onclick</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-keyword>this</p>.<p class=cm-property>save</p>() }, <p class=cm-string>\"💾 Save\"</p>); } <p class=cm-property>save</p>() { <p class=cm-keyword>let</p> <p class=cm-def>canvas</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"canvas\"</p>); <p class=cm-variable>drawPicture</p>(<p class=cm-keyword>this</p>.<p class=cm-property>picture</p>, <p class=cm-variable-2>canvas</p>, <p class=cm-number>1</p>); <p class=cm-keyword>let</p> <p class=cm-def>link</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"a\"</p>, { <p class=cm-property>href</p>: <p class=cm-variable-2>canvas</p>.<p class=cm-property>toDataURL</p>(), <p class=cm-property>download</p>: <p class=cm-string>\"pixelart.png\"</p> }); <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>link</p>); <p class=cm-variable-2>link</p>.<p class=cm-property>click</p>(); <p class=cm-variable-2>link</p>.<p class=cm-property>remove</p>(); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>; }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_pdnEnbG3o4 class=p_ident id=p_pdnEnbG3o4></a>The component keeps track of the current picture so that it can access it when saving. To create the image file, it uses a <code>&lt;canvas&gt;</code> element that it draws the picture on (at a scale of one pixel per pixel).</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_diweiWpe1X class=p_ident id=p_diweiWpe1X></a>The <code>toDataURL</code> method on a canvas element creates a URL that starts with <code>data:</code>. Unlike <code>http:</code> and <code>https:</code> URLs, data URLs contain the whole resource in the URL. They are usually very long, but they allow us to create working links to arbitrary pictures, right here in the browser.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_k7Z8mWz3Zb class=p_ident id=p_k7Z8mWz3Zb></a>To actually get the browser to download the picture, we then create a link element that points at this URL and has a <code>download</code> attribute. Such links, when clicked, make the browser show a file save dialog. We add that link to the document, simulate a click on it, and remove it again.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_hjRrUluZwC class=p_ident id=p_hjRrUluZwC></a>You can do a lot with browser technology, but sometimes the way to do it is rather odd.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_U1MnOnU4AK class=p_ident id=p_U1MnOnU4AK></a>And it gets worse. We’ll also want to be able to load existing image files into our application. To do that, we again define a button component.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_6tKjwwpwls class=c_ident id=c_6tKjwwpwls></a><p class=cm-keyword>class</p> <p class=cm-def>LoadButton</p> { <p class=cm-property>constructor</p>(<p class=cm-def>_</p>, {<p class=cm-def>dispatch</p>}) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"button\"</p>, { <p class=cm-property>onclick</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable>startLoad</p>(<p class=cm-variable-2>dispatch</p>) }, <p class=cm-string>\"📁 Load\"</p>); } <p class=cm-property>syncState</p>() {}\n} <p class=cm-keyword>function</p> <p class=cm-def>startLoad</p>(<p class=cm-def>dispatch</p>) { <p class=cm-keyword>let</p> <p class=cm-def>input</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"input\"</p>, { <p class=cm-property>type</p>: <p class=cm-string>\"file\"</p>, <p class=cm-property>onchange</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable>finishLoad</p>(<p class=cm-variable-2>input</p>.<p class=cm-property>files</p>[<p class=cm-number>0</p>], <p class=cm-variable-2>dispatch</p>) }); <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>input</p>); <p class=cm-variable-2>input</p>.<p class=cm-property>click</p>(); <p class=cm-variable-2>input</p>.<p class=cm-property>remove</p>();\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_iIAN+CV0z5 class=p_ident id=p_iIAN+CV0z5></a>To get access to a file on the user’s computer, we need the user to select the file through a file input field. But I don’t want the load button to look like a file input field, so we create the file input when the button is clicked and then pretend that this file input itself was clicked.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_YHZXdzuhWI class=p_ident id=p_YHZXdzuhWI></a>When the user has selected a file, we can use <code>FileReader</code> to get access to its contents, again as a data URL. That URL can be used to create an <code>&lt;img&gt;</code> element, but because we can’t get direct access to the pixels in such an image, we can’t create a <code>Picture</code> object from that.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_bRy4XNFu3R class=c_ident id=c_bRy4XNFu3R></a><p class=cm-keyword>function</p> <p class=cm-def>finishLoad</p>(<p class=cm-def>file</p>, <p class=cm-def>dispatch</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>file</p> <p class=cm-operator>==</p> <p class=cm-atom>null</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>let</p> <p class=cm-def>reader</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>FileReader</p>(); <p class=cm-variable-2>reader</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"load\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>image</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"img\"</p>, { <p class=cm-property>onload</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>dispatch</p>({ <p class=cm-property>picture</p>: <p class=cm-variable>pictureFromImage</p>(<p class=cm-variable-2>image</p>) }), <p class=cm-property>src</p>: <p class=cm-variable-2>reader</p>.<p class=cm-property>result</p> }); }); <p class=cm-variable-2>reader</p>.<p class=cm-property>readAsDataURL</p>(<p class=cm-variable-2>file</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_GCbWh2o/H9 class=p_ident id=p_GCbWh2o/H9></a>To get access to the pixels, we must first draw the picture to a <code>&lt;canvas&gt;</code> element. The canvas context has a <code>getImageData</code> method that allows a script to read its pixels. So, once the picture is on the canvas, we can access it and construct a <code>Picture</code> object.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_bHE23Qbgos class=c_ident id=c_bHE23Qbgos></a><p class=cm-keyword>function</p> <p class=cm-def>pictureFromImage</p>(<p class=cm-def>image</p>) { <p class=cm-keyword>let</p> <p class=cm-def>width</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>min</p>(<p class=cm-number>100</p>, <p class=cm-variable-2>image</p>.<p class=cm-property>width</p>); <p class=cm-keyword>let</p> <p class=cm-def>height</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>min</p>(<p class=cm-number>100</p>, <p class=cm-variable-2>image</p>.<p class=cm-property>height</p>); <p class=cm-keyword>let</p> <p class=cm-def>canvas</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"canvas\"</p>, {<p class=cm-property>width</p>, <p class=cm-property>height</p>}); <p class=cm-keyword>let</p> <p class=cm-def>cx</p> <p class=cm-operator>=</p> <p class=cm-variable-2>canvas</p>.<p class=cm-property>getContext</p>(<p class=cm-string>\"2d\"</p>); <p class=cm-variable-2>cx</p>.<p class=cm-property>drawImage</p>(<p class=cm-variable-2>image</p>, <p class=cm-number>0</p>, <p class=cm-number>0</p>); <p class=cm-keyword>let</p> <p class=cm-def>pixels</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>let</p> {<p class=cm-def>data</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>cx</p>.<p class=cm-property>getImageData</p>(<p class=cm-number>0</p>, <p class=cm-number>0</p>, <p class=cm-variable-2>width</p>, <p class=cm-variable-2>height</p>); <p class=cm-keyword>function</p> <p class=cm-def>hex</p>(<p class=cm-def>n</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>n</p>.<p class=cm-property>toString</p>(<p class=cm-number>16</p>).<p class=cm-property>padStart</p>(<p class=cm-number>2</p>, <p class=cm-string>\"0\"</p>); } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>data</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>+=</p> <p class=cm-number>4</p>) { <p class=cm-keyword>let</p> [<p class=cm-def>r</p>, <p class=cm-def>g</p>, <p class=cm-def>b</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>data</p>.<p class=cm-property>slice</p>(<p class=cm-variable-2>i</p>, <p class=cm-variable-2>i</p> <p class=cm-operator>+</p> <p class=cm-number>3</p>); <p class=cm-variable-2>pixels</p>.<p class=cm-property>push</p>(<p class=cm-string>\"#\"</p> <p class=cm-operator>+</p> <p class=cm-variable-2>hex</p>(<p class=cm-variable-2>r</p>) <p class=cm-operator>+</p> <p class=cm-variable-2>hex</p>(<p class=cm-variable-2>g</p>) <p class=cm-operator>+</p> <p class=cm-variable-2>hex</p>(<p class=cm-variable-2>b</p>)); } <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Picture</p>(<p class=cm-variable-2>width</p>, <p class=cm-variable-2>height</p>, <p class=cm-variable-2>pixels</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_AYkCLiGt6h class=p_ident id=p_AYkCLiGt6h></a>We’ll limit the size of images to 100 by 100 pixels since anything bigger will look <em>huge</em> on our display and might slow down the interface.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_9BhQWl518s class=p_ident id=p_9BhQWl518s></a>The <code>data</code> property of the object returned by <code>getImageData</code> is an array of color components. For each pixel in the rectangle specified by the arguments, it contains four values, which represent the red, green, blue, and <em>alpha</em> components of the pixel’s color, as numbers between 0 and 255. The alpha part represents opacity—when it is zero, the pixel is fully transparent, and when it is 255, it is fully opaque. For our purpose, we can ignore it.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ISSui65mS1 class=p_ident id=p_ISSui65mS1></a>The two hexadecimal digits per component, as used in our color notation, correspond precisely to the 0 to 255 range—two base-16 digits can express 16<sup>2</sup> = 256 different numbers. The <code>toString</code> method of numbers can be given a base as argument, so <code>n.toString(16)</code> will produce a string representation in base 16. We have to make sure that each number takes up two digits, so the <code>hex</code> helper function calls <code>padStart</code> to add a leading zero when necessary.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ZYiaCxYgwc class=p_ident id=p_ZYiaCxYgwc></a>We can load and save now! That leaves one more feature before we’re done.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_6z5Bscg+0R class=h_ident id=h_6z5Bscg+0R></a>Undo history</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_9BV8ZF7PJo class=p_ident id=p_9BV8ZF7PJo></a>Half of the process of editing is making little mistakes and correcting them. So an important feature in a drawing program is an undo history.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Gnol1X09SZ class=p_ident id=p_Gnol1X09SZ></a>To be able to undo changes, we need to store previous versions of the picture. Since it’s an immutable value, that is easy. But it does require an additional field in the application state.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ylDRpE2dGz class=p_ident id=p_ylDRpE2dGz></a>We’ll add a <code>done</code> array to keep previous versions of the picture. Maintaining this property requires a more complicated state update function that adds pictures to the array.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Rjg7sBJ+/e class=p_ident id=p_Rjg7sBJ+/e></a>But we don’t want to store <em>every</em> change, only changes a certain amount of time apart. To be able to do that, we’ll need a second property, <code>doneAt</code>, tracking the time at which we last stored a picture in the history.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_xx2001jEVe class=c_ident id=c_xx2001jEVe></a><p class=cm-keyword>function</p> <p class=cm-def>historyUpdateState</p>(<p class=cm-def>state</p>, <p class=cm-def>action</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>action</p>.<p class=cm-property>undo</p> <p class=cm-operator>==</p> <p class=cm-atom>true</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>state</p>.<p class=cm-property>done</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>state</p>; <p class=cm-keyword>return</p> <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable-2>state</p>, { <p class=cm-property>picture</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>done</p>[<p class=cm-number>0</p>], <p class=cm-property>done</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>done</p>.<p class=cm-property>slice</p>(<p class=cm-number>1</p>), <p class=cm-property>doneAt</p>: <p class=cm-number>0</p> }); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>action</p>.<p class=cm-property>picture</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>state</p>.<p class=cm-property>doneAt</p> <p class=cm-operator>&lt;</p> <p class=cm-variable>Date</p>.<p class=cm-property>now</p>() <p class=cm-operator>-</p> <p class=cm-number>1000</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable-2>state</p>, <p class=cm-variable-2>action</p>, { <p class=cm-property>done</p>: [<p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>, <p class=cm-variable-2>state</p>.<p class=cm-property>done</p>], <p class=cm-property>doneAt</p>: <p class=cm-variable>Date</p>.<p class=cm-property>now</p>() }); } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable-2>state</p>, <p class=cm-variable-2>action</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_CU+yNT8jA+ class=p_ident id=p_CU+yNT8jA+></a>When the action is an undo action, the function takes the most recent picture from the history and makes that the current picture. It sets <code>doneAt</code> to zero so that the next change is guaranteed to store the picture back in the history, allowing you to revert to it another time if you want.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_R91Icq4lrz class=p_ident id=p_R91Icq4lrz></a>Otherwise, if the action contains a new picture and the last time we stored something is more than a second (1000 milliseconds) ago, the <code>done</code> and <code>doneAt</code> properties are updated to store the previous picture.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_hl3atayXAC class=p_ident id=p_hl3atayXAC></a>The undo button component doesn’t do much. It dispatches undo actions when clicked and disables itself when there is nothing to undo.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_V5SwZIdQv8 class=c_ident id=c_V5SwZIdQv8></a><p class=cm-keyword>class</p> <p class=cm-def>UndoButton</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>, {<p class=cm-def>dispatch</p>}) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"button\"</p>, { <p class=cm-property>onclick</p>: () <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>dispatch</p>({<p class=cm-property>undo</p>: <p class=cm-atom>true</p>}), <p class=cm-property>disabled</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>done</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p> }, <p class=cm-string>\"⮪ Undo\"</p>); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>disabled</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>done</p>.<p class=cm-property>length</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>;\n  }\n}</pre> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_rUniBhw5Qd class=h_ident id=h_rUniBhw5Qd></a>Let’s draw</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_jIw4zXAanZ class=p_ident id=p_jIw4zXAanZ></a>To set up the application, we need to create a state, a set of tools, a set of controls, and a dispatch function. We can pass them to the <code>PixelEditor</code> constructor to create the main component. Since we’ll need to create several editors in the exercises, we first define some bindings.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_PyNgZwUySd class=c_ident id=c_PyNgZwUySd></a><p class=cm-keyword>const</p> <p class=cm-def>startState</p> <p class=cm-operator>=</p> { <p class=cm-property>tool</p>: <p class=cm-string>\"draw\"</p>, <p class=cm-property>color</p>: <p class=cm-string>\"#000000\"</p>, <p class=cm-property>picture</p>: <p class=cm-variable>Picture</p>.<p class=cm-property>empty</p>(<p class=cm-number>60</p>, <p class=cm-number>30</p>, <p class=cm-string>\"#f0f0f0\"</p>), <p class=cm-property>done</p>: [], <p class=cm-property>doneAt</p>: <p class=cm-number>0</p>\n}; <p class=cm-keyword>const</p> <p class=cm-def>baseTools</p> <p class=cm-operator>=</p> {<p class=cm-property>draw</p>, <p class=cm-property>fill</p>, <p class=cm-property>rectangle</p>, <p class=cm-property>pick</p>}; <p class=cm-keyword>const</p> <p class=cm-def>baseControls</p> <p class=cm-operator>=</p> [ <p class=cm-variable>ToolSelect</p>, <p class=cm-variable>ColorSelect</p>, <p class=cm-variable>SaveButton</p>, <p class=cm-variable>LoadButton</p>, <p class=cm-variable>UndoButton</p>\n]; <p class=cm-keyword>function</p> <p class=cm-def>startPixelEditor</p>({<p class=cm-def>state</p> <p class=cm-operator>=</p> <p class=cm-variable>startState</p>, <p class=cm-def>tools</p> <p class=cm-operator>=</p> <p class=cm-variable>baseTools</p>, <p class=cm-def>controls</p> <p class=cm-operator>=</p> <p class=cm-variable>baseControls</p>}) { <p class=cm-keyword>let</p> <p class=cm-def>app</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>PixelEditor</p>(<p class=cm-variable-2>state</p>, { <p class=cm-property>tools</p>, <p class=cm-property>controls</p>, <p class=cm-property>dispatch</p>(<p class=cm-def>action</p>) { <p class=cm-variable-2>state</p> <p class=cm-operator>=</p> <p class=cm-variable>historyUpdateState</p>(<p class=cm-variable-2>state</p>, <p class=cm-variable-2>action</p>); <p class=cm-variable-2>app</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>); } }); <p class=cm-keyword>return</p> <p class=cm-variable-2>app</p>.<p class=cm-property>dom</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_mvhc46WKC4 class=p_ident id=p_mvhc46WKC4></a>When destructuring an object or array, you can use <code>=</code> after a binding name to give the binding a default value, which is used when the property is missing or holds <code>undefined</code>. The <code>startPixelEditor</code> function makes use of this to accept an object with a number of optional properties as an argument. If you don’t provide a <code>tools</code> property, for example, <code>tools</code> will be bound to <code>baseTools</code>.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_rZawaYRcqb class=p_ident id=p_rZawaYRcqb></a>This is how we get an actual editor on the screen:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_eYhWs5adxG class=c_ident id=c_eYhWs5adxG></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>) .<p class=cm-property>appendChild</p>(<p class=cm-variable>startPixelEditor</p>({}));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_rdhO7mE6jW class=p_ident id=p_rdhO7mE6jW></a>Go ahead and draw something. I’ll wait.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_0bgBxHHAl2 class=h_ident id=h_0bgBxHHAl2></a>Why is this so hard?</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_PmpoI92nJu class=p_ident id=p_PmpoI92nJu></a>Browser technology is amazing. It provides a powerful set of interface building blocks, ways to style and manipulate them, and tools to inspect and debug your applications. The software you write for the browser can be run on almost every computer and phone on the planet.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_uqWgH1U6Ki class=p_ident id=p_uqWgH1U6Ki></a>At the same time, browser technology is ridiculous. You have to learn a large number of silly tricks and obscure facts to master it, and the default programming model it provides is so problematic that most programmers prefer to cover it in several layers of abstraction rather than deal with it directly.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_AyiKfJ46L7 class=p_ident id=p_AyiKfJ46L7></a>And though the situation is definitely improving, it mostly does so in the form of more elements being added to address shortcomings—creating even more complexity. A feature used by a million websites can’t really be replaced. Even if it could, it would be hard to decide what it should be replaced with.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_2Av6bIk2in class=p_ident id=p_2Av6bIk2in></a>Technology never exists in a vacuum—we’re constrained by our tools and the social, economic, and historical factors that produced them. This can be annoying, but it is generally more productive to try to build a good understanding of how the <em>existing</em> technical reality works—and why it is the way it is—than to rage against it or hold out for another reality.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_iDBDoz+SYO class=p_ident id=p_iDBDoz+SYO></a>New abstractions <em>can</em> be helpful. The component model and data flow convention I used in this chapter is a crude form of that. As mentioned, there are libraries that try to make user interface programming more pleasant. At the time of writing, <a href=https://reactjs.org/ >React</a> and <a href=https://angular.io/ >Angular</a> are popular choices, but there’s a whole cottage industry of such frameworks. If you’re interested in programming web applications, I recommend investigating a few of them to understand how they work and what benefits they provide.</p> <h2><a href=https://eloquentjavascript.net/19_paint.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <p><a href=https://eloquentjavascript.net/19_paint.html#p_We+KsAI00v class=p_ident id=p_We+KsAI00v></a>There is still room for improvement in our program. Let’s add a few more features as exercises.</p> <h3><a href=https://eloquentjavascript.net/19_paint.html#i_BUum8+bZXE class=i_ident id=i_BUum8+bZXE></a>Keyboard bindings</h3> <p><a href=https://eloquentjavascript.net/19_paint.html#p_FuGqJ+Eqr8 class=p_ident id=p_FuGqJ+Eqr8></a>Add keyboard shortcuts to the application. The first letter of a tool’s name selects the tool, and <span class=keyname>control</span>-Z or <span class=keyname>command</span>-Z activates undo.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Gnz9yDs2sE class=p_ident id=p_Gnz9yDs2sE></a>Do this by modifying the <code>PixelEditor</code> component. Add a <code>tabIndex</code> property of 0 to the wrapping <code>&lt;div&gt;</code> element so that it can receive keyboard focus. Note that the <em>property</em> corresponding to the <code>tabindex</code> <em>attribute</em> is called <code>tabIndex</code>, with a capital I, and our <code>elt</code> function expects property names. Register the key event handlers directly on that element. This means you have to click, touch, or tab to the application before you can interact with it with the keyboard.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Yzx5/UnTtd class=p_ident id=p_Yzx5/UnTtd></a>Remember that keyboard events have <code>ctrlKey</code> and <code>metaKey</code> (for the <span class=keyname>command</span> key on Mac) properties that you can use to see whether those keys are held down.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_9RBHLjfr9C class=c_ident id=c_9RBHLjfr9C></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>class</p> <p class=cm-def>PixelEditor</p> { <p class=cm-property>constructor</p>(<p class=cm-def>state</p>, <p class=cm-def>config</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>tools</p>, <p class=cm-def>controls</p>, <p class=cm-def>dispatch</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>config</p>; <p class=cm-keyword>this</p>.<p class=cm-property>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>; <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>PictureCanvas</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>, <p class=cm-def>pos</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>tool</p> <p class=cm-operator>=</p> <p class=cm-variable-2>tools</p>[<p class=cm-keyword>this</p>.<p class=cm-property>state</p>.<p class=cm-property>tool</p>]; <p class=cm-keyword>let</p> <p class=cm-def>onMove</p> <p class=cm-operator>=</p> <p class=cm-variable-2>tool</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>state</p>, <p class=cm-variable-2>dispatch</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>onMove</p>) { <p class=cm-keyword>return</p> <p class=cm-def>pos</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>onMove</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>state</p>, <p class=cm-variable-2>dispatch</p>); } }); <p class=cm-keyword>this</p>.<p class=cm-property>controls</p> <p class=cm-operator>=</p> <p class=cm-variable-2>controls</p>.<p class=cm-property>map</p>( <p class=cm-def>Control</p> <p class=cm-operator>=&gt;</p> <p class=cm-keyword>new</p> <p class=cm-variable-2>Control</p>(<p class=cm-variable-2>state</p>, <p class=cm-variable-2>config</p>)); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"div\"</p>, {}, <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p>.<p class=cm-property>dom</p>, <p class=cm-variable>elt</p>(<p class=cm-string>\"br\"</p>), <p class=cm-keyword>this</p>.<p class=cm-property>controls</p>.<p class=cm-property>reduce</p>( (<p class=cm-def>a</p>, <p class=cm-def>c</p>) <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p>.<p class=cm-property>concat</p>(<p class=cm-string>\" \"</p>, <p class=cm-variable-2>c</p>.<p class=cm-property>dom</p>), [])); } <p class=cm-property>syncState</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>; <p class=cm-keyword>this</p>.<p class=cm-property>canvas</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>ctrl</p> <p class=cm-keyword>of</p> <p class=cm-keyword>this</p>.<p class=cm-property>controls</p>) <p class=cm-variable-2>ctrl</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>); } } <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>) .<p class=cm-property>appendChild</p>(<p class=cm-variable>startPixelEditor</p>({}));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/19_paint.html#p_xwvacRuw4q class=p_ident id=p_xwvacRuw4q></a>The <code>key</code> property of events for letter keys will be the lowercase letter itself, if <span class=keyname>shift</span> isn’t being held. We’re not interested in key events with <span class=keyname>shift</span> here.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ODUWMiqiFq class=p_ident id=p_ODUWMiqiFq></a>A <code>\"keydown\"</code> handler can inspect its event object to see whether it matches any of the shortcuts. You can automatically get the list of first letters from the <code>tools</code> object so that you don’t have to write them out.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_+R29awWdUv class=p_ident id=p_+R29awWdUv></a>When the key event matches a shortcut, call <code>preventDefault</code> on it and dispatch the appropriate action.</p> </div></div> <h3><a href=https://eloquentjavascript.net/19_paint.html#i_N6J15nL9us class=i_ident id=i_N6J15nL9us></a>Efficient drawing</h3> <p><a href=https://eloquentjavascript.net/19_paint.html#p_IwtJehHo1s class=p_ident id=p_IwtJehHo1s></a>During drawing, the majority of work that our application does happens in <code>drawPicture</code>. Creating a new state and updating the rest of the DOM isn’t very expensive, but repainting all the pixels on the canvas is quite a bit of work.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_ttnFBSQKkT class=p_ident id=p_ttnFBSQKkT></a>Find a way to make the <code>syncState</code> method of <code>PictureCanvas</code> faster by redrawing only the pixels that actually changed.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_usWBD49GQe class=p_ident id=p_usWBD49GQe></a>Remember that <code>drawPicture</code> is also used by the save button, so if you change it, either make sure the changes don’t break the old use or create a new version with a different name.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_K1ZR/jxVLm class=p_ident id=p_K1ZR/jxVLm></a>Also note that changing the size of a <code>&lt;canvas&gt;</code> element, by setting its <code>width</code> or <code>height</code> properties, clears it, making it entirely transparent again.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_WYxUTPFclW class=c_ident id=c_WYxUTPFclW></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>PictureCanvas</p>.<p class=cm-property>prototype</p>.<p class=cm-property>syncState</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>picture</p>) { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>==</p> <p class=cm-variable-2>picture</p>) <p class=cm-keyword>return</p>; <p class=cm-keyword>this</p>.<p class=cm-property>picture</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>; <p class=cm-variable>drawPicture</p>(<p class=cm-keyword>this</p>.<p class=cm-property>picture</p>, <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>, <p class=cm-variable>scale</p>); }; <p class=cm-keyword>function</p> <p class=cm-def>drawPicture</p>(<p class=cm-def>picture</p>, <p class=cm-def>canvas</p>, <p class=cm-def>scale</p>) { <p class=cm-variable-2>canvas</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>width</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>; <p class=cm-variable-2>canvas</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>height</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>; <p class=cm-keyword>let</p> <p class=cm-def>cx</p> <p class=cm-operator>=</p> <p class=cm-variable-2>canvas</p>.<p class=cm-property>getContext</p>(<p class=cm-string>\"2d\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>height</p>; <p class=cm-variable-2>y</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>width</p>; <p class=cm-variable-2>x</p><p class=cm-operator>++</p>) { <p class=cm-variable-2>cx</p>.<p class=cm-property>fillStyle</p> <p class=cm-operator>=</p> <p class=cm-variable-2>picture</p>.<p class=cm-property>pixel</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>); <p class=cm-variable-2>cx</p>.<p class=cm-property>fillRect</p>(<p class=cm-variable-2>x</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>y</p> <p class=cm-operator>*</p> <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>scale</p>, <p class=cm-variable-2>scale</p>); } } } <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>) .<p class=cm-property>appendChild</p>(<p class=cm-variable>startPixelEditor</p>({}));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/19_paint.html#p_hWnsI+3L35 class=p_ident id=p_hWnsI+3L35></a>This exercise is a good example of how immutable data structures can make code <em>faster</em>. Because we have both the old and the new picture, we can compare them and redraw only the pixels that changed color, saving more than 99 percent of the drawing work in most cases.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_tH/EgkLe4/ class=p_ident id=p_tH/EgkLe4/ ></a>You can either write a new function <code>updatePicture</code> or have <code>drawPicture</code> take an extra argument, which may be undefined or the previous picture. For each pixel, the function checks whether a previous picture was passed with the same color at this position and skips the pixel when that is the case.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_iypPTMWN+N class=p_ident id=p_iypPTMWN+N></a>Because the canvas gets cleared when we change its size, you should also avoid touching its <code>width</code> and <code>height</code> properties when the old picture and the new picture have the same size. If they are different, which will happen when a new picture has been loaded, you can set the binding holding the old picture to null after changing the canvas size because you shouldn’t skip any pixels after you’ve changed the canvas size.</p> </div></div> <h3><a href=https://eloquentjavascript.net/19_paint.html#i_lH0RbmdIJo class=i_ident id=i_lH0RbmdIJo></a>Circles</h3> <p><a href=https://eloquentjavascript.net/19_paint.html#p_CKH37/aTkf class=p_ident id=p_CKH37/aTkf></a>Define a tool called <code>circle</code> that draws a filled circle when you drag. The center of the circle lies at the point where the drag or touch gesture starts, and its radius is determined by the distance dragged.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_MYYVHp5bsE class=c_ident id=c_MYYVHp5bsE></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>circle</p>(<p class=cm-def>pos</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { } <p class=cm-keyword>let</p> <p class=cm-def>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>startPixelEditor</p>({ <p class=cm-property>tools</p>: <p class=cm-variable>Object</p>.<p class=cm-property>assign</p>({}, <p class=cm-variable>baseTools</p>, {<p class=cm-property>circle</p>}) }); <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>).<p class=cm-property>appendChild</p>(<p class=cm-variable>dom</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/19_paint.html#p_n8gcP1wK10 class=p_ident id=p_n8gcP1wK10></a>You can take some inspiration from the <code>rectangle</code> tool. Like that tool, you’ll want to keep drawing on the <em>starting</em> picture, rather than the current picture, when the pointer moves.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_g4iL6doRwh class=p_ident id=p_g4iL6doRwh></a>To figure out which pixels to color, you can use the Pythagorean theorem. First figure out the distance between the current pointer position and the start position by taking the square root (<code>Math.sqrt</code>) of the sum of the square (<code>Math.pow(x, 2)</code>) of the difference in x-coordinates and the square of the difference in y-coordinates. Then loop over a square of pixels around the start position, whose sides are at least twice the radius, and color those that are within the circle’s radius, again using the Pythagorean formula to figure out their distance from the center.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_6rR6tnEiD7 class=p_ident id=p_6rR6tnEiD7></a>Make sure you don’t try to color pixels that are outside of the picture’s boundaries.</p> </div></div> <h3><a href=https://eloquentjavascript.net/19_paint.html#i_gbSk/YiRrs class=i_ident id=i_gbSk/YiRrs></a>Proper lines</h3> <p><a href=https://eloquentjavascript.net/19_paint.html#p_9+5Lhu8/5P class=p_ident id=p_9+5Lhu8/5P></a>This is a more advanced exercise than the preceding two, and it will require you to design a solution to a nontrivial problem. Make sure you have plenty of time and patience before starting to work on this exercise, and do not get discouraged by initial failures.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_VU//OuPykO class=p_ident id=p_VU//OuPykO></a>On most browsers, when you select the <code>draw</code> tool and quickly drag across the picture, you don’t get a closed line. Rather, you get dots with gaps between them because the <code>\"mousemove\"</code> or <code>\"touchmove\"</code> events did not fire quickly enough to hit every pixel.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_MVVAQugFEf class=p_ident id=p_MVVAQugFEf></a>Improve the <code>draw</code> tool to make it draw a full line. This means you have to make the motion handler function remember the previous position and connect that to the current one.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_7SM2TRnD47 class=p_ident id=p_7SM2TRnD47></a>To do this, since the pixels can be an arbitrary distance apart, you’ll have to write a general line drawing function.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_e6Gkv3bxv2 class=p_ident id=p_e6Gkv3bxv2></a>A line between two pixels is a connected chain of pixels, as straight as possible, going from the start to the end. Diagonally adjacent pixels count as a connected. So a slanted line should look like the picture on the left, not the picture on the right.</p><figure><img alt=\"Two pixelated lines, one light, skipping across pixels diagonally, and one heavy, with all pixels connected horizontally or vertically\" src=https://eloquentjavascript.net/img/line-grid.svg></figure> <p><a href=https://eloquentjavascript.net/19_paint.html#p_+B4IUrham3 class=p_ident id=p_+B4IUrham3></a>Finally, if we have code that draws a line between two arbitrary points, we might as well use it to also define a <code>line</code> tool, which draws a straight line between the start and end of a drag.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_lYipUdu4TJ class=c_ident id=c_lYipUdu4TJ></a><p class=cm-tag>&lt;</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>draw</p>(<p class=cm-def>pos</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { <p class=cm-keyword>function</p> <p class=cm-def>drawPixel</p>({<p class=cm-def>x</p>, <p class=cm-def>y</p>}, <p class=cm-def>state</p>) { <p class=cm-keyword>let</p> <p class=cm-def>drawn</p> <p class=cm-operator>=</p> {<p class=cm-property>x</p>, <p class=cm-property>y</p>, <p class=cm-property>color</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>color</p>}; <p class=cm-variable-2>dispatch</p>({<p class=cm-property>picture</p>: <p class=cm-variable-2>state</p>.<p class=cm-property>picture</p>.<p class=cm-property>draw</p>([<p class=cm-variable-2>drawn</p>])}); } <p class=cm-variable-2>drawPixel</p>(<p class=cm-variable-2>pos</p>, <p class=cm-variable-2>state</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>drawPixel</p>; } <p class=cm-keyword>function</p> <p class=cm-def>line</p>(<p class=cm-def>pos</p>, <p class=cm-def>state</p>, <p class=cm-def>dispatch</p>) { } <p class=cm-keyword>let</p> <p class=cm-def>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>startPixelEditor</p>({ <p class=cm-property>tools</p>: {<p class=cm-property>draw</p>, <p class=cm-property>line</p>, <p class=cm-property>fill</p>, <p class=cm-property>rectangle</p>, <p class=cm-property>pick</p>} }); <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>).<p class=cm-property>appendChild</p>(<p class=cm-variable>dom</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/19_paint.html#p_0Sbp4dO/v8 class=p_ident id=p_0Sbp4dO/v8></a>The thing about the problem of drawing a pixelated line is that it is really four similar but slightly different problems. Drawing a horizontal line from the left to the right is easy—you loop over the x-coordinates and color a pixel at every step. If the line has a slight slope (less than 45 degrees or ¼π radians), you can interpolate the y-coordinate along the slope. You still need one pixel per <em>x</em> position, with the <em>y</em> position of those pixels determined by the slope.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_mrTlGXQJo5 class=p_ident id=p_mrTlGXQJo5></a>But as soon as your slope goes across 45 degrees, you need to switch the way you treat the coordinates. You now need one pixel per <em>y</em> position since the line goes up more than it goes left. And then, when you cross 135 degrees, you have to go back to looping over the x-coordinates, but from right to left.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_IfupYbaeUB class=p_ident id=p_IfupYbaeUB></a>You don’t actually have to write four loops. Since drawing a line from <em>A</em> to <em>B</em> is the same as drawing a line from <em>B</em> to <em>A</em>, you can swap the start and end positions for lines going from right to left and treat them as going left to right.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_Hn7VorKX+l class=p_ident id=p_Hn7VorKX+l></a>So you need two different loops. The first thing your line drawing function should do is check whether the difference between the x-coordinates is larger than the difference between the y-coordinates. If it is, this is a horizontal-ish line, and if not, a vertical-ish one.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_J1kJbTfzUr class=p_ident id=p_J1kJbTfzUr></a>Make sure you compare the <em>absolute</em> values of the <em>x</em> and <em>y</em> difference, which you can get with <code>Math.abs</code>.</p> <p><a href=https://eloquentjavascript.net/19_paint.html#p_XJKDpy8qQW class=p_ident id=p_XJKDpy8qQW></a>Once you know along which axis you will be looping, you can check whether the start point has a higher coordinate along that axis than the endpoint and swap them if necessary. A succinct way to swap the values of two bindings in JavaScript uses destructuring assignment like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/19_paint.html#c_/XtfsVpMBL class=c_ident id=c_/XtfsVpMBL></a>[<span class=cm-variable>start</span>, <span class=cm-variable>end</span>] <span class=cm-operator>=</span> [<span class=cm-variable>end</span>, <span class=cm-variable>start</span>];</pre> <p><a href=https://eloquentjavascript.net/19_paint.html#p_kQN0DL7QjH class=p_ident id=p_kQN0DL7QjH></a>Then you can compute the slope of the line, which determines the amount the coordinate on the other axis changes for each step you take along your main axis. With that, you can run a loop along the main axis while also tracking the corresponding position on the other axis, and you can draw pixels on every iteration. Make sure you round the non-main axis coordinates since they are likely to be fractional and the <code>draw</code> method doesn’t respond well to fractional coordinates.</p> </div></div><nav><a href=https://eloquentjavascript.net/18_http.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/20_node.html>▶</a></nav>\n</article><hr><h4>Page 15</h4><article score=1035.0500000000002>\n<nav><a href=https://eloquentjavascript.net/15_event.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/17_canvas.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/16_game.html#p_kUA7+lr6ay class=p_ident id=p_kUA7+lr6ay></a>All reality is a game.</p> <footer>Iain Banks, <cite>The Player of Games</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture of a game character jumping over lava\" src=https://eloquentjavascript.net/img/chapter_picture_16.jpg></figure> <p><a href=https://eloquentjavascript.net/16_game.html#p_OqEjiDXza0 class=p_ident id=p_OqEjiDXza0></a>Much of my initial fascination with computers, like that of many nerdy kids, had to do with computer games. I was drawn into the tiny simulated worlds that I could manipulate and in which stories (sort of) unfolded—more, I suppose, because of the way I projected my imagination into them than because of the possibilities they actually offered.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_hkas9mExVc class=p_ident id=p_hkas9mExVc></a>I don’t wish a career in game programming on anyone. Much like the music industry, the discrepancy between the number of eager young people wanting to work in it and the actual demand for such people creates a rather unhealthy environment. But writing games for fun is amusing.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_U1BQ0KJdvV class=p_ident id=p_U1BQ0KJdvV></a>This chapter will walk through the implementation of a small platform game. Platform games (or “jump and run” games) are games that expect the player to move a figure through a world, which is usually two-dimensional and viewed from the side, while jumping over and onto things.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_lMtTRzata0 class=h_ident id=h_lMtTRzata0></a>The game</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_C38xTPlNF8 class=p_ident id=p_C38xTPlNF8></a>Our game will be roughly based on <a href=http://www.lessmilk.com/games/10>Dark Blue</a> by Thomas Palef. I chose that game because it is both entertaining and minimalist and because it can be built without too much code. It looks like this:</p><figure><img alt=\"The game Dark Blue\" src=https://eloquentjavascript.net/img/darkblue.png></figure> <p><a href=https://eloquentjavascript.net/16_game.html#p_mIXBfsCnQQ class=p_ident id=p_mIXBfsCnQQ></a>The dark box represents the player, whose task is to collect the yellow boxes (coins) while avoiding the red stuff (lava). A level is completed when all coins have been collected.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_Y1K6GO/tu5 class=p_ident id=p_Y1K6GO/tu5></a>The player can walk around with the left and right arrow keys and can jump with the up arrow. Jumping is a specialty of this game character. It can reach several times its own height and can change direction in midair. This may not be entirely realistic, but it helps give the player the feeling of being in direct control of the on-screen avatar.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_or+OtPnSO1 class=p_ident id=p_or+OtPnSO1></a>The game consists of a static background, laid out like a grid, with the moving elements overlaid on that background. Each field on the grid is either empty, solid, or lava. The moving elements are the player, coins, and certain pieces of lava. The positions of these elements are not constrained to the grid—their coordinates may be fractional, allowing smooth motion.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_hLFu/U4fE5 class=h_ident id=h_hLFu/U4fE5></a>The technology</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_w6B1L26QOc class=p_ident id=p_w6B1L26QOc></a>We will use the browser DOM to display the game, and we’ll read user input by handling key events.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_wha4Kv9EnE class=p_ident id=p_wha4Kv9EnE></a>The screen- and keyboard-related code is only a small part of the work we need to do to build this game. Since everything looks like colored boxes, drawing is uncomplicated: we create DOM elements and use styling to give them a background color, size, and position.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_iXpeeK1cBS class=p_ident id=p_iXpeeK1cBS></a>We can represent the background as a table since it is an unchanging grid of squares. The free-moving elements can be overlaid using absolutely positioned elements.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_uCQz+7JTon class=p_ident id=p_uCQz+7JTon></a>In games and other programs that should animate graphics and respond to user input without noticeable delay, efficiency is important. Although the DOM was not originally designed for high-performance graphics, it is actually better at this than you would expect. You saw some animations in <a href=https://eloquentjavascript.net/14_dom.html#animation>Chapter 14</a>. On a modern machine, a simple game like this performs well, even if we don’t worry about optimization very much.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_fFvps6KPyM class=p_ident id=p_fFvps6KPyM></a>In the <a href=https://eloquentjavascript.net/17_canvas.html>next chapter</a>, we will explore another browser technology, the <code>&lt;canvas&gt;</code> tag, which provides a more traditional way to draw graphics, working in terms of shapes and pixels rather than DOM elements.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_7UfwmBGLOk class=h_ident id=h_7UfwmBGLOk></a>Levels</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_abOzbCGnYG class=p_ident id=p_abOzbCGnYG></a>We’ll want a human-readable, human-editable way to specify levels. Since it is okay for everything to start out on a grid, we could use big strings in which each character represents an element—either a part of the background grid or a moving element.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_On1HrmEvoL class=p_ident id=p_On1HrmEvoL></a>The plan for a small level might look like this:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_txvY7tsNJp class=c_ident id=c_txvY7tsNJp></a><p class=cm-keyword>let</p> <p class=cm-def>simpleLevelPlan</p> <p class=cm-operator>=</p> <p class=cm-string-2>`</p>\n<p class=cm-string-2>......................</p>\n<p class=cm-string-2>..#................#..</p>\n<p class=cm-string-2>..#..............=.#..</p>\n<p class=cm-string-2>..#.........o.o....#..</p>\n<p class=cm-string-2>..#.@......#####...#..</p>\n<p class=cm-string-2>..#####............#..</p>\n<p class=cm-string-2>......#++++++++++++#..</p>\n<p class=cm-string-2>......##############..</p>\n<p class=cm-string-2>......................`</p>;</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_9xefWk13KJ class=p_ident id=p_9xefWk13KJ></a>Periods are empty space, hash (<code>#</code>) characters are walls, and plus signs are lava. The player’s starting position is the at sign (<code>@</code>). Every O character is a coin, and the equal sign (<code>=</code>) at the top is a block of lava that moves back and forth horizontally.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_0EQudcPkjK class=p_ident id=p_0EQudcPkjK></a>We’ll support two additional kinds of moving lava: the pipe character (<code>|</code>) creates vertically moving blobs, and <code>v</code> indicates <em>dripping</em> lava—vertically moving lava that doesn’t bounce back and forth but only moves down, jumping back to its start position when it hits the floor.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_JSlRu3lL/0 class=p_ident id=p_JSlRu3lL/0></a>A whole game consists of multiple levels that the player must complete. A level is completed when all coins have been collected. If the player touches lava, the current level is restored to its starting position, and the player may try again.</p> <h2 id=level><a href=https://eloquentjavascript.net/16_game.html#h_DeVC1tufta class=h_ident id=h_DeVC1tufta></a>Reading a level</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_YiuShyNEuf class=p_ident id=p_YiuShyNEuf></a>The following class stores a level object. Its argument should be the string that defines the level.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_ObYKMNTKci class=c_ident id=c_ObYKMNTKci></a><p class=cm-keyword>class</p> <p class=cm-def>Level</p> { <p class=cm-property>constructor</p>(<p class=cm-def>plan</p>) { <p class=cm-keyword>let</p> <p class=cm-def>rows</p> <p class=cm-operator>=</p> <p class=cm-variable-2>plan</p>.<p class=cm-property>trim</p>().<p class=cm-property>split</p>(<p class=cm-string>\"\\n\"</p>).<p class=cm-property>map</p>(<p class=cm-def>l</p> <p class=cm-operator>=&gt;</p> [<p class=cm-variable-2>l</p>]); <p class=cm-keyword>this</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-variable-2>rows</p>.<p class=cm-property>length</p>; <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>rows</p>[<p class=cm-number>0</p>].<p class=cm-property>length</p>; <p class=cm-keyword>this</p>.<p class=cm-property>startActors</p> <p class=cm-operator>=</p> []; <p class=cm-keyword>this</p>.<p class=cm-property>rows</p> <p class=cm-operator>=</p> <p class=cm-variable-2>rows</p>.<p class=cm-property>map</p>((<p class=cm-def>row</p>, <p class=cm-def>y</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>return</p> <p class=cm-variable-2>row</p>.<p class=cm-property>map</p>((<p class=cm-def>ch</p>, <p class=cm-def>x</p>) <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>type</p> <p class=cm-operator>=</p> <p class=cm-variable>levelChars</p>[<p class=cm-variable-2>ch</p>]; <p class=cm-keyword>if</p> (<p class=cm-keyword>typeof</p> <p class=cm-variable-2>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"string\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>type</p>; <p class=cm-keyword>this</p>.<p class=cm-property>startActors</p>.<p class=cm-property>push</p>( <p class=cm-variable-2>type</p>.<p class=cm-property>create</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-variable-2>x</p>, <p class=cm-variable-2>y</p>), <p class=cm-variable-2>ch</p>)); <p class=cm-keyword>return</p> <p class=cm-string>\"empty\"</p>;\n      });\n    });\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_JIksXnWVuw class=p_ident id=p_JIksXnWVuw></a>The <code>trim</code> method is used to remove whitespace at the start and end of the plan string. This allows our example plan to start with a newline so that all the lines are directly below each other. The remaining string is split on newline characters, and each line is spread into an array, producing arrays of characters.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_LoAi+0JNfy class=p_ident id=p_LoAi+0JNfy></a>So <code>rows</code> holds an array of arrays of characters, the rows of the plan. We can derive the level’s width and height from these. But we must still separate the moving elements from the background grid. We’ll call moving elements <em>actors</em>. They’ll be stored in an array of objects. The background will be an array of arrays of strings, holding field types such as <code>\"empty\"</code>, <code>\"wall\"</code>, or <code>\"lava\"</code>.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_rJcldM+jM6 class=p_ident id=p_rJcldM+jM6></a>To create these arrays, we map over the rows and then over their content. Remember that <code>map</code> passes the array index as a second argument to the mapping function, which tells us the x- and y-coordinates of a given character. Positions in the game will be stored as pairs of coordinates, with the top left being 0,0 and each background square being 1 unit high and wide.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_MMksR1/9C2 class=p_ident id=p_MMksR1/9C2></a>To interpret the characters in the plan, the <code>Level</code> constructor uses the <code>levelChars</code> object, which maps background elements to strings and actor characters to classes. When <code>type</code> is an actor class, its static <code>create</code> method is used to create an object, which is added to <code>startActors</code>, and the mapping function returns <code>\"empty\"</code> for this background square.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_XPViP3s8zO class=p_ident id=p_XPViP3s8zO></a>The position of the actor is stored as a <code>Vec</code> object. This is a two-dimensional vector, an object with <code>x</code> and <code>y</code> properties, as seen in the exercises of <a href=https://eloquentjavascript.net/06_object.html#exercise_vector>Chapter 6</a>.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_nuR5OrGgSy class=p_ident id=p_nuR5OrGgSy></a>As the game runs, actors will end up in different places or even disappear entirely (as coins do when collected). We’ll use a <code>State</code> class to track the state of a running game.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_8mXPZZkFTr class=c_ident id=c_8mXPZZkFTr></a><p class=cm-keyword>class</p> <p class=cm-def>State</p> { <p class=cm-property>constructor</p>(<p class=cm-def>level</p>, <p class=cm-def>actors</p>, <p class=cm-def>status</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>level</p> <p class=cm-operator>=</p> <p class=cm-variable-2>level</p>; <p class=cm-keyword>this</p>.<p class=cm-property>actors</p> <p class=cm-operator>=</p> <p class=cm-variable-2>actors</p>; <p class=cm-keyword>this</p>.<p class=cm-property>status</p> <p class=cm-operator>=</p> <p class=cm-variable-2>status</p>; } <p class=cm-keyword>static</p> <p class=cm-property>start</p>(<p class=cm-def>level</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>State</p>(<p class=cm-variable-2>level</p>, <p class=cm-variable-2>level</p>.<p class=cm-property>startActors</p>, <p class=cm-string>\"playing\"</p>); } <p class=cm-keyword>get</p> <p class=cm-property>player</p>() { <p class=cm-keyword>return</p> <p class=cm-keyword>this</p>.<p class=cm-property>actors</p>.<p class=cm-property>find</p>(<p class=cm-def>a</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"player\"</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_ykNWl1yVwU class=p_ident id=p_ykNWl1yVwU></a>The <code>status</code> property will switch to <code>\"lost\"</code> or <code>\"won\"</code> when the game has ended.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_HXx6FQb6dD class=p_ident id=p_HXx6FQb6dD></a>This is again a persistent data structure—updating the game state creates a new state and leaves the old one intact.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_pw0251T7gn class=h_ident id=h_pw0251T7gn></a>Actors</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_JlMpFXE8o0 class=p_ident id=p_JlMpFXE8o0></a>Actor objects represent the current position and state of a given moving element in our game. All actor objects conform to the same interface. Their <code>pos</code> property holds the coordinates of the element’s top-left corner, and their <code>size</code> property holds its size.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_zAiZFPI5Yc class=p_ident id=p_zAiZFPI5Yc></a>Then they have an <code>update</code> method, which is used to compute their new state and position after a given time step. It simulates the thing the actor does—moving in response to the arrow keys for the player and bouncing back and forth for the lava—and returns a new, updated actor object.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_yHrnzwQ8R4 class=p_ident id=p_yHrnzwQ8R4></a>A <code>type</code> property contains a string that identifies the type of the actor—<code>\"player\"</code>, <code>\"coin\"</code>, or <code>\"lava\"</code>. This is useful when drawing the game—the look of the rectangle drawn for an actor is based on its type.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_vyajSMujgl class=p_ident id=p_vyajSMujgl></a>Actor classes have a static <code>create</code> method that is used by the <code>Level</code> constructor to create an actor from a character in the level plan. It is given the coordinates of the character and the character itself, which is needed because the <code>Lava</code> class handles several different characters.</p> <p id=vector><a href=https://eloquentjavascript.net/16_game.html#p_lWgsae+2Q1 class=p_ident id=p_lWgsae+2Q1></a>This is the <code>Vec</code> class that we’ll use for our two-dimensional values, such as the position and size of actors.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_Hb9lakixOM class=c_ident id=c_Hb9lakixOM></a><p class=cm-keyword>class</p> <p class=cm-def>Vec</p> { <p class=cm-property>constructor</p>(<p class=cm-def>x</p>, <p class=cm-def>y</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>=</p> <p class=cm-variable-2>x</p>; <p class=cm-keyword>this</p>.<p class=cm-property>y</p> <p class=cm-operator>=</p> <p class=cm-variable-2>y</p>; } <p class=cm-property>plus</p>(<p class=cm-def>other</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>other</p>.<p class=cm-property>x</p>, <p class=cm-keyword>this</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>other</p>.<p class=cm-property>y</p>); } <p class=cm-property>times</p>(<p class=cm-def>factor</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-keyword>this</p>.<p class=cm-property>x</p> <p class=cm-operator>*</p> <p class=cm-variable-2>factor</p>, <p class=cm-keyword>this</p>.<p class=cm-property>y</p> <p class=cm-operator>*</p> <p class=cm-variable-2>factor</p>);\n  }\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_gWWk7Ulj1q class=p_ident id=p_gWWk7Ulj1q></a>The <code>times</code> method scales a vector by a given number. It will be useful when we need to multiply a speed vector by a time interval to get the distance traveled during that time.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_AGmjtw30RN class=p_ident id=p_AGmjtw30RN></a>The different types of actors get their own classes since their behavior is very different. Let’s define these classes. We’ll get to their <code>update</code> methods later.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_qFX0r+uydc class=p_ident id=p_qFX0r+uydc></a>The player class has a property <code>speed</code> that stores its current speed to simulate momentum and gravity.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_+Zda+gD/W/ class=c_ident id=c_+Zda+gD/W/ ></a><p class=cm-keyword>class</p> <p class=cm-def>Player</p> { <p class=cm-property>constructor</p>(<p class=cm-def>pos</p>, <p class=cm-def>speed</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>; <p class=cm-keyword>this</p>.<p class=cm-property>speed</p> <p class=cm-operator>=</p> <p class=cm-variable-2>speed</p>; } <p class=cm-keyword>get</p> <p class=cm-property>type</p>() { <p class=cm-keyword>return</p> <p class=cm-string>\"player\"</p>; } <p class=cm-keyword>static</p> <p class=cm-property>create</p>(<p class=cm-def>pos</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Player</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-operator>-</p><p class=cm-number>0.5</p>)), <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-number>0</p>)); }\n} <p class=cm-variable>Player</p>.<p class=cm-property>prototype</p>.<p class=cm-property>size</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0.8</p>, <p class=cm-number>1.5</p>);</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_pJwDuA/gUR class=p_ident id=p_pJwDuA/gUR></a>Because a player is one-and-a-half squares high, its initial position is set to be half a square above the position where the <code>@</code> character appeared. This way, its bottom aligns with the bottom of the square it appeared in.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_X3b7n+ph7P class=p_ident id=p_X3b7n+ph7P></a>The <code>size</code> property is the same for all instances of <code>Player</code>, so we store it on the prototype rather than on the instances themselves. We could have used a getter like <code>type</code>, but that would create and return a new <code>Vec</code> object every time the property is read, which would be wasteful. (Strings, being immutable, don’t have to be re-created every time they are evaluated.)</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_CZIhBrKg4H class=p_ident id=p_CZIhBrKg4H></a>When constructing a <code>Lava</code> actor, we need to initialize the object differently depending on the character it is based on. Dynamic lava moves along at its current speed until it hits an obstacle. At that point, if it has a <code>reset</code> property, it will jump back to its start position (dripping). If it does not, it will invert its speed and continue in the other direction (bouncing).</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_0NJ2jc8Gmf class=p_ident id=p_0NJ2jc8Gmf></a>The <code>create</code> method looks at the character that the <code>Level</code> constructor passes and creates the appropriate lava actor.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_OquWedN4L5 class=c_ident id=c_OquWedN4L5></a><p class=cm-keyword>class</p> <p class=cm-def>Lava</p> { <p class=cm-property>constructor</p>(<p class=cm-def>pos</p>, <p class=cm-def>speed</p>, <p class=cm-def>reset</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>; <p class=cm-keyword>this</p>.<p class=cm-property>speed</p> <p class=cm-operator>=</p> <p class=cm-variable-2>speed</p>; <p class=cm-keyword>this</p>.<p class=cm-property>reset</p> <p class=cm-operator>=</p> <p class=cm-variable-2>reset</p>; } <p class=cm-keyword>get</p> <p class=cm-property>type</p>() { <p class=cm-keyword>return</p> <p class=cm-string>\"lava\"</p>; } <p class=cm-keyword>static</p> <p class=cm-property>create</p>(<p class=cm-def>pos</p>, <p class=cm-def>ch</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>ch</p> <p class=cm-operator>==</p> <p class=cm-string>\"=\"</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>2</p>, <p class=cm-number>0</p>)); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>ch</p> <p class=cm-operator>==</p> <p class=cm-string>\"|\"</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-number>2</p>)); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>ch</p> <p class=cm-operator>==</p> <p class=cm-string>\"v\"</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-number>3</p>), <p class=cm-variable-2>pos</p>); } }\n} <p class=cm-variable>Lava</p>.<p class=cm-property>prototype</p>.<p class=cm-property>size</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>1</p>, <p class=cm-number>1</p>);</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_fqdOUTLAz4 class=p_ident id=p_fqdOUTLAz4></a><code>Coin</code> actors are relatively simple. They mostly just sit in their place. But to liven up the game a little, they are given a “wobble”, a slight vertical back-and-forth motion. To track this, a coin object stores a base position as well as a <code>wobble</code> property that tracks the phase of the bouncing motion. Together, these determine the coin’s actual position (stored in the <code>pos</code> property).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_f2L1vFl5w5 class=c_ident id=c_f2L1vFl5w5></a><p class=cm-keyword>class</p> <p class=cm-def>Coin</p> { <p class=cm-property>constructor</p>(<p class=cm-def>pos</p>, <p class=cm-def>basePos</p>, <p class=cm-def>wobble</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>; <p class=cm-keyword>this</p>.<p class=cm-property>basePos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>basePos</p>; <p class=cm-keyword>this</p>.<p class=cm-property>wobble</p> <p class=cm-operator>=</p> <p class=cm-variable-2>wobble</p>; } <p class=cm-keyword>get</p> <p class=cm-property>type</p>() { <p class=cm-keyword>return</p> <p class=cm-string>\"coin\"</p>; } <p class=cm-keyword>static</p> <p class=cm-property>create</p>(<p class=cm-def>pos</p>) { <p class=cm-keyword>let</p> <p class=cm-def>basePos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0.2</p>, <p class=cm-number>0.1</p>)); <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Coin</p>(<p class=cm-variable-2>basePos</p>, <p class=cm-variable-2>basePos</p>, <p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>*</p> <p class=cm-variable>Math</p>.<p class=cm-property>PI</p> <p class=cm-operator>*</p> <p class=cm-number>2</p>); }\n} <p class=cm-variable>Coin</p>.<p class=cm-property>prototype</p>.<p class=cm-property>size</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0.6</p>, <p class=cm-number>0.6</p>);</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_C16pTz7oRy class=p_ident id=p_C16pTz7oRy></a>In <a href=https://eloquentjavascript.net/14_dom.html#sin_cos>Chapter 14</a>, we saw that <code>Math.sin</code> gives us the y-coordinate of a point on a circle. That coordinate goes back and forth in a smooth waveform as we move along the circle, which makes the sine function useful for modeling a wavy motion.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_gQCua74XOk class=p_ident id=p_gQCua74XOk></a>To avoid a situation where all coins move up and down synchronously, the starting phase of each coin is randomized. The <em>phase</em> of <code>Math.sin</code>’s wave, the width of a wave it produces, is 2π. We multiply the value returned by <code>Math.random</code> by that number to give the coin a random starting position on the wave.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_0wsl0zoIAL class=p_ident id=p_0wsl0zoIAL></a>We can now define the <code>levelChars</code> object that maps plan characters to either background grid types or actor classes.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_VxaicldIYi class=c_ident id=c_VxaicldIYi></a><p class=cm-keyword>const</p> <p class=cm-def>levelChars</p> <p class=cm-operator>=</p> { <p class=cm-string>\".\"</p>: <p class=cm-string>\"empty\"</p>, <p class=cm-string>\"#\"</p>: <p class=cm-string>\"wall\"</p>, <p class=cm-string>\"+\"</p>: <p class=cm-string>\"lava\"</p>, <p class=cm-string>\"@\"</p>: <p class=cm-variable>Player</p>, <p class=cm-string>\"o\"</p>: <p class=cm-variable>Coin</p>, <p class=cm-string>\"=\"</p>: <p class=cm-variable>Lava</p>, <p class=cm-string>\"|\"</p>: <p class=cm-variable>Lava</p>, <p class=cm-string>\"v\"</p>: <p class=cm-variable>Lava</p>\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_DkV+hEDKE5 class=p_ident id=p_DkV+hEDKE5></a>That gives us all the parts needed to create a <code>Level</code> instance.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_CDJvcZL+0x class=c_ident id=c_CDJvcZL+0x></a><p class=cm-keyword>let</p> <p class=cm-def>simpleLevel</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Level</p>(<p class=cm-variable>simpleLevelPlan</p>);\n<p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string-2>`${</p><p class=cm-variable>simpleLevel</p>.<p class=cm-property>width</p><p class=cm-string-2>}</p> <p class=cm-string-2>by ${</p><p class=cm-variable>simpleLevel</p>.<p class=cm-property>height</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>);\n</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_lCdOTin0mI class=p_ident id=p_lCdOTin0mI></a>The task ahead is to display such levels on the screen and to model time and motion inside them.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_uCRd57RG2L class=h_ident id=h_uCRd57RG2L></a>Encapsulation as a burden</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_M65QHGE4qM class=p_ident id=p_M65QHGE4qM></a>Most of the code in this chapter does not worry about encapsulation very much for two reasons. First, encapsulation takes extra effort. It makes programs bigger and requires additional concepts and interfaces to be introduced. Since there is only so much code you can throw at a reader before their eyes glaze over, I’ve made an effort to keep the program small.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_21KwkzRO2L class=p_ident id=p_21KwkzRO2L></a>Second, the various elements in this game are so closely tied together that if the behavior of one of them changed, it is unlikely that any of the others would be able to stay the same. Interfaces between the elements would end up encoding a lot of assumptions about the way the game works. This makes them a lot less effective—whenever you change one part of the system, you still have to worry about the way it impacts the other parts because their interfaces wouldn’t cover the new situation.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_0qau17Yus5 class=p_ident id=p_0qau17Yus5></a>Some <em>cutting points</em> in a system lend themselves well to separation through rigorous interfaces, but others don’t. Trying to encapsulate something that isn’t a suitable boundary is a sure way to waste a lot of energy. When you are making this mistake, you’ll usually notice that your interfaces are getting awkwardly large and detailed and that they need to be changed often, as the program evolves.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_zVT1v9P1c6 class=p_ident id=p_zVT1v9P1c6></a>There is one thing that we <em>will</em> encapsulate, and that is the drawing subsystem. The reason for this is that we’ll display the same game in a different way in the <a href=https://eloquentjavascript.net/17_canvas.html#canvasdisplay>next chapter</a>. By putting the drawing behind an interface, we can load the same game program there and plug in a new display module.</p> <h2 id=domdisplay><a href=https://eloquentjavascript.net/16_game.html#h_neNgUMdlHQ class=h_ident id=h_neNgUMdlHQ></a>Drawing</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_bjlUPfTgQP class=p_ident id=p_bjlUPfTgQP></a>The encapsulation of the drawing code is done by defining a <em>display</em> object, which displays a given level and state. The display type we define in this chapter is called <code>DOMDisplay</code> because it uses DOM elements to show the level.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_8XJ1fe7OPg class=p_ident id=p_8XJ1fe7OPg></a>We’ll be using a style sheet to set the actual colors and other fixed properties of the elements that make up the game. It would also be possible to directly assign to the elements’ <code>style</code> property when we create them, but that would produce more verbose programs.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_nm5ENHsGf9 class=p_ident id=p_nm5ENHsGf9></a>The following helper function provides a succinct way to create an element and give it some attributes and child nodes:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_IslrNCPEgI class=c_ident id=c_IslrNCPEgI></a><p class=cm-keyword>function</p> <p class=cm-def>elt</p>(<p class=cm-def>name</p>, <p class=cm-def>attrs</p>, <p class=cm-def>children</p>) { <p class=cm-keyword>let</p> <p class=cm-def>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-variable-2>name</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>attr</p> <p class=cm-keyword>of</p> <p class=cm-variable>Object</p>.<p class=cm-property>keys</p>(<p class=cm-variable-2>attrs</p>)) { <p class=cm-variable-2>dom</p>.<p class=cm-property>setAttribute</p>(<p class=cm-variable-2>attr</p>, <p class=cm-variable-2>attrs</p>[<p class=cm-variable-2>attr</p>]); } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>child</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>children</p>) { <p class=cm-variable-2>dom</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>child</p>); } <p class=cm-keyword>return</p> <p class=cm-variable-2>dom</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_Xjpq/reXQf class=p_ident id=p_Xjpq/reXQf></a>A display is created by giving it a parent element to which it should append itself and a level object.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_YPdTKEt761 class=c_ident id=c_YPdTKEt761></a><p class=cm-keyword>class</p> <p class=cm-def>DOMDisplay</p> { <p class=cm-property>constructor</p>(<p class=cm-def>parent</p>, <p class=cm-def>level</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"div\"</p>, {<p class=cm-property>class</p>: <p class=cm-string>\"game\"</p>}, <p class=cm-variable>drawGrid</p>(<p class=cm-variable-2>level</p>)); <p class=cm-keyword>this</p>.<p class=cm-property>actorLayer</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>; <p class=cm-variable-2>parent</p>.<p class=cm-property>appendChild</p>(<p class=cm-keyword>this</p>.<p class=cm-property>dom</p>); } <p class=cm-property>clear</p>() { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>remove</p>(); }\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_mbvJm4+nKS class=p_ident id=p_mbvJm4+nKS></a>The level’s background grid, which never changes, is drawn once. Actors are redrawn every time the display is updated with a given state. The <code>actorLayer</code> property will be used to track the element that holds the actors so that they can be easily removed and replaced.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_si3+n3Lijy class=p_ident id=p_si3+n3Lijy></a>Our coordinates and sizes are tracked in grid units, where a size or distance of 1 means one grid block. When setting pixel sizes, we will have to scale these coordinates up—everything in the game would be ridiculously small at a single pixel per square. The <code>scale</code> constant gives the number of pixels that a single unit takes up on the screen.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_LrmszCVXMZ class=c_ident id=c_LrmszCVXMZ></a><p class=cm-keyword>const</p> <p class=cm-def>scale</p> <p class=cm-operator>=</p> <p class=cm-number>20</p>; <p class=cm-keyword>function</p> <p class=cm-def>drawGrid</p>(<p class=cm-def>level</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"table\"</p>, { <p class=cm-property>class</p>: <p class=cm-string>\"background\"</p>, <p class=cm-property>style</p>: <p class=cm-string-2>`width: ${</p><p class=cm-variable-2>level</p>.<p class=cm-property>width</p> <p class=cm-operator>*</p> <p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p> }, <p class=cm-variable-2>level</p>.<p class=cm-property>rows</p>.<p class=cm-property>map</p>(<p class=cm-def>row</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"tr\"</p>, {<p class=cm-property>style</p>: <p class=cm-string-2>`height: ${</p><p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p>}, <p class=cm-variable-2>row</p>.<p class=cm-property>map</p>(<p class=cm-def>type</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"td\"</p>, {<p class=cm-property>class</p>: <p class=cm-variable-2>type</p>})))\n  ));\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_cGH93DulN/ class=p_ident id=p_cGH93DulN/ ></a>As mentioned, the background is drawn as a <code>&lt;table&gt;</code> element. This nicely corresponds to the structure of the <code>rows</code> property of the level—each row of the grid is turned into a table row (<code>&lt;tr&gt;</code> element). The strings in the grid are used as class names for the table cell (<code>&lt;td&gt;</code>) elements. The spread (triple dot) operator is used to pass arrays of child nodes to <code>elt</code> as separate arguments.</p> <p id=game_css><a href=https://eloquentjavascript.net/16_game.html#p_rtSatvHAOz class=p_ident id=p_rtSatvHAOz></a>The following CSS makes the table look like the background we want:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_wOP5LzF6Sp class=c_ident id=c_wOP5LzF6Sp></a><p class=cm-qualifier>.background</p> { <p class=cm-property>background</p>: <p class=cm-atom>rgb</p>(<p class=cm-number>52</p>, <p class=cm-number>166</p>, <p class=cm-number>251</p>); <p class=cm-property>table-layout</p>: <p class=cm-atom>fixed</p>; <p class=cm-property>border-spacing</p>: <p class=cm-number>0</p>; }\n<p class=cm-qualifier>.background</p> <p class=cm-tag>td</p> { <p class=cm-property>padding</p>: <p class=cm-number>0</p>; }\n<p class=cm-qualifier>.lava</p> { <p class=cm-property>background</p>: <p class=cm-atom>rgb</p>(<p class=cm-number>255</p>, <p class=cm-number>100</p>, <p class=cm-number>100</p>); }\n<p class=cm-qualifier>.wall</p> { <p class=cm-property>background</p>: <p class=cm-keyword>white</p>;              }</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_Fm4CLmRVL5 class=p_ident id=p_Fm4CLmRVL5></a>Some of these (<code>table-layout</code>, <code>border-spacing</code>, and <code>padding</code>) are used to suppress unwanted default behavior. We don’t want the layout of the table to depend upon the contents of its cells, and we don’t want space between the table cells or padding inside them.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_SjTsFY8eD3 class=p_ident id=p_SjTsFY8eD3></a>The <code>background</code> rule sets the background color. CSS allows colors to be specified both as words (<code>white</code>) or with a format such as <code>rgb(R, G, B)</code>, where the red, green, and blue components of the color are separated into three numbers from 0 to 255. So, in <code>rgb(52, 166, 251)</code>, the red component is 52, green is 166, and blue is 251. Since the blue component is the largest, the resulting color will be bluish. You can see that in the <code>.lava</code> rule, the first number (red) is the largest.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_EGE24ax3xh class=p_ident id=p_EGE24ax3xh></a>We draw each actor by creating a DOM element for it and setting that element’s position and size based on the actor’s properties. The values have to be multiplied by <code>scale</code> to go from game units to pixels.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_SJNWL3kOZh class=c_ident id=c_SJNWL3kOZh></a><p class=cm-keyword>function</p> <p class=cm-def>drawActors</p>(<p class=cm-def>actors</p>) { <p class=cm-keyword>return</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"div\"</p>, {}, <p class=cm-variable-2>actors</p>.<p class=cm-property>map</p>(<p class=cm-def>actor</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>rect</p> <p class=cm-operator>=</p> <p class=cm-variable>elt</p>(<p class=cm-string>\"div\"</p>, {<p class=cm-property>class</p>: <p class=cm-string-2>`actor ${</p><p class=cm-variable-2>actor</p>.<p class=cm-property>type</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>}); <p class=cm-variable-2>rect</p>.<p class=cm-property>style</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>actor</p>.<p class=cm-property>size</p>.<p class=cm-property>x</p> <p class=cm-operator>*</p> <p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p>; <p class=cm-variable-2>rect</p>.<p class=cm-property>style</p>.<p class=cm-property>height</p> <p class=cm-operator>=</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>actor</p>.<p class=cm-property>size</p>.<p class=cm-property>y</p> <p class=cm-operator>*</p> <p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p>; <p class=cm-variable-2>rect</p>.<p class=cm-property>style</p>.<p class=cm-property>left</p> <p class=cm-operator>=</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>actor</p>.<p class=cm-property>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>*</p> <p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p>; <p class=cm-variable-2>rect</p>.<p class=cm-property>style</p>.<p class=cm-property>top</p> <p class=cm-operator>=</p> <p class=cm-string-2>`${</p><p class=cm-variable-2>actor</p>.<p class=cm-property>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>*</p> <p class=cm-variable>scale</p><p class=cm-string-2>}</p><p class=cm-string-2>px`</p>; <p class=cm-keyword>return</p> <p class=cm-variable-2>rect</p>;\n  }));\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_mTuOphlRZ6 class=p_ident id=p_mTuOphlRZ6></a>To give an element more than one class, we separate the class names by spaces. In the CSS code shown next, the <code>actor</code> class gives the actors their absolute position. Their type name is used as an extra class to give them a color. We don’t have to define the <code>lava</code> class again because we’re reusing the class for the lava grid squares we defined earlier.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_ksr13Gc65g class=c_ident id=c_ksr13Gc65g></a><p class=cm-qualifier>.actor</p> { <p class=cm-property>position</p>: <p class=cm-atom>absolute</p>; }\n<p class=cm-qualifier>.coin</p> { <p class=cm-property>background</p>: <p class=cm-atom>rgb</p>(<p class=cm-number>241</p>, <p class=cm-number>229</p>, <p class=cm-number>89</p>); }\n<p class=cm-qualifier>.player</p> { <p class=cm-property>background</p>: <p class=cm-atom>rgb</p>(<p class=cm-number>64</p>, <p class=cm-number>64</p>, <p class=cm-number>64</p>);   }</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_4qUaGsKUgq class=p_ident id=p_4qUaGsKUgq></a>The <code>syncState</code> method is used to make the display show a given state. It first removes the old actor graphics, if any, and then redraws the actors in their new positions. It may be tempting to try to reuse the DOM elements for actors, but to make that work, we would need a lot of additional bookkeeping to associate actors with DOM elements and to make sure we remove elements when their actors vanish. Since there will typically be only a handful of actors in the game, redrawing all of them is not expensive.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_/bAFVECbGl class=c_ident id=c_/bAFVECbGl></a><p class=cm-variable>DOMDisplay</p>.<p class=cm-property>prototype</p>.<p class=cm-property>syncState</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>actorLayer</p>) <p class=cm-keyword>this</p>.<p class=cm-property>actorLayer</p>.<p class=cm-property>remove</p>(); <p class=cm-keyword>this</p>.<p class=cm-property>actorLayer</p> <p class=cm-operator>=</p> <p class=cm-variable>drawActors</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>actors</p>); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>appendChild</p>(<p class=cm-keyword>this</p>.<p class=cm-property>actorLayer</p>); <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>className</p> <p class=cm-operator>=</p> <p class=cm-string-2>`game ${</p><p class=cm-variable-2>state</p>.<p class=cm-property>status</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>; <p class=cm-keyword>this</p>.<p class=cm-property>scrollPlayerIntoView</p>(<p class=cm-variable-2>state</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_sZEoSNaFbo class=p_ident id=p_sZEoSNaFbo></a>By adding the level’s current status as a class name to the wrapper, we can style the player actor slightly differently when the game is won or lost by adding a CSS rule that takes effect only when the player has an ancestor element with a given class.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_6QpUiIcdtL class=c_ident id=c_6QpUiIcdtL></a><p class=cm-qualifier>.lost</p> <p class=cm-qualifier>.player</p> { <p class=cm-property>background</p>: <p class=cm-atom>rgb</p>(<p class=cm-number>160</p>, <p class=cm-number>64</p>, <p class=cm-number>64</p>);\n}\n<p class=cm-qualifier>.won</p> <p class=cm-qualifier>.player</p> { <p class=cm-property>box-shadow</p>: <p class=cm-number>-4px</p> <p class=cm-number>-7px</p> <p class=cm-number>8px</p> <p class=cm-keyword>white</p>, <p class=cm-number>4px</p> <p class=cm-number>-7px</p> <p class=cm-number>8px</p> <p class=cm-keyword>white</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_RiEBu6FHP5 class=p_ident id=p_RiEBu6FHP5></a>After touching lava, the player’s color turns dark red, suggesting scorching. When the last coin has been collected, we add two blurred white shadows—one to the top left and one to the top right—to create a white halo effect.</p> <p id=viewport><a href=https://eloquentjavascript.net/16_game.html#p_3Lai0THCj4 class=p_ident id=p_3Lai0THCj4></a>We can’t assume that the level always fits in the <em>viewport</em>—the element into which we draw the game. That is why the <code>scrollPlayerIntoView</code> call is needed. It ensures that if the level is protruding outside the viewport, we scroll that viewport to make sure the player is near its center. The following CSS gives the game’s wrapping DOM element a maximum size and ensures that anything that sticks out of the element’s box is not visible. We also give it a relative position so that the actors inside it are positioned relative to the level’s top-left corner.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_cxq+gtsZuW class=c_ident id=c_cxq+gtsZuW></a><p class=cm-qualifier>.game</p> { <p class=cm-property>overflow</p>: <p class=cm-atom>hidden</p>; <p class=cm-property>max-width</p>: <p class=cm-number>600px</p>; <p class=cm-property>max-height</p>: <p class=cm-number>450px</p>; <p class=cm-property>position</p>: <p class=cm-atom>relative</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_IgYwZuZ1Co class=p_ident id=p_IgYwZuZ1Co></a>In the <code>scrollPlayerIntoView</code> method, we find the player’s position and update the wrapping element’s scroll position. We change the scroll position by manipulating that element’s <code>scrollLeft</code> and <code>scrollTop</code> properties when the player is too close to the edge.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_Of96qEfT96 class=c_ident id=c_Of96qEfT96></a><p class=cm-variable>DOMDisplay</p>.<p class=cm-property>prototype</p>.<p class=cm-property>scrollPlayerIntoView</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>let</p> <p class=cm-def>width</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>clientWidth</p>; <p class=cm-keyword>let</p> <p class=cm-def>height</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>clientHeight</p>; <p class=cm-keyword>let</p> <p class=cm-def>margin</p> <p class=cm-operator>=</p> <p class=cm-variable-2>width</p> <p class=cm-operator>/</p> <p class=cm-number>3</p>; <p class=cm-keyword>let</p> <p class=cm-def>left</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollLeft</p>, <p class=cm-def>right</p> <p class=cm-operator>=</p> <p class=cm-variable-2>left</p> <p class=cm-operator>+</p> <p class=cm-variable-2>width</p>; <p class=cm-keyword>let</p> <p class=cm-def>top</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollTop</p>, <p class=cm-def>bottom</p> <p class=cm-operator>=</p> <p class=cm-variable-2>top</p> <p class=cm-operator>+</p> <p class=cm-variable-2>height</p>; <p class=cm-keyword>let</p> <p class=cm-def>player</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>player</p>; <p class=cm-keyword>let</p> <p class=cm-def>center</p> <p class=cm-operator>=</p> <p class=cm-variable-2>player</p>.<p class=cm-property>pos</p>.<p class=cm-property>plus</p>(<p class=cm-variable-2>player</p>.<p class=cm-property>size</p>.<p class=cm-property>times</p>(<p class=cm-number>0.5</p>)) .<p class=cm-property>times</p>(<p class=cm-variable>scale</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>center</p>.<p class=cm-property>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>left</p> <p class=cm-operator>+</p> <p class=cm-variable-2>margin</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollLeft</p> <p class=cm-operator>=</p> <p class=cm-variable-2>center</p>.<p class=cm-property>x</p> <p class=cm-operator>-</p> <p class=cm-variable-2>margin</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>center</p>.<p class=cm-property>x</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>right</p> <p class=cm-operator>-</p> <p class=cm-variable-2>margin</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollLeft</p> <p class=cm-operator>=</p> <p class=cm-variable-2>center</p>.<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>margin</p> <p class=cm-operator>-</p> <p class=cm-variable-2>width</p>; } <p class=cm-keyword>if</p> (<p class=cm-variable-2>center</p>.<p class=cm-property>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>top</p> <p class=cm-operator>+</p> <p class=cm-variable-2>margin</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollTop</p> <p class=cm-operator>=</p> <p class=cm-variable-2>center</p>.<p class=cm-property>y</p> <p class=cm-operator>-</p> <p class=cm-variable-2>margin</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>center</p>.<p class=cm-property>y</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>bottom</p> <p class=cm-operator>-</p> <p class=cm-variable-2>margin</p>) { <p class=cm-keyword>this</p>.<p class=cm-property>dom</p>.<p class=cm-property>scrollTop</p> <p class=cm-operator>=</p> <p class=cm-variable-2>center</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>margin</p> <p class=cm-operator>-</p> <p class=cm-variable-2>height</p>;\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_3qHzB4KoD+ class=p_ident id=p_3qHzB4KoD+></a>The way the player’s center is found shows how the methods on our <code>Vec</code> type allow computations with objects to be written in a relatively readable way. To find the actor’s center, we add its position (its top-left corner) and half its size. That is the center in level coordinates, but we need it in pixel coordinates, so we then multiply the resulting vector by our display scale.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_nyYhuiyn32 class=p_ident id=p_nyYhuiyn32></a>Next, a series of checks verifies that the player position isn’t outside of the allowed range. Note that sometimes this will set nonsense scroll coordinates that are below zero or beyond the element’s scrollable area. This is okay—the DOM will constrain them to acceptable values. Setting <code>scrollLeft</code> to -10 will cause it to become 0.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_MFibm1pU7d class=p_ident id=p_MFibm1pU7d></a>It would have been slightly simpler to always try to scroll the player to the center of the viewport. But this creates a rather jarring effect. As you are jumping, the view will constantly shift up and down. It is more pleasant to have a “neutral” area in the middle of the screen where you can move around without causing any scrolling.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_LSD2j1d23Y class=p_ident id=p_LSD2j1d23Y></a>We are now able to display our tiny level.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_LDPexlnWt1 class=c_ident id=c_LDPexlnWt1></a><p class=cm-tag>&lt;</p><p class=cm-tag>link</p> <p class=cm-attribute>rel</p>=<p class=cm-string>\"stylesheet\"</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"css/game.css\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>simpleLevel</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Level</p>(<p class=cm-variable>simpleLevelPlan</p>); <p class=cm-keyword>let</p> <p class=cm-def>display</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>DOMDisplay</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-variable>simpleLevel</p>); <p class=cm-variable>display</p>.<p class=cm-property>syncState</p>(<p class=cm-variable>State</p>.<p class=cm-property>start</p>(<p class=cm-variable>simpleLevel</p>));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_WeN+Ro9UkI class=p_ident id=p_WeN+Ro9UkI></a>The <code>&lt;link&gt;</code> tag, when used with <code>rel=\"stylesheet\"</code>, is a way to load a CSS file into a page. The file <code>game.css</code> contains the styles necessary for our game.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_zX4xC7JBQU class=h_ident id=h_zX4xC7JBQU></a>Motion and collision</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_Ans+nACOmo class=p_ident id=p_Ans+nACOmo></a>Now we’re at the point where we can start adding motion—the most interesting aspect of the game. The basic approach, taken by most games like this, is to split time into small steps and, for each step, move the actors by a distance corresponding to their speed multiplied by the size of the time step. We’ll measure time in seconds, so speeds are expressed in units per second.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_AMJvAGiWYs class=p_ident id=p_AMJvAGiWYs></a>Moving things is easy. The difficult part is dealing with the interactions between the elements. When the player hits a wall or floor, they should not simply move through it. The game must notice when a given motion causes an object to hit another object and respond accordingly. For walls, the motion must be stopped. When hitting a coin, it must be collected. When touching lava, the game should be lost.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_0knqUiUFMu class=p_ident id=p_0knqUiUFMu></a>Solving this for the general case is a big task. You can find libraries, usually called <em>physics engines</em>, that simulate interaction between physical objects in two or three dimensions. We’ll take a more modest approach in this chapter, handling only collisions between rectangular objects and handling them in a rather simplistic way.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_siPXpdT6C4 class=p_ident id=p_siPXpdT6C4></a>Before moving the player or a block of lava, we test whether the motion would take it inside of a wall. If it does, we simply cancel the motion altogether. The response to such a collision depends on the type of actor—the player will stop, whereas a lava block will bounce back.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_SnXtyooCGY class=p_ident id=p_SnXtyooCGY></a>This approach requires our time steps to be rather small since it will cause motion to stop before the objects actually touch. If the time steps (and thus the motion steps) are too big, the player would end up hovering a noticeable distance above the ground. Another approach, arguably better but more complicated, would be to find the exact collision spot and move there. We will take the simple approach and hide its problems by ensuring the animation proceeds in small steps.</p> <p id=touches><a href=https://eloquentjavascript.net/16_game.html#p_3qnJ7o6jgV class=p_ident id=p_3qnJ7o6jgV></a>This method tells us whether a rectangle (specified by a position and a size) touches a grid element of the given type.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_EY7I5wl4Zy class=c_ident id=c_EY7I5wl4Zy></a><p class=cm-variable>Level</p>.<p class=cm-property>prototype</p>.<p class=cm-property>touches</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>pos</p>, <p class=cm-def>size</p>, <p class=cm-def>type</p>) { <p class=cm-keyword>var</p> <p class=cm-def>xStart</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>x</p>); <p class=cm-keyword>var</p> <p class=cm-def>xEnd</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>ceil</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>size</p>.<p class=cm-property>x</p>); <p class=cm-keyword>var</p> <p class=cm-def>yStart</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>floor</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>y</p>); <p class=cm-keyword>var</p> <p class=cm-def>yEnd</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>ceil</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>size</p>.<p class=cm-property>y</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>var</p> <p class=cm-def>y</p> <p class=cm-operator>=</p> <p class=cm-variable-2>yStart</p>; <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>yEnd</p>; <p class=cm-variable-2>y</p><p class=cm-operator>++</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>var</p> <p class=cm-def>x</p> <p class=cm-operator>=</p> <p class=cm-variable-2>xStart</p>; <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>xEnd</p>; <p class=cm-variable-2>x</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> <p class=cm-def>isOutside</p> <p class=cm-operator>=</p> <p class=cm-variable-2>x</p> <p class=cm-operator>&lt;</p> <p class=cm-number>0</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable-2>x</p> <p class=cm-operator>&gt;=</p> <p class=cm-keyword>this</p>.<p class=cm-property>width</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable-2>y</p> <p class=cm-operator>&lt;</p> <p class=cm-number>0</p> <p class=cm-operator>|</p><p class=cm-operator>|</p> <p class=cm-variable-2>y</p> <p class=cm-operator>&gt;=</p> <p class=cm-keyword>this</p>.<p class=cm-property>height</p>; <p class=cm-keyword>let</p> <p class=cm-def>here</p> <p class=cm-operator>=</p> <p class=cm-variable-2>isOutside</p> <p class=cm-operator>?</p> <p class=cm-string>\"wall\"</p> : <p class=cm-keyword>this</p>.<p class=cm-property>rows</p>[<p class=cm-variable-2>y</p>][<p class=cm-variable-2>x</p>]; <p class=cm-keyword>if</p> (<p class=cm-variable-2>here</p> <p class=cm-operator>==</p> <p class=cm-variable-2>type</p>) <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } } <p class=cm-keyword>return</p> <p class=cm-atom>false</p>;\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_4FaUFI2Ppt class=p_ident id=p_4FaUFI2Ppt></a>The method computes the set of grid squares that the body overlaps with by using <code>Math.floor</code> and <code>Math.ceil</code> on its coordinates. Remember that grid squares are 1 by 1 units in size. By rounding the sides of a box up and down, we get the range of background squares that the box touches.</p><figure><img alt=\"Finding collisions on a grid\" src=https://eloquentjavascript.net/img/game-grid.svg></figure> <p><a href=https://eloquentjavascript.net/16_game.html#p_y0L2VEuDgy class=p_ident id=p_y0L2VEuDgy></a>We loop over the block of grid squares found by rounding the coordinates and return <code>true</code> when a matching square is found. Squares outside of the level are always treated as <code>\"wall\"</code> to ensure that the player can’t leave the world and that we won’t accidentally try to read outside of the bounds of our <code>rows</code> array.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_VPBaabj50T class=p_ident id=p_VPBaabj50T></a>The state <code>update</code> method uses <code>touches</code> to figure out whether the player is touching lava.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_af6Xo1AsIn class=c_ident id=c_af6Xo1AsIn></a><p class=cm-variable>State</p>.<p class=cm-property>prototype</p>.<p class=cm-property>update</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>time</p>, <p class=cm-def>keys</p>) { <p class=cm-keyword>let</p> <p class=cm-def>actors</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>actors</p> .<p class=cm-property>map</p>(<p class=cm-def>actor</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>actor</p>.<p class=cm-property>update</p>(<p class=cm-variable-2>time</p>, <p class=cm-keyword>this</p>, <p class=cm-variable-2>keys</p>)); <p class=cm-keyword>let</p> <p class=cm-def>newState</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>State</p>(<p class=cm-keyword>this</p>.<p class=cm-property>level</p>, <p class=cm-variable-2>actors</p>, <p class=cm-keyword>this</p>.<p class=cm-property>status</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>newState</p>.<p class=cm-property>status</p> <p class=cm-operator>!=</p> <p class=cm-string>\"playing\"</p>) <p class=cm-keyword>return</p> <p class=cm-variable-2>newState</p>; <p class=cm-keyword>let</p> <p class=cm-def>player</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newState</p>.<p class=cm-property>player</p>; <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>level</p>.<p class=cm-property>touches</p>(<p class=cm-variable-2>player</p>.<p class=cm-property>pos</p>, <p class=cm-variable-2>player</p>.<p class=cm-property>size</p>, <p class=cm-string>\"lava\"</p>)) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>State</p>(<p class=cm-keyword>this</p>.<p class=cm-property>level</p>, <p class=cm-variable-2>actors</p>, <p class=cm-string>\"lost\"</p>); } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>actor</p> <p class=cm-keyword>of</p> <p class=cm-variable-2>actors</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>actor</p> <p class=cm-operator>!=</p> <p class=cm-variable-2>player</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable>overlap</p>(<p class=cm-variable-2>actor</p>, <p class=cm-variable-2>player</p>)) { <p class=cm-variable-2>newState</p> <p class=cm-operator>=</p> <p class=cm-variable-2>actor</p>.<p class=cm-property>collide</p>(<p class=cm-variable-2>newState</p>); } } <p class=cm-keyword>return</p> <p class=cm-variable-2>newState</p>;\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_i/qab4417U class=p_ident id=p_i/qab4417U></a>The method is passed a time step and a data structure that tells it which keys are being held down. The first thing it does is call the <code>update</code> method on all actors, producing an array of updated actors. The actors also get the time step, the keys, and the state, so that they can base their update on those. Only the player will actually read keys, since that’s the only actor that’s controlled by the keyboard.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_CTpNIbtVGd class=p_ident id=p_CTpNIbtVGd></a>If the game is already over, no further processing has to be done (the game can’t be won after being lost, or vice versa). Otherwise, the method tests whether the player is touching background lava. If so, the game is lost, and we’re done. Finally, if the game really is still going on, it sees whether any other actors overlap the player.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_JshvA9JB7k class=p_ident id=p_JshvA9JB7k></a>Overlap between actors is detected with the <code>overlap</code> function. It takes two actor objects and returns true when they touch—which is the case when they overlap both along the x-axis and along the y-axis.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_Z19icVgfA7 class=c_ident id=c_Z19icVgfA7></a><p class=cm-keyword>function</p> <p class=cm-def>overlap</p>(<p class=cm-def>actor1</p>, <p class=cm-def>actor2</p>) { <p class=cm-keyword>return</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>size</p>.<p class=cm-property>x</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>pos</p>.<p class=cm-property>x</p> <p class=cm-operator>+</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>size</p>.<p class=cm-property>x</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>size</p>.<p class=cm-property>y</p> <p class=cm-operator>&gt;</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>actor1</p>.<p class=cm-property>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>pos</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>actor2</p>.<p class=cm-property>size</p>.<p class=cm-property>y</p>;\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_EMdttGHwtg class=p_ident id=p_EMdttGHwtg></a>If any actor does overlap, its <code>collide</code> method gets a chance to update the state. Touching a lava actor sets the game status to <code>\"lost\"</code>. Coins vanish when you touch them and set the status to <code>\"won\"</code> when they are the last coin of the level.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_jNqQLSOJRn class=c_ident id=c_jNqQLSOJRn></a><p class=cm-variable>Lava</p>.<p class=cm-property>prototype</p>.<p class=cm-property>collide</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>State</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>level</p>, <p class=cm-variable-2>state</p>.<p class=cm-property>actors</p>, <p class=cm-string>\"lost\"</p>);\n}; <p class=cm-variable>Coin</p>.<p class=cm-property>prototype</p>.<p class=cm-property>collide</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>state</p>) { <p class=cm-keyword>let</p> <p class=cm-def>filtered</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>actors</p>.<p class=cm-property>filter</p>(<p class=cm-def>a</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p> <p class=cm-operator>!=</p> <p class=cm-keyword>this</p>); <p class=cm-keyword>let</p> <p class=cm-def>status</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>status</p>; <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>filtered</p>.<p class=cm-property>some</p>(<p class=cm-def>a</p> <p class=cm-operator>=&gt;</p> <p class=cm-variable-2>a</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"coin\"</p>)) <p class=cm-variable-2>status</p> <p class=cm-operator>=</p> <p class=cm-string>\"won\"</p>; <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>State</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>level</p>, <p class=cm-variable-2>filtered</p>, <p class=cm-variable-2>status</p>);\n};</pre> <h2 id=actors><a href=https://eloquentjavascript.net/16_game.html#h_GaxRpVIsuF class=h_ident id=h_GaxRpVIsuF></a>Actor updates</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_fbEQ61HTVq class=p_ident id=p_fbEQ61HTVq></a>Actor objects’ <code>update</code> methods take as arguments the time step, the state object, and a <code>keys</code> object. The one for the <code>Lava</code> actor type ignores the <code>keys</code> object.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_vuIaAGYDTl class=c_ident id=c_vuIaAGYDTl></a><p class=cm-variable>Lava</p>.<p class=cm-property>prototype</p>.<p class=cm-property>update</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>time</p>, <p class=cm-def>state</p>) { <p class=cm-keyword>let</p> <p class=cm-def>newPos</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>this</p>.<p class=cm-property>speed</p>.<p class=cm-property>times</p>(<p class=cm-variable-2>time</p>)); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>state</p>.<p class=cm-property>level</p>.<p class=cm-property>touches</p>(<p class=cm-variable-2>newPos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>size</p>, <p class=cm-string>\"wall\"</p>)) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-variable-2>newPos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>speed</p>, <p class=cm-keyword>this</p>.<p class=cm-property>reset</p>); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-keyword>this</p>.<p class=cm-property>reset</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-keyword>this</p>.<p class=cm-property>reset</p>, <p class=cm-keyword>this</p>.<p class=cm-property>speed</p>, <p class=cm-keyword>this</p>.<p class=cm-property>reset</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Lava</p>(<p class=cm-keyword>this</p>.<p class=cm-property>pos</p>, <p class=cm-keyword>this</p>.<p class=cm-property>speed</p>.<p class=cm-property>times</p>(<p class=cm-operator>-</p><p class=cm-number>1</p>));\n  }\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_NnAl39AH58 class=p_ident id=p_NnAl39AH58></a>This <code>update</code> method computes a new position by adding the product of the time step and the current speed to its old position. If no obstacle blocks that new position, it moves there. If there is an obstacle, the behavior depends on the type of the lava block—dripping lava has a <code>reset</code> position, to which it jumps back when it hits something. Bouncing lava inverts its speed by multiplying it by -1 so that it starts moving in the opposite direction.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_AsHqJXqhZP class=p_ident id=p_AsHqJXqhZP></a>Coins use their <code>update</code> method to wobble. They ignore collisions with the grid since they are simply wobbling around inside of their own square.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_+DC3G3xD19 class=c_ident id=c_+DC3G3xD19></a><p class=cm-keyword>const</p> <p class=cm-def>wobbleSpeed</p> <p class=cm-operator>=</p> <p class=cm-number>8</p>, <p class=cm-def>wobbleDist</p> <p class=cm-operator>=</p> <p class=cm-number>0.07</p>; <p class=cm-variable>Coin</p>.<p class=cm-property>prototype</p>.<p class=cm-property>update</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>time</p>) { <p class=cm-keyword>let</p> <p class=cm-def>wobble</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>wobble</p> <p class=cm-operator>+</p> <p class=cm-variable-2>time</p> <p class=cm-operator>*</p> <p class=cm-variable>wobbleSpeed</p>; <p class=cm-keyword>let</p> <p class=cm-def>wobblePos</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>sin</p>(<p class=cm-variable-2>wobble</p>) <p class=cm-operator>*</p> <p class=cm-variable>wobbleDist</p>; <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Coin</p>(<p class=cm-keyword>this</p>.<p class=cm-property>basePos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>wobblePos</p>)), <p class=cm-keyword>this</p>.<p class=cm-property>basePos</p>, <p class=cm-variable-2>wobble</p>);\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_SYkdq1IZii class=p_ident id=p_SYkdq1IZii></a>The <code>wobble</code> property is incremented to track time and then used as an argument to <code>Math.sin</code> to find the new position on the wave. The coin’s current position is then computed from its base position and an offset based on this wave.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_SuUDJCzjex class=p_ident id=p_SuUDJCzjex></a>That leaves the player itself. Player motion is handled separately per axis because hitting the floor should not prevent horizontal motion, and hitting a wall should not stop falling or jumping motion.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_cBJRAPnr2+ class=c_ident id=c_cBJRAPnr2+></a><p class=cm-keyword>const</p> <p class=cm-def>playerXSpeed</p> <p class=cm-operator>=</p> <p class=cm-number>7</p>;\n<p class=cm-keyword>const</p> <p class=cm-def>gravity</p> <p class=cm-operator>=</p> <p class=cm-number>30</p>;\n<p class=cm-keyword>const</p> <p class=cm-def>jumpSpeed</p> <p class=cm-operator>=</p> <p class=cm-number>17</p>; <p class=cm-variable>Player</p>.<p class=cm-property>prototype</p>.<p class=cm-property>update</p> <p class=cm-operator>=</p> <p class=cm-keyword>function</p>(<p class=cm-def>time</p>, <p class=cm-def>state</p>, <p class=cm-def>keys</p>) { <p class=cm-keyword>let</p> <p class=cm-def>xSpeed</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>keys</p>.<p class=cm-property>ArrowLeft</p>) <p class=cm-variable-2>xSpeed</p> <p class=cm-operator>-=</p> <p class=cm-variable>playerXSpeed</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>keys</p>.<p class=cm-property>ArrowRight</p>) <p class=cm-variable-2>xSpeed</p> <p class=cm-operator>+=</p> <p class=cm-variable>playerXSpeed</p>; <p class=cm-keyword>let</p> <p class=cm-def>pos</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>pos</p>; <p class=cm-keyword>let</p> <p class=cm-def>movedX</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-variable-2>xSpeed</p> <p class=cm-operator>*</p> <p class=cm-variable-2>time</p>, <p class=cm-number>0</p>)); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>state</p>.<p class=cm-property>level</p>.<p class=cm-property>touches</p>(<p class=cm-variable-2>movedX</p>, <p class=cm-keyword>this</p>.<p class=cm-property>size</p>, <p class=cm-string>\"wall\"</p>)) { <p class=cm-variable-2>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>movedX</p>; } <p class=cm-keyword>let</p> <p class=cm-def>ySpeed</p> <p class=cm-operator>=</p> <p class=cm-keyword>this</p>.<p class=cm-property>speed</p>.<p class=cm-property>y</p> <p class=cm-operator>+</p> <p class=cm-variable-2>time</p> <p class=cm-operator>*</p> <p class=cm-variable>gravity</p>; <p class=cm-keyword>let</p> <p class=cm-def>movedY</p> <p class=cm-operator>=</p> <p class=cm-variable-2>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-variable-2>ySpeed</p> <p class=cm-operator>*</p> <p class=cm-variable-2>time</p>)); <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable-2>state</p>.<p class=cm-property>level</p>.<p class=cm-property>touches</p>(<p class=cm-variable-2>movedY</p>, <p class=cm-keyword>this</p>.<p class=cm-property>size</p>, <p class=cm-string>\"wall\"</p>)) { <p class=cm-variable-2>pos</p> <p class=cm-operator>=</p> <p class=cm-variable-2>movedY</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>keys</p>.<p class=cm-property>ArrowUp</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>ySpeed</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>ySpeed</p> <p class=cm-operator>=</p> <p class=cm-operator>-</p><p class=cm-variable>jumpSpeed</p>; } <p class=cm-keyword>else</p> { <p class=cm-variable-2>ySpeed</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; } <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Player</p>(<p class=cm-variable-2>pos</p>, <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-variable-2>xSpeed</p>, <p class=cm-variable-2>ySpeed</p>));\n};</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_rmP4WNaYTL class=p_ident id=p_rmP4WNaYTL></a>The horizontal motion is computed based on the state of the left and right arrow keys. When there’s no wall blocking the new position created by this motion, it is used. Otherwise, the old position is kept.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_BP0T8XR1kg class=p_ident id=p_BP0T8XR1kg></a>Vertical motion works in a similar way but has to simulate jumping and gravity. The player’s vertical speed (<code>ySpeed</code>) is first accelerated to account for gravity.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_3H8Calt+MC class=p_ident id=p_3H8Calt+MC></a>We check for walls again. If we don’t hit any, the new position is used. If there <em>is</em> a wall, there are two possible outcomes. When the up arrow is pressed <em>and</em> we are moving down (meaning the thing we hit is below us), the speed is set to a relatively large, negative value. This causes the player to jump. If that is not the case, the player simply bumped into something, and the speed is set to zero.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_HeVD7be3z6 class=p_ident id=p_HeVD7be3z6></a>The gravity strength, jumping speed, and pretty much all other constants in this game have been set by trial and error. I tested values until I found a combination I liked.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_zKch6Si/SS class=h_ident id=h_zKch6Si/SS></a>Tracking keys</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_NBxmiqrPk8 class=p_ident id=p_NBxmiqrPk8></a>For a game like this, we do not want keys to take effect once per keypress. Rather, we want their effect (moving the player figure) to stay active as long as they are held.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_AHo2Emv/R2 class=p_ident id=p_AHo2Emv/R2></a>We need to set up a key handler that stores the current state of the left, right, and up arrow keys. We will also want to call <code>preventDefault</code> for those keys so that they don’t end up scrolling the page.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_oH4kiTyM1E class=p_ident id=p_oH4kiTyM1E></a>The following function, when given an array of key names, will return an object that tracks the current position of those keys. It registers event handlers for <code>\"keydown\"</code> and <code>\"keyup\"</code> events and, when the key code in the event is present in the set of codes that it is tracking, updates the object.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_HHYPd26+il class=c_ident id=c_HHYPd26+il></a><p class=cm-keyword>function</p> <p class=cm-def>trackKeys</p>(<p class=cm-def>keys</p>) { <p class=cm-keyword>let</p> <p class=cm-def>down</p> <p class=cm-operator>=</p> <p class=cm-variable>Object</p>.<p class=cm-property>create</p>(<p class=cm-atom>null</p>); <p class=cm-keyword>function</p> <p class=cm-def>track</p>(<p class=cm-def>event</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>keys</p>.<p class=cm-property>includes</p>(<p class=cm-variable-2>event</p>.<p class=cm-property>key</p>)) { <p class=cm-variable-2>down</p>[<p class=cm-variable-2>event</p>.<p class=cm-property>key</p>] <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>type</p> <p class=cm-operator>==</p> <p class=cm-string>\"keydown\"</p>; <p class=cm-variable-2>event</p>.<p class=cm-property>preventDefault</p>(); } } <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keydown\"</p>, <p class=cm-variable-2>track</p>); <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keyup\"</p>, <p class=cm-variable-2>track</p>); <p class=cm-keyword>return</p> <p class=cm-variable-2>down</p>;\n} <p class=cm-keyword>const</p> <p class=cm-def>arrowKeys</p> <p class=cm-operator>=</p> <p class=cm-variable>trackKeys</p>([<p class=cm-string>\"ArrowLeft\"</p>, <p class=cm-string>\"ArrowRight\"</p>, <p class=cm-string>\"ArrowUp\"</p>]);</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_/Gh0/QdYTL class=p_ident id=p_/Gh0/QdYTL></a>The same handler function is used for both event types. It looks at the event object’s <code>type</code> property to determine whether the key state should be updated to true (<code>\"keydown\"</code>) or false (<code>\"keyup\"</code>).</p> <h2 id=runAnimation><a href=https://eloquentjavascript.net/16_game.html#h_/jwYTlYjAy class=h_ident id=h_/jwYTlYjAy></a>Running the game</h2> <p><a href=https://eloquentjavascript.net/16_game.html#p_h0hF0+vYTt class=p_ident id=p_h0hF0+vYTt></a>The <code>requestAnimationFrame</code> function, which we saw in <a href=https://eloquentjavascript.net/14_dom.html#animationFrame>Chapter 14</a>, provides a good way to animate a game. But its interface is quite primitive—using it requires us to track the time at which our function was called the last time around and call <code>requestAnimationFrame</code> again after every frame.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_YcIf88ICqS class=p_ident id=p_YcIf88ICqS></a>Let’s define a helper function that wraps those boring parts in a convenient interface and allows us to simply call <code>runAnimation</code>, giving it a function that expects a time difference as an argument and draws a single frame. When the frame function returns the value <code>false</code>, the animation stops.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_AVT0noPnDW class=c_ident id=c_AVT0noPnDW></a><p class=cm-keyword>function</p> <p class=cm-def>runAnimation</p>(<p class=cm-def>frameFunc</p>) { <p class=cm-keyword>let</p> <p class=cm-def>lastTime</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>; <p class=cm-keyword>function</p> <p class=cm-def>frame</p>(<p class=cm-def>time</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>lastTime</p> <p class=cm-operator>!=</p> <p class=cm-atom>null</p>) { <p class=cm-keyword>let</p> <p class=cm-def>timeStep</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>min</p>(<p class=cm-variable-2>time</p> <p class=cm-operator>-</p> <p class=cm-variable-2>lastTime</p>, <p class=cm-number>100</p>) <p class=cm-operator>/</p> <p class=cm-number>1000</p>; <p class=cm-keyword>if</p> (<p class=cm-variable-2>frameFunc</p>(<p class=cm-variable-2>timeStep</p>) <p class=cm-operator>===</p> <p class=cm-atom>false</p>) <p class=cm-keyword>return</p>; } <p class=cm-variable-2>lastTime</p> <p class=cm-operator>=</p> <p class=cm-variable-2>time</p>; <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-variable-2>frame</p>); } <p class=cm-variable>requestAnimationFrame</p>(<p class=cm-variable-2>frame</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_2lfHQQNum5 class=p_ident id=p_2lfHQQNum5></a>I have set a maximum frame step of 100 milliseconds (one-tenth of a second). When the browser tab or window with our page is hidden, <code>requestAnimationFrame</code> calls will be suspended until the tab or window is shown again. In this case, the difference between <code>lastTime</code> and <code>time</code> will be the entire time in which the page was hidden. Advancing the game by that much in a single step would look silly and might cause weird side effects, such as the player falling through the floor.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_jKakPLUmwL class=p_ident id=p_jKakPLUmwL></a>The function also converts the time steps to seconds, which are an easier quantity to think about than milliseconds.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_kwKnkc4FM+ class=p_ident id=p_kwKnkc4FM+></a>The <code>runLevel</code> function takes a <code>Level</code> object and a display constructor and returns a promise. It displays the level (in <code>document.body</code>) and lets the user play through it. When the level is finished (lost or won), <code>runLevel</code> waits one more second (to let the user see what happens) and then clears the display, stops the animation, and resolves the promise to the game’s end status.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_HTrHnVaIWA class=c_ident id=c_HTrHnVaIWA></a><p class=cm-keyword>function</p> <p class=cm-def>runLevel</p>(<p class=cm-def>level</p>, <p class=cm-def>Display</p>) { <p class=cm-keyword>let</p> <p class=cm-def>display</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable-2>Display</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-variable-2>level</p>); <p class=cm-keyword>let</p> <p class=cm-def>state</p> <p class=cm-operator>=</p> <p class=cm-variable>State</p>.<p class=cm-property>start</p>(<p class=cm-variable-2>level</p>); <p class=cm-keyword>let</p> <p class=cm-def>ending</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>; <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>(<p class=cm-def>resolve</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>runAnimation</p>(<p class=cm-def>time</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>update</p>(<p class=cm-variable-2>time</p>, <p class=cm-variable>arrowKeys</p>); <p class=cm-variable-2>display</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>state</p>.<p class=cm-property>status</p> <p class=cm-operator>==</p> <p class=cm-string>\"playing\"</p>) { <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>ending</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>ending</p> <p class=cm-operator>-=</p> <p class=cm-variable-2>time</p>; <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } <p class=cm-keyword>else</p> { <p class=cm-variable-2>display</p>.<p class=cm-property>clear</p>(); <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>status</p>); <p class=cm-keyword>return</p> <p class=cm-atom>false</p>;\n      }\n    });\n  });\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_eyKzVe0sIB class=p_ident id=p_eyKzVe0sIB></a>A game is a sequence of levels. Whenever the player dies, the current level is restarted. When a level is completed, we move on to the next level. This can be expressed by the following function, which takes an array of level plans (strings) and a display constructor:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_SyT3weqmk4 class=c_ident id=c_SyT3weqmk4></a><p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>runGame</p>(<p class=cm-def>plans</p>, <p class=cm-def>Display</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>level</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>level</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>plans</p>.<p class=cm-property>length</p>;) { <p class=cm-keyword>let</p> <p class=cm-def>status</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>runLevel</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Level</p>(<p class=cm-variable-2>plans</p>[<p class=cm-variable-2>level</p>]), <p class=cm-variable-2>Display</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>status</p> <p class=cm-operator>==</p> <p class=cm-string>\"won\"</p>) <p class=cm-variable-2>level</p><p class=cm-operator>++</p>; } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You've won!\"</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_ibGanBtTKe class=p_ident id=p_ibGanBtTKe></a>Because we made <code>runLevel</code> return a promise, <code>runGame</code> can be written using an <code>async</code> function, as shown in <a href=https://eloquentjavascript.net/11_async.html>Chapter 11</a>. It returns another promise, which resolves when the player finishes the game.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_/6dLhjN2fB class=p_ident id=p_/6dLhjN2fB></a>There is a set of level plans available in the <code>GAME_LEVELS</code> binding in <a href=https://eloquentjavascript.net/code#16>this chapter’s sandbox</a>. This page feeds them to <code>runGame</code>, starting an actual game.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_ftVm34P6My class=c_ident id=c_ftVm34P6My></a><p class=cm-tag>&lt;</p><p class=cm-tag>link</p> <p class=cm-attribute>rel</p>=<p class=cm-string>\"stylesheet\"</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"css/game.css\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>runGame</p>(<p class=cm-variable>GAME_LEVELS</p>, <p class=cm-variable>DOMDisplay</p>); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/16_game.html#p_MkrZ67rFcA class=p_ident id=p_MkrZ67rFcA></a>See if you can beat those. I had quite a lot of fun building them.</p> <h2><a href=https://eloquentjavascript.net/16_game.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/16_game.html#i_tFsh86eaJC class=i_ident id=i_tFsh86eaJC></a>Game over</h3> <p><a href=https://eloquentjavascript.net/16_game.html#p_Qg9LKDI5Td class=p_ident id=p_Qg9LKDI5Td></a>It’s traditional for platform games to have the player start with a limited number of <em>lives</em> and subtract one life each time they die. When the player is out of lives, the game restarts from the beginning.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_cg64RJFkZh class=p_ident id=p_cg64RJFkZh></a>Adjust <code>runGame</code> to implement lives. Have the player start with three. Output the current number of lives (using <code>console.log</code>) every time a level starts.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_/XVg6hHOl5 class=c_ident id=c_/XVg6hHOl5></a><p class=cm-tag>&lt;</p><p class=cm-tag>link</p> <p class=cm-attribute>rel</p>=<p class=cm-string>\"stylesheet\"</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"css/game.css\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>async</p> <p class=cm-keyword>function</p> <p class=cm-def>runGame</p>(<p class=cm-def>plans</p>, <p class=cm-def>Display</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>level</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>level</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>plans</p>.<p class=cm-property>length</p>;) { <p class=cm-keyword>let</p> <p class=cm-def>status</p> <p class=cm-operator>=</p> <p class=cm-keyword>await</p> <p class=cm-variable>runLevel</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Level</p>(<p class=cm-variable-2>plans</p>[<p class=cm-variable-2>level</p>]), <p class=cm-variable-2>Display</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>status</p> <p class=cm-operator>==</p> <p class=cm-string>\"won\"</p>) <p class=cm-variable-2>level</p><p class=cm-operator>++</p>; } <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You've won!\"</p>); } <p class=cm-variable>runGame</p>(<p class=cm-variable>GAME_LEVELS</p>, <p class=cm-variable>DOMDisplay</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p></pre> <h3><a href=https://eloquentjavascript.net/16_game.html#i_cNfzuXtVqI class=i_ident id=i_cNfzuXtVqI></a>Pausing the game</h3> <p><a href=https://eloquentjavascript.net/16_game.html#p_a/Q1DcuFrC class=p_ident id=p_a/Q1DcuFrC></a>Make it possible to pause (suspend) and unpause the game by pressing the Esc key.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_FpramcVlTZ class=p_ident id=p_FpramcVlTZ></a>This can be done by changing the <code>runLevel</code> function to use another keyboard event handler and interrupting or resuming the animation whenever the Esc key is hit.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_QBqhApUa2T class=p_ident id=p_QBqhApUa2T></a>The <code>runAnimation</code> interface may not look like it is suitable for this at first glance, but it is if you rearrange the way <code>runLevel</code> calls it.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_WJUxvtDgig class=p_ident id=p_WJUxvtDgig></a>When you have that working, there is something else you could try. The way we have been registering keyboard event handlers is somewhat problematic. The <code>arrowKeys</code> object is currently a global binding, and its event handlers are kept around even when no game is running. You could say they <em>leak</em> out of our system. Extend <code>trackKeys</code> to provide a way to unregister its handlers and then change <code>runLevel</code> to register its handlers when it starts and unregister them again when it is finished.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_ybbf+T2p9b class=c_ident id=c_ybbf+T2p9b></a><p class=cm-tag>&lt;</p><p class=cm-tag>link</p> <p class=cm-attribute>rel</p>=<p class=cm-string>\"stylesheet\"</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"css/game.css\"</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>runLevel</p>(<p class=cm-def>level</p>, <p class=cm-def>Display</p>) { <p class=cm-keyword>let</p> <p class=cm-def>display</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable-2>Display</p>(<p class=cm-variable>document</p>.<p class=cm-property>body</p>, <p class=cm-variable-2>level</p>); <p class=cm-keyword>let</p> <p class=cm-def>state</p> <p class=cm-operator>=</p> <p class=cm-variable>State</p>.<p class=cm-property>start</p>(<p class=cm-variable-2>level</p>); <p class=cm-keyword>let</p> <p class=cm-def>ending</p> <p class=cm-operator>=</p> <p class=cm-number>1</p>; <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Promise</p>(<p class=cm-def>resolve</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>runAnimation</p>(<p class=cm-def>time</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable-2>state</p> <p class=cm-operator>=</p> <p class=cm-variable-2>state</p>.<p class=cm-property>update</p>(<p class=cm-variable-2>time</p>, <p class=cm-variable>arrowKeys</p>); <p class=cm-variable-2>display</p>.<p class=cm-property>syncState</p>(<p class=cm-variable-2>state</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>state</p>.<p class=cm-property>status</p> <p class=cm-operator>==</p> <p class=cm-string>\"playing\"</p>) { <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>ending</p> <p class=cm-operator>&gt;</p> <p class=cm-number>0</p>) { <p class=cm-variable-2>ending</p> <p class=cm-operator>-=</p> <p class=cm-variable-2>time</p>; <p class=cm-keyword>return</p> <p class=cm-atom>true</p>; } <p class=cm-keyword>else</p> { <p class=cm-variable-2>display</p>.<p class=cm-property>clear</p>(); <p class=cm-variable-2>resolve</p>(<p class=cm-variable-2>state</p>.<p class=cm-property>status</p>); <p class=cm-keyword>return</p> <p class=cm-atom>false</p>; } }); }); } <p class=cm-variable>runGame</p>(<p class=cm-variable>GAME_LEVELS</p>, <p class=cm-variable>DOMDisplay</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/16_game.html#p_dyqugB1j6F class=p_ident id=p_dyqugB1j6F></a>An animation can be interrupted by returning <code>false</code> from the function given to <code>runAnimation</code>. It can be continued by calling <code>runAnimation</code> again.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_ymajy5Ud0Z class=p_ident id=p_ymajy5Ud0Z></a>So we need to communicate the fact that we are pausing the game to the function given to <code>runAnimation</code>. For that, you can use a binding that both the event handler and that function have access to.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_adK1uPfN73 class=p_ident id=p_adK1uPfN73></a>When finding a way to unregister the handlers registered by <code>trackKeys</code>, remember that the <em>exact</em> same function value that was passed to <code>addEventListener</code> must be passed to <code>removeEventListener</code> to successfully remove a handler. Thus, the <code>handler</code> function value created in <code>trackKeys</code> must be available to the code that unregisters the handlers.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_n0zT7gRNWv class=p_ident id=p_n0zT7gRNWv></a>You can add a property to the object returned by <code>trackKeys</code>, containing either that function value or a method that handles the unregistering directly.</p> </div></div> <h3><a href=https://eloquentjavascript.net/16_game.html#i_tKK8cGG5os class=i_ident id=i_tKK8cGG5os></a>A monster</h3> <p><a href=https://eloquentjavascript.net/16_game.html#p_RtEFEXlrkS class=p_ident id=p_RtEFEXlrkS></a>It is traditional for platform games to have enemies that you can jump on top of to defeat. This exercise asks you to add such an actor type to the game.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_Mhy2ENHlzV class=p_ident id=p_Mhy2ENHlzV></a>We’ll call it a monster. Monsters move only horizontally. You can make them move in the direction of the player, bounce back and forth like horizontal lava, or have any movement pattern you want. The class doesn’t have to handle falling, but it should make sure the monster doesn’t walk through walls.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_kN0Yd5LQRq class=p_ident id=p_kN0Yd5LQRq></a>When a monster touches the player, the effect depends on whether the player is jumping on top of them or not. You can approximate this by checking whether the player’s bottom is near the monster’s top. If this is the case, the monster disappears. If not, the game is lost.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/16_game.html#c_rthUoERAau class=c_ident id=c_rthUoERAau></a><p class=cm-tag>&lt;</p><p class=cm-tag>link</p> <p class=cm-attribute>rel</p>=<p class=cm-string>\"stylesheet\"</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"css/game.css\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p><p class=cm-qualifier>.monster</p> { <p class=cm-property>background</p>: <p class=cm-keyword>purple</p> }<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>class</p> <p class=cm-def>Monster</p> { <p class=cm-property>constructor</p>(<p class=cm-def>pos</p>, ) {} <p class=cm-keyword>get</p> <p class=cm-property>type</p>() { <p class=cm-keyword>return</p> <p class=cm-string>\"monster\"</p>; } <p class=cm-keyword>static</p> <p class=cm-property>create</p>(<p class=cm-def>pos</p>) { <p class=cm-keyword>return</p> <p class=cm-keyword>new</p> <p class=cm-variable>Monster</p>(<p class=cm-variable-2>pos</p>.<p class=cm-property>plus</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>0</p>, <p class=cm-operator>-</p><p class=cm-number>1</p>))); } <p class=cm-property>update</p>(<p class=cm-def>time</p>, <p class=cm-def>state</p>) {} <p class=cm-property>collide</p>(<p class=cm-def>state</p>) {} } <p class=cm-variable>Monster</p>.<p class=cm-property>prototype</p>.<p class=cm-property>size</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Vec</p>(<p class=cm-number>1.2</p>, <p class=cm-number>2</p>); <p class=cm-variable>levelChars</p>[<p class=cm-string>\"M\"</p>] <p class=cm-operator>=</p> <p class=cm-variable>Monster</p>; <p class=cm-variable>runLevel</p>(<p class=cm-keyword>new</p> <p class=cm-variable>Level</p>(<p class=cm-string-2>`</p>\n<p class=cm-string-2>..................................</p>\n<p class=cm-string-2>.################################.</p>\n<p class=cm-string-2>.#..............................#.</p>\n<p class=cm-string-2>.#..............................#.</p>\n<p class=cm-string-2>.#..............................#.</p>\n<p class=cm-string-2>.#...........................o..#.</p>\n<p class=cm-string-2>.#..@...........................#.</p>\n<p class=cm-string-2>.##########..............########.</p>\n<p class=cm-string-2>..........#..o..o..o..o..#........</p>\n<p class=cm-string-2>..........#...........M..#........</p>\n<p class=cm-string-2>..........################........</p>\n<p class=cm-string-2>..................................</p>\n<p class=cm-string-2>`</p>), <p class=cm-variable>DOMDisplay</p>); <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>body</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/16_game.html#p_aiYWebohij class=p_ident id=p_aiYWebohij></a>If you want to implement a type of motion that is stateful, such as bouncing, make sure you store the necessary state in the actor object—include it as constructor argument and add it as a property.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_bCqQqL9ccE class=p_ident id=p_bCqQqL9ccE></a>Remember that <code>update</code> returns a <em>new</em> object, rather than changing the old one.</p> <p><a href=https://eloquentjavascript.net/16_game.html#p_tKPg/OUkNV class=p_ident id=p_tKPg/OUkNV></a>When handling collision, find the player in <code>state.actors</code> and compare its position to the monster’s position. To get the <em>bottom</em> of the player, you have to add its vertical size to its vertical position. The creation of an updated state will resemble either <code>Coin</code>’s <code>collide</code> method (removing the actor) or <code>Lava</code>’s (changing the status to <code>\"lost\"</code>), depending on the player position.</p> </div></div><nav><a href=https://eloquentjavascript.net/15_event.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/17_canvas.html>▶</a></nav>\n</article><hr><h4>Page 16</h4><article score=776.4500000000002>\n<nav><a href=https://eloquentjavascript.net/14_dom.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/16_game.html>▶</a></nav> <blockquote> <p><a href=https://eloquentjavascript.net/15_event.html#p_9vGtY0kynX class=p_ident id=p_9vGtY0kynX></a>You have power over your mind—not outside events. Realize this, and you will find strength.</p> <footer>Marcus Aurelius, <cite>Meditations</cite></footer> </blockquote><figure class=\"chapter framed\"><img alt=\"Picture a Rube Goldberg machine\" src=https://eloquentjavascript.net/img/chapter_picture_15.jpg></figure> <p><a href=https://eloquentjavascript.net/15_event.html#p_xpTTTgjdUW class=p_ident id=p_xpTTTgjdUW></a>Some programs work with direct user input, such as mouse and keyboard actions. That kind of input isn’t available as a well-organized data structure—it comes in piece by piece, in real time, and the program is expected to respond to it as it happens.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_HQoLxG2r2l class=h_ident id=h_HQoLxG2r2l></a>Event handlers</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_4crjoEGjCE class=p_ident id=p_4crjoEGjCE></a>Imagine an interface where the only way to find out whether a key on the keyboard is being pressed is to read the current state of that key. To be able to react to keypresses, you would have to constantly read the key’s state so that you’d catch it before it’s released again. It would be dangerous to perform other time-intensive computations since you might miss a keypress.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_2XITYSlZAe class=p_ident id=p_2XITYSlZAe></a>Some primitive machines do handle input like that. A step up from this would be for the hardware or operating system to notice the keypress and put it in a queue. A program can then periodically check the queue for new events and react to what it finds there.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_z76x9gnNzd class=p_ident id=p_z76x9gnNzd></a>Of course, it has to remember to look at the queue, and to do it often, because any time between the key being pressed and the program noticing the event will cause the software to feel unresponsive. This approach is called <em>polling</em>. Most programmers prefer to avoid it.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_yR0Vf6qqc8 class=p_ident id=p_yR0Vf6qqc8></a>A better mechanism is for the system to actively notify our code when an event occurs. Browsers do this by allowing us to register functions as <em>handlers</em> for specific events.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_z0Q59PvLev class=c_ident id=c_z0Q59PvLev></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Click this document to activate the handler.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"You knocked?\"</p>); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_3pQVpu1yal class=p_ident id=p_3pQVpu1yal></a>The <code>window</code> binding refers to a built-in object provided by the browser. It represents the browser window that contains the document. Calling its <code>addEventListener</code> method registers the second argument to be called whenever the event described by its first argument occurs.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_Kx1VwAV7ei class=h_ident id=h_Kx1VwAV7ei></a>Events and DOM nodes</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_tVKEGdxeqi class=p_ident id=p_tVKEGdxeqi></a>Each browser event handler is registered in a context. In the previous example we called <code>addEventListener</code> on the <code>window</code> object to register a handler for the whole window. Such a method can also be found on DOM elements and some other types of objects. Event listeners are called only when the event happens in the context of the object they are registered on.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_srTkrKlkl+ class=c_ident id=c_srTkrKlkl+></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>Click me<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>No handler here.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>button</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"button\"</p>); <p class=cm-variable>button</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Button clicked.\"</p>); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_NDsx/r9YFj class=p_ident id=p_NDsx/r9YFj></a>That example attaches a handler to the button node. Clicks on the button cause that handler to run, but clicks on the rest of the document do not.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_nXR5M/glIi class=p_ident id=p_nXR5M/glIi></a>Giving a node an <code>onclick</code> attribute has a similar effect. This works for most types of events—you can attach a handler through the attribute whose name is the event name with <code>on</code> in front of it.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_2j++Jf85vd class=p_ident id=p_2j++Jf85vd></a>But a node can have only one <code>onclick</code> attribute, so you can register only one handler per node that way. The <code>addEventListener</code> method allows you to add any number of handlers so that it is safe to add handlers even if there is already another handler on the element.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_kTdN4mDFS6 class=p_ident id=p_kTdN4mDFS6></a>The <code>removeEventListener</code> method, called with arguments similar to <code>addEventListener</code>, removes a handler.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_nMrNUG0bzK class=c_ident id=c_nMrNUG0bzK></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>Act-once button<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>button</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"button\"</p>); <p class=cm-keyword>function</p> <p class=cm-def>once</p>() { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Done.\"</p>); <p class=cm-variable>button</p>.<p class=cm-property>removeEventListener</p>(<p class=cm-string>\"click\"</p>, <p class=cm-variable>once</p>); } <p class=cm-variable>button</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, <p class=cm-variable>once</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_I5Z7Y0phDC class=p_ident id=p_I5Z7Y0phDC></a>The function given to <code>removeEventListener</code> has to be the same function value that was given to <code>addEventListener</code>. So, to unregister a handler, you’ll want to give the function a name (<code>once</code>, in the example) to be able to pass the same function value to both methods.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_0d6qd0WrDY class=h_ident id=h_0d6qd0WrDY></a>Event objects</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_ALjvdUiK0y class=p_ident id=p_ALjvdUiK0y></a>Though we have ignored it so far, event handler functions are passed an argument: the <em>event object</em>. This object holds additional information about the event. For example, if we want to know <em>which</em> mouse button was pressed, we can look at the event object’s <code>button</code> property.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_ogCz14mujk class=c_ident id=c_ogCz14mujk></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>Click me any way you want<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>button</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"button\"</p>); <p class=cm-variable>button</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousedown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>button</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Left button\"</p>); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>button</p> <p class=cm-operator>==</p> <p class=cm-number>1</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Middle button\"</p>); } <p class=cm-keyword>else</p> <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>button</p> <p class=cm-operator>==</p> <p class=cm-number>2</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Right button\"</p>); } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_2YZPvB2Zm4 class=p_ident id=p_2YZPvB2Zm4></a>The information stored in an event object differs per type of event. We’ll discuss different types later in the chapter. The object’s <code>type</code> property always holds a string identifying the event (such as <code>\"click\"</code> or <code>\"mousedown\"</code>).</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_NEhx0cDpml class=h_ident id=h_NEhx0cDpml></a>Propagation</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_9PGPBJSMFn class=p_ident id=p_9PGPBJSMFn></a>For most event types, handlers registered on nodes with children will also receive events that happen in the children. If a button inside a paragraph is clicked, event handlers on the paragraph will also see the click event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_0VuJPBg2UB class=p_ident id=p_0VuJPBg2UB></a>But if both the paragraph and the button have a handler, the more specific handler—the one on the button—gets to go first. The event is said to <em>propagate</em> outward, from the node where it happened to that node’s parent node and on to the root of the document. Finally, after all handlers registered on a specific node have had their turn, handlers registered on the whole window get a chance to respond to the event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_unHabXBzty class=p_ident id=p_unHabXBzty></a>At any point, an event handler can call the <code>stopPropagation</code> method on the event object to prevent handlers further up from receiving the event. This can be useful when, for example, you have a button inside another clickable element and you don’t want clicks on the button to activate the outer element’s click behavior.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_qKf3t2phih class=p_ident id=p_qKf3t2phih></a>The following example registers <code>\"mousedown\"</code> handlers on both a button and the paragraph around it. When clicked with the right mouse button, the handler for the button calls <code>stopPropagation</code>, which will prevent the handler on the paragraph from running. When the button is clicked with another mouse button, both handlers will run.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_ApZbQ8dI12 class=c_ident id=c_ApZbQ8dI12></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>A paragraph with a <p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>button<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>para</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"p\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>button</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"button\"</p>); <p class=cm-variable>para</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousedown\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Handler for paragraph.\"</p>); }); <p class=cm-variable>button</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousedown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Handler for button.\"</p>); <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>button</p> <p class=cm-operator>==</p> <p class=cm-number>2</p>) <p class=cm-variable-2>event</p>.<p class=cm-property>stopPropagation</p>(); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_NocTrrs2K+ class=p_ident id=p_NocTrrs2K+></a>Most event objects have a <code>target</code> property that refers to the node where they originated. You can use this property to ensure that you’re not accidentally handling something that propagated up from a node you do not want to handle.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_RrFjk/g1ly class=p_ident id=p_RrFjk/g1ly></a>It is also possible to use the <code>target</code> property to cast a wide net for a specific type of event. For example, if you have a node containing a long list of buttons, it may be more convenient to register a single click handler on the outer node and have it use the <code>target</code> property to figure out whether a button was clicked, rather than register individual handlers on all of the buttons.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_dpl2XD58ol class=c_ident id=c_dpl2XD58ol></a><p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>A<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>B<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>C<p class=cm-tag>&lt;/</p><p class=cm-tag>button</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>target</p>.<p class=cm-property>nodeName</p> <p class=cm-operator>==</p> <p class=cm-string>\"BUTTON\"</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Clicked\"</p>, <p class=cm-variable-2>event</p>.<p class=cm-property>target</p>.<p class=cm-property>textContent</p>); } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/15_event.html#h_GaHJsztrot class=h_ident id=h_GaHJsztrot></a>Default actions</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_mNZd3hJWtB class=p_ident id=p_mNZd3hJWtB></a>Many events have a default action associated with them. If you click a link, you will be taken to the link’s target. If you press the down arrow, the browser will scroll the page down. If you right-click, you’ll get a context menu. And so on.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_BXr+oTOrOE class=p_ident id=p_BXr+oTOrOE></a>For most types of events, the JavaScript event handlers are called <em>before</em> the default behavior takes place. If the handler doesn’t want this normal behavior to happen, typically because it has already taken care of handling the event, it can call the <code>preventDefault</code> method on the event object.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_hu1WU9Uwj3 class=p_ident id=p_hu1WU9Uwj3></a>This can be used to implement your own keyboard shortcuts or context menu. It can also be used to obnoxiously interfere with the behavior that users expect. For example, here is a link that cannot be followed:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_0/0kxevSeD class=c_ident id=c_0/0kxevSeD></a><p class=cm-tag>&lt;</p><p class=cm-tag>a</p> <p class=cm-attribute>href</p>=<p class=cm-string>\"https://developer.mozilla.org/\"</p><p class=cm-tag>&gt;</p>MDN<p class=cm-tag>&lt;/</p><p class=cm-tag>a</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>link</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"a\"</p>); <p class=cm-variable>link</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Nope.\"</p>); <p class=cm-variable-2>event</p>.<p class=cm-property>preventDefault</p>(); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_pN3dm88Fmp class=p_ident id=p_pN3dm88Fmp></a>Try not to do such things unless you have a really good reason to. It’ll be unpleasant for people who use your page when expected behavior is broken.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_KMgK6E70da class=p_ident id=p_KMgK6E70da></a>Depending on the browser, some events can’t be intercepted at all. On Chrome, for example, the keyboard shortcut to close the current tab (<span class=keyname>control</span>-W or <span class=keyname>command</span>-W) cannot be handled by JavaScript.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_974t15Z9oa class=h_ident id=h_974t15Z9oa></a>Key events</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_cxWc3fDa17 class=p_ident id=p_cxWc3fDa17></a>When a key on the keyboard is pressed, your browser fires a <code>\"keydown\"</code> event. When it is released, you get a <code>\"keyup\"</code> event.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_KkYEaH5/cU class=c_ident id=c_KkYEaH5/cU></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>This page turns violet when you hold the V key.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keydown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>key</p> <p class=cm-operator>==</p> <p class=cm-string>\"v\"</p>) { <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>style</p>.<p class=cm-property>background</p> <p class=cm-operator>=</p> <p class=cm-string>\"violet\"</p>; } }); <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keyup\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>key</p> <p class=cm-operator>==</p> <p class=cm-string>\"v\"</p>) { <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>style</p>.<p class=cm-property>background</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>; } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_OIjS/pXtfk class=p_ident id=p_OIjS/pXtfk></a>Despite its name, <code>\"keydown\"</code> fires not only when the key is physically pushed down. When a key is pressed and held, the event fires again every time the key <em>repeats</em>. Sometimes you have to be careful about this. For example, if you add a button to the DOM when a key is pressed and remove it again when the key is released, you might accidentally add hundreds of buttons when the key is held down longer.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_91YbvgP75t class=p_ident id=p_91YbvgP75t></a>The example looked at the <code>key</code> property of the event object to see which key the event is about. This property holds a string that, for most keys, corresponds to the thing that pressing that key would type. For special keys such as <span class=keyname>enter</span>, it holds a string that names the key (<code>\"Enter\"</code>, in this case). If you hold <span class=keyname>shift</span> while pressing a key, that might also influence the name of the key—<code>\"v\"</code> becomes <code>\"V\"</code>, and <code>\"1\"</code> may become <code>\"!\"</code>, if that is what pressing <span class=keyname>shift</span>-1 produces on your keyboard.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_4cdQPevWxW class=p_ident id=p_4cdQPevWxW></a>Modifier keys such as <span class=keyname>shift</span>, <span class=keyname>control</span>, <span class=keyname>alt</span>, and <span class=keyname>meta</span> (<span class=keyname>command</span> on Mac) generate key events just like normal keys. But when looking for key combinations, you can also find out whether these keys are held down by looking at the <code>shiftKey</code>, <code>ctrlKey</code>, <code>altKey</code>, and <code>metaKey</code> properties of keyboard and mouse events.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_aHmyG7GoKB class=c_ident id=c_aHmyG7GoKB></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Press Control-Space to continue.<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"keydown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>key</p> <p class=cm-operator>==</p> <p class=cm-string>\" \"</p> <p class=cm-operator>&amp;</p><p class=cm-operator>&amp;</p> <p class=cm-variable-2>event</p>.<p class=cm-property>ctrlKey</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Continuing!\"</p>); } });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_EHGULml9MQ class=p_ident id=p_EHGULml9MQ></a>The DOM node where a key event originates depends on the element that has focus when the key is pressed. Most nodes cannot have focus unless you give them a <code>tabindex</code> attribute, but things like links, buttons, and form fields can. We’ll come back to form fields in <a href=https://eloquentjavascript.net/18_http.html#forms>Chapter 18</a>. When nothing in particular has focus, <code>document.body</code> acts as the target node of key events.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_gWNn34dc3l class=p_ident id=p_gWNn34dc3l></a>When the user is typing text, using key events to figure out what is being typed is problematic. Some platforms, most notably the virtual keyboard on Android phones, don’t fire key events. But even when you have an old-fashioned keyboard, some types of text input don’t match key presses in a straightforward way, such as <em>input method editor</em> (IME) software used by people whose scripts don’t fit on a keyboard, where multiple key strokes are combined to create characters.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_zRpxwczivX class=p_ident id=p_zRpxwczivX></a>To notice when something was typed, elements that you can type into, such as the <code>&lt;input&gt;</code> and <code>&lt;textarea&gt;</code> tags, fire <code>\"input\"</code> events whenever the user changes their content. To get the actual content that was typed, it is best to directly read it from the focused field. <a href=https://eloquentjavascript.net/18_http.html#forms>Chapter 18</a> will show how.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_cF46QKpzec class=h_ident id=h_cF46QKpzec></a>Pointer events</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_mTy2muIADb class=p_ident id=p_mTy2muIADb></a>There are currently two widely used ways to point at things on a screen: mice (including devices that act like mice, such as touchpads and trackballs) and touchscreens. These produce different kinds of events.</p> <h3><a href=https://eloquentjavascript.net/15_event.html#i_D5iwImkmyt class=i_ident id=i_D5iwImkmyt></a>Mouse clicks</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_zZHDVhEhYY class=p_ident id=p_zZHDVhEhYY></a>Pressing a mouse button causes a number of events to fire. The <code>\"mousedown\"</code> and <code>\"mouseup\"</code> events are similar to <code>\"keydown\"</code> and <code>\"keyup\"</code> and fire when the button is pressed and released. These happen on the DOM nodes that are immediately below the mouse pointer when the event occurs.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_nNPZmPzglj class=p_ident id=p_nNPZmPzglj></a>After the <code>\"mouseup\"</code> event, a <code>\"click\"</code> event fires on the most specific node that contained both the press and the release of the button. For example, if I press down the mouse button on one paragraph and then move the pointer to another paragraph and release the button, the <code>\"click\"</code> event will happen on the element that contains both those paragraphs.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_gzmmLlVcMF class=p_ident id=p_gzmmLlVcMF></a>If two clicks happen close together, a <code>\"dblclick\"</code> (double-click) event also fires, after the second click event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_kaCGAW6CrN class=p_ident id=p_kaCGAW6CrN></a>To get precise information about the place where a mouse event happened, you can look at its <code>clientX</code> and <code>clientY</code> properties, which contain the event’s coordinates (in pixels) relative to the top-left corner of the window, or <code>pageX</code> and <code>pageY</code>, which are relative to the top-left corner of the whole document (which may be different when the window has been scrolled).</p> <p id=mouse_drawing><a href=https://eloquentjavascript.net/15_event.html#p_A7YDC3hfu1 class=p_ident id=p_A7YDC3hfu1></a>The following implements a primitive drawing program. Every time you click the document, it adds a dot under your mouse pointer. See <a href=https://eloquentjavascript.net/19_paint.html>Chapter 19</a> for a less primitive drawing program.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_2eo6Jw+49U class=c_ident id=c_2eo6Jw+49U></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-tag>body</p> { <p class=cm-property>height</p>: <p class=cm-number>200px</p>; <p class=cm-property>background</p>: <p class=cm-keyword>beige</p>; } <p class=cm-qualifier>.dot</p> { <p class=cm-property>height</p>: <p class=cm-number>8px</p>; <p class=cm-property>width</p>: <p class=cm-number>8px</p>; <p class=cm-property>border-radius</p>: <p class=cm-number>4px</p>; <p class=cm-property>background</p>: <p class=cm-keyword>blue</p>; <p class=cm-property>position</p>: <p class=cm-atom>absolute</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"click\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>dot</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-string>\"div\"</p>); <p class=cm-variable-2>dot</p>.<p class=cm-property>className</p> <p class=cm-operator>=</p> <p class=cm-string>\"dot\"</p>; <p class=cm-variable-2>dot</p>.<p class=cm-property>style</p>.<p class=cm-property>left</p> <p class=cm-operator>=</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>pageX</p> <p class=cm-operator>-</p> <p class=cm-number>4</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable-2>dot</p>.<p class=cm-property>style</p>.<p class=cm-property>top</p> <p class=cm-operator>=</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>pageY</p> <p class=cm-operator>-</p> <p class=cm-number>4</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>dot</p>); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h3><a href=https://eloquentjavascript.net/15_event.html#i_XojjiOmg7v class=i_ident id=i_XojjiOmg7v></a>Mouse motion</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_yS6GUjUh7f class=p_ident id=p_yS6GUjUh7f></a>Every time the mouse pointer moves, a <code>\"mousemove\"</code> event is fired. This event can be used to track the position of the mouse. A common situation in which this is useful is when implementing some form of mouse-dragging functionality.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_uNUrAgInXR class=p_ident id=p_uNUrAgInXR></a>As an example, the following program displays a bar and sets up event handlers so that dragging to the left or right on this bar makes it narrower or wider:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_+CX2XtmsmE class=c_ident id=c_+CX2XtmsmE></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Drag the bar to change its width:<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>style</p>=<p class=cm-string>\"background: orange; width: 60px; height: 20px\"</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>lastX</p>; <p class=cm-keyword>let</p> <p class=cm-def>bar</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"div\"</p>); <p class=cm-variable>bar</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousedown\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>button</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable>lastX</p> <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>clientX</p>; <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousemove\"</p>, <p class=cm-variable>moved</p>); <p class=cm-variable-2>event</p>.<p class=cm-property>preventDefault</p>(); } }); <p class=cm-keyword>function</p> <p class=cm-def>moved</p>(<p class=cm-def>event</p>) { <p class=cm-keyword>if</p> (<p class=cm-variable-2>event</p>.<p class=cm-property>buttons</p> <p class=cm-operator>==</p> <p class=cm-number>0</p>) { <p class=cm-variable>window</p>.<p class=cm-property>removeEventListener</p>(<p class=cm-string>\"mousemove\"</p>, <p class=cm-variable>moved</p>); } <p class=cm-keyword>else</p> { <p class=cm-keyword>let</p> <p class=cm-def>dist</p> <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>clientX</p> <p class=cm-operator>-</p> <p class=cm-variable>lastX</p>; <p class=cm-keyword>let</p> <p class=cm-def>newWidth</p> <p class=cm-operator>=</p> <p class=cm-variable>Math</p>.<p class=cm-property>max</p>(<p class=cm-number>10</p>, <p class=cm-variable>bar</p>.<p class=cm-property>offsetWidth</p> <p class=cm-operator>+</p> <p class=cm-variable-2>dist</p>); <p class=cm-variable>bar</p>.<p class=cm-property>style</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-variable-2>newWidth</p> <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>lastX</p> <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>clientX</p>; } }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_NkCRDxiDFs class=p_ident id=p_NkCRDxiDFs></a>Note that the <code>\"mousemove\"</code> handler is registered on the whole window. Even if the mouse goes outside of the bar during resizing, as long as the button is held we still want to update its size.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_cThE4XLnJC class=p_ident id=p_cThE4XLnJC></a>We must stop resizing the bar when the mouse button is released. For that, we can use the <code>buttons</code> property (note the plural), which tells us about the buttons that are currently held down. When this is zero, no buttons are down. When buttons are held, its value is the sum of the codes for those buttons—the left button has code 1, the right button 2, and the middle one 4. That way, you can check whether a given button is pressed by taking the remainder of the value of <code>buttons</code> and its code.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_CmfoIcvJii class=p_ident id=p_CmfoIcvJii></a>Note that the order of these codes is different from the one used by <code>button</code>, where the middle button came before the right one. As mentioned, consistency isn’t really a strong point of the browser’s programming interface.</p> <h3><a href=https://eloquentjavascript.net/15_event.html#i_jF9QgltzXD class=i_ident id=i_jF9QgltzXD></a>Touch events</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_sd0bzLSga7 class=p_ident id=p_sd0bzLSga7></a>The style of graphical browser that we use was designed with mouse interfaces in mind, at a time where touchscreens were rare. To make the Web “work” on early touchscreen phones, browsers for those devices pretended, to a certain extent, that touch events were mouse events. If you tap your screen, you’ll get <code>\"mousedown\"</code>, <code>\"mouseup\"</code>, and <code>\"click\"</code> events.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_jD6s34l+nR class=p_ident id=p_jD6s34l+nR></a>But this illusion isn’t very robust. A touchscreen works differently from a mouse: it doesn’t have multiple buttons, you can’t track the finger when it isn’t on the screen (to simulate <code>\"mousemove\"</code>), and it allows multiple fingers to be on the screen at the same time.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_5INtcl6su5 class=p_ident id=p_5INtcl6su5></a>Mouse events cover touch interaction only in straightforward cases—if you add a <code>\"click\"</code> handler to a button, touch users will still be able to use it. But something like the resizeable bar in the previous example does not work on a touchscreen.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_cQNA+9JYLs class=p_ident id=p_cQNA+9JYLs></a>There are specific event types fired by touch interaction. When a finger starts touching the screen, you get a <code>\"touchstart\"</code> event. When it is moved while touching, <code>\"touchmove\"</code> events fire. Finally, when it stops touching the screen, you’ll see a <code>\"touchend\"</code> event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_IHGyrDKsGS class=p_ident id=p_IHGyrDKsGS></a>Because many touchscreens can detect multiple fingers at the same time, these events don’t have a single set of coordinates associated with them. Rather, their event objects have a <code>touches</code> property, which holds an array-like object of points, each of which has its own <code>clientX</code>, <code>clientY</code>, <code>pageX</code>, and <code>pageY</code> properties.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_6DdNmVnXwi class=p_ident id=p_6DdNmVnXwi></a>You could do something like this to show red circles around every touching finger:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_TpxWIP8ylU class=c_ident id=c_TpxWIP8ylU></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-tag>dot</p> { <p class=cm-property>position</p>: <p class=cm-atom>absolute</p>; <p class=cm-property>display</p>: <p class=cm-atom>block</p>; <p class=cm-property>border</p>: <p class=cm-number>2px</p> <p class=cm-atom>solid</p> <p class=cm-keyword>red</p>; <p class=cm-property>border-radius</p>: <p class=cm-number>50px</p>; <p class=cm-property>height</p>: <p class=cm-number>100px</p>; <p class=cm-property>width</p>: <p class=cm-number>100px</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Touch this page<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>update</p>(<p class=cm-def>event</p>) { <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>dot</p>; <p class=cm-variable-2>dot</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"dot\"</p>);) { <p class=cm-variable-2>dot</p>.<p class=cm-property>remove</p>(); } <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>i</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>; <p class=cm-variable-2>i</p> <p class=cm-operator>&lt;</p> <p class=cm-variable-2>event</p>.<p class=cm-property>touches</p>.<p class=cm-property>length</p>; <p class=cm-variable-2>i</p><p class=cm-operator>++</p>) { <p class=cm-keyword>let</p> {<p class=cm-def>pageX</p>, <p class=cm-def>pageY</p>} <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>touches</p>[<p class=cm-variable-2>i</p>]; <p class=cm-keyword>let</p> <p class=cm-def>dot</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>createElement</p>(<p class=cm-string>\"dot\"</p>); <p class=cm-variable-2>dot</p>.<p class=cm-property>style</p>.<p class=cm-property>left</p> <p class=cm-operator>=</p> (<p class=cm-variable-2>pageX</p> <p class=cm-operator>-</p> <p class=cm-number>50</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable-2>dot</p>.<p class=cm-property>style</p>.<p class=cm-property>top</p> <p class=cm-operator>=</p> (<p class=cm-variable-2>pageY</p> <p class=cm-operator>-</p> <p class=cm-number>50</p>) <p class=cm-operator>+</p> <p class=cm-string>\"px\"</p>; <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable-2>dot</p>); } } <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"touchstart\"</p>, <p class=cm-variable>update</p>); <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"touchmove\"</p>, <p class=cm-variable>update</p>); <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"touchend\"</p>, <p class=cm-variable>update</p>);\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_NZHqbUebJ6 class=p_ident id=p_NZHqbUebJ6></a>You’ll often want to call <code>preventDefault</code> in touch event handlers to override the browser’s default behavior (which may include scrolling the page on swiping) and to prevent the mouse events from being fired, for which you may <em>also</em> have a handler.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_xGSp7W5DAZ class=h_ident id=h_xGSp7W5DAZ></a>Scroll events</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_RLg7GV0Uge class=p_ident id=p_RLg7GV0Uge></a>Whenever an element is scrolled, a <code>\"scroll\"</code> event is fired on it. This has various uses, such as knowing what the user is currently looking at (for disabling off-screen animations or sending spy reports to your evil headquarters) or showing some indication of progress (by highlighting part of a table of contents or showing a page number).</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_koAfRfBrN2 class=p_ident id=p_koAfRfBrN2></a>The following example draws a progress bar above the document and updates it to fill up as you scroll down:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_7tyBZD/B1O class=c_ident id=c_7tyBZD/B1O></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-builtin>#progress</p> { <p class=cm-property>border-bottom</p>: <p class=cm-number>2px</p> <p class=cm-atom>solid</p> <p class=cm-keyword>blue</p>; <p class=cm-property>width</p>: <p class=cm-number>0</p>; <p class=cm-property>position</p>: <p class=cm-atom>fixed</p>; <p class=cm-property>top</p>: <p class=cm-number>0</p>; <p class=cm-property>left</p>: <p class=cm-number>0</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"progress\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>appendChild</p>(<p class=cm-variable>document</p>.<p class=cm-property>createTextNode</p>( <p class=cm-string>\"supercalifragilisticexpialidocious \"</p>.<p class=cm-property>repeat</p>(<p class=cm-number>1000</p>))); <p class=cm-keyword>let</p> <p class=cm-def>bar</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#progress\"</p>); <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"scroll\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>max</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>scrollHeight</p> <p class=cm-operator>-</p> <p class=cm-variable>innerHeight</p>; <p class=cm-variable>bar</p>.<p class=cm-property>style</p>.<p class=cm-property>width</p> <p class=cm-operator>=</p> <p class=cm-string-2>`${</p>(<p class=cm-variable>pageYOffset</p> <p class=cm-operator>/</p> <p class=cm-variable-2>max</p>) <p class=cm-operator>*</p> <p class=cm-number>100</p><p class=cm-string-2>}</p><p class=cm-string-2>%`</p>; });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_K3MHOw7Pyv class=p_ident id=p_K3MHOw7Pyv></a>Giving an element a <code>position</code> of <code>fixed</code> acts much like an <code>absolute</code> position but also prevents it from scrolling along with the rest of the document. The effect is to make our progress bar stay at the top. Its width is changed to indicate the current progress. We use <code>%</code>, rather than <code>px</code>, as a unit when setting the width so that the element is sized relative to the page width.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_98WgTyMsUp class=p_ident id=p_98WgTyMsUp></a>The global <code>innerHeight</code> binding gives us the height of the window, which we have to subtract from the total scrollable height—you can’t keep scrolling when you hit the bottom of the document. There’s also an <code>innerWidth</code> for the window width. By dividing <code>pageYOffset</code>, the current scroll position, by the maximum scroll position and multiplying by 100, we get the percentage for the progress bar.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_tX0nzFvZnA class=p_ident id=p_tX0nzFvZnA></a>Calling <code>preventDefault</code> on a scroll event does not prevent the scrolling from happening. In fact, the event handler is called only <em>after</em> the scrolling takes place.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_NoKd+BgJRm class=h_ident id=h_NoKd+BgJRm></a>Focus events</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_Rd7wWTGmsl class=p_ident id=p_Rd7wWTGmsl></a>When an element gains focus, the browser fires a <code>\"focus\"</code> event on it. When it loses focus, the element gets a <code>\"blur\"</code> event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_rU6XEBvIwF class=p_ident id=p_rU6XEBvIwF></a>Unlike the events discussed earlier, these two events do not propagate. A handler on a parent element is not notified when a child element gains or loses focus.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_CuMJTkSD/k class=p_ident id=p_CuMJTkSD/k></a>The following example displays help text for the text field that currently has focus:</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_0ajEiAUCqr class=c_ident id=c_0ajEiAUCqr></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Name: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>data-help</p>=<p class=cm-string>\"Your full name\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>Age: <p class=cm-tag>&lt;</p><p class=cm-tag>input</p> <p class=cm-attribute>type</p>=<p class=cm-string>\"text\"</p> <p class=cm-attribute>data-help</p>=<p class=cm-string>\"Your age in years\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>p</p> <p class=cm-attribute>id</p>=<p class=cm-string>\"help\"</p><p class=cm-tag>&gt;</p><p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>help</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"#help\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>fields</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelectorAll</p>(<p class=cm-string>\"input\"</p>); <p class=cm-keyword>for</p> (<p class=cm-keyword>let</p> <p class=cm-def>field</p> <p class=cm-keyword>of</p> <p class=cm-variable>Array</p>.<p class=cm-property>from</p>(<p class=cm-variable>fields</p>)) { <p class=cm-variable>field</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"focus\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>let</p> <p class=cm-def>text</p> <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>.<p class=cm-property>target</p>.<p class=cm-property>getAttribute</p>(<p class=cm-string>\"data-help\"</p>); <p class=cm-variable>help</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-variable-2>text</p>; }); <p class=cm-variable>field</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"blur\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>help</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-string>\"\"</p>; }); }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_ncYRMnjZTA class=p_ident id=p_ncYRMnjZTA></a>The window object will receive <code>\"focus\"</code> and <code>\"blur\"</code> events when the user moves from or to the browser tab or window in which the document is shown.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_NmV8RP8lpt class=h_ident id=h_NmV8RP8lpt></a>Load event</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_zOHPnpKQpO class=p_ident id=p_zOHPnpKQpO></a>When a page finishes loading, the <code>\"load\"</code> event fires on the window and the document body objects. This is often used to schedule initialization actions that require the whole document to have been built. Remember that the content of <code>&lt;script&gt;</code> tags is run immediately when the tag is encountered. This may be too soon, for example when the script needs to do something with parts of the document that appear after the <code>&lt;script&gt;</code> tag.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_SqGooUkpJY class=p_ident id=p_SqGooUkpJY></a>Elements such as images and script tags that load an external file also have a <code>\"load\"</code> event that indicates the files they reference were loaded. Like the focus-related events, loading events do not propagate.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_41hBiFLDEt class=p_ident id=p_41hBiFLDEt></a>When a page is closed or navigated away from (for example, by following a link), a <code>\"beforeunload\"</code> event fires. The main use of this event is to prevent the user from accidentally losing work by closing a document. If you prevent the default behavior on this event <em>and</em> set the <code>returnValue</code> property on the event object to a string, the browser will show the user a dialog asking if they really want to leave the page. That dialog might include your string, but because some malicious sites try to use these dialogs to confuse people into staying on their page to look at dodgy weight loss ads, most browsers no longer display them.</p> <h2 id=timeline><a href=https://eloquentjavascript.net/15_event.html#h_nX2hsbjECC class=h_ident id=h_nX2hsbjECC></a>Events and the event loop</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_IdpDwNDDaS class=p_ident id=p_IdpDwNDDaS></a>In the context of the event loop, as discussed in <a href=https://eloquentjavascript.net/11_async.html>Chapter 11</a>, browser event handlers behave like other asynchronous notifications. They are scheduled when the event occurs but must wait for other scripts that are running to finish before they get a chance to run.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_U9K4BTMkUk class=p_ident id=p_U9K4BTMkUk></a>The fact that events can be processed only when nothing else is running means that, if the event loop is tied up with other work, any interaction with the page (which happens through events) will be delayed until there’s time to process it. So if you schedule too much work, either with long-running event handlers or with lots of short-running ones, the page will become slow and cumbersome to use.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_KfmkFMZHYK class=p_ident id=p_KfmkFMZHYK></a>For cases where you <em>really</em> do want to do some time-consuming thing in the background without freezing the page, browsers provide something called <em>web workers</em>. A worker is a JavaScript process that runs alongside the main script, on its own timeline.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_V7fk5zfZyU class=p_ident id=p_V7fk5zfZyU></a>Imagine that squaring a number is a heavy, long-running computation that we want to perform in a separate thread. We could write a file called <code>code/<wbr>squareworker.<wbr>js</code> that responds to messages by computing a square and sending a message back.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_FgmodjGwd9 class=c_ident id=c_FgmodjGwd9></a><p class=cm-variable>addEventListener</p>(<p class=cm-string>\"message\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>postMessage</p>(<p class=cm-variable-2>event</p>.<p class=cm-property>data</p> <p class=cm-operator>*</p> <p class=cm-variable-2>event</p>.<p class=cm-property>data</p>);\n});</pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_dG9n2QuEiF class=p_ident id=p_dG9n2QuEiF></a>To avoid the problems of having multiple threads touching the same data, workers do not share their global scope or any other data with the main script’s environment. Instead, you have to communicate with them by sending messages back and forth.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_JZ/vp+7+lV class=p_ident id=p_JZ/vp+7+lV></a>This code spawns a worker running that script, sends it a few messages, and outputs the responses.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_43W0FL82No class=c_ident id=c_43W0FL82No></a><p class=cm-keyword>let</p> <p class=cm-def>squareWorker</p> <p class=cm-operator>=</p> <p class=cm-keyword>new</p> <p class=cm-variable>Worker</p>(<p class=cm-string>\"code/squareworker.js\"</p>);\n<p class=cm-variable>squareWorker</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"message\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"The worker responded:\"</p>, <p class=cm-variable-2>event</p>.<p class=cm-property>data</p>);\n});\n<p class=cm-variable>squareWorker</p>.<p class=cm-property>postMessage</p>(<p class=cm-number>10</p>);\n<p class=cm-variable>squareWorker</p>.<p class=cm-property>postMessage</p>(<p class=cm-number>24</p>);</pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_/l2saz0Kwz class=p_ident id=p_/l2saz0Kwz></a>The <code>postMessage</code> function sends a message, which will cause a <code>\"message\"</code> event to fire in the receiver. The script that created the worker sends and receives messages through the <code>Worker</code> object, whereas the worker talks to the script that created it by sending and listening directly on its global scope. Only values that can be represented as JSON can be sent as messages—the other side will receive a <em>copy</em> of them, rather than the value itself.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_hBzQOpfNhU class=h_ident id=h_hBzQOpfNhU></a>Timers</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_oH4C56AxK/ class=p_ident id=p_oH4C56AxK/ ></a>We saw the <code>setTimeout</code> function in <a href=https://eloquentjavascript.net/11_async.html>Chapter 11</a>. It schedules another function to be called later, after a given number of milliseconds.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_FeJ5k8rGCc class=p_ident id=p_FeJ5k8rGCc></a>Sometimes you need to cancel a function you have scheduled. This is done by storing the value returned by <code>setTimeout</code> and calling <code>clearTimeout</code> on it.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_EYaodyT5pj class=c_ident id=c_EYaodyT5pj></a><p class=cm-keyword>let</p> <p class=cm-def>bombTimer</p> <p class=cm-operator>=</p> <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"BOOM!\"</p>);\n}, <p class=cm-number>500</p>); <p class=cm-keyword>if</p> (<p class=cm-variable>Math</p>.<p class=cm-property>random</p>() <p class=cm-operator>&lt;</p> <p class=cm-number>0.5</p>) { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Defused.\"</p>); <p class=cm-variable>clearTimeout</p>(<p class=cm-variable>bombTimer</p>);\n}</pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_J6c+vHyMhN class=p_ident id=p_J6c+vHyMhN></a>The <code>cancelAnimationFrame</code> function works in the same way as <code>clearTimeout</code>—calling it on a value returned by <code>requestAnimationFrame</code> will cancel that frame (assuming it hasn’t already been called).</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_MTqUUpmFIN class=p_ident id=p_MTqUUpmFIN></a>A similar set of functions, <code>setInterval</code> and <code>clearInterval</code>, are used to set timers that should <em>repeat</em> every <em>X</em> milliseconds.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_WmiFQBAos1 class=c_ident id=c_WmiFQBAos1></a><p class=cm-keyword>let</p> <p class=cm-def>ticks</p> <p class=cm-operator>=</p> <p class=cm-number>0</p>;\n<p class=cm-keyword>let</p> <p class=cm-def>clock</p> <p class=cm-operator>=</p> <p class=cm-variable>setInterval</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"tick\"</p>, <p class=cm-variable>ticks</p><p class=cm-operator>++</p>); <p class=cm-keyword>if</p> (<p class=cm-variable>ticks</p> <p class=cm-operator>==</p> <p class=cm-number>10</p>) { <p class=cm-variable>clearInterval</p>(<p class=cm-variable>clock</p>); <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"stop.\"</p>); }\n}, <p class=cm-number>200</p>);</pre> <h2><a href=https://eloquentjavascript.net/15_event.html#h_AOVmaqj10I class=h_ident id=h_AOVmaqj10I></a>Debouncing</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_xHU4bJ8gsS class=p_ident id=p_xHU4bJ8gsS></a>Some types of events have the potential to fire rapidly, many times in a row (the <code>\"mousemove\"</code> and <code>\"scroll\"</code> events, for example). When handling such events, you must be careful not to do anything too time-consuming or your handler will take up so much time that interaction with the document starts to feel slow.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_CvRYtJPZwz class=p_ident id=p_CvRYtJPZwz></a>If you do need to do something nontrivial in such a handler, you can use <code>setTimeout</code> to make sure you are not doing it too often. This is usually called <em>debouncing</em> the event. There are several slightly different approaches to this.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_8qDwbjQg0l class=p_ident id=p_8qDwbjQg0l></a>In the first example, we want to react when the user has typed something, but we don’t want to do it immediately for every input event. When they are typing quickly, we just want to wait until a pause occurs. Instead of immediately performing an action in the event handler, we set a timeout. We also clear the previous timeout (if any) so that when events occur close together (closer than our timeout delay), the timeout from the previous event will be canceled.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_amVDbwAaoI class=c_ident id=c_amVDbwAaoI></a><p class=cm-tag>&lt;</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p>Type something here...<p class=cm-tag>&lt;/</p><p class=cm-tag>textarea</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>textarea</p> <p class=cm-operator>=</p> <p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"textarea\"</p>); <p class=cm-keyword>let</p> <p class=cm-def>timeout</p>; <p class=cm-variable>textarea</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"input\"</p>, () <p class=cm-operator>=&gt;</p> { <p class=cm-variable>clearTimeout</p>(<p class=cm-variable>timeout</p>); <p class=cm-variable>timeout</p> <p class=cm-operator>=</p> <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> <p class=cm-variable>console</p>.<p class=cm-property>log</p>(<p class=cm-string>\"Typed!\"</p>), <p class=cm-number>500</p>); });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <p><a href=https://eloquentjavascript.net/15_event.html#p_55az3iLtsc class=p_ident id=p_55az3iLtsc></a>Giving an undefined value to <code>clearTimeout</code> or calling it on a timeout that has already fired has no effect. Thus, we don’t have to be careful about when to call it, and we simply do so for every event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_GisH+i+4tv class=p_ident id=p_GisH+i+4tv></a>We can use a slightly different pattern if we want to space responses so that they’re separated by at least a certain length of time but want to fire them <em>during</em> a series of events, not just afterward. For example, we might want to respond to <code>\"mousemove\"</code> events by showing the current coordinates of the mouse but only every 250 milliseconds.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_Hx4a7naGCO class=c_ident id=c_Hx4a7naGCO></a><p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>let</p> <p class=cm-def>scheduled</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>; <p class=cm-variable>window</p>.<p class=cm-property>addEventListener</p>(<p class=cm-string>\"mousemove\"</p>, <p class=cm-def>event</p> <p class=cm-operator>=&gt;</p> { <p class=cm-keyword>if</p> (<p class=cm-operator>!</p><p class=cm-variable>scheduled</p>) { <p class=cm-variable>setTimeout</p>(() <p class=cm-operator>=&gt;</p> { <p class=cm-variable>document</p>.<p class=cm-property>body</p>.<p class=cm-property>textContent</p> <p class=cm-operator>=</p> <p class=cm-string-2>`Mouse at ${</p><p class=cm-variable>scheduled</p>.<p class=cm-property>pageX</p><p class=cm-string-2>}</p><p class=cm-string-2>, ${</p><p class=cm-variable>scheduled</p>.<p class=cm-property>pageY</p><p class=cm-string-2>}</p><p class=cm-string-2>`</p>; <p class=cm-variable>scheduled</p> <p class=cm-operator>=</p> <p class=cm-atom>null</p>; }, <p class=cm-number>250</p>); } <p class=cm-variable>scheduled</p> <p class=cm-operator>=</p> <p class=cm-variable-2>event</p>; });\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <h2><a href=https://eloquentjavascript.net/15_event.html#h_ErccPg/l98 class=h_ident id=h_ErccPg/l98></a>Summary</h2> <p><a href=https://eloquentjavascript.net/15_event.html#p_bKLVanKSm7 class=p_ident id=p_bKLVanKSm7></a>Event handlers make it possible to detect and react to events happening in our web page. The <code>addEventListener</code> method is used to register such a handler.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_pT/A7mXxlh class=p_ident id=p_pT/A7mXxlh></a>Each event has a type (<code>\"keydown\"</code>, <code>\"focus\"</code>, and so on) that identifies it. Most events are called on a specific DOM element and then <em>propagate</em> to that element’s ancestors, allowing handlers associated with those elements to handle them.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_ot9NdEIh/U class=p_ident id=p_ot9NdEIh/U></a>When an event handler is called, it is passed an event object with additional information about the event. This object also has methods that allow us to stop further propagation (<code>stopPropagation</code>) and prevent the browser’s default handling of the event (<code>preventDefault</code>).</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_3en9/+MrwJ class=p_ident id=p_3en9/+MrwJ></a>Pressing a key fires <code>\"keydown\"</code> and <code>\"keyup\"</code> events. Pressing a mouse button fires <code>\"mousedown\"</code>, <code>\"mouseup\"</code>, and <code>\"click\"</code> events. Moving the mouse fires <code>\"mousemove\"</code> events. Touchscreen interaction will result in <code>\"touchstart\"</code>, <code>\"touchmove\"</code>, and <code>\"touchend\"</code> events.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_zwo0vgzm7O class=p_ident id=p_zwo0vgzm7O></a>Scrolling can be detected with the <code>\"scroll\"</code> event, and focus changes can be detected with the <code>\"focus\"</code> and <code>\"blur\"</code> events. When the document finishes loading, a <code>\"load\"</code> event fires on the window.</p> <h2><a href=https://eloquentjavascript.net/15_event.html#h_TcUD2vzyMe class=h_ident id=h_TcUD2vzyMe></a>Exercises</h2> <h3><a href=https://eloquentjavascript.net/15_event.html#i_ZPJB9UFdQA class=i_ident id=i_ZPJB9UFdQA></a>Balloon</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_bYd6pEDTM7 class=p_ident id=p_bYd6pEDTM7></a>Write a page that displays a balloon (using the balloon emoji, 🎈). When you press the up arrow, it should inflate (grow) 10 percent, and when you press the down arrow, it should deflate (shrink) 10 percent.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_ktZgwjxebp class=p_ident id=p_ktZgwjxebp></a>You can control the size of text (emoji are text) by setting the <code>font-size</code> CSS property (<code>style.fontSize</code>) on its parent element. Remember to include a unit in the value—for example, pixels (<code>10px</code>).</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_5IHxQ3D2Mc class=p_ident id=p_5IHxQ3D2Mc></a>The key names of the arrow keys are <code>\"ArrowUp\"</code> and <code>\"ArrowDown\"</code>. Make sure the keys change only the balloon, without scrolling the page.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_kqnmdZaGYC class=p_ident id=p_kqnmdZaGYC></a>When that works, add a feature where, if you blow up the balloon past a certain size, it explodes. In this case, exploding means that it is replaced with an 💥 emoji, and the event handler is removed (so that you can’t inflate or deflate the explosion).</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_cG9w6ciW0L class=c_ident id=c_cG9w6ciW0L></a><p class=cm-tag>&lt;</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p>🎈<p class=cm-tag>&lt;/</p><p class=cm-tag>p</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/15_event.html#p_01AbHu5E/h class=p_ident id=p_01AbHu5E/h></a>You’ll want to register a handler for the <code>\"keydown\"</code> event and look at <code>event.key</code> to figure out whether the up or down arrow key was pressed.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_HSkdm2Qn5Y class=p_ident id=p_HSkdm2Qn5Y></a>The current size can be kept in a binding so that you can base the new size on it. It’ll be helpful to define a function that updates the size—both the binding and the style of the balloon in the DOM—so that you can call it from your event handler, and possibly also once when starting, to set the initial size.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_H1O0U7JLAU class=p_ident id=p_H1O0U7JLAU></a>You can change the balloon to an explosion by replacing the text node with another one (using <code>replaceChild</code>) or by setting the <code>textContent</code> property of its parent node to a new string.</p> </div></div> <h3><a href=https://eloquentjavascript.net/15_event.html#i_NOgRH0Y9st class=i_ident id=i_NOgRH0Y9st></a>Mouse trail</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_LbKyZCJxyG class=p_ident id=p_LbKyZCJxyG></a>In JavaScript’s early days, which was the high time of gaudy home pages with lots of animated images, people came up with some truly inspiring ways to use the language.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_ZseDCwl6/C class=p_ident id=p_ZseDCwl6/C></a>One of these was the <em>mouse trail</em>—a series of elements that would follow the mouse pointer as you moved it across the page.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_jft4unkoqB class=p_ident id=p_jft4unkoqB></a>In this exercise, I want you to implement a mouse trail. Use absolutely positioned <code>&lt;div&gt;</code> elements with a fixed size and background color (refer to the <a href=https://eloquentjavascript.net/15_event.html#mouse_drawing>code</a> in the “Mouse Clicks” section for an example). Create a bunch of such elements and, when the mouse moves, display them in the wake of the mouse pointer.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_mHJUfC5Anf class=p_ident id=p_mHJUfC5Anf></a>There are various possible approaches here. You can make your solution as simple or as complex as you want. A simple solution to start with is to keep a fixed number of trail elements and cycle through them, moving the next one to the mouse’s current position every time a <code>\"mousemove\"</code> event occurs.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_I0KwYAPM1r class=c_ident id=c_I0KwYAPM1r></a><p class=cm-tag>&lt;</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-qualifier>.trail</p> { <p class=cm-property>position</p>: <p class=cm-atom>absolute</p>; <p class=cm-property>height</p>: <p class=cm-number>6px</p>; <p class=cm-property>width</p>: <p class=cm-number>6px</p>; <p class=cm-property>border-radius</p>: <p class=cm-number>3px</p>; <p class=cm-property>background</p>: <p class=cm-keyword>teal</p>; } <p class=cm-tag>body</p> { <p class=cm-property>height</p>: <p class=cm-number>300px</p>; }\n<p class=cm-tag>&lt;/</p><p class=cm-tag>style</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/15_event.html#p_2Ngnp4yWsj class=p_ident id=p_2Ngnp4yWsj></a>Creating the elements is best done with a loop. Append them to the document to make them show up. To be able to access them later to change their position, you’ll want to store the elements in an array.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_seJm6U8e4t class=p_ident id=p_seJm6U8e4t></a>Cycling through them can be done by keeping a counter variable and adding 1 to it every time the <code>\"mousemove\"</code> event fires. The remainder operator (<code>% elements.<wbr>length</code>) can then be used to get a valid array index to pick the element you want to position during a given event.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_cJRZn+Vuv9 class=p_ident id=p_cJRZn+Vuv9></a>Another interesting effect can be achieved by modeling a simple physics system. Use the <code>\"mousemove\"</code> event only to update a pair of bindings that track the mouse position. Then use <code>requestAnimationFrame</code> to simulate the trailing elements being attracted to the position of the mouse pointer. At every animation step, update their position based on their position relative to the pointer (and, optionally, a speed that is stored for each element). Figuring out a good way to do this is up to you.</p> </div></div> <h3><a href=https://eloquentjavascript.net/15_event.html#i_Kk1WKx2anJ class=i_ident id=i_Kk1WKx2anJ></a>Tabs</h3> <p><a href=https://eloquentjavascript.net/15_event.html#p_hJ2BbC0iJH class=p_ident id=p_hJ2BbC0iJH></a>Tabbed panels are widely used in user interfaces. They allow you to select an interface panel by choosing from a number of tabs “sticking out” above an element.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_rh5X8kUE8g class=p_ident id=p_rh5X8kUE8g></a>In this exercise you must implement a simple tabbed interface. Write a function, <code>asTabs</code>, that takes a DOM node and creates a tabbed interface showing the child elements of that node. It should insert a list of <code>&lt;button&gt;</code> elements at the top of the node, one for each child element, containing text retrieved from the <code>data-tabname</code> attribute of the child. All but one of the original children should be hidden (given a <code>display</code> style of <code>none</code>). The currently visible node can be selected by clicking the buttons.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_TlKLllZaBb class=p_ident id=p_TlKLllZaBb></a>When that works, extend it to style the button for the currently selected tab differently so that it is obvious which tab is selected.</p> <pre class=\"cm-s-default snippet\"><a href=https://eloquentjavascript.net/15_event.html#c_FKji/iKKCg class=c_ident id=c_FKji/iKKCg></a><p class=cm-tag>&lt;</p><p class=cm-tag>tab-panel</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>data-tabname</p>=<p class=cm-string>\"one\"</p><p class=cm-tag>&gt;</p>Tab one<p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>data-tabname</p>=<p class=cm-string>\"two\"</p><p class=cm-tag>&gt;</p>Tab two<p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p> <p class=cm-tag>&lt;</p><p class=cm-tag>div</p> <p class=cm-attribute>data-tabname</p>=<p class=cm-string>\"three\"</p><p class=cm-tag>&gt;</p>Tab three<p class=cm-tag>&lt;/</p><p class=cm-tag>div</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;/</p><p class=cm-tag>tab-panel</p><p class=cm-tag>&gt;</p>\n<p class=cm-tag>&lt;</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p> <p class=cm-keyword>function</p> <p class=cm-def>asTabs</p>(<p class=cm-def>node</p>) { } <p class=cm-variable>asTabs</p>(<p class=cm-variable>document</p>.<p class=cm-property>querySelector</p>(<p class=cm-string>\"tab-panel\"</p>));\n<p class=cm-tag>&lt;/</p><p class=cm-tag>script</p><p class=cm-tag>&gt;</p></pre> <div class=solution><div class=solution-text> <p><a href=https://eloquentjavascript.net/15_event.html#p_uF9atTSMgL class=p_ident id=p_uF9atTSMgL></a>One pitfall you might run into is that you can’t directly use the node’s <code>childNodes</code> property as a collection of tab nodes. For one thing, when you add the buttons, they will also become child nodes and end up in this object because it is a live data structure. For another, the text nodes created for the whitespace between the nodes are also in <code>childNodes</code> but should not get their own tabs. You can use <code>children</code> instead of <code>childNodes</code> to ignore text nodes.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_pEwUiY3Alw class=p_ident id=p_pEwUiY3Alw></a>You could start by building up an array of tabs so that you have easy access to them. To implement the styling of the buttons, you could store objects that contain both the tab panel and its button.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_Ejl1JbiNLC class=p_ident id=p_Ejl1JbiNLC></a>I recommend writing a separate function for changing tabs. You can either store the previously selected tab and change only the styles needed to hide that and show the new one, or you can just update the style of all tabs every time a new tab is selected.</p> <p><a href=https://eloquentjavascript.net/15_event.html#p_2M7g5hWy1u class=p_ident id=p_2M7g5hWy1u></a>You might want to call this function immediately to make the interface start with the first tab visible.</p> </div></div><nav><a href=https://eloquentjavascript.net/14_dom.html>◀</a>&nbsp;<a href=https://eloquentjavascript.net/index.html>◆</a>&nbsp;<a href=https://eloquentjavascript.net/16_game.html>▶</a></nav>\n</article></body></html>",
            "source": "https://eloquentjavascript.net/05_higher_order.html",
            "title": "Chapter 5Higher-Order Functions",
            "author": null,
            "published": null,
            "image": "https://eloquentjavascript.net/img/chapter_picture_5.jpg",
            "description": "◀ ◆ ▶ Tzu-li and Tzu-ssu were boasting about the size of their latest programs. ‘Two-hundred thousand lines,’ said Tzu-li, ‘not counting comments!’ Tzu-ssu responded, ‘Pssh, mine is almost a million&hellip;",
            "tags": [],
            "createdAt": "2020-12-18T15:45:16.345+01:00",
            "readAt": "2020-12-18T15:45:41.884+01:00",
            "archivedAt": "2020-12-18T15:47:10.152+01:00"
        },
        {
            "links": [
                null
            ],
            "pages": [],
            "_id": "5fdcc0b1de09ff30845f9f27",
            "html": "<html><head></head><body> <p>An attempt at creating the longest wall of text ever written. Check out <a href=ltelinks.html>some other LTEs</a>!</p> <p>Hello, everyone! This is the LONGEST TEXT EVER! I was inspired by the various other \"longest texts ever\" on the internet, and I wanted to make my own. So here it is! This is going to be a WORLD RECORD! This is actually my third attempt at doing this. The first time, I didn't save it. The second time, the Neocities editor crashed. Now I'm writing this in Notepad, then copying it into the Neocities editor instead of typing it directly in the Neocities editor to avoid crashing. It sucks that my past two attempts are gone now. Those actually got pretty long. Not the longest, but still pretty long. I hope this one won't get lost somehow. Anyways, let's talk about WAFFLES! I like waffles. Waffles are cool. Waffles is a funny word. There's a Teen Titans Go episode called \"Waffles\" where the word \"Waffles\" is said a hundred-something times. It's pretty annoying. There's also a Teen Titans Go episode about Pig Latin. Don't know what Pig Latin is? It's a language where you take all the consonants before the first vowel, move them to the end, and add '-ay' to the end. If the word begins with a vowel, you just add '-way' to the end. For example, \"Waffles\" becomes \"Afflesway\". I've been speaking Pig Latin fluently since the fourth grade, so it surprised me when I saw the episode for the first time. I speak Pig Latin with my sister sometimes. It's pretty fun. I like speaking it in public so that everyone around us gets confused. That's never actually happened before, but if it ever does, 'twill be pretty funny. By the way, \"'twill\" is a word I invented recently, and it's a contraction of \"it will\". I really hope it gains popularity in the near future, because \"'twill\" is WAY more fun than saying \"it'll\". \"It'll\" is too boring. Nobody likes boring. This is nowhere near being the longest text ever, but eventually it will be! I might still be writing this a decade later, who knows? But right now, it's not very long. But I'll just keep writing until it is the longest! Have you ever heard the song \"Dau Dau\" by Awesome Scampis? It's an amazing song. Look it up on YouTube! I play that song all the time around my sister! It drives her crazy, and I love it. Another way I like driving my sister crazy is by speaking my own made up language to her. She hates the languages I make! The only language that we both speak besides English is Pig Latin. I think you already knew that. Whatever. I think I'm gonna go for now. Bye! Hi, I'm back now. I'm gonna contribute more to this soon-to-be giant wall of text. I just realised I have a giant stuffed frog on my bed. I forgot his name. I'm pretty sure it was something stupid though. I think it was \"FROG\" in Morse Code or something. Morse Code is cool. I know a bit of it, but I'm not very good at it. I'm also not very good at French. I barely know anything in French, and my pronunciation probably sucks. But I'm learning it, at least. I'm also learning Esperanto. It's this language that was made up by some guy a long time ago to be the \"universal language\". A lot of people speak it. I am such a language nerd. Half of this text is probably gonna be about languages. But hey, as long as it's long! Ha, get it? As LONG as it's LONG? I'm so funny, right? No, I'm not. I should probably get some sleep. Goodnight! Hello, I'm back again. I basically have only two interests nowadays: languages and furries. What? Oh, sorry, I thought you knew I was a furry. Haha, oops. Anyway, yeah, I'm a furry, but since I'm a young furry, I can't really do as much as I would like to do in the fandom. When I'm older, I would like to have a fursuit, go to furry conventions, all that stuff. But for now I can only dream of that. Sorry you had to deal with me talking about furries, but I'm honestly very desperate for this to be the longest text ever. Last night I was watching nothing but fursuit unboxings. I think I need help. This one time, me and my mom were going to go to a furry Christmas party, but we didn't end up going because of the fact that there was alcohol on the premises, and that she didn't wanna have to be a mom dragging her son through a crowd of furries. Both of those reasons were understandable. Okay, hopefully I won't have to talk about furries anymore. I don't care if you're a furry reading this right now, I just don't wanna have to torture everyone else. I will no longer say the F word throughout the rest of this entire text. Of course, by the F word, I mean the one that I just used six times, not the one that you're probably thinking of which I have not used throughout this entire text. I just realised that next year will be 2020. That's crazy! It just feels so futuristic! It's also crazy that the 2010s decade is almost over. That decade brought be a lot of memories. In fact, it brought be almost all of my memories. It'll be sad to see it go. I'm gonna work on a series of video lessons for Toki Pona. I'll expain what Toki Pona is after I come back. Bye! I'm back now, and I decided not to do it on Toki Pona, since many other people have done Toki Pona video lessons already. I decided to do it on Viesa, my English code. Now, I shall explain what Toki Pona is. Toki Pona is a minimalist constructed language that has only ~120 words! That means you can learn it very quickly. I reccomend you learn it! It's pretty fun and easy! Anyway, yeah, I might finish my video about Viesa later. But for now, I'm gonna add more to this giant wall of text, because I want it to be the longest! It would be pretty cool to have a world record for the longest text ever. Not sure how famous I'll get from it, but it'll be cool nonetheless. Nonetheless. That's an interesting word. It's a combination of three entire words. That's pretty neat. Also, remember when I said that I said the F word six times throughout this text? I actually messed up there. I actually said it ten times (including the plural form). I'm such a liar! I struggled to spell the word \"liar\" there. I tried spelling it \"lyer\", then \"lier\". Then I remembered that it's \"liar\". At least I'm better at spelling than my sister. She's younger than me, so I guess it's understandable. \"Understandable\" is a pretty long word. Hey, I wonder what the most common word I've used so far in this text is. I checked, and appearantly it's \"I\", with 59 uses! The word \"I\" makes up 5% of the words this text! I would've thought \"the\" would be the most common, but \"the\" is only the second most used word, with 43 uses. \"It\" is the third most common, followed by \"a\" and \"to\". Congrats to those five words! If you're wondering what the least common word is, well, it's actually a tie between a bunch of words that are only used once, and I don't wanna have to list them all here. Remember when I talked about waffles near the beginning of this text? Well, I just put some waffles in the toaster, and I got reminded of the very beginnings of this longest text ever. Okay, that was literally yesterday, but I don't care. You can't see me right now, but I'm typing with my nose! Okay, I was not able to type the exclamation point with just my nose. I had to use my finger. But still, I typed all of that sentence with my nose! I'm not typing with my nose right now, because it takes too long, and I wanna get this text as long as possible quickly. I'm gonna take a break for now! Bye! Hi, I'm back again. My sister is beside me, watching me write in this endless wall of text. My sister has a new thing where she just says the word \"poop\" nonstop. I don't really like it. She also eats her own boogers. I'm not joking. She's gross like that. Also, remember when I said I put waffles in the toaster? Well, I forgot about those and I only ate them just now. Now my sister is just saying random numbers. Now she's saying that they're not random, they're the numbers being displayed on the microwave. Still, I don't know why she's doing that. Now she's making annoying clicking noises. Now she's saying that she's gonna watch Friends on three different devices. Why!?!?! Hi its me his sister. I'd like to say that all of that is not true. Max wants to make his own video but i wont let him because i need my phone for my alarm.POOP POOP POOP POOP LOL IM FUNNY. kjnbhhisdnhidfhdfhjsdjksdnjhdfhdfghdfghdfbhdfbcbhnidjsduhchyduhyduhdhcduhduhdcdhcdhjdnjdnhjsdjxnj Hey, I'm back. Sorry about my sister. I had to seize control of the LTE from her because she was doing keymash. Keymash is just effortless. She just went back to school. She comes home from school for her lunch break. I think I'm gonna go again. Bye! Hello, I'm back. Let's compare LTE's. This one is only 8593 characters long so far. Kenneth Iman's LTE is 21425 characters long. The Flaming-Chicken LTE (the original) is a whopping 203941 characters long! I think I'll be able to surpass Kenneth Iman's not long from now. But my goal is to surpass the Flaming-Chicken LTE. Actually, I just figured out that there's an LTE longer than the Flaming-Chicken LTE. It's Hermnerps LTE, which is only slightly longer than the Flaming-Chicken LTE, at 230634 characters. My goal is to surpass THAT. Then I'll be the world record holder, I think. But I'll still be writing this even after I achieve the world record, of course. One time, I printed an entire copy of the Bee Movie script for no reason. I heard someone else say they had three copies of the Bee Movie script in their backpack, and I got inspired. But I only made one copy because I didn't want to waste THAT much paper. I still wasted quite a bit of paper, though. Now I wanna see how this LTE compares to the Bee Movie script. Okay, I checked, and the Bee Movie script is 50753 characters long. Not as long as some of the LTEs I mentioned, but still longer than mine and Kenneth Iman's combined. This LTE is getting close to 10000 characters! That means it'll be half the length of Kenneth Iman's LTE. That's pretty exciting. Also, going back to the topic of the Bee Movie Script, I tried to write the entire thing out by hand once. But I never finished it, especially since I'm focusing on this thing now. Maybe I should write this LTE out by hand. Nah, I don't think I will. Yay, we're at 10000 characters! Let's celebrate by talking about MUSIC! Music is cool. That concludes our celebratory discussion about music. Thank you, and have a good rest of your day. Hi, I'm back now, and I got a book! It's a dictionary for a language called Elefen. It's like Esperanto, but better. Now I can learn Elefen even without internet! That's pretty cool. I will now write something in Elefen. See if you can understand it! Here goes: Si tu pote leje esta, tu es merveliosa! Elefen es un lingua multe fresca! Did you understand that? Maybe you can't speak Elefen, but you still understood that because of your knowledge of other languages. Elefen is cool because it's an actual language, not an English code like Pig Latin or Viesa. Oh, I forgot to mention that my sister is back from school. She's blasting Rhett and Link songs right now. Have you seen that picture of Rhett and Link standing with a bunch of *******? Sorry, I almost said the F word there. That would've broken my rule of not saying the F word. I wrote something in Elefen, so I will also write something in Toki Pona. See if you can understand it now! sina sona e toki mi la sina pona mute a! I can speak Toki Pona fluently, by the way. It's also a pretty cool language. My sister is still playing annoying songs. It's hindering my focus right now. But it's fiiiiine. Okay, luckily she's run out of songs to play. At least for now. She's trying to think of another annoying song to play. Now she's playing a song by Green Day. Not NEARLY as bad as the other songs she just played. I should go for now. Goodbye! Hello, I'm back once again. I don't know why I feel obligated to say that every time I come back. But I'll keep doing it anyway. My sister stopped blasting annoying songs, so that's good. She's cooking something in the microwave. I'll go check to see what it is right now. Nevermind, it's already done cooking. Right, I remember! It's mac and cheese! Now she just started singing \"I have a tongue, you don't, because I cut it off yesterday\". I don't know what goes on in her mind when she does stuff like that. I've been messing around with my Elefen dictionary for a while, looking up whatever random words I can think of. By the way, the whole reason I'm doing this longest text ever is because of pointlesssites.com. That's how I found the Flaming-Chicken LTE, which inspired me to start writing this LTE. So thanks, pointlesssites.com! I check that website every day to see what new pointless websites they add. You know, I could double every letter I type so that this text would be twice as long as it normally would be. But nah, that's kinda cheating. So I won't. Also, SUBSCRIBE TO PEWDIEPIE! There, I did my part. Not that anyone will read this, but still. 'Twould be nice if you subscribed to PewDiePie. That's another word I invented. Actually, I looked it up, and I didn't invent it. Someone came up with it before I did. That's pretty sad. Also, LEARN VIESA TODAY! IT WILL CURE YOUR DEPRESSION! Seriously though, learn Viesa. It won't actually cure your depression, but I'm desperate for speakers. I only have one other person to speak it with. I should go now. Goodbye. Hi, I’m back. I just came up with an idea: SIMPLIFIED ENGLISH! Or, in Simplified Engish: Simifid Enis. It’s where every group of consonant letters is reduced to the first consonant in that group of consonants, and same goes with the vowels. If a word ends up being just a single consonant with no vowel, put ‘a’ at the end. So “I like eating my waffles” becomes “I like etin ma wafes”. Isn’t it the most amazing thing ever? Nah, it’s not quite as amazing as Viesa. Actually, Viesa isn’t a real language, so it’s less amazing then Elefen and Toki Pona, both of which are cool languages. I kinda figured that half of this text would be about languages. Oh well. I just really want this to be the longest text ever, without using copy and paste, keymash, etc. If you remember, my sister did a little bit of keymash in this text a while ago. I would’ve deleted it, but nah, I didn’t feel like it. And besides, it’s not like it took up half this text. I have an estimate for how long it’ll take me to be the world record holder: about one month. I think I can manage one month of writing this. You know what? I’m just gonna break my rule of not saying the word “furry”. There, I said it. Now I’m allowing myself to write “furry” whenever I want. So with that out of the way, let’s talk about how I first became a furry. For some reason, I have the exact date when I became a furry memorized. It’s May 4, 2018. At that time, I discovered that I was a furry by watching some furry YouTube videos. I knew about the existence of furries years before this, but I didn’t know much about it until this time. I said to myself, “You know what? I’m a furry now,” and that’s what started it all. And I’ve been slowly learning more about the fandom ever since. I would like to participate more in the fandom when I’m older, but I’m too young for most of it right now. Guess I’ll just have to wait. But in the meantime, I can write about it in this text. I should sleep now. Goodnight. Hello, I'm back once again. Happy Pi Day! I memorized a bunch of digits of Pi once, not sure how many I still remember... I have literally nothing to write about now. I've been trying to come up with something for the past 10 minutes, and I still have no idea. Literally nothing is happening right now. It's pretty boring. My sister is watching Friends, as usual. Okay, since there's nothing for me to write about, I should go now. Bye! Wow, it has been a while since I last added to this. It is now July 10, 2019. Last time I edited this page was Pi Day, which was March 14. Those 4 months of this thing being untouched end today! Wait... 4 months? That means I was supposed to get this past the world record three months ago. Oh well. I have put many things into this text. A lot of them were cringy, like how I keep mentioning furry-related things. You know, I should stop putting things in here when I know I'm gonna cringe at them later. I'll try not to do that from here on out. I just know I'll fail though. I'd hate to be aware of someone reading this entire thing... like, if I had to sit and watch a family member or something read this entire text, I would cringe so hard. I would not want that to happen. I am currently pasting the entirety of the FlamingChicken LTE onto a page on OurWorldOfText. The frustrating thing about pasting stuff there is that it pastes one letter at a time, so it takes forever to paste long text. And when the tab isn't open, I'm pretty sure it just stops pasting, so you have to keep the tab open if you want it to continue. Why am I even doing this? No idea. I might not even paste the whole thing. I probably won't. Hey, I just had a thought. What if, in the future, students are reading this for a class assignment? What if this LTE becomes part of the school curriculum? If so, hi future student! I hope you're enjoying reading my CRINGE. What is my life coming to? That's enough writing for now. Goodbye. Hey again. Might as well continue writing in here for a bit. Hey, have you ever heard of 3D Movie Maker? It's a program from the 90s (that still works on modern computers) where you can make 3D animated movies. It's pretty cool. I've made a few movies with it myself, and many other people use it to make interesting stuff. In case you want to try it for yourself, I'm sure if you google \"3dmm download\" or something like that, it will take you somewhere where you can download the program. It's kinda aimed at younger children, but hopefully that doesn't stop you from making absolute masterpieces with this program. I have a keyboard in my room (the musical kind, not the one you type words on), and I don't really know how to play it properly, but I do it anyways. I can play a few songs on the piano (albeit with weird fingering because like I just said, I have no idea what I'm doing), including HOME - Resonance and PilotRedSun - Bodybuilder. You might not know one or both of those songs. If you don't know one of them, why not google it? You will have discovered some new music, and it will all be because of me. Why are you reading this, anyways? How did you even find it? Were you like me, and you were browsing pointlesssites.com, eventually finding the FlamingChicken LTE and going down a rabbit hole of discovering random LTEs? Literally the only reason I'm writing this right now is because that happened. I just discovered a new LTE: the RainbowFluffySheep LTE. I'm gonna see how many characters long it is. 75,957 characters. Pretty long, but not as long as the top two LTEs (FlamingChicken and Hermnerps, both with around 200,000 characters). I wanna write as much as possible into this text today. I'm gonna see how much LTE-writing I can do in one day. Hopefully it's a lot, because I wanna hold a world record! Imagine having a world record. Well, would it really be a world record? Because I don't know of any world record books that have \"Longest Text Ever\" as a record. Oh well, I just hope this LTE passes exactly 230,634 characters. That's all my goal is. I'm not even a tenth of the way there yet, but give it a month and I'm sure I'll get there. Hey, remember last time I said it would only take a month? That was four months ago. I should just stop promising things all together at this point. Forget I said anything about that. Did you know my sister has an LTE? That's right! It's not very long, though, and you can't read it because it's on her phone. She made it while bored at the library. That library was where I used to have web design classes. Those were fun, but I don't do them anymore. Now all I do it sit at home and write stuff in here. Well, I'm exaggerating. I go to the convenience store with my sister sometimes. But that's pretty much it outside of being bored on a computer. I should be a less boring human being. One day, I should translate this entire LTE into Viesa. That would be a big waste of time, even bigger than writing the LTE itself. But I could still do it. I don't think I ever will. This text is simply too long, and it'll be even longer than that by the time I pass 230,634 characters. By the way, if you think I'm gonna stop writing this once I pass 230,634 characters, you're wrong! Because I'll keep writing this even after I pass that point. It'll feel nice to be way ahead the record. My sister's alarm clock has been going off for half an hour and I haven't turned it off. Why? Because LAZYNESS! Actually, I really should turn it off now. There, I turned it off. First when I tried to turn it off, it started playing the radio. Then I tried again, and it turned off completely. Then I hurt myself on the door while walking out. So that was quite the adventure. I'm gonna go sleep now. Goodnight! Hey, I'm back again. My computer BSOD'd while writing this, so I have to start this section over again. That's why you save your work, kids! Before I had to start over again, I was talking about languages. Yes, I decided to bring that topic back after a while. But I no longer want to talk about it. Why? Because it'll probably bore you to death. That is assuming you're reading this at all. Who knows, maybe absolutely zero people will read this within the span of the universe's existence. But I doubt that. There's gotta be someone who'll find this text and dedicate their time to reading it, even if it takes thousands of years for that to happen. What will happen to this LTE in a thousand years? Will the entire internet dissapear within that time? In that case, will this text dissapear with it? Or will it, along with the rest of what used to be the internet, be preserved somewhere? I'm thinking out loud right now. Well, not really \"out loud\" because I'm typing this, and you can't technically be loud through text. THE CLOSEST THING IS TYPING IN ALL CAPS. Imagine if I typed this entire text like that. That would be painful. I decided to actually save my work this time, in case of another crash. I already had my two past attempts at an LTE vanish from existance. I mean, most of this LTE is already stored on Neocities, so I probably won't need to worry about anything. I think I might change the LTE page a little. I want the actual text area to be larger. I'm gonna make it a very basic HTML page with just a header and text. Maybe with some CSS coloring. I don't know. Screw it, I'm gonna do it. There, now the text area is larger. It really does show how small this LTE is so far compared to FlamingChicken or Hermnerps. But at least I made the background a nice Alice Blue. That's the name of the CSS color I used. It's pretty light. We're getting pretty close to the 1/10 mark! That's the point where we're one tenth of the way to making this the longest text ever, meaning all I have to do is write the equivalent of everything I've already written so far nine more times! Not gonna make any promises, though. How come every time I try to type \"though\", it comes out as \"thought\"? Why do I always type the extra T? It's so annoying that I have to delete the T every time. Okay, only mildly annoying. Not as annoying as I previously described. I apologize for my exaggeration of the annoyance level of me typing \"thought\" instead of \"though\". I just realized that most of the games I play are games that I've been playing for at least six years. I started playing Garry's Mod in 2013, Minecraft in whatever year version 1.2.3 came out. Now I have to look that up. March 2, 2012. So I started playing Minecraft approximately during that time. Wow, seven years ago! Coincidentally, I was also seven years old then. I remember the days of 2012-13. That was when I still played Roblox and made terrible YouTube videos. I was called \"Infinite Budgets\" back then. I also remember the days of 2016. A lot of people thought that was a terrible year, but for me personally, it brings me a lot of nostalgia because I talked a lot with my online friend at the time, and I did livestreams on YouTube and stuff. It was fun. 2016 was also when I got the phone that I still have to this day. Yup, my phone is three years old. My life was completely different when I got this phone: I was 11 years old, my YouTube channel actually had activity, and I wasn’t writing this text. I’m currently writing this in the car. We are on out way to the dollar store. And since I’m writing this on my phone, I’m making a lot more typos than usual. Some of them might make it through, so be prepared for that. Anyways, we appear to be getting close to the dollar store. I have a gift card for that place. I think so anyways, it might be for a different store... Yup, this dollar store is different. Oh well. My sister has an obsession with sponges. I’m sure she’s gonna find the sponges and go crazy over them. Why does she like sponges so much? No idea. She just found a bag of tiny baby dolls, and she wants to put them in ice cubes and call it “Ice Ice Baby”. She is truly a strange human being. My sister also has an obsession with stuffies. She has such an addiction, that she’s banned from them. Now she found the wigs and she’s considering buying one. She’s been looking at them for quite a while now. We’re out of the dollar store, and now we’re going to the computer store. I have no idea why we’re here. I guess we just are. Now we’re going home. Welp, that was a fun adventure. Stay tuned for more fun adventures as you read through this LTE. I should go now. Bye! Hello again. I made a private world on OurWorldOfText for my sister and I, but she doesn't want to join it. She doesn't think it'll be fun. Now I'm just editing it alone. How sad. But oh well. Now I’m here adding more to this text. I once made a Discord server specifically for a language called “Bo”, where the only word is “bo”. I made it almost four months ago, and somehow, it’s still going. People are still spamming nothing but “bo” there. It’s great. I also once made a server where you’re not allowed to use any vowels. It was a very strange server. I deleted it after some time though, so all that insanity is no more. I also used to own a Pig Latin server, but it got inactive so I deleted that too. We had some good memories in that server though. Now there’s a new Pig Latin server, but it’s not owned by me. Dang, my YouTube channel has been dead for so long. I haven’t posted a video in a year. I want to revive it, but I don’t know what to post there. I’ll figure it out. I doubt my channel will ever go back to it’s 2016 legacy, but I’m sure I’ll post something eventually. Random fact of the day: there are thirty-nine question marks so far in this text. Am I about to make it forty? Yes, I just did. Now the fact I initially stated is no longer true. Or is it? Because I said “so far” in the fact, that implies that we’re talking about the moment that fact was said, disregarding any future events. Now I’m pretty sure that fact is still technically true. Welp, I guess I should just accept that I’m editing that world of text alone for the rest of my life. I originally put a bunch of complaining in there, but I deleted it all. The thing is, now that world will never be same without all of that complaining about my sister not being here. But that’s fine. Hey, I just had a cool realization. Basically, there’s this conlang (constructed language, for those not in the know) server where we have a Sentence of the Week activity. In this activity, someone posts a text with a maximum of nine sentences, then people translate it into their own conlangs. My realization is this: if we take nine sentences from this LTE every week, there would be a whole year of sentences for people to translate. There are approximantly 523 sentences in this LTE. Divide that by 9 sentences each week, and you get 58 weeks worth of sentences, which is approximantly the number of weeks in a year. Quick maths. I actually suck at math, but that’s besides the point. I should go now. Goodbye! Hello, I’m back again. I really need to come up with different hello and goodbye messages, because I’ve already said “Hello, I’m back again” once before. Same with the “I should go now. Goodbye!” I said at the end of the previous section. I was going to explain what a “section” is, but I’m terrible at explaining things, so I’m not going to anymore. I guess you’ll just have to figure it out yourself. It’s probably not very hard to figure out, anyways. I guess I can just say that a section starts with me saying hello, and ends with me saying goodbye. That should be enough explaination, now that I think about it. Hey, do you ever feel like you never have any idea what you’re talking about? That’s my entire life. I just summarized it all in one sentence. On an unrelated note, I feel like half this LTE is just me talking about the LTE itself. I mean, press CTRL+F on this webpage, then type “LTE”. Look at all the times I use it in this text! Not counting the ‘lte’ in the word ‘multe’, of course. Dang, now the search results will include that, too. Anyways, half of this text is just me talking about how I’m trying to get this text to be the longest. Well, the longest LTE, anyways. I still have a long way to go. I’m only 12.7% of the way there. I mean, minus the four month gap, my estimation is that I’ve only been writing this for not even two weeks. So it makes sense that this LTE isn’t very long yet. Whenever I look at this webpage, it looks long at first glance, but the longer I look at it, the more I realize how short it actually is. It’s something that I can’t explain. For real this time. I just realized that none of this is helping the fact that half this LTE is about the LTE itself. I should bring up a new topic, but I don’t feel comfortable talking about much else. Why? Because, like I said, I never have any idea what I’m talking about. Most of this LTE is just me talking about LTEs or languages. Sometimes furries, but I don’t wanna go back into that territory at this point. But it doesn’t matter, because I’m still gonna write this LTE for as long as possible, even if it means talking about the same things half the time. Also, LEARN VIESA! Haven’t said that in a while, so I might as well bring it back. The documentation for Viesa is on this very website, so go ahead and read it! You might need to know some linguistic knowledge to understand it, though. In fact, you probably won’t understand most of it unless you know some amount about lingusitics, so you have been warned. If Viesa is too much for you, Pig Latin will probably be better for you. If it's so easy that kids can learn it, you can too! It's a language you can learn in probably five minutes, so why not give it a try? You may also enjoy Ubbi Dubbi, where you place 'ub' before every vowel sound. It's also a very easy language to learn, although not quite as popular. The thing is, none of these are even real languages. They're just codes, and very simple codes at that. You could probably crask Pig Latin or Ubbi Dubbi rather easily. Viesa too, actually. But I still enjoy them occasionally, even if Pig Latin and Ubbi Dubbi are inefficient and easy to crack, and Viesa is easy to crack yet unneccesarily difficult. I do make real languages, but I never put in the effort to learn them to fluency. At least I make them at all. Here’s a fun game: I will open up a random page from a book, and tell you the first word I see. English. That’s the word. Stay tuned for more fun games as you read through this LTE. We’re back, and we’re gonna play the same game as before. Ready? Subject. Now we’re gonna do it again. Reading. And again. Itself. Constituent. Grammar. Colloquial. Black. Outline. Add. About four of those words were language related. You’ll never guess why! (Spoiler alert: it’s a conlanging book). I’m running out of ideas now. I’m just gonna generate a random word and try to talk about it. Forbid. That’s the opposite of “allow”, I’m pretty sure. I don’t really know what else to say. Well, I guess I failed at generating a topic I could talk about. You know what's weird? My favorite word hasn't been used once in this entire text. I'm about to change that forever. Epic. Yup, my favorite word is \"epic\". I use it on a regular basis. I say \"That's epic\" all the time. It's a word I can't live without. Hey, I've now written more of this text after the 4 month gap than before it! Just thought I'd share that fact. Also, I'm gonna try and write as much as possible in this LTE today. I've already written more today than the day I first said I was gonna write as much as possible, so that's a good sign. The thing is, I don't know what to write about. I need to write about something, otherwise I won't write at all and I won't accomplish my goal. Wait, what goal should I set? How many characters should I write today? I'm gonna try and get 10,000 characters. I've already written almost 5,000 today, so from here I just have to write the equivellant of everything I've already written today. I'm just gonna try it and see if I make it. Maybe sometime in the future I'll do a bigger goal, like 15,000 or even 20,000 in one day. Actually, I don't know if 20,000 would even be possible for me. It might be, but it sounds like somewhat of a stretch for me to write that much in a single day. We'll see how long 10,000 takes, though. I'm already doing a bad job at this. I haven't typed anything here in several minutes. I need a topic. Um, Vabungula, I guess? Basically, it's a conlang created by Bill Price in 1965. It amazes me how one can work on a single conlang for that long. Most of the conlangs I start making die after 15 minutes. Anyways, I really like it because... um, I don't know, actually. There's not really anything about it that's super interesting (other than how long it's existed), it's just his personal conlang. Maybe it's the amount of development that went into it. It has over 5,000 dictionary entries and several texts written in the language. I'm sure most people reading this don't care about my language related talk, but I gotta make this long. I'm desperate to reach my 10,000 character goal. I've got 4,000 to go. I just found a website that generates random art from a seed. I just put this entire text as the seed, and it generated something quite nice. I would put the picture here, but I want this LTE to be nothing but text, so I won't do that. I've been playing with this for a while now. Many of the seeds produce boring pictures, but some of them are nice. For example, I just used \"e\" as the seed and it produced a nice looking picture. \"a\" looks nice too, arguably nicer. I've been using nothing but the word \"nice\" to describe these pictures. Maybe it's time to get a bigger vocabulary? \"b\" looks, um, good? I don't have the right vocabulary for this. I also don't feel like doing every single letter, because the pictures take some time to generate. But if you want to do it for yourself, just go to random-art.org and try it out! By the way, this is another website I found through pointlesssites.com. You know, the same website that lead me to the FlamingChicken LTE, which lead me to begin writing this whole thing. But what made me discover pointlesssites.com? Vsauce mentioned it. But what made me discover Vsauce? YouTube Reccomendations, probably. But what made me discover YouTube? As far as I remember, my dad showed it to me when I was 6. So I would like to thank my dad for being the reason I started writing this. He's the one who showed me YouTube, which reccomended me Vsauce, which mentioned pointlesssites.com, which brought me to the FlamingChicken LTE, which inspired me to start my own LTE. If he had never shown me YouTube, I wouldn't be here writing this text, and you wouldn't be reading it. Well, that's probably not true, because I probably would have discovered YouTube by other means, thus leading me to Vsauce, leading me to Vsauce, leading me to pointlesssites.com, leading me to the FlamingChicken LTE, leading me to... okay, I really need to stop now. I've gone too far. But you know what I haven't gone too far with? This LTE. I don't think I even can go too far with writing this text. Unless this text gets so long that it surpasses the 1GB storage limit of Neocities. In which case, I'll need to upgrade to Supporter in order to get a 50GB storage limit. But what if the text gets so long that is surpasses that? I don't think I'll ever make it there. I mean, 50GB is about 50 trillion characters. So I think we're good. I still need to get to 10,000 by the end of today. I've got 1,500 to go. Currently watching a livestream. It's reminding me of when I used to livestream back in 2016. I still kinda miss those days. But at the same time, I was quite awkward and had zero social skills, so I'm not sure if I'd want to go back. At this point, everything I've written today is longer than what can fit on the screen at once. At least on my computer screen. It probably changes with different screen resolutions and devices. But anyways, it's pretty unusual for that much of the LTE to be written in a single day. I don't want to pressure myself into writing this much every day, though. Last time I forced myself to complete a certain amount of something every day, it was overwhelming and I ended up losing motivation, thus letting down all my fans who were anticipating the August 30th, 2016 release date. Okay, the amount of eager fans was probably a number you could count on one hand, but still. By the way, if you're wondering what this \"something\" was, it was GoAnimated Garbage: The Movie, which was supposed to be an hour long episode of a series I made to make fun of random GoAnimate videos. In case you're not the type of person who knows what GoAnimate is... hoo boy. Basically, it's a drag-and-drop animation website infamous for the \"grounded videos\" that people made with it, among other types of videos. It's this whole community that I neither can explain nor want to explain. But I had somewhat of an association with that community back in the day. On my YouTube channel, I used to make a genre of GoAnimate video known as the \"OS video\". Typically an OS video is where some sort of hated character within the GoAnimate community forcefully installs their operating system onto a user's computer, and the user has to deal with this OS until they eventually find a way to \"destroy\" it. I made five of these videos. In chronological order: Caillou OS, Boots OS, Franklin OS, Little Bill OS, and Crap OS X. Caillou OS is the most viewed video on my main channel, which is unsurprising since Caillou is pretty much THE character associated with the GoAnimate community. When I made that video, it was a big transition for my channel. The channel's name was changed from Infinite Budgets, which had been my name since 2013 when I made crappy Roblox videos, to Allisima. All of my old videos were deleted, with the exception of my \"Barney Errors\", which was yet another genre of GoAnimate video. Basically, a Barney error is when a user's computer/console/whatever session is interrupted by a \"Barney Error\", a message informing the user that Barney has been killed, and the device must not be turned off because it's an \"important message\". There's also a bomb that's placed in Barney's \"lair\", the timer for which is displayed in the error. The user gets some amount of \"chances\", and every time the device is turned off, the user looses a chance and the time until the bomb explodes decreases. Eventually, the user turns off the computer enough times that there are no more chances left, the bomb explodes, and some sort of punishment happens. These punishments can range from having to downgrade your operating system, to having your computer destroyed, and in extreme cases, even to death. I once made a whole channel for Barney Errors, where I made about twenty of them before quitting. After that, I eventually quit GoAnimate all together, but I still made Crap OS X, an OS video made with Powerpoint. I also made an interactive OS parody called Windows Poop Editon, again with Powerpoint. Before that, I also made one called \"Atch OS\" using my old Windows XP netbook. I just checked to see if my old Weebly website still exists, since there's an Atch OS download on there and I wanted to see if it dissapeared from existence or not. Appearantly it does! I'm getting so much nostalgia from this website. It's like a window into 2016, when I had fun making these videos on a regular basis. I'm way past my 10,000 character goal now. I'm kinda glad I set this goal, but again, I'm not gonna force myself to do it everyday. I think I'm gonna stop writing for today. Bye! Hey, I'm back. Yes, that hello wasn't original either, since I already said it once. Specifically, after my sister seized the LTE and started spamming. You remember that, right? I hope you read through this whole thing instead of just picking a random part (which just happened to be this part) and reading only a tiny bit. Nah, I'm just kidding. Read this text however you want to, it doesn't matter if you read this entire text from start to finish or not. I mean, I did put some cringy stuff in here, as I keep mentioning. But it's on the Internet, and since recently, on my homepage, so I know people are gonna read it. Really the only reason I'm making this is because I have a weird obsession for writing giant walls of text. Guess what? I just added translations of this LTE into various conlangs on my website! But they're all very incomplete, and I probably won't finish them ever... I mean, if I'm gonna finish any of them, 'twill probably be the Viesa translation since it's the easiest to do. Hey, 'twill's back! I remember the very beginnings of this LTE, when I first mentioned 'twill. That was 40,000 characters ago. Appearantly I'm measuring time with characters now. Hey, what's the average amount of text I write per day in this LTE? The four month gap probably significantly drops that amount. Let's see! The trouble is finding out when I started writing this LTE, because I don't know the exact date. I'm just gonna estimate that it was March 12, based on the amount of times I said goodnight before I said \"Happy Pi Day\". It's not a very accurate measurement, though, because sometimes I stop writing for the day without saying goodnight. But anyways, from March 12 to today, July 16, is 127 days. As of that previous sentence, there are 42,549 characters in this LTE. 42,549 characters divided by 127 days equals about 335 characters per day. That's not very much at all. To get an idea of how short that is, the first 335 characters of this LTE consist of about 64 words and 8 sentences. As I predicted, the four months of no activity had a big impact on this number. But what if we ignore the 4 month gap, which was from March 15 to July 9, I've only been working on this LTE for ten days. 42,549 characters divided by 10 days is about 4254 characters. That's much better. It might be that big because of the 12,600 characters I wrote yesterday. I said I wouldn't do it every day, but honestly, I'm feeling like doing a goal again today. I think I might even go a bit higher than yesterday. Let's do 15,000 characters! I have zero life outside of this LTE, anyways, so I think I'll make it. As long as I keep typing about random stuff for the entire day, I'll probably get past 15,000 easily. I think I'm insane. Literally all I do anymore is write this LTE. My mom is almost certainly concered for me, because I was in my room pretty much all of yesterday and my sister told her about how I'm trying to write the longest text ever. But enough about my descent into insanity for now. Let's get this LTE to over 55,000 characters today! This is probably the most meta LTE in existence. Like I've said, I talk about the LTE itself as much, if not more than anything else. By the way, if I were to write as much as I did yesterday every day, I would reach my goal in just 15 days. Now I'm tempted to do that, even though I said I wouldn't set a goal like that every day. I think I might end up doing it subconciously. I kinda wanna convince some other people I know online to start their own LTE. Wouldn't it be fun if we all had our own LTEs? They would probably all die within a day, but at least I wouldn't be the only one writing an LTE in 2019... The most recently updated LTE I've seen is the RainbowFluffySheep LTE, which I believe was last updated in late 2018. That wasn't really that long ago, but still, I don't think it's being updated anymore. Now let's do an LTE Timeline! The original FlamingChickens LTE was probably started sometime in 2004, and Hermnerps was started the same year. The FlamingChickens LTE stopped in 2005, while the Hermnerps LTE actually lived on until 2009, although edits after the end of 2004 were rather sparce. The Kenneth Iman LTE was started in 2013 and was last updated in 2015. The RainbowFluffySheep LTE both started and was last updated in March 2018. And of course, the WhileTrue LTE was started in March 2019 and is still being updated today. Wow, 15 years of LTEs! I think my LTE is the only one still being updated. It would be nice if someone else was writing their own LTE along with me. But 'twill be hard to convince other people to waste their lives writing a useless wall of text. You never know, maybe an LTE that stopped being edited years ago will come back from the dead. That seems kind of unlikely though. Very strange fact incoming. A certain word has not been used since the very beginning of this text. Ready to learn what it is? I shouldn't tell you, actually. Of course, that would ruin it. Unless you want me to ruin a really cool fact. Surely you wouldn't want that to happen. Okay, I'll just tell you, because I'm probably gonna end up using it again someday or another. The word is \"various\". If you search for \"various\" in this LTE, you'll only find it at the very beginning as well as here. And I was gonna keep this a secret, but just now I did this thing where if you take the first letter of each sentence, it spells out \"VARIOUS\". Kinda clever... I guess? Anyways, for those who are insane enough to be reading this entire thing from the start: Wow, you have quite the dedication. My LTE isn't even the longest yet, but perhaps in the future, when it is the longest, people will be challenging themselves to read the entire thing. And maybe you're one of them! Perhaps you're reading this long after I've passed my goal, in which case you still have quite a bit to go. So I wish you luck on your Longest Text Ever reading adventure! I've been talking about LTEs all day. For the past 6,000 characters, in fact. I need to find something different to talk about. But first, I just had an idea pertaining LTEs. I should compare this LTE to the longest joke in the world! The longest joke in the world is 56,554 characters long, which is about how long I'm trying to get this LTE by the end of today. So if I reach my goal today, this text will be longer than the longest joke in the world! That's pretty cool. I would also be a quarter of the way to my goal. But let's get back to finding something different to talk about. I can't think of anything. My sister is singing a song about wanting Subway. I will never understand her. What goes through her brain that makes her decide \"Yeah, I think it would be a good idea to sing about how I really want Subway\"? I don't get how her brain works. She also likes eating paper. I asked her and appearantly she was perfectly okay with me writing that in here. She probably thinks nobody's ever gonna read this. But she's gonna be wrong! Eventually. Now she's asking me to write about how she likes yogurt. \"Because I didn't used to\", she says. She's eating mango yogurt, and she has water in a Gatorade bottle. Now I'm asking her what else I should put in this text. She says I should write about how there's wild sage where we live. Now she's having hot chocolate. She didn't ask me to write that, but I told her I was going to write it and she said okay. My sister might start her own Longest Text Ever, again. She says it will have only one word repeated throughout the entire text. But I told her that it defeats the purpose of an LTE. In the original FlamingChickens LTE, one of the very first things that is written is \"I will just type, and type, and never, ever use copy and paste\". Okay, I just made a webpage for her LTE (it's gonna be an actual LTE this time). Stay tuned for \"The Best Longest Text Ever\", as she calls it. I think it should have just been called \"KKs Longest Text Ever\" or something, but whatever. She types really slow, but I hope her LTE will be successful nonetheless. Warning: if you do go and read her LTE, she spoils Spiderman: Far From Home at the very beginning, so be careful about that. In fact, she's basically typing the entire plot of the movie. Well, that's one way to increase your LTE's length, I guess. My sister is listening to her terrible songs instead of writing her LTE. Well, she has her LTE page open, but she's not writing anything and is singing instead. Actually, she's writing stuff now, so ignore everything I said previously. She's still writing the entire plot. Her LTE is now 2,000 characters, which isn't very long, but she's only been working on it for an hour. Plus she's a slow typer. She types everything with one hand. It might take a while for her LTE to get to this level. But assuming she keeps writing it and doesn't forget about it after today, it'll get pretty long eventually. I still need to write 7,000 characters today. My sister is watching a cringy video made by our old elementary school. They became a French immersion school after I left. She found one of the videos I was in... oh god, I can't stand to look at that video. It hurts me to think about those days. My sister's LTE webpage has text now! Maybe I should create a page linking to all the LTEs I know about. I think I'll do that. Boom, it is done. I think I'm gonna also put a link to it on this page. There, that's done as well. Guys, I'm not sure if I'm gonna make it to 15,000. I still have 5,000 characters to go (I was completely off earlier, I don't have 7,000 left to go), and there's not much left of the day. In retrospect, it was probably a bad idea to make a goal for the day in the first place. After all, LTE writing is supposed to be fun! Sort of. There's zero need to make unneccesary deadlines. I think it just reduces the fun, as well as the part of my life that isn't just writing huge walls of text. From here on out, I declare character-per-day goals abolished. I will no longer make attempts to write a certain amount in a single day. I should have listened to my past self, who said not to do goals every day. But I didn't, and now I regret it. But anyways, here's a fun fact about this LTE: excluding my upcoming usage, the pronoun \"he\" is only used twice in this LTE, and they both refer to my dad. On the other hand, the pronoun \"she\" is used forty times! Almost all of these refer to my sister. Only one refers to my mom. I guess I just really like talking about the weird stuff my sister does. But not as much as being meta and talking about my own LTE. Here's another fun fact: \"LTE\" is the fourteenth most common word in this text! That's insane. It's more common than words you'd expect to be common, like \"you\", \"I'm\", \"for\", \"be\", \"about\", \"was\", and so on. I really need to talk about other things once in a while. But since I have zero creativity, I always resort to talking about the same topics. From what I've seen, most other LTEs are pretty diverse, but mine isn't at all. Honestly, this is likely the most boring LTE to read. But my absolute lack of creativity means it's probably gonna stay that way for a long time. I'm tired, so I'm gonna go to sleep. Maybe I'll be more creative by tomorrow. Probably not. Anyways, goodnight. Hey, I'm back, and I don't feel any more creative. But I did have a dream last night, so I'm gonna talk about that. Last night, I dreamt that I was in one of our old houses, and I saw that someone made a video roasting Viesa. They talked about how you shouldn't say \"dog\" in Viesa, because appearantly \"deeg\" is bad or something? I don't know. Then they said the rule where W becomes V is weird, but I don't remember the reason they said it. I didn't really care about how they roasted my language. Then I watched a Minecraft video for whatever reason, and then the dream ended. How do other LTE writers have so many topics to talk about? All I ever talk about is either LTEs themselves, or the fact that all I ever talk about is LTEs. There's no diversity. I very rarely talk about anything else. And when I do, it's usually about languages and lasts only a few sentences. There, I deleted it. Oh, you don't have any context. Basically I wrote a bunch of depressing stuff, then I decided to delete it all. I knew I was going to regret it later, in the same way I regret writing all that stuff about furries. Not that I think there's anything wrong with being a furry, it's just that it personally makes me uncomfortable looking back on it. I'm not even into that stuff as much anymore. I don't watch furry YouTube, and I don't talk about how much I want a fursuit/go to a convention. That's a part of me that's slowly disappearing. Okay, I'm gonna stop talking about that, because I literally just said how I regret talking about it in this text. You know, I've been feeling kind of down about this LTE lately, because as I just mentioned, all I ever talk about is this LTE itself, there's no diversity, blah blah blah. It's especially been like that ever since the four month gap. In fact, I barely talked about LTEs before that gap. It's like I lost all my creativity after four months. You know what? I'm officially gonna say this: If, for some reason, you are reading this before you decide you want to start reading this entire text, READ EVERYTHING FROM \"WOW, IT HAS BEEN A WHILE\" TO HERE AT YOUR OWN RISK, BECAUSE YOU WILL LIKELY DIE OF BOREDOM DUE TO THE MONOTONOUS TOPICS! There, now I'm gonna try and forget that half this LTE is the same exact boring topic. I will also try to avoid writing about the same exact boring topic for the rest of this text. Let's celebrate the End of Monotonous Topics (EMT) by talking about how we (my sister and I) had lunch and did various other things with our grandpa! So grandpa asked if we wanted to have lunch and spend an afternoon with him, and we said yes. Then he picked us up, and we went to a nearby town where we had lunch, went to a museum which was a house built in 1909 as well as the town's first hospital, and got ice cream from what is appearently one of the best ice cream places in the country, according to grandpa. So today was a fun day. I'm gonna go now. Bye! Hey, I'm back. That's the fifth time I've said that. I need to come up with more original... nah, whatever. Anyways, I had a dream last night which was basically a whole movie I don't remember most of. All I remember is playing a keyboard at the store for some reason, and that the dream ended with a random car horn. Oh, and there was Minecraft involved in the beginning, which I'm pretty sure is becoming a recurring theme in my dreams. I don't know why that happened, because I rarely play Minecraft anymore. Do any of y'all remember the DVD screensaver meme? That was one of my favorite memes. For those who don't know what I'm talking about, many DVD players had this screensaver where it was a DVD logo bouncing around the screen. The big moment that everyone anticipates is when the logo hits the corner of the screen perfectly, because, well, it's just so SATISFYING! I used to watch a livestream that was literally just this screensaver running endlessly. And when it hit the corner, it was a huge celebration for both me and everyone else watching. I got so excited when the logo hit the corner. My computer's screensaver is even still a DVD screensaver. But nowadays when I see it hit the corner, I don't have as much enthusiasm as I used to. I've just seen it too many times for it to be exciting anymore. Plus, the meme isn't even a thing anymore. I doubt that livestream is even still running. But you never know, so I'm gonna check to see if it's still going. Oh wow, it is! That was the last thing I expected to see in July 2019. But only four people are watching it, which makes sense. The title now says \"DVD Logo Screensaver For 1 Year\", even though it hasn't quite been going on for a year. But when it hits that point, perhaps that's when it will finally end? It should have ended months ago, if you ask me. Yup, I was right. There's a countdown on the livestream to when it ends, and it says 181 days, 9 hours, 12 minutes, and 3 seconds. Wow, the corner hit and wall hit numbers are much bigger now. The most corner hits I'd seen is around 1400 or so, but now it's at 4776! The wall hits used to be in the hundred-thousands, now it's at over two and a half million! Hello, I have returned. There, I came up with something original to say! Anyways, I just combined every single LTE I know of (including this one) and put it onto one single page on a Wikia wiki called \"No Rules Wiki\". That wiki exactly as you would expect from the title. I found it a while ago, and I thought it was about time I made a contribution, even if pasting over half a million characters into a single article is breaking some rule... I've been wanting to make Viesa an actual conlang for so long now. I think it's long overdue at this point. Hey, I'm back again. These sections are getting shorter and shorter each day. But oh well. I just discovered how much I like the word \"number\". I don't know why, but it's just so fun to say! I think I've liked that word ever since I was a toddler learning my numbers! I remember thinking it was a fun word even back then. At that time I had two little electronic toys: one was orange and for numbers, and one was purple and for letters. I'm pretty sure those were the colors. I also vaguely remember having a fan that lit up and displayed custom messages. I haven't seen anything like that since then. All I hear right now is Baby Shark being blasted upstairs. You know that song, right? I don't know who doesn't know it at this point. I can't think of a single person I've seen that doesn't know what that song is. Dang, ever since the EMT I haven't been writing as much in this text. Looks like LTEs were all I could talk about. Oh well. How many times have I said \"oh well\"? Probably a lot. About eight times, in fact. I'm back again. I went a full day without writing anything into this LTE yesterday! There were a lot of things happening that day, so I didn't feel like writing. I could've written at least a little bit, but I didn't. Time for me to use this LTE as my dream journal yet again! I had a dream where my domain was \"exin\" (or something like that) instead of \"whiletrue\", so that was a thing. I also had a dream where there was this game that I thought existed in the real world, but it didn't. Dreams do that sometimes. I don't remember much about the game, but it involved the Simpsons, I guess? Also, I was in a weird store where they had an... iCarly laptop? And a bunch of gift cards. That's all I remember. For now, at least. My sister does not like synthwave. She says \"it's repetitive\", \"the sounds they use don't sound like music\", and she doesn't like how it doesn't have lyrics. First of all, she's hypocritical because she always listens to the same songs on repeat. And why does it matter that it doesn't have words? Why does she think every single piece of music in existence has to have words? YOU BETTER WATCH YOUR OPINIONS THERE! (That was a reference to a cringy GoAnimator that no one reading this will get, unless you came to this website from my YouTube channel which you subscribed to during my OS video days). Anyways, synthwave is objectively the best genre of music. I remember hearing HOME - Resonance for the first time in a Discord voice chat, and it was magical. I wish I could listen to that song for the first time again. That was how I got into synthwave. You know what my favorite color combination is? Yellow text on a magenta background. Oh, and don't forget the Comic Sans. That is just pure beauty right there. In fact, it's used in the first frame (well, close enough) of \"history of the entire world, i guess\", which makes me love that video even more. We're at 60,000 characters, 1,000 sentences, and 12,000 words! Weird how all those counts hit such round numbers in one day, huh? I need to stick to the EMT, so I should stop talking about that. My sister is attempting to build a Lego city. Her goal is to have three buildings, since she doesn't have THAT much Lego. Have you noticed how quickly I've been switching topics in this text? That's because I can't talk about anything for a long time. That is, unless that thing is languages or LTEs. I am currently trying to revive a language my sister and I started making a while back. Sometimes my sister has days when she doesn't hate languages for some reason, then she ends up starting one. But of course, she regained her hate and abandoned it. Now I'm the only one working on the language. By the way, the language is called Lazay, which was the successor to Zula, the first language we made together which is now deleted. We started writing the language on paper, but then I started a Google Doc. I'm sure the papers are still here somewhere. I'm just too lazy to find them. I’m back again. I haven’t been ending these sections with goodbyes recently. But whatever. We’re on our way to IKEA to get a dresser for my room. We’re listening to Queens of the Stone Age right now, and I’m just waiting for “Fortress” to come on. I sing that song in Viesa, but I make up half of the lyrics. It goes: Ванавар јак фиртрас кува, ма башег ђара, ја сок. Try and translate that! The song is playing now. I like this song. We’re back from IKEA now. Actually, we’ve been home for hours now, and we’ve already built the dresser. My computer crashed (but don’t worry, I started writing this in Google Docs on my phone), and now Google Chrome won’t open. So I have to use Microsoft Edge for now. I’m gonna sleep now. Goodnight! Hello, I'm back. My sister is brushing my back with a hairbrush, and I don't know why. I asked her what I should write about (because I have zero creativity), and she said I should write about that. I'm gonna type whatever comes to my head now. Hi, I'm a boring human being who has zero creativity whatsoever and still happens to be writing an LTE. Isn't that insane? How could this be? Nobody knows, and nobody will ever know. It is a strange mystery that has yet to be solved. Hmm, I wonder if I should go and eat pancakes now? I'm so random right now. In fact, there's an entire subreddit for that: r/iamsorandom. You should check it out! I mean, you don't really have to, but it would be nice if you did. I use Reddit a lot, but I only use it for language-related stuff. Well, I make posts in language-related subreddits, but the non-language subs that I look at are ones that I don't post anything to, because I know nothing about literally anything that isn't languages. And heck, I don't even know much about languages! I only make English codes and call them \"conlangs\". Sort of. I usually don't actually call them conlangs, but I use them for such purposes. I speak Viesa as if it were a real language, but it simply is not. Why did I make Viesa in the first place? Well, you see, it all started out as a joke for April Fools' Day. I called it \"the new universal language\", despite it literally being a cipher of English. What!? A cipher of English being a universal language? How silly! What a funny joke, right? Maybe? Somewhat? Anyways, I then made a SECOND VERSION! DUN DUN DUN! This second version had CLICKY SOUNDS which, spoiler alert, dissapear in the next version of Viesa. Sad, right? RIP CLICKS 2018-2018 NEVER FORGET! I also added WACKY GRAMMAR STUFF and PRONOUNS! WOAH! How crazy! Then I made the next version: VERSION 3.0! This version added CYRILLIC! (you know, that alphabet the Russians use, as well as the Serbs, whose version of the Cyrillic alphabet I stole for Viesa. Hehehe!) And that's the entire history of Viesa, explained in a Zany way! Do you like how I capitalized \"Zany\" there? Aren't capital letters so cool? They let you YELL AND SCREAM AT THE TOP OF YOUR LUNGS! They add EXCITEMENT! And most of all, they let you capitalize words like This. lowercase letters are also cool. without them, we'd all be yelling and screaming all the time. That would be pretty tiring, wouldn't it? I see two water bottles. One is empty, while the other still has some water in it. The empty one is blue, and the one with the water is pink. I should also mention that the blue one is mine, while the pink one is my sister's. I got that water bottle because I lost my other one at school. But GUESS WHAT? I FOUND IT IN THE LOST AND FOUND! Wow! Now I had two water bottles. How Wacky and Crazy and Zany and Bizzare and all those adjectives that perfectly describe this epic moment! Wow, writing your mind is a great way to increase your LTEs length! Before I was actually THINKING about what I was writing. But now I barely do, and it's greatly improving my LTE! Except the overuse of capital letters might throw the reader off guard a little because of how sparingly I've used them in the past, but oh well. I could fix it, but I don't feel like it. I want to continue writing, but I need to sleep now. Goodnight! Hi, I'm back again. My computer crashed AGAIN, and I was ignorant enough to not save my work, so that means I have to start this part of the text all over again. That's quite unfortunate. But did I mention that my Google Chrome is working again? That's the good news. It's good news because Google Chrome has all my logins, websites, and stuff like that. Hopefully you know what I mean when I say that. Maybe you do, maybe you don't. I don't even know what I mean right now! I'm probably insane right now. Especially since I'm writing this right now, as I have been for about 18 days minus the four month gap... I think. I hope I did that right. As I've said before, I'm bad at math. My sister just read the entirety of what I've written today for some reason. My sister just sang \"I want your computer to crash again because I'm evil\". She IS evil if she wants my computer to crash. At least I'll have this section saved. In fact, right now I'm pressing Ctrl+S after every sentence! Including this one. And this one. Also this one. I think you get the point now. My sister keeps typing into this LTE without my consent, and I keep having to delete it all. It's pretty annoying. Hey, flashback to when I said that way at the beginning of this text! You know, the part where I talk about the Teen Titans Go episode called \"Waffles\" where the word \"Waffles\" is said a hundred-something times. You know what else is said a hundred something times (in this LTE)? The letter J. So far it's been used 115 times in this LTE. That's your Interesting LTE Fact of the Day! Well, not really \"daily\", but whatever. Here's a story: Once upon a time, people got tired of starting off their stories with \"Once upon a time\", so they stopped doing that. But one person decided not to stop using \"Once upon a time\", and used it at the beginning of this story. And that person is ME! The end. Wasn't that a lovely story? You're probably not thinking that. Again, I'm not creative in any way whatsoever. That's why I don't usually write stories and instead write giant walls of text full of meaningless information, like the one and only WhileTrue's Longest Text Ever that you're reading right now. Hopefully nobody died of boredom from reading between \"Wow, it has been a while\" and the EMT. That's the most boring part of the LTE! 90% of it is just me talking about LTEs themselves. How uninteresting is that? Very uninteresting. Penguins. What are they? I don't know. What am I even writing right now? I haven't a clue. Isn't it weird that I said \"haven't a clue\" like that? Normally \"haven't\" isn't used if it's alone as a verb, as in \"I haven't my keys\". Who says that? Nobody, that's who. And yet \"I haven't a clue\" is an actual thing I've heard people say. Anyways, AFRICA! That was random, but let's discuss it anyway. Africa is a well-known song by Toto. It's a good song. I can kinda sorta play it on piano? Maybe? I don't know. Another song I can play on the piano is All Star by Smash Mouth. You know, the Shrek song? Anyways, I once made a video called \"All Star but it's played on a Sesame Street piano\" and it got almost a million views. It's been stuck at 900,000 for what seems like forever now. I'm gonna check to see if it's at a million now. I doubt it, though. Nope, still at 926,000 views. And I doubt it's gonna get any more, to be honest. It had a good run though. My sister is chugging applesauce. She thinks she's epic because of it. I don't know anymore. I seem to keep saying that after everything I type at this point. It's strange. Hello, I have returned after yet another long absence. When was the last time I added to this? I think it was somewhere in July. So yeah, it’s been three months, as it is now October 17, 2019. The end of the decade is approaching fast. I’m a bit excited, because I’ll have significant memories from more than just one decade! My earliest significant memories started in Kindergarden, which was in 2010. This means that I only really remember one decade. But now that an entirely new decade is coming up, I’ll be able to remember another! Part of me feels like I shouldn’t be excited over this, since the boundaries between years is arbitrary, and a decade is 10 years only because we count in base 10, so if we counted in base 12 or something, a decade would be 12 years long. That was kind of a run-on sentence, but I don’t really feel like making this text perfect, anyway. Have you heard of the Library of Babel? libraryofbabel.info is a website containing every possible combination of the lowercase letters a-z, space, comma, and period. The library is divided into hexagonal chambers. Each hex contains four walls. Each wall contains three shelves. Each shelf contains 32 volumes. Each volume contains 410 pages of 3200 characters each. Everything you could ever say or write is on this website. Even this LTE! See for yourself: https://libraryofbabel.info/bookmark.cgi?lte. Okay, that’s only the first bit of it, but every other bit of this LTE is somewhere in the library! In fact, here’s the next bit: https://libraryofbabel.info/bookmark.cgi?lte:1. It’s split up into about 20 different pages. I don’t feel like putting links to all of them here. It also removes punctuation that the library doesn’t use, like the exclamation point, question mark, colon, and so on. But it’s pretty mind-blowing stuff, if you ask me. If you try and browse the library yourself though, you probably won’t find much more than total gibberish. It’s crazy to think that everything we could ever possibly say or write is massively outweighed by meaningless strings of letters and punctuation. </p> </body></html>",
            "source": "https://whiletrue.neocities.org/lte.html",
            "title": "The Longest Text Ever",
            "author": null,
            "published": null,
            "image": null,
            "description": "An attempt at creating the longest wall of text ever written. Check out some other LTEs! Hello, everyone! This is the LONGEST TEXT EVER! I was inspired by the various other \"longest texts ever\" on the&hellip;",
            "tags": [],
            "createdAt": "2020-12-18T15:46:09.240+01:00",
            "readAt": "2020-12-18T15:46:42.609+01:00",
            "archivedAt": "2020-12-18T15:47:08.569+01:00"
        }
    ],
    "tags": [
        {
            "children": [
                {
                    "children": [],
                    "_id": "5fdcab44130cba20187c5dd0",
                    "title": "Tennis",
                    "color": "#0edd3b"
                },
                {
                    "children": [],
                    "_id": "5fdcc504de09ff30845f9f2f",
                    "title": "Voetball",
                    "color": "#4279a6"
                }
            ],
            "_id": "5fdcab36130cba20187c5dce",
            "title": "Sport",
            "color": "#00736d"
        },
        {
            "children": [
                {
                    "children": [
                        {
                            "children": [],
                            "_id": "5fdcab79130cba20187c5dde",
                            "title": "VueJS",
                            "color": "#0b9414"
                        },
                        {
                            "children": [],
                            "_id": "5fdcab7f130cba20187c5de3",
                            "title": "React",
                            "color": "#d00a4d"
                        }
                    ],
                    "_id": "5fdcab52130cba20187c5dd4",
                    "title": "Javascript",
                    "color": "#bf0284"
                },
                {
                    "children": [],
                    "_id": "5fdcab73130cba20187c5ddb",
                    "title": "C#",
                    "color": "#2fd892"
                }
            ],
            "_id": "5fdcab4b130cba20187c5dd1",
            "title": "Programmeren",
            "color": "#fbc9a7"
        },
        {
            "children": [
                {
                    "children": [],
                    "_id": "5fdcab92130cba20187c5ded",
                    "title": "nu.nl",
                    "color": "#401780"
                },
                {
                    "children": [],
                    "_id": "5fdcab97130cba20187c5df4",
                    "title": "Telegraaf",
                    "color": "#5da076"
                }
            ],
            "_id": "5fdcab8c130cba20187c5de6",
            "title": "Nieuws",
            "color": "#0ecbc3"
        }
    ],
    "__v": 47
}